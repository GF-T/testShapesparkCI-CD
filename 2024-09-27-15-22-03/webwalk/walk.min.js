var mS=Object.defineProperty,gS=Object.defineProperties;var _S=Object.getOwnPropertyDescriptors;var Ng=Object.getOwnPropertySymbols;var vS=Object.prototype.hasOwnProperty,bS=Object.prototype.propertyIsEnumerable;var nu=(ye,tt,Ei)=>tt in ye?mS(ye,tt,{enumerable:!0,configurable:!0,writable:!0,value:Ei}):ye[tt]=Ei,zt=(ye,tt)=>{for(var Ei in tt||(tt={}))vS.call(tt,Ei)&&nu(ye,Ei,tt[Ei]);if(Ng)for(var Ei of Ng(tt))bS.call(tt,Ei)&&nu(ye,Ei,tt[Ei]);return ye},pn=(ye,tt)=>gS(ye,_S(tt));var a=(ye,tt,Ei)=>(nu(ye,typeof tt!="symbol"?tt+"":tt,Ei),Ei);var ei=(ye,tt,Ei)=>new Promise((vs,fr)=>{var bs=Sn=>{try{Ws(Ei.next(Sn))}catch(pr){fr(pr)}},an=Sn=>{try{Ws(Ei.throw(Sn))}catch(pr){fr(pr)}},Ws=Sn=>Sn.done?vs(Sn.value):Promise.resolve(Sn.value).then(bs,an);Ws((Ei=Ei.apply(ye,tt)).next())});(function(){var Fi,Io;(function(){function s(R,V,ie){return R.call.apply(R.bind,arguments)}function e(R,V,ie){if(!R)throw Error();if(2<arguments.length){var re=Array.prototype.slice.call(arguments,2);return function(){var De=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(De,re),R.apply(V,De)}}return function(){return R.apply(V,arguments)}}function t(R,V,ie){return t=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?s:e,t.apply(null,arguments)}var i=Date.now||function(){return+new Date};function n(R,V){this.a=R,this.m=V||R,this.c=this.m.document}var r=!!window.FontFace;function o(R,V,ie,re){if(V=R.c.createElement(V),ie)for(var De in ie)ie.hasOwnProperty(De)&&(De=="style"?V.style.cssText=ie[De]:V.setAttribute(De,ie[De]));return re&&V.appendChild(R.c.createTextNode(re)),V}function l(R,V,ie){R=R.c.getElementsByTagName(V)[0],R||(R=document.documentElement),R.insertBefore(ie,R.lastChild)}function c(R){R.parentNode&&R.parentNode.removeChild(R)}function d(R,V,ie){V=V||[],ie=ie||[];for(var re=R.className.split(/\s+/),De=0;De<V.length;De+=1){for(var Ze=!1,He=0;He<re.length;He+=1)if(V[De]===re[He]){Ze=!0;break}Ze||re.push(V[De])}for(V=[],De=0;De<re.length;De+=1){for(Ze=!1,He=0;He<ie.length;He+=1)if(re[De]===ie[He]){Ze=!0;break}Ze||V.push(re[De])}R.className=V.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function u(R,V){for(var ie=R.className.split(/\s+/),re=0,De=ie.length;re<De;re++)if(ie[re]==V)return!0;return!1}function h(R){if(typeof R.f=="string")return R.f;var V=R.m.location.protocol;return V=="about:"&&(V=R.a.location.protocol),V=="https:"?"https:":"http:"}function f(R){return R.m.location.hostname||R.a.location.hostname}function p(R,V,ie){function re(){Rt&&De&&Ze&&(Rt(He),Rt=null)}V=o(R,"link",{rel:"stylesheet",href:V,media:"all"});var De=!1,Ze=!0,He=null,Rt=ie||null;r?(V.onload=function(){De=!0,re()},V.onerror=function(){De=!0,He=Error("Stylesheet failed to load"),re()}):setTimeout(function(){De=!0,re()},0),l(R,"head",V)}function m(R,V,ie,re){var De=R.c.getElementsByTagName("head")[0];if(De){var Ze=o(R,"script",{src:V}),He=!1;return Ze.onload=Ze.onreadystatechange=function(){He||this.readyState&&this.readyState!="loaded"&&this.readyState!="complete"||(He=!0,ie&&ie(null),Ze.onload=Ze.onreadystatechange=null,Ze.parentNode.tagName=="HEAD"&&De.removeChild(Ze))},De.appendChild(Ze),setTimeout(function(){He||(He=!0,ie&&ie(Error("Script load timeout")))},re||5e3),Ze}return null}function b(){this.a=0,this.c=null}function _(R){return R.a++,function(){R.a--,A(R)}}function y(R,V){R.c=V,A(R)}function A(R){R.a==0&&R.c&&(R.c(),R.c=null)}function T(R){this.a=R||"-"}T.prototype.c=function(R){for(var V=[],ie=0;ie<arguments.length;ie++)V.push(arguments[ie].replace(/[\W_]+/g,"").toLowerCase());return V.join(this.a)};function M(R,V){this.c=R,this.f=4,this.a="n";var ie=(V||"n4").match(/^([nio])([1-9])$/i);ie&&(this.a=ie[1],this.f=parseInt(ie[2],10))}function C(R){return q(R)+" "+(R.f+"00")+" 300px "+N(R.c)}function N(R){var V=[];R=R.split(/,\s*/);for(var ie=0;ie<R.length;ie++){var re=R[ie].replace(/['"]/g,"");re.indexOf(" ")!=-1||/^\d/.test(re)?V.push("'"+re+"'"):V.push(re)}return V.join(",")}function O(R){return R.a+R.f}function q(R){var V="normal";return R.a==="o"?V="oblique":R.a==="i"&&(V="italic"),V}function j(R){var V=4,ie="n",re=null;return R&&((re=R.match(/(normal|oblique|italic)/i))&&re[1]&&(ie=re[1].substr(0,1).toLowerCase()),(re=R.match(/([1-9]00|normal|bold)/i))&&re[1]&&(/bold/i.test(re[1])?V=7:/[1-9]00/.test(re[1])&&(V=parseInt(re[1].substr(0,1),10)))),ie+V}function K(R,V){this.c=R,this.f=R.m.document.documentElement,this.h=V,this.a=new T("-"),this.j=V.events!==!1,this.g=V.classes!==!1}function de(R){R.g&&d(R.f,[R.a.c("wf","loading")]),Ve(R,"loading")}function xe(R){if(R.g){var V=u(R.f,R.a.c("wf","active")),ie=[],re=[R.a.c("wf","loading")];V||ie.push(R.a.c("wf","inactive")),d(R.f,ie,re)}Ve(R,"inactive")}function Ve(R,V,ie){R.j&&R.h[V]&&(ie?R.h[V](ie.c,O(ie)):R.h[V]())}function qe(){this.c={}}function k(R,V,ie){var re=[],De;for(De in V)if(V.hasOwnProperty(De)){var Ze=R.c[De];Ze&&re.push(Ze(V[De],ie))}return re}function Q(R,V){this.c=R,this.f=V,this.a=o(this.c,"span",{"aria-hidden":"true"},this.f)}function le(R){l(R.c,"body",R.a)}function ae(R){return"display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+N(R.c)+";"+("font-style:"+q(R)+";font-weight:"+(R.f+"00")+";")}function Ee(R,V,ie,re,De,Ze){this.g=R,this.j=V,this.a=re,this.c=ie,this.f=De||3e3,this.h=Ze||void 0}Ee.prototype.start=function(){var R=this.c.m.document,V=this,ie=i(),re=new Promise(function(Ze,He){function Rt(){i()-ie>=V.f?He():R.fonts.load(C(V.a),V.h).then(function(Ft){1<=Ft.length?Ze():setTimeout(Rt,25)},function(){He()})}Rt()}),De=new Promise(function(Ze,He){setTimeout(He,V.f)});Promise.race([De,re]).then(function(){V.g(V.a)},function(){V.j(V.a)})};function te(R,V,ie,re,De,Ze,He){this.v=R,this.B=V,this.c=ie,this.a=re,this.s=He||"BESbswy",this.f={},this.w=De||3e3,this.u=Ze||null,this.o=this.j=this.h=this.g=null,this.g=new Q(this.c,this.s),this.h=new Q(this.c,this.s),this.j=new Q(this.c,this.s),this.o=new Q(this.c,this.s),R=new M(this.a.c+",serif",O(this.a)),R=ae(R),this.g.a.style.cssText=R,R=new M(this.a.c+",sans-serif",O(this.a)),R=ae(R),this.h.a.style.cssText=R,R=new M("serif",O(this.a)),R=ae(R),this.j.a.style.cssText=R,R=new M("sans-serif",O(this.a)),R=ae(R),this.o.a.style.cssText=R,le(this.g),le(this.h),le(this.j),le(this.o)}var me={D:"serif",C:"sans-serif"},Fe=null;function we(){if(Fe===null){var R=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);Fe=!!R&&(536>parseInt(R[1],10)||parseInt(R[1],10)===536&&11>=parseInt(R[2],10))}return Fe}te.prototype.start=function(){this.f.serif=this.j.a.offsetWidth,this.f["sans-serif"]=this.o.a.offsetWidth,this.A=i(),et(this)};function at(R,V,ie){for(var re in me)if(me.hasOwnProperty(re)&&V===R.f[me[re]]&&ie===R.f[me[re]])return!0;return!1}function et(R){var V=R.g.a.offsetWidth,ie=R.h.a.offsetWidth,re;(re=V===R.f.serif&&ie===R.f["sans-serif"])||(re=we()&&at(R,V,ie)),re?i()-R.A>=R.w?we()&&at(R,V,ie)&&(R.u===null||R.u.hasOwnProperty(R.a.c))?z(R,R.v):z(R,R.B):U(R):z(R,R.v)}function U(R){setTimeout(t(function(){et(this)},R),50)}function z(R,V){setTimeout(t(function(){c(this.g.a),c(this.h.a),c(this.j.a),c(this.o.a),V(this.a)},R),0)}function G(R,V,ie){this.c=R,this.a=V,this.f=0,this.o=this.j=!1,this.s=ie}var X=null;G.prototype.g=function(R){var V=this.a;V.g&&d(V.f,[V.a.c("wf",R.c,O(R).toString(),"active")],[V.a.c("wf",R.c,O(R).toString(),"loading"),V.a.c("wf",R.c,O(R).toString(),"inactive")]),Ve(V,"fontactive",R),this.o=!0,_e(this)},G.prototype.h=function(R){var V=this.a;if(V.g){var ie=u(V.f,V.a.c("wf",R.c,O(R).toString(),"active")),re=[],De=[V.a.c("wf",R.c,O(R).toString(),"loading")];ie||re.push(V.a.c("wf",R.c,O(R).toString(),"inactive")),d(V.f,re,De)}Ve(V,"fontinactive",R),_e(this)};function _e(R){--R.f==0&&R.j&&(R.o?(R=R.a,R.g&&d(R.f,[R.a.c("wf","active")],[R.a.c("wf","loading"),R.a.c("wf","inactive")]),Ve(R,"active")):xe(R.a))}function Ie(R){this.j=R,this.a=new qe,this.h=0,this.f=this.g=!0}Ie.prototype.load=function(R){this.c=new n(this.j,R.context||this.j),this.g=R.events!==!1,this.f=R.classes!==!1,ke(this,new K(this.c,R),R)};function Ye(R,V,ie,re,De){var Ze=--R.h==0;(R.f||R.g)&&setTimeout(function(){var He=De||null,Rt=re||null||{};if(ie.length===0&&Ze)xe(V.a);else{V.f+=ie.length,Ze&&(V.j=Ze);var Ft,di=[];for(Ft=0;Ft<ie.length;Ft++){var Qt=ie[Ft],bi=Rt[Qt.c],yn=V.a,Vs=Qt;yn.g&&d(yn.f,[yn.a.c("wf",Vs.c,O(Vs).toString(),"loading")]),Ve(yn,"fontloading",Vs),yn=null,X===null&&(X=window.FontFace?(Vs=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent))?42<parseInt(Vs[1],10):!0:!1),X?yn=new Ee(t(V.g,V),t(V.h,V),V.c,Qt,V.s,bi):yn=new te(t(V.g,V),t(V.h,V),V.c,Qt,V.s,He,bi),di.push(yn)}for(Ft=0;Ft<di.length;Ft++)di[Ft].start()}},0)}function ke(R,V,ie){var De=[],re=ie.timeout;de(V);var De=k(R.a,ie,R.c),Ze=new G(R.c,V,re);for(R.h=De.length,V=0,ie=De.length;V<ie;V++)De[V].load(function(He,Rt,Ft){Ye(R,Ze,He,Rt,Ft)})}function ge(R,V){this.c=R,this.a=V}function Qe(R,V,ie){var re=h(R.c);return R=(R.a.api||"fast.fonts.net/jsapi").replace(/^.*http(s?):(\/\/)?/,""),re+"//"+R+"/"+V+".js"+(ie?"?v="+ie:"")}ge.prototype.load=function(R){function V(){if(Ze["__mti_fntLst"+re]){var He=Ze["__mti_fntLst"+re](),Rt=[],Ft;if(He)for(var di=0;di<He.length;di++){var Qt=He[di].fontfamily;He[di].fontStyle!=null&&He[di].fontWeight!=null?(Ft=He[di].fontStyle+He[di].fontWeight,Rt.push(new M(Qt,Ft))):Rt.push(new M(Qt))}R(Rt)}else setTimeout(function(){V()},50)}var ie=this,re=ie.a.projectId,De=ie.a.version;if(re){var Ze=ie.c.m;m(this.c,Qe(ie,re,De),function(He){He?R([]):(Ze["__MonotypeConfiguration__"+re]=function(){return ie.a},V())}).id="__MonotypeAPIScript__"+re}else R([])};function ue(R,V){this.c=R,this.a=V}ue.prototype.load=function(R){var V,ie,re=this.a.urls||[],De=this.a.families||[],Ze=this.a.testStrings||{},He=new b;for(V=0,ie=re.length;V<ie;V++)p(this.c,re[V],_(He));var Rt=[];for(V=0,ie=De.length;V<ie;V++)if(re=De[V].split(":"),re[1])for(var Ft=re[1].split(","),di=0;di<Ft.length;di+=1)Rt.push(new M(re[0],Ft[di]));else Rt.push(new M(re[0]));y(He,function(){R(Rt,Ze)})};function Ae(R,V,ie){R?this.c=R:this.c=V+Se,this.a=[],this.f=[],this.g=ie||""}var Se="//fonts.googleapis.com/css";function We(R,V){for(var ie=V.length,re=0;re<ie;re++){var De=V[re].split(":");De.length==3&&R.f.push(De.pop());var Ze="";De.length==2&&De[1]!=""&&(Ze=":"),R.a.push(De.join(Ze))}}function rt(R){if(R.a.length==0)throw Error("No fonts to load!");if(R.c.indexOf("kit=")!=-1)return R.c;for(var V=R.a.length,ie=[],re=0;re<V;re++)ie.push(R.a[re].replace(/ /g,"+"));return V=R.c+"?family="+ie.join("%7C"),0<R.f.length&&(V+="&subset="+R.f.join(",")),0<R.g.length&&(V+="&text="+encodeURIComponent(R.g)),V}function bt(R){this.f=R,this.a=[],this.c={}}var ft={latin:"BESbswy","latin-ext":"çöüğş",cyrillic:"йяЖ",greek:"αβΣ",khmer:"កខគ",Hanuman:"កខគ"},F={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},J={i:"i",italic:"i",n:"n",normal:"n"},Ne=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;function he(R){for(var V=R.f.length,ie=0;ie<V;ie++){var re=R.f[ie].split(":"),De=re[0].replace(/\+/g," "),Ze=["n4"];if(2<=re.length){var He,Rt=re[1];if(He=[],Rt)for(var Rt=Rt.split(","),Ft=Rt.length,di=0;di<Ft;di++){var Qt;if(Qt=Rt[di],Qt.match(/^[\w-]+$/)){var bi=Ne.exec(Qt.toLowerCase());if(bi==null)Qt="";else{if(Qt=bi[2],Qt=Qt==null||Qt==""?"n":J[Qt],bi=bi[1],bi==null||bi=="")bi="4";else var yn=F[bi],bi=yn||(isNaN(bi)?"4":bi.substr(0,1));Qt=[Qt,bi].join("")}}else Qt="";Qt&&He.push(Qt)}0<He.length&&(Ze=He),re.length==3&&(re=re[2],He=[],re=re?re.split(","):He,0<re.length&&(re=ft[re[0]])&&(R.c[De]=re))}for(R.c[De]||(re=ft[De])&&(R.c[De]=re),re=0;re<Ze.length;re+=1)R.a.push(new M(De,Ze[re]))}}function Ce(R,V){this.c=R,this.a=V}var ze={Arimo:!0,Cousine:!0,Tinos:!0};Ce.prototype.load=function(R){var V=new b,ie=this.c,re=new Ae(this.a.api,h(ie),this.a.text),De=this.a.families;We(re,De);var Ze=new bt(De);he(Ze),p(ie,rt(re),_(V)),y(V,function(){R(Ze.a,Ze.c,ze)})};function gt(R,V){this.c=R,this.a=V}gt.prototype.load=function(R){var V=this.a.id,ie=this.c.m;V?m(this.c,(this.a.api||"https://use.typekit.net")+"/"+V+".js",function(re){if(re)R([]);else if(ie.Typekit&&ie.Typekit.config&&ie.Typekit.config.fn){re=ie.Typekit.config.fn;for(var De=[],Ze=0;Ze<re.length;Ze+=2)for(var He=re[Ze],Rt=re[Ze+1],Ft=0;Ft<Rt.length;Ft++)De.push(new M(He,Rt[Ft]));try{ie.Typekit.load({events:!1,classes:!1,async:!0})}catch(di){}R(De)}},2e3):R([])};function Ut(R,V){this.c=R,this.f=V,this.a=[]}Ut.prototype.load=function(R){var V=this.f.id,ie=this.c.m,re=this;V?(ie.__webfontfontdeckmodule__||(ie.__webfontfontdeckmodule__={}),ie.__webfontfontdeckmodule__[V]=function(De,Ze){for(var He=0,Rt=Ze.fonts.length;He<Rt;++He){var Ft=Ze.fonts[He];re.a.push(new M(Ft.name,j("font-weight:"+Ft.weight+";font-style:"+Ft.style)))}R(re.a)},m(this.c,h(this.c)+(this.f.api||"//f.fontdeck.com/s/css/js/")+f(this.c)+"/"+V+".js",function(De){De&&R([])})):R([])};var ii=new Ie(window);ii.a.c.custom=function(R,V){return new ue(V,R)},ii.a.c.fontdeck=function(R,V){return new Ut(V,R)},ii.a.c.monotype=function(R,V){return new ge(V,R)},ii.a.c.typekit=function(R,V){return new gt(V,R)},ii.a.c.google=function(R,V){return new Ce(V,R)};var Oe={load:t(ii.load,ii)};typeof define=="function"&&define.amd?define(function(){return Oe}):typeof module!="undefined"&&module.exports?module.exports=Oe:(window.WebFont=Oe,window.WebFontConfig&&ii.load(window.WebFontConfig))})();/**
 * @license
 * webxr-polyfill
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * cardboard-vr-display
 * Copyright (c) 2015-2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * webvr-polyfill-dpdb 
 * Copyright (c) 2017 Google
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * wglu-preserve-state
 * Copyright (c) 2016, Brandon Jones.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *//**
 * @license
 * nosleep.js
 * Copyright (c) 2017, Rich Tibbett
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */(function(s,e){typeof exports=="object"&&typeof module!="undefined"?module.exports=e():typeof define=="function"&&define.amd?define(e):s.WebXRPolyfill=e()})(this,function(){"use strict";const s=typeof global!="undefined"?global:typeof self!="undefined"?self:typeof window!="undefined"?window:{},e=Symbol("@@webxr-polyfill/EventTarget");class t{constructor(){this[e]={listeners:new Map}}addEventListener(g,S){if(typeof g!="string")throw new Error("`type` must be a string");if(typeof S!="function")throw new Error("`listener` must be a function");const I=this[e].listeners.get(g)||[];I.push(S),this[e].listeners.set(g,I)}removeEventListener(g,S){if(typeof g!="string")throw new Error("`type` must be a string");if(typeof S!="function")throw new Error("`listener` must be a function");const I=this[e].listeners.get(g)||[];for(let H=I.length;H>=0;H--)I[H]===S&&I.pop()}dispatchEvent(g,S){const I=this[e].listeners.get(g)||[],H=[];for(let Z=0;Z<I.length;Z++)H[Z]=I[Z];for(let Z of H)Z(S);typeof this[`on${g}`]=="function"&&this[`on${g}`](S)}}const i=1e-6;let n=typeof Float32Array!="undefined"?Float32Array:Array;const r=Math.PI/180;function o(){let E=new n(16);return n!=Float32Array&&(E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[11]=0,E[12]=0,E[13]=0,E[14]=0),E[0]=1,E[5]=1,E[10]=1,E[15]=1,E}function l(E,g){return E[0]=g[0],E[1]=g[1],E[2]=g[2],E[3]=g[3],E[4]=g[4],E[5]=g[5],E[6]=g[6],E[7]=g[7],E[8]=g[8],E[9]=g[9],E[10]=g[10],E[11]=g[11],E[12]=g[12],E[13]=g[13],E[14]=g[14],E[15]=g[15],E}function c(E){return E[0]=1,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=1,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[10]=1,E[11]=0,E[12]=0,E[13]=0,E[14]=0,E[15]=1,E}function d(E,g){let S=g[0],I=g[1],H=g[2],Z=g[3],ee=g[4],oe=g[5],Pe=g[6],be=g[7],Ke=g[8],lt=g[9],Ot=g[10],Gt=g[11],$t=g[12],Ht=g[13],Bt=g[14],ui=g[15],Ui=S*oe-I*ee,At=S*Pe-H*ee,Pt=S*be-Z*ee,It=I*Pe-H*oe,yt=I*be-Z*oe,os=H*be-Z*Pe,cr=Ke*Ht-lt*$t,hr=Ke*Bt-Ot*$t,Gr=Ke*ui-Gt*$t,Gs=lt*Bt-Ot*Ht,dr=lt*ui-Gt*Ht,Hs=Ot*ui-Gt*Bt,yi=Ui*Hs-At*dr+Pt*Gs+It*Gr-yt*hr+os*cr;return yi?(yi=1/yi,E[0]=(oe*Hs-Pe*dr+be*Gs)*yi,E[1]=(H*dr-I*Hs-Z*Gs)*yi,E[2]=(Ht*os-Bt*yt+ui*It)*yi,E[3]=(Ot*yt-lt*os-Gt*It)*yi,E[4]=(Pe*Gr-ee*Hs-be*hr)*yi,E[5]=(S*Hs-H*Gr+Z*hr)*yi,E[6]=(Bt*Pt-$t*os-ui*At)*yi,E[7]=(Ke*os-Ot*Pt+Gt*At)*yi,E[8]=(ee*dr-oe*Gr+be*cr)*yi,E[9]=(I*Gr-S*dr-Z*cr)*yi,E[10]=($t*yt-Ht*Pt+ui*Ui)*yi,E[11]=(lt*Pt-Ke*yt-Gt*Ui)*yi,E[12]=(oe*hr-ee*Gs-Pe*cr)*yi,E[13]=(S*Gs-I*hr+H*cr)*yi,E[14]=(Ht*At-$t*It-Bt*Ui)*yi,E[15]=(Ke*It-lt*At+Ot*Ui)*yi,E):null}function u(E,g,S){let I=g[0],H=g[1],Z=g[2],ee=g[3],oe=g[4],Pe=g[5],be=g[6],Ke=g[7],lt=g[8],Ot=g[9],Gt=g[10],$t=g[11],Ht=g[12],Bt=g[13],ui=g[14],Ui=g[15],At=S[0],Pt=S[1],It=S[2],yt=S[3];return E[0]=At*I+Pt*oe+It*lt+yt*Ht,E[1]=At*H+Pt*Pe+It*Ot+yt*Bt,E[2]=At*Z+Pt*be+It*Gt+yt*ui,E[3]=At*ee+Pt*Ke+It*$t+yt*Ui,At=S[4],Pt=S[5],It=S[6],yt=S[7],E[4]=At*I+Pt*oe+It*lt+yt*Ht,E[5]=At*H+Pt*Pe+It*Ot+yt*Bt,E[6]=At*Z+Pt*be+It*Gt+yt*ui,E[7]=At*ee+Pt*Ke+It*$t+yt*Ui,At=S[8],Pt=S[9],It=S[10],yt=S[11],E[8]=At*I+Pt*oe+It*lt+yt*Ht,E[9]=At*H+Pt*Pe+It*Ot+yt*Bt,E[10]=At*Z+Pt*be+It*Gt+yt*ui,E[11]=At*ee+Pt*Ke+It*$t+yt*Ui,At=S[12],Pt=S[13],It=S[14],yt=S[15],E[12]=At*I+Pt*oe+It*lt+yt*Ht,E[13]=At*H+Pt*Pe+It*Ot+yt*Bt,E[14]=At*Z+Pt*be+It*Gt+yt*ui,E[15]=At*ee+Pt*Ke+It*$t+yt*Ui,E}function h(E,g,S){let I=g[0],H=g[1],Z=g[2],ee=g[3],oe=I+I,Pe=H+H,be=Z+Z,Ke=I*oe,lt=I*Pe,Ot=I*be,Gt=H*Pe,$t=H*be,Ht=Z*be,Bt=ee*oe,ui=ee*Pe,Ui=ee*be;return E[0]=1-(Gt+Ht),E[1]=lt+Ui,E[2]=Ot-ui,E[3]=0,E[4]=lt-Ui,E[5]=1-(Ke+Ht),E[6]=$t+Bt,E[7]=0,E[8]=Ot+ui,E[9]=$t-Bt,E[10]=1-(Ke+Gt),E[11]=0,E[12]=S[0],E[13]=S[1],E[14]=S[2],E[15]=1,E}function f(E,g){return E[0]=g[12],E[1]=g[13],E[2]=g[14],E}function p(E,g){let S=g[0]+g[5]+g[10],I=0;return S>0?(I=Math.sqrt(S+1)*2,E[3]=.25*I,E[0]=(g[6]-g[9])/I,E[1]=(g[8]-g[2])/I,E[2]=(g[1]-g[4])/I):g[0]>g[5]&&g[0]>g[10]?(I=Math.sqrt(1+g[0]-g[5]-g[10])*2,E[3]=(g[6]-g[9])/I,E[0]=.25*I,E[1]=(g[1]+g[4])/I,E[2]=(g[8]+g[2])/I):g[5]>g[10]?(I=Math.sqrt(1+g[5]-g[0]-g[10])*2,E[3]=(g[8]-g[2])/I,E[0]=(g[1]+g[4])/I,E[1]=.25*I,E[2]=(g[6]+g[9])/I):(I=Math.sqrt(1+g[10]-g[0]-g[5])*2,E[3]=(g[1]-g[4])/I,E[0]=(g[8]+g[2])/I,E[1]=(g[6]+g[9])/I,E[2]=.25*I),E}function m(E,g,S,I,H){let Z=1/Math.tan(g/2),ee;return E[0]=Z/S,E[1]=0,E[2]=0,E[3]=0,E[4]=0,E[5]=Z,E[6]=0,E[7]=0,E[8]=0,E[9]=0,E[11]=-1,E[12]=0,E[13]=0,E[15]=0,H!=null&&H!==1/0?(ee=1/(I-H),E[10]=(H+I)*ee,E[14]=2*H*I*ee):(E[10]=-1,E[14]=-2*I),E}function b(){let E=new n(3);return n!=Float32Array&&(E[0]=0,E[1]=0,E[2]=0),E}function _(E){var g=new n(3);return g[0]=E[0],g[1]=E[1],g[2]=E[2],g}function y(E){let g=E[0],S=E[1],I=E[2];return Math.sqrt(g*g+S*S+I*I)}function A(E,g,S){let I=new n(3);return I[0]=E,I[1]=g,I[2]=S,I}function T(E,g){return E[0]=g[0],E[1]=g[1],E[2]=g[2],E}function M(E,g,S){return E[0]=g[0]+S[0],E[1]=g[1]+S[1],E[2]=g[2]+S[2],E}function C(E,g,S){return E[0]=g[0]*S,E[1]=g[1]*S,E[2]=g[2]*S,E}function N(E,g){let S=g[0],I=g[1],H=g[2],Z=S*S+I*I+H*H;return Z>0&&(Z=1/Math.sqrt(Z),E[0]=g[0]*Z,E[1]=g[1]*Z,E[2]=g[2]*Z),E}function O(E,g){return E[0]*g[0]+E[1]*g[1]+E[2]*g[2]}function q(E,g,S){let I=g[0],H=g[1],Z=g[2],ee=S[0],oe=S[1],Pe=S[2];return E[0]=H*Pe-Z*oe,E[1]=Z*ee-I*Pe,E[2]=I*oe-H*ee,E}function j(E,g,S){let I=S[0],H=S[1],Z=S[2],ee=S[3],oe=g[0],Pe=g[1],be=g[2],Ke=H*be-Z*Pe,lt=Z*oe-I*be,Ot=I*Pe-H*oe,Gt=H*Ot-Z*lt,$t=Z*Ke-I*Ot,Ht=I*lt-H*Ke,Bt=ee*2;return Ke*=Bt,lt*=Bt,Ot*=Bt,Gt*=2,$t*=2,Ht*=2,E[0]=oe+Ke+Gt,E[1]=Pe+lt+$t,E[2]=be+Ot+Ht,E}function K(E,g){let S=A(E[0],E[1],E[2]),I=A(g[0],g[1],g[2]);N(S,S),N(I,I);let H=O(S,I);return H>1?0:H<-1?Math.PI:Math.acos(H)}const de=y,xe=function(){let E=b();return function(g,S,I,H,Z,ee){let oe,Pe;for(S||(S=3),I||(I=0),H?Pe=Math.min(H*S+I,g.length):Pe=g.length,oe=I;oe<Pe;oe+=S)E[0]=g[oe],E[1]=g[oe+1],E[2]=g[oe+2],Z(E,E,ee),g[oe]=E[0],g[oe+1]=E[1],g[oe+2]=E[2];return g}}();function Ve(){let E=new n(9);return n!=Float32Array&&(E[1]=0,E[2]=0,E[3]=0,E[5]=0,E[6]=0,E[7]=0),E[0]=1,E[4]=1,E[8]=1,E}function qe(){let E=new n(4);return n!=Float32Array&&(E[0]=0,E[1]=0,E[2]=0,E[3]=0),E}function k(E){let g=new n(4);return g[0]=E[0],g[1]=E[1],g[2]=E[2],g[3]=E[3],g}function Q(E,g,S,I){let H=new n(4);return H[0]=E,H[1]=g,H[2]=S,H[3]=I,H}function le(E,g){return E[0]=g[0],E[1]=g[1],E[2]=g[2],E[3]=g[3],E}function ae(E,g){let S=g[0],I=g[1],H=g[2],Z=g[3],ee=S*S+I*I+H*H+Z*Z;return ee>0&&(ee=1/Math.sqrt(ee),E[0]=S*ee,E[1]=I*ee,E[2]=H*ee,E[3]=Z*ee),E}const Ee=function(){let E=qe();return function(g,S,I,H,Z,ee){let oe,Pe;for(S||(S=4),I||(I=0),H?Pe=Math.min(H*S+I,g.length):Pe=g.length,oe=I;oe<Pe;oe+=S)E[0]=g[oe],E[1]=g[oe+1],E[2]=g[oe+2],E[3]=g[oe+3],Z(E,E,ee),g[oe]=E[0],g[oe+1]=E[1],g[oe+2]=E[2],g[oe+3]=E[3];return g}}();function te(){let E=new n(4);return n!=Float32Array&&(E[0]=0,E[1]=0,E[2]=0),E[3]=1,E}function me(E,g,S){S=S*.5;let I=Math.sin(S);return E[0]=I*g[0],E[1]=I*g[1],E[2]=I*g[2],E[3]=Math.cos(S),E}function Fe(E,g,S){let I=g[0],H=g[1],Z=g[2],ee=g[3],oe=S[0],Pe=S[1],be=S[2],Ke=S[3];return E[0]=I*Ke+ee*oe+H*be-Z*Pe,E[1]=H*Ke+ee*Pe+Z*oe-I*be,E[2]=Z*Ke+ee*be+I*Pe-H*oe,E[3]=ee*Ke-I*oe-H*Pe-Z*be,E}function we(E,g,S,I){let H=g[0],Z=g[1],ee=g[2],oe=g[3],Pe=S[0],be=S[1],Ke=S[2],lt=S[3],Ot,Gt,$t,Ht,Bt;return Gt=H*Pe+Z*be+ee*Ke+oe*lt,Gt<0&&(Gt=-Gt,Pe=-Pe,be=-be,Ke=-Ke,lt=-lt),1-Gt>i?(Ot=Math.acos(Gt),$t=Math.sin(Ot),Ht=Math.sin((1-I)*Ot)/$t,Bt=Math.sin(I*Ot)/$t):(Ht=1-I,Bt=I),E[0]=Ht*H+Bt*Pe,E[1]=Ht*Z+Bt*be,E[2]=Ht*ee+Bt*Ke,E[3]=Ht*oe+Bt*lt,E}function at(E,g){let S=g[0],I=g[1],H=g[2],Z=g[3],ee=S*S+I*I+H*H+Z*Z,oe=ee?1/ee:0;return E[0]=-S*oe,E[1]=-I*oe,E[2]=-H*oe,E[3]=Z*oe,E}function et(E,g){let S=g[0]+g[4]+g[8],I;if(S>0)I=Math.sqrt(S+1),E[3]=.5*I,I=.5/I,E[0]=(g[5]-g[7])*I,E[1]=(g[6]-g[2])*I,E[2]=(g[1]-g[3])*I;else{let H=0;g[4]>g[0]&&(H=1),g[8]>g[H*3+H]&&(H=2);let Z=(H+1)%3,ee=(H+2)%3;I=Math.sqrt(g[H*3+H]-g[Z*3+Z]-g[ee*3+ee]+1),E[H]=.5*I,I=.5/I,E[3]=(g[Z*3+ee]-g[ee*3+Z])*I,E[Z]=(g[Z*3+H]+g[H*3+Z])*I,E[ee]=(g[ee*3+H]+g[H*3+ee])*I}return E}function U(E,g,S,I){let H=.5*Math.PI/180;g*=H,S*=H,I*=H;let Z=Math.sin(g),ee=Math.cos(g),oe=Math.sin(S),Pe=Math.cos(S),be=Math.sin(I),Ke=Math.cos(I);return E[0]=Z*Pe*Ke-ee*oe*be,E[1]=ee*oe*Ke+Z*Pe*be,E[2]=ee*Pe*be-Z*oe*Ke,E[3]=ee*Pe*Ke+Z*oe*be,E}const z=k,G=Q,X=le,_e=ae,Ie=function(){let E=b(),g=A(1,0,0),S=A(0,1,0);return function(I,H,Z){let ee=O(H,Z);return ee<-.999999?(q(E,g,H),de(E)<1e-6&&q(E,S,H),N(E,E),me(I,E,Math.PI),I):ee>.999999?(I[0]=0,I[1]=0,I[2]=0,I[3]=1,I):(q(E,H,Z),I[0]=E[0],I[1]=E[1],I[2]=E[2],I[3]=1+ee,_e(I,I))}}(),Ye=function(){let E=te(),g=te();return function(S,I,H,Z,ee,oe){return we(E,I,ee,oe),we(g,H,Z,oe),we(S,E,g,2*oe*(1-oe)),S}}(),ke=function(){let E=Ve();return function(g,S,I,H){return E[0]=I[0],E[3]=I[1],E[6]=I[2],E[1]=H[0],E[4]=H[1],E[7]=H[2],E[2]=-S[0],E[5]=-S[1],E[8]=-S[2],_e(g,et(g,E))}}();if(!("DOMPointReadOnly"in window)){const E=Symbol("@@webxr-polyfill/DOMPointReadOnly");window.DOMPointReadOnly=class kg{constructor(S,I,H,Z){if(arguments.length===1)this[E]={x:S.x,y:S.y,z:S.z,w:S.w};else if(arguments.length===4)this[E]={x:S,y:I,z:H,w:Z};else throw new TypeError("Must supply either 1 or 4 arguments")}get x(){return this[E].x}get y(){return this[E].y}get z(){return this[E].z}get w(){return this[E].w}static fromPoint(S){return new kg(S.x,S.y,S.z,S.w)}}}const ge=Symbol("@@webxr-polyfill/XRRigidTransform");class Qe{constructor(){if(this[ge]={matrix:null,position:null,orientation:null,inverse:null},arguments.length===0)this[ge].matrix=c(new Float32Array(16));else if(arguments.length===1)arguments[0]instanceof Float32Array?this[ge].matrix=arguments[0]:(this[ge].position=this._getPoint(arguments[0]),this[ge].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else if(arguments.length===2)this[ge].position=this._getPoint(arguments[0]),this[ge].orientation=this._getPoint(arguments[1]);else throw new Error("Too many arguments!");if(this[ge].matrix){let g=b();f(g,this[ge].matrix),this[ge].position=DOMPointReadOnly.fromPoint({x:g[0],y:g[1],z:g[2]});let S=te();p(S,this[ge].matrix),this[ge].orientation=DOMPointReadOnly.fromPoint({x:S[0],y:S[1],z:S[2],w:S[3]})}else this[ge].matrix=c(new Float32Array(16)),h(this[ge].matrix,G(this[ge].orientation.x,this[ge].orientation.y,this[ge].orientation.z,this[ge].orientation.w),A(this[ge].position.x,this[ge].position.y,this[ge].position.z))}_getPoint(g){return g instanceof DOMPointReadOnly?g:DOMPointReadOnly.fromPoint(g)}get matrix(){return this[ge].matrix}get position(){return this[ge].position}get orientation(){return this[ge].orientation}get inverse(){if(this[ge].inverse===null){let g=c(new Float32Array(16));d(g,this[ge].matrix),this[ge].inverse=new Qe(g),this[ge].inverse[ge].inverse=this}return this[ge].inverse}}const ue=Symbol("@@webxr-polyfill/XRSpace");class Ae{constructor(g=null,S=null){this[ue]={specialType:g,inputSource:S,baseMatrix:null,inverseBaseMatrix:null,lastFrameId:-1}}get _specialType(){return this[ue].specialType}get _inputSource(){return this[ue].inputSource}_ensurePoseUpdated(g,S){S!=this[ue].lastFrameId&&(this[ue].lastFrameId=S,this._onPoseUpdate(g))}_onPoseUpdate(g){this[ue].specialType=="viewer"&&(this._baseMatrix=g.getBasePoseMatrix())}set _baseMatrix(g){this[ue].baseMatrix=g,this[ue].inverseBaseMatrix=null}get _baseMatrix(){return this[ue].baseMatrix||this[ue].inverseBaseMatrix&&(this[ue].baseMatrix=new Float32Array(16),d(this[ue].baseMatrix,this[ue].inverseBaseMatrix)),this[ue].baseMatrix}set _inverseBaseMatrix(g){this[ue].inverseBaseMatrix=g,this[ue].baseMatrix=null}get _inverseBaseMatrix(){return this[ue].inverseBaseMatrix||this[ue].baseMatrix&&(this[ue].inverseBaseMatrix=new Float32Array(16),d(this[ue].inverseBaseMatrix,this[ue].baseMatrix)),this[ue].inverseBaseMatrix}_getSpaceRelativeTransform(g){if(!this._inverseBaseMatrix||!g._baseMatrix)return null;let S=new Float32Array(16);return u(S,this._inverseBaseMatrix,g._baseMatrix),new Qe(S)}}const Se=1.6,We=Symbol("@@webxr-polyfill/XRReferenceSpace"),rt=["viewer","local","local-floor","bounded-floor","unbounded"];function bt(E){return E==="bounded-floor"||E==="local-floor"}class ft extends Ae{constructor(g,S=null){if(!rt.includes(g))throw new Error(`XRReferenceSpaceType must be one of ${rt}`);if(super(g),g==="bounded-floor"&&!S)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");bt(g)&&!S&&(S=c(new Float32Array(16)),S[13]=Se),this._inverseBaseMatrix=S||c(new Float32Array(16)),this[We]={type:g,transform:S,originOffset:c(new Float32Array(16))}}_transformBasePoseMatrix(g,S){u(g,this._inverseBaseMatrix,S)}_originOffsetMatrix(){return this[We].originOffset}_adjustForOriginOffset(g){let S=new Float32Array(16);d(S,this[We].originOffset),u(g,S,g)}_getSpaceRelativeTransform(g){let S=super._getSpaceRelativeTransform(g);return this._adjustForOriginOffset(S.matrix),new XRRigidTransform(S.matrix)}getOffsetReferenceSpace(g){let S=new ft(this[We].type,this[We].transform,this[We].bounds);return u(S[We].originOffset,this[We].originOffset,g.matrix),S}}const F=Symbol("@@webxr-polyfill/XR"),J=["inline","immersive-vr","immersive-ar"],Ne={inline:{requiredFeatures:["viewer"],optionalFeatures:[]},"immersive-vr":{requiredFeatures:["viewer","local"],optionalFeatures:[]},"immersive-ar":{requiredFeatures:["viewer","local"],optionalFeatures:[]}},he=`Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode
  or navigator.xr.requestSession('inline') prior to requesting an immersive
  session. This is a limitation specific to the WebXR Polyfill and does not apply
  to native implementations of the API.`;class Ce extends t{constructor(g){super(),this[F]={device:null,devicePromise:g,immersiveSession:null,inlineSessions:new Set},g.then(S=>{this[F].device=S})}isSessionSupported(g){return ei(this,null,function*(){return this[F].device||(yield this[F].devicePromise),g!="inline"?Promise.resolve(this[F].device.isSessionSupported(g)):Promise.resolve(!0)})}requestSession(g,S){return ei(this,null,function*(){if(!this[F].device){if(g!="inline")throw new Error(he);yield this[F].devicePromise}if(!J.includes(g))throw new TypeError(`The provided value '${g}' is not a valid enum value of type XRSessionMode`);const I=Ne[g],H=I.requiredFeatures.concat(S&&S.requiredFeatures?S.requiredFeatures:[]),Z=I.optionalFeatures.concat(S&&S.optionalFeatures?S.optionalFeatures:[]),ee=new Set;let oe=!1;for(let lt of H)this[F].device.isFeatureSupported(lt)?ee.add(lt):(console.error(`The required feature '${lt}' is not supported`),oe=!0);if(oe)throw new DOMException("Session does not support some required features","NotSupportedError");for(let lt of Z)this[F].device.isFeatureSupported(lt)?ee.add(lt):console.log(`The optional feature '${lt}' is not supported`);const Pe=yield this[F].device.requestSession(g,ee),be=new XRSession(this[F].device,g,Pe);g=="inline"?this[F].inlineSessions.add(be):this[F].immersiveSession=be;const Ke=()=>{g=="inline"?this[F].inlineSessions.delete(be):this[F].immersiveSession=null,be.removeEventListener("end",Ke)};return be.addEventListener("end",Ke),be})}}let ze;if("performance"in s)ze=()=>performance.now();else{let E=Date.now();ze=()=>Date.now()-E}var gt=ze;const Ut=Symbol("@@webxr-polyfill/XRPose");class ii{constructor(g,S){this[Ut]={transform:g,emulatedPosition:S}}get transform(){return this[Ut].transform}get emulatedPosition(){return this[Ut].emulatedPosition}}const Oe=Symbol("@@webxr-polyfill/XRViewerPose");class R extends ii{constructor(g,S,I=!1){super(g,I),this[Oe]={views:S}}get views(){return this[Oe].views}}const V=Symbol("@@webxr-polyfill/XRViewport");class ie{constructor(g){this[V]={target:g}}get x(){return this[V].target.x}get y(){return this[V].target.y}get width(){return this[V].target.width}get height(){return this[V].target.height}}const re=["left","right","none"],De=Symbol("@@webxr-polyfill/XRView");class Ze{constructor(g,S,I,H){if(!re.includes(I))throw new Error(`XREye must be one of: ${re}`);const Z=Object.create(null),ee=new ie(Z);this[De]={device:g,eye:I,viewport:ee,temp:Z,sessionId:H,transform:S}}get eye(){return this[De].eye}get projectionMatrix(){return this[De].device.getProjectionMatrix(this.eye)}get transform(){return this[De].transform}_getViewport(g){if(this[De].device.getViewport(this[De].sessionId,this.eye,g,this[De].temp))return this[De].viewport}}const He=Symbol("@@webxr-polyfill/XRFrame"),Rt="XRFrame access outside the callback that produced it is invalid.",Ft="getViewerPose can only be called on XRFrame objects passed to XRSession.requestAnimationFrame callbacks.";let di=0;class Qt{constructor(g,S,I){this[He]={id:++di,active:!1,animationFrame:!1,device:g,session:S,sessionId:I}}get session(){return this[He].session}getViewerPose(g){if(!this[He].animationFrame)throw new DOMException(Ft,"InvalidStateError");if(!this[He].active)throw new DOMException(Rt,"InvalidStateError");const S=this[He].device,I=this[He].session;I[ce].viewerSpace._ensurePoseUpdated(S,this[He].id),g._ensurePoseUpdated(S,this[He].id);let H=g._getSpaceRelativeTransform(I[ce].viewerSpace);const Z=[];for(let oe of I[ce].viewSpaces){oe._ensurePoseUpdated(S,this[He].id);let Pe=g._getSpaceRelativeTransform(oe),be=new Ze(S,Pe,oe.eye,this[He].sessionId);Z.push(be)}return new R(H,Z,!1)}getPose(g,S){if(!this[He].active)throw new DOMException(Rt,"InvalidStateError");const I=this[He].device;if(g._specialType==="target-ray"||g._specialType==="grip")return I.getInputPose(g._inputSource,S,g._specialType);{g._ensurePoseUpdated(I,this[He].id),S._ensurePoseUpdated(I,this[He].id);let H=S._getSpaceRelativeTransform(g);return H?new XRPose(H,!1):null}}}const bi=Symbol("@@webxr-polyfill/XRRenderState"),yn=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});class Vs{constructor(g={}){const S=Object.assign({},yn,g);this[bi]={config:S}}get depthNear(){return this[bi].config.depthNear}get depthFar(){return this[bi].config.depthFar}get inlineVerticalFieldOfView(){return this[bi].config.inlineVerticalFieldOfView}get baseLayer(){return this[bi].config.baseLayer}}const dg=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),zd=Symbol("@@webxr-polyfill/xr-compatible"),Vr=Symbol("@@webxr-polyfill/XRWebGLLayer"),KE=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});class ZE{constructor(g,S,I={}){const H=Object.assign({},KE,I);if(!(g instanceof fg))throw new Error("session must be a XRSession");if(g.ended)throw new Error("InvalidStateError");if(S[dg]&&S[zd]!==!0)throw new Error("InvalidStateError");const Z=S.getParameter(S.FRAMEBUFFER_BINDING);this[Vr]={context:S,config:H,framebuffer:Z,session:g}}get context(){return this[Vr].context}get antialias(){return this[Vr].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[Vr].framebuffer}get framebufferWidth(){return this[Vr].context.drawingBufferWidth}get framebufferHeight(){return this[Vr].context.drawingBufferHeight}get _session(){return this[Vr].session}getViewport(g){return g._getViewport(this)}static getNativeFramebufferScaleFactor(g){if(!g)throw new TypeError("getNativeFramebufferScaleFactor must be passed a session.");return g[ce].ended?0:1}}const Vd=Symbol("@@webxr-polyfill/XRInputSourceEvent");function Gd(E,g){const S=new Event(E,g);return S[Vd]={frame:g.frame,inputSource:g.inputSource},Object.setPrototypeOf(S,Gd.prototype),Object.defineProperty(S,"frame",{get(){return this[Vd].frame}}),Object.defineProperty(S,"inputSource",{get(){return this[Vd].inputSource}}),S}const ug=Symbol("@@webxr-polyfill/XRSessionEvent");function Ac(E,g){const S=new Event(E,g);return S[ug]={session:g.session},Object.setPrototypeOf(S,Ac.prototype),Object.defineProperty(S,"session",{get(){return this[ug].session}}),S}const Ec=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");function Hd(E,g){const S=new Event(E,g);return S[Ec]={session:g.session,added:g.added,removed:g.removed},Object.setPrototypeOf(S,Hd.prototype),Object.defineProperty(S,"session",{get(){return this[Ec].session}}),Object.defineProperty(S,"added",{get(){return this[Ec].added}}),Object.defineProperty(S,"removed",{get(){return this[Ec].removed}}),S}const ce=Symbol("@@webxr-polyfill/XRSession");class Wd extends Ae{constructor(g){super(g)}get eye(){return this._specialType}_onPoseUpdate(g){this._inverseBaseMatrix=g.getBaseViewMatrix(this._specialType)}}class fg extends t{constructor(g,S,I){super();let H=S!="inline",Z=new Vs({inlineVerticalFieldOfView:H?null:Math.PI*.5});this[ce]={device:g,mode:S,immersive:H,ended:!1,suspended:!1,frameCallbacks:[],currentFrameCallbacks:null,frameHandle:0,deviceFrameHandle:null,id:I,activeRenderState:Z,pendingRenderState:null,viewerSpace:new ft("viewer"),viewSpaces:[],currentInputSources:[]},H?this[ce].viewSpaces.push(new Wd("left"),new Wd("right")):this[ce].viewSpaces.push(new Wd("none")),this[ce].onDeviceFrame=()=>{if(this[ce].ended||this[ce].suspended||(this[ce].deviceFrameHandle=null,this[ce].startDeviceFrameLoop(),this[ce].pendingRenderState!==null&&(this[ce].activeRenderState=new Vs(this[ce].pendingRenderState),this[ce].pendingRenderState=null,this[ce].activeRenderState.baseLayer&&this[ce].device.onBaseLayerSet(this[ce].id,this[ce].activeRenderState.baseLayer)),this[ce].activeRenderState.baseLayer===null))return;const ee=new Qt(g,this,this[ce].id),oe=this[ce].currentFrameCallbacks=this[ce].frameCallbacks;this[ce].frameCallbacks=[],ee[He].active=!0,ee[He].animationFrame=!0,this[ce].device.onFrameStart(this[ce].id,this[ce].activeRenderState),this._checkInputSourcesChange();const Pe=gt();for(let be=0;be<oe.length;be++)try{!oe[be].cancelled&&typeof oe[be].callback=="function"&&oe[be].callback(Pe,ee)}catch(Ke){console.error(Ke)}this[ce].currentFrameCallbacks=null,ee[He].active=!1,this[ce].device.onFrameEnd(this[ce].id)},this[ce].startDeviceFrameLoop=()=>{this[ce].deviceFrameHandle===null&&(this[ce].deviceFrameHandle=this[ce].device.requestAnimationFrame(this[ce].onDeviceFrame))},this[ce].stopDeviceFrameLoop=()=>{const ee=this[ce].deviceFrameHandle;ee!==null&&(this[ce].device.cancelAnimationFrame(ee),this[ce].deviceFrameHandle=null)},this[ce].onPresentationEnd=ee=>{if(ee!==this[ce].id){this[ce].suspended=!1,this[ce].startDeviceFrameLoop(),this.dispatchEvent("focus",{session:this});return}this[ce].ended=!0,this[ce].stopDeviceFrameLoop(),g.removeEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),g.removeEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),g.removeEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),g.removeEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",Ac("end",{session:this}))},g.addEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].onPresentationStart=ee=>{ee!==this[ce].id&&(this[ce].suspended=!0,this[ce].stopDeviceFrameLoop(),this.dispatchEvent("blur",{session:this}))},g.addEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].onSelectStart=ee=>{ee.sessionId===this[ce].id&&this[ce].dispatchInputSourceEvent("selectstart",ee.inputSource)},g.addEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].onSelectEnd=ee=>{ee.sessionId===this[ce].id&&(this[ce].dispatchInputSourceEvent("selectend",ee.inputSource),this[ce].dispatchInputSourceEvent("select",ee.inputSource))},g.addEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this[ce].onSqueezeStart=ee=>{ee.sessionId===this[ce].id&&this[ce].dispatchInputSourceEvent("squeezestart",ee.inputSource)},g.addEventListener("@@webxr-polyfill/input-squeeze-start",this[ce].onSqueezeStart),this[ce].onSqueezeEnd=ee=>{ee.sessionId===this[ce].id&&(this[ce].dispatchInputSourceEvent("squeezeend",ee.inputSource),this[ce].dispatchInputSourceEvent("squeeze",ee.inputSource))},g.addEventListener("@@webxr-polyfill/input-squeeze-end",this[ce].onSqueezeEnd),this[ce].dispatchInputSourceEvent=(ee,oe)=>{const Pe=new Qt(g,this,this[ce].id),be=Gd(ee,{frame:Pe,inputSource:oe});Pe[He].active=!0,this.dispatchEvent(ee,be),Pe[He].active=!1},this[ce].startDeviceFrameLoop(),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ce].activeRenderState}get environmentBlendMode(){return this[ce].device.environmentBlendMode||"opaque"}requestReferenceSpace(g){return ei(this,null,function*(){if(this[ce].ended)return;if(!rt.includes(g))throw new TypeError(`XRReferenceSpaceType must be one of ${rt}`);if(!this[ce].device.doesSessionSupportReferenceSpace(this[ce].id,g))throw new DOMException(`The ${g} reference space is not supported by this session.`,"NotSupportedError");if(g==="viewer")return this[ce].viewerSpace;let S=yield this[ce].device.requestFrameOfReferenceTransform(g);if(g==="bounded-floor")throw S?this[ce].device.requestStageBounds()?new DOMException(`The WebXR polyfill does not support the ${g} reference space yet.`,"NotSupportedError"):new DOMException(`${g} XRReferenceSpace not supported by this device.`,"NotSupportedError"):new DOMException(`${g} XRReferenceSpace not supported by this device.`,"NotSupportedError");return new ft(g,S)})}requestAnimationFrame(g){if(this[ce].ended)return;const S=++this[ce].frameHandle;return this[ce].frameCallbacks.push({handle:S,callback:g,cancelled:!1}),S}cancelAnimationFrame(g){let S=this[ce].frameCallbacks,I=S.findIndex(H=>H&&H.handle===g);I>-1&&(S[I].cancelled=!0,S.splice(I,1)),S=this[ce].currentFrameCallbacks,S&&(I=S.findIndex(H=>H&&H.handle===g),I>-1&&(S[I].cancelled=!0))}get inputSources(){return this[ce].device.getInputSources()}end(){return ei(this,null,function*(){if(!this[ce].ended)return this[ce].immersive&&(this[ce].ended=!0,this[ce].device.removeEventListener("@@webxr-polyfill/vr-present-start",this[ce].onPresentationStart),this[ce].device.removeEventListener("@@webxr-polyfill/vr-present-end",this[ce].onPresentationEnd),this[ce].device.removeEventListener("@@webxr-polyfill/input-select-start",this[ce].onSelectStart),this[ce].device.removeEventListener("@@webxr-polyfill/input-select-end",this[ce].onSelectEnd),this.dispatchEvent("end",Ac("end",{session:this}))),this[ce].stopDeviceFrameLoop(),this[ce].device.endSession(this[ce].id)})}updateRenderState(g){if(this[ce].ended){const I="Can't call updateRenderState on an XRSession that has already ended.";throw new Error(I)}if(g.baseLayer&&g.baseLayer._session!==this){const I="Called updateRenderState with a base layer that was created by a different session.";throw new Error(I)}if(g.inlineVerticalFieldOfView!==null&&g.inlineVerticalFieldOfView!==void 0)if(this[ce].immersive){const I="inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.";throw new Error(I)}else g.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,g.inlineVerticalFieldOfView));if(this[ce].pendingRenderState===null){const I=this[ce].activeRenderState;this[ce].pendingRenderState={depthNear:I.depthNear,depthFar:I.depthFar,inlineVerticalFieldOfView:I.inlineVerticalFieldOfView,baseLayer:I.baseLayer}}Object.assign(this[ce].pendingRenderState,g)}_checkInputSourcesChange(){const g=[],S=[],I=this.inputSources,H=this[ce].currentInputSources;for(const Z of I)H.includes(Z)||g.push(Z);for(const Z of H)I.includes(Z)||S.push(Z);(g.length>0||S.length>0)&&this.dispatchEvent("inputsourceschange",Hd("inputsourceschange",{session:this,added:g,removed:S})),this[ce].currentInputSources.length=0;for(const Z of I)this[ce].currentInputSources.push(Z)}}const lr=Symbol("@@webxr-polyfill/XRInputSource");class pg{constructor(g){this[lr]={impl:g,gripSpace:new Ae("grip",this),targetRaySpace:new Ae("target-ray",this)}}get handedness(){return this[lr].impl.handedness}get targetRayMode(){return this[lr].impl.targetRayMode}get gripSpace(){let g=this[lr].impl.targetRayMode;return g==="gaze"||g==="screen"?null:this[lr].gripSpace}get targetRaySpace(){return this[lr].targetRaySpace}get profiles(){return this[lr].impl.profiles}get gamepad(){return this[lr].impl.gamepad}}const jd=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");function mg(E,g){const S=new Event(E,g);return S[jd]={referenceSpace:g.referenceSpace,transform:g.transform||null},Object.setPrototypeOf(S,mg.prototype),Object.defineProperty(S,"referenceSpace",{get(){return this[jd].referenceSpace}}),Object.defineProperty(S,"transform",{get(){return this[jd].transform}}),S}var Xd={XRSystem:Ce,XRSession:fg,XRSessionEvent:Ac,XRFrame:Qt,XRView:Ze,XRViewport:ie,XRViewerPose:R,XRWebGLLayer:ZE,XRSpace:Ae,XRReferenceSpace:ft,XRReferenceSpaceEvent:mg,XRInputSource:pg,XRInputSourceEvent:Gd,XRInputSourcesChangeEvent:Hd,XRRenderState:Vs,XRRigidTransform:Qe,XRPose:ii};const gg=E=>typeof E.prototype.makeXRCompatible=="function"?!1:(E.prototype.makeXRCompatible=function(){return this[zd]=!0,Promise.resolve()},!0),_g=E=>{const g=E.prototype.getContext;E.prototype.getContext=function(S,I){const H=g.call(this,S,I);return H&&(H[dg]=!0,I&&"xrCompatible"in I&&(H[zd]=I.xrCompatible)),H}},$E=E=>!!(E.ImageBitmapRenderingContext&&E.createImageBitmap),JE=E=>{var g=!1;return function(S){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(S)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(S.substr(0,4)))&&(g=!0)}(E.navigator.userAgent||E.navigator.vendor||E.opera),g},ew=E=>{E.style.display="block",E.style.position="absolute",E.style.width=E.style.height="1px",E.style.top=E.style.left="0px"};var qd=typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function tw(E){return E&&E.__esModule&&Object.prototype.hasOwnProperty.call(E,"default")?E.default:E}function iw(E,g){return g={exports:{}},E(g,g.exports),g.exports}var nw=iw(function(E,g){(function(S,I){E.exports=I()})(qd,function(){var S=function(v,x){if(!(v instanceof x))throw new TypeError("Cannot call a class as a function")},I=function(){function v(x,w){for(var P=0;P<w.length;P++){var L=w[P];L.enumerable=L.enumerable||!1,L.configurable=!0,"value"in L&&(L.writable=!0),Object.defineProperty(x,L.key,L)}}return function(x,w,P){return w&&v(x.prototype,w),P&&v(x,P),x}}(),H=function(){function v(x,w){var P=[],L=!0,W=!1,Y=void 0;try{for(var fe=x[Symbol.iterator](),pe;!(L=(pe=fe.next()).done)&&(P.push(pe.value),!(w&&P.length===w));L=!0);}catch($){W=!0,Y=$}finally{try{!L&&fe.return&&fe.return()}finally{if(W)throw Y}}return P}return function(x,w){if(Array.isArray(x))return x;if(Symbol.iterator in Object(x))return v(x,w);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),Z=.001,ee=1,oe=function(x,w){return"data:"+x+","+encodeURIComponent(w)},Pe=function(x,w,P){return x+(w-x)*P},be=function(){var v=/iPad|iPhone|iPod/.test(navigator.platform);return function(){return v}}(),Ke=function(){var v=navigator.userAgent.indexOf("Version")!==-1&&navigator.userAgent.indexOf("Android")!==-1&&navigator.userAgent.indexOf("Chrome")!==-1;return function(){return v}}(),lt=function(){var v=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);return function(){return v}}(),Ot=function(){var v=navigator.userAgent.indexOf("Firefox")!==-1&&navigator.userAgent.indexOf("Android")!==-1;return function(){return v}}(),Gt=function(){var v=navigator.userAgent.match(/.*Chrome\/([0-9]+)/),x=v?parseInt(v[1],10):null;return function(){return x}}(),$t=function(){var v=!1;return v=be()&&lt()&&navigator.userAgent.indexOf("13_4")!==-1,function(){return v}}(),Ht=function(){var v=!1;if(Gt()===65){var x=navigator.userAgent.match(/.*Chrome\/([0-9\.]*)/);if(x){var w=x[1].split("."),P=H(w,4),L=P[0],W=P[1],Y=P[2],fe=P[3];v=parseInt(Y,10)===3325&&parseInt(fe,10)<148}}return function(){return v}}(),Bt=function(){var v=navigator.userAgent.indexOf("R7 Build")!==-1;return function(){return v}}(),ui=function(){var x=window.orientation==90||window.orientation==-90;return Bt()?!x:x},Ui=function(x){return!(isNaN(x)||x<=Z||x>ee)},At=function(){return Math.max(window.screen.width,window.screen.height)*window.devicePixelRatio},Pt=function(){return Math.min(window.screen.width,window.screen.height)*window.devicePixelRatio},It=function(x){if(Ke())return!1;if(x.requestFullscreen)x.requestFullscreen();else if(x.webkitRequestFullscreen)x.webkitRequestFullscreen();else if(x.mozRequestFullScreen)x.mozRequestFullScreen();else if(x.msRequestFullscreen)x.msRequestFullscreen();else return!1;return!0},yt=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.msExitFullscreen)document.msExitFullscreen();else return!1;return!0},os=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},cr=function(x,w,P,L){var W=x.createShader(x.VERTEX_SHADER);x.shaderSource(W,w),x.compileShader(W);var Y=x.createShader(x.FRAGMENT_SHADER);x.shaderSource(Y,P),x.compileShader(Y);var fe=x.createProgram();x.attachShader(fe,W),x.attachShader(fe,Y);for(var pe in L)x.bindAttribLocation(fe,L[pe],pe);return x.linkProgram(fe),x.deleteShader(W),x.deleteShader(Y),fe},hr=function(x,w){for(var P={},L=x.getProgramParameter(w,x.ACTIVE_UNIFORMS),W="",Y=0;Y<L;Y++){var fe=x.getActiveUniform(w,Y);W=fe.name.replace("[0]",""),P[W]=x.getUniformLocation(w,W)}return P},Gr=function(x,w,P,L,W,Y,fe){var pe=1/(w-P),$=1/(L-W),se=1/(Y-fe);return x[0]=-2*pe,x[1]=0,x[2]=0,x[3]=0,x[4]=0,x[5]=-2*$,x[6]=0,x[7]=0,x[8]=0,x[9]=0,x[10]=2*se,x[11]=0,x[12]=(w+P)*pe,x[13]=(W+L)*$,x[14]=(fe+Y)*se,x[15]=1,x},Gs=function(){var x=!1;return function(w){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(w)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(w.substr(0,4)))&&(x=!0)}(navigator.userAgent||navigator.vendor||window.opera),x},dr=function(x,w){for(var P in w)w.hasOwnProperty(P)&&(x[P]=w[P]);return x},Hs=function(x){if(be()){var w=x.style.width,P=x.style.height;x.style.width=parseInt(w)+1+"px",x.style.height=parseInt(P)+"px",setTimeout(function(){x.style.width=w,x.style.height=P},100)}window.canvas=x},yi=function(){var v=Math.PI/180,x=Math.PI*.25;function w($,se,Te,$e){var ot=Math.tan(se?se.upDegrees*v:x),ht=Math.tan(se?se.downDegrees*v:x),Et=Math.tan(se?se.leftDegrees*v:x),mt=Math.tan(se?se.rightDegrees*v:x),pt=2/(Et+mt),Jt=2/(ot+ht);return $[0]=pt,$[1]=0,$[2]=0,$[3]=0,$[4]=0,$[5]=Jt,$[6]=0,$[7]=0,$[8]=-((Et-mt)*pt*.5),$[9]=(ot-ht)*Jt*.5,$[10]=$e/(Te-$e),$[11]=-1,$[12]=0,$[13]=0,$[14]=$e*Te/(Te-$e),$[15]=0,$}function P($,se,Te){var $e=se[0],ot=se[1],ht=se[2],Et=se[3],mt=$e+$e,pt=ot+ot,Jt=ht+ht,Ai=$e*mt,Oi=$e*pt,pi=$e*Jt,tn=ot*pt,xn=ot*Jt,An=ht*Jt,En=Et*mt,wn=Et*pt,ur=Et*Jt;return $[0]=1-(tn+An),$[1]=Oi+ur,$[2]=pi-wn,$[3]=0,$[4]=Oi-ur,$[5]=1-(Ai+An),$[6]=xn+En,$[7]=0,$[8]=pi+wn,$[9]=xn-En,$[10]=1-(Ai+tn),$[11]=0,$[12]=Te[0],$[13]=Te[1],$[14]=Te[2],$[15]=1,$}function L($,se,Te){var $e=Te[0],ot=Te[1],ht=Te[2],Et,mt,pt,Jt,Ai,Oi,pi,tn,xn,An,En,wn;return se===$?($[12]=se[0]*$e+se[4]*ot+se[8]*ht+se[12],$[13]=se[1]*$e+se[5]*ot+se[9]*ht+se[13],$[14]=se[2]*$e+se[6]*ot+se[10]*ht+se[14],$[15]=se[3]*$e+se[7]*ot+se[11]*ht+se[15]):(Et=se[0],mt=se[1],pt=se[2],Jt=se[3],Ai=se[4],Oi=se[5],pi=se[6],tn=se[7],xn=se[8],An=se[9],En=se[10],wn=se[11],$[0]=Et,$[1]=mt,$[2]=pt,$[3]=Jt,$[4]=Ai,$[5]=Oi,$[6]=pi,$[7]=tn,$[8]=xn,$[9]=An,$[10]=En,$[11]=wn,$[12]=Et*$e+Ai*ot+xn*ht+se[12],$[13]=mt*$e+Oi*ot+An*ht+se[13],$[14]=pt*$e+pi*ot+En*ht+se[14],$[15]=Jt*$e+tn*ot+wn*ht+se[15]),$}function W($,se){var Te=se[0],$e=se[1],ot=se[2],ht=se[3],Et=se[4],mt=se[5],pt=se[6],Jt=se[7],Ai=se[8],Oi=se[9],pi=se[10],tn=se[11],xn=se[12],An=se[13],En=se[14],wn=se[15],ur=Te*mt-$e*Et,Va=Te*pt-ot*Et,Ga=Te*Jt-ht*Et,Ha=$e*pt-ot*mt,Wa=$e*Jt-ht*mt,ja=ot*Jt-ht*pt,Xa=Ai*An-Oi*xn,qa=Ai*En-pi*xn,Ya=Ai*wn-tn*xn,Qa=Oi*En-pi*An,Ka=Oi*wn-tn*An,Za=pi*wn-tn*En,Mi=ur*Za-Va*Ka+Ga*Qa+Ha*Ya-Wa*qa+ja*Xa;return Mi?(Mi=1/Mi,$[0]=(mt*Za-pt*Ka+Jt*Qa)*Mi,$[1]=(ot*Ka-$e*Za-ht*Qa)*Mi,$[2]=(An*ja-En*Wa+wn*Ha)*Mi,$[3]=(pi*Wa-Oi*ja-tn*Ha)*Mi,$[4]=(pt*Ya-Et*Za-Jt*qa)*Mi,$[5]=(Te*Za-ot*Ya+ht*qa)*Mi,$[6]=(En*Ga-xn*ja-wn*Va)*Mi,$[7]=(Ai*ja-pi*Ga+tn*Va)*Mi,$[8]=(Et*Ka-mt*Ya+Jt*Xa)*Mi,$[9]=($e*Ya-Te*Ka-ht*Xa)*Mi,$[10]=(xn*Wa-An*Ga+wn*ur)*Mi,$[11]=(Oi*Ga-Ai*Wa-tn*ur)*Mi,$[12]=(mt*qa-Et*Qa-pt*Xa)*Mi,$[13]=(Te*Qa-$e*qa+ot*Xa)*Mi,$[14]=(An*Va-xn*Ha-En*ur)*Mi,$[15]=(Ai*Ha-Oi*Va+pi*ur)*Mi,$):null}var Y=new Float32Array([0,0,0,1]),fe=new Float32Array([0,0,0]);function pe($,se,Te,$e,ot,ht){w($,$e||null,ht.depthNear,ht.depthFar);var Et=Te.orientation||Y,mt=Te.position||fe;P(se,Et,mt),ot&&L(se,se,ot),W(se,se)}return function($,se,Te){return!$||!se?!1:($.pose=se,$.timestamp=se.timestamp,pe($.leftProjectionMatrix,$.leftViewMatrix,se,Te._getFieldOfView("left"),Te._getEyeOffset("left"),Te),pe($.rightProjectionMatrix,$.rightViewMatrix,se,Te._getFieldOfView("right"),Te._getEyeOffset("right"),Te),!0)}}(),Ow=function(){var x=window.self!==window.top,w=Pg(document.referrer),P=Pg(window.location.href);return x&&w!==P},Pg=function(x){var w,P=x.indexOf("://");P!==-1?w=P+3:w=0;var L=x.indexOf("/",w);return L===-1&&(L=x.length),x.substring(0,L)},Bw=function(x){if(x.w>1)return console.warn("getQuaternionAngle: w > 1"),0;var w=2*Math.acos(x.w);return w},Qd=function(){var v={};return function(x,w){v[x]===void 0&&(console.warn("webvr-polyfill: "+w),v[x]=!0)}}(),Hr=function(x,w){var P=w?"Please use "+w+" instead.":"";Qd(x,x+" has been deprecated. This may not work on native WebVR displays. "+P)};function Nw(v,x,w){if(!x){w(v);return}for(var P=[],L=null,W=0;W<x.length;++W){var Y=x[W];switch(Y){case v.TEXTURE_BINDING_2D:case v.TEXTURE_BINDING_CUBE_MAP:var fe=x[++W];if(fe<v.TEXTURE0||fe>v.TEXTURE31){console.error("TEXTURE_BINDING_2D or TEXTURE_BINDING_CUBE_MAP must be followed by a valid texture unit"),P.push(null,null);break}L||(L=v.getParameter(v.ACTIVE_TEXTURE)),v.activeTexture(fe),P.push(v.getParameter(Y),null);break;case v.ACTIVE_TEXTURE:L=v.getParameter(v.ACTIVE_TEXTURE),P.push(null);break;default:P.push(v.getParameter(Y));break}}w(v);for(var W=0;W<x.length;++W){var Y=x[W],pe=P[W];switch(Y){case v.ACTIVE_TEXTURE:break;case v.ARRAY_BUFFER_BINDING:v.bindBuffer(v.ARRAY_BUFFER,pe);break;case v.COLOR_CLEAR_VALUE:v.clearColor(pe[0],pe[1],pe[2],pe[3]);break;case v.COLOR_WRITEMASK:v.colorMask(pe[0],pe[1],pe[2],pe[3]);break;case v.CURRENT_PROGRAM:v.useProgram(pe);break;case v.ELEMENT_ARRAY_BUFFER_BINDING:v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,pe);break;case v.FRAMEBUFFER_BINDING:v.bindFramebuffer(v.FRAMEBUFFER,pe);break;case v.RENDERBUFFER_BINDING:v.bindRenderbuffer(v.RENDERBUFFER,pe);break;case v.TEXTURE_BINDING_2D:var fe=x[++W];if(fe<v.TEXTURE0||fe>v.TEXTURE31)break;v.activeTexture(fe),v.bindTexture(v.TEXTURE_2D,pe);break;case v.TEXTURE_BINDING_CUBE_MAP:var fe=x[++W];if(fe<v.TEXTURE0||fe>v.TEXTURE31)break;v.activeTexture(fe),v.bindTexture(v.TEXTURE_CUBE_MAP,pe);break;case v.VIEWPORT:v.viewport(pe[0],pe[1],pe[2],pe[3]);break;case v.BLEND:case v.CULL_FACE:case v.DEPTH_TEST:case v.SCISSOR_TEST:case v.STENCIL_TEST:pe?v.enable(Y):v.disable(Y);break;default:console.log("No GL restore behavior for 0x"+Y.toString(16));break}L&&v.activeTexture(L)}}var ka=Nw,kw=["attribute vec2 position;","attribute vec3 texCoord;","varying vec2 vTexCoord;","uniform vec4 viewportOffsetScale[2];","void main() {","  vec4 viewport = viewportOffsetScale[int(texCoord.z)];","  vTexCoord = (texCoord.xy * viewport.zw) + viewport.xy;","  gl_Position = vec4( position, 1.0, 1.0 );","}"].join(`
`),Uw=["precision mediump float;","uniform sampler2D diffuse;","varying vec2 vTexCoord;","void main() {","  gl_FragColor = texture2D(diffuse, vTexCoord);","}"].join(`
`);function as(v,x,w,P){this.gl=v,this.cardboardUI=x,this.bufferScale=w,this.dirtySubmitFrameBindings=P,this.ctxAttribs=v.getContextAttributes(),this.instanceExt=v.getExtension("ANGLE_instanced_arrays"),this.meshWidth=20,this.meshHeight=20,this.bufferWidth=v.drawingBufferWidth,this.bufferHeight=v.drawingBufferHeight,this.realBindFramebuffer=v.bindFramebuffer,this.realEnable=v.enable,this.realDisable=v.disable,this.realColorMask=v.colorMask,this.realClearColor=v.clearColor,this.realViewport=v.viewport,be()||(this.realCanvasWidth=Object.getOwnPropertyDescriptor(v.canvas.__proto__,"width"),this.realCanvasHeight=Object.getOwnPropertyDescriptor(v.canvas.__proto__,"height")),this.isPatched=!1,this.lastBoundFramebuffer=null,this.cullFace=!1,this.depthTest=!1,this.blend=!1,this.scissorTest=!1,this.stencilTest=!1,this.viewport=[0,0,0,0],this.colorMask=[!0,!0,!0,!0],this.clearColor=[0,0,0,0],this.attribs={position:0,texCoord:1},this.program=cr(v,kw,Uw,this.attribs),this.uniforms=hr(v,this.program),this.viewportOffsetScale=new Float32Array(8),this.setTextureBounds(),this.vertexBuffer=v.createBuffer(),this.indexBuffer=v.createBuffer(),this.indexCount=0,this.renderTarget=v.createTexture(),this.framebuffer=v.createFramebuffer(),this.depthStencilBuffer=null,this.depthBuffer=null,this.stencilBuffer=null,this.ctxAttribs.depth&&this.ctxAttribs.stencil?this.depthStencilBuffer=v.createRenderbuffer():this.ctxAttribs.depth?this.depthBuffer=v.createRenderbuffer():this.ctxAttribs.stencil&&(this.stencilBuffer=v.createRenderbuffer()),this.patch(),this.onResize()}as.prototype.destroy=function(){var v=this.gl;this.unpatch(),v.deleteProgram(this.program),v.deleteBuffer(this.vertexBuffer),v.deleteBuffer(this.indexBuffer),v.deleteTexture(this.renderTarget),v.deleteFramebuffer(this.framebuffer),this.depthStencilBuffer&&v.deleteRenderbuffer(this.depthStencilBuffer),this.depthBuffer&&v.deleteRenderbuffer(this.depthBuffer),this.stencilBuffer&&v.deleteRenderbuffer(this.stencilBuffer),this.cardboardUI&&this.cardboardUI.destroy()},as.prototype.onResize=function(){var v=this.gl,x=this,w=[v.RENDERBUFFER_BINDING,v.TEXTURE_BINDING_2D,v.TEXTURE0];ka(v,w,function(P){x.realBindFramebuffer.call(P,P.FRAMEBUFFER,null),x.scissorTest&&x.realDisable.call(P,P.SCISSOR_TEST),x.realColorMask.call(P,!0,!0,!0,!0),x.realViewport.call(P,0,0,P.drawingBufferWidth,P.drawingBufferHeight),x.realClearColor.call(P,0,0,0,1),P.clear(P.COLOR_BUFFER_BIT),x.realBindFramebuffer.call(P,P.FRAMEBUFFER,x.framebuffer),P.bindTexture(P.TEXTURE_2D,x.renderTarget),P.texImage2D(P.TEXTURE_2D,0,x.ctxAttribs.alpha?P.RGBA:P.RGB,x.bufferWidth,x.bufferHeight,0,x.ctxAttribs.alpha?P.RGBA:P.RGB,P.UNSIGNED_BYTE,null),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MAG_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_MIN_FILTER,P.LINEAR),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_S,P.CLAMP_TO_EDGE),P.texParameteri(P.TEXTURE_2D,P.TEXTURE_WRAP_T,P.CLAMP_TO_EDGE),P.framebufferTexture2D(P.FRAMEBUFFER,P.COLOR_ATTACHMENT0,P.TEXTURE_2D,x.renderTarget,0),x.ctxAttribs.depth&&x.ctxAttribs.stencil?(P.bindRenderbuffer(P.RENDERBUFFER,x.depthStencilBuffer),P.renderbufferStorage(P.RENDERBUFFER,P.DEPTH_STENCIL,x.bufferWidth,x.bufferHeight),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_STENCIL_ATTACHMENT,P.RENDERBUFFER,x.depthStencilBuffer)):x.ctxAttribs.depth?(P.bindRenderbuffer(P.RENDERBUFFER,x.depthBuffer),P.renderbufferStorage(P.RENDERBUFFER,P.DEPTH_COMPONENT16,x.bufferWidth,x.bufferHeight),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.DEPTH_ATTACHMENT,P.RENDERBUFFER,x.depthBuffer)):x.ctxAttribs.stencil&&(P.bindRenderbuffer(P.RENDERBUFFER,x.stencilBuffer),P.renderbufferStorage(P.RENDERBUFFER,P.STENCIL_INDEX8,x.bufferWidth,x.bufferHeight),P.framebufferRenderbuffer(P.FRAMEBUFFER,P.STENCIL_ATTACHMENT,P.RENDERBUFFER,x.stencilBuffer)),!P.checkFramebufferStatus(P.FRAMEBUFFER)===P.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer incomplete!"),x.realBindFramebuffer.call(P,P.FRAMEBUFFER,x.lastBoundFramebuffer),x.scissorTest&&x.realEnable.call(P,P.SCISSOR_TEST),x.realColorMask.apply(P,x.colorMask),x.realViewport.apply(P,x.viewport),x.realClearColor.apply(P,x.clearColor)}),this.cardboardUI&&this.cardboardUI.onResize()},as.prototype.patch=function(){if(!this.isPatched){var v=this,x=this.gl.canvas,w=this.gl;be()||(x.width=At()*this.bufferScale,x.height=Pt()*this.bufferScale,Object.defineProperty(x,"width",{configurable:!0,enumerable:!0,get:function(){return v.bufferWidth},set:function(L){v.bufferWidth=L,v.realCanvasWidth.set.call(x,L),v.onResize()}}),Object.defineProperty(x,"height",{configurable:!0,enumerable:!0,get:function(){return v.bufferHeight},set:function(L){v.bufferHeight=L,v.realCanvasHeight.set.call(x,L),v.onResize()}})),this.lastBoundFramebuffer=w.getParameter(w.FRAMEBUFFER_BINDING),this.lastBoundFramebuffer==null&&(this.lastBoundFramebuffer=this.framebuffer,this.gl.bindFramebuffer(w.FRAMEBUFFER,this.framebuffer)),this.gl.bindFramebuffer=function(P,L){v.lastBoundFramebuffer=L||v.framebuffer,v.realBindFramebuffer.call(w,P,v.lastBoundFramebuffer)},this.cullFace=w.getParameter(w.CULL_FACE),this.depthTest=w.getParameter(w.DEPTH_TEST),this.blend=w.getParameter(w.BLEND),this.scissorTest=w.getParameter(w.SCISSOR_TEST),this.stencilTest=w.getParameter(w.STENCIL_TEST),w.enable=function(P){switch(P){case w.CULL_FACE:v.cullFace=!0;break;case w.DEPTH_TEST:v.depthTest=!0;break;case w.BLEND:v.blend=!0;break;case w.SCISSOR_TEST:v.scissorTest=!0;break;case w.STENCIL_TEST:v.stencilTest=!0;break}v.realEnable.call(w,P)},w.disable=function(P){switch(P){case w.CULL_FACE:v.cullFace=!1;break;case w.DEPTH_TEST:v.depthTest=!1;break;case w.BLEND:v.blend=!1;break;case w.SCISSOR_TEST:v.scissorTest=!1;break;case w.STENCIL_TEST:v.stencilTest=!1;break}v.realDisable.call(w,P)},this.colorMask=w.getParameter(w.COLOR_WRITEMASK),w.colorMask=function(P,L,W,Y){v.colorMask[0]=P,v.colorMask[1]=L,v.colorMask[2]=W,v.colorMask[3]=Y,v.realColorMask.call(w,P,L,W,Y)},this.clearColor=w.getParameter(w.COLOR_CLEAR_VALUE),w.clearColor=function(P,L,W,Y){v.clearColor[0]=P,v.clearColor[1]=L,v.clearColor[2]=W,v.clearColor[3]=Y,v.realClearColor.call(w,P,L,W,Y)},this.viewport=w.getParameter(w.VIEWPORT),w.viewport=function(P,L,W,Y){v.viewport[0]=P,v.viewport[1]=L,v.viewport[2]=W,v.viewport[3]=Y,v.realViewport.call(w,P,L,W,Y)},this.isPatched=!0,Hs(x)}},as.prototype.unpatch=function(){if(this.isPatched){var v=this.gl,x=this.gl.canvas;be()||(Object.defineProperty(x,"width",this.realCanvasWidth),Object.defineProperty(x,"height",this.realCanvasHeight)),x.width=this.bufferWidth,x.height=this.bufferHeight,v.bindFramebuffer=this.realBindFramebuffer,v.enable=this.realEnable,v.disable=this.realDisable,v.colorMask=this.realColorMask,v.clearColor=this.realClearColor,v.viewport=this.realViewport,this.lastBoundFramebuffer==this.framebuffer&&v.bindFramebuffer(v.FRAMEBUFFER,null),this.isPatched=!1,setTimeout(function(){Hs(x)},1)}},as.prototype.setTextureBounds=function(v,x){v||(v=[0,0,.5,1]),x||(x=[.5,0,.5,1]),this.viewportOffsetScale[0]=v[0],this.viewportOffsetScale[1]=v[1],this.viewportOffsetScale[2]=v[2],this.viewportOffsetScale[3]=v[3],this.viewportOffsetScale[4]=x[0],this.viewportOffsetScale[5]=x[1],this.viewportOffsetScale[6]=x[2],this.viewportOffsetScale[7]=x[3]},as.prototype.submitFrame=function(){var v=this.gl,x=this,w=[];if(this.dirtySubmitFrameBindings||w.push(v.CURRENT_PROGRAM,v.ARRAY_BUFFER_BINDING,v.ELEMENT_ARRAY_BUFFER_BINDING,v.TEXTURE_BINDING_2D,v.TEXTURE0),ka(v,w,function(L){x.realBindFramebuffer.call(L,L.FRAMEBUFFER,null);var W=0,Y=0;x.instanceExt&&(W=L.getVertexAttrib(x.attribs.position,x.instanceExt.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE),Y=L.getVertexAttrib(x.attribs.texCoord,x.instanceExt.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE)),x.cullFace&&x.realDisable.call(L,L.CULL_FACE),x.depthTest&&x.realDisable.call(L,L.DEPTH_TEST),x.blend&&x.realDisable.call(L,L.BLEND),x.scissorTest&&x.realDisable.call(L,L.SCISSOR_TEST),x.stencilTest&&x.realDisable.call(L,L.STENCIL_TEST),x.realColorMask.call(L,!0,!0,!0,!0),x.realViewport.call(L,0,0,L.drawingBufferWidth,L.drawingBufferHeight),(x.ctxAttribs.alpha||be())&&(x.realClearColor.call(L,0,0,0,1),L.clear(L.COLOR_BUFFER_BIT)),L.useProgram(x.program),L.bindBuffer(L.ELEMENT_ARRAY_BUFFER,x.indexBuffer),L.bindBuffer(L.ARRAY_BUFFER,x.vertexBuffer),L.enableVertexAttribArray(x.attribs.position),L.enableVertexAttribArray(x.attribs.texCoord),L.vertexAttribPointer(x.attribs.position,2,L.FLOAT,!1,20,0),L.vertexAttribPointer(x.attribs.texCoord,3,L.FLOAT,!1,20,8),x.instanceExt&&(W!=0&&x.instanceExt.vertexAttribDivisorANGLE(x.attribs.position,0),Y!=0&&x.instanceExt.vertexAttribDivisorANGLE(x.attribs.texCoord,0)),L.activeTexture(L.TEXTURE0),L.uniform1i(x.uniforms.diffuse,0),L.bindTexture(L.TEXTURE_2D,x.renderTarget),L.uniform4fv(x.uniforms.viewportOffsetScale,x.viewportOffsetScale),L.drawElements(L.TRIANGLES,x.indexCount,L.UNSIGNED_SHORT,0),x.cardboardUI&&x.cardboardUI.renderNoState(),x.realBindFramebuffer.call(x.gl,L.FRAMEBUFFER,x.framebuffer),x.ctxAttribs.preserveDrawingBuffer||(x.realClearColor.call(L,0,0,0,0),L.clear(L.COLOR_BUFFER_BIT)),x.dirtySubmitFrameBindings||x.realBindFramebuffer.call(L,L.FRAMEBUFFER,x.lastBoundFramebuffer),x.cullFace&&x.realEnable.call(L,L.CULL_FACE),x.depthTest&&x.realEnable.call(L,L.DEPTH_TEST),x.blend&&x.realEnable.call(L,L.BLEND),x.scissorTest&&x.realEnable.call(L,L.SCISSOR_TEST),x.stencilTest&&x.realEnable.call(L,L.STENCIL_TEST),x.realColorMask.apply(L,x.colorMask),x.realViewport.apply(L,x.viewport),(x.ctxAttribs.alpha||!x.ctxAttribs.preserveDrawingBuffer)&&x.realClearColor.apply(L,x.clearColor),x.instanceExt&&(W!=0&&x.instanceExt.vertexAttribDivisorANGLE(x.attribs.position,W),Y!=0&&x.instanceExt.vertexAttribDivisorANGLE(x.attribs.texCoord,Y))}),be()){var P=v.canvas;(P.width!=x.bufferWidth||P.height!=x.bufferHeight)&&(x.bufferWidth=P.width,x.bufferHeight=P.height,x.onResize())}},as.prototype.updateDeviceInfo=function(v){var x=this.gl,w=this,P=[x.ARRAY_BUFFER_BINDING,x.ELEMENT_ARRAY_BUFFER_BINDING];ka(x,P,function(L){var W=w.computeMeshVertices_(w.meshWidth,w.meshHeight,v);if(L.bindBuffer(L.ARRAY_BUFFER,w.vertexBuffer),L.bufferData(L.ARRAY_BUFFER,W,L.STATIC_DRAW),!w.indexCount){var Y=w.computeMeshIndices_(w.meshWidth,w.meshHeight);L.bindBuffer(L.ELEMENT_ARRAY_BUFFER,w.indexBuffer),L.bufferData(L.ELEMENT_ARRAY_BUFFER,Y,L.STATIC_DRAW),w.indexCount=Y.length}})},as.prototype.computeMeshVertices_=function(v,x,w){for(var P=new Float32Array(2*v*x*5),L=w.getLeftEyeVisibleTanAngles(),W=w.getLeftEyeNoLensTanAngles(),Y=w.getLeftEyeVisibleScreenRect(W),fe=0,pe=0;pe<2;pe++){for(var $=0;$<x;$++)for(var se=0;se<v;se++,fe++){var Te=se/(v-1),$e=$/(x-1),ot=Te,ht=$e,Et=Pe(L[0],L[2],Te),mt=Pe(L[3],L[1],$e),pt=Math.sqrt(Et*Et+mt*mt),Jt=w.distortion.distortInverse(pt),Ai=Et*Jt/pt,Oi=mt*Jt/pt;Te=(Ai-W[0])/(W[2]-W[0]),$e=(Oi-W[3])/(W[1]-W[3]),Te=(Y.x+Te*Y.width-.5)*2,$e=(Y.y+$e*Y.height-.5)*2,P[fe*5+0]=Te,P[fe*5+1]=$e,P[fe*5+2]=ot,P[fe*5+3]=ht,P[fe*5+4]=pe}var pi=L[2]-L[0];L[0]=-(pi+L[0]),L[2]=pi-L[2],pi=W[2]-W[0],W[0]=-(pi+W[0]),W[2]=pi-W[2],Y.x=1-(Y.x+Y.width)}return P},as.prototype.computeMeshIndices_=function(v,x){for(var w=new Uint16Array(2*(v-1)*(x-1)*6),P=v/2,L=x/2,W=0,Y=0,fe=0;fe<2;fe++)for(var pe=0;pe<x;pe++)for(var $=0;$<v;$++,W++)$==0||pe==0||($<=P==pe<=L?(w[Y++]=W,w[Y++]=W-v-1,w[Y++]=W-v,w[Y++]=W-v-1,w[Y++]=W,w[Y++]=W-1):(w[Y++]=W-1,w[Y++]=W-v,w[Y++]=W,w[Y++]=W-v,w[Y++]=W-1,w[Y++]=W-v-1));return w},as.prototype.getOwnPropertyDescriptor_=function(v,x){var w=Object.getOwnPropertyDescriptor(v,x);return(w.get===void 0||w.set===void 0)&&(w.configurable=!0,w.enumerable=!0,w.get=function(){return this.getAttribute(x)},w.set=function(P){this.setAttribute(x,P)}),w};var zw=["attribute vec2 position;","uniform mat4 projectionMat;","void main() {","  gl_Position = projectionMat * vec4( position, -1.0, 1.0 );","}"].join(`
`),Vw=["precision mediump float;","uniform vec4 color;","void main() {","  gl_FragColor = color;","}"].join(`
`),Cg=Math.PI/180,Kd=60,Rg=12,Ig=20,Zd=1,Dg=.75,Lg=.3125,Gw=4,Wr=28,$d=1.5;function jr(v){this.gl=v,this.attribs={position:0},this.program=cr(v,zw,Vw,this.attribs),this.uniforms=hr(v,this.program),this.vertexBuffer=v.createBuffer(),this.gearOffset=0,this.gearVertexCount=0,this.arrowOffset=0,this.arrowVertexCount=0,this.projMat=new Float32Array(16),this.listener=null,this.onResize()}jr.prototype.destroy=function(){var v=this.gl;this.listener&&v.canvas.removeEventListener("click",this.listener,!1),v.deleteProgram(this.program),v.deleteBuffer(this.vertexBuffer)},jr.prototype.listen=function(v,x){var w=this.gl.canvas;this.listener=function(P){var L=w.clientWidth/2,W=Wr*$d,Y=P.touches?P.touches[0].clientX:P.clientX,fe=P.touches?P.touches[0].clientY:P.clientY;Y>L-W&&Y<L+W&&fe>w.clientHeight-W?v(P):Y<W&&fe<W&&x(P)},w.addEventListener("click",this.listener,!1),w.addEventListener("touchstart",this.listener,!1)},jr.prototype.onResize=function(){var v=this.gl,x=this,w=[v.ARRAY_BUFFER_BINDING];ka(v,w,function(P){var L=[],W=P.drawingBufferWidth/2,Y=Math.max(screen.width,screen.height)*window.devicePixelRatio,fe=P.drawingBufferWidth/Y,pe=fe*window.devicePixelRatio,$=Gw*pe/2,se=Wr*$d*pe,Te=Wr*pe/2,$e=(Wr*$d-Wr)*pe;L.push(W-$,se),L.push(W-$,P.drawingBufferHeight),L.push(W+$,se),L.push(W+$,P.drawingBufferHeight),x.gearOffset=L.length/2;function ot(Jt,Ai){var Oi=(90-Jt)*Cg,pi=Math.cos(Oi),tn=Math.sin(Oi);L.push(Lg*pi*Te+W,Lg*tn*Te+Te),L.push(Ai*pi*Te+W,Ai*tn*Te+Te)}for(var ht=0;ht<=6;ht++){var Et=ht*Kd;ot(Et,Zd),ot(Et+Rg,Zd),ot(Et+Ig,Dg),ot(Et+(Kd-Ig),Dg),ot(Et+(Kd-Rg),Zd)}x.gearVertexCount=L.length/2-x.gearOffset,x.arrowOffset=L.length/2;function mt(Jt,Ai){L.push($e+Jt,P.drawingBufferHeight-$e-Ai)}var pt=$/Math.sin(45*Cg);mt(0,Te),mt(Te,0),mt(Te+pt,pt),mt(pt,Te+pt),mt(pt,Te-pt),mt(0,Te),mt(Te,Te*2),mt(Te+pt,Te*2-pt),mt(pt,Te-pt),mt(0,Te),mt(pt,Te-$),mt(Wr*pe,Te-$),mt(pt,Te+$),mt(Wr*pe,Te+$),x.arrowVertexCount=L.length/2-x.arrowOffset,P.bindBuffer(P.ARRAY_BUFFER,x.vertexBuffer),P.bufferData(P.ARRAY_BUFFER,new Float32Array(L),P.STATIC_DRAW)})},jr.prototype.render=function(){var v=this.gl,x=this,w=[v.CULL_FACE,v.DEPTH_TEST,v.BLEND,v.SCISSOR_TEST,v.STENCIL_TEST,v.COLOR_WRITEMASK,v.VIEWPORT,v.CURRENT_PROGRAM,v.ARRAY_BUFFER_BINDING];ka(v,w,function(P){P.disable(P.CULL_FACE),P.disable(P.DEPTH_TEST),P.disable(P.BLEND),P.disable(P.SCISSOR_TEST),P.disable(P.STENCIL_TEST),P.colorMask(!0,!0,!0,!0),P.viewport(0,0,P.drawingBufferWidth,P.drawingBufferHeight),x.renderNoState()})},jr.prototype.renderNoState=function(){var v=this.gl;v.useProgram(this.program),v.bindBuffer(v.ARRAY_BUFFER,this.vertexBuffer),v.enableVertexAttribArray(this.attribs.position),v.vertexAttribPointer(this.attribs.position,2,v.FLOAT,!1,8,0),v.uniform4f(this.uniforms.color,1,1,1,1),Gr(this.projMat,0,v.drawingBufferWidth,0,v.drawingBufferHeight,.1,1024),v.uniformMatrix4fv(this.uniforms.projectionMat,!1,this.projMat),v.drawArrays(v.TRIANGLE_STRIP,0,4),v.drawArrays(v.TRIANGLE_STRIP,this.gearOffset,this.gearVertexCount),v.drawArrays(v.TRIANGLE_STRIP,this.arrowOffset,this.arrowVertexCount)};function Sc(v){this.coefficients=v}Sc.prototype.distortInverse=function(v){for(var x=0,w=1,P=v-this.distort(x);Math.abs(w-x)>1e-4;){var L=v-this.distort(w),W=w-L*((w-x)/(L-P));x=w,w=W,P=L}return w},Sc.prototype.distort=function(v){for(var x=v*v,w=0,P=0;P<this.coefficients.length;P++)w=x*(w+this.coefficients[P]);return(w+1)*v};var gs=Math.PI/180,_s=180/Math.PI,fi=function(x,w,P){this.x=x||0,this.y=w||0,this.z=P||0};fi.prototype={constructor:fi,set:function(x,w,P){return this.x=x,this.y=w,this.z=P,this},copy:function(x){return this.x=x.x,this.y=x.y,this.z=x.z,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var x=this.length();if(x!==0){var w=1/x;this.multiplyScalar(w)}else this.x=0,this.y=0,this.z=0;return this},multiplyScalar:function(x){this.x*=x,this.y*=x,this.z*=x},applyQuaternion:function(x){var w=this.x,P=this.y,L=this.z,W=x.x,Y=x.y,fe=x.z,pe=x.w,$=pe*w+Y*L-fe*P,se=pe*P+fe*w-W*L,Te=pe*L+W*P-Y*w,$e=-W*w-Y*P-fe*L;return this.x=$*pe+$e*-W+se*-fe-Te*-Y,this.y=se*pe+$e*-Y+Te*-W-$*-fe,this.z=Te*pe+$e*-fe+$*-Y-se*-W,this},dot:function(x){return this.x*x.x+this.y*x.y+this.z*x.z},crossVectors:function(x,w){var P=x.x,L=x.y,W=x.z,Y=w.x,fe=w.y,pe=w.z;return this.x=L*pe-W*fe,this.y=W*Y-P*pe,this.z=P*fe-L*Y,this}};var Nt=function(x,w,P,L){this.x=x||0,this.y=w||0,this.z=P||0,this.w=L!==void 0?L:1};Nt.prototype={constructor:Nt,set:function(x,w,P,L){return this.x=x,this.y=w,this.z=P,this.w=L,this},copy:function(x){return this.x=x.x,this.y=x.y,this.z=x.z,this.w=x.w,this},setFromEulerXYZ:function(x,w,P){var L=Math.cos(x/2),W=Math.cos(w/2),Y=Math.cos(P/2),fe=Math.sin(x/2),pe=Math.sin(w/2),$=Math.sin(P/2);return this.x=fe*W*Y+L*pe*$,this.y=L*pe*Y-fe*W*$,this.z=L*W*$+fe*pe*Y,this.w=L*W*Y-fe*pe*$,this},setFromEulerYXZ:function(x,w,P){var L=Math.cos(x/2),W=Math.cos(w/2),Y=Math.cos(P/2),fe=Math.sin(x/2),pe=Math.sin(w/2),$=Math.sin(P/2);return this.x=fe*W*Y+L*pe*$,this.y=L*pe*Y-fe*W*$,this.z=L*W*$-fe*pe*Y,this.w=L*W*Y+fe*pe*$,this},setFromAxisAngle:function(x,w){var P=w/2,L=Math.sin(P);return this.x=x.x*L,this.y=x.y*L,this.z=x.z*L,this.w=Math.cos(P),this},multiply:function(x){return this.multiplyQuaternions(this,x)},multiplyQuaternions:function(x,w){var P=x.x,L=x.y,W=x.z,Y=x.w,fe=w.x,pe=w.y,$=w.z,se=w.w;return this.x=P*se+Y*fe+L*$-W*pe,this.y=L*se+Y*pe+W*fe-P*$,this.z=W*se+Y*$+P*pe-L*fe,this.w=Y*se-P*fe-L*pe-W*$,this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this.normalize(),this},normalize:function(){var x=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return x===0?(this.x=0,this.y=0,this.z=0,this.w=1):(x=1/x,this.x=this.x*x,this.y=this.y*x,this.z=this.z*x,this.w=this.w*x),this},slerp:function(x,w){if(w===0)return this;if(w===1)return this.copy(x);var P=this.x,L=this.y,W=this.z,Y=this.w,fe=Y*x.w+P*x.x+L*x.y+W*x.z;if(fe<0?(this.w=-x.w,this.x=-x.x,this.y=-x.y,this.z=-x.z,fe=-fe):this.copy(x),fe>=1)return this.w=Y,this.x=P,this.y=L,this.z=W,this;var pe=Math.acos(fe),$=Math.sqrt(1-fe*fe);if(Math.abs($)<.001)return this.w=.5*(Y+this.w),this.x=.5*(P+this.x),this.y=.5*(L+this.y),this.z=.5*(W+this.z),this;var se=Math.sin((1-w)*pe)/$,Te=Math.sin(w*pe)/$;return this.w=Y*se+this.w*Te,this.x=P*se+this.x*Te,this.y=L*se+this.y*Te,this.z=W*se+this.z*Te,this},setFromUnitVectors:function(){var v,x,w=1e-6;return function(P,L){return v===void 0&&(v=new fi),x=P.dot(L)+1,x<w?(x=0,Math.abs(P.x)>Math.abs(P.z)?v.set(-P.y,P.x,0):v.set(0,-P.z,P.y)):v.crossVectors(P,L),this.x=v.x,this.y=v.y,this.z=v.z,this.w=x,this.normalize(),this}}()};function Jd(v){this.width=v.width||At(),this.height=v.height||Pt(),this.widthMeters=v.widthMeters,this.heightMeters=v.heightMeters,this.bevelMeters=v.bevelMeters}var Hw=new Jd({widthMeters:.11,heightMeters:.062,bevelMeters:.004}),Ww=new Jd({widthMeters:.1038,heightMeters:.0584,bevelMeters:.004}),eu={CardboardV1:new tu({id:"CardboardV1",label:"Cardboard I/O 2014",fov:40,interLensDistance:.06,baselineLensDistance:.035,screenLensDistance:.042,distortionCoefficients:[.441,.156],inverseCoefficients:[-.4410035,.42756155,-.4804439,.5460139,-.58821183,.5733938,-.48303202,.33299083,-.17573841,.0651772,-.01488963,.001559834]}),CardboardV2:new tu({id:"CardboardV2",label:"Cardboard I/O 2015",fov:60,interLensDistance:.064,baselineLensDistance:.035,screenLensDistance:.039,distortionCoefficients:[.34,.55],inverseCoefficients:[-.33836704,-.18162185,.862655,-1.2462051,1.0560602,-.58208317,.21609078,-.05444823,.009177956,-.0009904169,6183535e-11,-16981803e-13]})};function Si(v,x){this.viewer=eu.CardboardV2,this.updateDeviceParams(v),this.distortion=new Sc(this.viewer.distortionCoefficients);for(var w=0;w<x.length;w++){var P=x[w];eu[P.id]=new tu(P)}}Si.prototype.updateDeviceParams=function(v){this.device=this.determineDevice_(v)||this.device},Si.prototype.getDevice=function(){return this.device},Si.prototype.setViewer=function(v){this.viewer=v,this.distortion=new Sc(this.viewer.distortionCoefficients)},Si.prototype.determineDevice_=function(v){if(!v)return be()?(console.warn("Using fallback iOS device measurements."),Ww):(console.warn("Using fallback Android device measurements."),Hw);var x=.0254,w=x/v.xdpi,P=x/v.ydpi,L=At(),W=Pt();return new Jd({widthMeters:w*L,heightMeters:P*W,bevelMeters:v.bevelMm*.001})},Si.prototype.getDistortedFieldOfViewLeftEye=function(){var v=this.viewer,x=this.device,w=this.distortion,P=v.screenLensDistance,L=(x.widthMeters-v.interLensDistance)/2,W=v.interLensDistance/2,Y=v.baselineLensDistance-x.bevelMeters,fe=x.heightMeters-Y,pe=_s*Math.atan(w.distort(L/P)),$=_s*Math.atan(w.distort(W/P)),se=_s*Math.atan(w.distort(Y/P)),Te=_s*Math.atan(w.distort(fe/P));return{leftDegrees:Math.min(pe,v.fov),rightDegrees:Math.min($,v.fov),downDegrees:Math.min(se,v.fov),upDegrees:Math.min(Te,v.fov)}},Si.prototype.getLeftEyeVisibleTanAngles=function(){var v=this.viewer,x=this.device,w=this.distortion,P=Math.tan(-gs*v.fov),L=Math.tan(gs*v.fov),W=Math.tan(gs*v.fov),Y=Math.tan(-gs*v.fov),fe=x.widthMeters/4,pe=x.heightMeters/2,$=v.baselineLensDistance-x.bevelMeters-pe,se=v.interLensDistance/2-fe,Te=-$,$e=v.screenLensDistance,ot=w.distort((se-fe)/$e),ht=w.distort((Te+pe)/$e),Et=w.distort((se+fe)/$e),mt=w.distort((Te-pe)/$e),pt=new Float32Array(4);return pt[0]=Math.max(P,ot),pt[1]=Math.min(L,ht),pt[2]=Math.min(W,Et),pt[3]=Math.max(Y,mt),pt},Si.prototype.getLeftEyeNoLensTanAngles=function(){var v=this.viewer,x=this.device,w=this.distortion,P=new Float32Array(4),L=w.distortInverse(Math.tan(-gs*v.fov)),W=w.distortInverse(Math.tan(gs*v.fov)),Y=w.distortInverse(Math.tan(gs*v.fov)),fe=w.distortInverse(Math.tan(-gs*v.fov)),pe=x.widthMeters/4,$=x.heightMeters/2,se=v.baselineLensDistance-x.bevelMeters-$,Te=v.interLensDistance/2-pe,$e=-se,ot=v.screenLensDistance,ht=(Te-pe)/ot,Et=($e+$)/ot,mt=(Te+pe)/ot,pt=($e-$)/ot;return P[0]=Math.max(L,ht),P[1]=Math.min(W,Et),P[2]=Math.min(Y,mt),P[3]=Math.max(fe,pt),P},Si.prototype.getLeftEyeVisibleScreenRect=function(v){var x=this.viewer,w=this.device,P=x.screenLensDistance,L=(w.widthMeters-x.interLensDistance)/2,W=x.baselineLensDistance-w.bevelMeters,Y=(v[0]*P+L)/w.widthMeters,fe=(v[1]*P+W)/w.heightMeters,pe=(v[2]*P+L)/w.widthMeters,$=(v[3]*P+W)/w.heightMeters;return{x:Y,y:$,width:pe-Y,height:fe-$}},Si.prototype.getFieldOfViewLeftEye=function(v){return v?this.getUndistortedFieldOfViewLeftEye():this.getDistortedFieldOfViewLeftEye()},Si.prototype.getFieldOfViewRightEye=function(v){var x=this.getFieldOfViewLeftEye(v);return{leftDegrees:x.rightDegrees,rightDegrees:x.leftDegrees,upDegrees:x.upDegrees,downDegrees:x.downDegrees}},Si.prototype.getUndistortedFieldOfViewLeftEye=function(){var v=this.getUndistortedParams_();return{leftDegrees:_s*Math.atan(v.outerDist),rightDegrees:_s*Math.atan(v.innerDist),downDegrees:_s*Math.atan(v.bottomDist),upDegrees:_s*Math.atan(v.topDist)}},Si.prototype.getUndistortedViewportLeftEye=function(){var v=this.getUndistortedParams_(),x=this.viewer,w=this.device,P=x.screenLensDistance,L=w.widthMeters/P,W=w.heightMeters/P,Y=w.width/L,fe=w.height/W,pe=Math.round((v.eyePosX-v.outerDist)*Y),$=Math.round((v.eyePosY-v.bottomDist)*fe);return{x:pe,y:$,width:Math.round((v.eyePosX+v.innerDist)*Y)-pe,height:Math.round((v.eyePosY+v.topDist)*fe)-$}},Si.prototype.getUndistortedParams_=function(){var v=this.viewer,x=this.device,w=this.distortion,P=v.screenLensDistance,L=v.interLensDistance/2/P,W=x.widthMeters/P,Y=x.heightMeters/P,fe=W/2-L,pe=(v.baselineLensDistance-x.bevelMeters)/P,$=v.fov,se=w.distortInverse(Math.tan(gs*$)),Te=Math.min(fe,se),$e=Math.min(L,se),ot=Math.min(pe,se),ht=Math.min(Y-pe,se);return{outerDist:Te,innerDist:$e,topDist:ht,bottomDist:ot,eyePosX:fe,eyePosY:pe}};function tu(v){this.id=v.id,this.label=v.label,this.fov=v.fov,this.interLensDistance=v.interLensDistance,this.baselineLensDistance=v.baselineLensDistance,this.screenLensDistance=v.screenLensDistance,this.distortionCoefficients=v.distortionCoefficients,this.inverseCoefficients=v.inverseCoefficients}Si.Viewers=eu;var jw=1,Xw="2019-11-09T17:36:14Z",qw=[{type:"android",rules:[{mdmh:"asus/*/Nexus 7/*"},{ua:"Nexus 7"}],dpi:[320.8,323],bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_X00PD/*"},{ua:"ASUS_X00PD"}],dpi:245,bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_X008D/*"},{ua:"ASUS_X008D"}],dpi:282,bw:3,ac:500},{type:"android",rules:[{mdmh:"asus/*/ASUS_Z00AD/*"},{ua:"ASUS_Z00AD"}],dpi:[403,404.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 2 XL/*"},{ua:"Pixel 2 XL"}],dpi:537.9,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 3 XL/*"},{ua:"Pixel 3 XL"}],dpi:[558.5,553.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel XL/*"},{ua:"Pixel XL"}],dpi:[537.9,533],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 3/*"},{ua:"Pixel 3"}],dpi:442.4,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Google/*/Pixel 2/*"},{ua:"Pixel 2"}],dpi:441,bw:3,ac:500},{type:"android",rules:[{mdmh:"Google/*/Pixel/*"},{ua:"Pixel"}],dpi:[432.6,436.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC6435LVW/*"},{ua:"HTC6435LVW"}],dpi:[449.7,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"HTC/*/HTC One XL/*"},{ua:"HTC One XL"}],dpi:[315.3,314.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"htc/*/Nexus 9/*"},{ua:"Nexus 9"}],dpi:289,bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One M9/*"},{ua:"HTC One M9"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One_M8/*"},{ua:"HTC One_M8"}],dpi:[449.7,447.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"HTC/*/HTC One/*"},{ua:"HTC One"}],dpi:472.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/Nexus 6P/*"},{ua:"Nexus 6P"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/BLN-L24/*"},{ua:"HONORBLN-L24"}],dpi:480,bw:4,ac:500},{type:"android",rules:[{mdmh:"Huawei/*/BKL-L09/*"},{ua:"BKL-L09"}],dpi:403,bw:3.47,ac:500},{type:"android",rules:[{mdmh:"LENOVO/*/Lenovo PB2-690Y/*"},{ua:"Lenovo PB2-690Y"}],dpi:[457.2,454.713],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5X/*"},{ua:"Nexus 5X"}],dpi:[422,419.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS345/*"},{ua:"LGMS345"}],dpi:[221.7,219.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D800/*"},{ua:"LG-D800"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/LG-D850/*"},{ua:"LG-D850"}],dpi:[537.9,541.9],bw:3,ac:500},{type:"android",rules:[{mdmh:"LGE/*/VS985 4G/*"},{ua:"VS985 4G"}],dpi:[537.9,535.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 5/*"},{ua:"Nexus 5 B"}],dpi:[442.4,444.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/Nexus 4/*"},{ua:"Nexus 4"}],dpi:[319.8,318.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LG-P769/*"},{ua:"LG-P769"}],dpi:[240.6,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGMS323/*"},{ua:"LGMS323"}],dpi:[206.6,204.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"LGE/*/LGLS996/*"},{ua:"LGLS996"}],dpi:[403.4,401.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/4560MMX/*"},{ua:"4560MMX"}],dpi:[240,219.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/A250/*"},{ua:"Micromax A250"}],dpi:[480,446.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Micromax/*/Micromax AQ4501/*"},{ua:"Micromax AQ4501"}],dpi:240,bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/G5/*"},{ua:"Moto G (5) Plus"}],dpi:[403.4,403],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/DROID RAZR/*"},{ua:"DROID RAZR"}],dpi:[368.1,256.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT830C/*"},{ua:"XT830C"}],dpi:[254,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1021/*"},{ua:"XT1021"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1023/*"},{ua:"XT1023"}],dpi:[254,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1028/*"},{ua:"XT1028"}],dpi:[326.6,327.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1034/*"},{ua:"XT1034"}],dpi:[326.6,328.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1053/*"},{ua:"XT1053"}],dpi:[315.3,316.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1562/*"},{ua:"XT1562"}],dpi:[403.4,402.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/Nexus 6/*"},{ua:"Nexus 6 B"}],dpi:[494.3,489.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1063/*"},{ua:"XT1063"}],dpi:[295,296.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/XT1064/*"},{ua:"XT1064"}],dpi:[295,295.6],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1092/*"},{ua:"XT1092"}],dpi:[422,424.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"motorola/*/XT1095/*"},{ua:"XT1095"}],dpi:[422,423.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"motorola/*/G4/*"},{ua:"Moto G (4)"}],dpi:401,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/A0001/*"},{ua:"A0001"}],dpi:[403.4,401],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1001/*"},{ua:"ONE E1001"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1003/*"},{ua:"ONE E1003"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE E1005/*"},{ua:"ONE E1005"}],dpi:[442.4,441.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2001/*"},{ua:"ONE A2001"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2003/*"},{ua:"ONE A2003"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A2005/*"},{ua:"ONE A2005"}],dpi:[391.9,405.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3000/*"},{ua:"ONEPLUS A3000"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3003/*"},{ua:"ONEPLUS A3003"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A3010/*"},{ua:"ONEPLUS A3010"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A5000/*"},{ua:"ONEPLUS A5000 "}],dpi:[403.411,399.737],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONE A5010/*"},{ua:"ONEPLUS A5010"}],dpi:[403,400],bw:2,ac:1e3},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6000/*"},{ua:"ONEPLUS A6000"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6003/*"},{ua:"ONEPLUS A6003"}],dpi:401,bw:3,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6010/*"},{ua:"ONEPLUS A6010"}],dpi:401,bw:2,ac:500},{type:"android",rules:[{mdmh:"OnePlus/*/ONEPLUS A6013/*"},{ua:"ONEPLUS A6013"}],dpi:401,bw:2,ac:500},{type:"android",rules:[{mdmh:"OPPO/*/X909/*"},{ua:"X909"}],dpi:[442.4,444.1],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9082/*"},{ua:"GT-I9082"}],dpi:[184.7,185.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G360P/*"},{ua:"SM-G360P"}],dpi:[196.7,205.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Nexus S/*"},{ua:"Nexus S"}],dpi:[234.5,229.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[304.8,303.9],bw:5,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-T230NU/*"},{ua:"SM-T230NU"}],dpi:216,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SGH-T399/*"},{ua:"SGH-T399"}],dpi:[217.7,231.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SGH-M919/*"},{ua:"SGH-M919"}],dpi:[440.8,437.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N9005/*"},{ua:"SM-N9005"}],dpi:[386.4,387],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SM-N900A/*"},{ua:"SAMSUNG-SM-N900A"}],dpi:[386.4,387.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9500/*"},{ua:"GT-I9500"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/GT-I9505/*"},{ua:"GT-I9505"}],dpi:439.4,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900F/*"},{ua:"SM-G900F"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G900M/*"},{ua:"SM-G900M"}],dpi:[415.6,431.6],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G800F/*"},{ua:"SM-G800F"}],dpi:326.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G906S/*"},{ua:"SM-G906S"}],dpi:[562.7,572.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300/*"},{ua:"GT-I9300"}],dpi:[306.7,304.8],bw:5,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-T535/*"},{ua:"SM-T535"}],dpi:[142.6,136.4],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-N920C/*"},{ua:"SM-N920C"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N920P/*"},{ua:"SM-N920P"}],dpi:[386.3655,390.144],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N920W8/*"},{ua:"SM-N920W8"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9300I/*"},{ua:"GT-I9300I"}],dpi:[304.8,305.8],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-I9195/*"},{ua:"GT-I9195"}],dpi:[249.4,256.7],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SPH-L520/*"},{ua:"SPH-L520"}],dpi:[249.4,255.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SAMSUNG-SGH-I717/*"},{ua:"SAMSUNG-SGH-I717"}],dpi:285.8,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SPH-D710/*"},{ua:"SPH-D710"}],dpi:[217.7,204.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/GT-N7100/*"},{ua:"GT-N7100"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SCH-I605/*"},{ua:"SCH-I605"}],dpi:265.1,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/Galaxy Nexus/*"},{ua:"Galaxy Nexus"}],dpi:[315.3,314.2],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910H/*"},{ua:"SM-N910H"}],dpi:[515.1,518],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-N910C/*"},{ua:"SM-N910C"}],dpi:[515.2,520.2],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G130M/*"},{ua:"SM-G130M"}],dpi:[165.9,164.8],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G928I/*"},{ua:"SM-G928I"}],dpi:[515.1,518.4],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G920F/*"},{ua:"SM-G920F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G920P/*"},{ua:"SM-G920P"}],dpi:[522.5,577],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G925F/*"},{ua:"SM-G925F"}],dpi:580.6,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G925V/*"},{ua:"SM-G925V"}],dpi:[522.5,576.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G930F/*"},{ua:"SM-G930F"}],dpi:576.6,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G935F/*"},{ua:"SM-G935F"}],dpi:533,bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G950F/*"},{ua:"SM-G950F"}],dpi:[562.707,565.293],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G955U/*"},{ua:"SM-G955U"}],dpi:[522.514,525.762],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G955F/*"},{ua:"SM-G955F"}],dpi:[522.514,525.762],bw:3,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G960F/*"},{ua:"SM-G960F"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G9600/*"},{ua:"SM-G9600"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960T/*"},{ua:"SM-G960T"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960N/*"},{ua:"SM-G960N"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960U/*"},{ua:"SM-G960U"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G9608/*"},{ua:"SM-G9608"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960FD/*"},{ua:"SM-G960FD"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G960W/*"},{ua:"SM-G960W"}],dpi:[569.575,571.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G965F/*"},{ua:"SM-G965F"}],dpi:529,bw:2,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/C6903/*"},{ua:"C6903"}],dpi:[442.5,443.3],bw:3,ac:500},{type:"android",rules:[{mdmh:"Sony/*/D6653/*"},{ua:"D6653"}],dpi:[428.6,427.6],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6653/*"},{ua:"E6653"}],dpi:[428.6,425.7],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/E6853/*"},{ua:"E6853"}],dpi:[403.4,401.9],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Sony/*/SGP321/*"},{ua:"SGP321"}],dpi:[224.7,224.1],bw:3,ac:500},{type:"android",rules:[{mdmh:"TCT/*/ALCATEL ONE TOUCH Fierce/*"},{ua:"ALCATEL ONE TOUCH Fierce"}],dpi:[240,247.5],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"THL/*/thl 5000/*"},{ua:"thl 5000"}],dpi:[480,443.3],bw:3,ac:1e3},{type:"android",rules:[{mdmh:"Fly/*/IQ4412/*"},{ua:"IQ4412"}],dpi:307.9,bw:3,ac:1e3},{type:"android",rules:[{mdmh:"ZTE/*/ZTE Blade L2/*"},{ua:"ZTE Blade L2"}],dpi:240,bw:3,ac:500},{type:"android",rules:[{mdmh:"BENEVE/*/VR518/*"},{ua:"VR518"}],dpi:480,bw:3,ac:500},{type:"ios",rules:[{res:[640,960]}],dpi:[325.1,328.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[640,1136]}],dpi:[317.1,320.2],bw:3,ac:1e3},{type:"ios",rules:[{res:[750,1334]}],dpi:326.4,bw:4,ac:1e3},{type:"ios",rules:[{res:[1242,2208]}],dpi:[453.6,458.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[1125,2001]}],dpi:[410.9,415.4],bw:4,ac:1e3},{type:"ios",rules:[{res:[1125,2436]}],dpi:458,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"Huawei/*/EML-L29/*"},{ua:"EML-L29"}],dpi:428,bw:3.45,ac:500},{type:"android",rules:[{mdmh:"Nokia/*/Nokia 7.1/*"},{ua:"Nokia 7.1"}],dpi:[432,431.9],bw:3,ac:500},{type:"ios",rules:[{res:[1242,2688]}],dpi:458,bw:4,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G570M/*"},{ua:"SM-G570M"}],dpi:320,bw:3.684,ac:1e3},{type:"android",rules:[{mdmh:"samsung/*/SM-G970F/*"},{ua:"SM-G970F"}],dpi:438,bw:2.281,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G973F/*"},{ua:"SM-G973F"}],dpi:550,bw:2.002,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G975F/*"},{ua:"SM-G975F"}],dpi:522,bw:2.054,ac:500},{type:"android",rules:[{mdmh:"samsung/*/SM-G977F/*"},{ua:"SM-G977F"}],dpi:505,bw:2.334,ac:500},{type:"ios",rules:[{res:[828,1792]}],dpi:326,bw:5,ac:500}],Yw={format:jw,last_updated:Xw,devices:qw};function Ua(v,x){if(this.dpdb=Yw,this.recalculateDeviceParams_(),v){this.onDeviceParamsUpdated=x;var w=new XMLHttpRequest,P=this;w.open("GET",v,!0),w.addEventListener("load",function(){P.loading=!1,w.status>=200&&w.status<=299?(P.dpdb=JSON.parse(w.response),P.recalculateDeviceParams_()):console.error("Error loading online DPDB!")}),w.send()}}Ua.prototype.getDeviceParams=function(){return this.deviceParams},Ua.prototype.recalculateDeviceParams_=function(){var v=this.calcDeviceParams_();v?(this.deviceParams=v,this.onDeviceParamsUpdated&&this.onDeviceParamsUpdated(this.deviceParams)):console.error("Failed to recalculate device parameters.")},Ua.prototype.calcDeviceParams_=function(){var v=this.dpdb;if(!v)return console.error("DPDB not available."),null;if(v.format!=1)return console.error("DPDB has unexpected format version."),null;if(!v.devices||!v.devices.length)return console.error("DPDB does not have a devices section."),null;var x=navigator.userAgent||navigator.vendor||window.opera,w=At(),P=Pt();if(!v.devices)return console.error("DPDB has no devices section."),null;for(var L=0;L<v.devices.length;L++){var W=v.devices[L];if(!W.rules){console.warn("Device["+L+"] has no rules section.");continue}if(W.type!="ios"&&W.type!="android"){console.warn("Device["+L+"] has invalid type.");continue}if(be()==(W.type=="ios")){for(var Y=!1,fe=0;fe<W.rules.length;fe++){var pe=W.rules[fe];if(this.ruleMatches_(pe,x,w,P)){Y=!0;break}}if(Y){var $=W.dpi[0]||W.dpi,se=W.dpi[1]||W.dpi;return new Qw({xdpi:$,ydpi:se,bevelMm:W.bw})}}}return console.warn("No DPDB device match."),null},Ua.prototype.ruleMatches_=function(v,x,w,P){if(!v.ua&&!v.res||(v.ua&&v.ua.substring(0,2)==="SM"&&(v.ua=v.ua.substring(0,7)),v.ua&&x.indexOf(v.ua)<0))return!1;if(v.res){if(!v.res[0]||!v.res[1])return!1;var L=v.res[0],W=v.res[1];if(Math.min(w,P)!=Math.min(L,W)||Math.max(w,P)!=Math.max(L,W))return!1}return!0};function Qw(v){this.xdpi=v.xdpi,this.ydpi=v.ydpi,this.bevelMm=v.bevelMm}function za(v,x){this.set(v,x)}za.prototype.set=function(v,x){this.sample=v,this.timestampS=x},za.prototype.copy=function(v){this.set(v.sample,v.timestampS)};function Xr(v,x){this.kFilter=v,this.isDebug=x,this.currentAccelMeasurement=new za,this.currentGyroMeasurement=new za,this.previousGyroMeasurement=new za,be()?this.filterQ=new Nt(-1,0,0,1):this.filterQ=new Nt(1,0,0,1),this.previousFilterQ=new Nt,this.previousFilterQ.copy(this.filterQ),this.accelQ=new Nt,this.isOrientationInitialized=!1,this.estimatedGravity=new fi,this.measuredGravity=new fi,this.gyroIntegralQ=new Nt}Xr.prototype.addAccelMeasurement=function(v,x){this.currentAccelMeasurement.set(v,x)},Xr.prototype.addGyroMeasurement=function(v,x){this.currentGyroMeasurement.set(v,x);var w=x-this.previousGyroMeasurement.timestampS;Ui(w)&&this.run_(),this.previousGyroMeasurement.copy(this.currentGyroMeasurement)},Xr.prototype.run_=function(){if(!this.isOrientationInitialized){this.accelQ=this.accelToQuaternion_(this.currentAccelMeasurement.sample),this.previousFilterQ.copy(this.accelQ),this.isOrientationInitialized=!0;return}var v=this.currentGyroMeasurement.timestampS-this.previousGyroMeasurement.timestampS,x=this.gyroToQuaternionDelta_(this.currentGyroMeasurement.sample,v);this.gyroIntegralQ.multiply(x),this.filterQ.copy(this.previousFilterQ),this.filterQ.multiply(x);var w=new Nt;w.copy(this.filterQ),w.inverse(),this.estimatedGravity.set(0,0,-1),this.estimatedGravity.applyQuaternion(w),this.estimatedGravity.normalize(),this.measuredGravity.copy(this.currentAccelMeasurement.sample),this.measuredGravity.normalize();var P=new Nt;P.setFromUnitVectors(this.estimatedGravity,this.measuredGravity),P.inverse(),this.isDebug&&console.log("Delta: %d deg, G_est: (%s, %s, %s), G_meas: (%s, %s, %s)",_s*Bw(P),this.estimatedGravity.x.toFixed(1),this.estimatedGravity.y.toFixed(1),this.estimatedGravity.z.toFixed(1),this.measuredGravity.x.toFixed(1),this.measuredGravity.y.toFixed(1),this.measuredGravity.z.toFixed(1));var L=new Nt;L.copy(this.filterQ),L.multiply(P),this.filterQ.slerp(L,1-this.kFilter),this.previousFilterQ.copy(this.filterQ)},Xr.prototype.getOrientation=function(){return this.filterQ},Xr.prototype.accelToQuaternion_=function(v){var x=new fi;x.copy(v),x.normalize();var w=new Nt;return w.setFromUnitVectors(new fi(0,0,-1),x),w.inverse(),w},Xr.prototype.gyroToQuaternionDelta_=function(v,x){var w=new Nt,P=new fi;return P.copy(v),P.normalize(),w.setFromAxisAngle(P,v.length()*x),w};function Fg(v,x){this.predictionTimeS=v,this.isDebug=x,this.previousQ=new Nt,this.previousTimestampS=null,this.deltaQ=new Nt,this.outQ=new Nt}Fg.prototype.getPrediction=function(v,x,w){if(!this.previousTimestampS)return this.previousQ.copy(v),this.previousTimestampS=w,v;var P=new fi;P.copy(x),P.normalize();var L=x.length();if(L<gs*20)return this.isDebug&&console.log("Moving slowly, at %s deg/s: no prediction",(_s*L).toFixed(1)),this.outQ.copy(v),this.previousQ.copy(v),this.outQ;var W=L*this.predictionTimeS;return this.deltaQ.setFromAxisAngle(P,W),this.outQ.copy(this.previousQ),this.outQ.multiply(this.deltaQ),this.previousQ.copy(v),this.previousTimestampS=w,this.outQ};function Bn(v,x,w,P){this.yawOnly=w,this.accelerometer=new fi,this.gyroscope=new fi,this.filter=new Xr(v,P),this.posePredictor=new Fg(x,P),this.isFirefoxAndroid=Ot(),this.isIOS=be();var L=Gt();this.isDeviceMotionInRadians=!this.isIOS&&L&&L<66,this.isWithoutDeviceMotion=Ht()||$t(),this.filterToWorldQ=new Nt,be()?this.filterToWorldQ.setFromAxisAngle(new fi(1,0,0),Math.PI/2):this.filterToWorldQ.setFromAxisAngle(new fi(1,0,0),-Math.PI/2),this.inverseWorldToScreenQ=new Nt,this.worldToScreenQ=new Nt,this.originalPoseAdjustQ=new Nt,this.originalPoseAdjustQ.setFromAxisAngle(new fi(0,0,1),-window.orientation*Math.PI/180),this.setScreenTransform_(),ui()&&this.filterToWorldQ.multiply(this.inverseWorldToScreenQ),this.resetQ=new Nt,this.orientationOut_=new Float32Array(4),this.start()}Bn.prototype.getPosition=function(){return null},Bn.prototype.getOrientation=function(){var v=void 0;if(this.isWithoutDeviceMotion&&this._deviceOrientationQ){this.deviceOrientationFixQ=this.deviceOrientationFixQ||function(){var L=new Nt().setFromAxisAngle(new fi(0,0,-1),0),W=new Nt;return window.orientation===-90?W.setFromAxisAngle(new fi(0,1,0),Math.PI/-2):W.setFromAxisAngle(new fi(0,1,0),Math.PI/2),L.multiply(W)}(),this.deviceOrientationFilterToWorldQ=this.deviceOrientationFilterToWorldQ||function(){var L=new Nt;return L.setFromAxisAngle(new fi(1,0,0),-Math.PI/2),L}(),v=this._deviceOrientationQ;var w=new Nt;return w.copy(v),w.multiply(this.deviceOrientationFilterToWorldQ),w.multiply(this.resetQ),w.multiply(this.worldToScreenQ),w.multiplyQuaternions(this.deviceOrientationFixQ,w),this.yawOnly&&(w.x=0,w.z=0,w.normalize()),this.orientationOut_[0]=w.x,this.orientationOut_[1]=w.y,this.orientationOut_[2]=w.z,this.orientationOut_[3]=w.w,this.orientationOut_}else{var x=this.filter.getOrientation();v=this.posePredictor.getPrediction(x,this.gyroscope,this.previousTimestampS)}var w=new Nt;return w.copy(this.filterToWorldQ),w.multiply(this.resetQ),w.multiply(v),w.multiply(this.worldToScreenQ),this.yawOnly&&(w.x=0,w.z=0,w.normalize()),this.orientationOut_[0]=w.x,this.orientationOut_[1]=w.y,this.orientationOut_[2]=w.z,this.orientationOut_[3]=w.w,this.orientationOut_},Bn.prototype.resetPose=function(){this.resetQ.copy(this.filter.getOrientation()),this.resetQ.x=0,this.resetQ.y=0,this.resetQ.z*=-1,this.resetQ.normalize(),ui()&&this.resetQ.multiply(this.inverseWorldToScreenQ),this.resetQ.multiply(this.originalPoseAdjustQ)},Bn.prototype.onDeviceOrientation_=function(v){this._deviceOrientationQ=this._deviceOrientationQ||new Nt;var x=v.alpha,w=v.beta,P=v.gamma;x=(x||0)*Math.PI/180,w=(w||0)*Math.PI/180,P=(P||0)*Math.PI/180,this._deviceOrientationQ.setFromEulerYXZ(w,x,-P)},Bn.prototype.onDeviceMotion_=function(v){this.updateDeviceMotion_(v)},Bn.prototype.updateDeviceMotion_=function(v){var x=v.accelerationIncludingGravity,w=v.rotationRate,P=v.timeStamp/1e3,L=P-this.previousTimestampS;if(L<0){Qd("fusion-pose-sensor:invalid:non-monotonic","Invalid timestamps detected: non-monotonic timestamp from devicemotion"),this.previousTimestampS=P;return}else if(L<=Z||L>ee){Qd("fusion-pose-sensor:invalid:outside-threshold","Invalid timestamps detected: Timestamp from devicemotion outside expected range."),this.previousTimestampS=P;return}this.accelerometer.set(-x.x,-x.y,-x.z),w&&(Bt()?this.gyroscope.set(-w.beta,w.alpha,w.gamma):this.gyroscope.set(w.alpha,w.beta,w.gamma),this.isDeviceMotionInRadians||this.gyroscope.multiplyScalar(Math.PI/180),this.filter.addGyroMeasurement(this.gyroscope,P)),this.filter.addAccelMeasurement(this.accelerometer,P),this.previousTimestampS=P},Bn.prototype.onOrientationChange_=function(v){this.setScreenTransform_()},Bn.prototype.onMessage_=function(v){var x=v.data;if(!(!x||!x.type)){var w=x.type.toLowerCase();w==="devicemotion"&&this.updateDeviceMotion_(x.deviceMotionEvent)}},Bn.prototype.setScreenTransform_=function(){switch(this.worldToScreenQ.set(0,0,0,1),window.orientation){case 0:break;case 90:this.worldToScreenQ.setFromAxisAngle(new fi(0,0,1),-Math.PI/2);break;case-90:this.worldToScreenQ.setFromAxisAngle(new fi(0,0,1),Math.PI/2);break;case 180:break}this.inverseWorldToScreenQ.copy(this.worldToScreenQ),this.inverseWorldToScreenQ.inverse()},Bn.prototype.start=function(){this.onDeviceMotionCallback_=this.onDeviceMotion_.bind(this),this.onOrientationChangeCallback_=this.onOrientationChange_.bind(this),this.onMessageCallback_=this.onMessage_.bind(this),this.onDeviceOrientationCallback_=this.onDeviceOrientation_.bind(this),be()&&Ow()&&window.addEventListener("message",this.onMessageCallback_),window.addEventListener("orientationchange",this.onOrientationChangeCallback_),this.isWithoutDeviceMotion?window.addEventListener("deviceorientation",this.onDeviceOrientationCallback_):window.addEventListener("devicemotion",this.onDeviceMotionCallback_)},Bn.prototype.stop=function(){window.removeEventListener("devicemotion",this.onDeviceMotionCallback_),window.removeEventListener("deviceorientation",this.onDeviceOrientationCallback_),window.removeEventListener("orientationchange",this.onOrientationChangeCallback_),window.removeEventListener("message",this.onMessageCallback_)};var Kw=60,Zw=new fi(1,0,0),$w=new fi(0,0,1),iu=new Nt;iu.setFromAxisAngle(Zw,-Math.PI/2),iu.multiply(new Nt().setFromAxisAngle($w,Math.PI/2));var Jw=function(){function v(x){S(this,v),this.config=x,this.sensor=null,this.fusionSensor=null,this._out=new Float32Array(4),this.api=null,this.errors=[],this._sensorQ=new Nt,this._outQ=new Nt,this._onSensorRead=this._onSensorRead.bind(this),this._onSensorError=this._onSensorError.bind(this),this.init()}return I(v,[{key:"init",value:function(){var w=null;try{w=new RelativeOrientationSensor({frequency:Kw,referenceFrame:"screen"}),w.addEventListener("error",this._onSensorError)}catch(P){this.errors.push(P),P.name==="SecurityError"?(console.error("Cannot construct sensors due to the Feature Policy"),console.warn('Attempting to fall back using "devicemotion"; however this will fail in the future without correct permissions.'),this.useDeviceMotion()):P.name==="ReferenceError"?this.useDeviceMotion():console.error(P)}w&&(this.api="sensor",this.sensor=w,this.sensor.addEventListener("reading",this._onSensorRead),this.sensor.start())}},{key:"useDeviceMotion",value:function(){this.api="devicemotion",this.fusionSensor=new Bn(this.config.K_FILTER,this.config.PREDICTION_TIME_S,this.config.YAW_ONLY,this.config.DEBUG),this.sensor&&(this.sensor.removeEventListener("reading",this._onSensorRead),this.sensor.removeEventListener("error",this._onSensorError),this.sensor=null)}},{key:"getOrientation",value:function(){if(this.fusionSensor)return this.fusionSensor.getOrientation();if(!this.sensor||!this.sensor.quaternion)return this._out[0]=this._out[1]=this._out[2]=0,this._out[3]=1,this._out;var w=this.sensor.quaternion;this._sensorQ.set(w[0],w[1],w[2],w[3]);var P=this._outQ;return P.copy(iu),P.multiply(this._sensorQ),this.config.YAW_ONLY&&(P.x=P.z=0,P.normalize()),this._out[0]=P.x,this._out[1]=P.y,this._out[2]=P.z,this._out[3]=P.w,this._out}},{key:"_onSensorError",value:function(w){this.errors.push(w.error),w.error.name==="NotAllowedError"?console.error("Permission to access sensor was denied"):w.error.name==="NotReadableError"?console.error("Sensor could not be read"):console.error(w.error),this.useDeviceMotion()}},{key:"_onSensorRead",value:function(){}}]),v}(),eS="<svg width='198' height='240' viewBox='0 0 198 240' xmlns='http://www.w3.org/2000/svg'><g fill='none' fill-rule='evenodd'><path d='M149.625 109.527l6.737 3.891v.886c0 .177.013.36.038.549.01.081.02.162.027.242.14 1.415.974 2.998 2.105 3.999l5.72 5.062.081-.09s4.382-2.53 5.235-3.024l25.97 14.993v54.001c0 .771-.386 1.217-.948 1.217-.233 0-.495-.076-.772-.236l-23.967-13.838-.014.024-27.322 15.775-.85-1.323c-4.731-1.529-9.748-2.74-14.951-3.61a.27.27 0 0 0-.007.024l-5.067 16.961-7.891 4.556-.037-.063v27.59c0 .772-.386 1.217-.948 1.217-.232 0-.495-.076-.772-.236l-42.473-24.522c-.95-.549-1.72-1.877-1.72-2.967v-1.035l-.021.047a5.111 5.111 0 0 0-1.816-.399 5.682 5.682 0 0 0-.546.001 13.724 13.724 0 0 1-1.918-.041c-1.655-.153-3.2-.6-4.404-1.296l-46.576-26.89.005.012-10.278-18.75c-1.001-1.827-.241-4.216 1.698-5.336l56.011-32.345a4.194 4.194 0 0 1 2.099-.572c1.326 0 2.572.659 3.227 1.853l.005-.003.227.413-.006.004a9.63 9.63 0 0 0 1.477 2.018l.277.27c1.914 1.85 4.468 2.801 7.113 2.801 1.949 0 3.948-.517 5.775-1.572.013 0 7.319-4.219 7.319-4.219a4.194 4.194 0 0 1 2.099-.572c1.326 0 2.572.658 3.226 1.853l3.25 5.928.022-.018 6.785 3.917-.105-.182 46.881-26.965m0-1.635c-.282 0-.563.073-.815.218l-46.169 26.556-5.41-3.124-3.005-5.481c-.913-1.667-2.699-2.702-4.66-2.703-1.011 0-2.02.274-2.917.792a3825 3825 0 0 1-7.275 4.195l-.044.024a9.937 9.937 0 0 1-4.957 1.353c-2.292 0-4.414-.832-5.976-2.342l-.252-.245a7.992 7.992 0 0 1-1.139-1.534 1.379 1.379 0 0 0-.06-.122l-.227-.414a1.718 1.718 0 0 0-.095-.154c-.938-1.574-2.673-2.545-4.571-2.545-1.011 0-2.02.274-2.917.792L3.125 155.502c-2.699 1.559-3.738 4.94-2.314 7.538l10.278 18.75c.177.323.448.563.761.704l46.426 26.804c1.403.81 3.157 1.332 5.072 1.508a15.661 15.661 0 0 0 2.146.046 4.766 4.766 0 0 1 .396 0c.096.004.19.011.283.022.109 1.593 1.159 3.323 2.529 4.114l42.472 24.522c.524.302 1.058.455 1.59.455 1.497 0 2.583-1.2 2.583-2.852v-26.562l7.111-4.105a1.64 1.64 0 0 0 .749-.948l4.658-15.593c4.414.797 8.692 1.848 12.742 3.128l.533.829a1.634 1.634 0 0 0 2.193.531l26.532-15.317L193 192.433c.523.302 1.058.455 1.59.455 1.497 0 2.583-1.199 2.583-2.852v-54.001c0-.584-.312-1.124-.818-1.416l-25.97-14.993a1.633 1.633 0 0 0-1.636.001c-.606.351-2.993 1.73-4.325 2.498l-4.809-4.255c-.819-.725-1.461-1.933-1.561-2.936a7.776 7.776 0 0 0-.033-.294 2.487 2.487 0 0 1-.023-.336v-.886c0-.584-.312-1.123-.817-1.416l-6.739-3.891a1.633 1.633 0 0 0-.817-.219' fill='#455A64'/><path d='M96.027 132.636l46.576 26.891c1.204.695 1.979 1.587 2.242 2.541l-.01.007-81.374 46.982h-.001c-1.654-.152-3.199-.6-4.403-1.295l-46.576-26.891 83.546-48.235' fill='#FAFAFA'/><path d='M63.461 209.174c-.008 0-.015 0-.022-.002-1.693-.156-3.228-.609-4.441-1.309l-46.576-26.89a.118.118 0 0 1 0-.203l83.546-48.235a.117.117 0 0 1 .117 0l46.576 26.891c1.227.708 2.021 1.612 2.296 2.611a.116.116 0 0 1-.042.124l-.021.016-81.375 46.981a.11.11 0 0 1-.058.016zm-50.747-28.303l46.401 26.79c1.178.68 2.671 1.121 4.32 1.276l81.272-46.922c-.279-.907-1.025-1.73-2.163-2.387l-46.517-26.857-83.313 48.1z' fill='#607D8B'/><path d='M148.327 165.471a5.85 5.85 0 0 1-.546.001c-1.894-.083-3.302-1.038-3.145-2.132a2.693 2.693 0 0 0-.072-1.105l-81.103 46.822c.628.058 1.272.073 1.918.042.182-.009.364-.009.546-.001 1.894.083 3.302 1.038 3.145 2.132l79.257-45.759' fill='#FFF'/><path d='M69.07 211.347a.118.118 0 0 1-.115-.134c.045-.317-.057-.637-.297-.925-.505-.61-1.555-1.022-2.738-1.074a5.966 5.966 0 0 0-.535.001 14.03 14.03 0 0 1-1.935-.041.117.117 0 0 1-.103-.092.116.116 0 0 1 .055-.126l81.104-46.822a.117.117 0 0 1 .171.07c.104.381.129.768.074 1.153-.045.316.057.637.296.925.506.61 1.555 1.021 2.739 1.073.178.008.357.008.535-.001a.117.117 0 0 1 .064.218l-79.256 45.759a.114.114 0 0 1-.059.016zm-3.405-2.372c.089 0 .177.002.265.006 1.266.056 2.353.488 2.908 1.158.227.274.35.575.36.882l78.685-45.429c-.036 0-.072-.001-.107-.003-1.267-.056-2.354-.489-2.909-1.158-.282-.34-.402-.724-.347-1.107a2.604 2.604 0 0 0-.032-.91L63.846 208.97a13.91 13.91 0 0 0 1.528.012c.097-.005.194-.007.291-.007z' fill='#607D8B'/><path d='M2.208 162.134c-1.001-1.827-.241-4.217 1.698-5.337l56.011-32.344c1.939-1.12 4.324-.546 5.326 1.281l.232.41a9.344 9.344 0 0 0 1.47 2.021l.278.27c3.325 3.214 8.583 3.716 12.888 1.23l7.319-4.22c1.94-1.119 4.324-.546 5.325 1.282l3.25 5.928-83.519 48.229-10.278-18.75z' fill='#FAFAFA'/><path d='M12.486 181.001a.112.112 0 0 1-.031-.005.114.114 0 0 1-.071-.056L2.106 162.19c-1.031-1.88-.249-4.345 1.742-5.494l56.01-32.344a4.328 4.328 0 0 1 2.158-.588c1.415 0 2.65.702 3.311 1.882.01.008.018.017.024.028l.227.414a.122.122 0 0 1 .013.038 9.508 9.508 0 0 0 1.439 1.959l.275.266c1.846 1.786 4.344 2.769 7.031 2.769 1.977 0 3.954-.538 5.717-1.557a.148.148 0 0 1 .035-.013l7.284-4.206a4.321 4.321 0 0 1 2.157-.588c1.427 0 2.672.716 3.329 1.914l3.249 5.929a.116.116 0 0 1-.044.157l-83.518 48.229a.116.116 0 0 1-.059.016zm49.53-57.004c-.704 0-1.41.193-2.041.557l-56.01 32.345c-1.882 1.086-2.624 3.409-1.655 5.179l10.221 18.645 83.317-48.112-3.195-5.829c-.615-1.122-1.783-1.792-3.124-1.792a4.08 4.08 0 0 0-2.04.557l-7.317 4.225a.148.148 0 0 1-.035.013 11.7 11.7 0 0 1-5.801 1.569c-2.748 0-5.303-1.007-7.194-2.835l-.278-.27a9.716 9.716 0 0 1-1.497-2.046.096.096 0 0 1-.013-.037l-.191-.347a.11.11 0 0 1-.023-.029c-.615-1.123-1.783-1.793-3.124-1.793z' fill='#607D8B'/><path d='M42.434 155.808c-2.51-.001-4.697-1.258-5.852-3.365-1.811-3.304-.438-7.634 3.059-9.654l12.291-7.098a7.599 7.599 0 0 1 3.789-1.033c2.51 0 4.697 1.258 5.852 3.365 1.811 3.304.439 7.634-3.059 9.654l-12.291 7.098a7.606 7.606 0 0 1-3.789 1.033zm13.287-20.683a7.128 7.128 0 0 0-3.555.971l-12.291 7.098c-3.279 1.893-4.573 5.942-2.883 9.024 1.071 1.955 3.106 3.122 5.442 3.122a7.13 7.13 0 0 0 3.556-.97l12.291-7.098c3.279-1.893 4.572-5.942 2.883-9.024-1.072-1.955-3.106-3.123-5.443-3.123z' fill='#607D8B'/><path d='M149.588 109.407l6.737 3.89v.887c0 .176.013.36.037.549.011.081.02.161.028.242.14 1.415.973 2.998 2.105 3.999l7.396 6.545c.177.156.358.295.541.415 1.579 1.04 2.95.466 3.062-1.282.049-.784.057-1.595.023-2.429l-.003-.16v-1.151l25.987 15.003v54c0 1.09-.77 1.53-1.72.982l-42.473-24.523c-.95-.548-1.72-1.877-1.72-2.966v-34.033' fill='#FAFAFA'/><path d='M194.553 191.25c-.257 0-.54-.085-.831-.253l-42.472-24.521c-.981-.567-1.779-1.943-1.779-3.068v-34.033h.234v34.033c0 1.051.745 2.336 1.661 2.866l42.473 24.521c.424.245.816.288 1.103.122.285-.164.442-.52.442-1.002v-53.933l-25.753-14.868.003 1.106c.034.832.026 1.654-.024 2.439-.054.844-.396 1.464-.963 1.746-.619.309-1.45.173-2.28-.373a5.023 5.023 0 0 1-.553-.426l-7.397-6.544c-1.158-1.026-1.999-2.625-2.143-4.076a9.624 9.624 0 0 0-.027-.238 4.241 4.241 0 0 1-.038-.564v-.82l-6.68-3.856.117-.202 6.738 3.89.058.034v.954c0 .171.012.351.036.533.011.083.021.165.029.246.138 1.395.948 2.935 2.065 3.923l7.397 6.545c.173.153.35.289.527.406.758.499 1.504.63 2.047.359.49-.243.786-.795.834-1.551.05-.778.057-1.591.024-2.417l-.004-.163v-1.355l.175.1 25.987 15.004.059.033v54.068c0 .569-.198.996-.559 1.204a1.002 1.002 0 0 1-.506.131' fill='#607D8B'/><path d='M145.685 163.161l24.115 13.922-25.978 14.998-1.462-.307c-6.534-2.17-13.628-3.728-21.019-4.616-4.365-.524-8.663 1.096-9.598 3.62a2.746 2.746 0 0 0-.011 1.928c1.538 4.267 4.236 8.363 7.995 12.135l.532.845-25.977 14.997-24.115-13.922 75.518-43.6' fill='#FFF'/><path d='M94.282 220.818l-.059-.033-24.29-14.024.175-.101 75.577-43.634.058.033 24.29 14.024-26.191 15.122-.045-.01-1.461-.307c-6.549-2.174-13.613-3.725-21.009-4.614a13.744 13.744 0 0 0-1.638-.097c-3.758 0-7.054 1.531-7.837 3.642a2.62 2.62 0 0 0-.01 1.848c1.535 4.258 4.216 8.326 7.968 12.091l.016.021.526.835.006.01.064.102-.105.061-25.977 14.998-.058.033zm-23.881-14.057l23.881 13.788 24.802-14.32c.546-.315.846-.489 1.017-.575l-.466-.74c-3.771-3.787-6.467-7.881-8.013-12.168a2.851 2.851 0 0 1 .011-2.008c.815-2.199 4.203-3.795 8.056-3.795.557 0 1.117.033 1.666.099 7.412.891 14.491 2.445 21.041 4.621.836.175 1.215.254 1.39.304l25.78-14.884-23.881-13.788-75.284 43.466z' fill='#607D8B'/><path d='M167.23 125.979v50.871l-27.321 15.773-6.461-14.167c-.91-1.996-3.428-1.738-5.624.574a10.238 10.238 0 0 0-2.33 4.018l-6.46 21.628-27.322 15.774v-50.871l75.518-43.6' fill='#FFF'/><path d='M91.712 220.567a.127.127 0 0 1-.059-.016.118.118 0 0 1-.058-.101v-50.871c0-.042.023-.08.058-.101l75.519-43.6a.117.117 0 0 1 .175.101v50.871c0 .041-.023.08-.059.1l-27.321 15.775a.118.118 0 0 1-.094.01.12.12 0 0 1-.071-.063l-6.46-14.168c-.375-.822-1.062-1.275-1.934-1.275-1.089 0-2.364.686-3.5 1.881a10.206 10.206 0 0 0-2.302 3.972l-6.46 21.627a.118.118 0 0 1-.054.068L91.77 220.551a.12.12 0 0 1-.058.016zm.117-50.92v50.601l27.106-15.65 6.447-21.583a10.286 10.286 0 0 1 2.357-4.065c1.18-1.242 2.517-1.954 3.669-1.954.969 0 1.731.501 2.146 1.411l6.407 14.051 27.152-15.676v-50.601l-75.284 43.466z' fill='#607D8B'/><path d='M168.543 126.213v50.87l-27.322 15.774-6.46-14.168c-.91-1.995-3.428-1.738-5.624.574a10.248 10.248 0 0 0-2.33 4.019l-6.461 21.627-27.321 15.774v-50.87l75.518-43.6' fill='#FFF'/><path d='M93.025 220.8a.123.123 0 0 1-.059-.015.12.12 0 0 1-.058-.101v-50.871c0-.042.023-.08.058-.101l75.518-43.6a.112.112 0 0 1 .117 0c.036.02.059.059.059.1v50.871a.116.116 0 0 1-.059.101l-27.321 15.774a.111.111 0 0 1-.094.01.115.115 0 0 1-.071-.062l-6.46-14.168c-.375-.823-1.062-1.275-1.935-1.275-1.088 0-2.363.685-3.499 1.881a10.19 10.19 0 0 0-2.302 3.971l-6.461 21.628a.108.108 0 0 1-.053.067l-27.322 15.775a.12.12 0 0 1-.058.015zm.117-50.919v50.6l27.106-15.649 6.447-21.584a10.293 10.293 0 0 1 2.357-4.065c1.179-1.241 2.516-1.954 3.668-1.954.969 0 1.732.502 2.147 1.412l6.407 14.051 27.152-15.676v-50.601l-75.284 43.466z' fill='#607D8B'/><path d='M169.8 177.083l-27.322 15.774-6.46-14.168c-.91-1.995-3.428-1.738-5.625.574a10.246 10.246 0 0 0-2.329 4.019l-6.461 21.627-27.321 15.774v-50.87l75.518-43.6v50.87z' fill='#FAFAFA'/><path d='M94.282 220.917a.234.234 0 0 1-.234-.233v-50.871c0-.083.045-.161.117-.202l75.518-43.601a.234.234 0 1 1 .35.202v50.871a.233.233 0 0 1-.116.202l-27.322 15.775a.232.232 0 0 1-.329-.106l-6.461-14.168c-.36-.789-.992-1.206-1.828-1.206-1.056 0-2.301.672-3.415 1.844a10.099 10.099 0 0 0-2.275 3.924l-6.46 21.628a.235.235 0 0 1-.107.136l-27.322 15.774a.23.23 0 0 1-.116.031zm.233-50.969v50.331l26.891-15.525 6.434-21.539a10.41 10.41 0 0 1 2.384-4.112c1.201-1.265 2.569-1.991 3.753-1.991 1.018 0 1.818.526 2.253 1.48l6.354 13.934 26.982-15.578v-50.331l-75.051 43.331z' fill='#607D8B'/><path d='M109.894 199.943c-1.774 0-3.241-.725-4.244-2.12a.224.224 0 0 1 .023-.294.233.233 0 0 1 .301-.023c.78.547 1.705.827 2.75.827 1.323 0 2.754-.439 4.256-1.306 5.311-3.067 9.631-10.518 9.631-16.611 0-1.927-.442-3.56-1.278-4.724a.232.232 0 0 1 .323-.327c1.671 1.172 2.591 3.381 2.591 6.219 0 6.242-4.426 13.863-9.865 17.003-1.574.908-3.084 1.356-4.488 1.356zm-2.969-1.542c.813.651 1.82.877 2.968.877h.001c1.321 0 2.753-.327 4.254-1.194 5.311-3.067 9.632-10.463 9.632-16.556 0-1.979-.463-3.599-1.326-4.761.411 1.035.625 2.275.625 3.635 0 6.243-4.426 13.883-9.865 17.023-1.574.909-3.084 1.317-4.49 1.317-.641 0-1.243-.149-1.799-.341z' fill='#607D8B'/><path d='M113.097 197.23c5.384-3.108 9.748-10.636 9.748-16.814 0-2.051-.483-3.692-1.323-4.86-1.784-1.252-4.374-1.194-7.257.47-5.384 3.108-9.748 10.636-9.748 16.814 0 2.051.483 3.692 1.323 4.86 1.784 1.252 4.374 1.194 7.257-.47' fill='#FAFAFA'/><path d='M108.724 198.614c-1.142 0-2.158-.213-3.019-.817-.021-.014-.04.014-.055-.007-.894-1.244-1.367-2.948-1.367-4.973 0-6.242 4.426-13.864 9.865-17.005 1.574-.908 3.084-1.363 4.49-1.363 1.142 0 2.158.309 3.018.913a.23.23 0 0 1 .056.056c.894 1.244 1.367 2.972 1.367 4.997 0 6.243-4.426 13.783-9.865 16.923-1.574.909-3.084 1.276-4.49 1.276zm-2.718-1.109c.774.532 1.688.776 2.718.776 1.323 0 2.754-.413 4.256-1.28 5.311-3.066 9.631-10.505 9.631-16.598 0-1.909-.434-3.523-1.255-4.685-.774-.533-1.688-.799-2.718-.799-1.323 0-2.755.441-4.256 1.308-5.311 3.066-9.631 10.506-9.631 16.599 0 1.909.434 3.517 1.255 4.679z' fill='#607D8B'/><path d='M149.318 114.262l-9.984 8.878 15.893 11.031 5.589-6.112-11.498-13.797' fill='#FAFAFA'/><path d='M169.676 120.84l-9.748 5.627c-3.642 2.103-9.528 2.113-13.147.024-3.62-2.089-3.601-5.488.041-7.591l9.495-5.608-6.729-3.885-81.836 47.071 45.923 26.514 3.081-1.779c.631-.365.869-.898.618-1.39-2.357-4.632-2.593-9.546-.683-14.262 5.638-13.92 24.509-24.815 48.618-28.07 8.169-1.103 16.68-.967 24.704.394.852.145 1.776.008 2.407-.357l3.081-1.778-25.825-14.91' fill='#FAFAFA'/><path d='M113.675 183.459a.47.47 0 0 1-.233-.062l-45.924-26.515a.468.468 0 0 1 .001-.809l81.836-47.071a.467.467 0 0 1 .466 0l6.729 3.885a.467.467 0 0 1-.467.809l-6.496-3.75-80.9 46.533 44.988 25.973 2.848-1.644c.192-.111.62-.409.435-.773-2.416-4.748-2.658-9.814-.7-14.65 2.806-6.927 8.885-13.242 17.582-18.263 8.657-4.998 19.518-8.489 31.407-10.094 8.198-1.107 16.79-.97 24.844.397.739.125 1.561.007 2.095-.301l2.381-1.374-25.125-14.506a.467.467 0 0 1 .467-.809l25.825 14.91a.467.467 0 0 1 0 .809l-3.081 1.779c-.721.417-1.763.575-2.718.413-7.963-1.351-16.457-1.486-24.563-.392-11.77 1.589-22.512 5.039-31.065 9.977-8.514 4.916-14.456 11.073-17.183 17.805-1.854 4.578-1.623 9.376.666 13.875.37.725.055 1.513-.8 2.006l-3.081 1.78a.476.476 0 0 1-.234.062' fill='#455A64'/><path d='M153.316 128.279c-2.413 0-4.821-.528-6.652-1.586-1.818-1.049-2.82-2.461-2.82-3.975 0-1.527 1.016-2.955 2.861-4.02l9.493-5.607a.233.233 0 1 1 .238.402l-9.496 5.609c-1.696.979-2.628 2.263-2.628 3.616 0 1.34.918 2.608 2.585 3.571 3.549 2.049 9.343 2.038 12.914-.024l9.748-5.628a.234.234 0 0 1 .234.405l-9.748 5.628c-1.858 1.072-4.296 1.609-6.729 1.609' fill='#607D8B'/><path d='M113.675 182.992l-45.913-26.508M113.675 183.342a.346.346 0 0 1-.175-.047l-45.913-26.508a.35.35 0 1 1 .35-.607l45.913 26.508a.35.35 0 0 1-.175.654' fill='#455A64'/><path d='M67.762 156.484v54.001c0 1.09.77 2.418 1.72 2.967l42.473 24.521c.95.549 1.72.11 1.72-.98v-54.001' fill='#FAFAFA'/><path d='M112.727 238.561c-.297 0-.62-.095-.947-.285l-42.473-24.521c-1.063-.613-1.895-2.05-1.895-3.27v-54.001a.35.35 0 1 1 .701 0v54.001c0 .96.707 2.18 1.544 2.663l42.473 24.522c.344.198.661.243.87.122.206-.119.325-.411.325-.799v-54.001a.35.35 0 1 1 .7 0v54.001c0 .655-.239 1.154-.675 1.406a1.235 1.235 0 0 1-.623.162' fill='#455A64'/><path d='M112.86 147.512h-.001c-2.318 0-4.499-.522-6.142-1.471-1.705-.984-2.643-2.315-2.643-3.749 0-1.445.952-2.791 2.68-3.788l12.041-6.953c1.668-.962 3.874-1.493 6.212-1.493 2.318 0 4.499.523 6.143 1.472 1.704.984 2.643 2.315 2.643 3.748 0 1.446-.952 2.791-2.68 3.789l-12.042 6.952c-1.668.963-3.874 1.493-6.211 1.493zm12.147-16.753c-2.217 0-4.298.497-5.861 1.399l-12.042 6.952c-1.502.868-2.33 1.998-2.33 3.182 0 1.173.815 2.289 2.293 3.142 1.538.889 3.596 1.378 5.792 1.378h.001c2.216 0 4.298-.497 5.861-1.399l12.041-6.953c1.502-.867 2.33-1.997 2.33-3.182 0-1.172-.814-2.288-2.292-3.142-1.539-.888-3.596-1.377-5.793-1.377z' fill='#607D8B'/><path d='M165.63 123.219l-5.734 3.311c-3.167 1.828-8.286 1.837-11.433.02-3.147-1.817-3.131-4.772.036-6.601l5.734-3.31 11.397 6.58' fill='#FAFAFA'/><path d='M154.233 117.448l9.995 5.771-4.682 2.704c-1.434.827-3.352 1.283-5.399 1.283-2.029 0-3.923-.449-5.333-1.263-1.29-.744-2-1.694-2-2.674 0-.991.723-1.955 2.036-2.713l5.383-3.108m0-.809l-5.734 3.31c-3.167 1.829-3.183 4.784-.036 6.601 1.568.905 3.623 1.357 5.684 1.357 2.077 0 4.159-.46 5.749-1.377l5.734-3.311-11.397-6.58M145.445 179.667c-1.773 0-3.241-.85-4.243-2.245-.067-.092-.057-.275.023-.356.08-.081.207-.12.3-.055.781.548 1.706.812 2.751.811 1.322 0 2.754-.446 4.256-1.313 5.31-3.066 9.631-10.522 9.631-16.615 0-1.927-.442-3.562-1.279-4.726a.235.235 0 0 1 .024-.301.232.232 0 0 1 .3-.027c1.67 1.172 2.59 3.38 2.59 6.219 0 6.242-4.425 13.987-9.865 17.127-1.573.908-3.083 1.481-4.488 1.481zM142.476 178c.814.651 1.82 1.002 2.969 1.002 1.322 0 2.753-.452 4.255-1.32 5.31-3.065 9.631-10.523 9.631-16.617 0-1.98-.463-3.63-1.325-4.793.411 1.035.624 2.26.624 3.62 0 6.242-4.425 13.875-9.865 17.015-1.573.909-3.084 1.376-4.489 1.376a5.49 5.49 0 0 1-1.8-.283z' fill='#607D8B'/><path d='M148.648 176.704c5.384-3.108 9.748-10.636 9.748-16.813 0-2.052-.483-3.693-1.322-4.861-1.785-1.252-4.375-1.194-7.258.471-5.383 3.108-9.748 10.636-9.748 16.813 0 2.051.484 3.692 1.323 4.86 1.785 1.253 4.374 1.195 7.257-.47' fill='#FAFAFA'/><path d='M144.276 178.276c-1.143 0-2.158-.307-3.019-.911a.217.217 0 0 1-.055-.054c-.895-1.244-1.367-2.972-1.367-4.997 0-6.241 4.425-13.875 9.865-17.016 1.573-.908 3.084-1.369 4.489-1.369 1.143 0 2.158.307 3.019.91a.24.24 0 0 1 .055.055c.894 1.244 1.367 2.971 1.367 4.997 0 6.241-4.425 13.875-9.865 17.016-1.573.908-3.084 1.369-4.489 1.369zm-2.718-1.172c.773.533 1.687.901 2.718.901 1.322 0 2.754-.538 4.256-1.405 5.31-3.066 9.631-10.567 9.631-16.661 0-1.908-.434-3.554-1.256-4.716-.774-.532-1.688-.814-2.718-.814-1.322 0-2.754.433-4.256 1.3-5.31 3.066-9.631 10.564-9.631 16.657 0 1.91.434 3.576 1.256 4.738z' fill='#607D8B'/><path d='M150.72 172.361l-.363-.295a24.105 24.105 0 0 0 2.148-3.128 24.05 24.05 0 0 0 1.977-4.375l.443.149a24.54 24.54 0 0 1-2.015 4.46 24.61 24.61 0 0 1-2.19 3.189M115.917 191.514l-.363-.294a24.174 24.174 0 0 0 2.148-3.128 24.038 24.038 0 0 0 1.976-4.375l.443.148a24.48 24.48 0 0 1-2.015 4.461 24.662 24.662 0 0 1-2.189 3.188M114 237.476V182.584 237.476' fill='#607D8B'/><g><path d='M81.822 37.474c.017-.135-.075-.28-.267-.392-.327-.188-.826-.21-1.109-.045l-6.012 3.471c-.131.076-.194.178-.191.285.002.132.002.461.002.578v.043l-.007.128-6.591 3.779c-.001 0-2.077 1.046-2.787 5.192 0 0-.912 6.961-.898 19.745.015 12.57.606 17.07 1.167 21.351.22 1.684 3.001 2.125 3.001 2.125.331.04.698-.027 1.08-.248l75.273-43.551c1.808-1.069 2.667-3.719 3.056-6.284 1.213-7.99 1.675-32.978-.275-39.878-.196-.693-.51-1.083-.868-1.282l-2.086-.79c-.727.028-1.416.467-1.534.535L82.032 37.072l-.21.402' fill='#FFF'/><path d='M144.311 1.701l2.085.79c.358.199.672.589.868 1.282 1.949 6.9 1.487 31.887.275 39.878-.39 2.565-1.249 5.215-3.056 6.284L69.21 93.486a1.78 1.78 0 0 1-.896.258l-.183-.011c0 .001-2.782-.44-3.003-2.124-.56-4.282-1.151-8.781-1.165-21.351-.015-12.784.897-19.745.897-19.745.71-4.146 2.787-5.192 2.787-5.192l6.591-3.779.007-.128v-.043c0-.117 0-.446-.002-.578-.003-.107.059-.21.191-.285l6.012-3.472a.98.98 0 0 1 .481-.11c.218 0 .449.053.627.156.193.112.285.258.268.392l.211-.402 60.744-34.836c.117-.068.806-.507 1.534-.535m0-.997l-.039.001c-.618.023-1.283.244-1.974.656l-.021.012-60.519 34.706a2.358 2.358 0 0 0-.831-.15c-.365 0-.704.084-.98.244l-6.012 3.471c-.442.255-.699.69-.689 1.166l.001.15-6.08 3.487c-.373.199-2.542 1.531-3.29 5.898l-.006.039c-.009.07-.92 7.173-.906 19.875.014 12.62.603 17.116 1.172 21.465l.002.015c.308 2.355 3.475 2.923 3.836 2.98l.034.004c.101.013.204.019.305.019a2.77 2.77 0 0 0 1.396-.392l75.273-43.552c1.811-1.071 2.999-3.423 3.542-6.997 1.186-7.814 1.734-33.096-.301-40.299-.253-.893-.704-1.527-1.343-1.882l-.132-.062-2.085-.789a.973.973 0 0 0-.353-.065' fill='#455A64'/><path d='M128.267 11.565l1.495.434-56.339 32.326' fill='#FFF'/><path d='M74.202 90.545a.5.5 0 0 1-.25-.931l18.437-10.645a.499.499 0 1 1 .499.864L74.451 90.478l-.249.067M75.764 42.654l-.108-.062.046-.171 5.135-2.964.17.045-.045.171-5.135 2.964-.063.017M70.52 90.375V46.421l.063-.036L137.84 7.554v43.954l-.062.036L70.52 90.375zm.25-43.811v43.38l66.821-38.579V7.985L70.77 46.564z' fill='#607D8B'/><path d='M86.986 83.182c-.23.149-.612.384-.849.523l-11.505 6.701c-.237.139-.206.252.068.252h.565c.275 0 .693-.113.93-.252L87.7 83.705c.237-.139.428-.253.425-.256a11.29 11.29 0 0 1-.006-.503c0-.274-.188-.377-.418-.227l-.715.463' fill='#607D8B'/><path d='M75.266 90.782H74.7c-.2 0-.316-.056-.346-.166-.03-.11.043-.217.215-.317l11.505-6.702c.236-.138.615-.371.844-.519l.715-.464a.488.488 0 0 1 .266-.089c.172 0 .345.13.345.421 0 .214.001.363.003.437l.006.004-.004.069c-.003.075-.003.075-.486.356l-11.505 6.702a2.282 2.282 0 0 1-.992.268zm-.6-.25l.034.001h.566c.252 0 .649-.108.866-.234l11.505-6.702c.168-.098.294-.173.361-.214-.004-.084-.004-.218-.004-.437l-.095-.171-.131.049-.714.463c-.232.15-.616.386-.854.525l-11.505 6.702-.029.018z' fill='#607D8B'/><path d='M75.266 89.871H74.7c-.2 0-.316-.056-.346-.166-.03-.11.043-.217.215-.317l11.505-6.702c.258-.151.694-.268.993-.268h.565c.2 0 .316.056.346.166.03.11-.043.217-.215.317l-11.505 6.702a2.282 2.282 0 0 1-.992.268zm-.6-.25l.034.001h.566c.252 0 .649-.107.866-.234l11.505-6.702.03-.018-.035-.001h-.565c-.252 0-.649.108-.867.234l-11.505 6.702-.029.018zM74.37 90.801v-1.247 1.247' fill='#607D8B'/><path d='M68.13 93.901c-.751-.093-1.314-.737-1.439-1.376-.831-4.238-1.151-8.782-1.165-21.352-.015-12.784.897-19.745.897-19.745.711-4.146 2.787-5.192 2.787-5.192l74.859-43.219c.223-.129 2.487-1.584 3.195.923 1.95 6.9 1.488 31.887.275 39.878-.389 2.565-1.248 5.215-3.056 6.283L69.21 93.653c-.382.221-.749.288-1.08.248 0 0-2.781-.441-3.001-2.125-.561-4.281-1.152-8.781-1.167-21.351-.014-12.784.898-19.745.898-19.745.71-4.146 2.787-5.191 2.787-5.191l6.598-3.81.871-.119 6.599-3.83.046-.461L68.13 93.901' fill='#FAFAFA'/><path d='M68.317 94.161l-.215-.013h-.001l-.244-.047c-.719-.156-2.772-.736-2.976-2.292-.568-4.34-1.154-8.813-1.168-21.384-.014-12.654.891-19.707.9-19.777.725-4.231 2.832-5.338 2.922-5.382l6.628-3.827.87-.119 6.446-3.742.034-.334a.248.248 0 0 1 .273-.223.248.248 0 0 1 .223.272l-.059.589-6.752 3.919-.87.118-6.556 3.785c-.031.016-1.99 1.068-2.666 5.018-.007.06-.908 7.086-.894 19.702.014 12.539.597 16.996 1.161 21.305.091.691.689 1.154 1.309 1.452a1.95 1.95 0 0 1-.236-.609c-.781-3.984-1.155-8.202-1.17-21.399-.014-12.653.891-19.707.9-19.777.725-4.231 2.832-5.337 2.922-5.382-.004.001 74.444-42.98 74.846-43.212l.028-.017c.904-.538 1.72-.688 2.36-.433.555.221.949.733 1.172 1.52 2.014 7.128 1.46 32.219.281 39.983-.507 3.341-1.575 5.515-3.175 6.462L69.335 93.869a2.023 2.023 0 0 1-1.018.292zm-.147-.507c.293.036.604-.037.915-.217l75.273-43.551c1.823-1.078 2.602-3.915 2.934-6.106 1.174-7.731 1.731-32.695-.268-39.772-.178-.631-.473-1.032-.876-1.192-.484-.193-1.166-.052-1.921.397l-.034.021-74.858 43.218c-.031.017-1.989 1.069-2.666 5.019-.007.059-.908 7.085-.894 19.702.015 13.155.386 17.351 1.161 21.303.09.461.476.983 1.037 1.139.114.025.185.037.196.039h.001z' fill='#455A64'/><path d='M69.317 68.982c.489-.281.885-.056.885.505 0 .56-.396 1.243-.885 1.525-.488.282-.884.057-.884-.504 0-.56.396-1.243.884-1.526' fill='#FFF'/><path d='M68.92 71.133c-.289 0-.487-.228-.487-.625 0-.56.396-1.243.884-1.526a.812.812 0 0 1 .397-.121c.289 0 .488.229.488.626 0 .56-.396 1.243-.885 1.525a.812.812 0 0 1-.397.121m.794-2.459a.976.976 0 0 0-.49.147c-.548.317-.978 1.058-.978 1.687 0 .486.271.812.674.812a.985.985 0 0 0 .491-.146c.548-.317.978-1.057.978-1.687 0-.486-.272-.813-.675-.813' fill='#8097A2'/><path d='M68.92 70.947c-.271 0-.299-.307-.299-.439 0-.491.361-1.116.79-1.363a.632.632 0 0 1 .303-.096c.272 0 .301.306.301.438 0 .491-.363 1.116-.791 1.364a.629.629 0 0 1-.304.096m.794-2.086a.812.812 0 0 0-.397.121c-.488.283-.884.966-.884 1.526 0 .397.198.625.487.625a.812.812 0 0 0 .397-.121c.489-.282.885-.965.885-1.525 0-.397-.199-.626-.488-.626' fill='#8097A2'/><path d='M69.444 85.35c.264-.152.477-.031.477.272 0 .303-.213.67-.477.822-.263.153-.477.031-.477-.271 0-.302.214-.671.477-.823' fill='#FFF'/><path d='M69.23 86.51c-.156 0-.263-.123-.263-.337 0-.302.214-.671.477-.823a.431.431 0 0 1 .214-.066c.156 0 .263.124.263.338 0 .303-.213.67-.477.822a.431.431 0 0 1-.214.066m.428-1.412c-.1 0-.203.029-.307.09-.32.185-.57.618-.57.985 0 .309.185.524.449.524a.63.63 0 0 0 .308-.09c.32-.185.57-.618.57-.985 0-.309-.185-.524-.45-.524' fill='#8097A2'/><path d='M69.23 86.322l-.076-.149c0-.235.179-.544.384-.661l.12-.041.076.151c0 .234-.179.542-.383.66l-.121.04m.428-1.038a.431.431 0 0 0-.214.066c-.263.152-.477.521-.477.823 0 .214.107.337.263.337a.431.431 0 0 0 .214-.066c.264-.152.477-.519.477-.822 0-.214-.107-.338-.263-.338' fill='#8097A2'/><path d='M139.278 7.769v43.667L72.208 90.16V46.493l67.07-38.724' fill='#455A64'/><path d='M72.083 90.375V46.421l.063-.036 67.257-38.831v43.954l-.062.036-67.258 38.831zm.25-43.811v43.38l66.821-38.579V7.985L72.333 46.564z' fill='#607D8B'/></g><path d='M125.737 88.647l-7.639 3.334V84l-11.459 4.713v8.269L99 100.315l13.369 3.646 13.368-15.314' fill='#455A64'/></g></svg>";function qr(){this.loadIcon_();var v=document.createElement("div"),Y=v.style;Y.position="fixed",Y.top=0,Y.right=0,Y.bottom=0,Y.left=0,Y.backgroundColor="gray",Y.fontFamily="sans-serif",Y.zIndex=1e6;var x=document.createElement("img");x.src=this.icon;var Y=x.style;Y.marginLeft="25%",Y.marginTop="25%",Y.width="50%",v.appendChild(x);var w=document.createElement("div"),Y=w.style;Y.textAlign="center",Y.fontSize="16px",Y.lineHeight="24px",Y.margin="24px 25%",Y.width="50%",w.innerHTML="Place your phone into your Cardboard viewer.",v.appendChild(w);var P=document.createElement("div"),Y=P.style;Y.backgroundColor="#CFD8DC",Y.position="fixed",Y.bottom=0,Y.width="100%",Y.height="48px",Y.padding="14px 24px",Y.boxSizing="border-box",Y.color="#656A6B",v.appendChild(P);var L=document.createElement("div");L.style.float="left",L.innerHTML="No Cardboard viewer?";var W=document.createElement("a");W.href="https://www.google.com/get/cardboard/get-cardboard/",W.innerHTML="get one",W.target="_blank";var Y=W.style;Y.float="right",Y.fontWeight=600,Y.textTransform="uppercase",Y.borderLeft="1px solid gray",Y.paddingLeft="24px",Y.textDecoration="none",Y.color="#656A6B",P.appendChild(L),P.appendChild(W),this.overlay=v,this.text=w,this.hide()}qr.prototype.show=function(v){!v&&!this.overlay.parentElement?document.body.appendChild(this.overlay):v&&(this.overlay.parentElement&&this.overlay.parentElement!=v&&this.overlay.parentElement.removeChild(this.overlay),v.appendChild(this.overlay)),this.overlay.style.display="block";var x=this.overlay.querySelector("img"),w=x.style;ui()?(w.width="20%",w.marginLeft="40%",w.marginTop="3%"):(w.width="50%",w.marginLeft="25%",w.marginTop="25%")},qr.prototype.hide=function(){this.overlay.style.display="none"},qr.prototype.showTemporarily=function(v,x){this.show(x),this.timer=setTimeout(this.hide.bind(this),v)},qr.prototype.disableShowTemporarily=function(){clearTimeout(this.timer)},qr.prototype.update=function(){this.disableShowTemporarily(),!ui()&&Gs()?this.show():this.hide()},qr.prototype.loadIcon_=function(){this.icon=oe("image/svg+xml",eS)};var tS="CardboardV1",Og="WEBVR_CARDBOARD_VIEWER",iS="webvr-polyfill-viewer-selector";function Nn(v){try{this.selectedKey=localStorage.getItem(Og)}catch(x){console.error("Failed to load viewer profile: %s",x)}this.selectedKey||(this.selectedKey=v||tS),this.dialog=this.createDialog_(Si.Viewers),this.root=null,this.onChangeCallbacks_=[]}Nn.prototype.show=function(v){this.root=v,v.appendChild(this.dialog);var x=this.dialog.querySelector("#"+this.selectedKey);x.checked=!0,this.dialog.style.display="block"},Nn.prototype.hide=function(){this.root&&this.root.contains(this.dialog)&&this.root.removeChild(this.dialog),this.dialog.style.display="none"},Nn.prototype.getCurrentViewer=function(){return Si.Viewers[this.selectedKey]},Nn.prototype.getSelectedKey_=function(){var v=this.dialog.querySelector("input[name=field]:checked");return v?v.id:null},Nn.prototype.onChange=function(v){this.onChangeCallbacks_.push(v)},Nn.prototype.fireOnChange_=function(v){for(var x=0;x<this.onChangeCallbacks_.length;x++)this.onChangeCallbacks_[x](v)},Nn.prototype.onSave_=function(){if(this.selectedKey=this.getSelectedKey_(),!this.selectedKey||!Si.Viewers[this.selectedKey]){console.error("ViewerSelector.onSave_: this should never happen!");return}this.fireOnChange_(Si.Viewers[this.selectedKey]);try{localStorage.setItem(Og,this.selectedKey)}catch(v){console.error("Failed to save viewer profile: %s",v)}this.hide()},Nn.prototype.createDialog_=function(v){var x=document.createElement("div");x.classList.add(iS),x.style.display="none";var w=document.createElement("div"),W=w.style;W.position="fixed",W.left=0,W.top=0,W.width="100%",W.height="100%",W.background="rgba(0, 0, 0, 0.3)",w.addEventListener("click",this.hide.bind(this));var P=280,L=document.createElement("div"),W=L.style;W.boxSizing="border-box",W.position="fixed",W.top="24px",W.left="50%",W.marginLeft=-P/2+"px",W.width=P+"px",W.padding="24px",W.overflow="hidden",W.background="#fafafa",W.fontFamily="'Roboto', sans-serif",W.boxShadow="0px 5px 20px #666",L.appendChild(this.createH1_("Select your viewer"));for(var Y in v)L.appendChild(this.createChoice_(Y,v[Y].label));return L.appendChild(this.createButton_("Save",this.onSave_.bind(this))),x.appendChild(w),x.appendChild(L),x},Nn.prototype.createH1_=function(v){var x=document.createElement("h1"),w=x.style;return w.color="black",w.fontSize="20px",w.fontWeight="bold",w.marginTop=0,w.marginBottom="24px",x.innerHTML=v,x},Nn.prototype.createChoice_=function(v,x){var w=document.createElement("div");w.style.marginTop="8px",w.style.color="black";var P=document.createElement("input");P.style.fontSize="30px",P.setAttribute("id",v),P.setAttribute("type","radio"),P.setAttribute("value",v),P.setAttribute("name","field");var L=document.createElement("label");return L.style.marginLeft="4px",L.setAttribute("for",v),L.innerHTML=x,w.appendChild(P),w.appendChild(L),w},Nn.prototype.createButton_=function(v,x){var w=document.createElement("button");w.innerHTML=v;var P=w.style;return P.float="right",P.textTransform="uppercase",P.color="#1094f7",P.fontSize="14px",P.letterSpacing=0,P.border=0,P.background="none",P.marginTop="16px",w.addEventListener("click",x),w};var nS=typeof window!="undefined"?window:typeof qd!="undefined"?qd:typeof self!="undefined"?self:{};function sS(v){return v&&v.__esModule&&Object.prototype.hasOwnProperty.call(v,"default")?v.default:v}function rS(v,x){return x={exports:{}},v(x,x.exports),x.exports}var oS=rS(function(v,x){(function(P,L){v.exports=L()})(nS,function(){return function(w){var P={};function L(W){if(P[W])return P[W].exports;var Y=P[W]={i:W,l:!1,exports:{}};return w[W].call(Y.exports,Y,Y.exports,L),Y.l=!0,Y.exports}return L.m=w,L.c=P,L.d=function(W,Y,fe){L.o(W,Y)||Object.defineProperty(W,Y,{configurable:!1,enumerable:!0,get:fe})},L.n=function(W){var Y=W&&W.__esModule?function(){return W.default}:function(){return W};return L.d(Y,"a",Y),Y},L.o=function(W,Y){return Object.prototype.hasOwnProperty.call(W,Y)},L.p="",L(L.s=0)}([function(w,P,L){var W=function(){function se(Te,$e){for(var ot=0;ot<$e.length;ot++){var ht=$e[ot];ht.enumerable=ht.enumerable||!1,ht.configurable=!0,"value"in ht&&(ht.writable=!0),Object.defineProperty(Te,ht.key,ht)}}return function(Te,$e,ot){return $e&&se(Te.prototype,$e),ot&&se(Te,ot),Te}}();function Y(se,Te){if(!(se instanceof Te))throw new TypeError("Cannot call a class as a function")}var fe=L(1),pe=typeof navigator!="undefined"&&parseFloat((""+(/CPU.*OS ([0-9_]{3,4})[0-9_]{0,1}|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))<10&&!window.MSStream,$=function(){function se(){Y(this,se),pe?this.noSleepTimer=null:(this.noSleepVideo=document.createElement("video"),this.noSleepVideo.setAttribute("playsinline",""),this.noSleepVideo.setAttribute("src",fe),this.noSleepVideo.addEventListener("timeupdate",function(Te){this.noSleepVideo.currentTime>.5&&(this.noSleepVideo.currentTime=Math.random())}.bind(this)))}return W(se,[{key:"enable",value:function(){pe?(this.disable(),this.noSleepTimer=window.setInterval(function(){window.location.href="/",window.setTimeout(window.stop,0)},15e3)):this.noSleepVideo.play()}},{key:"disable",value:function(){pe?this.noSleepTimer&&(window.clearInterval(this.noSleepTimer),this.noSleepTimer=null):this.noSleepVideo.pause()}}]),se}();w.exports=$},function(w,P,L){w.exports="data:video/mp4;base64,AAAAIGZ0eXBtcDQyAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAACKBtZGF0AAAC8wYF///v3EXpvebZSLeWLNgg2SPu73gyNjQgLSBjb3JlIDE0MiByMjQ3OSBkZDc5YTYxIC0gSC4yNjQvTVBFRy00IEFWQyBjb2RlYyAtIENvcHlsZWZ0IDIwMDMtMjAxNCAtIGh0dHA6Ly93d3cudmlkZW9sYW4ub3JnL3gyNjQuaHRtbCAtIG9wdGlvbnM6IGNhYmFjPTEgcmVmPTEgZGVibG9jaz0xOjA6MCBhbmFseXNlPTB4MToweDExMSBtZT1oZXggc3VibWU9MiBwc3k9MSBwc3lfcmQ9MS4wMDowLjAwIG1peGVkX3JlZj0wIG1lX3JhbmdlPTE2IGNocm9tYV9tZT0xIHRyZWxsaXM9MCA4eDhkY3Q9MCBjcW09MCBkZWFkem9uZT0yMSwxMSBmYXN0X3Bza2lwPTEgY2hyb21hX3FwX29mZnNldD0wIHRocmVhZHM9NiBsb29rYWhlYWRfdGhyZWFkcz0xIHNsaWNlZF90aHJlYWRzPTAgbnI9MCBkZWNpbWF0ZT0xIGludGVybGFjZWQ9MCBibHVyYXlfY29tcGF0PTAgY29uc3RyYWluZWRfaW50cmE9MCBiZnJhbWVzPTMgYl9weXJhbWlkPTIgYl9hZGFwdD0xIGJfYmlhcz0wIGRpcmVjdD0xIHdlaWdodGI9MSBvcGVuX2dvcD0wIHdlaWdodHA9MSBrZXlpbnQ9MzAwIGtleWludF9taW49MzAgc2NlbmVjdXQ9NDAgaW50cmFfcmVmcmVzaD0wIHJjX2xvb2thaGVhZD0xMCByYz1jcmYgbWJ0cmVlPTEgY3JmPTIwLjAgcWNvbXA9MC42MCBxcG1pbj0wIHFwbWF4PTY5IHFwc3RlcD00IHZidl9tYXhyYXRlPTIwMDAwIHZidl9idWZzaXplPTI1MDAwIGNyZl9tYXg9MC4wIG5hbF9ocmQ9bm9uZSBmaWxsZXI9MCBpcF9yYXRpbz0xLjQwIGFxPTE6MS4wMACAAAAAOWWIhAA3//p+C7v8tDDSTjf97w55i3SbRPO4ZY+hkjD5hbkAkL3zpJ6h/LR1CAABzgB1kqqzUorlhQAAAAxBmiQYhn/+qZYADLgAAAAJQZ5CQhX/AAj5IQADQGgcIQADQGgcAAAACQGeYUQn/wALKCEAA0BoHAAAAAkBnmNEJ/8ACykhAANAaBwhAANAaBwAAAANQZpoNExDP/6plgAMuSEAA0BoHAAAAAtBnoZFESwr/wAI+SEAA0BoHCEAA0BoHAAAAAkBnqVEJ/8ACykhAANAaBwAAAAJAZ6nRCf/AAsoIQADQGgcIQADQGgcAAAADUGarDRMQz/+qZYADLghAANAaBwAAAALQZ7KRRUsK/8ACPkhAANAaBwAAAAJAZ7pRCf/AAsoIQADQGgcIQADQGgcAAAACQGe60Qn/wALKCEAA0BoHAAAAA1BmvA0TEM//qmWAAy5IQADQGgcIQADQGgcAAAAC0GfDkUVLCv/AAj5IQADQGgcAAAACQGfLUQn/wALKSEAA0BoHCEAA0BoHAAAAAkBny9EJ/8ACyghAANAaBwAAAANQZs0NExDP/6plgAMuCEAA0BoHAAAAAtBn1JFFSwr/wAI+SEAA0BoHCEAA0BoHAAAAAkBn3FEJ/8ACyghAANAaBwAAAAJAZ9zRCf/AAsoIQADQGgcIQADQGgcAAAADUGbeDRMQz/+qZYADLkhAANAaBwAAAALQZ+WRRUsK/8ACPghAANAaBwhAANAaBwAAAAJAZ+1RCf/AAspIQADQGgcAAAACQGft0Qn/wALKSEAA0BoHCEAA0BoHAAAAA1Bm7w0TEM//qmWAAy4IQADQGgcAAAAC0Gf2kUVLCv/AAj5IQADQGgcAAAACQGf+UQn/wALKCEAA0BoHCEAA0BoHAAAAAkBn/tEJ/8ACykhAANAaBwAAAANQZvgNExDP/6plgAMuSEAA0BoHCEAA0BoHAAAAAtBnh5FFSwr/wAI+CEAA0BoHAAAAAkBnj1EJ/8ACyghAANAaBwhAANAaBwAAAAJAZ4/RCf/AAspIQADQGgcAAAADUGaJDRMQz/+qZYADLghAANAaBwAAAALQZ5CRRUsK/8ACPkhAANAaBwhAANAaBwAAAAJAZ5hRCf/AAsoIQADQGgcAAAACQGeY0Qn/wALKSEAA0BoHCEAA0BoHAAAAA1Bmmg0TEM//qmWAAy5IQADQGgcAAAAC0GehkUVLCv/AAj5IQADQGgcIQADQGgcAAAACQGepUQn/wALKSEAA0BoHAAAAAkBnqdEJ/8ACyghAANAaBwAAAANQZqsNExDP/6plgAMuCEAA0BoHCEAA0BoHAAAAAtBnspFFSwr/wAI+SEAA0BoHAAAAAkBnulEJ/8ACyghAANAaBwhAANAaBwAAAAJAZ7rRCf/AAsoIQADQGgcAAAADUGa8DRMQz/+qZYADLkhAANAaBwhAANAaBwAAAALQZ8ORRUsK/8ACPkhAANAaBwAAAAJAZ8tRCf/AAspIQADQGgcIQADQGgcAAAACQGfL0Qn/wALKCEAA0BoHAAAAA1BmzQ0TEM//qmWAAy4IQADQGgcAAAAC0GfUkUVLCv/AAj5IQADQGgcIQADQGgcAAAACQGfcUQn/wALKCEAA0BoHAAAAAkBn3NEJ/8ACyghAANAaBwhAANAaBwAAAANQZt4NExC//6plgAMuSEAA0BoHAAAAAtBn5ZFFSwr/wAI+CEAA0BoHCEAA0BoHAAAAAkBn7VEJ/8ACykhAANAaBwAAAAJAZ+3RCf/AAspIQADQGgcAAAADUGbuzRMQn/+nhAAYsAhAANAaBwhAANAaBwAAAAJQZ/aQhP/AAspIQADQGgcAAAACQGf+UQn/wALKCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHCEAA0BoHAAACiFtb292AAAAbG12aGQAAAAA1YCCX9WAgl8AAAPoAAAH/AABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAGGlvZHMAAAAAEICAgAcAT////v7/AAAF+XRyYWsAAABcdGtoZAAAAAPVgIJf1YCCXwAAAAEAAAAAAAAH0AAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAygAAAMoAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAB9AAABdwAAEAAAAABXFtZGlhAAAAIG1kaGQAAAAA1YCCX9WAgl8AAV+QAAK/IFXEAAAAAAAtaGRscgAAAAAAAAAAdmlkZQAAAAAAAAAAAAAAAFZpZGVvSGFuZGxlcgAAAAUcbWluZgAAABR2bWhkAAAAAQAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAAE3HN0YmwAAACYc3RzZAAAAAAAAAABAAAAiGF2YzEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAygDKAEgAAABIAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAY//8AAAAyYXZjQwFNQCj/4QAbZ01AKOyho3ySTUBAQFAAAAMAEAAr8gDxgxlgAQAEaO+G8gAAABhzdHRzAAAAAAAAAAEAAAA8AAALuAAAABRzdHNzAAAAAAAAAAEAAAABAAAB8GN0dHMAAAAAAAAAPAAAAAEAABdwAAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAADqYAAAAAQAAF3AAAAABAAAAAAAAAAEAAAu4AAAAAQAAOpgAAAABAAAXcAAAAAEAAAAAAAAAAQAAC7gAAAABAAA6mAAAAAEAABdwAAAAAQAAAAAAAAABAAALuAAAAAEAAC7gAAAAAQAAF3AAAAABAAAAAAAAABxzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAEEc3RzegAAAAAAAAAAAAAAPAAAAzQAAAAQAAAADQAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAAPAAAADQAAAA0AAAARAAAADwAAAA0AAAANAAAAEQAAAA8AAAANAAAADQAAABEAAAANAAAADQAAAQBzdGNvAAAAAAAAADwAAAAwAAADZAAAA3QAAAONAAADoAAAA7kAAAPQAAAD6wAAA/4AAAQXAAAELgAABEMAAARcAAAEbwAABIwAAAShAAAEugAABM0AAATkAAAE/wAABRIAAAUrAAAFQgAABV0AAAVwAAAFiQAABaAAAAW1AAAFzgAABeEAAAX+AAAGEwAABiwAAAY/AAAGVgAABnEAAAaEAAAGnQAABrQAAAbPAAAG4gAABvUAAAcSAAAHJwAAB0AAAAdTAAAHcAAAB4UAAAeeAAAHsQAAB8gAAAfjAAAH9gAACA8AAAgmAAAIQQAACFQAAAhnAAAIhAAACJcAAAMsdHJhawAAAFx0a2hkAAAAA9WAgl/VgIJfAAAAAgAAAAAAAAf8AAAAAAAAAAAAAAABAQAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAACsm1kaWEAAAAgbWRoZAAAAADVgIJf1YCCXwAArEQAAWAAVcQAAAAAACdoZGxyAAAAAAAAAABzb3VuAAAAAAAAAAAAAAAAU3RlcmVvAAAAAmNtaW5mAAAAEHNtaGQAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAidzdGJsAAAAZ3N0c2QAAAAAAAAAAQAAAFdtcDRhAAAAAAAAAAEAAAAAAAAAAAACABAAAAAArEQAAAAAADNlc2RzAAAAAAOAgIAiAAIABICAgBRAFQAAAAADDUAAAAAABYCAgAISEAaAgIABAgAAABhzdHRzAAAAAAAAAAEAAABYAAAEAAAAABxzdHNjAAAAAAAAAAEAAAABAAAAAQAAAAEAAAAUc3RzegAAAAAAAAAGAAAAWAAAAXBzdGNvAAAAAAAAAFgAAAOBAAADhwAAA5oAAAOtAAADswAAA8oAAAPfAAAD5QAAA/gAAAQLAAAEEQAABCgAAAQ9AAAEUAAABFYAAARpAAAEgAAABIYAAASbAAAErgAABLQAAATHAAAE3gAABPMAAAT5AAAFDAAABR8AAAUlAAAFPAAABVEAAAVXAAAFagAABX0AAAWDAAAFmgAABa8AAAXCAAAFyAAABdsAAAXyAAAF+AAABg0AAAYgAAAGJgAABjkAAAZQAAAGZQAABmsAAAZ+AAAGkQAABpcAAAauAAAGwwAABskAAAbcAAAG7wAABwYAAAcMAAAHIQAABzQAAAc6AAAHTQAAB2QAAAdqAAAHfwAAB5IAAAeYAAAHqwAAB8IAAAfXAAAH3QAAB/AAAAgDAAAICQAACCAAAAg1AAAIOwAACE4AAAhhAAAIeAAACH4AAAiRAAAIpAAACKoAAAiwAAAItgAACLwAAAjCAAAAFnVkdGEAAAAObmFtZVN0ZXJlbwAAAHB1ZHRhAAAAaG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAO2lsc3QAAAAzqXRvbwAAACtkYXRhAAAAAQAAAABIYW5kQnJha2UgMC4xMC4yIDIwMTUwNjExMDA="}])})}),aS=sS(oS),lS=1e3,cS=[0,0,.5,1],hS=[.5,0,.5,1],dS=window.requestAnimationFrame,uS=window.cancelAnimationFrame;function fS(){this.leftProjectionMatrix=new Float32Array(16),this.leftViewMatrix=new Float32Array(16),this.rightProjectionMatrix=new Float32Array(16),this.rightViewMatrix=new Float32Array(16),this.pose=null}function Bg(v){Object.defineProperties(this,{hasPosition:{writable:!1,enumerable:!0,value:v.hasPosition},hasExternalDisplay:{writable:!1,enumerable:!0,value:v.hasExternalDisplay},canPresent:{writable:!1,enumerable:!0,value:v.canPresent},maxLayers:{writable:!1,enumerable:!0,value:v.maxLayers},hasOrientation:{enumerable:!0,get:function(){return Hr("VRDisplayCapabilities.prototype.hasOrientation","VRDisplay.prototype.getFrameData"),v.hasOrientation}}})}function ni(v){v=v||{};var x="wakelock"in v?v.wakelock:!0;this.isPolyfilled=!0,this.displayId=lS++,this.displayName="",this.depthNear=.01,this.depthFar=1e4,this.isPresenting=!1,Object.defineProperty(this,"isConnected",{get:function(){return Hr("VRDisplay.prototype.isConnected","VRDisplayCapabilities.prototype.hasExternalDisplay"),!1}}),this.capabilities=new Bg({hasPosition:!1,hasOrientation:!1,hasExternalDisplay:!1,canPresent:!1,maxLayers:1}),this.stageParameters=null,this.waitingForPresent_=!1,this.layer_=null,this.originalParent_=null,this.fullscreenElement_=null,this.fullscreenWrapper_=null,this.fullscreenElementCachedStyle_=null,this.fullscreenEventTarget_=null,this.fullscreenChangeHandler_=null,this.fullscreenErrorHandler_=null,x&&Gs()&&(this.wakelock_=new aS)}ni.prototype.getFrameData=function(v){return yi(v,this._getPose(),this)},ni.prototype.getPose=function(){return Hr("VRDisplay.prototype.getPose","VRDisplay.prototype.getFrameData"),this._getPose()},ni.prototype.resetPose=function(){return Hr("VRDisplay.prototype.resetPose"),this._resetPose()},ni.prototype.getImmediatePose=function(){return Hr("VRDisplay.prototype.getImmediatePose","VRDisplay.prototype.getFrameData"),this._getPose()},ni.prototype.requestAnimationFrame=function(v){return dS(v)},ni.prototype.cancelAnimationFrame=function(v){return uS(v)},ni.prototype.wrapForFullscreen=function(v){if(be())return v;if(!this.fullscreenWrapper_){this.fullscreenWrapper_=document.createElement("div");var x=["height: "+Math.min(screen.height,screen.width)+"px !important","top: 0 !important","left: 0 !important","right: 0 !important","border: 0","margin: 0","padding: 0","z-index: 999999 !important","position: fixed"];this.fullscreenWrapper_.setAttribute("style",x.join("; ")+";"),this.fullscreenWrapper_.classList.add("webvr-polyfill-fullscreen-wrapper")}if(this.fullscreenElement_==v)return this.fullscreenWrapper_;if(this.fullscreenElement_&&(this.originalParent_?this.originalParent_.appendChild(this.fullscreenElement_):this.fullscreenElement_.parentElement.removeChild(this.fullscreenElement_)),this.fullscreenElement_=v,this.originalParent_=v.parentElement,this.originalParent_||document.body.appendChild(v),!this.fullscreenWrapper_.parentElement){var w=this.fullscreenElement_.parentElement;w.insertBefore(this.fullscreenWrapper_,this.fullscreenElement_),w.removeChild(this.fullscreenElement_)}this.fullscreenWrapper_.insertBefore(this.fullscreenElement_,this.fullscreenWrapper_.firstChild),this.fullscreenElementCachedStyle_=this.fullscreenElement_.getAttribute("style");var P=this;function L(){if(P.fullscreenElement_){var W=["position: absolute","top: 0","left: 0","width: "+Math.max(screen.width,screen.height)+"px","height: "+Math.min(screen.height,screen.width)+"px","border: 0","margin: 0","padding: 0"];P.fullscreenElement_.setAttribute("style",W.join("; ")+";")}}return L(),this.fullscreenWrapper_},ni.prototype.removeFullscreenWrapper=function(){if(this.fullscreenElement_){var v=this.fullscreenElement_;this.fullscreenElementCachedStyle_?v.setAttribute("style",this.fullscreenElementCachedStyle_):v.removeAttribute("style"),this.fullscreenElement_=null,this.fullscreenElementCachedStyle_=null;var x=this.fullscreenWrapper_.parentElement;return this.fullscreenWrapper_.removeChild(v),this.originalParent_===x?x.insertBefore(v,this.fullscreenWrapper_):this.originalParent_&&this.originalParent_.appendChild(v),x.removeChild(this.fullscreenWrapper_),v}},ni.prototype.requestPresent=function(v){var x=this.isPresenting,w=this;return v instanceof Array||(Hr("VRDisplay.prototype.requestPresent with non-array argument","an array of VRLayers as the first argument"),v=[v]),new Promise(function(P,L){if(!w.capabilities.canPresent){L(new Error("VRDisplay is not capable of presenting."));return}if(v.length==0||v.length>w.capabilities.maxLayers){L(new Error("Invalid number of layers."));return}var W=v[0];if(!W.source){P();return}var Y=W.leftBounds||cS,fe=W.rightBounds||hS;if(x){var pe=w.layer_;pe.source!==W.source&&(pe.source=W.source);for(var $=0;$<4;$++)pe.leftBounds[$]=Y[$],pe.rightBounds[$]=fe[$];w.wrapForFullscreen(w.layer_.source),w.updatePresent_(),P();return}if(w.layer_={predistorted:W.predistorted,source:W.source,leftBounds:Y.slice(0),rightBounds:fe.slice(0)},w.waitingForPresent_=!1,w.layer_&&w.layer_.source){var se=w.wrapForFullscreen(w.layer_.source),Te=function(){var ht=os();w.isPresenting=se===ht,w.isPresenting?(screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape-primary").catch(function(Et){console.error("screen.orientation.lock() failed due to",Et.message)}),w.waitingForPresent_=!1,w.beginPresent_(),P()):(screen.orientation&&screen.orientation.unlock&&screen.orientation.unlock(),w.removeFullscreenWrapper(),w.disableWakeLock(),w.endPresent_(),w.removeFullscreenListeners_()),w.fireVRDisplayPresentChange_()},$e=function(){w.waitingForPresent_&&(w.removeFullscreenWrapper(),w.removeFullscreenListeners_(),w.disableWakeLock(),w.waitingForPresent_=!1,w.isPresenting=!1,L(new Error("Unable to present.")))};w.addFullscreenListeners_(se,Te,$e),It(se)?(w.enableWakeLock(),w.waitingForPresent_=!0):(be()||Ke())&&(w.enableWakeLock(),w.isPresenting=!0,w.beginPresent_(),w.fireVRDisplayPresentChange_(),P())}!w.waitingForPresent_&&!be()&&(yt(),L(new Error("Unable to present.")))})},ni.prototype.exitPresent=function(){var v=this.isPresenting,x=this;return this.isPresenting=!1,this.layer_=null,this.disableWakeLock(),new Promise(function(w,P){v?(!yt()&&be()&&(x.endPresent_(),x.fireVRDisplayPresentChange_()),Ke()&&(x.removeFullscreenWrapper(),x.removeFullscreenListeners_(),x.endPresent_(),x.fireVRDisplayPresentChange_()),w()):P(new Error("Was not presenting to VRDisplay."))})},ni.prototype.getLayers=function(){return this.layer_?[this.layer_]:[]},ni.prototype.fireVRDisplayPresentChange_=function(){var v=new CustomEvent("vrdisplaypresentchange",{detail:{display:this}});window.dispatchEvent(v)},ni.prototype.fireVRDisplayConnect_=function(){var v=new CustomEvent("vrdisplayconnect",{detail:{display:this}});window.dispatchEvent(v)},ni.prototype.addFullscreenListeners_=function(v,x,w){this.removeFullscreenListeners_(),this.fullscreenEventTarget_=v,this.fullscreenChangeHandler_=x,this.fullscreenErrorHandler_=w,x&&(document.fullscreenEnabled?v.addEventListener("fullscreenchange",x,!1):document.webkitFullscreenEnabled?v.addEventListener("webkitfullscreenchange",x,!1):document.mozFullScreenEnabled?document.addEventListener("mozfullscreenchange",x,!1):document.msFullscreenEnabled&&v.addEventListener("msfullscreenchange",x,!1)),w&&(document.fullscreenEnabled?v.addEventListener("fullscreenerror",w,!1):document.webkitFullscreenEnabled?v.addEventListener("webkitfullscreenerror",w,!1):document.mozFullScreenEnabled?document.addEventListener("mozfullscreenerror",w,!1):document.msFullscreenEnabled&&v.addEventListener("msfullscreenerror",w,!1))},ni.prototype.removeFullscreenListeners_=function(){if(this.fullscreenEventTarget_){var v=this.fullscreenEventTarget_;if(this.fullscreenChangeHandler_){var x=this.fullscreenChangeHandler_;v.removeEventListener("fullscreenchange",x,!1),v.removeEventListener("webkitfullscreenchange",x,!1),document.removeEventListener("mozfullscreenchange",x,!1),v.removeEventListener("msfullscreenchange",x,!1)}if(this.fullscreenErrorHandler_){var w=this.fullscreenErrorHandler_;v.removeEventListener("fullscreenerror",w,!1),v.removeEventListener("webkitfullscreenerror",w,!1),document.removeEventListener("mozfullscreenerror",w,!1),v.removeEventListener("msfullscreenerror",w,!1)}this.fullscreenEventTarget_=null,this.fullscreenChangeHandler_=null,this.fullscreenErrorHandler_=null}},ni.prototype.enableWakeLock=function(){this.wakelock_&&this.wakelock_.enable()},ni.prototype.disableWakeLock=function(){this.wakelock_&&this.wakelock_.disable()},ni.prototype.beginPresent_=function(){},ni.prototype.endPresent_=function(){},ni.prototype.submitFrame=function(v){},ni.prototype.getEyeParameters=function(v){return null};var pS={ADDITIONAL_VIEWERS:[],DEFAULT_VIEWER:"",MOBILE_WAKE_LOCK:!0,DEBUG:!1,DPDB_URL:"https://dpdb.webvr.rocks/dpdb.json",K_FILTER:.98,PREDICTION_TIME_S:.04,CARDBOARD_UI_DISABLED:!1,ROTATE_INSTRUCTIONS_DISABLED:!1,YAW_ONLY:!1,BUFFER_SCALE:.5,DIRTY_SUBMIT_FRAME_BINDINGS:!1},Tc={LEFT:"left",RIGHT:"right"};function Ti(v){var x=dr({},pS);v=dr(x,v||{}),ni.call(this,{wakelock:v.MOBILE_WAKE_LOCK}),this.config=v,this.displayName="Cardboard VRDisplay",this.capabilities=new Bg({hasPosition:!1,hasOrientation:!0,hasExternalDisplay:!1,canPresent:!0,maxLayers:1}),this.stageParameters=null,this.bufferScale_=this.config.BUFFER_SCALE,this.poseSensor_=new Jw(this.config),this.distorter_=null,this.cardboardUI_=null,this.dpdb_=new Ua(this.config.DPDB_URL,this.onDeviceParamsUpdated_.bind(this)),this.deviceInfo_=new Si(this.dpdb_.getDeviceParams(),v.ADDITIONAL_VIEWERS),this.viewerSelector_=new Nn(v.DEFAULT_VIEWER),this.viewerSelector_.onChange(this.onViewerChanged_.bind(this)),this.deviceInfo_.setViewer(this.viewerSelector_.getCurrentViewer()),this.config.ROTATE_INSTRUCTIONS_DISABLED||(this.rotateInstructions_=new qr),be()&&window.addEventListener("resize",this.onResize_.bind(this))}return Ti.prototype=Object.create(ni.prototype),Ti.prototype._getPose=function(){return{position:null,orientation:this.poseSensor_.getOrientation(),linearVelocity:null,linearAcceleration:null,angularVelocity:null,angularAcceleration:null}},Ti.prototype._resetPose=function(){this.poseSensor_.resetPose&&this.poseSensor_.resetPose()},Ti.prototype._getFieldOfView=function(v){var x;if(v==Tc.LEFT)x=this.deviceInfo_.getFieldOfViewLeftEye();else if(v==Tc.RIGHT)x=this.deviceInfo_.getFieldOfViewRightEye();else return console.error("Invalid eye provided: %s",v),null;return x},Ti.prototype._getEyeOffset=function(v){var x;if(v==Tc.LEFT)x=[-this.deviceInfo_.viewer.interLensDistance*.5,0,0];else if(v==Tc.RIGHT)x=[this.deviceInfo_.viewer.interLensDistance*.5,0,0];else return console.error("Invalid eye provided: %s",v),null;return x},Ti.prototype.getEyeParameters=function(v){var x=this._getEyeOffset(v),w=this._getFieldOfView(v),P={offset:x,renderWidth:this.deviceInfo_.device.width*.5*this.bufferScale_,renderHeight:this.deviceInfo_.device.height*this.bufferScale_};return Object.defineProperty(P,"fieldOfView",{enumerable:!0,get:function(){return Hr("VRFieldOfView","VRFrameData's projection matrices"),w}}),P},Ti.prototype.onDeviceParamsUpdated_=function(v){this.config.DEBUG&&console.log("DPDB reported that device params were updated."),this.deviceInfo_.updateDeviceParams(v),this.distorter_&&this.distorter_.updateDeviceInfo(this.deviceInfo_)},Ti.prototype.updateBounds_=function(){this.layer_&&this.distorter_&&(this.layer_.leftBounds||this.layer_.rightBounds)&&this.distorter_.setTextureBounds(this.layer_.leftBounds,this.layer_.rightBounds)},Ti.prototype.beginPresent_=function(){var v=this.layer_.source.getContext("webgl");v||(v=this.layer_.source.getContext("experimental-webgl")),v||(v=this.layer_.source.getContext("webgl2")),v&&(this.layer_.predistorted?this.config.CARDBOARD_UI_DISABLED||(v.canvas.width=At()*this.bufferScale_,v.canvas.height=Pt()*this.bufferScale_,this.cardboardUI_=new jr(v)):(this.config.CARDBOARD_UI_DISABLED||(this.cardboardUI_=new jr(v)),this.distorter_=new as(v,this.cardboardUI_,this.config.BUFFER_SCALE,this.config.DIRTY_SUBMIT_FRAME_BINDINGS),this.distorter_.updateDeviceInfo(this.deviceInfo_)),this.cardboardUI_&&this.cardboardUI_.listen(function(x){this.viewerSelector_.show(this.layer_.source.parentElement),x.stopPropagation(),x.preventDefault()}.bind(this),function(x){this.exitPresent(),x.stopPropagation(),x.preventDefault()}.bind(this)),this.rotateInstructions_&&(ui()&&Gs()?this.rotateInstructions_.showTemporarily(3e3,this.layer_.source.parentElement):this.rotateInstructions_.update()),this.orientationHandler=this.onOrientationChange_.bind(this),window.addEventListener("orientationchange",this.orientationHandler),this.vrdisplaypresentchangeHandler=this.updateBounds_.bind(this),window.addEventListener("vrdisplaypresentchange",this.vrdisplaypresentchangeHandler),this.fireVRDisplayDeviceParamsChange_())},Ti.prototype.endPresent_=function(){this.distorter_&&(this.distorter_.destroy(),this.distorter_=null),this.cardboardUI_&&(this.cardboardUI_.destroy(),this.cardboardUI_=null),this.rotateInstructions_&&this.rotateInstructions_.hide(),this.viewerSelector_.hide(),window.removeEventListener("orientationchange",this.orientationHandler),window.removeEventListener("vrdisplaypresentchange",this.vrdisplaypresentchangeHandler)},Ti.prototype.updatePresent_=function(){this.endPresent_(),this.beginPresent_()},Ti.prototype.submitFrame=function(v){if(this.distorter_)this.updateBounds_(),this.distorter_.submitFrame();else if(this.cardboardUI_&&this.layer_){var x=this.layer_.source.getContext("webgl");x||(x=this.layer_.source.getContext("experimental-webgl")),x||(x=this.layer_.source.getContext("webgl2"));var w=x.canvas;(w.width!=this.lastWidth||w.height!=this.lastHeight)&&this.cardboardUI_.onResize(),this.lastWidth=w.width,this.lastHeight=w.height,this.cardboardUI_.render()}},Ti.prototype.onOrientationChange_=function(v){this.viewerSelector_.hide(),this.rotateInstructions_&&this.rotateInstructions_.update(),this.onResize_()},Ti.prototype.onResize_=function(v){if(this.layer_){var x=this.layer_.source.getContext("webgl");x||(x=this.layer_.source.getContext("experimental-webgl")),x||(x=this.layer_.source.getContext("webgl2"));var w=["position: absolute","top: 0","left: 0","width: 100vw","height: 100vh","border: 0","margin: 0","padding: 0px","box-sizing: content-box"];x.canvas.setAttribute("style",w.join("; ")+";"),Hs(x.canvas)}},Ti.prototype.onViewerChanged_=function(v){this.deviceInfo_.setViewer(v),this.distorter_&&this.distorter_.updateDeviceInfo(this.deviceInfo_),this.fireVRDisplayDeviceParamsChange_()},Ti.prototype.fireVRDisplayDeviceParamsChange_=function(){var v=new CustomEvent("vrdisplaydeviceparamschange",{detail:{vrdisplay:this,deviceInfo:this.deviceInfo_}});window.dispatchEvent(v)},Ti.VRFrameData=fS,Ti.VRDisplay=ni,Ti})}),sw=tw(nw);class vg extends t{constructor(g){super(),this.global=g,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}onBaseLayerSet(g,S){throw new Error("Not implemented")}isSessionSupported(g){throw new Error("Not implemented")}isFeatureSupported(g){throw new Error("Not implemented")}requestSession(g,S){return ei(this,null,function*(){throw new Error("Not implemented")})}requestAnimationFrame(g){throw new Error("Not implemented")}onFrameStart(g){throw new Error("Not implemented")}onFrameEnd(g){throw new Error("Not implemented")}doesSessionSupportReferenceSpace(g,S){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}requestFrameOfReferenceTransform(g,S){return ei(this,null,function*(){})}cancelAnimationFrame(g){throw new Error("Not implemented")}endSession(g){throw new Error("Not implemented")}getViewport(g,S,I,H){throw new Error("Not implemented")}getProjectionMatrix(g){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(g){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(g,S,I){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let rw={mapping:"",profiles:["google-daydream","generic-trigger-touchpad"],buttons:{length:3,0:null,1:null,2:0}},ow={mapping:"xr-standard",profiles:["htc-vive-focus","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0}},aw={mapping:"xr-standard",profiles:["oculus-go","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[Math.PI*.11,0,0,1]}},bg={mapping:"xr-standard",displayProfiles:{"Oculus Quest":["oculus-touch-v2","oculus-touch","generic-trigger-squeeze-thumbstick"]},profiles:["oculus-touch","generic-trigger-squeeze-thumbstick"],axes:{length:4,0:null,1:null,2:0,3:1},buttons:{length:7,0:1,1:2,2:null,3:0,4:3,5:4,6:null},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},lw={mapping:"xr-standard",profiles:["htc-vive","generic-trigger-squeeze-touchpad"],displayProfiles:{"HTC Vive":["htc-vive","generic-trigger-squeeze-touchpad"],"HTC Vive DVT":["htc-vive","generic-trigger-squeeze-touchpad"],"Valve Index":["valve-index","generic-trigger-squeeze-touchpad-thumbstick"]},buttons:{length:3,0:1,1:2,2:0},gripTransform:{position:[0,0,.05,1]},targetRayTransform:{orientation:[Math.PI*-.08,0,0,1]},userAgentOverrides:{Firefox:{axes:{invert:[1,3]}}}},cw={mapping:"xr-standard",profiles:["samsung-gearvr","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[Math.PI*.11,0,0,1]}},hw={mapping:"xr-standard",profiles:["samsung-odyssey","microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},Yd={mapping:"xr-standard",profiles:["microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[Math.PI*.11,0,0,1]}},dw={"Daydream Controller":rw,"Gear VR Controller":cw,"HTC Vive Focus Controller":ow,"Oculus Go Controller":aw,"Oculus Touch (Right)":bg,"Oculus Touch (Left)":bg,"OpenVR Gamepad":lw,"Spatial Controller (Spatial Interaction Source) 045E-065A":Yd,"Spatial Controller (Spatial Interaction Source) 045E-065D":hw,"Windows Mixed Reality (Right)":Yd,"Windows Mixed Reality (Left)":Yd};const yg=A(.155,-.465,-.15),uw=A(-.155,-.465,-.15),fw=A(0,0,-.25),pw=A(0,0,.05),xg=A(-.08,.14,.08),Ag=.4,mw=.4,gw=.61,_w=.175,vw=.12,bw=.87,Eg=180/Math.PI;function yw(E,g,S){function I(Pe,be,Ke){return Pe<be?be:Pe>Ke?Ke:Pe}var H=g[0]*g[0],Z=g[1]*g[1],ee=g[2]*g[2],oe=g[3]*g[3];if(S==="XYZ")E[0]=Math.atan2(2*(g[0]*g[3]-g[1]*g[2]),oe-H-Z+ee),E[1]=Math.asin(I(2*(g[0]*g[2]+g[1]*g[3]),-1,1)),E[2]=Math.atan2(2*(g[2]*g[3]-g[0]*g[1]),oe+H-Z-ee);else if(S==="YXZ")E[0]=Math.asin(I(2*(g[0]*g[3]-g[1]*g[2]),-1,1)),E[1]=Math.atan2(2*(g[0]*g[2]+g[1]*g[3]),oe-H-Z+ee),E[2]=Math.atan2(2*(g[0]*g[1]+g[2]*g[3]),oe-H+Z-ee);else if(S==="ZXY")E[0]=Math.asin(I(2*(g[0]*g[3]+g[1]*g[2]),-1,1)),E[1]=Math.atan2(2*(g[1]*g[3]-g[2]*g[0]),oe-H-Z+ee),E[2]=Math.atan2(2*(g[2]*g[3]-g[0]*g[1]),oe-H+Z-ee);else if(S==="ZYX")E[0]=Math.atan2(2*(g[0]*g[3]+g[2]*g[1]),oe-H-Z+ee),E[1]=Math.asin(I(2*(g[1]*g[3]-g[0]*g[2]),-1,1)),E[2]=Math.atan2(2*(g[0]*g[1]+g[2]*g[3]),oe+H-Z-ee);else if(S==="YZX")E[0]=Math.atan2(2*(g[0]*g[3]-g[2]*g[1]),oe-H+Z-ee),E[1]=Math.atan2(2*(g[1]*g[3]-g[0]*g[2]),oe+H-Z-ee),E[2]=Math.asin(I(2*(g[0]*g[1]+g[2]*g[3]),-1,1));else if(S==="XZY")E[0]=Math.atan2(2*(g[0]*g[3]+g[1]*g[2]),oe-H+Z-ee),E[1]=Math.atan2(2*(g[0]*g[2]+g[1]*g[3]),oe+H-Z-ee),E[2]=Math.asin(I(2*(g[2]*g[3]-g[0]*g[1]),-1,1));else{console.log("No order given for quaternion to euler conversion.");return}}class xw{constructor(){this.hand="right",this.headElbowOffset=yg,this.controllerQ=te(),this.lastControllerQ=te(),this.headQ=te(),this.headPos=b(),this.elbowPos=b(),this.wristPos=b(),this.time=null,this.lastTime=null,this.rootQ=te(),this.position=b()}setHandedness(g){this.hand!=g&&(this.hand=g,this.hand=="left"?this.headElbowOffset=uw:this.headElbowOffset=yg)}update(g,S){this.time=gt(),g&&(X(this.lastControllerQ,this.controllerQ),X(this.controllerQ,g)),S&&(f(this.headPos,S),p(this.headQ,S));let I=this.getHeadYawOrientation_(),H=this.quatAngle_(this.lastControllerQ,this.controllerQ),Z=(this.time-this.lastTime)/1e3;H/Z>gw?we(this.rootQ,this.rootQ,I,Math.min(H/_w,1)):X(this.rootQ,I);let oe=A(0,0,-1);j(oe,oe,this.controllerQ);let Pe=O(oe,[0,1,0]),be=this.clamp_((Pe-vw)/bw,0,1),Ke=z(this.rootQ);at(Ke,Ke),Fe(Ke,Ke,this.controllerQ);let lt=this.elbowPos;T(lt,this.headPos),M(lt,lt,this.headElbowOffset);let Ot=_(xg);C(Ot,Ot,be),M(lt,lt,Ot);let $t=this.quatAngle_(Ke,te())*Eg,Ht=1-Math.pow($t/180,4),Bt=Ag,ui=1-Ag,Ui=Ht*(Bt+ui*be*mw),At=te();we(At,At,Ke,Ui);let Pt=at(te(),At),It=z(Ke);Fe(It,It,Pt);let yt=this.wristPos;T(yt,pw),j(yt,yt,At),M(yt,yt,fw),j(yt,yt,It),M(yt,yt,lt);let os=_(xg);C(os,os,be),M(this.position,this.wristPos,os),j(this.position,this.position,this.rootQ),this.lastTime=this.time}getPosition(){return this.position}getHeadYawOrientation_(){let g=b();return yw(g,this.headQ,"YXZ"),U(te(),0,g[1]*Eg,0)}clamp_(g,S,I){return Math.min(Math.max(g,S),I)}quatAngle_(g,S){let I=[0,0,-1],H=[0,0,-1];return j(I,I,g),j(H,H,S),K(I,H)}}const en=Symbol("@@webxr-polyfill/XRRemappedGamepad"),wg={pressed:!1,touched:!1,value:0};Object.freeze(wg);class Aw{constructor(g,S,I){if(I||(I={}),I.userAgentOverrides){for(let be in I.userAgentOverrides)if(navigator.userAgent.includes(be)){let Ke=I.userAgentOverrides[be];for(let lt in Ke)lt in I?Object.assign(I[lt],Ke[lt]):I[lt]=Ke[lt];break}}let H=new Array(I.axes&&I.axes.length?I.axes.length:g.axes.length),Z=new Array(I.buttons&&I.buttons.length?I.buttons.length:g.buttons.length),ee=null;if(I.gripTransform){let be=I.gripTransform.orientation||[0,0,0,1];ee=o(),h(ee,_e(be,be),I.gripTransform.position||[0,0,0])}let oe=null;if(I.targetRayTransform){let be=I.targetRayTransform.orientation||[0,0,0,1];oe=o(),h(oe,_e(be,be),I.targetRayTransform.position||[0,0,0])}let Pe=I.profiles;I.displayProfiles&&S.displayName in I.displayProfiles&&(Pe=I.displayProfiles[S.displayName]),this[en]={gamepad:g,map:I,profiles:Pe||[g.id],mapping:I.mapping||g.mapping,axes:H,buttons:Z,gripTransform:ee,targetRayTransform:oe},this._update()}_update(){let g=this[en].gamepad,S=this[en].map,I=this[en].axes;for(let Z=0;Z<I.length;++Z)S.axes&&Z in S.axes?S.axes[Z]===null?I[Z]=0:I[Z]=g.axes[S.axes[Z]]:I[Z]=g.axes[Z];if(S.axes&&S.axes.invert)for(let Z of S.axes.invert)Z<I.length&&(I[Z]*=-1);let H=this[en].buttons;for(let Z=0;Z<H.length;++Z)S.buttons&&Z in S.buttons?S.buttons[Z]===null?H[Z]=wg:H[Z]=g.buttons[S.buttons[Z]]:H[Z]=g.buttons[Z]}get id(){return""}get _profiles(){return this[en].profiles}get index(){return-1}get connected(){return this[en].gamepad.connected}get timestamp(){return this[en].gamepad.timestamp}get mapping(){return this[en].mapping}get axes(){return this[en].axes}get buttons(){return this[en].buttons}get hapticActuators(){return this[en].gamepad.hapticActuators}}class Ew{constructor(g,S,I=0,H=-1){this.polyfill=g,this.display=S,this.nativeGamepad=null,this.gamepad=null,this.inputSource=new pg(this),this.lastPosition=b(),this.emulatedPosition=!1,this.basePoseMatrix=o(),this.outputMatrix=o(),this.primaryButtonIndex=I,this.primaryActionPressed=!1,this.primarySqueezeButtonIndex=H,this.primarySqueezeActionPressed=!1,this.handedness="",this.targetRayMode="gaze",this.armModel=null}get profiles(){return this.gamepad?this.gamepad._profiles:[]}updateFromGamepad(g){this.nativeGamepad!==g&&(this.nativeGamepad=g,g?this.gamepad=new Aw(g,this.display,dw[g.id]):this.gamepad=null),this.handedness=g.hand===""?"none":g.hand,this.gamepad&&this.gamepad._update(),g.pose?(this.targetRayMode="tracked-pointer",this.emulatedPosition=!g.pose.hasPosition):g.hand===""&&(this.targetRayMode="gaze",this.emulatedPosition=!1)}updateBasePoseMatrix(){if(this.nativeGamepad&&this.nativeGamepad.pose){let g=this.nativeGamepad.pose,S=g.position,I=g.orientation;if(!S&&!I)return;S?(this.lastPosition[0]=S[0],this.lastPosition[1]=S[1],this.lastPosition[2]=S[2]):g.hasPosition?S=this.lastPosition:(this.armModel||(this.armModel=new xw),this.armModel.setHandedness(this.nativeGamepad.hand),this.armModel.update(I,this.polyfill.getBasePoseMatrix()),S=this.armModel.getPosition()),h(this.basePoseMatrix,I,S)}else l(this.basePoseMatrix,this.polyfill.getBasePoseMatrix());return this.basePoseMatrix}getXRPose(g,S){switch(this.updateBasePoseMatrix(),S){case"target-ray":g._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[en].targetRayTransform&&u(this.outputMatrix,this.outputMatrix,this.gamepad[en].targetRayTransform);break;case"grip":if(!this.nativeGamepad||!this.nativeGamepad.pose)return null;g._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[en].gripTransform&&u(this.outputMatrix,this.outputMatrix,this.gamepad[en].gripTransform);break;default:return null}return g._adjustForOriginOffset(this.outputMatrix),new XRPose(new XRRigidTransform(this.outputMatrix),this.emulatedPosition)}}const Na=!1,Sg={highRefreshRate:!0},Tg={oculus:1,openvr:1,"spatial controller (spatial interaction source)":1};let ww=0;class Sw{constructor(g,S,I={}){if(this.mode=g,this.enabledFeatures=S,this.outputContext=null,this.immersive=g=="immersive-vr"||g=="immersive-ar",this.ended=null,this.baseLayer=null,this.id=++ww,this.modifiedCanvasLayer=!1,this.outputContext&&!Na){const H=I.renderContextType||"2d";this.renderContext=this.outputContext.canvas.getContext(H)}}}class Mg extends vg{constructor(g,S){const{canPresent:I}=S.capabilities;super(g),this.display=S,this.frame=new g.VRFrameData,this.sessions=new Map,this.immersiveSession=null,this.canPresent=I,this.baseModelMatrix=o(),this.gamepadInputSources={},this.tempVec3=new Float32Array(3),this.onVRDisplayPresentChange=this.onVRDisplayPresentChange.bind(this),g.window.addEventListener("vrdisplaypresentchange",this.onVRDisplayPresentChange),this.CAN_USE_GAMEPAD=g.navigator&&"getGamepads"in g.navigator,this.HAS_BITMAP_SUPPORT=$E(g)}get depthNear(){return this.display.depthNear}set depthNear(g){this.display.depthNear=g}get depthFar(){return this.display.depthFar}set depthFar(g){this.display.depthFar=g}onBaseLayerSet(g,S){const I=this.sessions.get(g),H=S.context.canvas;if(I.immersive){const Z=this.display.getEyeParameters("left"),ee=this.display.getEyeParameters("right");H.width=Math.max(Z.renderWidth,ee.renderWidth)*2,H.height=Math.max(Z.renderHeight,ee.renderHeight),this.display.requestPresent([{source:H,attributes:Sg}]).then(()=>{!Na&&!this.global.document.body.contains(H)&&(I.modifiedCanvasLayer=!0,this.global.document.body.appendChild(H),ew(H)),I.baseLayer=S})}else I.baseLayer=S}isSessionSupported(g){return!(g=="immersive-ar"||g=="immersive-vr"&&this.canPresent===!1)}isFeatureSupported(g){switch(g){case"viewer":return!0;case"local":return!0;case"local-floor":return!0;case"bounded":return!1;case"unbounded":return!1;default:return!1}}requestSession(g,S){return ei(this,null,function*(){if(!this.isSessionSupported(g))return Promise.reject();let I=g=="immersive-vr";if(I){const Z=this.global.document.createElement("canvas");if(!Na){const ee=Z.getContext("webgl")}yield this.display.requestPresent([{source:Z,attributes:Sg}])}const H=new Sw(g,S,{renderContextType:this.HAS_BITMAP_SUPPORT?"bitmaprenderer":"2d"});return this.sessions.set(H.id,H),I&&(this.immersiveSession=H,this.dispatchEvent("@@webxr-polyfill/vr-present-start",H.id)),Promise.resolve(H.id)})}requestAnimationFrame(g){return this.display.requestAnimationFrame(g)}getPrimaryButtonIndex(g){let S=0,I=g.id.toLowerCase();for(let H in Tg)if(I.includes(H)){S=Tg[H];break}return Math.min(S,g.buttons.length-1)}onFrameStart(g,S){this.display.depthNear=S.depthNear,this.display.depthFar=S.depthFar,this.display.getFrameData(this.frame);const I=this.sessions.get(g);if(I.immersive&&this.CAN_USE_GAMEPAD){let H=this.gamepadInputSources;this.gamepadInputSources={};let Z=this.global.navigator.getGamepads();for(let ee=0;ee<Z.length;++ee){let oe=Z[ee];if(oe&&oe.displayId>0){let Pe=H[ee];if(Pe||(Pe=new Ew(this,this.display,this.getPrimaryButtonIndex(oe))),Pe.updateFromGamepad(oe),this.gamepadInputSources[ee]=Pe,Pe.primaryButtonIndex!=-1){let be=oe.buttons[Pe.primaryButtonIndex].pressed;be&&!Pe.primaryActionPressed?this.dispatchEvent("@@webxr-polyfill/input-select-start",{sessionId:I.id,inputSource:Pe.inputSource}):!be&&Pe.primaryActionPressed&&this.dispatchEvent("@@webxr-polyfill/input-select-end",{sessionId:I.id,inputSource:Pe.inputSource}),Pe.primaryActionPressed=be}if(Pe.primarySqueezeButtonIndex!=-1){let be=oe.buttons[Pe.primarySqueezeButtonIndex].pressed;be&&!Pe.primarySqueezeActionPressed?this.dispatchEvent("@@webxr-polyfill/input-squeeze-start",{sessionId:I.id,inputSource:Pe.inputSource}):!be&&Pe.primarySqueezeActionPressed&&this.dispatchEvent("@@webxr-polyfill/input-squeeze-end",{sessionId:I.id,inputSource:Pe.inputSource}),Pe.primarySqueezeActionPressed=be}}}}if(!Na&&!I.immersive&&I.baseLayer){const H=I.baseLayer.context.canvas;m(this.frame.leftProjectionMatrix,S.inlineVerticalFieldOfView,H.width/H.height,S.depthNear,S.depthFar)}}onFrameEnd(g){const S=this.sessions.get(g);if(!(S.ended||!S.baseLayer)){if(S.outputContext&&!(S.immersive&&!this.display.capabilities.hasExternalDisplay)){const I=S.immersive&&this.display.capabilities.hasExternalDisplay,H=S.baseLayer.context.canvas,Z=I?H.width/2:H.width,ee=H.height;if(!Na){const oe=S.outputContext.canvas,Pe=oe.width,be=oe.height,Ke=S.renderContext;this.HAS_BITMAP_SUPPORT?H.transferToImageBitmap?Ke.transferFromImageBitmap(H.transferToImageBitmap()):this.global.createImageBitmap(H,0,0,Z,ee,{resizeWidth:Pe,resizeHeight:be}).then(lt=>Ke.transferFromImageBitmap(lt)):Ke.drawImage(H,0,0,Z,ee,0,0,Pe,be)}}S.immersive&&S.baseLayer&&this.display.submitFrame()}}cancelAnimationFrame(g){this.display.cancelAnimationFrame(g)}endSession(g){return ei(this,null,function*(){const S=this.sessions.get(g);if(!S.ended){if(S.immersive)return this.display.exitPresent();S.ended=!0}})}doesSessionSupportReferenceSpace(g,S){const I=this.sessions.get(g);return I.ended?!1:I.enabledFeatures.has(S)}requestStageBounds(){if(this.display.stageParameters){const g=this.display.stageParameters.sizeX,S=this.display.stageParameters.sizeZ,I=[];return I.push(-g/2),I.push(-S/2),I.push(g/2),I.push(-S/2),I.push(g/2),I.push(S/2),I.push(-g/2),I.push(S/2),I}return null}requestFrameOfReferenceTransform(g,S){return ei(this,null,function*(){return(g==="local-floor"||g==="bounded-floor")&&this.display.stageParameters&&this.display.stageParameters.sittingToStandingTransform?this.display.stageParameters.sittingToStandingTransform:null})}getProjectionMatrix(g){if(g==="left")return this.frame.leftProjectionMatrix;if(g==="right")return this.frame.rightProjectionMatrix;if(g==="none")return this.frame.leftProjectionMatrix;throw new Error("eye must be of type 'left' or 'right'")}getViewport(g,S,I,H){const Z=this.sessions.get(g),{width:ee,height:oe}=I.context.canvas;if(!Z.immersive)return H.x=H.y=0,H.width=ee,H.height=oe,!0;if(S==="left"||S==="none")H.x=0;else if(S==="right")H.x=ee/2;else return!1;return H.y=0,H.width=ee/2,H.height=oe,!0}getBasePoseMatrix(){let{position:g,orientation:S}=this.frame.pose;return!g&&!S?this.baseModelMatrix:(g||(g=this.tempVec3,g[0]=g[1]=g[2]=0),h(this.baseModelMatrix,S,g),this.baseModelMatrix)}getBaseViewMatrix(g){if(g==="left"||g==="none")return this.frame.leftViewMatrix;if(g==="right")return this.frame.rightViewMatrix;throw new Error("eye must be of type 'left' or 'right'")}getInputSources(){let g=[];for(let S in this.gamepadInputSources)g.push(this.gamepadInputSources[S].inputSource);return g}getInputPose(g,S,I){if(!S)return null;for(let H in this.gamepadInputSources){let Z=this.gamepadInputSources[H];if(Z.inputSource===g)return Z.getXRPose(S,I)}return null}onWindowResize(){}onVRDisplayPresentChange(g){this.display.isPresenting||this.sessions.forEach(S=>{if(S.immersive&&!S.ended){if(S.modifiedCanvasLayer){const I=S.baseLayer.context.canvas;document.body.removeChild(I),I.setAttribute("style","")}this.immersiveSession===S&&(this.immersiveSession=null),this.dispatchEvent("@@webxr-polyfill/vr-present-end",S.id)}})}}class Tw extends Mg{constructor(g,S){const I=new sw(S||{});super(g,I),this.display=I,this.frame={rightViewMatrix:new Float32Array(16),leftViewMatrix:new Float32Array(16),rightProjectionMatrix:new Float32Array(16),leftProjectionMatrix:new Float32Array(16),pose:null,timestamp:null}}}const Mw=!1;let Pw=0;class Cw{constructor(g,S){this.mode=g,this.enabledFeatures=S,this.ended=null,this.baseLayer=null,this.id=++Pw}}class Rw extends vg{constructor(g){super(g),this.sessions=new Map,this.projectionMatrix=o(),this.identityMatrix=o()}onBaseLayerSet(g,S){const I=this.sessions.get(g);I.baseLayer=S}isSessionSupported(g){return g=="inline"}isFeatureSupported(g){switch(g){case"viewer":return!0;default:return!1}}requestSession(g,S){return ei(this,null,function*(){if(!this.isSessionSupported(g))return Promise.reject();const I=new Cw(g,S);return this.sessions.set(I.id,I),Promise.resolve(I.id)})}requestAnimationFrame(g){return window.requestAnimationFrame(g)}cancelAnimationFrame(g){window.cancelAnimationFrame(g)}onFrameStart(g,S){if(Mw)return;const I=this.sessions.get(g);if(I.baseLayer){const H=I.baseLayer.context.canvas;m(this.projectionMatrix,S.inlineVerticalFieldOfView,H.width/H.height,S.depthNear,S.depthFar)}}onFrameEnd(g){}endSession(g){return ei(this,null,function*(){const S=this.sessions.get(g);S.ended=!0})}doesSessionSupportReferenceSpace(g,S){const I=this.sessions.get(g);return I.ended?!1:I.enabledFeatures.has(S)}requestStageBounds(){return null}requestFrameOfReferenceTransform(g,S){return ei(this,null,function*(){return null})}getProjectionMatrix(g){return this.projectionMatrix}getViewport(g,S,I,H){const Z=this.sessions.get(g),{width:ee,height:oe}=I.context.canvas;return H.x=H.y=0,H.width=ee,H.height=oe,!0}getBasePoseMatrix(){return this.identityMatrix}getBaseViewMatrix(g){return this.identityMatrix}getInputSources(){return[]}getInputPose(g,S,I){return null}onWindowResize(){}}const Iw=function(E){return ei(this,null,function*(){let g=null;if("getVRDisplays"in E.navigator)try{const S=yield E.navigator.getVRDisplays();S&&S.length&&(g=new Mg(E,S[0]))}catch(S){}return g})},Dw=function(E,g){return ei(this,null,function*(){if(g.webvr){let I=yield Iw(E);if(I)return I}let S=JE(E);return S&&g.cardboard||!S&&g.allowCardboardOnDesktop?(E.VRFrameData||(E.VRFrameData=function(){this.rightViewMatrix=new Float32Array(16),this.leftViewMatrix=new Float32Array(16),this.rightProjectionMatrix=new Float32Array(16),this.leftProjectionMatrix=new Float32Array(16),this.pose=null}),new Tw(E,g.cardboardConfig)):new Rw(E)})},Lw={global:s,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},wc=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class Fw{constructor(g={}){this.config=Object.freeze(Object.assign({},Lw,g)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(g){if(!wc.every(S=>!!g[S]))throw new Error(`Global must have the following attributes : ${wc}`);for(const S of Object.keys(Xd))g[S]!==void 0?console.warn(`${S} already defined on global.`):g[S]=Xd[S];gg(g.WebGLRenderingContext)&&(_g(g.HTMLCanvasElement),g.OffscreenCanvas&&_g(g.OffscreenCanvas),g.WebGL2RenderingContext&&gg(g.WebGL2RenderingContext),window.isSecureContext||console.warn(`WebXR Polyfill Warning:
  This page is not running in a secure context (https:// or localhost)!
  This means that although the page may be able to use the WebXR Polyfill it will
  not be able to use native WebXR implementations, and as such will not be able to
  access dedicated VR or AR hardware, and will not be able to take advantage of
  any performance improvements a native WebXR implementation may offer. Please
  host this content on a secure origin for the best user experience.
  `)),this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let g=Dw(this.global,this.config);this.xr=new Xd.XRSystem(g),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(g){if(!wc.every(S=>!!g[S]))throw new Error(`Global must have the following attributes : ${wc}`);if(g.navigator.xr&&"supportsSession"in g.navigator.xr&&!("isSessionSupported"in g.navigator.xr)){let S=g.navigator.xr.supportsSession;g.navigator.xr.isSessionSupported=function(I){return S.call(this,I).then(()=>!0).catch(()=>!1)},g.navigator.xr.supportsSession=function(I){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),S.call(this,I)}}}}return Fw});/*!
 * Copyright (C) 2024-present Shapespark
 */function ye(s,e){if(!s)throw new Error(e)}function tt(s,e){console.assert(!!s,e)}function Ei(s,e){}function vs(s,e){throw new Error(`Unreachable code reached: ${e}`)}function fr(s,e){return(s&e)===e}function bs(s,e){return s[e]}function an(s,e,t){s[e]=t}function Ws(s){return Math.round(Pi(s,-1,1)*127)}function Sn(s){return s<=127?1:s<=32767?2:4}function pr(s,e,t){return s+t*(e-s)}function kn(s,e){const t=Math.pow(10,e);return Math.round(s*t)/t}function Mc(s){return Math.log(s)/Math.log(2)}function Ug(s,e){return Mc(e)-Mc(s)+1}function Pi(s,e,t){return s<e?e:s>t?t:s}function Bi(s,e,t,i,n){return i+(s-e)*(n-i)/(t-e)}function oi(s){const e=Math.PI/180;return s*e}function mn(s){const e=180/Math.PI;return s*e}function Yr(s,e,t){return Math.abs(s-e)<t}const es=class es{constructor(e=0,t=0,i=0){a(this,"x");a(this,"y");a(this,"z");this.x=e,this.y=t,this.z=i}set(e,t,i){return this.x=e,this.y=t,this.z=i,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){if(e!==0){const t=1/e;this.x*=t,this.y*=t,this.z*=t}else this.x=0,this.y=0,this.z=0;return this}min(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this.z>e.z&&(this.z=e.z),this}max(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this.z<e.z&&(this.z=e.z),this}clamp(e,t){return this.x=this.x<e.x?e.x:this.x>t.x?t.x:this.x,this.y=this.y<e.y?e.y:this.y>t.y?t.y:this.y,this.z=this.z<e.z?e.z:this.z>t.z?t.z:this.z,this}clampScalar(e,t){return this.x=this.x<e?e:this.x>t?t:this.x,this.y=this.y<e?e:this.y>t?t:this.y,this.z=this.z<e?e:this.z>t?t:this.z,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length())}setLength(e){const t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e),this}cross(e){const t=this.x,i=this.y,n=this.z;return this.x=i*e.z-n*e.y,this.y=n*e.x-t*e.z,this.z=t*e.y-i*e.x,this}crossVectors(e,t){return this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this}projectOnVector(e){es._tempVec3.copyFrom(e).normalize();const t=this.dot(es._tempVec3);return this.copyFrom(es._tempVec3).multiplyScalar(t)}projectOnPlane(e){return es._tempVec3.copyFrom(this).projectOnVector(e),this.sub(es._tempVec3)}reflect(e){return this.sub(es._tempVec3.copyFrom(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=this.dot(e)/(this.length()*e.length());return Math.acos(Pi(t,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}fillArray(e,t=0){e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z}addToArray(e,t=0){e[t]+=this.x,e[t+1]+=this.y,e[t+2]+=this.z}toArray(){return[this.x,this.y,this.z]}clone(){return new es(this.x,this.y,this.z)}};a(es,"_tempVec3",new es);let B=es;const So=class So{constructor(e=new B,t=0){a(this,"center");a(this,"radius");this.center=e,this.radius=t}set(e,t){return this.center.copyFrom(e),this.radius=t,this}setFromPoints(e,t){const i=this.center,n=new Dt;t!==void 0?i.copyFrom(t):n.setFromPoints(e).center(i);let r=0;for(const o of e)r=Math.max(r,i.distanceToSquared(o));return this.radius=Math.sqrt(r),this}copyFrom(e){return this.center.copyFrom(e.center),this.radius=e.radius,this}empty(){return this.radius<=0}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}clampPoint(e,t){const i=this.center.distanceToSquared(e),n=t||new B;return n.copyFrom(e),i>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n}getBoundingBox(){const e=new Dt;return e.set(this.center,this.center),e.expandByScalar(this.radius),e}applyMatrix4(e){return e.affineTransformPoint3(this.center),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new So().copyFrom(this)}static union(e,t){if(t.empty()){t.copyFrom(e);return}const i=t.center.distanceTo(e.center);let n,r;e.radius>t.radius?(n=e,r=t):(n=t,r=e);const o=(n.radius+r.radius+i)/2;if(o<=n.radius){t.copyFrom(n);return}const l=(o-n.radius)/i;console.assert(l>0),So._tempVec3.copyFrom(r.center).sub(n.center).multiplyScalar(l),t.center.copyFrom(n.center).add(So._tempVec3),t.radius=o}};a(So,"_tempVec3",new B);let Tn=So;const or=class or{constructor(e,t){a(this,"min",new B(1/0,1/0,1/0));a(this,"max",new B(-1/0,-1/0,-1/0));e&&t?this.set(e,t):ye(!e&&!t)}set(e,t){return this.min.copyFrom(e),this.max.copyFrom(t),this}setFromPoints(e){this.makeEmpty();for(const t of e)this.expandByPoint(t);return this}setFromArray(e,t=0,i=e.length){this.makeEmpty();const n=new B;for(let r=t;r<i;r+=3)n.set(e[r],e[r+1],e[r+2]),this.expandByPoint(n);return this}copyFrom(e){return this.min.copyFrom(e.min),this.max.copyFrom(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}empty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}center(e){return(e!=null?e:new B).addVectors(this.min,this.max).multiplyScalar(.5)}size(e){return(e!=null?e:new B).subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return(t!=null?t:new B).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}isIntersectionBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}clampPoint(e,t){return(t!=null?t:new B).copyFrom(e).clamp(this.min,this.max)}distanceToPoint(e){return or._tempVec3.copyFrom(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){const t=e!=null?e:new Tn;return t.center=this.center(),t.radius=this.size(or._tempVec3).length()*.5,t}intersect(e){return this.min.max(e.min),this.max.min(e.max),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){const t=(i,n,r)=>{or._tempVec3.set(i,n,r),this.expandByPoint(e.affineTransformPoint3(or._tempVec3))};return t(this.min.x,this.min.y,this.min.z),t(this.min.x,this.min.y,this.max.z),t(this.min.x,this.max.y,this.min.z),t(this.min.x,this.max.y,this.max.z),t(this.max.x,this.min.y,this.min.z),t(this.max.x,this.min.y,this.max.z),t(this.max.x,this.max.y,this.min.z),t(this.max.x,this.max.y,this.max.z),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}clone(){return new or(this.min,this.max)}};a(or,"_tempVec3",new B);let Dt=or;class Ue{constructor(e=0,t=0){a(this,"x");a(this,"y");this.x=e,this.y=t}set(e,t){return this.x=e,this.y=t,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}copyFrom(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){if(e!==0){const t=1/e;this.x*=t,this.y*=t}else this.x=0,this.y=0;return this}min(e){return this.x>e.x&&(this.x=e.x),this.y>e.y&&(this.y=e.y),this}max(e){return this.x<e.x&&(this.x=e.x),this.y<e.y&&(this.y=e.y),this}clamp(e,t){return this.x=this.x<e.x?e.x:this.x>t.x?t.x:this.x,this.y=this.y<e.y?e.y:this.y>t.y?t.y:this.y,this}clampScalar(e,t){return this.x=this.x<e?e:this.x>t?t:this.x,this.y=this.y<e?e:this.y>t?t:this.y,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){return this.divideScalar(this.length())}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}setLength(e){const t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e),this}static crossVectors(e,t){return e.x*t.y-e.y*t.x}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}fillArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,e}toArray(){return[this.x,this.y]}clone(){return new Ue(this.x,this.y)}}const Ia=class Ia{constructor(e=new Ue(1/0,1/0),t=new Ue(-1/0,-1/0)){a(this,"min");a(this,"max");this.min=e,this.max=t}set(e,t){return this.min.copyFrom(e),this.max.copyFrom(t),this}setFromPoints(e){this.makeEmpty();for(const t of e)this.expandByPoint(t);return this}copyFrom(e){return this.min.copyFrom(e.min),this.max.copyFrom(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}empty(){return this.max.x<this.min.x||this.max.y<this.min.y}center(e=new Ue){return e.addVectors(this.min,this.max).multiplyScalar(.5)}size(e=new Ue){return e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t=new Ue){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}isIntersectionBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)}clampPoint(e,t=new Ue){return t.copyFrom(e).clamp(this.min,this.max)}distanceToPoint(e){return Ia._tempVec2.copyFrom(e).clamp(this.min,this.max).sub(e).length()}intersect(e){return this.min.max(e.min),this.max.min(e.max),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}clone(){return new Ia().copyFrom(this)}};a(Ia,"_tempVec2",new Ue);let Do=Ia;function zg(s){return s<=.0031308?s*12.92:Math.pow(s,1/2.4)*1.055-.055}function $a(s){return s<=.04045?s/12.92:Math.pow((s+.055)/1.055,2.4)}class Vg{constructor(){a(this,"h",0);a(this,"s",0);a(this,"l",0)}}let Re=(Fi=class{constructor(e,t,i){a(this,"r",0);a(this,"g",0);a(this,"b",0);return typeof e=="number"&&t!==void 0&&i!==void 0?this.setRGB(e,t,i):e!==void 0?this.set(e):this}set(e){return e instanceof Fi?this.copyFrom(e):typeof e=="number"?this.setHex(e):typeof e=="string"&&this.setStyle(e),this}setHex(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,this}setRGB(e,t,i){return this.r=e,this.g=t,this.b=i,this}setHSL(e){const t=e.h,i=e.s,n=e.l;if(i===0)this.r=this.g=this.b=n;else{const r=function(c,d,u){return u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?c+(d-c)*6*u:u<.5?d:u<.6666666666666666?c+(d-c)*6*(.6666666666666666-u):c},o=n<=.5?n*(1+i):n+i-n*i,l=2*n-o;this.r=r(l,o,t+1/3),this.g=r(l,o,t),this.b=r(l,o,t-1/3)}return this}setStyle(e){if(/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(e)){const t=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(e);this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255}else if(/^rgb\((\d+)%, ?(\d+)%, ?(\d+)%\)$/i.test(e)){const t=/^rgb\((\d+)%, ?(\d+)%, ?(\d+)%\)$/i.exec(e);this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100}else if(/^#([0-9a-f]{6})$/i.test(e)){const t=/^#([0-9a-f]{6})$/i.exec(e);this.setHex(parseInt(t[1],16))}else if(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(e)){const t=/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(e);this.setHex(parseInt(t[1]+t[1]+t[2]+t[2]+t[3]+t[3],16))}else/^(\w+)$/i.test(e)&&this.setHex(Gg[e]);return this}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}convertGammaToLinear(){return this.r=$a(this.r),this.g=$a(this.g),this.b=$a(this.b),this}roundChannels(){return this.r=kn(this.r,3),this.g=kn(this.g,3),this.b=kn(this.b,3),this}getHex(){return this.r*255<<16^this.g*255<<8^this.b*255<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(){const e=new Vg,t=this.r,i=this.g,n=this.b,r=Math.max(t,i,n),o=Math.min(t,i,n);let l,c;const d=(o+r)/2;if(o===r)l=0,c=0;else{const u=r-o;c=d<=.5?u/(r+o):u/(2-r-o),l=r==t?(i-n)/u+(i<n?6:0):r==i?(n-t)/u+2:(t-i)/u+4,l/=6}return e.h=l,e.s=c,e.l=d,e}getStyle(){return"rgb("+(this.r*255|0)+","+(this.g*255|0)+","+(this.b*255|0)+")"}offsetHSL(e,t,i){const n=this.getHSL();return n.h+=e,n.s+=t,n.l+=i,this.setHSL(n),this}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e){return this.r=e[0],this.g=e[1],this.b=e[2],this}toArray(){return[this.r,this.g,this.b]}clone(){return new Fi().setRGB(this.r,this.g,this.b)}},a(Fi,"BLACK",new Fi(0)),a(Fi,"WHITE",new Fi(16777215)),a(Fi,"RED",new Fi(16711680)),a(Fi,"GREEN",new Fi(65280)),a(Fi,"BLUE",new Fi(255)),a(Fi,"ORANGE",new Fi(16753920)),Fi);const Gg={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},mc=class mc{static linearToGamma(e){return zg(e)}static gammaToLinear(e){return $a(e)}static rgbmEncode(e,t){const i=2.82842712,n=Math.sqrt(e.r)/i,r=Math.sqrt(e.g)/i,o=Math.sqrt(e.b)/i;let l=Math.max(Math.max(n,r),o);l=Pi(l,1/255,1),l=Math.ceil(l*255)/255,t.set(n/l,r/l,o/l,1-l)}static ycocgmEncode(e,t,i){const o=(b,_)=>{const y=Math.max(Math.abs(b),Math.abs(_));return y<.03125?16:y<.0625?8:y<.125?4:y<.25?2:1};let l=.25*e.r+.5*e.g+.25*e.b,c=.5*e.r-.5*e.b,d=-.25*e.r+.5*e.g-.25*e.b;l*=1/8,c*=1/8,d*=1/8;const u=o(c,d);l=Math.sqrt(l),c=c*u+.5,d=d*u+.5;let h,f;if(l<i)h=l*(1/i),f=16-1;else{h=(l-i)*(1/(1-i));const b=h*(16-3);f=b|0,h=b-f,f++}const m=(16-16/u|0)+f*16;t.set(h,c,d,m*(1/255))}static combineColorWithOpacity(e,t){if(t>=1)return e;const i=mc._tempColor;i.setStyle(e);const n=r=>r*255|0;return"rgba("+n(i.r)+","+n(i.g)+","+n(i.b)+","+t+")"}};a(mc,"_tempColor",new Re);let Qr=mc;const $i=class $i{constructor(){a(this,"elements",new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]))}set(e,t,i,n,r,o,l,c,d,u,h,f,p,m,b,_){const y=this.elements;return y[0]=e,y[4]=t,y[8]=i,y[12]=n,y[1]=r,y[5]=o,y[9]=l,y[13]=c,y[2]=d,y[6]=u,y[10]=h,y[14]=f,y[3]=p,y[7]=m,y[11]=b,y[15]=_,this}setZero(){return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}copyFrom(e){return this.elements.set(e.elements),this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}extractBasis(e,t,i){const n=this.elements;return e.set(n[0],n[1],n[2]),t.set(n[4],n[5],n[6]),i.set(n[8],n[9],n[10]),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=$i._tempVec3A,i=this.elements,n=e.elements,r=1/t.set(n[0],n[1],n[2]).length(),o=1/t.set(n[4],n[5],n[6]).length(),l=1/t.set(n[8],n[9],n[10]).length();return i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[8]=n[8]*l,i[9]=n[9]*l,i[10]=n[10]*l,this}makeRotationFromQuaternion(e){const t=this.elements,i=e.x,n=e.y,r=e.z,o=e.w,l=i+i,c=n+n,d=r+r,u=i*l,h=i*c,f=i*d,p=n*c,m=n*d,b=r*d,_=o*l,y=o*c,A=o*d;return t[0]=1-(p+b),t[4]=h-A,t[8]=f+y,t[1]=h+A,t[5]=1-(u+b),t[9]=m-_,t[2]=f-y,t[6]=m+_,t[10]=1-(u+p),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}lookAt(e,t,i){const n=$i._tempVec3A,r=$i._tempVec3B,o=$i._tempVec3C,l=this.elements;return o.subVectors(e,t).normalize(),o.length()===0&&(o.z=1),n.crossVectors(i,o).normalize(),n.length()===0&&(o.x+=1e-4,n.crossVectors(i,o).normalize()),r.crossVectors(o,n),l[0]=n.x,l[4]=r.x,l[8]=o.x,l[1]=n.y,l[5]=r.y,l[9]=o.y,l[2]=n.z,l[6]=r.z,l[10]=o.z,this}multiply(e){return this.multiplyMatrices(this,e)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,r=this.elements,o=i[0],l=i[4],c=i[8],d=i[12],u=i[1],h=i[5],f=i[9],p=i[13],m=i[2],b=i[6],_=i[10],y=i[14],A=i[3],T=i[7],M=i[11],C=i[15],N=n[0],O=n[4],q=n[8],j=n[12],K=n[1],de=n[5],xe=n[9],Ve=n[13],qe=n[2],k=n[6],Q=n[10],le=n[14],ae=n[3],Ee=n[7],te=n[11],me=n[15];return r[0]=o*N+l*K+c*qe+d*ae,r[4]=o*O+l*de+c*k+d*Ee,r[8]=o*q+l*xe+c*Q+d*te,r[12]=o*j+l*Ve+c*le+d*me,r[1]=u*N+h*K+f*qe+p*ae,r[5]=u*O+h*de+f*k+p*Ee,r[9]=u*q+h*xe+f*Q+p*te,r[13]=u*j+h*Ve+f*le+p*me,r[2]=m*N+b*K+_*qe+y*ae,r[6]=m*O+b*de+_*k+y*Ee,r[10]=m*q+b*xe+_*Q+y*te,r[14]=m*j+b*Ve+_*le+y*me,r[3]=A*N+T*K+M*qe+C*ae,r[7]=A*O+T*de+M*k+C*Ee,r[11]=A*q+T*xe+M*Q+C*te,r[15]=A*j+T*Ve+M*le+C*me,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}getTranslation(e=new B){return e.x=this.elements[12],e.y=this.elements[13],e.z=this.elements[14],e}affineTransformPoint3(e){this.isApproxAffine();const t=e.x,i=e.y,n=e.z,r=this.elements;return e.x=r[0]*t+r[4]*i+r[8]*n+r[12],e.y=r[1]*t+r[5]*i+r[9]*n+r[13],e.z=r[2]*t+r[6]*i+r[10]*n+r[14],e}transformPoint3(e){const t=e.x,i=e.y,n=e.z,r=this.elements,o=1/(r[3]*t+r[7]*i+r[11]*n+r[15]);return e.x=(r[0]*t+r[4]*i+r[8]*n+r[12])*o,e.y=(r[1]*t+r[5]*i+r[9]*n+r[13])*o,e.z=(r[2]*t+r[6]*i+r[10]*n+r[14])*o,e}transformVector3(e){this.isApproxAffine();const t=e.x,i=e.y,n=e.z,r=this.elements;return e.x=r[0]*t+r[4]*i+r[8]*n,e.y=r[1]*t+r[5]*i+r[9]*n,e.z=r[2]*t+r[6]*i+r[10]*n,e.normalize(),e}affineTransformPoint3Array(e,t=0,i=e.length){const n=$i._tempVec3A;for(let r=0,o=t;r<i;r+=3,o+=3)n.x=e[o],n.y=e[o+1],n.z=e[o+2],this.affineTransformPoint3(n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}determinant(){const e=this.elements,t=e[0],i=e[4],n=e[8],r=e[12],o=e[1],l=e[5],c=e[9],d=e[13],u=e[2],h=e[6],f=e[10],p=e[14],m=e[3],b=e[7],_=e[11],y=e[15];return m*(+r*c*h-n*d*h-r*l*f+i*d*f+n*l*p-i*c*p)+b*(+t*c*p-t*d*f+r*o*f-n*o*p+n*d*u-r*c*u)+_*(+t*d*h-t*l*p-r*o*h+i*o*p+r*l*u-i*d*u)+y*(-n*l*u-t*c*h+t*l*f+n*o*h-i*o*f+i*c*u)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e){const t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this}invert(){const e=$i._tempMatrix4;return e.getInverse(this),this.copyFrom(e),this}getInverse(e,t=!1){const i=this.elements,n=e.elements,r=n[0],o=n[4],l=n[8],c=n[12],d=n[1],u=n[5],h=n[9],f=n[13],p=n[2],m=n[6],b=n[10],_=n[14],y=n[3],A=n[7],T=n[11],M=n[15];i[0]=h*_*A-f*b*A+f*m*T-u*_*T-h*m*M+u*b*M,i[4]=c*b*A-l*_*A-c*m*T+o*_*T+l*m*M-o*b*M,i[8]=l*f*A-c*h*A+c*u*T-o*f*T-l*u*M+o*h*M,i[12]=c*h*m-l*f*m-c*u*b+o*f*b+l*u*_-o*h*_,i[1]=f*b*y-h*_*y-f*p*T+d*_*T+h*p*M-d*b*M,i[5]=l*_*y-c*b*y+c*p*T-r*_*T-l*p*M+r*b*M,i[9]=c*h*y-l*f*y-c*d*T+r*f*T+l*d*M-r*h*M,i[13]=l*f*p-c*h*p+c*d*b-r*f*b-l*d*_+r*h*_,i[2]=u*_*y-f*m*y+f*p*A-d*_*A-u*p*M+d*m*M,i[6]=c*m*y-o*_*y-c*p*A+r*_*A+o*p*M-r*m*M,i[10]=o*f*y-c*u*y+c*d*A-r*f*A-o*d*M+r*u*M,i[14]=c*u*p-o*f*p-c*d*m+r*f*m+o*d*_-r*u*_,i[3]=h*m*y-u*b*y-h*p*A+d*b*A+u*p*T-d*m*T,i[7]=o*b*y-l*m*y+l*p*A-r*b*A-o*p*T+r*m*T,i[11]=l*u*y-o*h*y-l*d*A+r*h*A+o*d*T-r*u*T,i[15]=o*h*p-l*u*p+l*d*m-r*h*m-o*d*b+r*u*b;const C=r*i[0]+d*i[4]+p*i[8]+y*i[12];if(C==0){const N="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(N);return console.warn(N),this.identity(),this}return this.multiplyScalar(1/C),this}scale(e){const t=this.elements,i=e.x,n=e.y,r=e.z;return t[0]*=i,t[4]*=n,t[8]*=r,t[1]*=i,t[5]*=n,t[9]*=r,t[2]*=i,t[6]*=n,t[10]*=r,t[3]*=i,t[7]*=n,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(i,n)))}makeTranslation(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),n=Math.sin(t),r=1-i,o=e.x,l=e.y,c=e.z,d=r*o,u=r*l;return this.set(d*o+i,d*l-n*c,d*c+n*l,0,d*l+n*c,u*l+i,u*c-n*o,0,d*c-n*l,u*c+n*o,r*c*c+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}compose(e,t,i){return this.makeRotationFromQuaternion(t),this.scale(i),this.setPosition(e),this}decompose(e,t,i){const n=$i._tempVec3A,r=$i._tempMatrix4,o=this.elements;let l=n.set(o[0],o[1],o[2]).length();const c=n.set(o[4],o[5],o[6]).length(),d=n.set(o[8],o[9],o[10]).length();this.determinant()<0&&(l=-l),e.x=o[12],e.y=o[13],e.z=o[14],r.elements.set(this.elements);const h=1/l,f=1/c,p=1/d;return r.elements[0]*=h,r.elements[1]*=h,r.elements[2]*=h,r.elements[4]*=f,r.elements[5]*=f,r.elements[6]*=f,r.elements[8]*=p,r.elements[9]*=p,r.elements[10]*=p,t.setFromRotationMatrix(r),i.x=l,i.y=c,i.z=d,this}makeFrustum(e,t,i,n,r,o){const l=this.elements,c=2*r/(t-e),d=2*r/(n-i),u=(t+e)/(t-e),h=(n+i)/(n-i),f=-(o+r)/(o-r),p=-2*o*r/(o-r);return l[0]=c,l[4]=0,l[8]=u,l[12]=0,l[1]=0,l[5]=d,l[9]=h,l[13]=0,l[2]=0,l[6]=0,l[10]=f,l[14]=p,l[3]=0,l[7]=0,l[11]=-1,l[15]=0,this}makePerspective(e,t,i,n){const r=i*Math.tan(oi(e*.5)),o=-r,l=o*t,c=r*t;return this.makeFrustum(l,c,o,r,i,n)}makeOrthographic(e,t,i,n,r,o){const l=this.elements,c=t-e,d=i-n,u=o-r,h=(t+e)/c,f=(i+n)/d,p=(o+r)/u;return l[0]=2/c,l[4]=0,l[8]=0,l[12]=-h,l[1]=0,l[5]=2/d,l[9]=0,l[13]=-f,l[2]=0,l[6]=0,l[10]=-2/u,l[14]=-p,l[3]=0,l[7]=0,l[11]=0,l[15]=1,this}fromArray(e){return this.elements.set(e),this}toArray(){return Array.from(this.elements)}clone(){return new $i().fromArray(this.elements)}isApproxAffine(e=1e-4){const t=this.elements;return Yr(t[3],0,e)&&Yr(t[7],0,e)&&Yr(t[11],0,e)&&Yr(t[15],1,e)}hasNaNs(){for(let e=0;e<this.elements.length;e++)if(isNaN(this.elements[e]))return!0;return!1}};a($i,"_tempVec3A",new B),a($i,"_tempVec3B",new B),a($i,"_tempVec3C",new B),a($i,"_tempMatrix4",new $i);let je=$i;const Da=class Da{constructor(e=0,t=0,i=0,n=1){a(this,"x");a(this,"y");a(this,"z");a(this,"w");this.x=e,this.y=t,this.z=i,this.w=n}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}setFromAxisAngle(e,t){const i=t/2,n=Math.sin(i);return this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(i),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],n=t[4],r=t[8],o=t[1],l=t[5],c=t[9],d=t[2],u=t[6],h=t[10],f=i+l+h;let p;return f>0?(p=.5/Math.sqrt(f+1),this.w=.25/p,this.x=(u-c)*p,this.y=(r-d)*p,this.z=(o-n)*p):i>l&&i>h?(p=2*Math.sqrt(1+i-l-h),this.w=(u-c)/p,this.x=.25*p,this.y=(n+o)/p,this.z=(r+d)/p):l>h?(p=2*Math.sqrt(1+l-i-h),this.w=(r-d)/p,this.x=(n+o)/p,this.y=.25*p,this.z=(c+u)/p):(p=2*Math.sqrt(1+h-i-l),this.w=(o-n)/p,this.x=(r+d)/p,this.y=(c+u)/p,this.z=.25*p),this}setFromUnitVectors(e,t){const n=Da._tempVec3;let r=e.dot(t)+1;return r<1e-6?(r=0,Math.abs(e.x)>Math.abs(e.z)?n.set(-e.y,e.x,0):n.set(0,-e.z,e.y)):n.crossVectors(e,t),this.x=n.x,this.y=n.y,this.z=n.z,this.w=r,this.normalize(),this}inverse(){return this.conjugate().normalize(),this}conjugate(){return this.x*=-1,this.y*=-1,this.z*=-1,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){let e=this.length();return e===0?(this.x=0,this.y=0,this.z=0,this.w=1):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this}multiply(e){return this.multiplyQuaternions(this,e)}multiplyQuaternions(e,t){const i=e.x,n=e.y,r=e.z,o=e.w,l=t.x,c=t.y,d=t.z,u=t.w;return this.x=i*u+o*l+n*d-r*c,this.y=n*u+o*c+r*l-i*d,this.z=r*u+o*d+i*c-n*l,this.w=o*u-i*l-n*c-r*d,this}slerp(e,t){if(t===0)return this;if(t===1)return this.copyFrom(e);const i=this.x,n=this.y,r=this.z,o=this.w;let l=o*e.w+i*e.x+n*e.y+r*e.z;if(l<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,l=-l):this.copyFrom(e),l>=1)return this.w=o,this.x=i,this.y=n,this.z=r,this;const c=Math.acos(l),d=Math.sqrt(1-l*l);if(Math.abs(d)<.001)return this.w=.5*(o+this.w),this.x=.5*(i+this.x),this.y=.5*(n+this.y),this.z=.5*(r+this.z),this;const u=Math.sin((1-t)*c)/d,h=Math.sin(t*c)/d;return this.w=o*u+this.w*h,this.x=i*u+this.x*h,this.y=n*u+this.y*h,this.z=r*u+this.z*h,this}static slerp(e,t,i,n){return i.copyFrom(e).slerp(t,n)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}applyToVector3(e){const t=e.x,i=e.y,n=e.z,r=this.x,o=this.y,l=this.z,c=this.w,d=c*t+o*n-l*i,u=c*i+l*t-r*n,h=c*n+r*i-o*t,f=-r*t-o*i-l*n;return e.x=d*c+f*-r+u*-l-h*-o,e.y=u*c+f*-o+h*-r-d*-l,e.z=h*c+f*-l+d*-o-u*-r,e}clone(){return new Da(this.x,this.y,this.z,this.w)}};a(Da,"_tempVec3");let xi=Da;var Un=(s=>(s[s.XYZ=0]="XYZ",s[s.YZX=1]="YZX",s[s.ZXY=2]="ZXY",s[s.XZY=3]="XZY",s[s.YXZ=4]="YXZ",s[s.ZYX=5]="ZYX",s))(Un||{});const Bs=class Bs{constructor(e=0,t=0,i=0,n=2){a(this,"x");a(this,"y");a(this,"z");a(this,"order");this.x=t,this.y=i,this.z=e,this.order=n}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,n!==void 0&&(this.order=n),this}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.order=e.order,this}setFromRotationMatrix(e,t){const i=e.elements,n=i[0],r=i[4],o=i[8],l=i[1],c=i[5],d=i[9],u=i[2],h=i[6],f=i[10];return t=t||this.order,t===0?(this.y=Math.asin(Pi(o,-1,1)),Math.abs(o)<.99999?(this.x=Math.atan2(-d,f),this.z=Math.atan2(-r,n)):(this.x=Math.atan2(h,c),this.z=0)):t===4?(this.x=Math.asin(-Pi(d,-1,1)),Math.abs(d)<.99999?(this.y=Math.atan2(o,f),this.z=Math.atan2(l,c)):(this.y=Math.atan2(-u,n),this.z=0)):t===2?(this.x=Math.asin(Pi(h,-1,1)),Math.abs(h)<.99999?(this.y=Math.atan2(-u,f),this.z=Math.atan2(-r,c)):(this.y=0,this.z=Math.atan2(l,n))):t===5?(this.y=Math.asin(-Pi(u,-1,1)),Math.abs(u)<.99999?(this.x=Math.atan2(h,f),this.z=Math.atan2(l,n)):(this.x=0,this.z=Math.atan2(-r,c))):t===1?(this.z=Math.asin(Pi(l,-1,1)),Math.abs(l)<.99999?(this.x=Math.atan2(-d,c),this.y=Math.atan2(-u,n)):(this.x=0,this.y=Math.atan2(o,f))):t===3&&(this.z=Math.asin(-Pi(r,-1,1)),Math.abs(r)<.99999?(this.x=Math.atan2(h,c),this.y=Math.atan2(o,n)):(this.x=Math.atan2(-d,f),this.y=0)),this.order=t,this}setFromQuaternion(e,t){return Bs._tempMatrix4.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Bs._tempMatrix4,t),this}setFromVector3(e,t){return this.set(e.x,e.y,e.z,t!=null?t:this.order)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.order===this.order}fromArray(e){return this.x=e[0],this.y=e[1],this.z=e[2],e[3]!==void 0&&(this.order=e[3]),this}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.order,e}toVector3(){return new B(this.x,this.y,this.z)}applyToVector3(e){return this.toQuaternion(Bs._tempQuat),Bs._tempQuat.applyToVector3(e)}clone(){return new Bs(this.x,this.y,this.z,this.order)}get pitch(){return this.x}set pitch(e){this.x=e}get roll(){return this.y}set roll(e){this.y=e}get yaw(){return this.z}set yaw(e){this.z=e}get pitchDeg(){return mn(this.pitch)}set pitchDeg(e){this.pitch=oi(e)}get rollDeg(){return mn(this.roll)}set rollDeg(e){this.roll=oi(e)}get yawDeg(){return mn(this.yaw)}set yawDeg(e){this.yaw=oi(e)}setFromDegTriple(e){const t=oi(e[0]),i=oi(e[1]),n=oi(e[2]);return this.set(i,n,t),this}toDegTriple(){return[this.yawDeg,this.pitchDeg,this.rollDeg]}setFromDirection(e){const t=Math.atan2(-e.x,e.y),i=Math.asin(e.z),n=0;return this.set(i,n,t),this}toQuaternion(e=new xi){const t=Math.cos(this.x/2),i=Math.cos(this.y/2),n=Math.cos(this.z/2),r=Math.sin(this.x/2),o=Math.sin(this.y/2),l=Math.sin(this.z/2);return this.order===0?e.set(r*i*n+t*o*l,t*o*n-r*i*l,t*i*l+r*o*n,t*i*n-r*o*l):this.order===4?e.set(r*i*n+t*o*l,t*o*n-r*i*l,t*i*l-r*o*n,t*i*n+r*o*l):this.order===2?e.set(r*i*n-t*o*l,t*o*n+r*i*l,t*i*l+r*o*n,t*i*n-r*o*l):this.order===5?e.set(r*i*n-t*o*l,t*o*n+r*i*l,t*i*l-r*o*n,t*i*n+r*o*l):this.order===1?e.set(r*i*n+t*o*l,t*o*n+r*i*l,t*i*l-r*o*n,t*i*n-r*o*l):this.order===3&&e.set(r*i*n-t*o*l,t*o*n-r*i*l,t*i*l+r*o*n,t*i*n+r*o*l),e}toRotationMatrix(e=new je){const t=e.elements,i=Math.cos(this.x),n=Math.sin(this.x),r=Math.cos(this.y),o=Math.sin(this.y),l=Math.cos(this.z),c=Math.sin(this.z);if(this.order===0){const d=i*l,u=i*c,h=n*l,f=n*c;t[0]=r*l,t[4]=-r*c,t[8]=o,t[1]=u+h*o,t[5]=d-f*o,t[9]=-n*r,t[2]=f-d*o,t[6]=h+u*o,t[10]=i*r}else if(this.order===4){const d=r*l,u=r*c,h=o*l,f=o*c;t[0]=d+f*n,t[4]=h*n-u,t[8]=i*o,t[1]=i*c,t[5]=i*l,t[9]=-n,t[2]=u*n-h,t[6]=f+d*n,t[10]=i*r}else if(this.order===2){const d=r*l,u=r*c,h=o*l,f=o*c;t[0]=d-f*n,t[4]=-i*c,t[8]=h+u*n,t[1]=u+h*n,t[5]=i*l,t[9]=f-d*n,t[2]=-i*o,t[6]=n,t[10]=i*r}else if(this.order===5){const d=i*l,u=i*c,h=n*l,f=n*c;t[0]=r*l,t[4]=h*o-u,t[8]=d*o+f,t[1]=r*c,t[5]=f*o+d,t[9]=u*o-h,t[2]=-o,t[6]=n*r,t[10]=i*r}else if(this.order===1){const d=i*r,u=i*o,h=n*r,f=n*o;t[0]=r*l,t[4]=f-d*c,t[8]=h*c+u,t[1]=c,t[5]=i*l,t[9]=-n*l,t[2]=-o*l,t[6]=u*c+h,t[10]=d-f*c}else if(this.order===3){const d=i*r,u=i*o,h=n*r,f=n*o;t[0]=r*l,t[4]=-c,t[8]=o*l,t[1]=d*c+f,t[5]=i*l,t[9]=u*c-h,t[2]=h*c-u,t[6]=n*l,t[10]=f*c+d}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,e}};a(Bs,"_tempQuat",new xi),a(Bs,"_tempMatrix4",new je);let mi=Bs;const La=class La{constructor(){a(this,"elements",new Float32Array([1,0,0,0,1,0,0,0,1]))}set(e,t,i,n,r,o,l,c,d){const u=this.elements;return u[0]=e,u[3]=t,u[6]=i,u[1]=n,u[4]=r,u[7]=o,u[2]=l,u[5]=c,u[8]=d,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copyFrom(e){const t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this}transformVector3(e){const t=e.x,i=e.y,n=e.z,r=this.elements;return e.x=r[0]*t+r[3]*i+r[6]*n,e.y=r[1]*t+r[4]*i+r[7]*n,e.z=r[2]*t+r[5]*i+r[8]*n,e}transformVector3Array(e,t=0,i=e.length){const n=La._tempVec3;for(let r=0,o=t;r<i;r+=3,o+=3)n.x=e[o+0],n.y=e[o+1],n.z=e[o+2],this.transformVector3(n),e[o+0]=n.x,e[o+1]=n.y,e[o+2]=n.z}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements;return e[0]*e[4]*e[8]-e[0]*e[5]*e[7]-e[1]*e[3]*e[8]+e[1]*e[5]*e[6]+e[2]*e[3]*e[7]-e[2]*e[4]*e[6]}getInverse(e,t=!1){const i=e.elements,n=this.elements;n[0]=+i[10]*i[5]-i[6]*i[9],n[1]=-i[10]*i[1]+i[2]*i[9],n[2]=+i[6]*i[1]-i[2]*i[5],n[3]=-i[10]*i[4]+i[6]*i[8],n[4]=+i[10]*i[0]-i[2]*i[8],n[5]=-i[6]*i[0]+i[2]*i[4],n[6]=+i[9]*i[4]-i[5]*i[8],n[7]=-i[9]*i[0]+i[1]*i[8],n[8]=+i[5]*i[0]-i[1]*i[4];const r=i[0]*n[0]+i[1]*n[3]+i[2]*n[6];if(r===0){const o="Matrix3.getInverse(): can't invert matrix, determinant is 0";if(t)throw new Error(o);return console.warn(o),this.identity(),this}return this.multiplyScalar(1/r),this}transpose(){const e=this.elements;let t=e[1];return e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(e){return this.getInverse(e).transpose(),this}fromArray(e){return this.elements.set(e),this}toArray(){const e=this.elements;return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]}fromMat4(e){const t=e.elements;this.set(t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10])}clone(){return new La().fromArray(this.elements)}};a(La,"_tempVec3",new B);let ys=La;const On=class On{constructor(e=new B,t=0){a(this,"normal");a(this,"constant");this.normal=e,this.constant=t}set(e,t){return this.normal.copyFrom(e),this.constant=t,this}setComponents(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copyFrom(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const n=On._tempVec3A,r=On._tempVec3B,o=n.subVectors(i,t).cross(r.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(o,e),this}copyFrom(e){return this.normal.copyFrom(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t=new B){return this.orthoPoint(e,t).sub(e).negate()}orthoPoint(e,t=new B){const i=this.distanceToPoint(e);return t.copyFrom(this.normal).multiplyScalar(i)}isIntersectionLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectLine(e,t=new B){const i=On._tempVec3A,n=t,r=e.delta(i),o=this.normal.dot(r);if(o==0)return this.distanceToPoint(e.start)==0?n.copyFrom(e.start):void 0;const l=-(e.start.dot(this.normal)+this.constant)/o;if(!(l<0||l>1))return n.copyFrom(r).multiplyScalar(l).add(e.start)}coplanarPoint(e=new B){return e.copyFrom(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=On._tempVec3A,n=On._tempVec3B,r=On._tempMatrix3,l=(t!=null?t:r.getNormalMatrix(e)).transformVector3(i.copyFrom(this.normal)),c=this.coplanarPoint(n);return e.affineTransformPoint3(c),this.setFromNormalAndCoplanarPoint(l,c),this}translate(e){return this.constant=this.constant-e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new On().copyFrom(this)}};a(On,"_tempVec3A",new B),a(On,"_tempVec3B",new B),a(On,"_tempMatrix3",new ys);let js=On;const Ns=class Ns{constructor(){a(this,"planes",[new js,new js,new js,new js,new js,new js])}setFromMatrix(e){const t=e.elements,i=this.planes;return i[0].setComponents(t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]).normalize(),i[1].setComponents(t[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]).normalize(),i[2].setComponents(t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]).normalize(),i[3].setComponents(t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]).normalize(),i[4].setComponents(t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14]).normalize(),i[5].setComponents(t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]).normalize(),this}intersectsObject(e){const t=e.geometry;let i;return t.boundingSphere===null&&t.computeBoundingSphere(),e.matrixWorld?(i=Ns._tempSphere,i.copyFrom(t.boundingSphere),i.applyMatrix4(e.matrixWorld)):i=t.boundingSphere,this.intersectsSphere(i)}nearPlaneDistanceToCenter(e){const t=e.geometry;let i;const n=this.planes[5];return e.matrixWorld?(i=Ns._tempSphere,i.copyFrom(t.boundingSphere),i.applyMatrix4(e.matrixWorld)):i=t.boundingSphere,n.distanceToPoint(i.center)}nearPlaneDistanceToPoint(e){return this.planes[5].distanceToPoint(e)}intersectsSphere(e){const t=this.planes,i=e.center,n=-e.radius;for(let r=0;r<6;r+=1)if(t[r].distanceToPoint(i)<n)return!1;return!0}intersectsBox(e){const t=Ns._tempVec3A,i=Ns._tempVec3B,n=this.planes;for(const r of n){t.x=r.normal.x>0?e.min.x:e.max.x,i.x=r.normal.x>0?e.max.x:e.min.x,t.y=r.normal.y>0?e.min.y:e.max.y,i.y=r.normal.y>0?e.max.y:e.min.y,t.z=r.normal.z>0?e.min.z:e.max.z,i.z=r.normal.z>0?e.max.z:e.min.z;const o=r.distanceToPoint(t),l=r.distanceToPoint(i);if(o<0&&l<0)return!1}return!0}containsPoint(e){return this.planes.every(t=>t.distanceToPoint(e)>=0)}};a(Ns,"_tempSphere",new Tn),a(Ns,"_tempVec3A",new B),a(Ns,"_tempVec3B",new B);let Kr=Ns;const Ur=class Ur{constructor(e=new B,t=new B){a(this,"start");a(this,"end");this.start=e,this.end=t}set(e,t){return this.start.copyFrom(e),this.end.copyFrom(t),this}copyFrom(e){return this.start.copyFrom(e.start),this.end.copyFrom(e.end),this}center(e=new B){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e=new B){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t=new B){const i=t;return this.delta(i).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t=!1){const i=Ur._tempVec3A,n=Ur._tempVec3B;i.subVectors(e,this.start),n.subVectors(this.end,this.start);const r=n.dot(n);let l=n.dot(i)/r;return t&&(l=Pi(l,0,1)),l}closestPointToPoint(e,t=!1,i=new B){const n=this.closestPointToPointParameter(e,t),r=i;return this.delta(r).multiplyScalar(n).add(this.start)}applyMatrix4(e){return e.affineTransformPoint3(this.start),e.affineTransformPoint3(this.end),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return new Ur().copyFrom(this)}};a(Ur,"_tempVec3A",new B),a(Ur,"_tempVec3B",new B);let Pc=Ur;const Hg=Math.PI/180;class Cc extends je{setOrthographic(e,t,i,n,r,o){const l=1/(t-e),c=1/(i-n),d=1/(o-r),u=(t+e)*l,h=(i+n)*c,f=(o+r)*d;return this.setZero(),this.elements[0]=2*l,this.elements[4]=0,this.elements[8]=0,this.elements[12]=-u,this.elements[1]=0,this.elements[5]=2*c,this.elements[9]=0,this.elements[13]=-h,this.elements[2]=0,this.elements[6]=0,this.elements[10]=-2*d,this.elements[14]=-f,this.elements[3]=0,this.elements[7]=0,this.elements[11]=0,this.elements[15]=1,this}setPerspective(e,t,i,n){const r=Math.tan(Hg*.5*e),o=i*r,l=2*o,c=t*l,d=-c/2,u=d+c,h=o-l,f=2*i/(u-d),p=2*i/(o-h),m=(u+d)/(u-d),b=(o+h)/(o-h),_=-(n+i)/(n-i),y=-2*n*i/(n-i);return this.setZero(),this.elements[0]=f,this.elements[4]=0,this.elements[8]=m,this.elements[12]=0,this.elements[1]=0,this.elements[5]=p,this.elements[9]=b,this.elements[13]=0,this.elements[2]=0,this.elements[6]=0,this.elements[10]=_,this.elements[14]=y,this.elements[3]=0,this.elements[7]=0,this.elements[11]=-1,this.elements[15]=0,this}}const Ji=class Ji{constructor(){a(this,"histograms");a(this,"indices");a(this,"tmpIndices")}sort(e,t=!1){let i=null;t?(i=e instanceof Float32Array?new Float32Array(e.length):new Int32Array(e.length),i.set(e)):i=e,this.histograms=new Int32Array(Ji._max*Math.ceil(64/11));let n=new Int32Array(i.buffer,i.byteOffset,i.byteLength>>2);const r=Math.ceil(i.BYTES_PER_ELEMENT*8/11),o=Ji._max*(r-1),l=1<<(i.BYTES_PER_ELEMENT*8-1)%11,c=(l<<1)-1;let d=null,u=new Int32Array(n.length);this.indices=new Uint32Array(n.length),this.tmpIndices=new Uint32Array(n.length);const h=Ji._max*r;for(let f=0;f<h;f++)this.histograms[f]=0;this.initHistograms(n,o,c);for(let f=0;f<=o;f+=Ji._max){let p=0;for(let m=f;m<f+Ji._max;m++){const b=this.histograms[m]+p;this.histograms[m]=p-1,p=b}}return this.lsbPass(n,u),d=u,u=n,n=d,this.pass(n,u),d=u,u=n,n=d,this.msbPass(n,u,l),{array:new Float32Array(u.buffer,u.byteOffset,i.length),indices:this.indices}}lsbPass(e,t){ye(this.histograms);for(let i=0,n=e.length;i<n;i++){let r=e[i];const o=r>>31;r^=o|2147483648;const l=++this.histograms[r&Ji._mask];this.indices[l]=i,t[l]=r}}pass(e,t){const i=e.length;ye(this.tmpIndices&&this.indices&&this.histograms);for(let n=0;n<i;n++){const r=e[n],o=++this.histograms[Ji._max+(r>>>11&Ji._mask)];this.tmpIndices[o]=this.indices[n],t[o]=r}this.indices.set(this.tmpIndices)}msbPass(e,t,i){ye(this.tmpIndices&&this.indices&&this.histograms);const n=(i<<1)-1,r=e.length,o=2*Ji._max;for(let l=0;l<r;l++){const c=e[l],d=c>>31,u=++this.histograms[o+(c>>>22&n)];this.tmpIndices[u]=this.indices[l],t[u]=c^(~d|2147483648)}this.indices.set(this.tmpIndices)}initHistograms(e,t,i){ye(this.histograms);const n=e.length;for(let r=0;r<n;r++){let o=e[r];const l=o>>31;o^=l|2147483648;let c=0,d=0;for(;c<t;c+=Ji._max,d+=11)this.histograms[c+(o>>>d&Ji._mask)]++;this.histograms[c+(o>>>d&i)]++}}};a(Ji,"_max",2048),a(Ji,"_mask",Ji._max-1);let su=Ji;const on=class on{constructor(e=new B,t=new B){a(this,"origin");a(this,"direction");this.origin=e,this.direction=t}set(e,t){return this.origin.copyFrom(e),this.direction.copyFrom(t),this}copyFrom(e){return this.origin.copyFrom(e.origin),this.direction.copyFrom(e.direction),this}at(e,t=new B){return t.copyFrom(this.direction).multiplyScalar(e).add(this.origin)}recast(e){const t=on._tempVec3A;return this.origin.copyFrom(this.at(e,t)),this}closestPointToPoint(e,t=new B){const i=t;i.subVectors(e,this.origin);const n=i.dot(this.direction);return n<0?i.copyFrom(this.origin):i.copyFrom(this.direction).multiplyScalar(n).add(this.origin)}distanceToPoint(e){const t=on._tempVec3A,i=t.subVectors(e,this.origin).dot(this.direction);return i<0?this.origin.distanceTo(e):(t.copyFrom(this.direction).multiplyScalar(i).add(this.origin),t.distanceTo(e))}isIntersectionSphere(e){return this.distanceToPoint(e.center)<=e.radius}intersectSphere(e,t=new B){const i=on._tempVec3A;i.subVectors(e.center,this.origin);const n=i.dot(this.direction),r=i.dot(i)-n*n,o=e.radius*e.radius;if(r>o)return;const l=Math.sqrt(o-r),c=n-l,d=n+l;if(!(c<0&&d<0))return c<0?this.at(d,t):this.at(c,t)}isIntersectionPlane(e){const t=e.distanceToPoint(this.origin);return t===0||e.normal.dot(this.direction)*t<0}distanceToPlane(e){const t=e.normal.dot(this.direction);if(t==0)return e.distanceToPoint(this.origin)==0?0:void 0;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:void 0}intersectPlane(e,t=new B){const i=this.distanceToPlane(e);if(i!==void 0)return this.at(i,t)}isIntersectionBox(e){const t=on._tempVec3A;return this.intersectBox(e,t)!==void 0}intersectBox(e,t=new B){let i,n,r,o,l,c;const d=1/this.direction.x,u=1/this.direction.y,h=1/this.direction.z,f=this.origin;if(d>=0?(i=(e.min.x-f.x)*d,n=(e.max.x-f.x)*d):(i=(e.max.x-f.x)*d,n=(e.min.x-f.x)*d),u>=0?(r=(e.min.y-f.y)*u,o=(e.max.y-f.y)*u):(r=(e.max.y-f.y)*u,o=(e.min.y-f.y)*u),!(i>o||r>n)&&((r>i||i!==i)&&(i=r),(o<n||n!==n)&&(n=o),h>=0?(l=(e.min.z-f.z)*h,c=(e.max.z-f.z)*h):(l=(e.max.z-f.z)*h,c=(e.min.z-f.z)*h),!(i>c||l>n)&&((l>i||i!==i)&&(i=l),(c<n||n!==n)&&(n=c),!(n<0))))return this.at(i>=0?i:n,t)}intersectTriangle(e,t,i,n=!1,r=new B){const o=on._tempVec3A,l=on._tempVec3B,c=on._tempVec3C,d=on._tempVec3D;l.subVectors(t,e),c.subVectors(i,e),d.crossVectors(l,c);let u=this.direction.dot(d),h;if(u>0){if(n)return;h=1}else if(u<0)h=-1,u=-u;else return;o.subVectors(this.origin,e);const f=h*this.direction.dot(c.crossVectors(o,c));if(f<0)return;const p=h*this.direction.dot(l.cross(o));if(p<0||f+p>u)return;const m=-h*o.dot(d);if(!(m<0))return this.at(m/u,r)}applyMatrix4(e){return e.affineTransformPoint3(this.direction.add(this.origin)),e.affineTransformPoint3(this.origin),this.direction.sub(this.origin),this.direction.normalize(),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new on().copyFrom(this)}};a(on,"_tempVec3A",new B),a(on,"_tempVec3B",new B),a(on,"_tempVec3C",new B),a(on,"_tempVec3D",new B);let Rc=on;class Lt{constructor(e=0,t=0,i=0,n=1){a(this,"x");a(this,"y");a(this,"z");a(this,"w");this.x=e,this.y=t,this.z=i,this.w=n}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){e==0?this.x=t:e==1?this.y=t:e==2?this.z=t:this.w=t}getComponent(e){return e==0?this.x:e==1?this.y:e==2?this.z:this.w}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==void 0?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,r=this.w,o=e.elements;return this.x=o[0]*t+o[4]*i+o[8]*n+o[12]*r,this.y=o[1]*t+o[5]*i+o[9]*n+o[13]*r,this.z=o[2]*t+o[6]*i+o[10]*n+o[14]*r,this.w=o[3]*t+o[7]*i+o[11]*n+o[15]*r,this}divideScalar(e){if(e!==0){const t=1/e;this.x*=t,this.y*=t,this.z*=t,this.w*=t}else this.x=0,this.y=0,this.z=0,this.w=1;return this}min(e){return this.x=this.x>e.x?e.x:this.x,this.y=this.y>e.y?e.y:this.y,this.z=this.z>e.z?e.z:this.z,this.w=this.w>e.w?e.w:this.w,this}max(e){return this.x=this.x<e.x?e.x:this.x,this.y=this.y<e.y?e.y:this.y,this.z=this.z<e.z?e.z:this.z,this.w=this.w<e.w?e.w:this.w,this}clamp(e,t){return this.x=this.x<e.x?e.x:this.x>t.x?t.x:this.x,this.y=this.y<e.y?e.y:this.y>t.y?t.y:this.y,this.z=this.z<e.z?e.z:this.z>t.z?t.z:this.z,this.w=this.w<e.w?e.w:this.w>t.w?t.w:this.w,this}clampScalar(e,t){return this.x=this.x<e?e:this.x>t?t:this.x,this.y=this.y<e?e:this.y>t?t:this.y,this.z=this.z<e?e:this.z>t?t:this.z,this.w=this.w<e?e:this.w>t?t:this.w,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length())}setLength(e){const t=this.length();return t!==0&&e!==t&&this.multiplyScalar(e/t),this}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e),this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(){return[this.x,this.y,this.z,this.w]}clone(){return new Lt(this.x,this.y,this.z,this.w)}}class Lo{static vertexNormals(e,t){e.length%3;const i=e.length/3;t?t.length%3:i%3;const n=t?t.length/3:i/3,r=new Float32Array(e.length),o=new B,l=new B,c=new B,d=new B,u=new B;for(let h=0;h<n;h++){const f=t?t[h*3+0]*3:h*9+0,p=t?t[h*3+1]*3:h*9+3,m=t?t[h*3+2]*3:h*9+6;o.fromArray(e,f),l.fromArray(e,p),c.fromArray(e,m),d.subVectors(o,l),u.subVectors(c,l),u.cross(d),u.addToArray(r,f),u.addToArray(r,p),u.addToArray(r,m)}return Lo.normalizeVectors(r),r}static normalizeVectors(e){const t=new B;for(let i=0;i<e.length;i+=3)t.fromArray(e,i),t.normalize(),t.fillArray(e,i)}static normalsToSpherical(e,t=!1){e.length%3;const i=e.length/3,n=t?new Int16Array(i*2):new Int8Array(i*2);for(let r=0;r<i;r+=1){const o=e[r*3+0],l=e[r*3+1],c=e[r*3+2],d=(Math.acos(c)/Math.PI-.5)*2,u=Math.atan2(l,o)/Math.PI;n[r*2+0]=Ws(d),n[r*2+1]=Ws(u)}return n}}function ru(s){const e={};return s&&s.substring(1).split("&").forEach(function(t){const i=t.indexOf("=");i>=0?e[t.substring(0,i)]=t.substring(i+1):e[t]=void 0}),e}function Ic(){return ru(window.location.hash)}function ut(s){return s in Ic()}function Dc(s){const e=Ic();return s in e&&e[s]!==void 0?decodeURI(e[s]):null}function Wg(s){const e=Ic();return Object.keys(e).filter(t=>t!==s).map(function(t){const i=e[t];return t+(i===void 0?"":"="+i)}).join("&")}function jg(s){return s in ru(window.location.search)}const D={ASSETS_URL:"./",EDIT_MODE:jg("editor"),NO_SCREENSHOTS:ut("noscreenshots"),DEBUG:ut("debug")||ut("benchmark"),DEBUG_WEBGL:ut("debugwebgl"),DEBUG_WEBGL_ERROR:ut("debugwebgl_error"),DEBUG_WEBGL_CALL:ut("debugwebgl_call"),DEBUG_SPECTOR:ut("debugspector"),DEBUG_UI:ut("debugui"),BENCHMARK:ut("benchmark"),BENCHMARK_OUTPUT:Dc("benchmark_output"),BENCHMARK_MEASUREMENTS:Dc("benchmark_measurements"),BENCHMARK_LIST_ALL:ut("benchmark_list_all"),DEBUG_SHARED_BUFFERS:ut("debugbuffers"),DEBUG_CAMERA_PATH:ut("debugcamerapath"),DEBUG_GEOMETRY_MERGING:ut("debugmerge"),DEBUG_VIEW_MODES:!1,PUPPETEER_TEST:ut("puppeteer_test"),SHOW_INTERNAL_VIEWS:ut("internalviews"),ALWAYS_RENDER:ut("alwaysrender")||ut("dev_new_renderer"),WEAK_REFLECTION_SHADOW:ut("weak_reflection_shadow"),LOG_INFO:ut("log")||ut("savelog"),LOG_TO_SERVER:ut("savelog"),LOG_TIME:!1,PROGRESSIVE_LOADER_AFTER_SEC:30,CONTEXT_LOST_RESTORE_LIMIT:4,RETRIES_ON_LOAD_ERROR:3,FORCE_FXAA:ut("fxaa"),FORCE_MOTION_BLUR:ut("motionblur"),FORCE_WEBGL1:ut("webgl1"),FONT_FAMILIES_TO_LOAD:[],MAX_TWO_POINTERS_IN_LINE_DIFF:40,CAMERA_WALK_NEAR:.01,CAMERA_ORBIT_NEAR_FROM_1M:.01,CAMERA_MIN_FAR:100,SKY_DISTANCE_TO_SCENE:100,CAMERA_DEFAULT_FOV:70,CAMERA_ORTHO_FRUSTUM_SIZE:20,CAMERA_DEFAULT_MOVE_MAX_SPEED:1.11,CAMERA_MOVE_MAX_SPEED_SHIFT_FACTOR:2,CAMERA_LOOK_SPEED:Math.PI/1500,CAMERA_LOOK_SMOOTHING:.1,CAMERA_ARROWS_TURN_SPEED:Math.PI/2,CAMERA_SCROLL_SPEED:.5,CAMERA_FULL_ACCELERATION_TIME:.5,CAMERA_FULL_DECELERATION_TIME:.166,CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE:1,CAMERA_FIXED_HEIGHT:null,MAX_GROUND_SEARCH_DEPTH:5.5,MATERIAL_PICKER_BALL_MAX_SIZE:.1,COVER_JSON_URL:"./cover.json",AUTO_TOUR_IN_VIEW_STILL_TIME_MS:3e3,CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE:.7,CLICK_MOVE_SHOW_TARGET_INDICATOR:!ut("nomovetarget"),KEY_MOVE_MIN_DISTANCE_TO_OBSTACLE:.1,MIN_DISTANCE_TO_CEILING:.1,LIGHT_PROBE_MIRROR_SIZE:512,LIGHT_PROBE_MAX_MIP_SIZE:128,LIGHT_PROBE_MIN_MIP_SIZE:4,LIGHT_PROBE_GLOSS_FOR_MIP:[.99,.9,.85,.7,.4,.25],DEBUG_LIGHT_PROBE_MIPS:!1,ENABLE_AUTO_EXPOSURE_CONTROLS:!1,EDITOR_COVER_WIDTH:1920,EDITOR_COVER_HEIGHT:1080,MAX_PANORAMA_SIZE:8192,OBJECT_VISIBILITY_TARGET_SIZE:128,DEFAULT_SKY_NAME:"default",EDITOR_CONTROLLED_SKY_NAME:"sky0",EDITOR_SELECTION_COLOR:new Re(5021401).convertGammaToLinear(),ALLOW_MOBILE_VR:!0,FALLBACK_CAMERA_HEIGHT:1.6,LOAD_PRIORITY:{CORE_RESOURCE:0,COLORMAP:1,UV0:1,DIFFUSE:2,LIGHTMAP:3,SKY:4,SPECULARITY:5,VIDEO:6},MERGE_TRANSPARENT_DISABLED:ut("nomergetransparent"),urlHashContains:ut,urlHashGetArgument:Dc,urlHashRemoveArgument:Wg,TELEPORT_TO_VIEW_MAX_TIME:3,TELEPORT_TO_POINT_MAX_TIME:4.5,TELEPORT_PATH_MAX_TIME:6,TELEPORT_TO_VIEW_ACCELERATION:4,TELEPORT_TO_POINT_ACCELERATION:2,TELEPORT_PATH_ACCELERATION:2,GAZE_POINTER_SHOW_LOADING_AFTER_S:2.5,GAZE_POINTER_ACTIVATE_AFTER_S:4.5,SPRITE_ANCHOR_FONT_SIZE:128,POINTER_PRIORITY:{TRANSFORM_CONTROLS:1,EDITOR_SELECTOR:2,INTERACTION_DISPATCHER:3},AVATAR_COLORS:["#f44336","#e81e63","#9c27b0","#673ab7","#3f51b5","#2196f3","#03a9f4","#00bcd4","#009688","#4caf50","#8bc34a","#cddc39","#ffeb3b","#ffc107","#ff9800","#ff5722","#795548","#9e9e9e","#607d8b","#ff5084"],STRINGS:{},DEFAULT_LANGUAGE:"English",ENABLE_MINIMAP:!0,FLIP_MOUSE:ut("flipmouse"),AUTO_PLAY:ut("autoplay"),HIDE_PLAY:ut("hideplay"),SHOW_HELP_ON_LOAD:ut("help"),GAZE_IN_POINTER_LOCK:ut("gazeinpointerlock"),NO_GAZE_TELEPORT:ut("nogazeteleport"),VR_LO:ut("vrlo"),VR_HI:ut("vrhi"),MOBILE_HI:ut("mobilehi"),NO_BASIS:ut("nobasis"),ENABLE_REFLECTION_PROBES_BLENDING:!0,MAX_BLENDED_REFLECTION_PROBES:3,DEV_NEW_RENDER_ARCHITECTURE:ut("dev_new_renderer"),DEV_DISABLE_UNIFORM_BUFFERS:!ut("dev_new_renderer"),DEV_NEW_SCENE:ut("dev_new_scene"),DEV_MATERIALX:ut("dev_materialx"),PROFILER_ENABLED:ut("profiler"),LIGHT_PROBE_MIPS_COUNT:0};D.LIGHT_PROBE_MIPS_COUNT=Ug(D.LIGHT_PROBE_MIN_MIP_SIZE,D.LIGHT_PROBE_MAX_MIP_SIZE);class Xg{constructor(e=!0){a(this,"_startTime",0);a(this,"_oldTime",0);a(this,"_elapsedTime",0);a(this,"_running",!1);a(this,"_autoStart");a(this,"_timer");this._autoStart=e,this._timer=self.performance!==void 0&&self.performance.now!==void 0?self.performance:Date}isRunning(){return this._running}start(){this._startTime=this._timer.now(),this._oldTime=this._startTime,this._running=!0}stop(){this.getElapsedTime(),this._running=!1}getElapsedTime(){return this.getDelta(),this._elapsedTime}getDelta(){let e=0;if(this._autoStart&&!this._running&&this.start(),this._running){const t=this._timer.now();e=.001*(t-this._oldTime),this._oldTime=t,this._elapsedTime+=e}return e}}const qg=854;/*!
 * Copyright (C) 2014-present Shapespark
 */function Ja(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;t+=1)if(s[t]!==e[t])return!1;return!0}function el(s){setTimeout(s,0)}function Lc(s,e){if(s.length===0)return;let t=0,i=e(s[0]);for(let n=1;n<s.length;n+=1){const r=e(s[n]);r>i&&(t=n,i=r)}return t}function zi(s,e){const t=e.indexOf(s);return console.assert(t!==-1),e.splice(t,1)}function Yg(s,e){const t=e.indexOf(s);return t!==-1?e.splice(t,1):[]}function tl(s,e,t){const i=s.indexOf(e),n=t>i?1:-1;for(let r=i;r!==t;r+=n)s[r]=s[r+n];s[t]=e}function Fc(s,e,t){for(let i=0;i<e.length;i+=1){const n=e[i],r=s[n];r!==void 0&&(t[n]=r)}}const Oc=Math.PI*2;function Vt(s){return s%=Oc,s>Math.PI?-Oc+s:s<-Math.PI?Oc+s:s}function ou(s,e){return Math.atan2(-(e.x-s.x),e.y-s.y)}function Zr(s,e){s.textContent!==void 0?s.textContent=e:console.warn("textContent and innerText properties are missing")}function au(s){return s.ctrlKey||s.altKey||s.metaKey}function il(s){const e=new Image;return e.src=s,e}function lu(s,e){if(s.readyState>=s.HAVE_CURRENT_DATA){e(s);return}function t(){s.readyState>=s.HAVE_CURRENT_DATA&&(s.removeEventListener("playing",t),s.removeEventListener("timeupdate",t),e(s))}s.addEventListener("playing",t),s.addEventListener("timeupdate",t)}function Mn(s){return JSON.parse(JSON.stringify(s))}function Fo(s){return typeof s=="object"?Object.freeze(Mn(s)):s}function Oo(s,e){if(s===e)return!0;if(typeof s!="object"||s===null||typeof e!="object"||e===null||Object.keys(s).length!==Object.keys(e).length)return!1;for(const t of Object.keys(s))if(!Object.prototype.hasOwnProperty.call(e,t)||!Oo(s[t],e[t]))return!1;return!0}function Qg(){const s=document.getElementsByTagName("script");for(const e of s)if(e.src.includes("walk.min.js"))return e.src.split("/").slice(0,-1).join("/")+"/";return console.error("Cannot determine webwalk URL."),"/webwalk/"}function gi(s){return Qg()+s}const Bc={FontAwesomeSolid:"",FontAwesomeRegular:"",FontAwesomeBrands:""};function cu(s,e,t){if(s.length===0){e();return}const i={};s.forEach(l=>{tt(Bc[l],"Font "+JSON.stringify(l)+" is not supported."),i[l]=Bc[l]});let n=0,r=0;function o(l){l?++n:++r,n+r===s.length&&(r===0?e():t&&t())}WebFont.load({custom:{families:s,testStrings:i},timeout:1e4,fontactive:function(){o(!0)},fontinactive:function(l){console.error("Cannot load font: "+l),o(!1)}})}function Bo(s){return s.startsWith("extra-assets/")?D.ASSETS_URL+s:D.ASSETS_URL+"extra-assets/"+s}function No(...s){}const Nc=()=>({lineColor:new Re(0),highlightColor:D.EDITOR_SELECTION_COLOR,lightmapResolutionLineColor:new Re(170),autoLightmapResolutionLineColor:new Re(43690),meshSelectedLineColor:new Re(47872),meshSelectedSecondaryLineColor:new Re(13404160),wireframeModeClearColor:new Re(16777215)});function Kg(s,e,t){let i=0,n=s.length;for(;i<n;){const r=i+n>>>1;t(s[r],e)===-1?i=r+1:n=r}return i}function xs(s){return window.TouchEvent&&s instanceof TouchEvent}const Zg=500,$g=5e3,Xs=[];let nl=0,kc,ko=0;function sl(s,e){let t=s.toString();for(;t.length<e;)t="0"+t;return t}function Jg(){const s=new Date;return sl(s.getHours(),2)+":"+sl(s.getMinutes(),2)+":"+sl(s.getSeconds(),2)+","+sl(s.getMilliseconds(),3)}function hu(){ko!==0&&(Xs[Xs.length-1]+=" ["+(ko+1).toString()+" copies]",ko=0)}function e_(s,e,t){if(kc===t){ko+=1;return}if(Xs.length>=Zg-1){nl+=1;return}hu(),kc=t;const i=s+e.toUpperCase()+" "+t;Xs.push(i),Xs.length==1&&setTimeout(t_,$g)}function t_(){hu(),nl>0&&Xs.push("[truncated, removed lines "+nl.toString()+"]"),qs("./logs","application/json",JSON.stringify({logs:Xs})),Xs.length=0,kc=void 0,nl=0,ko=0}function rl(s){const e=console[s].bind(console);console[s]=function(){let t="",i="";for(let n=0;n<arguments.length;++n)i+=(n===0?"":" ")+arguments[n];D.LOG_TIME&&(t=Jg()+" "),e_(t,s,i),e(t+i)}}function i_(){window.onerror=function(s,e,t,i,n){const r="Error occured: "+s+" ("+e+"#"+t.toString()+":"+i.toString()+"/"+n+")";return console.error(r),!1}}class n_{constructor(){this.log=No}logInfoMessages(){this.log=function(...e){console.log(...e)}}}const Le=new n_;function Uc(s){s&&(rl("log"),rl("info")),rl("warn"),rl("error"),i_()}D.LOG_INFO&&Le.logInfoMessages(),D.LOG_TO_SERVER&&Uc(!0);class s_{constructor(){a(this,"https");a(this,"localhost");a(this,"ipad");a(this,"mobile");a(this,"ios");a(this,"android");a(this,"facebookApp");a(this,"whatsApp");a(this,"inCrossOriginIframe");a(this,"firefox");a(this,"opera");a(this,"ie");a(this,"edge");a(this,"safari");a(this,"mac");a(this,"chromeVersion");a(this,"browserName");a(this,"basisDecodeWorkers");a(this,"webp",!0);a(this,"_gl");a(this,"_gpuInfo",null);this._asyncDetectGpuSupport(),this._asyncDetectWebpSupport(),this.https=window.location.protocol==="https:",this.localhost=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1",this.ipad=/iPad/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,this.mobile=/mobile|ip(hone|od)|android|silk/i.test(navigator.userAgent)||this.ipad||D.urlHashContains("mobile"),this.ios=/iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream||this.ipad,this.android=/Android/.test(navigator.userAgent),this.facebookApp=/FBAN|FBAV/.test(navigator.userAgent),this.whatsApp=/WhatsApp/.test(navigator.userAgent);function e(o){const l=document.createElement("a");return l.href=o,l.protocol+"//"+l.host}this.inCrossOriginIframe=function(){const o=window.self!==window.top,l=e(document.referrer),c=e(window.location.href);return o&&l!==c}();function t(o,l){const c=o.toLowerCase(),d=l.toLowerCase();return c.indexOf(d)!==-1}function i(o){return!navigator||!navigator.userAgent?!1:t(navigator.userAgent,o)}function n(o){return!navigator||!navigator.appVersion?!1:t(navigator.appVersion,o)}this.firefox=i("firefox"),this.opera=i("opera")||i("OPR/"),this.ie=i("msie")||n("trident/"),this.edge=i("edge/"),this.safari=i("safari/")&&!(i("chrome/")||i("chromium/")),this.mac=i("macintosh")&&!this.ipad;const r=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);this.chromeVersion=r?parseInt(r[2],10):void 0,this.browserName=this.firefox?"firefox":this.opera?"opera":this.ie?"ie":"chrome",this.browserName=this.edge?"edge":this.safari?"safari":this.browserName,this.basisDecodeWorkers=this.safari||this.ios?0:Math.min(4,navigator.hardwareConcurrency||4)}get gl(){return this._gl,this._gl}_asyncDetectGpuSupport(){const e=navigator.gpu;if(!e)return;e.requestAdapter({powerPreference:"high-performance"}).then(i=>i?i.requestAdapterInfo():null).then(i=>this._gpuInfo=i)}_asyncDetectWebpSupport(){const e="UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==",t=new Image;t.onload=()=>this.webp=t.width>0&&t.height>0,t.onerror=()=>this.webp=!1,t.src="data:image/webp;base64,"+e}fullScreenSupported(){const e=document;if(e.fullscreenEnabled!==void 0||e.webkitFullscreenEnabled!==void 0||e.mozFullScreenEnabled!==void 0||e.msFullscreenEnabled!==void 0)return!!(e.fullscreenEnabled||e.webkitFullscreenEnabled||e.mozFullScreenEnabled||e.msFullscreenEnabled);const t=document.body;return t.mozRequestFullScreen!==void 0||t.webkitRequestFullscreen!==void 0||t.msRequestFullscreen!==void 0||t.requestFullscreen!==void 0}pointerLockSupported(){const e=document;return!this.mobile&&!this.opera&&(document.pointerLockElement!==void 0||e.mozPointerLockElement!==void 0||e.webkitPointerLockElement!==void 0)}resetGlDetector(e){this._gl=new r_(e,this)}getPlatformInfo(){const t=function(r,o){return r.length>o&&(r=r.substring(0,o)),r=r.replace(/[^0-9a-zA-Z() .]/gi,""),encodeURI(r)},i=navigator.connection,n=this._gpuInfo;return{renderApi:n?3:this.gl.webgl2?2:1,webglVendor:this.gl.vendor?t(this.gl.vendor,32):"",webglRenderer:this.gl.renderer?t(this.gl.renderer,128):"",webgpuVendor:n?t(n.vendor,32):"",webgpuArch:n?t(n.architecture,64):"",width:Math.round(window.innerWidth/10)*10,height:Math.round(window.innerHeight/10)*10,dpr:window.devicePixelRatio,cpuCores:navigator.hardwareConcurrency,webp:this.webp?1:0,version:qg,browser:this.browserName,chromeVersion:this.chromeVersion,downloadSpeed:i==null?void 0:i.downlink,roundTripTime:i==null?void 0:i.rtt}}missingCapabilities(){this._gl;let e=null;const t=i=>{e=e?e+", "+i:i};return this._gl.webgl2||t("WebGL2 is not supported"),this._gl.maxTextureSize<4096&&t("4096x4096 textures are not supported"),this.webp||t("WebP format is not supported"),e?`Your GPU/browser does not have sufficient capabilities: ${e}.<br>Try opening this page on a different device.`:null}}class r_{constructor(e,t){a(this,"webgl2");a(this,"antialiasNative");a(this,"antialiasSamples");a(this,"antialiasPostprocess");a(this,"colorBufferFloat");a(this,"maxAnisotropy");a(this,"fragmentPrecision");a(this,"maxTextureSize");a(this,"maxRenderBufferSize");a(this,"vendor");a(this,"renderer");a(this,"dxtTextures");a(this,"pvrtcTextures");a(this,"etc1Textures");a(this,"astcTextures");a(this,"disableTextureSlotReuse");a(this,"_extensionCache",new Map);a(this,"_glCtx");var o;this._glCtx=e;const i=typeof WebGL2RenderingContext!="undefined"&&e instanceof WebGL2RenderingContext;this.webgl2=i,this.antialiasNative=!!((o=e.getContextAttributes())!=null&&o.antialias&&e.getParameter(e.SAMPLES)>1),this.antialiasSamples=e.getParameter(e.SAMPLES),this.antialiasPostprocess=!t.mobile,this.colorBufferFloat=this.extension("EXT_color_buffer_float");const n=this.extension("EXT_texture_filter_anisotropic");this.maxAnisotropy=n!==void 0?e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.fragmentPrecision=(()=>{if(e.getShaderPrecisionFormat===void 0)return"highp";const l=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT);if(l&&l.precision>0)return"highp";const c=e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT);return c&&c.precision>0?"mediump":"lowp"})(),this.maxRenderBufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE);const r=e.getExtension("WEBGL_debug_renderer_info");r&&(this.vendor=e.getParameter(r.UNMASKED_VENDOR_WEBGL),this.renderer=e.getParameter(r.UNMASKED_RENDERER_WEBGL)),this.dxtTextures=(()=>{if(D.urlHashContains("nodxt"))return!1;const l=this.extension("WEBGL_compressed_texture_s3tc"),c=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS);let d=!1,u=!1;if(l)for(let h=0;h<c.length;h+=1)d=d||c[h]===l.COMPRESSED_RGB_S3TC_DXT1_EXT,u=u||c[h]===l.COMPRESSED_RGBA_S3TC_DXT5_EXT;return d&&u})(),this.pvrtcTextures=(()=>D.urlHashContains("nopvr")?!1:!!this.extension("WEBGL_compressed_texture_pvrtc"))(),this.etc1Textures=(()=>D.urlHashContains("noetc1")?!1:!!this.extension("WEBGL_compressed_texture_etc1")&&t.mobile)(),this.astcTextures=(()=>!1)(),this.disableTextureSlotReuse=t.mac||t.chromeVersion===83}extension(e){let t=this._extensionCache.get(e);if(t!==void 0)return t;switch(e){case"EXT_texture_filter_anisotropic":t=this._glCtx.getExtension("EXT_texture_filter_anisotropic")||this._glCtx.getExtension("MOZ_EXT_texture_filter_anisotropic")||this._glCtx.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":t=this._glCtx.getExtension("WEBGL_compressed_texture_s3tc")||this._glCtx.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||this._glCtx.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":t=this._glCtx.getExtension("WEBGL_compressed_texture_pvrtc")||this._glCtx.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:t=this._glCtx.getExtension(e)}return t===null&&(t=void 0),t!==void 0&&this._extensionCache.set(e,t),t}reportToConsole(){const e="WebGL"+(this.webgl2?"2":"");Le.log(e+"; "+this.fragmentPrecision+" fragment precision."),this.dxtTextures||Le.log("DXT textures not supported."),this.antialiasNative?Le.log("Native anti-aliasing supported with "+this.antialiasSamples+" samples."):Le.log("Native anti-aliasing not supported"),this.disableTextureSlotReuse&&Le.log("WebGL texture slot reuse disabled.")}}const it=new s_;class kt{constructor(){a(this,"_listeners")}apply(e){e.addEventListener=kt.prototype.addEventListener,e.hasEventListener=kt.prototype.hasEventListener,e.removeEventListener=kt.prototype.removeEventListener,e.dispatchEvent=kt.prototype.dispatchEvent}addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const n=this._listeners[e];if(n!==void 0){const r=n.indexOf(t);r!==-1&&n.splice(r,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const i=this._listeners[e.type];if(i!==void 0){e.target=this;const n=[],r=i.length;for(let o=0;o<r;o++)n[o]=i[o];for(let o=0;o<r;o++)n[o].call(this,e)}}}/*!
 * Copyright (C) 2021-present Shapespark
 */const _i={help:{basic:"BASIC",advanced:"ADVANCED",mouse:"Mouse",or:"or",keyboard:"Keyboard",vrTeleport:"VR teleport",holdLeftButton:"Hold the left button",clickLeftButton:"Click the left button",lookAround:"Look around",walkToClickedPlace:"Walk to the clicked place",selectMaterialLightObject:"Select material, light, object",scroll:"Scroll",walkStraight:"Walk straight",walkStraightAndLookAround:"Walk straight and look around",walkStraightAndSideways:"Walk straight and sideways",changeHeight:"Change height",switchView:"Switch view",screenshot:"Screenshot",illuminationPreview:"Illumination preview",hideShowMenu:"Hide/show menu",hideShowMousePointer:"Hide/show mouse pointer",vrMode:"VR Mode",gazeAtFixedPlace:"Gaze at a fixed place",clickControllerButton:"Click a controller button",teleport:"Teleport",touch:"Touch",interactiveDesktop:"Click and drag to look around",interactiveMobile:"Drag to look around"},meetings:{and:"and",close:"Close",cancel:"Cancel",error:"Error",join3dMeeting:"Join 3D meeting",name:"Name",camera:"Camera",microphone:"Microphone",networkIssuesDetected:"Network issues detected.",diagnoseConnection:"Diagnose your connection.",byJoiningYouAgreeTo:"By joining, you agree to the",termsOfService:"Terms of Service",privacyPolicy:"Privacy Policy",infrastructureProvidedUnderTos:"The 3D meeting infrastructure is provided by Shapespark under the following Terms of Service",infrastructureProvidedUnderPp:"The 3D meeting infrastructure is provided by Shapespark under the following Privacy Policy",testCamera:"Test camera",join:"Join",devicesNotFound:{microphone:"Microphone not found",camera:"Camera not found",microphoneAndCamera:"Microphone and camera not found"},devicesBlocked:{microphone:"Microphone blocked",camera:"Camera blocked",microphoneAndCamera:"Microphone and camera blocked"},devicesNotAvailable:{microphone:"Microphone not available",camera:"Camera not available",microphoneAndCamera:"Microphone and camera not available"},checkIfDevicesConnected:{microphone:"Check if your microphone is properly connected.",camera:"Check if your camera is properly connected.",microphoneAndCamera:"Check if your microphone and camera are properly connected."},unblockDevices:{byButtons:{oneDevice:{beforeIcons:"Unblock it by clicking the",afterIcons:"button."},twoDevices:{beforeIcons:"Unblock them by clicking",afterIcons:"buttons."}},inBrowserSettings:{oneDevice:"Unblock it in the browser settings for this webpage.",twoDevices:"Unblock them in the browser settings for this webpage."},byButtonInAddressBar:{oneDevice:{beforeIcon:"Unblock it by clicking the",afterIcon:"button in the browser's address bar and refresh the webpage."},twoDevices:{beforeIcon:"Unblock them by clicking the",afterIcon:"button in the browser's address bar and refresh the webpage."}}},browserDoesNotSupportMeetings:"Your browser doesn't support video meetings. Open the meeting link in another browser.",ifConnectedCloseAppsAndRefresh:{oneDevice:"If it is connected, close all other applications using it and refresh the webpage.",twoDevices:"If they are connected, close all other applications using them and refresh the webpage."},me:"me",pointPlace:"Point a place by clicking.",doYouWantToLeaveMeeting:"Do you want to leave this meeting?",leaveMeeting:"Leave meeting",youHaveLeftMeeting:"You have left the meeting",joinAgain:"Join again",connectionLost:"Meeting connection lost.",code:"Code",meetingEnded:"The meeting has ended.",meetingEndedMaximumDurationReached:"The meeting has ended. Maximum duration of meeting reached.",failedToLoadMeeting:"Failed to load the meeting",failedToJoinMeeting:"Failed to join the meeting. Is your link valid?"}};/*!
 * Copyright (C) 2021-present Shapespark
 */const o_={help:pn(zt({},_i.help),{basic:"基本",advanced:"高级",mouse:"滑鼠",or:"或",keyboard:"键盘",vrTeleport:"VR 传送",holdLeftButton:"按住左键",clickLeftButton:"单按左键",lookAround:"调整视角",walkToClickedPlace:"走去指定地点",selectMaterialLightObject:"选择材质，灯光，物体",scroll:"滑轮",walkStraight:"直走",walkStraightAndLookAround:"调整视角",walkStraightAndSideways:"移动",changeHeight:"调整高度",switchView:"移动至指定视角",screenshot:"截图",illuminationPreview:"照明预览",hideShowMenu:"隐藏/显示菜单",hideShowMousePointer:"隐藏/显示鼠标",vrMode:"VR 模式",gazeAtFixedPlace:"凝视一个固定的地方",clickControllerButton:"单击控制器按钮",teleport:"传送",touch:"触碰"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const a_={help:pn(zt({},_i.help),{basic:"GRUNDLAGEN",advanced:"ERWEITERT",mouse:"Maus",or:"oder",keyboard:"Tastatur",vrTeleport:"VR-Teleport",holdLeftButton:"Linke Maustaste gedrückt halten",clickLeftButton:"Klick auf die linke Maustaste",lookAround:"Umschauen",walkToClickedPlace:"Zum angeklickten Punkt bewegen",selectMaterialLightObject:"Material, Licht, Objekt auswählen",scroll:"Mausrad",walkStraight:"Geradeaus gehen",walkStraightAndLookAround:"Geradeaus gehen und umsehen",walkStraightAndSideways:"Geradeaus und seitwärts gehen",changeHeight:"Höhe ändern",switchView:"Ansicht wechseln",screenshot:"Bildschirmfoto",illuminationPreview:"Beleuchtungsvorschau",hideShowMenu:"Menü aus- / einblenden",hideShowMousePointer:"Mauszeiger aus-/einblenden",vrMode:"VR-Modus",gazeAtFixedPlace:"Blick auf einem Punkt fixieren",clickControllerButton:"Controller Taste drücken",teleport:"Teleportieren",touch:"Tippen"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const l_={help:pn(zt({},_i.help),{basic:"BÁSICO",advanced:"AVANZADO",mouse:"Ratón",or:"o",keyboard:"Teclado",vrTeleport:"Teletransporte VR",holdLeftButton:"Mantén presionado el botón izquierdo",clickLeftButton:"Haz clic en el botón izquierdo",lookAround:"Mira a tu alrededor",walkToClickedPlace:"Camina hasta el lugar donde hiciste clic",selectMaterialLightObject:"Selecciona material, luz, objeto",scroll:"Desplázate",walkStraight:"Camina en línea recta",walkStraightAndLookAround:"Camina en línea recta y mira a tu alrededor",walkStraightAndSideways:"Camina recto y de lado",changeHeight:"Cambiar altura",switchView:"Cambiar vista",screenshot:"Captura de pantalla",illuminationPreview:"Vista previa de iluminación",hideShowMenu:"Ocultar / mostrar menú",hideShowMousePointer:"Ocultar / mostrar el puntero del ratón",vrMode:"Modo VR",gazeAtFixedPlace:"Mira a un punto fijo",clickControllerButton:"Pulsa un botón del mando",teleport:"Teletransporte",touch:"Tocar"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2023-present Shapespark
 */const c_={help:pn(zt({},_i.help),{basic:"PERUS",advanced:"EDISTYNYT",mouse:"Hiiri",or:"tai",keyboard:"Näppäimistö",vrTeleport:"VR-teleportti",holdLeftButton:"Pidä vasenta painiketta alhaalla",clickLeftButton:"Klikkaa vasenta painiketta",lookAround:"Katso ympärillesi",walkToClickedPlace:"Kävele klikattuun paikkaan",selectMaterialLightObject:"Valitse materiaali, valo, objekti",scroll:"Vieritä",walkStraight:"Kävele suoraan",walkStraightAndLookAround:"Kävele suoraan ja katso ympärillesi",walkStraightAndSideways:"Kävele suoraan ja sivuttain",changeHeight:"Muuta korkeutta",switchView:"Vaihda näkymää",screenshot:"Kuvankaappaus",illuminationPreview:"Valaistuksen esikatselu",hideShowMenu:"Piilota/näytä valikko",hideShowMousePointer:"Piilota/näytä hiiren osoitin",vrMode:"VR-tila",gazeAtFixedPlace:"Tuijota kiinteään paikkaan",clickControllerButton:"Klikkaa ohjaimen painiketta",teleport:"Teleporttaus",touch:"Kosketa",interactiveDesktop:"Klikkaa ja raahaa katsellaksesi ympäri",interactiveMobile:"Raahaa katsellaksesi ympäri"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const h_={help:pn(zt({},_i.help),{basic:"BASIQUES",advanced:"AVANCÉS",mouse:"Souris",or:"ou",keyboard:"Clavier",vrTeleport:"Téléportation VR",holdLeftButton:"Maintenez le bouton gauche",clickLeftButton:"Cliquez sur le bouton gauche",lookAround:"Regardez autour",walkToClickedPlace:"Déplacez-vous jusqu’à l’endroit cliqué",selectMaterialLightObject:"Sélectionnez le matériel, la lumière, l’objet",scroll:"Défilement",walkStraight:"Allez tout droit",walkStraightAndLookAround:"Allez tout droit et regardez autour",walkStraightAndSideways:"Allez tout droit et de côté",changeHeight:"Changez la hauteur",switchView:"Changez de vue",screenshot:"Capture d’écran",illuminationPreview:"Aperçu de l’éclairage",hideShowMenu:"Masquer / Afficher le menu",hideShowMousePointer:"Masquer / Afficher le pointeur de la souris",vrMode:"Mode RV",gazeAtFixedPlace:"Fixez un endroit précis",clickControllerButton:"Appuyez sur un bouton du contrôleur",teleport:"Téléportation",touch:"Touchez"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2022-present Shapespark
 */const d_={help:pn(zt({},_i.help),{basic:"基本操作",advanced:"詳細操作",mouse:"マウス",or:"or",keyboard:"キーボード",vrTeleport:"VR テレポート",holdLeftButton:"左ボタンを長押し",lookAround:"見回す",clickLeftButton:"左ボタン",walkToClickedPlace:"クリックした場所に移動する",selectMaterialLightObject:"マテリアル、ライト、オブジェクトを選択",scroll:"スクロール",walkStraight:"前後移動",walkStraightAndLookAround:"前後移動して見回す",walkStraightAndSideways:"前後左右移動",changeHeight:"高さ調整",switchView:"ビュー切り替え",screenshot:"スクリーンショット",illuminationPreview:"イルミネーションプレビュー",hideShowMenu:"メニュー 表示/非表示",hideShowMousePointer:"マウスカーソル 表示/非表示",vrMode:"VR モード",gazeAtFixedPlace:"特定の場所を見る",clickControllerButton:"コントローラーボタンをクリックする",teleport:"テレポート",touch:"触る",interactiveDesktop:"クリック＆ドラッグして見回す",interactiveMobile:"ドラッグして見回す"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2022-present Shapespark
 */const u_={help:pn(zt({},_i.help),{basic:"기본 조작법",advanced:"상세 조작법",mouse:"마우스",or:"혹은",keyboard:"키보드",vrTeleport:"VR 이동",holdLeftButton:"좌측 버튼 드래그",clickLeftButton:"좌측 버튼 클릭",lookAround:"주변 둘러보기",walkToClickedPlace:"클릭한 곳으로 이동",selectMaterialLightObject:"재질, 조명, 사물 선택",scroll:"스크롤",walkStraight:"직진 이동",walkStraightAndLookAround:"직진 이동 / 주변 둘러보기",walkStraightAndSideways:"직진 이동 / 옆으로 이동",changeHeight:"높이 조절",switchView:"뷰 선택",screenshot:"스크린샷",illuminationPreview:"일루미네이션 프리뷰",hideShowMenu:"메뉴 On/Off",hideShowMousePointer:"마우스 포인터 On/Off",vrMode:"VR 모드",gazeAtFixedPlace:"특정 장소 바라보기",clickControllerButton:"컨트롤러 버튼 클릭",teleport:"텔레포트",touch:"터치"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const f_={help:pn(zt({},_i.help),{basic:"PODSTAWOWE",advanced:"ZAAWANSOWANE",mouse:"Myszka",or:"lub",keyboard:"Klawiatura",vrTeleport:"Teleportacja VR",holdLeftButton:"Przytrzymaj lewy przycisk",clickLeftButton:"Naciśnij lewy przycisk",lookAround:"Rozglądaj się",walkToClickedPlace:"Idź do naciśniętego miejsca",selectMaterialLightObject:"Wybierz materiał, światło, obiekt",scroll:"Przewiń",walkStraight:"Idź prosto",walkStraightAndLookAround:"Idź prosto i rozglądaj się",walkStraightAndSideways:"Idź prosto i na boki",changeHeight:"Zmień wysokość",switchView:"Zmień widok",screenshot:"Zrzut ekranu",illuminationPreview:"Podgląd oświetlenia",hideShowMenu:"Schowaj/pokaż menu",hideShowMousePointer:"Schowaj/pokaż kursor myszki",vrMode:"Tryb VR",gazeAtFixedPlace:"Patrz w ustalone miejsce",clickControllerButton:"Naciśnij przycisk kontrolera",teleport:"Teleportacja",touch:"Dotyk",interactiveDesktop:"Klikaj i przeciągaj, aby się rozglądać",interactiveMobile:"Przeciągaj, aby się rozglądać"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const p_={help:pn(zt({},_i.help),{basic:"BÁSICO",advanced:"AVANÇADO",mouse:"Mouse",or:"ou",keyboard:"Teclado",vrTeleport:"Teletransporte VR",holdLeftButton:"Mantenha pressionado o botão esquerdo",clickLeftButton:"Clique com o botão esquerdo",lookAround:"Olhe ao redor",walkToClickedPlace:"Ande até o lugar que foi clicado",selectMaterialLightObject:"Selecione material, luz, objeto",scroll:"Rolagem",walkStraight:"Ande em frente",walkStraightAndLookAround:"Ande em frente e olhe ao redor",walkStraightAndSideways:"Ande em frente e para os lados",changeHeight:"Variar altura",switchView:"Alternar entre cenas",screenshot:"Captura de imagem",illuminationPreview:"Visualização de iluminação",hideShowMenu:"Ocultar/mostrar menu",hideShowMousePointer:"Ocultar/mostrar a seta do mouse",vrMode:"Modo VR",gazeAtFixedPlace:"Olhe para um lugar fixo",clickControllerButton:"Clique num botão controlador",teleport:"Teletransporte",touch:"Toque",interactiveDesktop:"Clique e arraste para olhar ao redor",interactiveMobile:"Arraste para olhar ao redor"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2021-present Shapespark
 */const m_={help:pn(zt({},_i.help),{basic:"Basit",advanced:"İleri Düzey",mouse:"Fare",or:"veya",keyboard:"Klavye",vrTeleport:"VR Işınlanma",holdLeftButton:"Sol tuşa basılı tut",clickLeftButton:"Sol tuşa tıkla",lookAround:"Çevrene bak",walkToClickedPlace:"Tıkladığın alana yürü",selectMaterialLightObject:"Materyal, ışık veya obje seç",scroll:"Aşağı kaydır",walkStraight:"Düz yürü",walkStraightAndLookAround:"Düz yürü ve çevrene bakın",walkStraightAndSideways:"Düz ve yanlana doğru yürü",changeHeight:"Yükseklik değiştir",switchView:"Görünüm değiştir",screenshot:"Ekran Görüntüsü",illuminationPreview:"Aydınlatma önizlemesi",hideShowMenu:"Menüyü göster/gizle",hideShowMousePointer:"İmleci göster/gizle",vrMode:"VR Modu",gazeAtFixedPlace:"Bir noktaya kitlenerek bak",clickControllerButton:"Kumanda butonuna tıkla",teleport:"Işınlan",touch:"Dokun"}),meetings:zt({},_i.meetings)};/*!
 * Copyright (C) 2023-present Shapespark
 */const zc={Chinese:o_,German:a_,English:_i,Finnish:c_,French:h_,Japanese:d_,Korean:u_,Polish:f_,Portuguese:p_,Spanish:l_,Turkish:m_};/*!
 * Copyright (C) 2021-present Shapespark
 */const Vc=Mn(zc[D.DEFAULT_LANGUAGE]);function Ct(s){return`<span data-strings="${s}"></span>`}function g_(s){const e=s.split(".");let t=Vc;for(const i of e){if(!t||typeof t=="string")return;t=t[i]}if(typeof t=="string")return t}function Gc(s){const e=s.querySelectorAll("[data-strings]");for(let t=0;t<e.length;++t){const i=e.item(t),n=i.getAttribute("data-strings");if(!n)return;const r=g_(n);r&&(i.textContent=r)}}function mr(s,e){s.innerHTML=e,Gc(s)}function du(s){function e(t,i,n){Object.entries(i).forEach(([r,o])=>{const l=n===""?r:`${n}.${r}`,c=t[r];if(c===void 0){console.warn(`Viewer string ${l} doesn’t exist`);return}if(o==null){console.error(`${l} must be defined`);return}if(typeof c!=typeof o){console.error(`${l} should be ${typeof c}`);return}switch(typeof o){case"string":t[r]=o;break;case"object":e(t[r],o,l);break}})}e(Vc,s,""),Gc(document)}Gc(document);function __(){return Fo(Vc)}/*!
 * Copyright (C) 2014-present Shapespark
 */function v_(){this.hideInfo=function(){const e=document.getElementById("info-message");e.style.display="none"},this.info=function(e,t){const i=document.getElementById("info-message");mr(i,e),i.style.display="",setTimeout(this.hideInfo,t||15e3),console.info(e)},this.error=function(e){const t=document.getElementById("error-message");mr(t,e),t.style.display="",console.error(e)},this.errorWithQr=function(e){const t=document.getElementById("error-message");t.innerHTML=e+'<div><canvas id="qr-code-inner-canvas" height="180" width="180"></canvas></div>';const i=()=>{const n=document.getElementById("qr-code-inner-canvas");QRCode.toCanvas(n,window.location.toString()),t.style.display="",console.error(e)};gr(gi("lib/qrcode.js"),i,()=>Wt.error(e))},this.sceneLoadError=function(){const e=it.missingCapabilities();if(e){Wt.errorWithQr(e);return}let t="Scene failed to load. Reload the page to retry.";const i=it.whatsApp?"WhatsApp":it.facebookApp?"Facebook app":void 0;i&&(t=`Scene failed to load. Open the scene outside of ${i} by copying the link to the native web browser: <div class='message-scrollable-line'><a href='${window.location}' target='_blank'>${window.location}</a></div>`),this.error(t)}}const Wt=new v_;let Hc=!1,uu=!1;function b_(){uu=!0}const $r={NOT_NEEDED:0,TEST_NEEDED:1,NEEDED:2};function y_(){const s=new Set,e=new Map;function t(o){try{o()}catch(l){console.log(l)}}function i(o,l,c){const d=document.createElement("script");d.onload=l,d.onerror=c,d.src=o,d.type="text/javascript",d.crossOrigin="anonymous",document.body.appendChild(d)}function n(o){s.add(o);const l=e.get(o);e.delete(o),l.forEach(c=>t(c.onSuccess))}function r(o){const l=e.get(o);e.delete(o),console.error("Can't load script : "+o),l.forEach(function(c){c.onError!==void 0&&t(c.onError.bind(null,o))})}return function(o,l,c){s.has(o)?l():e.has(o)?e.get(o).push({onSuccess:l,onError:c}):(e.set(o,[{onSuccess:l,onError:c}]),i(o,n.bind(this,o),r.bind(this,o)))}}const gr=y_();function x_(){const s=[],e=[];let t=1/0;function i(){let o=0;for(let l in D.LOAD_PRIORITY)D.LOAD_PRIORITY.hasOwnProperty(l)&&(o=Math.max(o,D.LOAD_PRIORITY[l]));for(let l=0;l<=o;l+=1)s[l]=[],e[l]=0}i();function n(o){el(o)}function r(){for(t=t+1;t<s.length;t+=1){const o=s[t];if(o.length>0){for(let l=0;l<o.length;l+=1)e[t]+=1,n(o[l]);o.length=0;break}}}this.add=function(o,l){o<=t?(e[o]+=1,t=o,n(l)):(s[o].push(l),e[t]===0&&r())},this.finished=function(o){e[o]-=1;const l=e[o];console.assert(l>=0),o===t&&l===0&&r()}}const ol=new x_;function A_(s){const e={"https://cdn0.shapespark.com/":"https://cdn0-jsbr.shapespark.com/","https://cdn0.dev.shapespark.com/":"https://cdn0-jsbr.dev.shapespark.com/","https://cdn0-shapespark-cn-dev.oss-accelerate.aliyuncs.com/":"https://cdn0-jsbr-cn-dev.shapespark.com.cn/","https://cdn0-shapespark-cn.oss-accelerate.aliyuncs.com/":"https://cdn0-jsbr.shapespark.com.cn/","https://cdncn0-shapespark.oss-accelerate.aliyuncs.com/":"https://cdncn0-jsbr.shapespark.com.cn/"};for(let[t,i]of Object.entries(e))if(s.startsWith(t))return s.replace(t,i);return s}function E_(){let s=[],e=[],t,i=!1,n=new XMLHttpRequest;function r(u){const h=new Int8Array(u);return new BrotliDecode(h).buffer}function o(u){t=u;for(let h=0;h<s.length;h+=1)s[h](u);s=null}function l(u){if(i){u();return}e.push(u),e.length===1&&gr(gi("lib/brotli.min.js"),()=>{i=!0;for(let h=0;h<e.length;h+=1)e[h]();e=null},()=>Wt.error("Cannot load required library"))}function c(){200<=n.status&&n.status<300||n.status===0?o(n.responseText==="SSSSSS"):(console.error("br.buf response",n.status),o(!0))}function d(u){if(t!==void 0){u(t);return}s.push(u),s.length===1&&(n.addEventListener("load",c,!1),n.open("GET",gi("3dassets/br.buf"),!0),n.send())}this.decode=function(u,h,f){h?l(()=>{f(r(u))}):d(p=>{p?f(u):l(()=>{f(r(u))})})}}const w_=new E_;function Jr(s,e){return function(t){ol.finished(s),e(t)}}function eo(s){this.method=s,this.binaryResult=!1,this.data=null,this.dataContentType=null,s==="GET"?(this.retriesLeft=D.RETRIES_ON_LOAD_ERROR,this.retryDelayMs=1e3+Math.random()*1e3):(this.retriesLeft=0,this.retryDelayMs=0)}eo.prototype={constructor:eo,retryScheduled:function(){console.assert(this.retriesLeft>0),this.retriesLeft-=1,this.retryDelayMs*=2}};function S_(s,e,t,i,n,r){setTimeout(function(){Wc(s,e,t,i,n,r)},e.retryDelayMs),e.retryScheduled()}function Wc(s,e,t,i,n,r){let o=new XMLHttpRequest;function l(){const p=o.status||0;return e.method==="GET"&&(p>=500||p===0)?e.retriesLeft!==0:!1}function c(){return uu!==!0?$r.NOT_NEEDED:o.getAllResponseHeaders().toLowerCase().indexOf("js-content-encoding:")>=0?$r.NEEDED:o.getResponseHeader("content-encoding")==="br"?$r.TEST_NEEDED:$r.NOT_NEEDED}function d(p,m){const b=c();b===$r.NOT_NEEDED?m(p):w_.decode(p,b===$r.NEEDED,m)}function u(){const p=l();if(console.warn("Failed to "+e.method+": "+s+" ("+o.status+")"+(p?", retrying in "+e.retryDelayMs/1e3+"s":"")),p)r&&!Hc&&(console.warn("Switch to jsbr hosts."),Hc=!0),S_(s,e,t,i,n,r);else if(i!==void 0){let m;try{m=JSON.parse(o.responseText).message}catch(b){m=void 0}i(o.status,m)}o=null,e=null}function h(){if(t!==void 0)if(e.binaryResult)d(o.response,t);else{const p=o.getResponseHeader("content-type"),m=o.responseText;m&&p.indexOf("text/plain")!==-1?d(m,t):m?d(m,b=>{t(JSON.parse(b))}):t()}o=null,e=null}function f(){200<=o.status&&o.status<300||o.status===0?h():u()}n!==void 0&&o.addEventListener("progress",n,!1),o.addEventListener("load",f,!1),o.addEventListener("error",u,!1),o.addEventListener("abort",u,!1),r&&Hc&&(s=A_(s)),o.open(e.method,s,!0),e.binaryResult&&(o.responseType="arraybuffer"),e.dataContentType&&o.setRequestHeader("Content-Type",e.dataContentType),e.method==="POST"&&o.setRequestHeader("X-Requested-By","Shapespark"),o.send(e.data)}function jc(s,e,t,i,n,r){const o=new eo("GET");o.binaryResult=e,Wc(s,o,t,i,n,r)}function _r(s,e,t,i,n,r,o=!1){ol.add(s,function(){jc(e,t,Jr(s,i),Jr(s,n),r,o)})}function qs(s,e,t,i,n,r){const o=new eo("POST");o.data=t,o.dataContentType=e,Wc(s,o,i,n,r)}function fu(s,e,t,i,n){function r(){s(e,t,i,n)}return function(){console.warn("Failed to get: "+e+(r?", retrying in "+t.retryDelayMs/1e3+"s":"")),t.retriesLeft>0?(setTimeout(r,t.retryDelayMs),t.retryScheduled()):n()}}function pu(s,e,t,i){let n=new Image;n.onload=function(){t(n),n=null},n.onerror=fu(pu,s,e,t,i),n.crossOrigin="anonymous",n.src=s}function mu(s,e,t,i){ol.add(s,function(){const n=new eo("GET");pu(e,n,Jr(s,t),Jr(s,i))})}function gu(s,e,t,i){let n=document.createElement("video");n.muted=!0,n.loop=!0,n.setAttribute("playsinline",""),n.setAttribute("webkit-playsinline",""),n.crossOrigin="anonymous",n.onerror=fu(gu,s,e,t,i),lu(n,function(){n.onerror=void 0,t(n),n=null}),n.src=s,n.play().catch(function(o){o.message.includes("video-only background media was paused to save power.")||i()})}function T_(s,e,t,i){ol.add(s,function(){const n=new eo("GET");gu(e,n,Jr(s,t),Jr(s,i))})}function M_(s,e,t){function i(o){return new Promise((l,c)=>{gr(o,l,c)})}function n(o){t!==void 0&&t(o)}const r=s.map(o=>i(o));Promise.all(r).then(e).catch(n)}function _u(s){return new Promise((e,t)=>{gr(s,e,t)})}let al;const P_=new Event("debugUI");class Uo extends EventTarget{loadImGui(){return ei(this,null,function*(){yield ImGui.default(),ImGui.CreateContext(),ImGui.StyleColorsDark();const e=document.getElementById("walk-canvas");ye(e instanceof HTMLCanvasElement),ImGui_Impl.Init(e)})}static beginFrame(e){ImGui_Impl.NewFrame(e),ImGui.NewFrame(),al.dispatchEvent(P_)}static endFrame(){ImGui.EndFrame()}static registerCallback(e){al.addEventListener("debugUI",e)}static isCapturingInput(){const e=ImGui.GetIO();return e.WantCaptureMouse||e.WantCaptureKeyboard}}let ls;class cs{static setDebugMarker(e){ls&&ls.setMarker(e)}static clearDebugMarker(){ls&&ls.clearMarker()}static startCapture(e,t=5e4){ls&&ls.startCapture(e,t)}static stopCapture(){ls&&ls.stopCapture()}static loadSpector(){return ei(this,null,function*(){try{yield _u(gi("lib/spector.bundle.js"))}catch(e){console.error("Cannot load SpectorJS library");return}console.info("SpectorJS loaded"),ls=new SPECTOR.Spector,ls.displayUI()})}static loadWebglDebug(){return ei(this,null,function*(){try{yield _u(gi("lib/webgl-debug.js")),console.info("WebGLDebugUtils loaded")}catch(e){console.error("Cannot load WebGLDebugUtils library")}})}static throwOnGLError(e,t){throw new Error(`${WebGLDebugUtils.glEnumToString(e)} was caused by call to: ${t}`)}static logGLCall(e,t){console.log(`gl.${e}(${WebGLDebugUtils.glFunctionArgsToString(e,t)})`)}static validateNoneOfTheArgsAreUndefined(e,t){Array.from(t).filter(i=>i===void 0).forEach(i=>{const n=WebGLDebugUtils.glFunctionArgToString(e,i);console.error(`undefined passed to gl.${e}(${n})`)})}static logAndValidate(e,t){cs.logGLCall(e,t),cs.validateNoneOfTheArgsAreUndefined(e,t)}static wrapWebglDebug(e){const t=D.DEBUG_WEBGL_ERROR?cs.throwOnGLError:void 0,i=D.DEBUG_WEBGL_CALL?cs.logAndValidate:void 0;try{return WebGLDebugUtils.makeDebugContext(e,t,i,void 0)}catch(n){return console.error("WebGLDebugUtils library not loaded"),e}}}function C_(){return ei(this,null,function*(){D.DEBUG_UI&&(al=new Uo,yield al.loadImGui()),D.DEBUG_SPECTOR&&(yield cs.loadSpector()),D.DEBUG_WEBGL&&(yield cs.loadWebglDebug())})}var ve=(s=>(s[s.OBJECT=0]="OBJECT",s[s.MATERIAL=1]="MATERIAL",s[s.LIGHT=2]="LIGHT",s[s.GLOBAL=3]="GLOBAL",s))(ve||{});class R_{constructor(e,t){a(this,"type");a(this,"blockOffset");this.type=e,this.blockOffset=t}}class vu{constructor(e,t,i){a(this,"name");a(this,"binding");a(this,"blockIndex");a(this,"uniforms",new Map);a(this,"size",-1);this.name=e,this.binding=t,this.blockIndex=i}getUniformOffsetInBytes(e,t){const i=t?t+e:e;return this.uniforms.get(i).blockOffset}}const zo={0:0,1:1,2:2,3:3},zn={0:"ObjectBuffer",1:"MaterialBuffer",2:"LightBuffer",3:"GlobalBuffer"},I_={ObjectBuffer:0,MaterialBuffer:1,LightBuffer:2,GlobalBuffer:3};class ll{constructor(e){a(this,"value",0);this.value=e}}const ct=class ct extends kt{constructor(){super();a(this,"id");a(this,"name","");a(this,"parent");a(this,"children",new Array);a(this,"up",ct.DEFAULT_UP);a(this,"position",new B);a(this,"rotation",new mi(0,0,0,Un.XYZ));a(this,"scale",new B(1,1,1));a(this,"matrix",new je);a(this,"_matrixWorld",new je);a(this,"matrixAutoUpdate",!0);a(this,"matrixWorldNeedsUpdate",!1);a(this,"_visible",!0);a(this,"castShadow",!1);a(this,"receiveShadow",!1);a(this,"frustumCulled",!0);a(this,"userData",{});this.id=ct._idCount++}get matrixWorld(){return this._matrixWorld}set matrixWorld(t){this._matrixWorld=t}get visible(){return this._visible}set visible(t){this._visible=t}applyMatrix(t){this.matrix.multiplyMatrices(t,this.matrix),this.matrix.decompose(this.position,ct._tempQuatA,this.scale),this.rotation.setFromQuaternion(ct._tempQuatA)}setRotationFromAxisAngle(t,i){ct._tempQuatA.setFromAxisAngle(t,i),this.rotation.setFromQuaternion(ct._tempQuatA)}setRotationFromEuler(t){this.rotation.copyFrom(t)}setRotationFromMatrix(t){this.rotation.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.rotation.setFromQuaternion(t)}rotateOnAxis(t,i){return ct._tempQuatA.setFromAxisAngle(t,i),this.rotation.toQuaternion(ct._tempQuatB),ct._tempQuatB.multiply(ct._tempQuatA),this.rotation.setFromQuaternion(ct._tempQuatB),this}rotateX(t){return this.rotateOnAxis(ct._tempVec3A.set(1,0,0),t)}rotateY(t){return this.rotateOnAxis(ct._tempVec3A.set(0,1,0),t)}rotateZ(t){return this.rotateOnAxis(ct._tempVec3A.set(0,0,1),t)}translateOnAxis(t,i){return this.rotation.toQuaternion(ct._tempQuatA),ct._tempVec3A.copyFrom(t),ct._tempQuatA.applyToVector3(ct._tempVec3A),this.position.add(ct._tempVec3A.multiplyScalar(i)),this}translateX(t){return this.translateOnAxis(ct._tempVec3B.set(1,0,0),t)}translateY(t){return this.translateOnAxis(ct._tempVec3B.set(0,1,0),t)}translateZ(t){return this.translateOnAxis(ct._tempVec3B.set(0,0,1),t)}localToWorld(t){return this.matrixWorld.affineTransformPoint3(t)}worldToLocal(t){return ct._tempMatrix4.getInverse(this.matrixWorld),ct._tempMatrix4.affineTransformPoint3(t)}lookAt(t){const i=ct._tempMatrix4;i.lookAt(t,this.position,this.up),this.rotation.setFromRotationMatrix(i)}add(t){return tt(t!==this),t.parent!==void 0&&t.parent.remove(t),t.parent=this,t.dispatchEvent({type:"added"}),this.children.push(t),ct.onAdd(t),this}remove(t){const i=this.children.indexOf(t);i!==-1&&(t.parent=void 0,t.dispatchEvent({type:"removed"}),this.children.splice(i,1))}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,i){if(this[t]===i)return this;for(const n of this.children){const r=n.getObjectByProperty(t,i);if(r!==void 0)return r}}getWorldPosition(t=new B){return this.updateMatrixWorld(!0),this.matrixWorld.getTranslation(t)}getWorldQuaternion(t=new xi){return this.updateMatrixWorld(!0),this.matrixWorld.decompose(ct._tempVec3A,t,ct._tempVec3B),t}getWorldRotation(t=new mi(0,0,0,Un.XYZ)){return this.getWorldQuaternion(ct._tempQuatA),t.setFromQuaternion(ct._tempQuatA,this.rotation.order)}getWorldScale(t=new B){return this.updateMatrixWorld(!0),this.matrixWorld.decompose(ct._tempVec3A,ct._tempQuatA,t),t}getWorldDirection(t=new B){return this.getWorldQuaternion(ct._tempQuatA),t.set(0,0,1),ct._tempQuatA.applyToVector3(t)}traverse(t){t(this);for(const i of this.children)i.traverse(t)}traverseVisible(t){if(this.visible){t(this);for(const i of this.children)i.traverseVisible(t)}}traverseAncestors(t){this.parent&&(t(this.parent),this.parent.traverseAncestors(t))}updateMatrix(){this.rotation.toQuaternion(ct._tempQuatA),this.matrix.compose(this.position,ct._tempQuatA,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t=!1){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(this.parent===void 0?this.matrixWorld.copyFrom(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(const i of this.children)i.updateMatrixWorld(t)}clone(t=new ct,i=!0){if(t.name=this.name,t.up.copyFrom(this.up),t.position.copyFrom(this.position),t.scale.copyFrom(this.scale),t.matrix.copyFrom(this.matrix),t.matrixWorld.copyFrom(this.matrixWorld),t.matrixAutoUpdate=this.matrixAutoUpdate,t.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,t.visible=this.visible,t.castShadow=this.castShadow,t.receiveShadow=this.receiveShadow,t.frustumCulled=this.frustumCulled,t.userData=JSON.parse(JSON.stringify(this.userData)),i)for(const n of this.children)t.add(n.clone());return t}};a(ct,"DEFAULT_UP",new B(0,1,0)),a(ct,"_idCount",0),a(ct,"onAdd",t=>{}),a(ct,"_tempQuatA",new xi),a(ct,"_tempQuatB",new xi),a(ct,"_tempVec3A",new B),a(ct,"_tempVec3B",new B),a(ct,"_tempMatrix4",new je);let _t=ct;class Je extends _t{constructor(e,t){super(),this.geometry=e,this.material=t,this.materialOverride=null,this.entityId=-1,this.lightProbes=[],this.lightmap=null,this.lightmapIdx=0,this.anchor=void 0,this.visibilityId=null}clone(e,t){return e===void 0&&(e=new Je(this.geometry,this.material)),_t.prototype.clone.call(this,e,t),e}}class As extends Je{constructor(e,t,i){super(t,i),this._visible=!0,this.node=e,this.autoLightmapResolution=-1,this.matrixAutoUpdate=!1,this.highlightMix=0,this.selected=!1,this.selectedSecondary=!1,this.cameraDistance=0,this.grassScaleOverride=void 0,this.matrix=this.matrixWorld=null,this._matrixWorld=null,this._mergedMesh=null}clone(){ye(!1)}updateMatrixWorld(){}get hideInViews(){return this.node.hideInViews}set hideInViews(e){console.assert(!1)}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._mergedMesh&&!D.EDIT_MODE&&(this._mergedMesh.visible=e))}get matrixWorld(){return this._matrixWorld||this.node.animationMatrix}set matrixWorld(e){this._matrixWorld=e}}class cl extends Je{constructor(e,t){super(e,t),this._visible=!0,this.anyLogicalMeshHasUvs=!1,this.lightmap=null,this.matrixAutoUpdate=!1,this.hideInViews=null,this.matrixAutoUpdate=!1,this.center=null,this.cameraDistance=0,this.matrix=null,this.editableRootNode=null,this.logicalMeshes=[]}clone(){ye(!1)}updateMatrixWorld(){}addLogicalMesh(e){this.logicalMeshes.push(e),e._mergedMesh=this}get visible(){return this._visible}set visible(e){if(e!==this._visible){this._visible=e;for(let t=0;t<this.logicalMeshes.length;t+=1)this.logicalMeshes[t]._visible=e}}get matrixWorld(){return this.editableRootNode?this.editableRootNode.mesh?this.editableRootNode.mesh.matrixWorld:this.editableRootNode.animationMatrix:null}set matrixWorld(e){tt(!1,"Cannot set matrixWorld for a merged mesh. ")}}const ne={REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,DEPTH_COMPONENT:6402,RGB:6407,RGBA:6408,HALF_FLOAT:5131,RGB8:32849,RGBA8:32856,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,DEPTH_COMPONENT24:33190,DEPTH_COMPONENT32F:36012,FUNC_ADD:32774,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGBA_ASTC_4x4_KHR:37808,SAMPLER_2D:35678,SAMPLER_3D:35679,SAMPLER_CUBE:35680,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,MAX_SAMPLES:36183,SAMPLER_BINDING:35097,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676};/*!
 * Copyright (C) 2024-present Shapespark
 */class ln{constructor(e){a(this,"_object");this._object=e||{}}hasChild(e){const t=this._object[e];return ln._isObject(t)}child(e){const t=this._object[e],i=typeof t=="object"&&!Array.isArray(t)&&t!==null?t:void 0;return new ln(i)}keys(){return Object.keys(this._object)}parseBoolean(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(i===!0||i==="true"||i===1)return!0;if(i===!1||i==="false"||i===0)return!1}return t}parseNumber(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(typeof i=="number"&&isFinite(i))return i}return t}parseString(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(typeof i=="string")return i}return t}parseEnum(e,t,i){if(Object.hasOwn(this._object,e)){const n=this._object[e];if(typeof n=="string"&&Object.values(t).includes(n))return n}return i}parseObject(e,t){if(Object.hasOwn(this._object,e)){const i=this._object[e];if(ln._isObject(i))return i}return t}parseStrings(e){if(Object.hasOwn(this._object,e)){const t=this._object[e];if(Array.isArray(t)&&t.every(i=>typeof i=="string"))return t}return[]}parseNumbers(e){if(Object.hasOwn(this._object,e)){const t=this._object[e];if(Array.isArray(t)&&t.every(i=>typeof i=="number"))return t}return[]}parseObjects(e){if(Object.hasOwn(this._object,e)){const t=this._object[e];if(Array.isArray(t)&&t.every(i=>ln._isObject(i)))return t}return[]}static _isObject(e){return typeof e=="object"&&!Array.isArray(e)&&e!==null}}var nt=(s=>(s[s.RGB8=ne.RGB8]="RGB8",s[s.RGBA8=ne.RGBA8]="RGBA8",s[s.DEPTH24=ne.DEPTH_COMPONENT24]="DEPTH24",s[s.DEPTH32F=ne.DEPTH_COMPONENT32F]="DEPTH32F",s[s.RGBA32F=ne.RGBA32F]="RGBA32F",s[s.RGB32F=ne.RGB32F]="RGB32F",s[s.RGBA16F=ne.RGBA16F]="RGBA16F",s[s.RGB16F=ne.RGB16F]="RGB16F",s[s.RGB_DXT1=ne.COMPRESSED_RGB_S3TC_DXT1_EXT]="RGB_DXT1",s[s.RGBA_DXT1=ne.COMPRESSED_RGBA_S3TC_DXT1_EXT]="RGBA_DXT1",s[s.RGBA_DXT3=ne.COMPRESSED_RGBA_S3TC_DXT3_EXT]="RGBA_DXT3",s[s.RGBA_DXT5=ne.COMPRESSED_RGBA_S3TC_DXT5_EXT]="RGBA_DXT5",s[s.RGB_PVRTC_4BPPV1=ne.COMPRESSED_RGB_PVRTC_4BPPV1_IMG]="RGB_PVRTC_4BPPV1",s[s.RGBA_PVRTC_4BPPV1=ne.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG]="RGBA_PVRTC_4BPPV1",s[s.RGB_PVRTC_2BPPV1=ne.COMPRESSED_RGB_PVRTC_2BPPV1_IMG]="RGB_PVRTC_2BPPV1",s[s.RGBA_PVRTC_2BPPV1=ne.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG]="RGBA_PVRTC_2BPPV1",s[s.RGB_ETC1=ne.COMPRESSED_RGB_ETC1_WEBGL]="RGB_ETC1",s[s.RGBA_ASTC_4X4=ne.COMPRESSED_RGBA_ASTC_4x4_KHR]="RGBA_ASTC_4X4",s))(nt||{});function Vo(s){return s>=nt.RGB_DXT1&&s<=nt.RGBA_DXT5||s>=nt.RGB_PVRTC_4BPPV1&&s<=nt.RGBA_PVRTC_2BPPV1||s==nt.RGB_ETC1||s==nt.RGBA_ASTC_4X4}function D_(s){return s==nt.DEPTH24||s==nt.DEPTH32F}function bu(s){return Vo(s),s==nt.RGB8||s==nt.RGB32F||s==nt.RGB16F?ne.RGB:s==nt.RGBA8||s==nt.RGBA32F||s==nt.RGBA16F?ne.RGBA:D_(s)?ne.DEPTH_COMPONENT:s}function yu(s){return Vo(s),s==nt.RGB8||s==nt.RGBA8?ne.UNSIGNED_BYTE:s==nt.RGBA32F||s==nt.RGB32F?ne.FLOAT:s==nt.RGBA16F||s==nt.RGB16F?ne.HALF_FLOAT:s==nt.DEPTH24?ne.UNSIGNED_INT:s==nt.DEPTH32F?ne.FLOAT:ne.UNSIGNED_BYTE}var to=(s=>(s.RGBM="rgbm",s.YCOCGM="ycocgm",s))(to||{}),gn=(s=>(s[s.NONE=0]="NONE",s[s.GENERATE_MIPS=1]="GENERATE_MIPS",s[s.PAUSE_LOADED_VIDEO=2]="PAUSE_LOADED_VIDEO",s[s.REPEAT_WRAPPING=4]="REPEAT_WRAPPING",s[s.DEFAULT=3]="DEFAULT",s))(gn||{}),Ys=(s=>(s[s.NOT_LOADED=0]="NOT_LOADED",s[s.POSTPONED=1]="POSTPONED",s[s.IN_PROGRESS=2]="IN_PROGRESS",s[s.COMPLETED=3]="COMPLETED",s))(Ys||{});class Qs{constructor(){a(this,"id");a(this,"name");a(this,"stdExt");a(this,"rawExt");a(this,"webFormats",new Array);a(this,"alpha");a(this,"encoding");a(this,"passphrase");a(this,"video");a(this,"importGpuCompress");a(this,"importAutoScale")}static parse(e,t=new Qs){const i=new ln(e);return t.id=i.parseString("id"),t.name=i.parseString("name"),t.stdExt=i.parseString("stdExt"),t.rawExt=i.parseString("rawExt"),t.webFormats=i.parseStrings("webFormats"),t.alpha=i.parseBoolean("alpha"),t.encoding=i.parseEnum("encoding",to),!t.encoding&&i.parseBoolean("rgbm")==!0&&(t.encoding="rgbm"),t.passphrase=i.parseString("passphrase"),t.video=i.parseBoolean("video"),t.importGpuCompress=i.parseBoolean("importGpuCompress"),t.importAutoScale=i.parseBoolean("importAutoScale"),t}}class hl extends Qs{constructor(){super(...arguments);a(this,"atlasId");a(this,"atlasScale");a(this,"atlasOffset")}static parse(t){const i=new hl,n=new ln(t);Qs.parse(t,i),i.atlasId=n.parseString("atlasId");const r=n.parseNumbers("atlasScale"),o=n.parseNumbers("atlasOffset");return r.length==2&&o.length==2&&(i.atlasScale=r,i.atlasOffset=o),i}}class Xc{constructor(e,t,i,n,r,o,l){a(this,"id");a(this,"name");a(this,"parentTexture");a(this,"rawExt");a(this,"stdExt");a(this,"uvOffsetScale");a(this,"isCutout",!1);a(this,"importGpuCompress",!0);a(this,"importAutoScale",!0);this.id=e,this.name=t,this.parentTexture=i,this.uvOffsetScale=new Lt(n,r,o,l)}addLoadedListener(e){this.parentTexture.addLoadedListener(e)}get loaded(){return this.parentTexture&&this.parentTexture.loaded}get hasAlpha(){return this.parentTexture.hasAlpha}serialize(){return{id:this.id,name:this.name,atlasId:this.parentTexture.id,atlasOffset:[this.uvOffsetScale.x,this.uvOffsetScale.y],atlasScale:[this.uvOffsetScale.z,this.uvOffsetScale.w],rawExt:this.rawExt,stdExt:this.stdExt,webFormats:[],alpha:this.hasAlpha,importGpuCompress:this.importGpuCompress,importAutoScale:this.importAutoScale}}}class Go{constructor(e,t=0,i=0){a(this,"data");a(this,"width");a(this,"height");this.data=e,this.width=t,this.height=i}}const ks=class ks extends kt{constructor(t=void 0,i=ne.CLAMP_TO_EDGE,n=ne.CLAMP_TO_EDGE,r=ne.LINEAR,o=ne.LINEAR_MIPMAP_LINEAR,l=nt.RGBA8,c=ks.DEFAULT_ANISOTROPY){super();a(this,"id");a(this,"name");a(this,"rawExt");a(this,"stdExt");a(this,"webFormats",[]);a(this,"isCube",!1);a(this,"image");a(this,"width");a(this,"height");a(this,"mipmaps",new Array);a(this,"wrapS");a(this,"wrapT");a(this,"magFilter");a(this,"minFilter");a(this,"anisotropy",ks.DEFAULT_ANISOTROPY);a(this,"isAnimated",!1);a(this,"hasAlpha",!1);a(this,"isCutout",!1);a(this,"encoding");a(this,"ycocgmThreshold",0);a(this,"format");a(this,"generateMipmaps",!0);a(this,"premultiplyAlpha",!1);a(this,"flipY",!0);a(this,"unpackAlignment",4);a(this,"releaseOnLoadedToGpu",!0);a(this,"loadingStatus",0);a(this,"importGpuCompress",!0);a(this,"importAutoScale",!0);a(this,"passphrase");a(this,"_atlasEntries");a(this,"_needsUpdate",!1);a(this,"_loadedListeners",new Array);a(this,"_isDisposed",!1);a(this,"webglTexture",null);a(this,"webglSlot",null);this.image=t,this.width=t?t.width:0,this.height=t?t.height:0,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=o,this.anisotropy=c,this.format=l}get loaded(){return this.loadingStatus==3}initFromJson(t,i){ye(t.id&&t.name),this.hasAlpha=!!t.alpha,this.encoding=t.encoding,fr(i,4)&&(this.wrapS=ne.REPEAT,this.wrapT=ne.REPEAT),fr(i,1)&&!t.video?(this.minFilter=ne.LINEAR_MIPMAP_LINEAR,this.generateMipmaps=!0):(this.minFilter=ne.LINEAR,this.generateMipmaps=!1),this.id=t.id,this.name=t.name,this.webFormats=t.webFormats,this.passphrase=t.passphrase,this.rawExt=t.rawExt,this.stdExt=t.stdExt,this.importGpuCompress=t.importGpuCompress!==!1,this.importAutoScale=t.importAutoScale!==!1}static newDataTexture(t=void 0,i=0,n=0,r=nt.RGBA8,o=ne.CLAMP_TO_EDGE,l=ne.CLAMP_TO_EDGE,c=ne.LINEAR,d=ne.LINEAR_MIPMAP_LINEAR,u=ks.NO_ANISOTROPY){const h=new Go(t,i,n),f=new ks(h,o,l,c,d,r,u);return f.loadingStatus=3,f}get isPlaying(){return ye(!1),!1}play(){ye(!1)}pause(){ye(!1)}rewind(){ye(!1)}sleepAnimation(){tt(!1)}wakeAnimation(){tt(!1)}get needsUpdate(){return this._needsUpdate}set needsUpdate(t){this._needsUpdate=t}isAtlas(){return this._atlasEntries!==void 0}enableAtlas(){console.assert(!this.isAtlas()),this._atlasEntries={}}getAtlasEntry(t,i,n,r,o,l){ye(this._atlasEntries);let c=this._atlasEntries[i];return c||(ye(this.loadingStatus!=3),c=new Xc(t,i,this,n,r,o,l),this._atlasEntries[i]=c,c)}forEachAtlasEntry(t){ye(this._atlasEntries);for(const i in this._atlasEntries)Object.prototype.hasOwnProperty.call(this._atlasEntries,i)&&t(this._atlasEntries[i])}clone(t){return t===void 0&&(t=new ks),t.isCube=this.isCube,t.image=this.image,this.mipmaps&&(t.mipmaps=this.mipmaps.slice(0)),t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.isCutout=this.isCutout,t.isAnimated=this.isAnimated,t.hasAlpha=this.hasAlpha,t.format=this.format,t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.flipY=this.flipY,t.unpackAlignment=this.unpackAlignment,t.passphrase=this.passphrase,t}serialize(){return{id:this.id,name:this.name,stdExt:this.stdExt,webFormats:this.webFormats,alpha:this.hasAlpha,importGpuCompress:this.importGpuCompress,importAutoScale:this.importAutoScale,passphrase:this.passphrase,rawExt:this.rawExt,encoding:this.encoding}}dispose(){this._loadedListeners=[],this.dispatchEvent({type:"dispose"}),this._isDisposed=!0}isDisposed(){return this._isDisposed}addLoadedListener(t){this.loaded?t():this._loadedListeners.push(t)}notifyLoaded(){this.loadingStatus=3;for(const t of this._loadedListeners)t();this._loadedListeners=[]}};a(ks,"DEFAULT_ANISOTROPY",4),a(ks,"NO_ANISOTROPY",1);let wt=ks;class St{constructor(e,t,i,n=!1){a(this,"array");a(this,"itemSize");a(this,"needsUpdate",!1);a(this,"length");a(this,"releaseOnLoadedToGpu",!1);a(this,"divisor");a(this,"buffer");a(this,"glType");a(this,"glTypeSize",0);this.array=e,this.itemSize=t,this.length=e.length,this.divisor=i||0,this.releaseOnLoadedToGpu=n,this.buffer=null,this.glType=null}set(e,t=0){return this.array.set(e,t),this}}class qc{constructor(){a(this,"uv0");a(this,"uv1");a(this,"uv1Mod");a(this,"t0");a(this,"t1");a(this,"t2");a(this,"sphericalNormal")}}class L_{constructor(){a(this,"index");a(this,"position");a(this,"uv0");a(this,"uv1");a(this,"uv1Mod");a(this,"t0");a(this,"t1");a(this,"t2");a(this,"normal");a(this,"sphericalNormal")}}const ts=class ts extends _t{constructor(){super();a(this,"matrixWorldInverse",new je);a(this,"projectionMatrix",new je)}getWorldDirection(){const t=new B(0,0,-1);return this.getWorldQuaternion(ts._tempQuat),ts._tempQuat.applyToVector3(t)}lookAt(t){ts._tempMatrix4A.lookAt(this.position,t,this.up),this.setRotationFromMatrix(ts._tempMatrix4A)}clone(t=new ts){return _t.prototype.clone.call(this,t),t.matrixWorldInverse.copyFrom(this.matrixWorldInverse),t.projectionMatrix.copyFrom(this.projectionMatrix),t}projectVector(t){const i=ts._tempMatrix4A;return i.multiplyMatrices(this.projectionMatrix,i.getInverse(this.matrixWorld)),i.transformPoint3(t)}unprojectVector(t){const i=ts._tempMatrix4A;return i.multiplyMatrices(this.matrixWorld,i.getInverse(this.projectionMatrix)),i.transformPoint3(t)}};a(ts,"_tempQuat",new xi),a(ts,"_tempMatrix4A",new je);let vr=ts;function xu(s){const e=new B;s[0].up.set(0,-1,0),e.set(1,0,0),s[0].lookAt(e),s[1].up.set(0,-1,0),e.set(-1,0,0),s[1].lookAt(e),s[2].up.set(0,0,1),e.set(0,1,0),s[2].lookAt(e),s[3].up.set(0,0,-1),e.set(0,-1,0),s[3].lookAt(e),s[4].up.set(0,-1,0),e.set(0,0,1),s[4].lookAt(e),s[5].up.set(0,-1,0),e.set(0,0,-1),s[5].lookAt(e)}class Yc extends _t{constructor(t,i){super();a(this,"sideCameras",[]);for(let n=0;n<6;n++){const r=new hs(90,1,t,i);this.add(r),this.sideCameras.push(r)}xu(this.sideCameras)}}class F_ extends _t{constructor(t,i){super();a(this,"sideCameras",[]);for(let n=0;n<6;n++){const r=new Vi(-1,1,1,-1,t,i);this.add(r),this.sideCameras.push(r)}xu(this.sideCameras)}}class Vi extends vr{constructor(t,i,n,r,o=.1,l=2e3){super();a(this,"zoom",1);a(this,"left");a(this,"right");a(this,"top");a(this,"bottom");a(this,"near");a(this,"far");this.left=t,this.right=i,this.top=n,this.bottom=r,this.near=o,this.far=l,this.updateProjectionMatrix()}static createNDC(t=0,i=1){return new Vi(-1,1,1,-1,t,i)}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),i=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,r=(this.top+this.bottom)/2;this.projectionMatrix.makeOrthographic(n-t,n+t,r+i,r-i,this.near,this.far)}clone(t=new Vi(0,0,0,0)){return vr.prototype.clone.call(this,t),t.zoom=this.zoom,t.left=this.left,t.right=this.right,t.top=this.top,t.bottom=this.bottom,t.near=this.near,t.far=this.far,t.projectionMatrix.copyFrom(this.projectionMatrix),t}}class hs extends vr{constructor(t=50,i=1,n=.1,r=2e3){super();a(this,"zoom",1);a(this,"fov");a(this,"aspectRatio");a(this,"near");a(this,"far");this.fov=t,this.aspectRatio=i,this.near=n,this.far=r,this.updateProjectionMatrix()}setLens(t,i=24){this.fov=2*mn(Math.atan(i/(t*2))),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=mn(2*Math.atan(Math.tan(oi(this.fov)*.5)/this.zoom));this.projectionMatrix.makePerspective(t,this.aspectRatio,this.near,this.far)}clone(t=new hs){return vr.prototype.clone.call(this,t),t.zoom=this.zoom,t.fov=this.fov,t.aspectRatio=this.aspectRatio,t.near=this.near,t.far=this.far,t.projectionMatrix.copyFrom(this.projectionMatrix),t}}const Ho={HABLE:1,UNREAL:2,UCHIMURA:3},Au=Ho.UNREAL;class io{constructor(e){a(this,"type");a(this,"target",null);this.type=e}}const zr=class zr extends vr{constructor(){super();a(this,"perspectiveCamera");a(this,"orthographicCamera");a(this,"current");a(this,"_physicalWidth",1);a(this,"_physicalHeight",1);a(this,"_defaultFov",D.CAMERA_DEFAULT_FOV);a(this,"_orthoFrustumSize",D.CAMERA_ORTHO_FRUSTUM_SIZE);a(this,"_defaultExposure",0);a(this,"_exposure",0);a(this,"_defaultGamma",1);a(this,"_gamma",1);a(this,"_autoExposure",!1);a(this,"_autoExposureDarkness",.3);a(this,"_moveMaxSpeed",D.CAMERA_DEFAULT_MOVE_MAX_SPEED);a(this,"_autoPath",!1);a(this,"_autoClimb",!1);a(this,"_fixedHeight",D.CAMERA_FIXED_HEIGHT);a(this,"_colorMap",null);a(this,"_toneMapping",null);a(this,"_motionBlurEnabled",D.FORCE_MOTION_BLUR);a(this,"_motionBlurIntensity",.5);a(this,"_colorMapIntensity",1);a(this,"_exposureUpdatedEvent",new io("exposureUpdated"));a(this,"_gammaUpdatedEvent",new io("gammaUpdated"));a(this,"_colorMapUpdated",new io("colorMapUpdated"));a(this,"_toneMappingUpdated",new io("toneMappingUpdated"));a(this,"_motionBlurUpdated",new io("motionBlurUpdated"));a(this,"_projectionTypeUpdated",new io("projectionTypeUpdated"));a(this,"_updated");this.perspectiveCamera=new hs(this._defaultFov,this.aspectRatio,D.CAMERA_WALK_NEAR,D.CAMERA_MIN_FAR),this.orthographicCamera=Vi.createNDC(D.CAMERA_WALK_NEAR,D.CAMERA_MIN_FAR),this.adjustProjectionProperties(),this.add(this.perspectiveCamera),this.add(this.orthographicCamera),this.current=this.perspectiveCamera;const t={type:zr.updatedEventType,target:this};this._updated=()=>this.dispatchEvent(t)}adjustProjectionProperties(){this.perspectiveCamera.aspectRatio=this.aspectRatio,this.orthographicCamera.left=this._orthoFrustumSize*this.aspectRatio/-2,this.orthographicCamera.right=this._orthoFrustumSize*this.aspectRatio/2,this.orthographicCamera.top=this._orthoFrustumSize/2,this.orthographicCamera.bottom=this._orthoFrustumSize/-2}updateProjectionMatrix(){this.perspectiveCamera.updateProjectionMatrix(),this.orthographicCamera.updateProjectionMatrix(),this.projectionMatrix=this.current.projectionMatrix,this._updated()}isPerspective(){return this.current===this.perspectiveCamera}isOrthographic(){return this.current===this.orthographicCamera}setPerspective(){this.current=this.perspectiveCamera,this.updateProjectionMatrix(),this.dispatchEvent(this._projectionTypeUpdated)}setOrthographic(){this.current=this.orthographicCamera,this.updateProjectionMatrix(),this.dispatchEvent(this._projectionTypeUpdated)}createProjectionMatrix(t,i){const n=new je;return t?n.makeOrthographic(i*this.aspectRatio/-2,i*this.aspectRatio/2,i/2,i/-2,this.near,this.far):n.makePerspective(this.fov,this.aspectRatio,this.near,this.far),n}getCurrent(){return this.current}get aspectRatio(){return this._physicalWidth/this._physicalHeight}get physicalWidth(){return this._physicalWidth}get physicalHeight(){return this._physicalHeight}set physicalWidth(t){this._physicalWidth=t,this.adjustProjectionProperties(),this.dispatchEvent({type:zr.physicalDimensionsChangedEventType}),this._updated()}set physicalHeight(t){this._physicalHeight=t,this.adjustProjectionProperties(),this.dispatchEvent({type:zr.physicalDimensionsChangedEventType}),this._updated()}get orthoFrustumSize(){return this._orthoFrustumSize}set orthoFrustumSize(t){this._orthoFrustumSize=t,this.adjustProjectionProperties(),this._updated()}get near(){return this.current.near}set near(t){this.perspectiveCamera.near=t,this.orthographicCamera.near=t,this.updateProjectionMatrix(),this._updated()}get far(){return this.current.far}set far(t){this.perspectiveCamera.far=t,this.orthographicCamera.far=t,this.updateProjectionMatrix(),this._updated()}get fov(){return this.perspectiveCamera.fov}set fov(t){this.perspectiveCamera.fov=t,this._updated()}get left(){return ye(this.current instanceof Vi),this.current.left}get right(){return ye(this.current instanceof Vi),this.current.right}get top(){return ye(this.current instanceof Vi),this.current.top}get bottom(){return ye(this.current instanceof Vi),this.current.bottom}get defaultFov(){return this._defaultFov}set defaultFov(t){this._defaultFov=t,this.perspectiveCamera.fov=t,this._updated()}get colorMap(){return this._colorMap}set colorMap(t){this._colorMap=t,t&&!t.loaded&&t.addLoadedListener(()=>this.dispatchEvent(this._colorMapUpdated)),this.dispatchEvent(this._colorMapUpdated)}get colorMapIntensity(){return this._colorMapIntensity}set colorMapIntensity(t){this._colorMapIntensity=t,this.dispatchEvent(this._colorMapUpdated)}get toneMapping(){return this._toneMapping}set toneMapping(t){this._toneMapping!==t&&(this._toneMapping=t,this.dispatchEvent(this._toneMappingUpdated))}get toneMappingModes(){return Ho}get motionBlurEnabled(){return this._motionBlurEnabled}set motionBlurEnabled(t){this._motionBlurEnabled!==t&&(this._motionBlurEnabled=t,this.dispatchEvent(this._motionBlurUpdated))}get motionBlurIntensity(){return this._motionBlurIntensity}set motionBlurIntensity(t){this._motionBlurIntensity!==t&&(this._motionBlurIntensity=t,this.dispatchEvent(this._motionBlurUpdated))}colorMapReady(){return!!(this._colorMap&&this._colorMap.loaded)}get defaultExposure(){return this._defaultExposure}set defaultExposure(t){this._defaultExposure=t,this._updated()}get exposure(){return this._exposure}set exposure(t){this._exposure!==t&&(this._exposure=t,this.dispatchEvent(this._exposureUpdatedEvent))}get defaultGamma(){return this._defaultGamma}set defaultGamma(t){this._defaultGamma=t,this._updated()}get gamma(){return this._gamma}set gamma(t){this._gamma!==t&&(this._gamma=t,this.dispatchEvent(this._gammaUpdatedEvent))}setGamma(t){this.gamma=t}get autoExposure(){return this._autoExposure}set autoExposure(t){this._autoExposure!==t&&(this._autoExposure=t,this._exposure=this._defaultExposure,this._updated())}get moveMaxSpeed(){return this._moveMaxSpeed}set moveMaxSpeed(t){this._moveMaxSpeed=t,this._updated()}get autoPath(){return this._autoPath}set autoPath(t){this._autoPath=t,this._updated()}get autoClimb(){return this._autoClimb}set autoClimb(t){this._autoClimb=t,this._updated()}get autoExposureDarkness(){return this._autoExposureDarkness}set autoExposureDarkness(t){this._autoExposureDarkness=t,this._updated()}get fixedHeight(){return this._fixedHeight}set fixedHeight(t){this._fixedHeight=t,this._updated()}serialize(){return{fov:this.defaultFov,exposure:this.defaultExposure,gamma:this.defaultGamma,lutTexture:this.colorMap?this.colorMap.serialize():null,lutIntensity:this.colorMapIntensity,toneMapping:this.toneMapping,autoPath:this.autoPath,autoClimb:this.autoClimb,moveMaxSpeed:this.moveMaxSpeed,fixedHeight:this._fixedHeight,motionBlurEnabled:this.motionBlurEnabled||null,motionBlurIntensity:this.motionBlurEnabled?this.motionBlurIntensity:null}}setFromJson(t){if(!t)return;const i=new ln(t);this.defaultFov=i.parseNumber("fov",this.defaultFov),this.defaultExposure=i.parseNumber("exposure",this.defaultExposure),this.defaultGamma=i.parseNumber("gamma",this.defaultGamma),this.colorMapIntensity=i.parseNumber("lutIntensity",this.colorMapIntensity);const n=i.parseNumber("toneMapping");n!==void 0&&(this.toneMapping=n),this.autoPath=i.parseBoolean("autoPath",this.autoPath),this.autoClimb=i.parseBoolean("autoClimb",this.autoClimb),this.autoExposure=i.parseBoolean("autoExposure",this.autoExposure);const r=i.parseNumber("fixedHeight");r!==void 0&&(this.fixedHeight=r),this.motionBlurEnabled=i.parseBoolean("motionBlurEnabled",this.motionBlurEnabled),this.motionBlurIntensity=i.parseNumber("motionBlurIntensity",this.motionBlurIntensity),this.autoExposureDarkness=i.parseNumber("autoExposureDarkness",this.autoExposureDarkness),this.moveMaxSpeed=i.parseNumber("moveMaxSpeed",this.moveMaxSpeed),this.updateProjectionMatrix()}};a(zr,"updatedEventType","cameraUpdated"),a(zr,"physicalDimensionsChangedEventType","physicalDimensionsChanged");let br=zr;const Eu={"aabb_query_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
varIn vec3 vPositionW;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int axis;
#endif
vec4 encodeFloat(in float x) {
float xabs = abs(x);
float r = floor(xabs);
float g = fract(xabs);
return vec4(r / 255.0, g, 0.0, 0.0);
}
void main() {
vec3 viewW = cameraPosition - vPositionW;
if (axis == 0) {
fragColor = encodeFloat(viewW.x);
} else if (axis == 1) {
fragColor = encodeFloat(viewW.y);
} else if (axis == 2) {
fragColor = encodeFloat(viewW.z);
}
}
`,"aabb_query_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec3 vPositionW;
void main() {
vec4 transformedPosition = transformPosition();
vPositionW = (modelMatrix * transformedPosition).xyz;
setClipPositionFromWorldPos(transformedPosition);
}
`,"accumulate_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float weight;
#endif
uniform sampler2D inputBuffer;
varIn vec2 vUv0;
void main() {
vec3 inputColor = texture2D(inputBuffer, vUv0).rgb;
fragColor = vec4(inputColor, weight);
}
`,"accumulate_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"alpha_stats_combine_fragment.glsl":`uniform sampler2D map;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 mapUvStep;
uniform vec2 mapUvScale;
#endif
varIn vec2 vUv0;
void main() {
vec2 corner = vUv0 * mapUvScale - mapUvStep;
vec2 uv = corner + 0.5 * mapUvStep;
vec4 p0 = texture2D(map, uv);
vec4 p1 = texture2D(map, uv + vec2(0.0, mapUvStep.y));
vec4 p2 = texture2D(map, uv + vec2(mapUvStep.x, 0.0));
vec4 p3 = texture2D(map, uv + vec2(mapUvStep.x, mapUvStep.y));
fragColor = vec4((p0.r + p1.r + p2.r + p3.r) / 4.0, (p0.g + p1.g + p2.g + p3.g) / 4.0, 0.0, 1.0);
return;
}
`,"alpha_stats_fragment.glsl":`uniform sampler2D map;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 mapUvStep;
uniform vec4 mapUvOffsetScale;
#endif
varIn vec2 vUv0;
void main() {
vec2 corner = vUv0 * mapUvOffsetScale.zw + mapUvOffsetScale.xy - mapUvStep;
vec2 uv = corner + 0.5 * mapUvStep;
const float bias = -1.0;
float a0 = texture2D(map, uv, bias).a;
float a1 = texture2D(map, uv + vec2(0.0, mapUvStep.y), bias).a;
float a2 = texture2D(map, uv + vec2(mapUvStep.x, 0.0), bias).a;
float a3 = texture2D(map, uv + vec2(mapUvStep.x, mapUvStep.y), bias).a;
float fully_transparent_count = step(0.0, -a0) + step(0.0, -a1) + step(0.0, -a2) + step(0.0, -a3);
float partialy_transparent_count =
step(0.0, -abs(clamp(a0, 0.05, 0.95) - a0)) + step(0.0, -abs(clamp(a1, 0.05, 0.95) - a1)) +
step(0.0, -abs(clamp(a2, 0.05, 0.95) - a2)) + step(0.0, -abs(clamp(a3, 0.05, 0.95) - a3));
fragColor = vec4(step(4.0, partialy_transparent_count), fully_transparent_count / 4.0, 0.0, 1.0);
return;
}
`,"alpha_stats_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"anchor_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE)
varOut vec2 vUv0;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
varOut vec3 vPositionV;
#endif
#ifdef USE_BUMP_TEXTURE
varOut vec3 vNormalV;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
varOut vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
varOut vec3 vNormalW;
#endif
void main() {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_ENVMAP) || defined(USE_HEADLIGHT)
vec3 positionW = (modelMatrix * vec4(position, 1.0)).xyz;
vec3 normal = sphericalDecode(sphericalNormal);
vec3 normalW = mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz) * normal;
normalW = normalize(normalW);
#endif
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE)
vec3 anchorCenterW = vec3(modelMatrix[3].xyz);
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vec3 cameraUpW = vec3(modelViewMatrix[0].y, modelViewMatrix[1].y, modelViewMatrix[2].y);
vec3 forwardW = normalize(anchorCenterW - cameraPosition);
vec3 rightW = cross(forwardW, cameraUpW);
rightW.z = 0.0;
rightW = normalize(rightW);
vec3 upW = cross(rightW, forwardW);
vUv0 = vec2(dot(normalW, rightW) * 0.5 + 0.5, dot(normalW, upW) * 0.5 + 0.5);
#endif
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_BUMP_TEXTURE)
vNormalV = normalize(normalMatrix * normal);
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
vPositionW = positionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
vNormalW = normalW;
#endif
setClipPositionFromViewPos(mvPosition);
}
`,"brdf_fragment.glsl":`precision highp float;
varIn vec2 vUv0;
const float PI = 3.1415926;
float radicalInverseVDC(int n) {
float base = 2.0;
float invBase = 1.0 / base;
float result = 0.0;
float denom;
for (int i = 0; i < 32; i++) {
if (n > 0) {
denom = mod(float(n), base);
result += denom * invBase;
invBase = invBase / base;
n = int(float(n) / base);
}
}
return result;
}
vec2 hammersley(int i, int N) {
return vec2(float(i) / float(N), radicalInverseVDC(i));
}
vec3 importanceSampleGGX(vec2 xi, vec3 N, float roughness) {
float a = roughness * roughness;
float phi = 2.0 * PI * xi.x;
float cosTheta = sqrt((1.0 - xi.y) / (1.0 + (a * a - 1.0) * xi.y));
float sinTheta = sqrt(1.0 - cosTheta * cosTheta);
vec3 H = vec3(sinTheta * cos(phi), sinTheta * sin(phi), cosTheta);
vec3 upVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
vec3 tangentX = normalize(cross(upVector, N));
vec3 tangentY = cross(N, tangentX);
return tangentX * H.x + tangentY * H.y + N * H.z;
}
float geometrySchlickGGX(float NdotV, float roughness) {
float k = (roughness * roughness) / 2.0;
float nom = NdotV;
float denom = NdotV * (1.0 - k) + k;
return nom / denom;
}
float geometrySmith(vec3 N, vec3 V, vec3 L, float roughness) {
float NdotV = max(dot(N, V), 0.0);
float NdotL = max(dot(N, L), 0.0);
float ggx2 = geometrySchlickGGX(NdotV, roughness);
float ggx1 = geometrySchlickGGX(NdotL, roughness);
return ggx1 * ggx2;
}
vec2 integrateBrdf(float roughness, float NdotV) {
vec3 V = vec3(sqrt(1.0 - NdotV * NdotV), 0.0, NdotV);
vec3 N = vec3(0.0, 0.0, 1.0);
float A = 0.0;
float B = 0.0;
const int NumSamples = 2048;
for (int i = 0; i < NumSamples; i++) {
vec2 xi = hammersley(i, NumSamples);
vec3 H = importanceSampleGGX(xi, N, roughness);
vec3 L = 2.0 * dot(V, H) * H - V;
float NdotL = clamp(L.z, 0.0, 1.0);
float NdotH = clamp(H.z, 0.0, 1.0);
float VdotH = clamp(dot(V, H), 0.0, 1.0);
if (NdotL > 0.0) {
float G = geometrySmith(N, V, L, roughness);
float G_Vis = G * VdotH / (NdotH * NdotV);
float Fc = pow(1.0 - VdotH, 5.0);
A += (1.0 - Fc) * G_Vis;
B += Fc * G_Vis;
}
}
return vec2(A, B) / float(NumSamples);
}
void main() {
fragColor = vec4(integrateBrdf(vUv0.y, vUv0.x).xy, 0.0, 1.0);
}
`,"brdf_vertex.glsl":`varOut vec2 vUv0;
void main() {
vUv0 = uv0;
gl_Position = vec4(position, 1.0);
}
`,"copy_opaque_fragment.glsl":`uniform sampler2D tDiffuse;
varIn vec2 vUv0;
void main() {
fragColor = vec4(texture2D(tDiffuse, vUv0).rgb, 1.0);
}
`,"copy_opaque_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec2 vUv0;
void main() {
vUv0 = uv0;
#ifdef DEV_NEW_RENDER_ARCHITECTURE
gl_Position = vec4(position, 1.0);
#else
setClipPositionFromWorldPos(position);
#endif
}
`,"cubemap_filter_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float rnd(vec2 uv) {
return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);
}
vec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {
float phi = uv.y * 2.0 * PI;
float cosTheta = sqrt(1.0 - uv.x);
float sinTheta = sqrt(1.0 - cosTheta * cosTheta);
vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);
return normalize(mix(vecSpace * sampleDir, cubeDir, gloss));
}
mat3 matrixFromVector(vec3 n) {  // frisvad
float a = 1.0 / (1.0 + n.z);
float b = -n.x * n.y * a;
vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);
vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);
return mat3(b1, b2, n);
}
float distributionGGX(vec3 N, vec3 H, float roughness) {
const float PI = 3.14159265359;
float a = roughness * roughness;
float a2 = a * a;
float NdotH = max(dot(N, H), 0.0);
float NdotH2 = NdotH * NdotH;
float nom = a2;
float denom = (NdotH2 * (a2 - 1.0) + 1.0);
denom = PI * denom * denom;
return nom / denom;
}
float radicalInverseVDC(int n) {
float base = 2.0;
float invBase = 1.0 / base;
float result = 0.0;
float denom;
for (int i = 0; i < 32; i++) {
if (n > 0) {
denom = mod(float(n), base);
result += denom * invBase;
invBase = invBase / base;
n = int(float(n) / base);
}
}
return result;
}
vec2 hammersley(int i, int N) {
return vec2(float(i) / float(N), radicalInverseVDC(i));
}
vec3 importanceSampleGGX(vec2 Xi, vec3 N, float roughness) {
float a = roughness * roughness;
float phi = 2.0 * PI * Xi.x;
float cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y));
float sinTheta = sqrt(1.0 - cosTheta * cosTheta);
vec3 H;
H.x = cos(phi) * sinTheta;
H.y = sin(phi) * sinTheta;
H.z = cosTheta;
vec3 up = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
vec3 tangent = normalize(cross(up, N));
vec3 bitangent = cross(N, tangent);
vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;
return normalize(sampleVec);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
uniform samplerCube envMap;
uniform samplerCube envMapFiltered;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float mipSize;
uniform float face;
uniform float gloss;
uniform float roughness;
uniform float topMipResolution;  // topMipResolution of source cubemap (per face)
#endif
void main(void) {
vec2 st = 2.0 * floor(gl_FragCoord.xy) / (mipSize - 1.0) - 1.0;
vec3 vec;
if (face == 0.0) {
vec = vec3(1, -st.y, -st.x);
} else if (face == 1.0) {
vec = vec3(-1, -st.y, st.x);
} else if (face == 2.0) {
vec = vec3(st.x, 1, st.y);
} else if (face == 3.0) {
vec = vec3(st.x, -1, -st.y);
} else if (face == 4.0) {
vec = vec3(st.x, -st.y, 1);
} else {
vec = vec3(-st.x, -st.y, -1);
}
mat3 vecSpace = matrixFromVector(normalize(vec));
vec3 color = vec3(0.0);
const int samples = 1024;
float totalWeight = 0.0;
vec3 N = normalize(vec);
vec3 R = N;
vec3 V = R;
for (int i = 0; i < samples; i++) {
vec2 xi = hammersley(i, samples);
vec3 H = importanceSampleGGX(xi, N, roughness);
vec3 L = normalize(2.0 * dot(V, H) * H - V);
float NdotL = max(dot(N, L), 0.0);
if (NdotL > 0.0) {
/*
float D = distributionGGX(N, H, roughness);
float NdotH = max(dot(N, H), 0.0);
float HdotV = max(dot(H, V), 0.0);
float pdf = D * NdotH / (4.0 * HdotV) + 0.0001;
float saTexel = 4.0 * PI / (6.0 * topMipResolution * topMipResolution);
float saSample = 1.0 / (float(samples) * pdf + 0.0001);
float mipLevel = roughness == 0.0 ? 0.0 : 0.5 * log2(saSample / saTexel);
color += hdrDecodeRgbm(textureCubeLodEXT(envMap, L, mipLevel)) * NdotL;
*/
color += hdrDecodeRgbm(textureCube(envMap, L)) * NdotL;
totalWeight += NdotL;
}
}
color /= totalWeight;
fragColor = hdrEncode(color);
}
`,"cubemap_filter_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
void main() {
setClipPositionFromWorldPos(position);
}
`,"cube_to_equirect_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
uniform samplerCube panoramaCube;
varIn vec2 vUv0;
void main() {
vec2 uv = vUv0;
float longitude = uv.x * 2. * PI;
float latitude = uv.y * PI;
vec3 dir = vec3(sin(longitude) * sin(latitude), cos(longitude) * sin(latitude), cos(latitude));
fragColor = textureCube(panoramaCube, normalize(dir));
}
`,"cube_to_equirect_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec2 vUv0;
void main() {
vUv0 = vec2(uv0.x, uv0.y - 1.0);
setClipPositionFromWorldPos(position);
}
`,"editor_light_fragment.glsl":`float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 color;
uniform vec3 highlight;
uniform float highlightMix;
#endif
varIn vec3 vNormal;
varIn vec3 vViewPosition;
void main() {
vec3 lVector = normalize(vViewPosition.xyz);
float pointDiffuse = max(dot(normalize(vNormal), lVector), 0.0);
vec3 lightColor = color * pointDiffuse;
lightColor = mix(lightColor, highlight, highlightMix);
fragColor = vec4(min(linearToGamma(lightColor), 1.0), 1.0);
}
`,"editor_light_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec3 vNormal;
varOut vec3 vViewPosition;
void main() {
vec3 normal = sphericalDecode(sphericalNormal);
vNormal = normalize(normalMatrix * normal);
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
vViewPosition = -mvPosition.xyz;
setClipPositionFromViewPos(mvPosition);
}
`,"equirect_sky_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 fogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, fogColor.xyz, fogAmount);
}
#endif
uniform sampler2D map;
varIn vec2 vUv0;
#ifdef USE_FOG
varIn vec3 vPositionW;
varIn vec3 vPositionV;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 camera_exposure_gamma;
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture2D(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture2D(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif    // USE_COLORMAP
void main() {
#ifdef USE_RGBM_MAP
vec4 colorRgbm = texture2D(map, vUv0);
vec3 colorLinear = hdrDecodeRgbm(colorRgbm);
#else
vec3 colorLinear = gammaToLinear(texture2D(map, vUv0).xyz);
#endif
#ifdef USE_FOG
float distance = length(vPositionV);
colorLinear = addFog(colorLinear, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
#ifdef USE_RGBM_MAP
fragColor = colorRgbm;
#else
fragColor = hdrEncode(10.0 * colorLinear);
#endif
#else
vec3 colorExposed = pow(camera_exposure_gamma.x * colorLinear, vec3(camera_exposure_gamma.y));
vec3 colorGamma = linearToGammaToneMapped(colorExposed);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, colorGamma, colorMapIntensity), 1.0);
#else
fragColor = vec4(colorGamma, 1.0);
#endif
#endif
}
`,"equirect_sky_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec2 vUv0;
#ifdef USE_FOG
varOut vec3 vPositionW;
varOut vec3 vPositionV;
#endif
void main() {
vUv0 = uv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vec3 vPos = (modelViewMatrix * vec4(position, 1.0)).xyz;
#ifdef USE_FOG
vPositionW = (modelMatrix * vec4(position, 1.0)).xyz;
vPositionV = -vPos;
#endif
setClipPositionFromViewPos(vPos);
}
`,"fxaa_fragment.glsl":`#ifdef DEV_NEW_RENDER_ARCHITECTURE
varIn vec2 vUv0;
#endif
uniform sampler2D tDiffuse;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 resolution;
#endif
#define FXAA_REDUCE_MIN (1.0 / 128.0)
#define FXAA_REDUCE_MUL (1.0 / 8.0)
#define FXAA_SPAN_MAX 8.0
void main() {
#ifdef DEV_NEW_RENDER_ARCHITECTURE
vec3 rgbNW = texture2D(tDiffuse, vUv0 + vec2(-resolution.x, -resolution.y)).xyz;
vec3 rgbNE = texture2D(tDiffuse, vUv0 + vec2(resolution.x, -resolution.y)).xyz;
vec3 rgbSW = texture2D(tDiffuse, vUv0 + vec2(-resolution.x, resolution.y)).xyz;
vec3 rgbSE = texture2D(tDiffuse, vUv0 + vec2(resolution.x, resolution.y)).xyz;
vec4 rgbaM = texture2D(tDiffuse, vUv0);
#else
vec3 rgbNW = texture2D(tDiffuse, (gl_FragCoord.xy + vec2(-1.0, -1.0)) * resolution).xyz;
vec3 rgbNE = texture2D(tDiffuse, (gl_FragCoord.xy + vec2(1.0, -1.0)) * resolution).xyz;
vec3 rgbSW = texture2D(tDiffuse, (gl_FragCoord.xy + vec2(-1.0, 1.0)) * resolution).xyz;
vec3 rgbSE = texture2D(tDiffuse, (gl_FragCoord.xy + vec2(1.0, 1.0)) * resolution).xyz;
vec4 rgbaM = texture2D(tDiffuse, gl_FragCoord.xy * resolution);
#endif
vec3 rgbM = rgbaM.xyz;
vec3 luma = vec3(0.299, 0.587, 0.114);
float lumaNW = dot(rgbNW, luma);
float lumaNE = dot(rgbNE, luma);
float lumaSW = dot(rgbSW, luma);
float lumaSE = dot(rgbSE, luma);
float lumaM = dot(rgbM, luma);
float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
vec2 dir;
dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));
float dirReduce =
max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),
max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) *
resolution;
#ifdef DEV_NEW_RENDER_ARCHITECTURE
vec4 rgbA = (1.0 / 2.0) * (texture2D(tDiffuse, vUv0 + dir * (1.0 / 3.0 - 0.5)) +
texture2D(tDiffuse, vUv0 + dir * (2.0 / 3.0 - 0.5)));
vec4 rgbB =
rgbA * (1.0 / 2.0) + (1.0 / 4.0) * (texture2D(tDiffuse, vUv0 + dir * (0.0 / 3.0 - 0.5)) +
texture2D(tDiffuse, vUv0 + dir * (3.0 / 3.0 - 0.5)));
#else
vec4 rgbA =
(1.0 / 2.0) * (texture2D(tDiffuse, gl_FragCoord.xy * resolution + dir * (1.0 / 3.0 - 0.5)) +
texture2D(tDiffuse, gl_FragCoord.xy * resolution + dir * (2.0 / 3.0 - 0.5)));
vec4 rgbB =
rgbA * (1.0 / 2.0) +
(1.0 / 4.0) * (texture2D(tDiffuse, gl_FragCoord.xy * resolution + dir * (0.0 / 3.0 - 0.5)) +
texture2D(tDiffuse, gl_FragCoord.xy * resolution + dir * (3.0 / 3.0 - 0.5)));
#endif
float lumaB = dot(rgbB, vec4(luma, 0.0));
if ((lumaB < lumaMin) || (lumaB > lumaMax)) {
fragColor = rgbA;
} else {
fragColor = rgbB;
}
}
`,"fxaa_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
#ifdef DEV_NEW_RENDER_ARCHITECTURE
varOut vec2 vUv0;
#endif
void main() {
#ifdef DEV_NEW_RENDER_ARCHITECTURE
gl_Position = vec4(position, 1.0);
vUv0 = uv0;
#else
setClipPositionFromWorldPos(position);
#endif
}
`,"gaze_pointer_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
const float pointRadius = 0.01;
const float pointBorder = 0.005;
const float timerRadius = 0.04;
const float timerBorder = 0.02;
const vec3 timerColor = vec3(0.298, 0.619, 0.851);
varIn vec2 coords;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float circleSpan;
#endif
void main() {
float dist = sqrt(dot(coords, coords));
if (dist < pointRadius) {
float a = 1.0 - smoothstep(pointRadius - pointBorder, pointRadius, dist);
fragColor = vec4(1.0, 1.0, 1.0, a);
} else if (-atan(coords.x, -coords.y) < circleSpan) {
float a2 = smoothstep(timerRadius - timerBorder, timerRadius, dist) -
smoothstep(timerRadius, timerRadius + timerBorder, dist);
fragColor = vec4(timerColor, a2);
} else {
discard;
}
}
`,"gaze_pointer_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec2 coords;
void main() {
coords = vec2(position.x, position.y);
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
setClipPositionFromWorldPos(position);
#else
gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
#endif
gl_Position.z = -0.1;
}
`,"global_buffer.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
`,"grass_fragment.glsl":`#ifdef USE_HEIGHT_TEXTURE
uniform sampler2D heightTexture;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float currentStep;
uniform float renderSteps;
#endif
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return baseColor * totalIntensity;
}
float easeOutCubic(in float x) {
return 1.0 - pow(1.0 - x, 3.0);
}
vec3 getBaseColorHook(out float alpha) {
float alphaDiscard = 0.5;
#ifdef USE_HEIGHT_TEXTURE
float heightAmount = texture2D(heightTexture, vUv0).r;
alpha = currentStep > 0.0 ? easeOutCubic(heightAmount) : 1.0;
alphaDiscard = (1.0 / renderSteps) * currentStep;
if (alpha < alphaDiscard) {
discard;
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
vec2 uv = vUv0;
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = texture2DGradEXT(baseColorTexture, uv, dfdx, dfdy);
#else
vec4 baseColorGamma = texture2DWithOptionalAntiTiling(baseColorTexture, uv);
#endif
vec3 baseColor = applyBaseColorCorrection(gammaToLinear(baseColorGamma.rgb), baseColorCorrection);
#endif
float offset = min(0.35, 0.35 * (renderSteps - 1.0));
float baseColorMultiplier = mix(1.0 - offset, 1.0 + offset, alphaDiscard);
return baseColor * baseColorMultiplier;
}
`,"grass_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float grassOffsetScaled;
uniform float grassDirectionality;
#endif
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal) {
vec3 vector = mix(vec3(0, 1, 0), normalize(normalMatrix * normal), grassDirectionality);
mvPosition.xyz += vector * grassOffsetScaled;
}
`,"light_buffer.glsl":`struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
};
#endif
`,"luma_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
};
#endif
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#ifdef USE_LIGHTMAP
webgl2centroid varIn vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture2D(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 color;
#endif
void main() {
vec3 receivedLight = getLightIntensity();
vec3 diffuseLight = receivedLight * color;
float luma = 0.299 * diffuseLight.r + 0.587 * diffuseLight.g + 0.114 * diffuseLight.b;
fragColor.r = fract(luma);
fragColor.g = floor(luma) / 255.0;
}
`,"minimap_add_alpha_fragment.glsl":`uniform sampler2D tColor;
#ifdef USE_ALPHA_FROM_COLOR
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 colorFill;
#endif
#else
uniform sampler2D tAlpha;
#endif
varIn vec2 vUv0;
void main() {
vec4 color = texture2D(tColor, vUv0);
#ifdef USE_ALPHA_FROM_COLOR
float alphaFromColor = (color.r + color.g + color.b) / 3.0;
fragColor = vec4(colorFill, alphaFromColor);
#else
float alpha = vec4(texture2D(tAlpha, vUv0)).a;
fragColor = vec4(color.rgb, alpha);
#endif
}
`,"minimap_add_alpha_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec2 vUv0;
void main() {
vUv0 = uv0;
setClipPositionFromWorldPos(position);
}
`,"motion_blur_fragment.glsl":`uniform sampler2D tDepth;
uniform sampler2D tDiffuse;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float velocityFactor;
uniform float delta;
uniform vec2 resolution;
uniform vec3 cameraMove;
uniform mat4 clipToWorldMatrix;
uniform mat4 previousWorldToClipMatrix;
#endif
void main() {
vec2 coord = gl_FragCoord.xy * resolution;
float zOverW = texture2D(tDepth, coord).r;
vec4 H = vec4(coord.x * 2.0 - 1.0, (1.0 - coord.y) * 2.0 - 1.0, zOverW, 1.0);
vec4 D = H * clipToWorldMatrix;
vec4 worldPos = D / D.w;
vec4 currentPos = H;
vec4 previousPos = worldPos * previousWorldToClipMatrix;
previousPos /= previousPos.w;
vec2 velocity =
velocityFactor * clamp((currentPos.xy - previousPos.xy) / 2.0, vec2(-0.01), vec2(0.01));
vec4 color = texture2D(tDiffuse, coord);
const int samples = 20;
vec2 offset = vec2(0.0);
for (int i = 1; i < samples; i++) {
offset = velocity * (float(i) / (float(samples) - 1.0) - 0.5);
vec4 currentColor = texture2D(tDiffuse, coord + offset);
color += currentColor;
}
vec4 finalColor = color / float(samples);
fragColor = vec4(finalColor.rgb, 1.0);
}
`,"motion_blur_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
void main() {
setClipPositionFromWorldPos(position);
}
`,"object_distance_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec3 vPositionW;
void main() {
vec4 transformedPosition = transformPosition();
vPositionW = (modelMatrix * transformedPosition).xyz;
setClipPositionFromWorldPos(transformedPosition);
}
`,"object_id_distance_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int objectId;
#endif
varIn vec3 vPositionW;
void main(void) {
float cameraDistance = min(distance(cameraPosition, vPositionW), 255.0);
int x = objectId / 256;
int y = objectId - 256 * x;
float z = floor(cameraDistance);
float a = fract(cameraDistance);
fragColor = vec4(float(x) / 255.0, float(y) / 255.0, z / 255.0, a);
}
`,"object_id_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform int objectId;
#endif
varIn vec3 vPositionW;
void main(void) {
int x = objectId / (256 * 256);
int y = (objectId - 256 * 256 * x) / 256;
int z = (objectId - 256 * 256 * x - 256 * y);
fragColor = vec4(float(x) / 255.0, float(y) / 255.0, float(z) / 255.0, 0);
}
`,"outline_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 color;
#endif
void main() {
fragColor = vec4(color, 1.0);
}
`,"outline_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float thickness;
#endif
void main() {
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(t0.x * n.x + t0.y * n.y + t0.z * n.z, t1.x * n.x + t1.y * n.y + t1.z * n.z,
t2.x * n.x + t2.y * n.y + t2.z * n.z);
vec4 transformedPosition = transformPosition();
float distToCamera = cameraPosition.z - transformedPosition.z;
vec4 movedPosition = vec4(transformedPosition.x - distToCamera * thickness * normal.x,
transformedPosition.y - distToCamera * thickness * normal.y,
transformedPosition.z, transformedPosition.w);
setClipPositionFromWorldPos(movedPosition);
}
`,"pbr_material_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 fogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, fogColor.xyz, fogAmount);
}
#endif
varIn vec3 vPositionW;
varIn vec3 vNormalW;
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE)
varIn vec2 vUv0;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
varIn vec3 vPositionV;
#endif
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#if defined(USE_BUMP_TEXTURE)
varIn vec3 vNormalV;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float bumpScale;
#endif
uniform sampler2D bumpTexture;
uniform vec4 bumpCorrection;
float bumpTextureCorrected(vec2 coord) {
return applyMapCorrection(texture2D(bumpTexture, coord), bumpCorrection);
}
vec2 dBumpdxy() {
vec2 texdx = dFdx(vUv0);
vec2 texdy = dFdy(vUv0);
float Hll = bumpScale * bumpTextureCorrected(vUv0);
float dBx = bumpScale * bumpTextureCorrected(vUv0 + texdx) - Hll;
float dBy = bumpScale * bumpTextureCorrected(vUv0 + texdy) - Hll;
return vec2(dBx, dBy);
}
vec3 perturbNormal(in vec3 surfPos, in vec3 surfNorm) {
vec2 dBdxy = dBumpdxy();
vec3 vSigmaX = dFdx(surfPos);
vec3 vSigmaY = dFdy(surfPos);
vec3 R1 = cross(vSigmaY, surfNorm);
vec3 R2 = cross(surfNorm, vSigmaX);
float fDet = dot(vSigmaX, R1);
vec3 vGrad = sign(fDet) * (dBdxy.x * R1 + dBdxy.y * R2);
return normalize(abs(fDet) * surfNorm - vGrad);
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#ifdef USE_PARALLAX_CORRECTION
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 baseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture2D(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 texture2DWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture2D(text, uv);
#endif
#endif
}
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
#ifdef USE_PARALLAX_CORRECTION
#else
vec2 uv = vUv0;
#endif
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = texture2DGradEXT(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma =
texture2DWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture2D(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = texture2DWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
#endif
return applyBaseColorCorrection(baseColor, baseColorCorrection);
}
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#ifdef USE_LIGHTMAP
webgl2centroid varIn vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture2D(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#if defined(USE_ENVMAP)
uniform sampler2D roughnessTexture;
uniform vec4 roughnessCorrection;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float roughness;
#endif
float getRoughness() {
#ifdef USE_ROUGHNESS_TEXTURE
return applyMapCorrection(texture2D(roughnessTexture, vUv0), roughnessCorrection);
#else
return roughness;
#endif
}
uniform sampler2D metallicTexture;
uniform vec4 metallicCorrection;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float metallic;
#endif
float getMetallic() {
#ifdef USE_METALLIC_TEXTURE
return applyMapCorrection(texture2D(metallicTexture, vUv0), metallicCorrection);
#else
return metallic;
#endif
}
uniform sampler2D brdfLUT;
vec3 envBRDFApprox(vec3 specularColor, float roughness, float NoV) {
const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);
const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;
vec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;
return specularColor * AB.x + AB.y;
}
vec3 getBrdf(float roughness, vec3 fresnel, float clampCosnv, vec3 specularColor) {
#ifdef USE_BRDF_TEXTURE
vec2 brdf = texture2D(brdfLUT, vec2(clampCosnv, roughness)).xy;
return fresnel * brdf.x + brdf.y;
#else
return envBRDFApprox(specularColor, roughness, clampCosnv);
#endif
}
uniform samplerCube envMap[NUM_REFLECTION_PROBES];
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float envMipsCount;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform ReflectionProbe reflectionProbes[NUM_REFLECTION_PROBES];
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
struct EnvMapLevel {
float mipLevel0;
float mipLevel1;
float mipMixFactor;
};
EnvMapLevel getEnvMapLevel(float roughness) {
EnvMapLevel result;
float maxMipLevel = envMipsCount - 1.0;
float mipSelector = roughness * maxMipLevel;
result.mipLevel0 = floor(mipSelector);
result.mipLevel1 = min(result.mipLevel0 + 1.0, maxMipLevel);
result.mipMixFactor = fract(mipSelector);
return result;
}
const vec3 infBox = vec3(1000.0);
vec3 cubeMapProject(vec3 reflectionW, in ReflectionProbe reflectionProbe) {
vec3 firstPlaneIntersect = (reflectionProbe.boxMax.xyz - vPositionW) / reflectionW;
vec3 secondPlaneIntersect = (reflectionProbe.boxMin.xyz - vPositionW) / reflectionW;
vec3 furthestPlane = max(firstPlaneIntersect, secondPlaneIntersect);
vec3 furthestPlaneNonNeg = step(0.0, -furthestPlane) * infBox + abs(furthestPlane);
float distance = min(min(furthestPlaneNonNeg.x, furthestPlaneNonNeg.y), furthestPlaneNonNeg.z);
vec3 intersectionPosW = vPositionW + reflectionW * distance;
return intersectionPosW - reflectionProbe.posW.xyz;
}
float signedDistanceBox(vec3 p, vec3 b, float offset) {
vec3 q = abs(p) - b;
return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0) - offset;
}
float getSignedDistanceField(in ReflectionProbe probe) {
vec3 halfBox = vec3(probe.boxMax - probe.boxMin) * vec3(0.5);
vec3 boxPos = vec3(probe.boxMax + probe.boxMin) * vec3(0.5);
vec3 localPos = boxPos - vPositionW;
const float offset = 0.1;
return signedDistanceBox(localPos, halfBox, offset);
}
vec3 sampleEnvMap(in EnvMapLevel envMapLevel, in vec3 reflectionW, samplerCube envMap,
int probeIndex) {
#ifdef USE_ENVMAP_PROJECT
ReflectionProbe reflectionProbe = reflectionProbes[probeIndex];
if (reflectionProbe.boxMin.x != reflectionProbe.boxMax.x)
reflectionW = cubeMapProject(reflectionW, reflectionProbe);
#endif
vec4 cubeColorRaw0 = textureCubeLodEXT(envMap, reflectionW, envMapLevel.mipLevel0);
vec3 cubeColor0 = hdrDecodeRgbm(cubeColorRaw0);
vec4 cubeColorRaw1 = textureCubeLodEXT(envMap, reflectionW, envMapLevel.mipLevel1);
vec3 cubeColor1 = hdrDecodeRgbm(cubeColorRaw1);
return mix(cubeColor0, cubeColor1, envMapLevel.mipMixFactor);
}
vec3 sampleEnvMapBlended(in EnvMapLevel envMapLevel, in vec3 reflectionW) {
#ifdef USE_REFLECTION_PROBE_BLENDING
float weight[NUM_REFLECTION_PROBES];
#ifdef USE_ENVMAP_PROJECT
for (int i = 0; i < NUM_REFLECTION_PROBES; i++) {
weight[i] = max(-getSignedDistanceField(reflectionProbes[i]), 0.0);
weight[i] = smoothstep(0.0, 1.0, weight[i]);
}
float weightSum = weight[0] + weight[1] + weight[2];
if (weightSum == 0.0) {
weight[0] = 1.0;
} else {
for (int i = 0; i < NUM_REFLECTION_PROBES; i++) weight[i] /= weightSum;
}
#else
for (int i = 0; i < NUM_REFLECTION_PROBES; i++) weight[i] = 1.0;
#endif
vec3 envColor = vec3(0.0, 0.0, 0.0);
if (weight[0] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0) * weight[0];
if (NUM_REFLECTION_PROBES >= 2 && weight[1] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[1], 1) * weight[1];
if (NUM_REFLECTION_PROBES >= 3 && weight[2] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[2], 2) * weight[2];
#else  // not USE_REFLECTION_PROBE_BLENDING
vec3 envColor = sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0);
#endif
return envColor;
}
#endif
float getEnvMapFresnel(float roughness) {
float roughness2 = roughness * roughness;
return (roughness2 - 2.0 * roughness + 1.0);
}
vec3 fresnelSchlickEnv(in vec3 specularColor, in float envMapFresnel, in float clampCosnv,
inout float opacity) {
float fresnel = 1.0 - clampCosnv;
float fresnel2 = fresnel * fresnel;
fresnel *= fresnel2 * fresnel2;
fresnel *= envMapFresnel;
opacity = opacity + (1.0 - opacity) * fresnel;
return specularColor + (1.0 - specularColor) * fresnel;
}
vec3 getSpecularColor(in vec3 baseColor, float metalic) {
const float dielectricF0 = 0.04;
return mix(vec3(dielectricF0), baseColor, metalic);
}
float getLuminance(in vec3 color) {
return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;
}
#if defined(USE_ENVMAP)
vec3 getNormalW() {
float sign = gl_FrontFacing ? 1.0 : -1.0;
#ifdef USE_BUMP_TEXTURE
vec3 normalPerturbedV = perturbNormal(-vPositionV, normalize(vNormalV));
return normalize(inverseTransformDirection(normalPerturbedV, viewMatrix)) * sign;
#else
return normalize(vNormalW) * sign;
#endif
}
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
vec3 totalSpec = vec3(0.0, 0.0, 0.0);
float metallic = getMetallic();
float roughness = getRoughness();
vec3 diffuseIntensity = totalIntensity * (1.0 - mix(0.04, 1.0, metallic));
vec3 viewW = normalize(cameraPosition - vPositionW);
vec3 normalW = getNormalW();
float clampCosnv = saturate(dot(normalW, viewW));
vec3 reflectionW = normalize(reflect(-viewW, normalW));
vec3 specularColor = getSpecularColor(baseColor, metallic);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
vec3 fresnel = fresnelSchlickEnv(specularColor, envMapFresnel, clampCosnv, opacity);
float luminance = getLuminance(totalIntensity);
totalSpec = envColor * getBrdf(roughness, fresnel, clampCosnv, specularColor);
#if defined(WEAK_REFLECTION_SHADOW)
float shadowingFactor = mix(0.4, 1.0, luminance);
#else
float shadowingFactor = mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, metallic);
#endif
return baseColor * diffuseIntensity + totalSpec * shadowingFactor;
}
#else  // NOT USE_ENVMAP
vec3 addSpecular(vec3 baseColor, in vec3 lightIntensity, in float opacity) {
return baseColor * lightIntensity;
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef USE_HIGHLIGHT
uniform vec3 highlight;
uniform float highlightMix;
#endif
#endif
#if defined(HDR_OUTPUT)
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture2D(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture2D(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
#ifdef USE_CHROMA_KEY
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 chromaKeyColor;
uniform vec3 chromaKeyDeltaCoeff;
#endif
const float k32 = sqrt(3.0) / 2.0;
vec3 rgb2abi(vec3 color) {
float r = color.r;
float g = color.g;
float b = color.b;
return vec3(r - 0.5 * g - 0.5 * b, k32 * (g - b), 0.3333 * (r + g + b));
}
const float IPI2 = 0.5 / 3.1415926538;
vec3 rgb2hci(vec3 color) {
vec3 abi = rgb2abi(color);
return vec3(atan(abi.y, abi.x) * IPI2, length(abi.xy), abi.z);
}
float chromaKeyShapeFn(vec3 delta, vec3 color, vec3 key) {
vec3 diff = color - key;
vec3 v = delta * vec3(
0.5 - abs(abs(diff.x) - 0.5), abs(diff.y), abs(diff.z));
float x = max(v.r, max(v.g, v.b));
return x * x;
}
float chromaKeyEdgeFn(float a) {
return clamp(.2 / .5 * (a - 1.0), 0.0, 1.0);
}
#endif
struct BSDF {
vec3 response;
vec3 throughput;
float thickness;
float ior;
};
struct SurfaceShader {
vec3 color;
vec3 transparency;
};
struct LightShader {
vec3 intensity;
vec3 direction;
};
#define u_envLightIntensity 1.0
#define u_envRadianceSamples 4
#define u_envRadianceMips envMipsCount
#define u_refractionTwoSided true
#define M_FLOAT_EPS 1e-8
BSDF combineBsdf(BSDF topLayer, BSDF bottomLayer) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
result.response = topLayer.response + bottomLayer.response * topLayer.throughput;
result.throughput = topLayer.throughput * bottomLayer.throughput;
return result;
}
BSDF mixBsdf(BSDF x, BSDF y, float a) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
result.response = mix(x.response, y.response, a);
result.throughput = mix(x.throughput, y.throughput, a);
return result;
}
float mx_square(float x) {
return x * x;
}
vec2 mx_square(vec2 x) {
return x * x;
}
vec3 mx_square(vec3 x) {
return x * x;
}
#define DIRECTIONAL_ALBEDO_METHOD 0
#define MAX_LIGHT_SOURCES 9
#define M_PI 3.1415926535897932
#define M_PI_INV (1.0 / M_PI)
float mx_pow5(float x) {
return mx_square(mx_square(x)) * x;
}
float mx_fresnel_schlick(float cosTheta, float F0) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = mx_pow5(x);
return F0 + (1.0 - F0) * x5;
}
vec3 mx_fresnel_schlick(float cosTheta, vec3 F0) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = mx_pow5(x);
return F0 + (1.0 - F0) * x5;
}
float mx_fresnel_schlick(float cosTheta, float F0, float F90) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = mx_pow5(x);
return mix(F0, F90, x5);
}
vec3 mx_fresnel_schlick(float cosTheta, vec3 F0, vec3 F90) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
float x5 = mx_pow5(x);
return mix(F0, F90, x5);
}
float mx_fresnel_schlick(float cosTheta, float F0, float F90, float exponent) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
return mix(F0, F90, pow(x, exponent));
}
vec3 mx_fresnel_schlick(float cosTheta, vec3 F0, vec3 F90, float exponent) {
float x = clamp(1.0 - cosTheta, 0.0, 1.0);
return mix(F0, F90, pow(x, exponent));
}
vec3 mx_forward_facing_normal(vec3 N, vec3 V) {
return (dot(N, V) < 0.0) ? -N : N;
}
float mx_golden_ratio_sequence(int i) {
const float GOLDEN_RATIO = 1.6180339887498948;
return fract((float(i) + 1.0) * GOLDEN_RATIO);
}
vec2 mx_spherical_fibonacci(int i, int numSamples) {
return vec2((float(i) + 0.5) / float(numSamples), mx_golden_ratio_sequence(i));
}
vec3 mx_uniform_sample_hemisphere(vec2 Xi) {
float phi = 2.0 * M_PI * Xi.x;
float cosTheta = 1.0 - Xi.y;
float sinTheta = sqrt(1.0 - mx_square(cosTheta));
return vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);
}
const int FRESNEL_MODEL_DIELECTRIC = 0;
const int FRESNEL_MODEL_CONDUCTOR = 1;
const int FRESNEL_MODEL_SCHLICK = 2;
const int FRESNEL_MODEL_AIRY = 3;
const int FRESNEL_MODEL_SCHLICK_AIRY = 4;
const mat3 XYZ_TO_RGB = mat3(2.3706743, -0.5138850, 0.0052982, -0.9000405, 1.4253036, -0.0146949,
-0.4706338, 0.0885814, 1.0093968);
struct FresnelData {
int model;
vec3 ior;
vec3 extinction;
vec3 F0;
vec3 F90;
float exponent;
float tf_thickness;
float tf_ior;
bool refraction;
};
float mx_ggx_NDF(vec3 H, vec2 alpha) {
vec2 He = H.xy / alpha;
float denom = dot(He, He) + mx_square(H.z);
return 1.0 / (M_PI * alpha.x * alpha.y * mx_square(denom));
}
vec3 mx_ggx_importance_sample_VNDF(vec2 Xi, vec3 V, vec2 alpha) {
V = normalize(vec3(V.xy * alpha, V.z));
float phi = 2.0 * M_PI * Xi.x;
float z = (1.0 - Xi.y) * (1.0 + V.z) - V.z;
float sinTheta = sqrt(clamp(1.0 - z * z, 0.0, 1.0));
float x = sinTheta * cos(phi);
float y = sinTheta * sin(phi);
vec3 c = vec3(x, y, z);
vec3 H = c + V;
H = normalize(vec3(H.xy * alpha, max(H.z, 0.0)));
return H;
}
float mx_ggx_smith_G1(float cosTheta, float alpha) {
float cosTheta2 = mx_square(cosTheta);
float tanTheta2 = (1.0 - cosTheta2) / cosTheta2;
return 2.0 / (1.0 + sqrt(1.0 + mx_square(alpha) * tanTheta2));
}
float mx_ggx_smith_G2(float NdotL, float NdotV, float alpha) {
float alpha2 = mx_square(alpha);
float lambdaL = sqrt(alpha2 + (1.0 - alpha2) * mx_square(NdotL));
float lambdaV = sqrt(alpha2 + (1.0 - alpha2) * mx_square(NdotV));
return 2.0 / (lambdaL / NdotL + lambdaV / NdotV);
}
vec3 mx_ggx_dir_albedo_analytic(float NdotV, float alpha, vec3 F0, vec3 F90) {
float x = NdotV;
float y = alpha;
float x2 = mx_square(x);
float y2 = mx_square(y);
vec4 r = vec4(0.1003, 0.9345, 1.0, 1.0) + vec4(-0.6303, -2.323, -1.765, 0.2281) * x +
vec4(9.748, 2.229, 8.263, 15.94) * y + vec4(-2.038, -3.748, 11.53, -55.83) * x * y +
vec4(29.34, 1.424, 28.96, 13.08) * x2 + vec4(-8.245, -0.7684, -7.507, 41.26) * y2 +
vec4(-26.44, 1.436, -36.11, 54.9) * x2 * y + vec4(19.99, 0.2913, 15.86, 300.2) * x * y2 +
vec4(-5.448, 0.6286, 33.37, -285.1) * x2 * y2;
vec2 AB = clamp(r.xy / r.zw, 0.0, 1.0);
return F0 * AB.x + F90 * AB.y;
}
vec3 mx_ggx_dir_albedo(float NdotV, float alpha, vec3 F0, vec3 F90) {
return mx_ggx_dir_albedo_analytic(NdotV, alpha, F0, F90);
}
float mx_ggx_dir_albedo(float NdotV, float alpha, float F0, float F90) {
return mx_ggx_dir_albedo(NdotV, alpha, vec3(F0), vec3(F90)).x;
}
vec3 mx_ggx_energy_compensation(float NdotV, float alpha, vec3 Fss) {
float Ess = mx_ggx_dir_albedo(NdotV, alpha, 1.0, 1.0);
return 1.0 + Fss * (1.0 - Ess) / Ess;
}
float mx_ggx_energy_compensation(float NdotV, float alpha, float Fss) {
return mx_ggx_energy_compensation(NdotV, alpha, vec3(Fss)).x;
}
float mx_average_alpha(vec2 alpha) {
return sqrt(alpha.x * alpha.y);
}
float mx_ior_to_f0(float ior) {
return mx_square((ior - 1.0) / (ior + 1.0));
}
float mx_f0_to_ior(float F0) {
float sqrtF0 = sqrt(clamp(F0, 0.01, 0.99));
return (1.0 + sqrtF0) / (1.0 - sqrtF0);
}
vec3 mx_f0_to_ior_colored(vec3 F0) {
vec3 sqrtF0 = sqrt(clamp(F0, 0.01, 0.99));
return (vec3(1.0) + sqrtF0) / (vec3(1.0) - sqrtF0);
}
float mx_fresnel_dielectric(float cosTheta, float ior) {
if (cosTheta < 0.0)
return 1.0;
float g = ior * ior + cosTheta * cosTheta - 1.0;
if (g < 0.0)
return 1.0;
g = sqrt(g);
float gmc = g - cosTheta;
float gpc = g + cosTheta;
float x = gmc / gpc;
float y = (gpc * cosTheta - 1.0) / (gmc * cosTheta + 1.0);
return 0.5 * x * x * (1.0 + y * y);
}
void mx_fresnel_dielectric_polarized(float cosTheta, float n, out float Rp, out float Rs) {
if (cosTheta < 0.0) {
Rp = 1.0;
Rs = 1.0;
return;
}
float cosTheta2 = cosTheta * cosTheta;
float sinTheta2 = 1.0 - cosTheta2;
float n2 = n * n;
float t0 = n2 - sinTheta2;
float a2plusb2 = sqrt(t0 * t0);
float t1 = a2plusb2 + cosTheta2;
float a = sqrt(max(0.5 * (a2plusb2 + t0), 0.0));
float t2 = 2.0 * a * cosTheta;
Rs = (t1 - t2) / (t1 + t2);
float t3 = cosTheta2 * a2plusb2 + sinTheta2 * sinTheta2;
float t4 = t2 * sinTheta2;
Rp = Rs * (t3 - t4) / (t3 + t4);
}
void mx_fresnel_dielectric_polarized(float cosTheta, float eta1, float eta2, out float Rp,
out float Rs) {
float n = eta2 / eta1;
mx_fresnel_dielectric_polarized(cosTheta, n, Rp, Rs);
}
void mx_fresnel_conductor_polarized(float cosTheta, vec3 n, vec3 k, out vec3 Rp, out vec3 Rs) {
cosTheta = clamp(cosTheta, 0.0, 1.0);
float cosTheta2 = cosTheta * cosTheta;
float sinTheta2 = 1.0 - cosTheta2;
vec3 n2 = n * n;
vec3 k2 = k * k;
vec3 t0 = n2 - k2 - vec3(sinTheta2);
vec3 a2plusb2 = sqrt(t0 * t0 + 4.0 * n2 * k2);
vec3 t1 = a2plusb2 + vec3(cosTheta2);
vec3 a = sqrt(max(0.5 * (a2plusb2 + t0), 0.0));
vec3 t2 = 2.0 * a * cosTheta;
Rs = (t1 - t2) / (t1 + t2);
vec3 t3 = cosTheta2 * a2plusb2 + vec3(sinTheta2 * sinTheta2);
vec3 t4 = t2 * sinTheta2;
Rp = Rs * (t3 - t4) / (t3 + t4);
}
void mx_fresnel_conductor_polarized(float cosTheta, float eta1, vec3 eta2, vec3 kappa2, out vec3 Rp,
out vec3 Rs) {
vec3 n = eta2 / eta1;
vec3 k = kappa2 / eta1;
mx_fresnel_conductor_polarized(cosTheta, n, k, Rp, Rs);
}
vec3 mx_fresnel_conductor(float cosTheta, vec3 n, vec3 k) {
vec3 Rp, Rs;
mx_fresnel_conductor_polarized(cosTheta, n, k, Rp, Rs);
return 0.5 * (Rp + Rs);
}
void mx_fresnel_dielectric_phase_polarized(float cosTheta, float eta1, float eta2, out float phiP,
out float phiS) {
float cosB = cos(atan(eta2 / eta1));  // Brewster's angle
if (eta2 > eta1) {
phiP = cosTheta < cosB ? M_PI : 0.0f;
phiS = 0.0f;
} else {
phiP = cosTheta < cosB ? 0.0f : M_PI;
phiS = M_PI;
}
}
void mx_fresnel_conductor_phase_polarized(float cosTheta, float eta1, vec3 eta2, vec3 kappa2,
out vec3 phiP, out vec3 phiS) {
if (dot(kappa2, kappa2) == 0.0 && eta2.x == eta2.y && eta2.y == eta2.z) {
float phiPx, phiSx;
mx_fresnel_dielectric_phase_polarized(cosTheta, eta1, eta2.x, phiPx, phiSx);
phiP = vec3(phiPx, phiPx, phiPx);
phiS = vec3(phiSx, phiSx, phiSx);
return;
}
vec3 k2 = kappa2 / eta2;
vec3 sinThetaSqr = vec3(1.0) - cosTheta * cosTheta;
vec3 A = eta2 * eta2 * (vec3(1.0) - k2 * k2) - eta1 * eta1 * sinThetaSqr;
vec3 B = sqrt(A * A + mx_square(2.0 * eta2 * eta2 * k2));
vec3 U = sqrt((A + B) / 2.0);
vec3 V = max(vec3(0.0), sqrt((B - A) / 2.0));
phiS = atan(2.0 * eta1 * V * cosTheta, U * U + V * V - mx_square(eta1 * cosTheta));
phiP = atan(
2.0 * eta1 * eta2 * eta2 * cosTheta * (2.0 * k2 * U - (vec3(1.0) - k2 * k2) * V),
mx_square(eta2 * eta2 * (vec3(1.0) + k2 * k2) * cosTheta) - eta1 * eta1 * (U * U + V * V));
}
vec3 mx_eval_sensitivity(float opd, vec3 shift) {
float phase = 2.0 * M_PI * opd;
vec3 val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);
vec3 pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);
vec3 var = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);
vec3 xyz = val * sqrt(2.0 * M_PI * var) * cos(pos * phase + shift) * exp(-var * phase * phase);
xyz.x += 9.7470e-14 * sqrt(2.0 * M_PI * 4.5282e+09) * cos(2.2399e+06 * phase + shift[0]) *
exp(-4.5282e+09 * phase * phase);
return xyz / 1.0685e-7;
}
vec3 mx_fresnel_airy(float cosTheta, vec3 ior, vec3 extinction, float tf_thickness, float tf_ior,
vec3 f0, vec3 f90, float exponent, bool use_schlick) {
float d = tf_thickness * 1.0e-9;
float eta1 = 1.0;
float eta2 = max(tf_ior, eta1);
vec3 eta3 = use_schlick ? mx_f0_to_ior_colored(f0) : ior;
vec3 kappa3 = use_schlick ? vec3(0.0) : extinction;
float R12p, T121p, R12s, T121s;
vec3 R23p, R23s;
mx_fresnel_dielectric_polarized(cosTheta, eta1, eta2, R12p, R12s);
float scale = eta1 / eta2;
float cosThetaTSqr = 1.0 - (1.0 - cosTheta * cosTheta) * scale * scale;
float cosTheta2 = sqrt(cosThetaTSqr);
if (use_schlick) {
vec3 f = mx_fresnel_schlick(cosTheta2, f0, f90, exponent);
R23p = 0.5 * f;
R23s = 0.5 * f;
} else {
mx_fresnel_conductor_polarized(cosTheta2, eta2, eta3, kappa3, R23p, R23s);
}
if (cosThetaTSqr <= 0.0f) {
R12s = 1.0;
R12p = 1.0;
}
T121p = 1.0 - R12p;
T121s = 1.0 - R12s;
float D = 2.0 * eta2 * d * cosTheta2;
float phi21p, phi21s;
vec3 phi23p, phi23s, r123s, r123p;
mx_fresnel_dielectric_phase_polarized(cosTheta, eta1, eta2, phi21p, phi21s);
if (use_schlick) {
phi23p = vec3((eta3[0] < eta2) ? M_PI : 0.0, (eta3[1] < eta2) ? M_PI : 0.0,
(eta3[2] < eta2) ? M_PI : 0.0);
phi23s = phi23p;
} else {
mx_fresnel_conductor_phase_polarized(cosTheta2, eta2, eta3, kappa3, phi23p, phi23s);
}
phi21p = M_PI - phi21p;
phi21s = M_PI - phi21s;
r123p = max(vec3(0.0), sqrt(R12p * R23p));
r123s = max(vec3(0.0), sqrt(R12s * R23s));
vec3 I = vec3(0.0);
vec3 C0, Cm, Sm;
vec3 S0 = vec3(1.0);
vec3 Rs = (T121p * T121p * R23p) / (vec3(1.0) - R12p * R23p);
C0 = R12p + Rs;
I += C0 * S0;
Cm = Rs - T121p;
for (int m = 1; m <= 2; ++m) {
Cm *= r123p;
Sm = 2.0 * mx_eval_sensitivity(float(m) * D, float(m) * (phi23p + vec3(phi21p)));
I += Cm * Sm;
}
vec3 Rp = (T121s * T121s * R23s) / (vec3(1.0) - R12s * R23s);
C0 = R12s + Rp;
I += C0 * S0;
Cm = Rp - T121s;
for (int m = 1; m <= 2; ++m) {
Cm *= r123s;
Sm = 2.0 * mx_eval_sensitivity(float(m) * D, float(m) * (phi23s + vec3(phi21s)));
I += Cm * Sm;
}
I *= 0.5;
I = clamp(XYZ_TO_RGB * I, vec3(0.0), vec3(1.0));
return I;
}
FresnelData mx_init_fresnel_data(int model) {
return FresnelData(model, vec3(0.0), vec3(0.0), vec3(0.0), vec3(0.0), 0.0, 0.0, 0.0, false);
}
FresnelData mx_init_fresnel_dielectric(float ior) {
FresnelData fd = mx_init_fresnel_data(FRESNEL_MODEL_DIELECTRIC);
fd.ior = vec3(ior);
return fd;
}
FresnelData mx_init_fresnel_conductor(vec3 ior, vec3 extinction) {
FresnelData fd = mx_init_fresnel_data(FRESNEL_MODEL_CONDUCTOR);
fd.ior = ior;
fd.extinction = extinction;
return fd;
}
FresnelData mx_init_fresnel_schlick(vec3 F0) {
FresnelData fd = mx_init_fresnel_data(FRESNEL_MODEL_SCHLICK);
fd.F0 = F0;
fd.F90 = vec3(1.0);
fd.exponent = 5.0f;
return fd;
}
FresnelData mx_init_fresnel_schlick(vec3 F0, vec3 F90, float exponent) {
FresnelData fd = mx_init_fresnel_data(FRESNEL_MODEL_SCHLICK);
fd.F0 = F0;
fd.F90 = F90;
fd.exponent = exponent;
return fd;
}
FresnelData mx_init_fresnel_schlick_airy(vec3 F0, vec3 F90, float exponent, float tf_thickness,
float tf_ior) {
FresnelData fd = mx_init_fresnel_data(FRESNEL_MODEL_SCHLICK_AIRY);
fd.F0 = F0;
fd.F90 = F90;
fd.exponent = exponent;
fd.tf_thickness = tf_thickness;
fd.tf_ior = tf_ior;
return fd;
}
FresnelData mx_init_fresnel_dielectric_airy(float ior, float tf_thickness, float tf_ior) {
FresnelData fd = mx_init_fresnel_data(FRESNEL_MODEL_AIRY);
fd.ior = vec3(ior);
fd.tf_thickness = tf_thickness;
fd.tf_ior = tf_ior;
return fd;
}
FresnelData mx_init_fresnel_conductor_airy(vec3 ior, vec3 extinction, float tf_thickness,
float tf_ior) {
FresnelData fd = mx_init_fresnel_data(FRESNEL_MODEL_AIRY);
fd.ior = ior;
fd.extinction = extinction;
fd.tf_thickness = tf_thickness;
fd.tf_ior = tf_ior;
return fd;
}
vec3 mx_compute_fresnel(float cosTheta, FresnelData fd) {
if (fd.model == FRESNEL_MODEL_DIELECTRIC) {
return vec3(mx_fresnel_dielectric(cosTheta, fd.ior.x));
} else if (fd.model == FRESNEL_MODEL_CONDUCTOR) {
return mx_fresnel_conductor(cosTheta, fd.ior, fd.extinction);
} else if (fd.model == FRESNEL_MODEL_SCHLICK) {
return mx_fresnel_schlick(cosTheta, fd.F0, fd.F90, fd.exponent);
} else {
return mx_fresnel_airy(cosTheta, fd.ior, fd.extinction, fd.tf_thickness, fd.tf_ior, fd.F0,
fd.F90, fd.exponent, fd.model == FRESNEL_MODEL_SCHLICK_AIRY);
}
}
vec3 mx_refraction_solid_sphere(vec3 R, vec3 N, float ior) {
R = refract(R, N, 1.0 / ior);
vec3 N1 = normalize(R * dot(R, N) - N * 0.5);
return refract(R, N1, ior);
}
vec2 mx_latlong_projection(vec3 dir) {
float latitude = -asin(dir.y) * M_PI_INV + 0.5;
float longitude = atan(dir.x, -dir.z) * M_PI_INV * 0.5 + 0.5;
return vec2(longitude, latitude);
}
vec3 mx_latlong_map_lookup(vec3 dir, mat4 transform, float lod, sampler2D envSampler) {
vec3 envDir = normalize((transform * vec4(dir, 0.0)).xyz);
vec2 uv = mx_latlong_projection(envDir);
return textureLod(envSampler, uv, lod).rgb;
}
float mx_latlong_compute_lod(vec3 dir, float pdf, float maxMipLevel, int envSamples) {
#ifdef USE_ENVMAP
const float MIP_LEVEL_OFFSET = 1.5;
float effectiveMaxMipLevel = maxMipLevel - MIP_LEVEL_OFFSET;
float distortion = sqrt(1.0 - mx_square(dir.y));
return max(effectiveMaxMipLevel - 0.5 * log2(float(envSamples) * pdf * distortion), 0.0);
#else
return 0.0;
#endif
}
vec3 mx_environment_radiance(vec3 N, vec3 V, vec3 X, vec2 alpha, int distribution, FresnelData fd) {
#ifdef USE_ENVMAP
X = normalize(X - dot(X, N) * N);
vec3 Y = cross(N, X);
mat3 tangentToWorld = mat3(X, Y, N);
V = vec3(dot(V, X), dot(V, Y), dot(V, N));
float NdotV = clamp(V.z, M_FLOAT_EPS, 1.0);
float avgAlpha = mx_average_alpha(alpha);
float G1V = mx_ggx_smith_G1(NdotV, avgAlpha);
vec3 radiance = vec3(0.0);
int envRadianceSamples = u_envRadianceSamples;
for (int i = 0; i < envRadianceSamples; i++) {
vec2 Xi = mx_spherical_fibonacci(i, envRadianceSamples);
vec3 H = mx_ggx_importance_sample_VNDF(Xi, V, alpha);
vec3 L = fd.refraction ? mx_refraction_solid_sphere(-V, H, fd.ior.x) : -reflect(V, H);
float NdotL = clamp(L.z, M_FLOAT_EPS, 1.0);
float VdotH = clamp(dot(V, H), M_FLOAT_EPS, 1.0);
vec3 Lw = tangentToWorld * L;
float pdf = mx_ggx_NDF(H, alpha) * G1V / (4.0 * NdotV);
float lod = mx_latlong_compute_lod(Lw, pdf, u_envRadianceMips - 1.0, envRadianceSamples);
EnvMapLevel envMapLevel;
envMapLevel.mipLevel0 = floor(lod);
envMapLevel.mipLevel1 = min(envMapLevel.mipLevel0 + 1.0, envMipsCount - 1.0);
envMapLevel.mipMixFactor = fract(lod);
vec3 sampleColor = sampleEnvMapBlended(envMapLevel, Lw);
vec3 F = mx_compute_fresnel(VdotH, fd);
float G = mx_ggx_smith_G2(NdotL, NdotV, avgAlpha);
vec3 FG = fd.refraction ? vec3(1.0) - (F * G) : F * G;
radiance += sampleColor * FG;
}
radiance /= G1V * float(envRadianceSamples);
return radiance * u_envLightIntensity;
#else
return vec3(0.0);
#endif
}
vec3 mx_environment_irradiance(vec3 N) {
#ifdef USE_ENVMAP
EnvMapLevel envMapLevel;
float mipLevel = max(0.0, envMipsCount - 2.0);
envMapLevel.mipLevel0 = mipLevel;
envMapLevel.mipLevel1 = mipLevel;
envMapLevel.mipMixFactor = 0.0;
return sampleEnvMap(envMapLevel, N, envMap[0], 0) * u_envLightIntensity;
#else
return vec3(0.0);
#endif
}
vec3 mx_surface_transmission(vec3 N, vec3 V, vec3 X, vec2 alpha, int distribution, FresnelData fd,
vec3 tint) {
fd.refraction = true;
if (u_refractionTwoSided) {
tint = mx_square(tint);
}
return mx_environment_radiance(N, V, X, alpha, distribution, fd) * tint;
}
void mx_uniform_edf(vec3 N, vec3 L, vec3 color, out vec3 result) {
result = color;
}
void mx_rotate_vector2(vec2 _in, float amount, out vec2 result) {
float rotationRadians = radians(amount);
float sa = sin(rotationRadians);
float ca = cos(rotationRadians);
result = vec2(ca * _in.x + sa * _in.y, -sa * _in.x + ca * _in.y);
}
void NG_place2d_vector2(vec2 texcoord1, vec2 pivot, vec2 scale, float rotate, vec2 offset,
int operationorder, out vec2 out1) {
vec2 N_subpivot_out = texcoord1 - pivot;
vec2 N_applyscale_out = N_subpivot_out / scale;
vec2 N_applyoffset2_out = N_subpivot_out - offset;
vec2 N_applyrot_out = vec2(0.0);
mx_rotate_vector2(N_applyscale_out, rotate, N_applyrot_out);
vec2 N_applyrot2_out = vec2(0.0);
mx_rotate_vector2(N_applyoffset2_out, rotate, N_applyrot2_out);
vec2 N_applyoffset_out = N_applyrot_out - offset;
vec2 N_applyscale2_out = N_applyrot2_out / scale;
vec2 N_addpivot_out = N_applyoffset_out + pivot;
vec2 N_addpivot2_out = N_applyscale2_out + pivot;
vec2 N_switch_operationorder_out = vec2(0.0);
if (float(operationorder) < float(1)) {
N_switch_operationorder_out = N_addpivot_out;
} else if (float(operationorder) < float(2)) {
N_switch_operationorder_out = N_addpivot2_out;
} else if (float(operationorder) < float(3)) {
N_switch_operationorder_out = vec2(0.000000, 0.000000);
} else if (float(operationorder) < float(4)) {
N_switch_operationorder_out = vec2(0.000000, 0.000000);
} else if (float(operationorder) < float(5)) {
N_switch_operationorder_out = vec2(0.000000, 0.000000);
}
out1 = N_switch_operationorder_out;
}
vec2 mx_transform_uv(vec2 uv, vec2 uv_scale, vec2 uv_offset) {
uv = uv * uv_scale + uv_offset;
return uv;
}
void mx_image_color4(sampler2D tex_sampler, int layer, vec4 defaultval, vec2 texcoord,
int uaddressmode, int vaddressmode, int filtertype, int framerange,
int frameoffset, int frameendaction, vec2 uv_scale, vec2 uv_offset,
out vec4 result) {
vec2 uv = mx_transform_uv(texcoord, uv_scale, uv_offset);
result = texture(tex_sampler, uv);
}
void NG_srgb_texture_to_lin_rec709_color3(vec3 in1, out vec3 out1) {
const float bias_in2_tmp = 0.055000;
vec3 bias_out = in1 + bias_in2_tmp;
const float linSeg_in2_tmp = 12.920000;
vec3 linSeg_out = in1 / linSeg_in2_tmp;
const float isAboveR_value2_tmp = 0.040450;
const float isAboveR_in1_tmp = 1.000000;
const float isAboveR_in2_tmp = 0.000000;
float isAboveR_out = (in1.x > isAboveR_value2_tmp) ? isAboveR_in1_tmp : isAboveR_in2_tmp;
const float isAboveG_value2_tmp = 0.040450;
const float isAboveG_in1_tmp = 1.000000;
const float isAboveG_in2_tmp = 0.000000;
float isAboveG_out = (in1.y > isAboveG_value2_tmp) ? isAboveG_in1_tmp : isAboveG_in2_tmp;
const float isAboveB_value2_tmp = 0.040450;
const float isAboveB_in1_tmp = 1.000000;
const float isAboveB_in2_tmp = 0.000000;
float isAboveB_out = (in1.z > isAboveB_value2_tmp) ? isAboveB_in1_tmp : isAboveB_in2_tmp;
const float max_in2_tmp = 0.000000;
vec3 max_out = max(bias_out, max_in2_tmp);
vec3 isAbove_out = vec3(isAboveR_out, isAboveG_out, isAboveB_out);
const float scale_in2_tmp = 1.055000;
vec3 scale_out = max_out / scale_in2_tmp;
const float powSeg_in2_tmp = 2.400000;
vec3 powSeg_out = pow(scale_out, vec3(powSeg_in2_tmp));
vec3 mix_out = mix(linSeg_out, powSeg_out, isAbove_out);
out1 = mix_out;
}
void NG_srgb_texture_to_lin_rec709_color4(vec4 in1, out vec4 out1) {
vec3 asColor3_out = vec3(in1.x, in1.y, in1.z);
vec3 transform_out = vec3(0.0);
NG_srgb_texture_to_lin_rec709_color3(asColor3_out, transform_out);
vec4 asColor4_out = vec4(transform_out.x, transform_out.y, transform_out.z, in1.w);
out1 = asColor4_out;
}
void NG_separate4_color4(vec4 in1, out float outr, out float outg, out float outb, out float outa) {
float N_r_color4_out = in1.x;
float N_g_color4_out = in1.y;
float N_b_color4_out = in1.z;
float N_a_color4_out = in1.w;
outr = N_r_color4_out;
outg = N_g_color4_out;
outb = N_b_color4_out;
outa = N_a_color4_out;
}
void mx_image_vector3(sampler2D tex_sampler, int layer, vec3 defaultval, vec2 texcoord,
int uaddressmode, int vaddressmode, int filtertype, int framerange,
int frameoffset, int frameendaction, vec2 uv_scale, vec2 uv_offset,
out vec3 result) {
vec2 uv = mx_transform_uv(texcoord, uv_scale, uv_offset);
result = texture(tex_sampler, uv).rgb;
}
void mx_normalmap_vector2(vec3 value, int map_space, vec2 normal_scale, vec3 N, vec3 T,
out vec3 result) {
value = (value == vec3(0.0f)) ? vec3(0.0, 0.0, 1.0) : value * 2.0 - 1.0;
if (map_space == 0) {
vec3 B = normalize(cross(N, T));
value.xy *= normal_scale;
value = T * value.x + B * value.y + N * value.z;
}
result = normalize(value);
}
void mx_normalmap_float(vec3 value, int map_space, float normal_scale, vec3 N, vec3 T,
out vec3 result) {
mx_normalmap_vector2(value, map_space, vec2(normal_scale), N, T, result);
}
void mx_image_color3(sampler2D tex_sampler, int layer, vec3 defaultval, vec2 texcoord,
int uaddressmode, int vaddressmode, int filtertype, int framerange,
int frameoffset, int frameendaction, vec2 uv_scale, vec2 uv_offset,
out vec3 result) {
vec2 uv = mx_transform_uv(texcoord, uv_scale, uv_offset);
result = texture(tex_sampler, uv).rgb;
}
void mx_roughness_anisotropy(float roughness, float anisotropy, out vec2 result) {
float roughness_sqr = clamp(roughness * roughness, M_FLOAT_EPS, 1.0);
if (anisotropy > 0.0) {
float aspect = sqrt(1.0 - clamp(anisotropy, 0.0, 0.98));
result.x = min(roughness_sqr / aspect, 1.0);
result.y = roughness_sqr * aspect;
} else {
result.x = roughness_sqr;
result.y = roughness_sqr;
}
}
void NG_extract_color3(vec3 in1, int index, out float out1) {
float N_r_color3_out = in1.x;
float N_g_color3_out = in1.y;
float N_b_color3_out = in1.z;
float N_sw_color3_out = 0.0;
if (float(index) < float(1)) {
N_sw_color3_out = N_r_color3_out;
} else if (float(index) < float(2)) {
N_sw_color3_out = N_g_color3_out;
} else if (float(index) < float(3)) {
N_sw_color3_out = N_b_color3_out;
} else if (float(index) < float(4)) {
N_sw_color3_out = 0.000000;
} else if (float(index) < float(5)) {
N_sw_color3_out = 0.000000;
}
out1 = N_sw_color3_out;
}
float mx_oren_nayar_diffuse(vec3 L, vec3 V, vec3 N, float NdotL, float roughness) {
float LdotV = clamp(dot(L, V), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float s = LdotV - NdotL * NdotV;
float stinv = (s > 0.0f) ? s / max(NdotL, NdotV) : 0.0;
float sigma2 = mx_square(roughness * M_PI);
float A = 1.0 - 0.5 * (sigma2 / (sigma2 + 0.33));
float B = 0.45 * sigma2 / (sigma2 + 0.09);
return A + B * stinv;
}
float mx_burley_diffuse(vec3 L, vec3 V, vec3 N, float NdotL, float roughness) {
vec3 H = normalize(L + V);
float LdotH = clamp(dot(L, H), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float F90 = 0.5 + (2.0 * roughness * mx_square(LdotH));
float refL = mx_fresnel_schlick(NdotL, 1.0, F90);
float refV = mx_fresnel_schlick(NdotV, 1.0, F90);
return refL * refV;
}
float mx_burley_diffuse_dir_albedo(float NdotV, float roughness) {
float x = NdotV;
float fit0 = 0.97619 - 0.488095 * mx_pow5(1.0 - x);
float fit1 = 1.55754 + (-2.02221 + (2.56283 - 1.06244 * x) * x) * x;
return mix(fit0, fit1, roughness);
}
vec3 mx_burley_diffusion_profile(float dist, vec3 shape) {
vec3 num1 = exp(-shape * dist);
vec3 num2 = exp(-shape * dist / 3.0);
float denom = max(dist, M_FLOAT_EPS);
return (num1 + num2) / denom;
}
vec3 mx_integrate_burley_diffusion(vec3 N, vec3 L, float radius, vec3 mfp) {
float theta = acos(dot(N, L));
vec3 shape = vec3(1.0) / max(mfp, 0.1);
vec3 sumD = vec3(0.0);
vec3 sumR = vec3(0.0);
const int SAMPLE_COUNT = 32;
const float SAMPLE_WIDTH = (2.0 * M_PI) / float(SAMPLE_COUNT);
for (int i = 0; i < SAMPLE_COUNT; i++) {
float x = -M_PI + (float(i) + 0.5) * SAMPLE_WIDTH;
float dist = radius * abs(2.0 * sin(x * 0.5));
vec3 R = mx_burley_diffusion_profile(dist, shape);
sumD += R * max(cos(theta + x), 0.0);
sumR += R;
}
return sumD / sumR;
}
vec3 mx_subsurface_scattering_approx(vec3 N, vec3 L, vec3 P, vec3 albedo, vec3 mfp) {
float curvature = length(fwidth(N)) / length(fwidth(P));
float radius = 1.0 / max(curvature, 0.01);
return albedo * mx_integrate_burley_diffusion(N, L, radius, mfp) / vec3(M_PI);
}
void mx_oren_nayar_diffuse_bsdf_reflection(vec3 L, vec3 V, vec3 P, float occlusion, float weight,
vec3 color, float roughness, vec3 normal,
inout BSDF bsdf) {
bsdf.throughput = vec3(0.0);
if (weight < M_FLOAT_EPS) {
return;
}
normal = mx_forward_facing_normal(normal, V);
float NdotL = clamp(dot(normal, L), M_FLOAT_EPS, 1.0);
bsdf.response = color * occlusion * weight * NdotL * M_PI_INV;
if (roughness > 0.0) {
bsdf.response *= mx_oren_nayar_diffuse(L, V, normal, NdotL, roughness);
}
}
void mx_oren_nayar_diffuse_bsdf_indirect(vec3 V, float weight, vec3 color, float roughness,
vec3 normal, inout BSDF bsdf) {
bsdf.throughput = vec3(0.0);
if (weight < M_FLOAT_EPS) {
return;
}
normal = mx_forward_facing_normal(normal, V);
vec3 Li = mx_environment_irradiance(normal);
bsdf.response = Li * color * weight;
}
void mx_dielectric_bsdf_reflection(vec3 L, vec3 V, vec3 P, float occlusion, float weight, vec3 tint,
float ior, vec2 roughness, vec3 N, vec3 X, int distribution,
int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
N = mx_forward_facing_normal(N, V);
X = normalize(X - dot(X, N) * N);
vec3 Y = cross(N, X);
vec3 H = normalize(L + V);
float NdotL = clamp(dot(N, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float VdotH = clamp(dot(V, H), M_FLOAT_EPS, 1.0);
vec2 safeAlpha = clamp(roughness, M_FLOAT_EPS, 1.0);
float avgAlpha = mx_average_alpha(safeAlpha);
vec3 Ht = vec3(dot(H, X), dot(H, Y), dot(H, N));
FresnelData fd;
vec3 safeTint = max(tint, 0.0);
if (bsdf.thickness > 0.0) {
fd = mx_init_fresnel_dielectric_airy(ior, bsdf.thickness, bsdf.ior);
} else {
fd = mx_init_fresnel_dielectric(ior);
}
vec3 F = mx_compute_fresnel(VdotH, fd);
float D = mx_ggx_NDF(Ht, safeAlpha);
float G = mx_ggx_smith_G2(NdotL, NdotV, avgAlpha);
float F0 = mx_ior_to_f0(ior);
vec3 comp = mx_ggx_energy_compensation(NdotV, avgAlpha, F);
vec3 dirAlbedo = mx_ggx_dir_albedo(NdotV, avgAlpha, F0, 1.0) * comp;
bsdf.throughput = 1.0 - dirAlbedo * weight;
bsdf.response = D * F * G * comp * safeTint * occlusion * weight / (4.0 * NdotV);
}
void mx_dielectric_bsdf_transmission(vec3 V, float weight, vec3 tint, float ior, vec2 roughness,
vec3 N, vec3 X, int distribution, int scatter_mode,
inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
N = mx_forward_facing_normal(N, V);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
FresnelData fd;
vec3 safeTint = max(tint, 0.0);
if (bsdf.thickness > 0.0) {
fd = mx_init_fresnel_dielectric_airy(ior, bsdf.thickness, bsdf.ior);
} else {
fd = mx_init_fresnel_dielectric(ior);
}
vec3 F = mx_compute_fresnel(NdotV, fd);
vec2 safeAlpha = clamp(roughness, M_FLOAT_EPS, 1.0);
float avgAlpha = mx_average_alpha(safeAlpha);
float F0 = mx_ior_to_f0(ior);
vec3 comp = mx_ggx_energy_compensation(NdotV, avgAlpha, F);
vec3 dirAlbedo = mx_ggx_dir_albedo(NdotV, avgAlpha, F0, 1.0) * comp;
bsdf.throughput = 1.0 - dirAlbedo * weight;
if (scatter_mode != 0) {
bsdf.response =
mx_surface_transmission(N, V, X, safeAlpha, distribution, fd, safeTint) * weight;
}
}
void mx_dielectric_bsdf_indirect(vec3 V, float weight, vec3 tint, float ior, vec2 roughness, vec3 N,
vec3 X, int distribution, int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
N = mx_forward_facing_normal(N, V);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
FresnelData fd;
vec3 safeTint = max(tint, 0.0);
if (bsdf.thickness > 0.0) {
fd = mx_init_fresnel_dielectric_airy(ior, bsdf.thickness, bsdf.ior);
} else {
fd = mx_init_fresnel_dielectric(ior);
}
vec3 F = mx_compute_fresnel(NdotV, fd);
vec2 safeAlpha = clamp(roughness, M_FLOAT_EPS, 1.0);
float avgAlpha = mx_average_alpha(safeAlpha);
float F0 = mx_ior_to_f0(ior);
vec3 comp = mx_ggx_energy_compensation(NdotV, avgAlpha, F);
vec3 dirAlbedo = mx_ggx_dir_albedo(NdotV, avgAlpha, F0, 1.0) * comp;
bsdf.throughput = 1.0 - dirAlbedo * weight;
vec3 Li = mx_environment_radiance(N, V, X, safeAlpha, distribution, fd);
bsdf.response = Li * safeTint * comp * weight;
}
void mx_generalized_schlick_bsdf_reflection(vec3 L, vec3 V, vec3 P, float occlusion, float weight,
vec3 color0, vec3 color90, float exponent,
vec2 roughness, vec3 N, vec3 X, int distribution,
int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
N = mx_forward_facing_normal(N, V);
X = normalize(X - dot(X, N) * N);
vec3 Y = cross(N, X);
vec3 H = normalize(L + V);
float NdotL = clamp(dot(N, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float VdotH = clamp(dot(V, H), M_FLOAT_EPS, 1.0);
vec2 safeAlpha = clamp(roughness, M_FLOAT_EPS, 1.0);
float avgAlpha = mx_average_alpha(safeAlpha);
vec3 Ht = vec3(dot(H, X), dot(H, Y), dot(H, N));
FresnelData fd;
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
if (bsdf.thickness > 0.0) {
fd = mx_init_fresnel_schlick_airy(safeColor0, safeColor90, exponent, bsdf.thickness, bsdf.ior);
} else {
fd = mx_init_fresnel_schlick(safeColor0, safeColor90, exponent);
}
vec3 F = mx_compute_fresnel(VdotH, fd);
float D = mx_ggx_NDF(Ht, safeAlpha);
float G = mx_ggx_smith_G2(NdotL, NdotV, avgAlpha);
vec3 comp = mx_ggx_energy_compensation(NdotV, avgAlpha, F);
vec3 dirAlbedo = mx_ggx_dir_albedo(NdotV, avgAlpha, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo * weight);
bsdf.response = D * F * G * comp * occlusion * weight / (4.0 * NdotV);
}
void mx_generalized_schlick_bsdf_transmission(vec3 V, float weight, vec3 color0, vec3 color90,
float exponent, vec2 roughness, vec3 N, vec3 X,
int distribution, int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
N = mx_forward_facing_normal(N, V);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
FresnelData fd;
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
if (bsdf.thickness > 0.0) {
fd = mx_init_fresnel_schlick_airy(safeColor0, safeColor90, exponent, bsdf.thickness, bsdf.ior);
} else {
fd = mx_init_fresnel_schlick(safeColor0, safeColor90, exponent);
}
vec3 F = mx_compute_fresnel(NdotV, fd);
vec2 safeAlpha = clamp(roughness, M_FLOAT_EPS, 1.0);
float avgAlpha = mx_average_alpha(safeAlpha);
vec3 comp = mx_ggx_energy_compensation(NdotV, avgAlpha, F);
vec3 dirAlbedo = mx_ggx_dir_albedo(NdotV, avgAlpha, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo * weight);
if (scatter_mode != 0) {
float avgF0 = dot(safeColor0, vec3(1.0 / 3.0));
fd.ior = vec3(mx_f0_to_ior(avgF0));
bsdf.response =
mx_surface_transmission(N, V, X, safeAlpha, distribution, fd, safeColor0) * weight;
}
}
void mx_generalized_schlick_bsdf_indirect(vec3 V, float weight, vec3 color0, vec3 color90,
float exponent, vec2 roughness, vec3 N, vec3 X,
int distribution, int scatter_mode, inout BSDF bsdf) {
if (weight < M_FLOAT_EPS) {
return;
}
N = mx_forward_facing_normal(N, V);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
FresnelData fd;
vec3 safeColor0 = max(color0, 0.0);
vec3 safeColor90 = max(color90, 0.0);
if (bsdf.thickness > 0.0) {
fd = mx_init_fresnel_schlick_airy(safeColor0, safeColor90, exponent, bsdf.thickness, bsdf.ior);
} else {
fd = mx_init_fresnel_schlick(safeColor0, safeColor90, exponent);
}
vec3 F = mx_compute_fresnel(NdotV, fd);
vec2 safeAlpha = clamp(roughness, M_FLOAT_EPS, 1.0);
float avgAlpha = mx_average_alpha(safeAlpha);
vec3 comp = mx_ggx_energy_compensation(NdotV, avgAlpha, F);
vec3 dirAlbedo = mx_ggx_dir_albedo(NdotV, avgAlpha, safeColor0, safeColor90) * comp;
float avgDirAlbedo = dot(dirAlbedo, vec3(1.0 / 3.0));
bsdf.throughput = vec3(1.0 - avgDirAlbedo * weight);
vec3 Li = mx_environment_radiance(N, V, X, safeAlpha, distribution, fd);
bsdf.response = Li * comp * weight;
}
struct SheenConfig {
vec3 sheenColor;
float sheenRoughness;
};
struct SheenParams {
float sheenRoughnessSq;
float sheenIntensity;
vec3 sheenColorNormalized;
};
SheenConfig defaultSheenConfig() {
return SheenConfig(vec3(0.0), 0.0);
}
SheenParams sheenParams(SheenConfig config) {
SheenParams params;
float r = 0.0, g = 0.0, b = 0.0;
NG_extract_color3(config.sheenColor, 0, r);
NG_extract_color3(config.sheenColor, 1, g);
NG_extract_color3(config.sheenColor, 2, b);
params.sheenRoughnessSq = config.sheenRoughness * config.sheenRoughness;
params.sheenIntensity = max(max(r, g), b);
params.sheenColorNormalized = config.sheenColor / params.sheenIntensity;
return params;
}
float mx_imageworks_sheen_NDF(float NdotH, float roughness) {
float invRoughness = 1.0 / max(roughness, 0.005);
float cos2 = NdotH * NdotH;
float sin2 = 1.0 - cos2;
return (2.0 + invRoughness) * pow(sin2, invRoughness * 0.5) / (2.0 * M_PI);
}
float mx_imageworks_sheen_brdf(float NdotL, float NdotV, float NdotH, float roughness) {
float D = mx_imageworks_sheen_NDF(NdotH, roughness);
float F = 1.0;
float G = 1.0;
return D * F * G / (4.0 * (NdotL + NdotV - NdotL * NdotV));
}
float mx_imageworks_sheen_dir_albedo_analytic(float NdotV, float roughness) {
vec2 r = vec2(13.67300, 1.0) + vec2(-68.78018, 61.57746) * NdotV +
vec2(799.08825, 442.78211) * roughness +
vec2(-905.00061, 2597.49308) * NdotV * roughness +
vec2(60.28956, 121.81241) * mx_square(NdotV) +
vec2(1086.96473, 3045.55075) * mx_square(roughness);
return r.x / r.y;
}
float mx_imageworks_sheen_dir_albedo(float NdotV, float roughness) {
float dirAlbedo = mx_imageworks_sheen_dir_albedo_analytic(NdotV, roughness);
return clamp(dirAlbedo, 0.0, 1.0);
}
BSDF sheenReflectionBsdf(SheenParams params, vec3 L, vec3 V, vec3 P, float occlusion, vec3 N) {
BSDF bsdf = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
float weight = params.sheenIntensity;
vec3 color = params.sheenColorNormalized;
float roughness = params.sheenRoughnessSq;
if (weight < M_FLOAT_EPS)
return bsdf;
N = mx_forward_facing_normal(N, V);
vec3 H = normalize(L + V);
float NdotL = clamp(dot(N, L), M_FLOAT_EPS, 1.0);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float NdotH = clamp(dot(N, H), M_FLOAT_EPS, 1.0);
vec3 fr = color * mx_imageworks_sheen_brdf(NdotL, NdotV, NdotH, roughness);
float dirAlbedo = mx_imageworks_sheen_dir_albedo(NdotV, roughness);
bsdf.throughput = vec3(1.0 - dirAlbedo * weight);
bsdf.response = fr * NdotL * occlusion * weight;
return bsdf;
}
BSDF sheenIndirectBsdf(SheenParams params, vec3 V, vec3 N) {
float weight = params.sheenIntensity;
vec3 color = params.sheenColorNormalized;
float roughness = params.sheenRoughnessSq;
BSDF bsdf = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
if (weight < M_FLOAT_EPS)
return bsdf;
N = mx_forward_facing_normal(N, V);
float NdotV = clamp(dot(N, V), M_FLOAT_EPS, 1.0);
float dirAlbedo = mx_imageworks_sheen_dir_albedo(NdotV, roughness);
bsdf.throughput = vec3(1.0 - dirAlbedo * weight);
vec3 Li = mx_environment_irradiance(N);
bsdf.response = Li * color * dirAlbedo * weight;
return bsdf;
}
struct ClearcoatConfig {
float clearcoat;
float clearcoatRoughness;
};
struct ClearcoatParams {
float clearcoat;
vec2 clearcoatRoughnessUv;
};
ClearcoatConfig defaultClearcoatConfig() {
return ClearcoatConfig(0.0, 0.0);
}
ClearcoatParams clearcoatParams(ClearcoatConfig config) {
ClearcoatParams result = ClearcoatParams(config.clearcoat, vec2(0.0));
mx_roughness_anisotropy(config.clearcoatRoughness, 0.000000, result.clearcoatRoughnessUv);
return result;
}
BSDF clearcoatReflectionBsdf(ClearcoatParams params, vec3 L, vec3 V, vec3 P, float occlusion,
vec3 normal, vec3 tangent) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_dielectric_bsdf_reflection(L, V, P, occlusion, params.clearcoat,
vec3(1.000000, 1.000000, 1.000000), 1.500000,
params.clearcoatRoughnessUv, normal, tangent, 0, 0, result);
return result;
}
BSDF clearcoatIndirectBsdf(ClearcoatParams params, vec3 V, vec3 normal, vec3 tangent) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_dielectric_bsdf_indirect(V, params.clearcoat, vec3(1.000000, 1.000000, 1.000000), 1.500000,
params.clearcoatRoughnessUv, normal, tangent, 0, 0, result);
return result;
}
BSDF clearcoatTransmissionBsdf(ClearcoatParams params, vec3 V, vec3 normal, vec3 tangent) {
BSDF result = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_dielectric_bsdf_transmission(V, params.clearcoat, vec3(1.000000, 1.000000, 1.000000), 1.500000,
params.clearcoatRoughnessUv, normal, tangent, 0, 0, result);
return result;
}
struct SpecularConfig {
float specular;
vec3 specularColor;
};
SpecularConfig defaultSpecularConfig() {
return SpecularConfig(1.0, vec3(1.0));
}
struct PbrConfig {
vec3 baseColor;
float metallic;
float roughness;
float occlusion;
float transmission;
float ior;
vec3 emissionColor;
float emissionStrength;
ClearcoatConfig clearcoat;
SheenConfig sheen;
SpecularConfig specular;
};
struct PbrParams {
vec3 dielectricF90;
vec3 dielectricF0;
vec2 roughnessUv;
};
PbrConfig defaultPbrConfig(vec3 baseColor, float metallic, float roughness) {
PbrConfig params;
params.baseColor = baseColor;
params.metallic = metallic;
params.roughness = roughness;
params.occlusion = 0.0;
params.transmission = 0.0;
params.ior = 1.5;
params.emissionColor = baseColor;
params.emissionStrength = 0.0;
params.clearcoat = defaultClearcoatConfig();
params.sheen = defaultSheenConfig();
params.specular = defaultSpecularConfig();
return params;
}
PbrParams pbrParams(SpecularConfig specular, float roughness, float ior) {
PbrParams params;
const float one_minus_ior_in1_tmp = 1.000000;
float one_minus_ior = one_minus_ior_in1_tmp - ior;
const float one_plus_ior_in1_tmp = 1.000000;
float one_plus_ior = one_plus_ior_in1_tmp + ior;
const vec3 dielectric_f90_in1_tmp = vec3(1.000000, 1.000000, 1.000000);
params.dielectricF90 = dielectric_f90_in1_tmp * specular.specular;
params.roughnessUv = vec2(0.0);
mx_roughness_anisotropy(roughness, 0.000000, params.roughnessUv);
float ior_div = one_minus_ior / one_plus_ior;
float dielectric_f0_from_ior = ior_div * ior_div;
vec3 dielectric_f0_from_ior_specular_color = specular.specularColor * dielectric_f0_from_ior;
const float clamped_dielectric_f0_from_ior_specular_color_in2_tmp = 1.000000;
vec3 clamped_dielectric_f0_from_ior_specular_color = min(
dielectric_f0_from_ior_specular_color, clamped_dielectric_f0_from_ior_specular_color_in2_tmp);
params.dielectricF0 = clamped_dielectric_f0_from_ior_specular_color * specular.specular;
return params;
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float emissionStrength;
#ifdef USE_EXPOSURE_AND_GAMMA
uniform vec4 camera_exposure_gamma;
#else
const vec4 camera_exposure_gamma = vec4(1.0, 1.0, 0.0, 0.0);
#endif
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
SurfaceShader gltfPbrSurfaceShader(PbrConfig config, vec3 lightIntensity, vec3 normal,
vec3 tangent) {
ClearcoatParams clearcoat = clearcoatParams(config.clearcoat);
SheenParams sheen = sheenParams(config.sheen);
PbrParams pbr = pbrParams(config.specular, config.roughness, config.ior);
SurfaceShader shader_constructor_out = SurfaceShader(vec3(0.0), vec3(0.0));
{
vec3 N = normalize(vNormalW);
vec3 V = normalize(cameraPosition - vPositionW);
vec3 P = vPositionW;
float occlusion = 1.0;
const float lightmapMultiplier = 3.0;
if (true) {
LightShader lightShader = LightShader(lightIntensity, vNormalW);
vec3 L = lightShader.direction;
BSDF metal_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_generalized_schlick_bsdf_reflection(
L, V, P, occlusion, 1.000000, config.baseColor, vec3(1.000000, 1.000000, 1.000000),
5.000000, pbr.roughnessUv, normal, tangent, 0, 0, metal_bsdf_out);
BSDF diffuse_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_oren_nayar_diffuse_bsdf_reflection(L, V, P, occlusion, 1.000000, config.baseColor,
0.000000, normal, diffuse_bsdf_out);
BSDF reflection_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_generalized_schlick_bsdf_reflection(L, V, P, occlusion, 1.000000, pbr.dielectricF0,
pbr.dielectricF90, 5.000000, pbr.roughnessUv, normal,
tangent, 0, 0, reflection_bsdf_out);
BSDF transmission_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
BSDF transmission_mix_out =
mixBsdf(diffuse_bsdf_out, transmission_bsdf_out, config.transmission);
BSDF dielectric_bsdf_out = combineBsdf(reflection_bsdf_out, transmission_mix_out);
BSDF base_mix_out = mixBsdf(dielectric_bsdf_out, metal_bsdf_out, config.metallic);
BSDF sheen_bsdf_out = sheenReflectionBsdf(sheen, L, V, P, occlusion, normal);
BSDF sheen_layer_out = combineBsdf(sheen_bsdf_out, base_mix_out);
BSDF clearcoat_bsdf_out =
clearcoatReflectionBsdf(clearcoat, L, V, P, occlusion, normal, tangent);
BSDF clearcoat_layer_out = combineBsdf(clearcoat_bsdf_out, sheen_layer_out);
shader_constructor_out.color +=
lightShader.intensity * clearcoat_layer_out.response * lightmapMultiplier;
}
{
float luminance = getLuminance(lightIntensity) * 0.75;
float shadowingFactor =
mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, config.metallic);
occlusion = shadowingFactor;
}
#ifdef USE_ENVMAP
if (true) {
BSDF metal_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_generalized_schlick_bsdf_indirect(V, 1.000000, config.baseColor,
vec3(1.000000, 1.000000, 1.000000), 5.000000,
pbr.roughnessUv, normal, tangent, 0, 0, metal_bsdf_out);
BSDF diffuse_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_oren_nayar_diffuse_bsdf_indirect(V, 1.000000, config.baseColor, 0.000000, normal,
diffuse_bsdf_out);
BSDF reflection_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_generalized_schlick_bsdf_indirect(V, 1.000000, pbr.dielectricF0, pbr.dielectricF90,
5.000000, pbr.roughnessUv, normal, tangent, 0, 0,
reflection_bsdf_out);
BSDF transmission_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
BSDF transmission_mix_out =
mixBsdf(diffuse_bsdf_out, transmission_bsdf_out, config.transmission);
BSDF dielectric_bsdf_out = combineBsdf(reflection_bsdf_out, transmission_mix_out);
BSDF base_mix_out = mixBsdf(dielectric_bsdf_out, metal_bsdf_out, config.metallic);
BSDF sheen_bsdf_out = sheenIndirectBsdf(sheen, V, normal);
BSDF sheen_layer_out = combineBsdf(sheen_bsdf_out, base_mix_out);
BSDF clearcoat_bsdf_out = clearcoatIndirectBsdf(clearcoat, V, normal, tangent);
BSDF clearcoat_layer_out = combineBsdf(clearcoat_bsdf_out, sheen_layer_out);
shader_constructor_out.color += occlusion * clearcoat_layer_out.response;
}
#endif
if (true) {
vec3 emission_out = vec3(0.0);
mx_uniform_edf(N, V, config.emissionColor * config.emissionStrength, emission_out);
shader_constructor_out.color += emission_out;
}
if (true) {
BSDF metal_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_generalized_schlick_bsdf_transmission(
V, 1.000000, config.baseColor, vec3(1.000000, 1.000000, 1.000000), 5.000000,
pbr.roughnessUv, normal, tangent, 0, 0, metal_bsdf_out);
BSDF diffuse_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
BSDF reflection_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_generalized_schlick_bsdf_transmission(V, 1.000000, pbr.dielectricF0, pbr.dielectricF90,
5.000000, pbr.roughnessUv, normal, tangent, 0, 0,
reflection_bsdf_out);
BSDF transmission_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
mx_dielectric_bsdf_transmission(V, 1.000000, config.baseColor, config.ior, pbr.roughnessUv,
normal, tangent, 0, 1, transmission_bsdf_out);
BSDF transmission_mix_out =
mixBsdf(diffuse_bsdf_out, transmission_bsdf_out, config.transmission);
BSDF dielectric_bsdf_out = combineBsdf(reflection_bsdf_out, transmission_mix_out);
BSDF base_mix_out = mixBsdf(dielectric_bsdf_out, metal_bsdf_out, config.metallic);
BSDF sheen_bsdf_out = BSDF(vec3(0.0), vec3(1.0), 0.0, 0.0);
BSDF sheen_layer_out = combineBsdf(sheen_bsdf_out, base_mix_out);
BSDF clearcoat_bsdf_out = clearcoatTransmissionBsdf(clearcoat, V, normal, tangent);
BSDF clearcoat_layer_out = combineBsdf(clearcoat_bsdf_out, sheen_layer_out);
shader_constructor_out.color += clearcoat_layer_out.response;
}
}
return shader_constructor_out;
}
float lengthSq(vec2 v) {
return dot(v, v);
}
vec3 computeTangent(vec3 normalW) {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE)
vec2 texCoord = vUv0;
#else
vec2 texCoord = vUv1;
#endif
vec2 uvDiff1 = vec2(dFdx(texCoord.x), dFdy(texCoord.x));
vec2 uvDiff2 = vec2(dFdx(texCoord.y), dFdy(texCoord.y));
vec3 denormTangent;
vec3 tangent;
if (lengthSq(uvDiff1) > lengthSq(uvDiff2)) {
denormTangent = uvDiff1.x * dFdy(vPositionW) - dFdx(vPositionW) * uvDiff1.y;
tangent = normalize(denormTangent - normalW * dot(normalW, denormTangent));
tangent = cross(normalW, tangent);
} else {
denormTangent = uvDiff2.x * dFdy(vPositionW) - dFdx(vPositionW) * uvDiff2.y;
tangent = normalize(denormTangent - normalW * dot(normalW, denormTangent));
}
return tangent;
}
void main() {
float alpha;
vec3 baseColor = getBaseColorHook(alpha);
#ifdef USE_CHROMA_KEY
float dist = chromaKeyShapeFn(chromaKeyDeltaCoeff, rgb2hci(baseColor), rgb2hci(chromaKeyColor));
alpha *= chromaKeyEdgeFn(dist);
#endif
#if defined(USE_BASE_COLOR_TEXTURE)
if (alpha < alphaDiscardThreshold) {
discard;
}
#endif
vec3 lightIntensity = getLightIntensity();
#ifdef USE_ENVMAP
float roughness = getRoughness();
float metallic = getMetallic();
#else
float roughness = 1.0;
float metallic = 0.0;
#endif
#ifdef USE_HIGHLIGHT
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
baseColor = mix(baseColor, highlight, highlightMix);
alpha = mix(alpha, 1.0, highlightMix);
#endif
#endif
PbrConfig pbr = defaultPbrConfig(baseColor, metallic, roughness);
pbr.emissionStrength = emissionStrength;
vec3 normalW = normalize((gl_FrontFacing ? 1.0 : -1.0) * vNormalW);
vec3 tangentW = computeTangent(normalW);
SurfaceShader resultFull = gltfPbrSurfaceShader(pbr, lightIntensity, normalW, tangentW);
{
vec3 viewW = normalize(cameraPosition - vPositionW);
float clampCosnv = saturate(dot(normalW, viewW));
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
fresnelSchlickEnv(pbr.specular.specularColor, envMapFresnel, clampCosnv, alpha);
}
vec3 result = resultFull.color + resultFull.transparency;
if (!(result.x > -1.0 || result.x < 1.0))
result = vec3(1.0, 0.0, 1.0);
#ifdef USE_FOG
float distance = length(vPositionV);
result = addFog(result, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
if (alpha < 0.5) {
discard;
}
fragColor = hdrEncode(result);
#else  // no HDR_OUTPUT
vec3 exposedColor = pow(camera_exposure_gamma.x * result.xyz, vec3(camera_exposure_gamma.y));
vec3 gammaColor = linearToGammaToneMapped(exposedColor);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, min(gammaColor, 1.0), colorMapIntensity), alpha);
#else
fragColor = vec4(gammaColor, alpha);
#endif
#endif  // no HDR_OUTPUT
}
`,"pbr_material_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE)
varOut vec2 vUv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 uvMod0;
#endif
#endif
#ifdef USE_LIGHTMAP
webgl2centroid varOut vec2 vUv1;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
varOut vec3 vPositionV;
#endif
#ifdef USE_BUMP_TEXTURE
varOut vec3 vNormalV;
#endif
varOut vec3 vPositionW;
varOut vec3 vNormalW;
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal);
void main() {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE)
vUv0 = uv0 * uvMod0.zw + uvMod0.xy;
#endif
vec4 transformedPosition = transformPosition();
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vec4 mvPosition = modelViewMatrix * transformedPosition;
#ifdef USE_LIGHTMAP
float zeroOrOne = min(uv1.x + uv1.y, 1.0);
vUv1 = uv1 * uv1Mod.zw + uv1Mod.xy * zeroOrOne;
#endif
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(t0.x * n.x + t0.y * n.y + t0.z * n.z, t1.x * n.x + t1.y * n.y + t1.z * n.z,
t2.x * n.x + t2.y * n.y + t2.z * n.z);
modifyMvPositionHook(mvPosition, normal);
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_BUMP_TEXTURE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#endif
vPositionW = (modelMatrix * transformedPosition).xyz;
vNormalW = mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz) * normal;
vNormalW = normalize(vNormalW);
gl_Position = projectionMatrix * mvPosition;
}
`,"per_object_data_helpers.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
`,"postprocess_vertex.glsl":`varOut vec2 vUv0;
void main() {
gl_Position = vec4(position, 1.0);
vUv0 = uv0;
}
`,"procedural_sky_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 fogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, fogColor.xyz, fogAmount);
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 topColor;
uniform vec3 bottomColor;
uniform float sinBottomAngle;
uniform float exponent;
uniform vec4 camera_exposure_gamma;
#endif
varIn vec3 vWorldDirection;
#ifdef USE_FOG
varIn vec3 vPositionW;
varIn vec3 vPositionV;
#endif
#ifdef HDR_OUTPUT
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture2D(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture2D(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
void main() {
float sinDirection = normalize(vWorldDirection).z;
float w = max(0.0, (sinDirection - sinBottomAngle) / (1.0 - sinBottomAngle));
vec3 colorGamma = mix(bottomColor, topColor, pow(w, exponent));
vec3 colorLinear = gammaToLinear(colorGamma);
#ifdef USE_FOG
float distance = length(vPositionV);
colorLinear = addFog(colorLinear, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
fragColor = hdrEncode(10.0 * colorLinear);
#else
#ifdef USE_FOG
vec3 colorExposed = pow(camera_exposure_gamma.x * colorLinear, vec3(camera_exposure_gamma.y));
colorGamma = linearToGammaToneMapped(colorExposed);
#endif
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, colorGamma, colorMapIntensity), 1.0);
#else
fragColor = vec4(colorGamma, 1.0);
#endif
#endif
}
`,"procedural_sky_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
#ifdef USE_FOG
varOut vec3 vPositionW;
varOut vec3 vPositionV;
#endif
varOut vec3 vWorldDirection;
void main() {
vec3 positionW = (modelMatrix * vec4(position, 1.0)).xyz;
vWorldDirection = positionW - cameraPosition;
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vPositionW = positionW;
vPositionV = -(modelViewMatrix * vec4(position, 1.0)).xyz;
setClipPositionFromViewPos(-vPositionV);
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
#else
gl_Position = viewProjMatrix * vec4(positionW, 1.0);
#endif
#endif
}
`,"rotate_gizmo_material_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 color;
uniform float opacity;
uniform vec3 gizmoPosition;
uniform float sphereRadius;
#endif
varIn vec4 mPosition;
void discardIfRayIntersectsSphere(vec3 r0, vec3 rd, vec3 s0, float sr) {
float a = dot(rd, rd);
vec3 s0_r0 = r0 - s0;
float b = 2.0 * dot(rd, s0_r0);
float c = dot(s0_r0, s0_r0) - (sr * sr);
float delta = b * b - 4.0 * a * c;
if (delta >= 0.0 && -b - sqrt(delta) > 0.0) {
discard;
}
}
void main() {
vec4 outColor;
outColor.rgb = color;
outColor.a = opacity;
vec3 toCamera = normalize(cameraPosition - gizmoPosition);
discardIfRayIntersectsSphere(mPosition.xyz, toCamera, gizmoPosition, sphereRadius);
fragColor = outColor;
}
`,"rotate_gizmo_material_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
varOut vec4 mPosition;
void main() {
vec4 p = vec4(position, 1.0);
mPosition = modelMatrix * p;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec4 mvPosition = modelViewMatrix * p;
gl_Position = projectionMatrix * mvPosition;
#else
gl_Position = viewProjMatrix * mPosition;
#endif
}
`,"sprite_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 offset;
#endif
#ifdef USE_FOG
varOut vec3 vPositionW;
varOut vec3 vPositionV;
#endif
varOut vec2 vUv0;
void main() {
vUv0 = uv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vec4 mvPosition = modelViewMatrix * vec4(offset, 1.0);
vec2 scale;
#ifdef USE_FOG
vPositionW = (modelMatrix * vec4(offset, 1.0)).xyz;
vPositionV = -mvPosition.xyz;
#endif
scale.x = length(modelMatrix[0].xyz);
scale.y = length(modelMatrix[1].xyz);
vec2 alignedPosition = position.xy * scale;
mvPosition.xy += alignedPosition;
gl_Position = projectionMatrix * mvPosition;
}
`,"standard_material_fragment.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
float _g2l(in float x) {
return (x <= 0.04045) ? x / 12.92 : pow((x + 0.055) / 1.055, 2.4);
}
vec3 gammaToLinear(in vec3 rgb) {
return vec3(_g2l(rgb.r), _g2l(rgb.g), _g2l(rgb.b));
}
float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
vec4 cubic(in float v) {
vec4 n = vec4(1.0, 2.0, 3.0, 4.0) - v;
vec4 s = n * n * n;
float x = s.x;
float y = s.y - 4.0 * s.x;
float z = s.z - 4.0 * s.y + 6.0 * s.x;
float w = 6.0 - x - y - z;
return vec4(x, y, z, w) * (1.0 / 6.0);
}
vec3 hdrDecodeRgbm(in vec4 rgbm) {
const float rgbmScale = 2.82842712;  // sqrt(8)
float m = 1.0 - rgbm.a;
vec3 r = rgbm.rgb * (rgbmScale * m);
return r * r;
}
vec3 hdrDecodeYcocgm(in vec4 ycocgm, in vec2 threshold) {
const float ycocgmLumaRange = 16.0;
float m = ycocgm.w * (16.0 * 255.0 / 256.0) - 1.0;
float chroma_scale_factor = fract(m);
float y_factor = m - chroma_scale_factor;
chroma_scale_factor = 1.0 - chroma_scale_factor;
float factor = y_factor == ycocgmLumaRange - 2.0 ? 0.0 : 1.0;
float y = mix(ycocgm.x * threshold.x, (y_factor + ycocgm.x) * threshold.y + threshold.x, factor);
float co = (ycocgm.y - 0.5) * chroma_scale_factor;
float cg = (ycocgm.z - 0.5) * chroma_scale_factor;
return vec3(y, co, cg);
}
vec3 ycocgToRgb(in vec3 ycocg) {
float y = ycocg.x, co = ycocg.y, cg = ycocg.z;
y = y * y;
float r = saturate(y + co - cg);
float g = saturate(y + cg);
float b = saturate(y - co - cg);
return vec3(r, g, b) * 8.0;
}
/*vec3 hdrDecodeYcocgmBicubic(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeYcocgmBilinear(in sampler2D ycocgmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 threshold, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xz), threshold);
vec3 sample1 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yz), threshold);
vec3 sample2 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.xw), threshold);
vec3 sample3 = hdrDecodeYcocgm(texture2D(ycocgmSampler, offset.yw), threshold);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
/*vec3 hdrDecodeRgbmBicubic(in sampler2D rgbmSampler, in vec2 texSize,
in vec2 invTexSize, in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 xcubic = cubic(fxy.x), ycubic = cubic(fxy.y);
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +1.5).xyxy;
vec4 s = vec4(xcubic.xz + xcubic.yw, ycubic.xz + ycubic.yw);
vec4 offset = (c + vec4 (xcubic.yw, ycubic.yw) / s) * invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
float sx = s.x / (s.x + s.y), sy = s.z / (s.z + s.w);
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}*/
vec3 hdrDecodeRgbmBilinear(in sampler2D rgbmSampler, in vec2 texSize, in vec2 invTexSize,
in vec2 texCoords) {
vec2 texCoordsScaled = texCoords * texSize - 0.5;
vec2 fxy = fract(texCoordsScaled);
texCoordsScaled -= fxy;
vec4 c = texCoordsScaled.xxyy + vec2(-0.5, +0.5).xyxy;
vec4 offset = c + vec4(1.0);
float sx = 1.0 - fxy.x;
float sy = 1.0 - fxy.y;
offset *= invTexSize.xxyy;
vec3 sample0 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xz));
vec3 sample1 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yz));
vec3 sample2 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.xw));
vec3 sample3 = hdrDecodeRgbm(texture2D(rgbmSampler, offset.yw));
return mix(mix(sample3, sample2, sx), mix(sample1, sample0, sx), sy);
}
struct ReflectionProbe {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
vec3 boxMin;
vec3 boxMax;
vec3 posW;
#else
vec4 boxMin;
vec4 boxMax;
vec4 posW;
#endif
};
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform LightBuffer {
vec4 lightmapSize;
vec4 lightmapThreshold;
ReflectionProbe reflectionProbes[3];
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef USE_FOG
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
uniform vec3 fogColor;
#endif
const float LOG2 = 1.442695;
vec3 addFog(in vec3 colorIn, in float distance, in vec3 positionW) {
float distanceValue = max(0.0, distance - fogDistStart_DistDensity_HeightStart_HeightDensity.x);
float distanceDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.y;
float distanceFogExp =
1.0 - exp2(-distanceDensity * distanceDensity * distanceValue * distanceValue * LOG2);
float heightValue = max(0.0, -positionW.z + fogDistStart_DistDensity_HeightStart_HeightDensity.z);
float heightDensity = fogDistStart_DistDensity_HeightStart_HeightDensity.w;
float heightFogExp =
1.0 - exp2(-heightDensity * heightDensity * heightValue * heightValue * LOG2);
float fogAmount = min(1.0, distanceFogExp + heightFogExp);
return mix(colorIn, fogColor.xyz, fogAmount);
}
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
varIn vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
varIn vec3 vNormalW;
#endif
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE)
varIn vec2 vUv0;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
varIn vec3 vPositionV;
#endif
vec3 rgbToHsl(vec3 rgb) {
vec3 hsl = vec3(0.0);
float fMin = min(min(rgb.r, rgb.g), rgb.b);
float fMax = max(max(rgb.r, rgb.g), rgb.b);
float delta = fMax - fMin;
hsl.z = (fMax + fMin) / 2.0;  // Luminance
if (delta == 0.0) {
return hsl;
}
hsl.y = delta / ((hsl.z <= 0.5) ? (fMax + fMin) : (2.0 - fMax - fMin));
float denom = 6.0 * delta;
if (rgb.r == fMax) {
hsl.x = (rgb.g - rgb.b) / denom;
} else if (rgb.g == fMax) {
hsl.x = (rgb.b - rgb.r) / denom + (1.0 / 3.0);
} else if (rgb.b == fMax) {
hsl.x = (rgb.r - rgb.g) / denom + (2.0 / 3.0);
}
if (hsl.x < 0.0) {
hsl.x += 1.0;
}
if (hsl.x > 1.0) {
hsl.x -= 1.0;
}
return hsl;
}
float hueToRgb(float p, float q, float hue) {
if (hue < 0.0) {
hue += 1.0;
}
if (hue > 1.0) {
hue -= 1.0;
}
float res;
if (6.0 * hue < 1.0) {
res = p + (q - p) * 6.0 * hue;
} else if (2.0 * hue < 1.0) {
res = q;
} else if (3.0 * hue < 2.0) {
res = p + (q - p) * ((2.0 / 3.0) - hue) * 6.0;
} else {
res = p;
}
return res;
}
vec3 hslToRgb(vec3 hsl) {
vec3 rgb;
if (hsl.y == 0.0) {
return vec3(hsl.z);
}
float q = hsl.z < 0.5 ? hsl.z * (1.0 + hsl.y) : (hsl.z + hsl.y) - (hsl.y * hsl.z);
float p = 2.0 * hsl.z - q;
rgb.r = hueToRgb(p, q, hsl.x + (1.0 / 3.0));
rgb.g = hueToRgb(p, q, hsl.x);
rgb.b = hueToRgb(p, q, hsl.x - (1.0 / 3.0));
return rgb;
}
vec3 adjustContrast(vec3 col, float contrast) {
float factor = (1.0 + contrast);
return clamp(vec3(factor * (col.r - 0.5) + 0.5, factor * (col.g - 0.5) + 0.5,
factor * (col.b - 0.5) + 0.5),
vec3(0.0), vec3(1.0));
}
float modOne(float x) {
if (x < 0.0) {
return 1.0 - (float(int(x)) - x);
}
return x - float(int(x));
}
float adjustComponent(float component, float adjustment) {
return clamp(component * (1.0 + adjustment), 0.0, 1.0);
}
float adjustContrastInComponent(float component, float contrast) {
return clamp((1.0 + contrast) * (component - 0.5) + 0.5, 0.0, 1.0);
}
vec3 applyBaseColorCorrection(vec3 color, vec4 colorCorrection) {
if (colorCorrection.x != 0.0 || colorCorrection.y != 0.0 || colorCorrection.z != 0.0) {
vec3 colorInHSL = rgbToHsl(color);
colorInHSL = vec3(modOne(colorInHSL.x + colorCorrection.x),
adjustComponent(colorInHSL.y, colorCorrection.y),
adjustComponent(colorInHSL.z, colorCorrection.z));
color = hslToRgb(colorInHSL);
}
if (colorCorrection.a == 0.0)
return color;
return adjustContrast(color, colorCorrection.a);
}
float desaturate(vec4 color) {
float minComp = min(min(color.r, color.g), color.b);
float maxComp = max(max(color.r, color.g), color.b);
return minComp * 0.5 + maxComp * 0.5;
}
float applyMapCorrection(vec4 color, vec4 correction) {
float value = desaturate(color);
float inversion = correction.r;
float scale = correction.g;
float contrast = correction.b;
value = clamp(scale * value + inversion, 0.0, 1.0);
if (contrast == 0.0)
return value;
value = adjustContrastInComponent(value, contrast);
return value;
}
#if defined(USE_BUMP_TEXTURE)
varIn vec3 vNormalV;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float bumpScale;
#endif
uniform sampler2D bumpTexture;
uniform vec4 bumpCorrection;
float bumpTextureCorrected(vec2 coord) {
return applyMapCorrection(texture2D(bumpTexture, coord), bumpCorrection);
}
vec2 dBumpdxy() {
vec2 texdx = dFdx(vUv0);
vec2 texdy = dFdy(vUv0);
float Hll = bumpScale * bumpTextureCorrected(vUv0);
float dBx = bumpScale * bumpTextureCorrected(vUv0 + texdx) - Hll;
float dBy = bumpScale * bumpTextureCorrected(vUv0 + texdy) - Hll;
return vec2(dBx, dBy);
}
vec3 perturbNormal(in vec3 surfPos, in vec3 surfNorm) {
vec2 dBdxy = dBumpdxy();
vec3 vSigmaX = dFdx(surfPos);
vec3 vSigmaY = dFdy(surfPos);
vec3 R1 = cross(vSigmaY, surfNorm);
vec3 R2 = cross(surfNorm, vSigmaX);
float fDet = dot(vSigmaX, R1);
vec3 vGrad = sign(fDet) * (dBdxy.x * R1 + dBdxy.y * R2);
return normalize(abs(fDet) * surfNorm - vGrad);
}
#endif
#ifdef USE_BASE_COLOR_TEXTURE
uniform sampler2D baseColorTexture;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 baseColorAtlasUvMod;
uniform float alphaDiscardThreshold;
#endif
#ifdef USE_PARALLAX_CORRECTION
#endif
#else
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 baseColor;
#endif
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef ANTI_TILING_REGULAR
uniform float antiTilingRegularStepX;
uniform float antiTilingRegularStepY;
uniform float antiTilingRegularMaxOffsetX;
uniform float antiTilingRegularMaxOffsetY;
#endif
uniform float opacity;
#ifdef USE_CUTOUT_MASK
uniform float cutoutMaskThreshold;
#endif
uniform vec4 baseColorCorrection;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 getBaseColorHook(out float alpha);
float hash(vec2 p) {
vec3 p3 = fract(vec3(p.xyx) * 0.13);
p3 += dot(p3, p3.yzx + 3.333);
return fract((p3.x + p3.y) * p3.z);
}
float noise2d(vec2 x) {
vec2 i = floor(x);
vec2 f = fract(x);
float a = hash(i);
float b = hash(i + vec2(1.0, 0.0));
float c = hash(i + vec2(0.0, 1.0));
float d = hash(i + vec2(1.0, 1.0));
vec2 u = f * f * (3.0 - 2.0 * f);
return mix(a, b, u.x) + (c - a) * u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
}
float sum(vec3 v) {
return v.x + v.y + v.z;
}
vec4 textureNoTileOrganic(sampler2D sampler, in vec2 x) {
float k = noise2d(x);
vec2 duvdx = dFdx(x);
vec2 duvdy = dFdy(x);
float l = k * 8.0;
float f = fract(l);
float ia = floor(l + 0.5);
float ib = floor(l);
f = min(f, 1.0 - f) * 2.0;
vec2 offa = sin(vec2(3.0, 7.0) * ia);
vec2 offb = sin(vec2(3.0, 7.0) * ib);
vec3 cola = textureGrad(sampler, x + offa, duvdx, duvdy).xyz;
vec3 colb = textureGrad(sampler, x + offb, duvdx, duvdy).xyz;
vec3 res = mix(cola, colb, smoothstep(0.1, 0.9, f - 0.1 * sum(cola - colb)));
return vec4(res.x, res.y, res.z, texture2D(sampler, x).a);
}
float toStepX(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepX;
return floor(x * antiTilingRegularMaxOffsetX / stepVal) * stepVal;
#else
return floor(x);
#endif
}
float toStepY(float x) {
#ifdef ANTI_TILING_REGULAR
float stepVal = antiTilingRegularStepY;
return floor(x * antiTilingRegularMaxOffsetY / stepVal) * stepVal;
#else
return floor(x);
#endif
}
vec4 hash4(vec2 p) {
return fract(tan(vec4(1.0 + dot(p, vec2(37.0, 17.0)), 2.0 + dot(p, vec2(11.0, 47.0)),
3.0 + dot(p, vec2(41.0, 29.0)), 4.0 + dot(p, vec2(23.0, 31.0)))) *
103.0);
}
vec4 textureNoTilerRegular(sampler2D samp, in vec2 uv) {
vec2 iuv = floor(uv);
vec2 fuv = fract(uv);
vec4 ofa = hash4(iuv + vec2(0.0, 0.0));
vec4 ofb = hash4(iuv + vec2(1.0, 0.0));
vec4 ofc = hash4(iuv + vec2(0.0, 1.0));
vec4 ofd = hash4(iuv + vec2(1.0, 1.0));
vec2 ddx = dFdx(uv);
vec2 ddy = dFdy(uv);
#ifdef ANTI_TILING_REGULAR_MIRROR_X
ofa.z = sign(ofa.z - 0.5);
ofb.z = sign(ofb.z - 0.5);
ofc.z = sign(ofc.z - 0.5);
ofd.z = sign(ofd.z - 0.5);
#else
ofa.z = 1.0;
ofb.z = 1.0;
ofc.z = 1.0;
ofd.z = 1.0;
#endif
#ifdef ANTI_TILING_REGULAR_MIRROR_Y
ofa.w = sign(ofa.w - 0.5);
ofb.w = sign(ofb.w - 0.5);
ofc.w = sign(ofc.w - 0.5);
ofd.w = sign(ofd.w - 0.5);
#else
ofa.w = 1.0;
ofb.w = 1.0;
ofc.w = 1.0;
ofd.w = 1.0;
#endif
vec2 uva = uv * ofa.zw + vec2(toStepX(ofa.x), toStepY(ofa.y));
vec2 ddxa = ddx * ofa.zw;
vec2 ddya = ddy * ofa.zw;
vec2 uvb = uv * ofb.zw + vec2(toStepX(ofb.x), toStepY(ofb.y));
vec2 ddxb = ddx * ofb.zw;
vec2 ddyb = ddy * ofb.zw;
vec2 uvc = uv * ofc.zw + vec2(toStepX(ofc.x), toStepY(ofc.y));
vec2 ddxc = ddx * ofc.zw;
vec2 ddyc = ddy * ofc.zw;
vec2 uvd = uv * ofd.zw + vec2(toStepX(ofd.x), toStepY(ofd.y));
vec2 ddxd = ddx * ofd.zw;
vec2 ddyd = ddy * ofd.zw;
vec2 b = smoothstep(0.45, 0.55, fuv);
return mix(mix(textureGrad(samp, uva, ddxa, ddya), textureGrad(samp, uvb, ddxb, ddyb), b.x),
mix(textureGrad(samp, uvc, ddxc, ddyc), textureGrad(samp, uvd, ddxd, ddyd), b.x), b.y);
}
vec4 texture2DWithOptionalAntiTiling(sampler2D text, in vec2 uv) {
#ifdef ANTI_TILING_ORGANIC
return textureNoTileOrganic(text, uv);
#else
#ifdef ANTI_TILING_REGULAR
return textureNoTilerRegular(text, uv);
#else
return texture2D(text, uv);
#endif
#endif
}
vec3 getBaseColor(out float alpha) {
#ifdef USE_BASE_COLOR_TEXTURE
#ifdef USE_PARALLAX_CORRECTION
#else
vec2 uv = vUv0;
#endif
#ifdef USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT
vec2 uvScaled = uv * baseColorAtlasUvMod.zw;
vec2 dfdx = dFdx(uvScaled);
vec2 dfdy = dFdy(uvScaled);
uv = fract(uv) * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
vec4 baseColorGamma = texture2DGradEXT(baseColorTexture, uv, dfdx, dfdy);
float textureAlpha = baseColorGamma.a;
#else
uv = uv * baseColorAtlasUvMod.zw + baseColorAtlasUvMod.xy;
#ifdef USE_ALPHA_IN_LOWER_HALF
vec4 baseColorGamma =
texture2DWithOptionalAntiTiling(baseColorTexture, vec2(uv.x, .5 + .5 * uv.y));
float textureAlpha = texture2D(baseColorTexture, vec2(uv.x, .5 * uv.y)).r;
#else
vec4 baseColorGamma = texture2DWithOptionalAntiTiling(baseColorTexture, uv);
float textureAlpha = baseColorGamma.a;
#endif
#endif
vec3 baseColor = gammaToLinear(baseColorGamma.rgb);
#ifdef USE_CUTOUT_MASK
alpha = step(cutoutMaskThreshold, textureAlpha);
if (alpha == 0.0)
discard;
#else
alpha = opacity * textureAlpha;
#endif
#else  // NOT USE_BASE_COLOR_TEXTURE
alpha = opacity;
#endif
return applyBaseColorCorrection(baseColor, baseColorCorrection);
}
#ifdef LIVE_LIGHTMAP
uniform sampler2D liveLightmap;
uniform float lightmapMode;
uniform vec4 screenResolution;
#endif
#ifdef USE_LIGHTMAP
webgl2centroid varIn vec2 vUv1;
uniform sampler2D lightmap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 lightmapSize;
uniform vec2 lightmapThreshold;
#endif
#endif  // NOT USE_LIGHTMAP
vec3 getLightIntensity() {
#ifdef LIVE_LIGHTMAP
if (lightmapMode == 1.0)
return texture2D(liveLightmap, gl_FragCoord.xy / screenResolution.xy).xyz;
if (lightmapMode == -1.0)
return vec3(1.0);
#endif
#ifdef USE_LIGHTMAP
vec2 uv = vec2(vUv1.x, vUv1.y);
#ifdef LIGHTMAP_YCOCGM
return ycocgToRgb(hdrDecodeYcocgmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw,
lightmapThreshold.xy, uv));
#else  // LIGHTMAP_RGBM
return hdrDecodeRgbmBilinear(lightmap, lightmapSize.xy, lightmapSize.zw, uv);
#endif
#else  // ifndef USE_LIGHTMAP
return vec3(1.0);
#endif
}
#if defined(USE_ENVMAP)
uniform sampler2D roughnessTexture;
uniform vec4 roughnessCorrection;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float roughness;
#endif
float getRoughness() {
#ifdef USE_ROUGHNESS_TEXTURE
return applyMapCorrection(texture2D(roughnessTexture, vUv0), roughnessCorrection);
#else
return roughness;
#endif
}
uniform sampler2D metallicTexture;
uniform vec4 metallicCorrection;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float metallic;
#endif
float getMetallic() {
#ifdef USE_METALLIC_TEXTURE
return applyMapCorrection(texture2D(metallicTexture, vUv0), metallicCorrection);
#else
return metallic;
#endif
}
uniform sampler2D brdfLUT;
vec3 envBRDFApprox(vec3 specularColor, float roughness, float NoV) {
const vec4 c0 = vec4(-1, -0.0275, -0.572, 0.022);
const vec4 c1 = vec4(1, 0.0425, 1.04, -0.04);
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;
vec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;
return specularColor * AB.x + AB.y;
}
vec3 getBrdf(float roughness, vec3 fresnel, float clampCosnv, vec3 specularColor) {
#ifdef USE_BRDF_TEXTURE
vec2 brdf = texture2D(brdfLUT, vec2(clampCosnv, roughness)).xy;
return fresnel * brdf.x + brdf.y;
#else
return envBRDFApprox(specularColor, roughness, clampCosnv);
#endif
}
uniform samplerCube envMap[NUM_REFLECTION_PROBES];
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float envMipsCount;
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform ReflectionProbe reflectionProbes[NUM_REFLECTION_PROBES];
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
struct EnvMapLevel {
float mipLevel0;
float mipLevel1;
float mipMixFactor;
};
EnvMapLevel getEnvMapLevel(float roughness) {
EnvMapLevel result;
float maxMipLevel = envMipsCount - 1.0;
float mipSelector = roughness * maxMipLevel;
result.mipLevel0 = floor(mipSelector);
result.mipLevel1 = min(result.mipLevel0 + 1.0, maxMipLevel);
result.mipMixFactor = fract(mipSelector);
return result;
}
const vec3 infBox = vec3(1000.0);
vec3 cubeMapProject(vec3 reflectionW, in ReflectionProbe reflectionProbe) {
vec3 firstPlaneIntersect = (reflectionProbe.boxMax.xyz - vPositionW) / reflectionW;
vec3 secondPlaneIntersect = (reflectionProbe.boxMin.xyz - vPositionW) / reflectionW;
vec3 furthestPlane = max(firstPlaneIntersect, secondPlaneIntersect);
vec3 furthestPlaneNonNeg = step(0.0, -furthestPlane) * infBox + abs(furthestPlane);
float distance = min(min(furthestPlaneNonNeg.x, furthestPlaneNonNeg.y), furthestPlaneNonNeg.z);
vec3 intersectionPosW = vPositionW + reflectionW * distance;
return intersectionPosW - reflectionProbe.posW.xyz;
}
float signedDistanceBox(vec3 p, vec3 b, float offset) {
vec3 q = abs(p) - b;
return length(max(q, 0.0)) + min(max(q.x, max(q.y, q.z)), 0.0) - offset;
}
float getSignedDistanceField(in ReflectionProbe probe) {
vec3 halfBox = vec3(probe.boxMax - probe.boxMin) * vec3(0.5);
vec3 boxPos = vec3(probe.boxMax + probe.boxMin) * vec3(0.5);
vec3 localPos = boxPos - vPositionW;
const float offset = 0.1;
return signedDistanceBox(localPos, halfBox, offset);
}
vec3 sampleEnvMap(in EnvMapLevel envMapLevel, in vec3 reflectionW, samplerCube envMap,
int probeIndex) {
#ifdef USE_ENVMAP_PROJECT
ReflectionProbe reflectionProbe = reflectionProbes[probeIndex];
if (reflectionProbe.boxMin.x != reflectionProbe.boxMax.x)
reflectionW = cubeMapProject(reflectionW, reflectionProbe);
#endif
vec4 cubeColorRaw0 = textureCubeLodEXT(envMap, reflectionW, envMapLevel.mipLevel0);
vec3 cubeColor0 = hdrDecodeRgbm(cubeColorRaw0);
vec4 cubeColorRaw1 = textureCubeLodEXT(envMap, reflectionW, envMapLevel.mipLevel1);
vec3 cubeColor1 = hdrDecodeRgbm(cubeColorRaw1);
return mix(cubeColor0, cubeColor1, envMapLevel.mipMixFactor);
}
vec3 sampleEnvMapBlended(in EnvMapLevel envMapLevel, in vec3 reflectionW) {
#ifdef USE_REFLECTION_PROBE_BLENDING
float weight[NUM_REFLECTION_PROBES];
#ifdef USE_ENVMAP_PROJECT
for (int i = 0; i < NUM_REFLECTION_PROBES; i++) {
weight[i] = max(-getSignedDistanceField(reflectionProbes[i]), 0.0);
weight[i] = smoothstep(0.0, 1.0, weight[i]);
}
float weightSum = weight[0] + weight[1] + weight[2];
if (weightSum == 0.0) {
weight[0] = 1.0;
} else {
for (int i = 0; i < NUM_REFLECTION_PROBES; i++) weight[i] /= weightSum;
}
#else
for (int i = 0; i < NUM_REFLECTION_PROBES; i++) weight[i] = 1.0;
#endif
vec3 envColor = vec3(0.0, 0.0, 0.0);
if (weight[0] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0) * weight[0];
if (NUM_REFLECTION_PROBES >= 2 && weight[1] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[1], 1) * weight[1];
if (NUM_REFLECTION_PROBES >= 3 && weight[2] > 0.0)
envColor += sampleEnvMap(envMapLevel, reflectionW, envMap[2], 2) * weight[2];
#else  // not USE_REFLECTION_PROBE_BLENDING
vec3 envColor = sampleEnvMap(envMapLevel, reflectionW, envMap[0], 0);
#endif
return envColor;
}
#endif
float getEnvMapFresnel(float roughness) {
float roughness2 = roughness * roughness;
return (roughness2 - 2.0 * roughness + 1.0);
}
vec3 fresnelSchlickEnv(in vec3 specularColor, in float envMapFresnel, in float clampCosnv,
inout float opacity) {
float fresnel = 1.0 - clampCosnv;
float fresnel2 = fresnel * fresnel;
fresnel *= fresnel2 * fresnel2;
fresnel *= envMapFresnel;
opacity = opacity + (1.0 - opacity) * fresnel;
return specularColor + (1.0 - specularColor) * fresnel;
}
vec3 getSpecularColor(in vec3 baseColor, float metalic) {
const float dielectricF0 = 0.04;
return mix(vec3(dielectricF0), baseColor, metalic);
}
float getLuminance(in vec3 color) {
return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;
}
#if defined(USE_ENVMAP)
vec3 getNormalW() {
float sign = gl_FrontFacing ? 1.0 : -1.0;
#ifdef USE_BUMP_TEXTURE
vec3 normalPerturbedV = perturbNormal(-vPositionV, normalize(vNormalV));
return normalize(inverseTransformDirection(normalPerturbedV, viewMatrix)) * sign;
#else
return normalize(vNormalW) * sign;
#endif
}
vec3 addSpecular(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
vec3 totalSpec = vec3(0.0, 0.0, 0.0);
float metallic = getMetallic();
float roughness = getRoughness();
vec3 diffuseIntensity = totalIntensity * (1.0 - mix(0.04, 1.0, metallic));
vec3 viewW = normalize(cameraPosition - vPositionW);
vec3 normalW = getNormalW();
float clampCosnv = saturate(dot(normalW, viewW));
vec3 reflectionW = normalize(reflect(-viewW, normalW));
vec3 specularColor = getSpecularColor(baseColor, metallic);
EnvMapLevel envMapLevel = getEnvMapLevel(roughness);
vec3 envColor = sampleEnvMapBlended(envMapLevel, reflectionW);
float envMapFresnel = roughness * roughness - 2.0 * roughness + 1.0;
vec3 fresnel = fresnelSchlickEnv(specularColor, envMapFresnel, clampCosnv, opacity);
float luminance = getLuminance(totalIntensity);
totalSpec = envColor * getBrdf(roughness, fresnel, clampCosnv, specularColor);
#if defined(WEAK_REFLECTION_SHADOW)
float shadowingFactor = mix(0.4, 1.0, luminance);
#else
float shadowingFactor = mix(0.4, 1.0, luminance) * mix(min(luminance, 1.0), 1.0, metallic);
#endif
return baseColor * diffuseIntensity + totalSpec * shadowingFactor;
}
#else  // NOT USE_ENVMAP
vec3 addSpecular(vec3 baseColor, in vec3 lightIntensity, in float opacity) {
return baseColor * lightIntensity;
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#ifdef USE_HIGHLIGHT
uniform vec3 highlight;
uniform float highlightMix;
#endif
#endif
#if defined(HDR_OUTPUT)
vec4 hdrEncode(in vec3 rgb) {
const float rgbmScale = 2.82842712;  // sqrt(8)
vec3 r = sqrt(rgb) / rgbmScale;
float m = max(max(r.r, r.g), r.b);
m = clamp(m, 1.0 / 255.0, 1.0);
m = ceil(m * 255.0) / 255.0;
r /= m;
return vec4(r.r, r.g, r.b, (1.0 - m));
}
#endif
#ifdef USE_COLORMAP
vec3 colormap(in sampler2D lut, in vec3 color, in float intensity) {
const float resolution = 16.0;
const float maxValueIndex = resolution - 1.0;
const float sliceWidth = 1.0 / resolution;
const float slicePixelWidth = sliceWidth / resolution;
const float sliceMarginWidth = 0.5 * slicePixelWidth;
const float sliceInnerWidth = sliceWidth - slicePixelWidth;
const float slicePixelHeight = 1.0 / resolution;
const float sliceMarginHeight = 0.5 * slicePixelHeight;
const float sliceInnerHeight = 1.0 - slicePixelHeight;
float bSlice0 = min(floor(color.b * maxValueIndex), maxValueIndex - 1.0);
float bSlice1 = bSlice0 + 1.0;
float bOffset = color.b * maxValueIndex - bSlice0;
float rSlicePos = sliceMarginWidth + color.r * sliceInnerWidth;
float gSlicePos = sliceMarginHeight + color.g * sliceInnerHeight;
float rPos0 = rSlicePos + (bSlice0 * sliceWidth);
float rPos1 = rSlicePos + (bSlice1 * sliceWidth);
vec3 color0 = texture2D(lut, vec2(rPos0, gSlicePos)).rgb;
vec3 color1 = texture2D(lut, vec2(rPos1, gSlicePos)).rgb;
return mix(color, mix(color0, color1, bOffset), intensity);
}
uniform sampler2D colorMap;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float colorMapIntensity;
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
#endif
#ifdef USE_CHROMA_KEY
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 chromaKeyColor;
uniform vec3 chromaKeyDeltaCoeff;
#endif
const float k32 = sqrt(3.0) / 2.0;
vec3 rgb2abi(vec3 color) {
float r = color.r;
float g = color.g;
float b = color.b;
return vec3(r - 0.5 * g - 0.5 * b, k32 * (g - b), 0.3333 * (r + g + b));
}
const float IPI2 = 0.5 / 3.1415926538;
vec3 rgb2hci(vec3 color) {
vec3 abi = rgb2abi(color);
return vec3(atan(abi.y, abi.x) * IPI2, length(abi.xy), abi.z);
}
float chromaKeyShapeFn(vec3 delta, vec3 color, vec3 key) {
vec3 diff = color - key;
vec3 v = delta * vec3(
0.5 - abs(abs(diff.x) - 0.5), abs(diff.y), abs(diff.z));
float x = max(v.r, max(v.g, v.b));
return x * x;
}
float chromaKeyEdgeFn(float a) {
return clamp(.2 / .5 * (a - 1.0), 0.0, 1.0);
}
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float emissionStrength;
#ifdef USE_EXPOSURE_AND_GAMMA
uniform vec4 camera_exposure_gamma;
#else
const vec4 camera_exposure_gamma = vec4(1.0, 1.0, 0.0, 0.0);
#endif
#endif  // DEV_DISABLE_UNIFORM_BUFFERS
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity);
void main() {
float alpha;
vec3 baseColor = getBaseColorHook(alpha);
#ifdef USE_CHROMA_KEY
float dist = chromaKeyShapeFn(chromaKeyDeltaCoeff, rgb2hci(baseColor), rgb2hci(chromaKeyColor));
alpha *= chromaKeyEdgeFn(dist);
#endif
#if defined(USE_BASE_COLOR_TEXTURE)
if (alpha < alphaDiscardThreshold) {
discard;
}
#endif
vec3 lightIntensity = getLightIntensity();
#ifdef USE_HIGHLIGHT
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
baseColor = mix(baseColor, highlight, highlightMix);
alpha = mix(alpha, 1.0, highlightMix);
#endif
#endif
vec3 diffuseSpecular = addSpecularHook(baseColor, lightIntensity, alpha);
#if defined(LIVE_LIGHTMAP) || defined(USE_HEADLIGHT)
#ifdef LIVE_LIGHTMAP
if (lightmapMode == -1.0)
#endif
{
vec3 lightW = normalize(cameraPosition - vPositionW.xyz);
vec3 normalW = vNormalW * (gl_FrontFacing ? 1.0 : -1.0);
float pointDiffuse = max(dot(normalize(normalW), lightW), 0.0);
diffuseSpecular *= pointDiffuse;
}
#endif
vec3 diffuseSpecularEmissive = diffuseSpecular + baseColor * emissionStrength;
#ifdef USE_FOG
float distance = length(vPositionV);
diffuseSpecularEmissive = addFog(diffuseSpecularEmissive, distance, vPositionW);
#endif
#ifdef HDR_OUTPUT
if (alpha < 0.5) {
discard;
}
fragColor = hdrEncode(diffuseSpecularEmissive);
#else  // no HDR_OUTPUT
vec3 exposedColor =
pow(camera_exposure_gamma.x * diffuseSpecularEmissive.xyz, vec3(camera_exposure_gamma.y));
vec3 gammaColor = linearToGammaToneMapped(exposedColor);
#ifdef USE_COLORMAP
fragColor = vec4(colormap(colorMap, min(gammaColor, 1.0), colorMapIntensity), alpha);
#else
fragColor = vec4(gammaColor, alpha);
#endif
#endif  // no HDR_OUTPUT
}
`,"standard_material_vertex.glsl":`const float PI = 3.14159265358979;
const float RECIPROCAL_PI2 = 0.15915494;
float saturate(in float a) {
return clamp(a, 0.0, 1.0);
}
vec3 inverseTransformDirection(in vec3 normal, in mat4 matrix) {
return normalize((vec4(normal, 0.0) * matrix).xyz);
}
vec3 sphericalDecode(in vec2 spNormal) {
float theta = (spNormal.x / 254.0 + 0.5) * PI;
float phi = spNormal.y * (PI / 127.0);
float sinTheta = sin(theta);
return vec3(sinTheta * cos(phi), sinTheta * sin(phi), cos(theta));
}
vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE)
varOut vec2 vUv0;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec4 uvMod0;
#endif
#endif
#ifdef USE_LIGHTMAP
webgl2centroid varOut vec2 vUv1;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
varOut vec3 vPositionV;
#endif
#ifdef USE_BUMP_TEXTURE
varOut vec3 vNormalV;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
varOut vec3 vPositionW;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
varOut vec3 vNormalW;
#endif
void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal);
void main() {
#if defined(USE_BASE_COLOR_TEXTURE) || defined(USE_ROUGHNESS_TEXTURE) || \\
defined(USE_METALLIC_TEXTURE) || defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE)
vUv0 = uv0 * uvMod0.zw + uvMod0.xy;
#endif
vec4 transformedPosition = transformPosition();
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vec4 mvPosition = modelViewMatrix * transformedPosition;
#ifdef USE_LIGHTMAP
float zeroOrOne = min(uv1.x + uv1.y, 1.0);
vUv1 = uv1 * uv1Mod.zw + uv1Mod.xy * zeroOrOne;
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_HEIGHT_TEXTURE) || defined(USE_ENVMAP) || \\
defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
vec3 n = sphericalDecode(sphericalNormal);
vec3 normal = vec3(t0.x * n.x + t0.y * n.y + t0.z * n.z, t1.x * n.x + t1.y * n.y + t1.z * n.z,
t2.x * n.x + t2.y * n.y + t2.z * n.z);
modifyMvPositionHook(mvPosition, normal);
#endif
#if defined(USE_BUMP_TEXTURE) || defined(USE_FOG)
vPositionV = -mvPosition.xyz;
#endif
#if defined(USE_BUMP_TEXTURE)
vNormalV = normalize(mat3(normalMatrix) * normal);
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(USE_FOG) || defined(LIVE_LIGHTMAP)
vPositionW = (modelMatrix * transformedPosition).xyz;
#endif
#if defined(USE_ENVMAP) || defined(USE_HEADLIGHT) || defined(LIVE_LIGHTMAP)
vNormalW = mat3(modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz) * normal;
vNormalW = normalize(vNormalW);
#endif
gl_Position = projectionMatrix * mvPosition;
}
`,"static_render_fragment.glsl":`float _l2g(in float x) {
return (x <= 0.0031308) ? x * 12.92 : pow(x, 1.0 / 2.4) * 1.055 - 0.055;
}
vec3 linearToGamma(in vec3 rgb) {
return vec3(_l2g(rgb.r), _l2g(rgb.g), _l2g(rgb.b));
}
vec3 hable(in vec3 rgb) {
float A = 0.15;  // shoulderStrength
float B = 0.50;  // linearStrength
float C = 0.10;  // linearAngle
float D = 0.20;  // toeStrength
float E = 0.02;  // toeNumerator
float F = 0.30;  // toeDenominator
return ((rgb * (A * rgb + C * B) + D * E) / (rgb * (A * rgb + B) + D * F)) - E / F;
}
vec3 toneMappingHable(in vec3 rgb) {
float exposure = 11.2;
float exposureBias = 2.0;
vec3 current = hable(exposureBias * rgb);
vec3 whiteScale = 1.0 / hable(vec3(exposure));
return pow(current * whiteScale, vec3(1.0 / 2.2));
}
vec3 uchimura(in vec3 x, in float P, in float a, in float m, in float l, in float c, in float b) {
float l0 = ((P - m) * l) / a;
float L0 = m - m / a;
float L1 = m + (1.0 - m) / a;
float S0 = m + l0;
float S1 = m + a * l0;
float C2 = (a * P) / (P - S1);
float CP = -C2 / P;
vec3 w0 = vec3(1.0 - smoothstep(0.0, m, x));
vec3 w2 = vec3(step(m + l0, x));
vec3 w1 = vec3(1.0 - w0 - w2);
vec3 T = vec3(m * pow(x / m, vec3(c)) + b);
vec3 S = vec3(P - (P - S1) * exp(CP * (x - S0)));
vec3 L = vec3(m + a * (x - m));
return T * w0 + L * w1 + S * w2;
}
vec3 toneMappingUchimura(in vec3 rgb) {
float P = 1.0;   // max display brightness
float a = 1.0;   // contrast
float m = 0.22;  // linear section start
float l = 0.4;   // linear section length
float c = 1.45;  // black
float b = 0.0;   // pedestal
return pow(uchimura(rgb, P, a, m, l, c, b), vec3(1.0 / 2.2));
}
vec3 toneMappingUnreal(in vec3 rgb) {
return rgb / (rgb + 0.187) * 1.035;
}
vec3 linearToGammaToneMapped(in vec3 rgb) {
#ifdef TONE_MAPPING_UNREAL
return toneMappingUnreal(rgb);
#endif
#ifdef TONE_MAPPING_HABLE
return toneMappingHable(rgb);
#endif
#ifdef TONE_MAPPING_UCHIMURA
return toneMappingUchimura(rgb);
#endif
return toneMappingUnreal(rgb);
}
uniform sampler2D staticRender;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec2 sizeInv;
#endif
void main() {
vec3 colorLinear = texture2D(staticRender, gl_FragCoord.xy * sizeInv).rgb;
fragColor = vec4(linearToGammaToneMapped(colorLinear), 1.0);
}
`,"static_render_vertex.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
void main() {
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
gl_Position = modelViewMatrix * vec4(position, 1.0);
}
`,"temporal_aa_fragment.glsl":`varIn vec2 vUv0;
uniform sampler2D tColor;
uniform sampler2D tDepth;
uniform sampler2D tColorPrev;
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform mat4 projMatrix;
uniform mat4 invProjMatrix;
uniform mat4 invViewMatrix;
uniform mat4 prevProjMatrix;
uniform mat4 prevViewMatrix;
uniform vec2 resolution;
uniform vec2 rtSize;
uniform vec2 jitterOffset;
uniform float temporalWeight;
#endif
vec4 getWorldPosFromDepth(float depth, vec2 uv) {
vec3 ndc = vec3(uv * 2.0 - 1.0, depth);
float clipW = projMatrix[2][3] / (ndc.z - projMatrix[2][2]);
vec4 clipPos = vec4(ndc * clipW, clipW);
vec4 viewPos = invProjMatrix * clipPos;
return invViewMatrix * viewPos;
}
vec2 getBackgroundVelocity(vec2 uv) {
vec4 worldPos = getWorldPosFromDepth(texture2D(tDepth, uv).r, uv);
vec4 previousPos = prevViewMatrix * worldPos;
previousPos = prevProjMatrix * previousPos;
previousPos /= previousPos.w;
vec2 prevPositionSS = vec2(previousPos.x * 0.5 + 0.5, previousPos.y * 0.5 + 0.5) * rtSize;
vec2 velocity = gl_FragCoord.xy - prevPositionSS;
return velocity * resolution;
}
vec3 getPreviousFrameColor(vec2 uv, vec2 velocity) {
vec3 minColor = vec3(9999.0);
vec3 maxColor = vec3(-9999.0);
for (int x = -1; x <= 1; x++) {
for (int y = -1; y <= 1; y++) {
vec3 color = texture2D(tColor, uv + vec2(x, y) * resolution).xyz;
minColor = min(minColor, color);  // Take min and max
maxColor = max(maxColor, color);
}
}
vec2 prevFrameUV = uv - velocity;
vec3 prevColor = texture2D(tColorPrev, prevFrameUV).xyz;
return clamp(prevColor, minColor, maxColor);
}
void main() {
vec3 currentColor = texture2D(tColor, vUv0).xyz;
vec3 prevColor = getPreviousFrameColor(vUv0, getBackgroundVelocity(vUv0));
fragColor.xyz = mix(currentColor, prevColor, temporalWeight);
}
`,"water.glsl":`#ifdef USE_NORMAL_TEXTURE
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform float time;
uniform float wavesSpeed;
uniform float wavesScale;
uniform float refractionFactor;
#endif
uniform sampler2D normalTexture;
vec4 getNoise(in vec2 uv, in float wavesTime) {
vec2 uv0 = (uv / 103.0) + vec2(wavesTime / 17.0, wavesTime / 29.0);
vec2 uv1 = uv / 107.0 - vec2(wavesTime / -19.0, wavesTime / 31.0);
vec2 uv2 = uv / vec2(897.0, 983.0) + vec2(wavesTime / 101.0, wavesTime / 97.0);
vec2 uv3 = uv / vec2(991.0, 877.0) - vec2(wavesTime / 109.0, wavesTime / -113.0);
vec4 noise = texture2D(normalTexture, uv0) + texture2D(normalTexture, uv1) +
texture2D(normalTexture, uv2) + texture2D(normalTexture, uv3);
return noise * 0.5 - 1.0;
}
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
vec3 toEyeW = cameraPosition - vPositionW;
vec3 viewW = normalize(toEyeW);
vec4 noise = getNoise(vPositionW.xy * wavesScale, time * wavesSpeed);
vec3 normalW = normalize(noise.xyz);
float clampCosnv = saturate(dot(normalW, viewW));
const float waterF0 = 0.02;
vec3 specularColor = vec3(waterF0);
vec3 reflectionW = reflect(-viewW, normalW);
vec3 refractionW = refract(-viewW, normalW, 0.75);
EnvMapLevel mirrorLevel = EnvMapLevel(0.0, 0.0, 0.0);
vec3 reflectedEnv = sampleEnvMap(mirrorLevel, normalize(reflectionW), envMap[0], 0);
vec3 refractedEnv =
refractionFactor * sampleEnvMap(mirrorLevel, normalize(refractionW), envMap[0], 0);
vec3 fresnel = fresnelSchlickEnv(specularColor, 1.0, clampCosnv, opacity);
vec3 totalSpec = reflectedEnv * fresnel + refractedEnv * (1.0 - fresnel);
vec3 diffuseIntensity = totalIntensity * 0.98;
float luminance = getLuminance(totalIntensity);
return totalSpec * mix(0.4, 1.0, luminance) + baseColor * diffuseIntensity;
}
#else  // NOT USE_NORMAL_TEXTURE
vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity, inout float opacity) {
return baseColor * totalIntensity;
}
#endif
vec3 getBaseColorHook(out float alpha) {
return getBaseColor(alpha);
}
`,"wireframe_fragment.glsl":`#ifdef DEV_DISABLE_UNIFORM_BUFFERS
uniform vec3 lineColor;
uniform float maxDistance;
uniform float lineThickness;
uniform float backsideLineThickness;
#endif
varIn vec3 vBaryCentric;
varIn vec3 vPositionV;
const float LOG2 = 1.442695;
const float maxOpacity = 0.9;
const float minOpacity = 0.4;
const float maxSize = 1.5;
const float minSize = 0.9;
const vec3 luma = vec3(0.299, 0.587, 0.114);
float edgeFactor(float size) {
vec3 d = fwidth(vBaryCentric);
vec3 r = smoothstep(vec3(0.0), d * size, vBaryCentric);
return min(min(r.x, r.y), r.z);
}
void main(void) {
float distanceSq = dot(vPositionV, vPositionV);
float distanceExp = 1.0 - exp2(-(1.0 / maxDistance) * distanceSq * LOG2);
float opacity = max(lineThickness, mix(maxOpacity, minOpacity, distanceExp));
float size = max(lineThickness, mix(maxSize, minSize, distanceExp));
#if defined(USE_TRANSPARENT_WIREFRAME)
vec3 color = lineColor;
if (!gl_FrontFacing) {
opacity *= 0.5;
size = max(backsideLineThickness, mix(maxSize, minSize, distanceExp));
float luminance = dot(lineColor, luma);
color = mix(lineColor, vec3(luminance), 0.65);
}
float edge = edgeFactor(size);
if (edge < 1.0) {
fragColor = vec4(color, (1.0 - edge) * opacity);
} else {
discard;
}
#else
opacity = (1.0 - edgeFactor(size)) * opacity;
fragColor = vec4(mix(vec3(1.0), lineColor, opacity), 1.0);
#endif
}
`,"wireframe_vertex.glsl":`vec4 transformPosition() {
return vec4(t0.x * position.x + t0.y * position.y + t0.z * position.z + t0.w,
t1.x * position.x + t1.y * position.y + t1.z * position.z + t1.w,
t2.x * position.x + t2.y * position.y + t2.z * position.z + t2.w, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
uniform GlobalBuffer {
mat4 projectionMatrix;
mat4 viewMatrix;
mat4 viewProjMatrix;
vec3 cameraPosition;
vec4 fogDistStart_DistDensity_HeightStart_HeightDensity;
vec4 fogColor;
vec4 camera_exposure_gamma;
float colorMapIntensity;
float time;
};
#endif
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = projectionMatrix * modelViewMatrix * worldPos;
}
#else
void setClipPositionFromWorldPos(in vec4 worldPos) {
gl_Position = viewProjMatrix * modelMatrix * worldPos;
}
#endif
void setClipPositionFromWorldPos(in vec3 worldPos) {
setClipPositionFromWorldPos(vec4(worldPos, 1.0));
}
void setClipPositionFromViewPos(in vec4 viewPos) {
gl_Position = projectionMatrix * viewPos;
}
void setClipPositionFromViewPos(in vec3 viewPos) {
setClipPositionFromViewPos(vec4(viewPos, 1.0));
}
varOut vec3 vBaryCentric;
varOut vec3 vPositionV;
void main() {
int order = gl_VertexID % 3;
if (order == 0) {
vBaryCentric = vec3(1.0, 0.0, 0.0);
} else if (order == 1) {
vBaryCentric = vec3(0.0, 1.0, 0.0);
} else {
vBaryCentric = vec3(0.0, 0.0, 1.0);
}
#ifdef DEV_DISABLE_UNIFORM_BUFFERS
#else
mat4 modelViewMatrix = viewMatrix * modelMatrix;
#endif
vec4 transformedPosition = transformPosition();
vec4 mvPosition = modelViewMatrix * transformedPosition;
vPositionV = -mvPosition.xyz;
gl_Position = projectionMatrix * modelViewMatrix * transformedPosition;
}
`},To=class To{constructor(e,t){a(this,"id");a(this,"code");this.id=e,this.code=t}static get(e){const i=Eu[e];return new To(e,i)}static makeInline(e){const t=To._inlineId++;return new To("inline_"+t,e)}static reloadShaders(e){fetch(gi("shaders.js")).then(t=>{t.text().then(i=>{const n=i.split(`
`).splice(1).join(`
`),r=JSON.parse(n),o=Eu;for(const l in r)Object.prototype.hasOwnProperty.call(r,l)&&(o[l]=r[l]);e()})})}hash(){let e=0;for(let t=0;t<this.code.length;t++){const i=this.code.charCodeAt(t);e=(e<<5)-e+i,e|=0}return e}equals(e){return this.id===e.id&&this.code===e.code}};a(To,"_inlineId",0);let nn=To;var Gi=(s=>(s[s.FRONT=0]="FRONT",s[s.BACK=1]="BACK",s[s.DOUBLE=2]="DOUBLE",s))(Gi||{}),Hi=(s=>(s[s.DISABLED=0]="DISABLED",s[s.NORMAL=1]="NORMAL",s[s.ADDITIVE=2]="ADDITIVE",s[s.SUBTRACTIVE=3]="SUBTRACTIVE",s[s.MULTIPLY=4]="MULTIPLY",s[s.CUSTOM=5]="CUSTOM",s))(Hi||{});const O_=Object.freeze((()=>{const s=new qc,e=new Float32Array([0,0]);return s.uv0=e,s.uv1=e,s.uv1Mod=new Float32Array([0,0,1/65535,1/65535]),s.t0=new Float32Array([1,0,0,0]),s.t1=new Float32Array([0,1,0,0]),s.t2=new Float32Array([0,0,1,0]),s.sphericalNormal=e,s})()),B_=Object.freeze(["position","sphericalNormal","uv0","uv1","uv1Mod","t0","t1","t2"]),N_=nn.makeInline(""),k_=nn.makeInline(""),wu=`#version 300 es
#define texture2D texture
#define textureCube texture
#define textureCubeLodEXT textureLod
#define texture2DGradEXT textureGrad
#define attr in
#define varOut out
#define varIn in
#define webgl2centroid centroid
`,U_=Object.keys(Ho).map(s=>"TONE_MAPPING_"+s),z_=s=>{s===null?s=Au:Object.values(Ho).includes(s)||(tt(!1,"Invalid tone mapping mode value"),s=Au);for(const[e,t]of Object.entries(Ho))if(t==s)return"TONE_MAPPING_"+e;return""};class Su{}const Fa=class Fa extends kt{constructor(t){var n,r;super();a(this,"name","");a(this,"attributes");a(this,"vertexShaderName");a(this,"_vertexShaderBody");a(this,"_vertexShaderHooks");a(this,"fragmentShaderName");a(this,"_fragmentShaderBody");a(this,"_fragmentShaderHooks");a(this,"_updated");a(this,"side",0);a(this,"doNotOverrideSide",!1);a(this,"_opacity",1);a(this,"transparent",!1);a(this,"transparentRenderOrder",0);a(this,"blending",0);a(this,"blendSrc",ne.SRC_ALPHA);a(this,"blendDst",ne.ONE_MINUS_SRC_ALPHA);a(this,"blendEquation",ne.FUNC_ADD);a(this,"blendSrcAlpha",null);a(this,"blendDstAlpha",null);a(this,"blendEquationAlpha",null);a(this,"depthTest",!0);a(this,"depthWrite",!0);a(this,"colorWrite",!0);a(this,"_hideFromLightProbes",!1);a(this,"_defines",new Set);a(this,"_definesString",null);a(this,"_lightmapSize",new Lt);a(this,"_lightmapThreshold",new Ue);a(this,"uniforms",{});a(this,"uniformBufferData");a(this,"uniformBufferDataConstructor",Su);a(this,"defaultAttributeValues",O_);a(this,"index0AttributeName");a(this,"visible",!0);a(this,"_programNeedsUpdate",!0);a(this,"program",null);a(this,"_sharedMaterialState",null);a(this,"lightmapSupported",!1);a(this,"fogSupported",!1);a(this,"hdrOutputSupported",!1);a(this,"colorMapSupported",!1);a(this,"exposureAndGammaSupported",!1);a(this,"toneMappingSupported",!1);a(this,"renderSteps",1);a(this,"id",-1);Fa._materialIdCount+=1,this.id=Fa._materialIdCount,this.attributes=B_,t.vsName&&t.vsName,t.fsName&&t.fsName,this.vertexShaderName=t.vsName,this._vertexShaderBody=nn.get(t.vsName),this._vertexShaderHooks=(n=t.vsHooks)!=null?n:N_,this.fragmentShaderName=t.fsName,this._fragmentShaderBody=nn.get(t.fsName),this._fragmentShaderHooks=(r=t.fsHooks)!=null?r:k_;const i={type:"materialUpdated"};this._updated=()=>this.dispatchEvent(i),t.uniformBufferDataConstructor&&(this.uniformBufferDataConstructor=t.uniformBufferDataConstructor,this.uniformBufferData=new this.uniformBufferDataConstructor)}get isAnimated(){return!1}get isPlaying(){return!1}update(t){}rewind(){console.assert(!1)}play(){console.assert(!1)}pause(){console.assert(!1)}get envMapMirror(){return!1}get hideFromLightProbes(){return this._hideFromLightProbes}set hideFromLightProbes(t){this._hideFromLightProbes=t}get programNeedsUpdate(){return this._programNeedsUpdate}fillMaterialUniformDataFromUniforms(){const t=this.uniforms;for(const i in this.uniformBufferData)if(Object.prototype.hasOwnProperty.call(this.uniformBufferData,i)&&Object.prototype.hasOwnProperty.call(t,i)){const n=t[i].value;if(typeof n=="string"){const r=+n;an(this.uniformBufferData,i,r)}else an(this.uniformBufferData,i,n)}}set programNeedsUpdate(t){this._definesString=null,this._programNeedsUpdate=t,this.dispatchEvent({type:"recompile"})}get lightmapEnabled(){return this.lightmapSupported&&this.sharedMaterialState!==null&&this.sharedMaterialState.lightmapEnabled}get sharedMaterialState(){return this._sharedMaterialState}set sharedMaterialState(t){this._sharedMaterialState=t,this._setSharedStateUpdate(),this._applySharedState()}hasDefine(t){return this._defines.has(t)}addDefine(t){this.hasDefine(t)||(this._defines.add(t),this.programNeedsUpdate=!0)}removeDefine(t){this.hasDefine(t)&&(this._defines.delete(t),this.programNeedsUpdate=!0)}condDefine(t,i){return t?this.addDefine(i):this.removeDefine(i),t}_getDefinesString(){if(this._definesString===null){const t=[];for(const i of this._defines)t.push("#define "+i);t.sort(),this._definesString=t.join(`
`)}return this._definesString}generateProgramId(){return[this._fragmentShaderBody.id,this._fragmentShaderHooks.id,this._getDefinesString(),this._vertexShaderBody.id,this._vertexShaderHooks.id].join("$")}tryToRefreshShaderCode(){const t=nn.get(this.vertexShaderName),i=nn.get(this.fragmentShaderName),n=!t.equals(this._vertexShaderBody)||!i.equals(this._fragmentShaderBody);return n&&(this._vertexShaderBody=t,this._fragmentShaderBody=i),n}generateVertexShader(t="#define DEV_DISABLE_UNIFORM_BUFFERS",i=""){return[wu,"precision highp float;","precision highp int;",this._getDefinesString(),t,"#ifdef DEV_DISABLE_UNIFORM_BUFFERS","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat3 normalMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","#else",i,"#endif","attr vec3 position;","attr vec2 sphericalNormal;","attr vec2 uv0;","attr vec2 uv1;","attr vec4 uv1Mod;","attr vec4 t0;","attr vec4 t1;","attr vec4 t2;",this._vertexShaderBody.code,this._vertexShaderHooks.code].join(`
`)}generateFragmentShader(t="#define DEV_DISABLE_UNIFORM_BUFFERS",i=""){return[wu,"precision "+it.gl.fragmentPrecision+" float;","precision "+it.gl.fragmentPrecision+" int;",t,this._getDefinesString(),"#ifdef DEV_DISABLE_UNIFORM_BUFFERS","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","#else",i,"#endif","out vec4 fragColor;",this._fragmentShaderBody.code,this._fragmentShaderHooks.code].join(`
`)}dispose(){this.dispatchEvent({type:"dispose"})}setUniform(t,i,n,r=ve.MATERIAL){this.uniforms[t]={type:i,value:n,uniformSourceType:r},this.uniforms[t].uniformSourceType===ve.MATERIAL&&this.uniformBufferData&&Object.prototype.hasOwnProperty.call(this.uniformBufferData,t)&&an(this.uniformBufferData,t,n)}propertyFromUniform(t){Object.defineProperty(this,t,{get:function(){return this.uniforms[t].value},set:function(i){this.uniforms[t].value=i}})}hash(){throw"canMerge not implemented"}updateRenderStep(t){}_setSharedStateUpdate(){this._sharedMaterialState.addEventListener("sharedMaterialStateUpdate",()=>{this._applySharedState()&&this._updated()})}_applySharedState(){let t=!1;if(D.DEV_DISABLE_UNIFORM_BUFFERS&&this.fogSupported){const r=this.sharedMaterialState.fog;if(this.condDefine(r!==void 0&&r.enabled(),"USE_FOG")&&r){const o=r.distanceEnabled?r.distanceDensity:0,l=r.heightEnabled?r.heightDensity:0;this.setUniform("fogDistStart_DistDensity_HeightStart_HeightDensity","v4",new Lt(r.distanceStart,o,r.heightStart,l),ve.GLOBAL),this.setUniform("fogColor","c",r.color,ve.GLOBAL)}t=!0}if(this.condDefine(!!this._sharedMaterialState.liveLightmap.texture,"LIVE_LIGHTMAP")){tt(this._sharedMaterialState);const r=this._sharedMaterialState.liveLightmap;this.setUniform("screenResolution","v4",new Lt(this._sharedMaterialState.physicalWidth,this._sharedMaterialState.physicalHeight,0,0),ve.GLOBAL),this.setUniform("lightmapMode","f",r.mode,ve.GLOBAL),this.setUniform("liveLightmap","t",r.texture,ve.GLOBAL),t=!0}if(this.hdrOutputSupported&&(this.condDefine(this.sharedMaterialState.hdrOutput,"HDR_OUTPUT"),t=!0),this.colorMapSupported){const r=this.sharedMaterialState.colorMap,o=this.sharedMaterialState.colorMapIntensity,l=r!==null&&o>0;this.condDefine(l,"USE_COLORMAP")&&(this.setUniform("colorMap","t",r,ve.GLOBAL),D.DEV_DISABLE_UNIFORM_BUFFERS&&this.setUniform("colorMapIntensity","f",o,ve.GLOBAL)),t=!0}if(this.exposureAndGammaSupported){if(this.addDefine("USE_EXPOSURE_AND_GAMMA"),D.DEV_DISABLE_UNIFORM_BUFFERS){const r=Math.pow(2,this.sharedMaterialState.cameraExposure);this.setUniform("camera_exposure_gamma","v4",new Lt(r,this.sharedMaterialState.cameraGamma,0,0),ve.GLOBAL)}t=!0}this.toneMappingSupported&&(U_.forEach(r=>{this.removeDefine(r)}),this.addDefine(z_(this.sharedMaterialState.toneMapping)),t=!0);const i=this.sharedMaterialState.brdfLUT;this.condDefine(i!==void 0,"USE_BRDF_TEXTURE")&&this.setUniform("brdfLUT","t",i,ve.GLOBAL),t=!0,this.condDefine(this.sharedMaterialState.weakReflectionShadow,"WEAK_REFLECTION_SHADOW");const n=this.sharedMaterialState.lightmapEncoding;return this.condDefine(this.lightmapEnabled&&n!==void 0,"USE_LIGHTMAP")&&n&&(this.addDefine("LIGHTMAP_"+n.toUpperCase()),this.setUniform("lightmap","t",null,ve.LIGHT),D.DEV_DISABLE_UNIFORM_BUFFERS&&(this.setUniform("lightmapSize","v4",this._lightmapSize,ve.LIGHT),this.setUniform("lightmapThreshold","v2",this._lightmapThreshold,ve.LIGHT)),t=!0),t}refreshPerObjectUniforms(t){const i=this.uniforms;let n=t.lightmap;return this.lightmapEnabled&&i.lightmap.value!==n?((!n||!n.loaded)&&(n=this.sharedMaterialState.getDefaultLightmap(n?n.ycocgmThreshold:0)),i.lightmap.value=n,D.DEV_DISABLE_UNIFORM_BUFFERS&&(i.lightmapSize.value.x=n.width,i.lightmapSize.value.y=n.height,i.lightmapSize.value.z=1/n.width,i.lightmapSize.value.w=1/n.height,i.lightmapThreshold.value.x=n.ycocgmThreshold,i.lightmapThreshold.value.y=(1-n.ycocgmThreshold)/(16-3)),!0):!1}};a(Fa,"_materialIdCount",0);let ai=Fa;class V_{constructor(){a(this,"hslContrast",new Lt);a(this,"inversionScaleContrast",new Lt)}}class no{constructor(){a(this,"contrast",0);a(this,"hslAdjustment",{h:0,s:0,l:0});a(this,"scale",0);a(this,"inversion",!1);a(this,"correctionTurnedOn",!1);a(this,"texture");a(this,"correctionUniforms",new V_)}getUniformVectors(){if(this.texture&&this.correctionTurnedOn){this.correctionUniforms.hslContrast.set(this.hslAdjustment.h,this.hslAdjustment.s,this.hslAdjustment.l,this.contrast);const e=(this.inversion?-1:1)*(1+this.scale),t=this.inversion?1:0;this.correctionUniforms.inversionScaleContrast.set(t,e,this.contrast,0)}else this.correctionUniforms.hslContrast.set(0,0,0,0),this.correctionUniforms.inversionScaleContrast.set(0,1,0,0);return this.correctionUniforms}loadFromJson(e,t){if(!e)return;const i=new ln(e);this.correctionTurnedOn=!0,this.contrast=i.parseNumber("contrast",0);const n=e.hslAdjustment;if(n)this.hslAdjustment.h=n[0],this.hslAdjustment.s=n[1],this.hslAdjustment.l=n[2];else{const r=t.getHSL(),o=e.hslOffset;this.hslAdjustment.h=o[0],this.hslAdjustment.s=Math.max(-1,Math.min(o[1]/(r.s==0?1:r.s),4)),this.hslAdjustment.l=Math.max(-1,Math.min(o[2]/(r.l==0?1:r.l),4))}this.inversion=i.parseBoolean("inversion",!1),this.scale=i.parseNumber("scale",0)}equals(e){return this.texture===e.texture&&this.correctionTurnedOn===e.correctionTurnedOn&&this.contrast===e.contrast&&this.hslAdjustment.h===e.hslAdjustment.h&&this.hslAdjustment.s===e.hslAdjustment.s&&this.hslAdjustment.l===e.hslAdjustment.l&&this.inversion===e.inversion&&this.scale===e.scale}serializeCorrection(){return this.correctionTurnedOn?{contrast:this.contrast,hslAdjustment:[this.hslAdjustment.h,this.hslAdjustment.s,this.hslAdjustment.l],inversion:this.inversion,scale:this.scale}:null}}const G_="standard_material_vertex.glsl",H_="standard_material_fragment.glsl",W_=nn.makeInline(["vec3 addSpecularHook(in vec3 baseColor, in vec3 totalIntensity,","                     inout float opacity) {","  return addSpecular(baseColor, totalIntensity, opacity);","}","vec3 getBaseColorHook(out float alpha) {","  return getBaseColor(alpha);","}"].join(`
`)),j_=nn.makeInline(["void modifyMvPositionHook(inout vec4 mvPosition, in vec3 normal) {}"].join(`
`)),yr=new B(0,0,0),dl=new Lt(0,0,1,1);var Tu=(s=>(s.BASIC="USE_BASIC_PARALLAX",s.STEEP="USE_STEEP_PARALLAX",s.OCCLUSION="USE_OCLUSION_PARALLAX",s.RELIEF="USE_RELIEF_PARALLAX",s))(Tu||{}),Pn=(s=>(s.BASE_COLOR="baseColorTexture",s.BUMP="bumpTexture",s.METALLIC="metallicTexture",s.ROUGHNESS="roughnessTexture",s.HEIGHT="heightTexture",s.NORMAL="normalTexture",s))(Pn||{});class Mu{constructor(){a(this,"mirrorX",!1);a(this,"mirrorY",!1);a(this,"stepX",1);a(this,"stepY",1);a(this,"maxOffsetX",1);a(this,"maxOffsetY",1)}}class so{constructor(){a(this,"baseColor",new Re);a(this,"envMipsCount",1);a(this,"opacity",1);a(this,"cutoutMaskThreshold",.5);a(this,"roughness",1);a(this,"metallic",0);a(this,"emissionStrength",1);a(this,"antiTilingRegularStepX",1);a(this,"antiTilingRegularStepY",1);a(this,"antiTilingRegularMaxOffsetX",0);a(this,"antiTilingRegularMaxOffsetY",0);a(this,"baseColorCorrection",new Lt);a(this,"baseColorAtlasUvMod",new Lt);a(this,"alphaDiscardThreshold",0);a(this,"chromaKeyColor",new Re);a(this,"chromaKeyDeltaCoeff",new B);a(this,"bumpScale",1);a(this,"parallaxScale",-.03);a(this,"parallaxMinLayers",10);a(this,"parallaxMaxLayers",15);a(this,"uvMod0",new Lt)}}const X_=so,Us=class Us extends ai{constructor(t){super({vsName:t!=null&&t.vsName?t.vsName:G_,fsName:t!=null&&t.fsName?t.fsName:H_,vsHooks:t!=null&&t.vsHooks?t.vsHooks:j_,fsHooks:t!=null&&t.fsHooks?t.fsHooks:W_,uniformBufferDataConstructor:t?t.uniformBufferDataConstructor:X_});a(this,"_emitLiveLightmapRequestIfWarranted",()=>{this._emissive&&this.dispatchEvent({type:Us.majorLightingPropertyUpdatedEventType})});a(this,"merged",!1);a(this,"_opacity",1);a(this,"_cutoutMaskThreshold",.5);a(this,"_cutoutMode","autodetect");a(this,"baseColor",new Re(16777215));a(this,"_correctedBaseColorTexture",new no);a(this,"_correctedRoughnessTexture",new no);a(this,"_correctedMetallicTexture",new no);a(this,"_correctedBumpTexture",new no);a(this,"_antiTilingType");a(this,"antiTilingRegularParameters",new Mu);a(this,"_emissive",!1);a(this,"_emissionStrength",1);a(this,"_reflective",!0);a(this,"_roughness",1);a(this,"_metallic",0);a(this,"cubeCameraIndex",null);a(this,"_lastUsedLightProbeIds",[]);a(this,"disableLightProbe",!1);a(this,"_envMapProject",!0);a(this,"_bumpScale",.001);a(this,"parallaxCorrection",!1);a(this,"parallaxMode","USE_BASIC_PARALLAX");a(this,"parallaxScale",-.03);a(this,"parallaxMinLayers",10);a(this,"parallaxMaxLayers",15);a(this,"_headLight");a(this,"_uvOffsetScale");a(this,"_repeatableTexturesRequired",!1);a(this,"highlight");a(this,"_highlightMix",0);a(this,"doNotImport");a(this,"_alphaInLowerHalf",!1);a(this,"_chromaKeyEnabled");a(this,"chromaKeyColor",new Re(0,.94,0));a(this,"chromaKeyDelta",new B(.1,.1,.1));a(this,"_chromaKeyDeltaCoeff",new B);a(this,"lightmapSupported",!0);a(this,"fogSupported",!0);a(this,"hdrOutputSupported",!0);a(this,"colorMapSupported",!0);a(this,"exposureAndGammaSupported",!0);a(this,"toneMappingSupported",!0);a(this,"name","");this.doNotImport={baseColor:!1,opacity:!1},D.EDIT_MODE&&(this.highlight=D.EDITOR_SELECTION_COLOR)}get opacity(){return this._opacity}set opacity(t){t>.99?this._opacity=1:this._opacity=t,this.configureTransparency(),this.setUniforms(),this._updated(),this.dispatchEvent({type:Us.majorLightingPropertyUpdatedEventType})}get cutoutMaskThreshold(){return this._cutoutMaskThreshold}set cutoutMaskThreshold(t){this._cutoutMaskThreshold=t,this.setUniforms(),this._updated()}_useChromaKey(){return!!(this.isAnimated&&this.chromaKeyEnabled)}_useAlphaInLowerHalf(){return!!(this.isAnimated&&this.alphaInLowerHalf)}_useBaseColorTextureAsCutout(){const t=this._correctedBaseColorTexture.texture;return this.opacity===1&&(t&&t.isCutout||this._useAlphaInLowerHalf()||this._useChromaKey())}loadCorrection(t,i){var n;(n=this._getCorrectedTexture(t))==null||n.loadFromJson(i,this.baseColor)}configureTransparency(){const t=this._getTexture("baseColorTexture"),i=!!t&&(t.hasAlpha||this._useAlphaInLowerHalf()||this._useChromaKey());this.transparent=this.opacity<1||i;const n=!!(this._useBaseColorTextureAsCutout()&&this._cutoutMode==="autodetect"||this._cutoutMode==="enabled");this.transparent?(this.blending=Hi.NORMAL,n?this.transparentRenderOrder=0:this.transparentRenderOrder=1):this.blending=Hi.DISABLED,this.depthWrite=!this.transparent||n,this.condDefine(n,"USE_CUTOUT_MASK")}getCutoutMode(){return this._cutoutMode}setCutoutMode(t){this._cutoutMode=t,this.configureTransparency(),this.setUniforms(),this._updated()}setChromaKeyColorRGB(t,i,n){this.chromaKeyColor.setRGB(t,i,n),this.setUniforms(),this._updated()}getChromaKeyDeltaComponent(t){return this.chromaKeyDelta.getComponent(t)}setChromaKeyDeltaComponent(t,i){this.chromaKeyDelta.setComponent(t,i),this.setUniforms(),this._updated()}rewind(){this.baseColorTexture instanceof wt,this.baseColorTexture.rewind()}play(){console.assert(this.isAnimated),this.baseColorTexture instanceof wt;const t=this.baseColorTexture.isPlaying;this.baseColorTexture.play(),this.baseColorTexture.isPlaying!==t&&this._updated()}pause(){console.assert(this.isAnimated),this.baseColorTexture instanceof wt;const t=this.baseColorTexture.isPlaying;this.baseColorTexture.pause(),this.baseColorTexture.isPlaying!==t&&this._updated()}sleepAnimation(){console.assert(this.isAnimated),this.baseColorTexture instanceof wt,this.baseColorTexture.sleepAnimation()}wakeAnimation(){console.assert(this.isAnimated),this.baseColorTexture instanceof wt,this.baseColorTexture.wakeAnimation()}getTextureMapCorrectionTurnedOn(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.correctionTurnedOn)!=null?n:!1}setTextureMapCorrectionTurnedOn(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"correctionTurnedOn",i)}getTextureMapInversion(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.inversion)!=null?n:!1}setTextureMapInversion(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"inversion",i)}getTextureMapContrast(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.contrast)!=null?n:0}setTextureMapContrast(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"contrast",i)}getTextureMapScale(t){var i,n;return(n=(i=this._getCorrectedTexture(t))==null?void 0:i.scale)!=null?n:0}setTextureMapScale(t,i){const n=this._getCorrectedTexture(t);n&&this._doSetProperty(n,"scale",i)}getTextureMapHslAdjustment(t,i){var n,r;return(r=(n=this._getCorrectedTexture(t))==null?void 0:n.hslAdjustment[i])!=null?r:0}setTextureMapHslAdjustment(t,i,n){const r=this._getCorrectedTexture(t);r&&this._doSetProperty(r.hslAdjustment,i,n)}setAntiTilingRegularParameters(t,i){this._doSetProperty(this.antiTilingRegularParameters,t,i)}setDoNotImport(t,i){this._doSetProperty(this.doNotImport,t,i)}isLightProbeDisabled(){return this.disableLightProbe||!this.reflective}_setLightProbeUniforms(){const t=D.ENABLE_REFLECTION_PROBES_BLENDING?D.MAX_BLENDED_REFLECTION_PROBES:1;for(let n=0;n<t;n++)this.setUniform(`envMap[${n}]`,"t",null,ve.LIGHT);this.addDefine(`NUM_REFLECTION_PROBES ${t}`);const i=this.envMapMirror?1:D.LIGHT_PROBE_MIPS_COUNT;if(this.setUniform("envMipsCount","f",i,ve.MATERIAL),this.condDefine(this.envMapProject,"USE_ENVMAP_PROJECT")&&(this.condDefine(D.ENABLE_REFLECTION_PROBES_BLENDING,"USE_REFLECTION_PROBE_BLENDING"),D.DEV_DISABLE_UNIFORM_BUFFERS))for(let n=0;n<D.MAX_BLENDED_REFLECTION_PROBES;n++)this.setUniform(`reflectionProbes[${n}].boxMin`,"v3",yr,ve.LIGHT),this.setUniform(`reflectionProbes[${n}].boxMax`,"v3",yr,ve.LIGHT),this.setUniform(`reflectionProbes[${n}].posW`,"v3",yr,ve.LIGHT);this._lastUsedLightProbeIds=[]}getUvOffsetAndScale(t){return t.copyFrom(this._uvOffsetScale||dl)}_uvOffsetAndScaleModified(){this.ensureTexturesRepeatable(),this._updated()}setUvOffsetAndScale(t,i,n,r){this._uvOffsetScale||(this._uvOffsetScale=new Lt,this.setUniforms()),t instanceof Lt?this._uvOffsetScale.copyFrom(t):this._uvOffsetScale.set(t,i,n,r),this._uvOffsetAndScaleModified()}getUvOffsetAndScaleByProperty(t){return this._uvOffsetScale[t]}setUvOffsetAndScaleByProperty(t,i){this._uvOffsetScale[t]=i,this._uvOffsetAndScaleModified()}ensureTexturesRepeatable(){this._repeatableTexturesRequired=!0,this.baseColorTexture instanceof Xc&&this.baseColorTexture.loaded&&(this.addDefine("USE_BASE_COLOR_TEXTURE_ATLAS_REPEAT"),this.setUniforms())}setUniforms(){var m;this.setUniform("opacity","f",this.opacity,ve.MATERIAL),this.setUniform("cutoutMaskThreshold","f",this.cutoutMaskThreshold,ve.MATERIAL);const t=!this.isLightProbeDisabled();let i=!1;const n=this.roughnessTexture,r=!!n&&n.loaded&&t;this.condDefine(r,"USE_ROUGHNESS_TEXTURE")?(this.setUniform("roughnessTexture","t",n,ve.MATERIAL),i=!0):this.setUniform("roughness","f",this.roughness,ve.MATERIAL);const o=this.metallicTexture,l=!!o&&o.loaded&&t;this.condDefine(l,"USE_METALLIC_TEXTURE")?(this.setUniform("metallicTexture","t",o,ve.MATERIAL),i=!0):this.setUniform("metallic","f",this.metallic,ve.MATERIAL);const c=this.emissive?this.emissionStrength:0;this.setUniform("emissionStrength","f",c,ve.MATERIAL),this.condDefine(this.antiTilingType==="Organic","ANTI_TILING_ORGANIC"),this.condDefine(this.antiTilingType==="Regular","ANTI_TILING_REGULAR")&&(this.condDefine(this.antiTilingRegularParameters.mirrorX,"ANTI_TILING_REGULAR_MIRROR_X"),this.condDefine(this.antiTilingRegularParameters.mirrorY,"ANTI_TILING_REGULAR_MIRROR_Y"),this.setUniform("antiTilingRegularStepX","f",this.antiTilingRegularParameters.stepX,ve.MATERIAL),this.setUniform("antiTilingRegularStepY","f",this.antiTilingRegularParameters.stepY,ve.MATERIAL),this.setUniform("antiTilingRegularMaxOffsetX","f",this.antiTilingRegularParameters.maxOffsetX,ve.MATERIAL),this.setUniform("antiTilingRegularMaxOffsetY","f",this.antiTilingRegularParameters.maxOffsetY,ve.MATERIAL));const d=this._correctedBaseColorTexture.getUniformVectors();this.setUniform("baseColorCorrection","v4",d.hslContrast,ve.MATERIAL);const u=this._correctedBumpTexture.getUniformVectors().inversionScaleContrast;if(this.setUniform("bumpCorrection","v4",u,ve.MATERIAL),r){const b=this._correctedRoughnessTexture.getUniformVectors().inversionScaleContrast;this.setUniform("roughnessCorrection","v4",b,ve.MATERIAL)}if(l){const b=this._correctedMetallicTexture.getUniformVectors().inversionScaleContrast;this.setUniform("metallicCorrection","v4",b,ve.MATERIAL)}let h=this._correctedBaseColorTexture.texture,f=dl;if(h&&h instanceof Xc&&h.parentTexture&&(f=h.uvOffsetScale,h=h.parentTexture),this.condDefine(!!h&&h.loaded,"USE_BASE_COLOR_TEXTURE")?(this.setUniform("baseColorTexture","t",h,ve.MATERIAL),i=!0,this.setUniform("baseColorAtlasUvMod","v4",f,ve.MATERIAL),this._useBaseColorTextureAsCutout()?this.setUniform("alphaDiscardThreshold","f",.25,ve.MATERIAL):this.setUniform("alphaDiscardThreshold","f",0,ve.MATERIAL)):this.setUniform("baseColor","c",this.baseColor,ve.MATERIAL),this.condDefine(this._useAlphaInLowerHalf(),"USE_ALPHA_IN_LOWER_HALF"),this.condDefine(this._useChromaKey(),"USE_CHROMA_KEY")){this.setUniform("chromaKeyColor","c",this.chromaKeyColor,ve.MATERIAL);const b=1.22,_=this.chromaKeyDelta;this._chromaKeyDeltaCoeff.x=1/(b*_.x),this._chromaKeyDeltaCoeff.y=1/(b*_.y),this._chromaKeyDeltaCoeff.z=1/(b*_.z),this.setUniform("chromaKeyDeltaCoeff","v3",this._chromaKeyDeltaCoeff,ve.MATERIAL)}const p=this.bumpTexture;this.condDefine(!!p&&p.loaded&&t,"USE_BUMP_TEXTURE")&&(this.setUniform("bumpTexture","t",p,ve.MATERIAL),i=!0,this.setUniform("bumpScale","f",this.bumpScale,ve.MATERIAL),this.condDefine(this.parallaxCorrection,"USE_PARALLAX_CORRECTION")&&(this.addDefine(Tu[this.parallaxMode]),this.setUniform("parallaxScale","f",this.parallaxScale,ve.MATERIAL),this.setUniform("parallaxMinLayers","f",this.parallaxMinLayers,ve.MATERIAL),this.setUniform("parallaxMaxLayers","f",this.parallaxMaxLayers,ve.MATERIAL))),i&&this.setUniform("uvMod0","v4",this._uvOffsetScale||dl,ve.MATERIAL),this.condDefine(t,"USE_ENVMAP")&&this._setLightProbeUniforms(),this.condDefine(this.highlight!==void 0,"USE_HIGHLIGHT")&&(this.setUniform("highlight","c",this.highlight,ve.OBJECT),this.setUniform("highlightMix","f",this.highlightMix,ve.OBJECT)),this.condDefine((m=this.headLight)!=null?m:!this.lightmapEnabled,"USE_HEADLIGHT"),this.fillMaterialUniformDataFromUniforms()}forceObjectUniformsRefresh(){this._lastUsedLightProbeIds=[]}textureNeedsUv0(t){return!0}get type(){return"standard"}hash(){return this.baseColorTexture?"standard"+this.baseColorTexture.name:"standard#"+this.baseColor.r+":"+this.baseColor.g+":"+this.baseColor.b}_getCorrectedTexture(t){switch(t){case"baseColorTexture":return this._correctedBaseColorTexture;case"bumpTexture":return this._correctedBumpTexture;case"metallicTexture":return this._correctedMetallicTexture;case"roughnessTexture":return this._correctedRoughnessTexture;case"heightTexture":case"normalTexture":return}vs(t,`Unknown type ${t}.`)}_getTexture(t){const i=this._getCorrectedTexture(t);return i?i.texture:this[t]}_setTexture(t,i){const n=this._getCorrectedTexture(t);n&&(n.texture=i,i&&!i.loaded?i.addLoadedListener(()=>{t=="baseColorTexture"&&this.configureTransparency(),this._repeatableTexturesRequired&&this.ensureTexturesRepeatable(),this.setUniforms(),this._updated()}):(this.setUniforms(),this._updated()))}canMerge(t){if(this.type!==t.type||this.opacity!==t.opacity)return!1;if(this._correctedBaseColorTexture.texture||t._correctedBaseColorTexture.texture){if(!Us.baseColorTexturesEqual(this,t)||!Us.antiTilingEqual(this,t))return!1}else if(!this.baseColor.equals(t.baseColor))return!1;if((this.emissive||t.emissive)&&(this.emissive!==t.emissive||this.emissionStrength!==t.emissionStrength))return!1;if(this.roughnessTexture||t.roughnessTexture){if(this.roughnessTexture!==t.roughnessTexture)return!1}else if(this.roughness!==t.roughness)return!1;if(this.metallicTexture||t.metallicTexture){if(this.metallicTexture!==t.metallicTexture)return!1}else if(this.metallic!==t.metallic)return!1;return!((this.bumpTexture||t.bumpTexture)&&(this.bumpTexture!==t.bumpTexture||this.bumpScale!==t.bumpScale)||this.envMapProject!==t.envMapProject||this.doubleSided!==t.doubleSided||this.parallaxCorrection||t.parallaxCorrection||!Us.uvOffsetScaleEqual(this,t))}assignLightProbe(t,i){const n=this.uniforms,r=this.envMapMirror?t.getMirrorTexture():t.getFilteredTexture();n[`envMap[${i}]`].value=r,D.DEV_DISABLE_UNIFORM_BUFFERS&&this.envMapProject&&(t.isBoundingBoxEnabled()?(n[`reflectionProbes[${i}].posW`].value=t.position,n[`reflectionProbes[${i}].boxMin`].value=t.boxMin,n[`reflectionProbes[${i}].boxMax`].value=t.boxMax):(n[`reflectionProbes[${i}].boxMin`].value=yr,n[`reflectionProbes[${i}].boxMax`].value=yr))}refreshPerObjectUniforms(t){const i=this.uniforms;let n=super.refreshPerObjectUniforms(t);const r=t instanceof As&&t.selected?t.highlightMix:0;if(i.highlightMix!==void 0&&r!==i.highlightMix.value&&(i.highlightMix.value=r,n=!0),this.isLightProbeDisabled())return n;const o=[];if(t.lightProbes.forEach(c=>o.push(c.id)),Ja(this._lastUsedLightProbeIds,o))return n;n=!0,this._lastUsedLightProbeIds=[...o];const l=this.envMapMirror?1:D.LIGHT_PROBE_MIPS_COUNT;if(i.envMipsCount.value=l,D.ENABLE_REFLECTION_PROBES_BLENDING){const c=this.envMapMirror?1:t.lightProbes.length;for(let u=0;u<c;u++)this.assignLightProbe(t.lightProbes[u],u);const d=t.lightProbes[0].getFilteredTexture();for(let u=c;u<D.MAX_BLENDED_REFLECTION_PROBES;u+=1)i[`envMap[${u}]`].value=d,D.DEV_DISABLE_UNIFORM_BUFFERS&&(i[`reflectionProbes[${u}].boxMin`].value=yr,i[`reflectionProbes[${u}].boxMax`].value=yr)}else this.assignLightProbe(t.lightProbes[0],0);return n}setBaseColorRGB(t,i,n){this.baseColor.setRGB(t,i,n),this.setUniforms(),this._updated(),this._emitLiveLightmapRequestIfWarranted()}getTextureAndSettings(t){var n;const i=this._getTexture(t);return t==="bumpTexture"?[i,{bumpScale:this._bumpScale}]:t==="baseColorTexture"?[i,{correctionTurnedOn:this._correctedBaseColorTexture.correctionTurnedOn,correction:(n=this._correctedBaseColorTexture.serializeCorrection())!=null?n:void 0,antiTilingType:this.antiTilingType,antiTilingRegularParameters:zt({},this.antiTilingRegularParameters),baseColor:this.baseColor.roundChannels().toArray()}]:[i,{}]}setTexture(t,i,n){var r,o,l,c,d,u,h,f,p,m;if(i===null&&(i=void 0),i){const b=this.baseColorTexture;b instanceof wt&&(i.wrapS=b.wrapS,i.wrapT=b.wrapT,i.anisotropy=b.anisotropy)}this._getCorrectedTexture(t)!==void 0&&(this._setTexture(t,i),this._getCorrectedTexture(t).correctionTurnedOn=n.correctionTurnedOn||!1,this._getCorrectedTexture(t).contrast=((r=n.correction)==null?void 0:r.contrast)||0,this._getCorrectedTexture(t).hslAdjustment.h=((o=n.correction)==null?void 0:o.hslAdjustment[0])||0,this._getCorrectedTexture(t).hslAdjustment.s=((l=n.correction)==null?void 0:l.hslAdjustment[1])||0,this._getCorrectedTexture(t).hslAdjustment.l=((c=n.correction)==null?void 0:c.hslAdjustment[2])||0,t==="baseColorTexture"?(this.antiTilingType=n.antiTilingType||"None",this.antiTilingRegularParameters.mirrorX=((d=n.antiTilingRegularParameters)==null?void 0:d.mirrorX)||!1,this.antiTilingRegularParameters.mirrorY=((u=n.antiTilingRegularParameters)==null?void 0:u.mirrorY)||!1,this.antiTilingRegularParameters.stepX=((h=n.antiTilingRegularParameters)==null?void 0:h.stepX)||1,this.antiTilingRegularParameters.stepY=((f=n.antiTilingRegularParameters)==null?void 0:f.stepY)||1,this.antiTilingRegularParameters.maxOffsetX=((p=n.antiTilingRegularParameters)==null?void 0:p.maxOffsetX)||1,this.antiTilingRegularParameters.maxOffsetY=((m=n.antiTilingRegularParameters)==null?void 0:m.maxOffsetY)||1,n.baseColor&&this.baseColor.fromArray(n.baseColor)):t==="bumpTexture"&&(this._bumpScale=n.bumpScale||.001))}serializeTextureProperties(t){const i=this._getCorrectedTexture(t);if(i!==void 0)return{correction:i.serializeCorrection(),texture:i.texture?i.texture.serialize():null}}serializeAntiTilingProperties(){if(!this.antiTiling)return;const t=this.antiTilingType;ye(t);let i;return t==="Regular"&&(i=this.antiTilingRegularParameters),{antiTilingType:t,antiTilingRegularParameters:i}}serializeUvOffsetScale(){return this.uvOffsetAndScaleEnabled?this._uvOffsetScale.toArray():null}serialize(){console.assert(!this.merged);const t=this.baseColor.roundChannels().toArray(),i=this.serializeTextureProperties("baseColorTexture"),n=this.serializeTextureProperties("roughnessTexture"),r=this.serializeTextureProperties("metallicTexture"),o=this.serializeTextureProperties("bumpTexture"),l=this._chromaKeyEnabled!==void 0;return{name:this.name,type:this.type,baseColor:t,baseColorTexture:i.texture,baseColorTextureCorrection:i.correction,alphaInLowerHalf:this.alphaInLowerHalf,chromaKeyEnabled:l?this.chromaKeyEnabled:null,chromaKeyColor:l?this.chromaKeyColor.roundChannels().toArray():null,chromaKeyDelta:l?this.chromaKeyDelta.toArray():null,opacity:this.opacity,cutoutMode:this._cutoutMode,cutoutMaskThreshold:this.cutoutMaskThreshold,emissive:this.emissive,emissionStrength:this.emissionStrength,reflective:this.reflective,roughness:this.roughness,metallic:this.metallic,envMapProject:this.envMapProject,bumpScale:this.bumpScale,doubleSided:this.doubleSided,doNotImport:this.doNotImport,roughnessTexture:n.texture,roughnessTextureCorrection:n.correction,metallicTexture:r.texture,metallicTextureCorrection:r.correction,bumpTexture:o.texture,bumpTextureCorrection:o.correction,uvOffsetScale:this.serializeUvOffsetScale(),antiTiling:this.serializeAntiTilingProperties()}}_onTextureSet(t){t?t.addLoadedListener(()=>{this.setUniforms(),this._updated()}):(this.setUniforms(),this._updated())}get roughnessTexture(){return this._correctedRoughnessTexture.texture}set roughnessTexture(t){this._correctedRoughnessTexture.texture=t,this._onTextureSet(t)}get metallicTexture(){return this._correctedMetallicTexture.texture}set metallicTexture(t){this._correctedMetallicTexture.texture=t,this._onTextureSet(t)}get bumpTexture(){return this._correctedBumpTexture.texture}set bumpTexture(t){this._correctedBumpTexture.texture=t,this._onTextureSet(t)}get alphaInLowerHalf(){return this._alphaInLowerHalf}set alphaInLowerHalf(t){this._alphaInLowerHalf=t,this.configureTransparency(),this.setUniforms(),this._updated()}get chromaKeyEnabled(){return!!this._chromaKeyEnabled}set chromaKeyEnabled(t){this._chromaKeyEnabled=!!t,this.configureTransparency(),this.setUniforms(),this._updated()}get isAnimated(){const t=this.baseColorTexture;return t instanceof wt&&t.isAnimated}get isPlaying(){const t=this.baseColorTexture;return t instanceof wt&&t.isAnimated&&t.isPlaying}get doubleSided(){return this.side===Gi.DOUBLE}set doubleSided(t){this.side=t?Gi.DOUBLE:Gi.FRONT,this.setUniforms(),this._updated()}get antiTiling(){return this._antiTilingType!==void 0}get antiTilingType(){return this._antiTilingType}set antiTilingType(t){this._antiTilingType=t,this.setUniforms(),this._updated()}get envMapMirror(){return this.roughness===0&&!this.roughnessTexture}get highlightMix(){return this._highlightMix}set highlightMix(t){t!==this._highlightMix&&(this._highlightMix=t,this.uniforms.highlightMix.value=t)}get baseColorTexture(){return this._correctedBaseColorTexture.texture}set baseColorTexture(t){this._setTexture("baseColorTexture",t)}_doSetProperty(t,i,n){n!==t[i]&&(an(t,i,n),this.setUniforms(),this._updated(),this._emitLiveLightmapRequestIfWarranted())}get emissive(){return this._emissive}set emissive(t){this._doSetProperty(this,"_emissive",t),this.dispatchEvent({type:Us.majorLightingPropertyUpdatedEventType})}get emissionStrength(){return this._emissionStrength}set emissionStrength(t){this._doSetProperty(this,"_emissionStrength",t)}get reflective(){return this._reflective}set reflective(t){this._doSetProperty(this,"_reflective",t)}get headLight(){return this._headLight}set headLight(t){this._doSetProperty(this,"_headLight",t)}get roughness(){return this._roughness}set roughness(t){this._doSetProperty(this,"_roughness",t)}get metallic(){return this._metallic}set metallic(t){this._doSetProperty(this,"_metallic",t)}get envMapProject(){return this._envMapProject}set envMapProject(t){this._doSetProperty(this,"_envMapProject",t)}get bumpScale(){return this._bumpScale}set bumpScale(t){this._doSetProperty(this,"_bumpScale",t)}get uvOffsetAndScaleEnabled(){return this._uvOffsetScale!==void 0}set uvOffsetAndScaleEnabled(t){t?this.setUvOffsetAndScale(dl):(this._uvOffsetScale=void 0,this.setUniforms(),this._updated())}static baseColorTexturesEqual(t,i){return t._correctedBaseColorTexture.equals(i._correctedBaseColorTexture)&&t._useAlphaInLowerHalf()===i._useAlphaInLowerHalf()&&(t._useChromaKey()?i._useChromaKey()&&t.chromaKeyColor.equals(i.chromaKeyColor)&&t.chromaKeyDelta.equals(i.chromaKeyDelta):!i._useChromaKey())}static antiTilingEqual(t,i){return t.antiTilingType===i.antiTilingType&&t.antiTilingRegularParameters.mirrorX===i.antiTilingRegularParameters.mirrorX&&t.antiTilingRegularParameters.mirrorY===i.antiTilingRegularParameters.mirrorY&&t.antiTilingRegularParameters.stepX===i.antiTilingRegularParameters.stepX&&t.antiTilingRegularParameters.stepY===i.antiTilingRegularParameters.stepY&&t.antiTilingRegularParameters.maxOffsetX===i.antiTilingRegularParameters.maxOffsetX&&t.antiTilingRegularParameters.maxOffsetY===i.antiTilingRegularParameters.maxOffsetY}static uvOffsetScaleEqual(t,i){return t._uvOffsetScale&&i._uvOffsetScale?t._uvOffsetScale.equals(i._uvOffsetScale):!1}};a(Us,"majorLightingPropertyUpdatedEventType","majorLightingPropertyUpdated");let si=Us;class Wi{constructor(){a(this,"id",NaN);a(this,"attributes",new L_);a(this,"attributesKeys",new Array);a(this,"boundingBox",null);a(this,"boundingSphere",null);a(this,"_disableBoundingVolumesCompute",!1);a(this,"_onDispose")}addAttribute(e,t){this.attributes[e]=t,this.attributesKeys.indexOf(e)==-1&&this.attributesKeys.push(e)}getAttribute(e){return this.attributes[e]}hasAttribute(e){return this.attributesKeys.includes(e)}applyMatrix(e){const t=this.attributes.position;t!==void 0&&(ye(t.array instanceof Float32Array),e.affineTransformPoint3Array(t.array),t.needsUpdate=!0);const i=this.attributes.normal;i!==void 0&&(ye(i.array instanceof Float32Array),new ys().getNormalMatrix(e).transformVector3Array(i.array),i.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere()}center(){tt(!this._disableBoundingVolumesCompute),this.computeBoundingBox();const e=this.boundingBox.center().negate();return this.applyMatrix(new je().setPosition(e)),e}computeBoundingBox(){if(this._disableBoundingVolumesCompute)return;tt(this.attributes.position);const e=new B;this.boundingBox===null&&(this.boundingBox=new Dt);const t=this.attributes.position.array;if(t){const i=this.boundingBox;i.makeEmpty();for(let n=0,r=t.length;n<r;n+=3)e.set(t[n],t[n+1],t[n+2]),i.expandByPoint(e)}else this.attributes.position.buffer&&console.warn("Computing bounding box for geometry with released position data");(!t||t.length===0)&&(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('Computed bbox min/max have NaN values. The "position" attribute is likely to have NaN values.')}computeBoundingSphere(){if(this._disableBoundingVolumesCompute)return;tt(this.attributes.position);const e=new Dt,t=new B;this.boundingSphere===null&&(this.boundingSphere=new Tn);const i=this.attributes.position.array;if(i){e.makeEmpty();const n=this.boundingSphere.center;for(let o=0;o<i.length;o+=3)t.set(i[o],i[o+1],i[o+2]),e.expandByPoint(t);e.center(n);let r=0;for(let o=0;o<i.length;o+=3)t.set(i[o],i[o+1],i[o+2]),r=Math.max(r,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('Computed bounding sphere radius is NaN. The "position" attribute is likely to have NaN values.')}else this.attributes.position.buffer&&console.warn("Computing bounding sphere for geometry with released position data")}computeVertexNormals(){var n;const e=this.attributes;if(!e.position)return;e.position.array instanceof Float32Array;const t=(n=e.index)==null?void 0:n.array,i=Lo.vertexNormals(e.position.array,t);e.normal===void 0?this.addAttribute("normal",new St(i,3)):e.normal.array=i,e.normal.needsUpdate=!0}normalizeNormals(){this.attributes.normal&&(this.attributes.normal.array instanceof Float32Array,Lo.normalizeVectors(this.attributes.normal.array))}setOnDispose(e){this._onDispose=e}dispose(){this._onDispose&&this._onDispose(this)}convertNormalsToSpherical(){tt(this.attributes.normal),tt(this.attributes.sphericalNormal===void 0),tt(this.attributes.normal.array);const e=this.attributes.normal.array,t=it.ios,i=Lo.normalsToSpherical(e,t);delete this.attributes.normal;const n=this.attributesKeys.indexOf("normal");this.attributesKeys.splice(n,1),this.addAttribute("sphericalNormal",new St(i,2))}changePosition(e){tt(this.attributes.position);const t=this.attributes.position.length/3,i=this.attributes.position.array;for(let n=0;n<3*t;n+=3)i[n]+=e.x,i[n+1]+=e.y,i[n+2]+=e.z}}class dt{static createBox(e,t,i,n=1,r=1,o=1){for(const m of[n,r,o])console.assert(Number.isInteger(m)&&m>=1);const l=new Array,c=new Array,d=new Array,u=new Array;let h=0;function f(m,b,_,y,A,T,M,C,N,O){const q=T/N,j=M/O,K=T/2,de=M/2,xe=C/2,Ve=N+1,qe=O+1;let k=0;const Q=new B;for(let le=0;le<qe;le++){const ae=le*j-de;for(let Ee=0;Ee<Ve;Ee++){const te=Ee*q-K;Q[m]=te*y,Q[b]=ae*A,Q[_]=xe,c.push(Q.x,Q.y,Q.z),Q[m]=0,Q[b]=0,Q[_]=C>0?1:-1,d.push(Q.x,Q.y,Q.z),u.push(Ee/N),u.push(1-le/O),k+=1}}for(let le=0;le<O;le++)for(let ae=0;ae<N;ae++){const Ee=h+ae+Ve*le,te=h+ae+Ve*(le+1),me=h+(ae+1)+Ve*(le+1),Fe=h+(ae+1)+Ve*le;l.push(Ee,te,Fe),l.push(te,me,Fe)}h+=k}f("z","y","x",-1,-1,i,t,e,o,r),f("z","y","x",1,-1,i,t,-e,o,r),f("x","z","y",1,1,e,i,t,n,o),f("x","z","y",1,-1,e,i,-t,n,o),f("x","y","z",1,-1,e,t,i,n,r),f("x","y","z",-1,-1,e,t,-i,n,r),console.assert(c.length<=65535+1);const p=new Wi;return p.addAttribute("index",new St(new Uint16Array(l),1)),p.addAttribute("position",new St(new Float32Array(c),3)),p.addAttribute("normal",new St(new Float32Array(d),3)),p.addAttribute("uv0",new St(new Float32Array(u),2)),p}static createSphere(e=50,t=8,i=6,n=0,r=Math.PI*2,o=0,l=Math.PI){console.assert(t>=3&&Number.isInteger(t)),console.assert(i>=2&&Number.isInteger(i));const c=o+l;let d=0;const u=[],h=new B,f=new B,p=new Array,m=new Array,b=new Array,_=new Array;for(let A=0;A<=i;A++){const T=[],M=A/i;for(let C=0;C<=t;C++){const N=C/t;h.x=-e*Math.cos(n+N*r)*Math.sin(o+M*l),h.y=e*Math.cos(o+M*l),h.z=e*Math.sin(n+N*r)*Math.sin(o+M*l),m.push(h.x,h.y,h.z),f.set(h.x,h.y,h.z),f.normalize(),b.push(f.x,f.y,f.z),_.push(N,1-M),T.push(d++)}u.push(T)}for(let A=0;A<i;A++)for(let T=0;T<t;T++){const M=u[A][T+1],C=u[A][T],N=u[A+1][T],O=u[A+1][T+1];(A!==0||o>0)&&p.push(M,C,O),(A!==i-1||c<Math.PI)&&p.push(C,N,O)}console.assert(m.length<=65535+1);const y=new Wi;return y.addAttribute("index",new St(new Uint16Array(p),1)),y.addAttribute("position",new St(new Float32Array(m),3)),y.addAttribute("normal",new St(new Float32Array(b),3)),y.addAttribute("uv0",new St(new Float32Array(_),2)),y}static createPlane(e,t,i=1,n=1){console.assert(i>=1&&Number.isInteger(i)),console.assert(n>=1&&Number.isInteger(n));const r=e/2,o=t/2,l=i,c=n,d=l+1,u=c+1,h=e/l,f=t/c,p=new Float32Array(d*u*3),m=new Float32Array(d*u*3),b=new Float32Array(d*u*2);let _=0,y=0;for(let M=0;M<u;M++){const C=M*f-o;for(let N=0;N<d;N++){const O=N*h-r;p[_]=O,p[_+1]=-C,m[_+2]=1,b[y]=N/l,b[y+1]=1-M/c,_+=3,y+=2}}_=0;const A=new(p.length/3>65535?Uint32Array:Uint16Array)(l*c*6);for(let M=0;M<c;M++)for(let C=0;C<l;C++){const N=C+d*M,O=C+d*(M+1),q=C+1+d*(M+1),j=C+1+d*M;A[_]=N,A[_+1]=O,A[_+2]=j,A[_+3]=O,A[_+4]=q,A[_+5]=j,_+=6}const T=new Wi;return T.addAttribute("index",new St(A,1)),T.addAttribute("position",new St(p,3)),T.addAttribute("normal",new St(m,3)),T.addAttribute("uv0",new St(b,2)),T}static createCylinder(e=20,t=20,i=100,n=8,r=1,o=!1,l=0,c=2*Math.PI){console.assert(n>=3&&Number.isInteger(n)),console.assert(r>=1&&Number.isInteger(r));const d=new Array,u=new Array,h=new Array,f=new Array;let p=0;const m=new Array,b=i/2;function _(){const T=new B,M=new B,C=(t-e)/i;for(let N=0;N<=r;N++){const O=[],q=N/r,j=q*(t-e)+e;for(let K=0;K<=n;K++){const de=K/n,xe=de*c+l,Ve=Math.sin(xe),qe=Math.cos(xe);M.x=j*Ve,M.y=-q*i+b,M.z=j*qe,u.push(M.x,M.y,M.z),T.set(Ve,C,qe),T.normalize(),h.push(T.x,T.y,T.z),f.push(de,1-q),O.push(p++)}m.push(O)}for(let N=0;N<n;N++)for(let O=0;O<r;O++){const q=m[O][N],j=m[O+1][N],K=m[O+1][N+1],de=m[O][N+1];d.push(q,j,de),d.push(j,K,de)}}function y(T){const M=new Ue,C=new B,N=T?e:t,O=T?1:-1,q=p;for(let K=1;K<=n;K++)u.push(0,b*O,0),h.push(0,O,0),f.push(.5,.5),p++;const j=p;for(let K=0;K<=n;K++){const xe=K/n*c+l,Ve=Math.cos(xe),qe=Math.sin(xe);C.x=N*qe,C.y=b*O,C.z=N*Ve,u.push(C.x,C.y,C.z),h.push(0,O,0),M.x=Ve*.5+.5,M.y=qe*.5*O+.5,f.push(M.x,M.y),p++}for(let K=0;K<n;K++){const de=q+K,xe=j+K;T===!0?d.push(xe,xe+1,de):d.push(xe+1,xe,de)}}_(),o||(e>0&&y(!0),t>0&&y(!1)),console.assert(u.length<=65535+1);const A=new Wi;return A.addAttribute("index",new St(new Uint16Array(d),1)),A.addAttribute("position",new St(new Float32Array(u),3)),A.addAttribute("normal",new St(new Float32Array(h),3)),A.addAttribute("uv0",new St(new Float32Array(f),2)),A}static createTorus(e=1,t=.4,i=8,n=6,r=Math.PI*2){console.assert(i>=3&&Number.isInteger(i)),console.assert(n>=3&&Number.isInteger(n));const o=new Array,l=new Array,c=new Array,d=new Array,u=new B,h=new B,f=new B;for(let m=0;m<=i;m++)for(let b=0;b<=n;b++){const _=b/n*r,y=m/i*Math.PI*2;h.x=(e+t*Math.cos(y))*Math.cos(_),h.y=(e+t*Math.cos(y))*Math.sin(_),h.z=t*Math.sin(y),l.push(h.x,h.y,h.z),u.x=e*Math.cos(_),u.y=e*Math.sin(_),f.subVectors(h,u).normalize(),c.push(f.x,f.y,f.z),d.push(b/n),d.push(m/i)}for(let m=1;m<=i;m++)for(let b=1;b<=n;b++){const _=(n+1)*m+b-1,y=(n+1)*(m-1)+b-1,A=(n+1)*(m-1)+b,T=(n+1)*m+b;o.push(_,y,T),o.push(y,A,T)}console.assert(l.length<=65535+1);const p=new Wi;return p.addAttribute("index",new St(new Uint16Array(o),1)),p.addAttribute("position",new St(new Float32Array(l),3)),p.addAttribute("normal",new St(new Float32Array(c),3)),p.addAttribute("uv0",new St(new Float32Array(d),2)),p}static createPolyhedron(e,t,i=1,n=0){const r=new Array,o=new Array;function l(m,b,_){const y=Math.pow(2,n),A=new Array;for(let M=0;M<=y;M++){A[M]=[];const C=m.clone().lerp(_,M/y),N=b.clone().lerp(_,M/y),O=y-M;for(let q=0;q<=O;q++)q===0&&M===y?A[M][q]=C:A[M][q]=C.clone().lerp(N,q/O)}const T=M=>r.push(M.x,M.y,M.z);for(let M=0;M<y;M++)for(let C=0;C<2*(y-M)-1;C++){const N=Math.floor(C/2);C%2===0?(T(A[M][N+1]),T(A[M+1][N]),T(A[M][N])):(T(A[M][N+1]),T(A[M+1][N+1]),T(A[M+1][N]))}}function c(){for(let m=0;m<o.length;m+=6){const b=o[m+0],_=o[m+2],y=o[m+4],A=Math.max(b,_,y),T=Math.min(b,_,y);A>.9&&T<.1&&(b<.2&&(o[m+0]+=1),_<.2&&(o[m+2]+=1),y<.2&&(o[m+4]+=1))}}function d(m,b){const _=m*3;b.x=e[_+0],b.y=e[_+1],b.z=e[_+2]}function u(){const m=new B,b=new B,_=new B,y=new B,A=new Ue,T=new Ue,M=new Ue,C=(N,O,q,j)=>{j<0&&N.x===1&&(o[O]=N.x-1),q.x===0&&q.z===0&&(o[O]=j/2/Math.PI+.5)};for(let N=0,O=0;N<r.length;N+=9,O+=6){m.set(r[N+0],r[N+1],r[N+2]),b.set(r[N+3],r[N+4],r[N+5]),_.set(r[N+6],r[N+7],r[N+8]),A.set(o[O+0],o[O+1]),T.set(o[O+2],o[O+3]),M.set(o[O+4],o[O+5]),y.copyFrom(m).add(b).add(_).divideScalar(3);const q=h(y);C(A,O+0,m,q),C(T,O+2,b,q),C(M,O+4,_,q)}}const h=m=>Math.atan2(m.z,-m.x),f=m=>Math.atan2(-m.y,Math.sqrt(m.x*m.x+m.z*m.z));{const m=new B,b=new B,_=new B;for(let y=0;y<t.length;y+=3)d(t[y+0],m),d(t[y+1],b),d(t[y+2],_),l(m,b,_)}{const m=new B;for(let b=0;b<r.length;b+=3)m.x=r[b+0],m.y=r[b+1],m.z=r[b+2],m.normalize().multiplyScalar(i),r[b+0]=m.x,r[b+1]=m.y,r[b+2]=m.z}{const m=new B;for(let b=0;b<r.length;b+=3){m.x=r[b+0],m.y=r[b+1],m.z=r[b+2];const _=h(m)/2/Math.PI+.5,y=f(m)/Math.PI+.5;o.push(_,1-y)}u(),c()}const p=new Wi;return p.addAttribute("position",new St(new Float32Array(r),3)),p.addAttribute("normal",new St(new Float32Array(r.slice()),3)),p.addAttribute("uv0",new St(new Float32Array(o),2)),n===0?p.computeVertexNormals():p.normalizeNormals(),p}static createIcosahedron(e,t){const i=(1+Math.sqrt(5))/2,n=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],r=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];return dt.createPolyhedron(n,r,e,t)}}function q_(){const s=dt.createBox(2,2,2);return s.convertNormalsToSpherical(),s}function Y_(){const s=dt.createIcosahedron(1,2);return s.convertNormalsToSpherical(),s}var ul=(s=>(s.CUBE="cube",s.SPHERE="sphere",s))(ul||{});const Wo=new B,Pu=new xi,is=class is extends kt{constructor(t,i,n){super();a(this,"_enterCallbacks");a(this,"_exitCallbacks");a(this,"volumeType");a(this,"position");a(this,"rotation");a(this,"scale");a(this,"_inverse",new je);a(this,"_inverseCached",!1);a(this,"_inside",!1);a(this,"_cameraPosition");a(this,"_disposed",!1);this._enterCallbacks=t,this._exitCallbacks=i,this.volumeType=n.type,this.position=new B().fromArray(n.position),this.rotation=new mi().setFromDegTriple(n.rotation),this.scale=new B().fromArray(n.scale),this.onCameraPositionUpdated=this.onCameraPositionUpdated.bind(this)}onCameraPositionUpdated(t){this._cameraPosition=t.newPosition,this.onUpdated()}onUpdated(){if(this._disposed||(this.dispatchEvent({type:is.updatedEventType}),!this._cameraPosition))return;const t=this.isPointInside(this._cameraPosition);t!==this._inside&&(this._inside=t,t?this._enterCallbacks.forEach(i=>i()):this._exitCallbacks.forEach(i=>i()))}getVolumeGeometry(){return this.volumeType==="sphere"?is._sphereGeometry:is._boxGeometry}setPosition(t,i,n){this.position.set(t,i,n),this._inverseCached=!1,this.onUpdated()}setRotation(t,i,n){this.rotation.yaw=Vt(t),this.rotation.pitch=Vt(i),this.rotation.roll=Vt(n),this._inverseCached=!1,this.onUpdated()}setRotationDeg(t,i,n){const r=oi(t),o=oi(i),l=oi(n);this.setRotation(r,o,l)}setScale(t,i,n){this.scale.set(t,i,n),this._inverseCached=!1,this.onUpdated()}isPointInsideUnitSphere(t){return t.lengthSq()<=1}isPointInsideUnitCube(t){return Math.abs(Wo.x)<=1&&Math.abs(t.y)<=1&&Math.abs(t.z)<=1}isPointInside(t){return this._inverseCached||(this.rotation.toQuaternion(Pu),this._inverse.compose(this.position,Pu,this.scale),this._inverse.getInverse(this._inverse),this._inverseCached=!0),Wo.set(t.x,t.y,t.z),this._inverse.affineTransformPoint3(Wo),this.volumeType==="sphere"?this.isPointInsideUnitSphere(Wo):this.isPointInsideUnitCube(Wo)}dispose(){this._disposed=!0,this._inside&&this._exitCallbacks.forEach(t=>t()),this._inside=!1,this.dispatchEvent({type:is.disposedEventType})}reinstate(){this._disposed=!1,this.dispatchEvent({type:is.updatedEventType})}serialize(){return{type:this.volumeType,position:this.position.toArray(),rotation:this.rotation.toDegTriple(),scale:this.scale.toArray()}}};a(is,"updatedEventType","cameraVolumeTriggerUpdated"),a(is,"disposedEventType","cameraVolumeTriggerDisposed"),a(is,"_boxGeometry",q_()),a(is,"_sphereGeometry",Y_());let _n=is;const Q_="wireframe_vertex.glsl",K_="wireframe_fragment.glsl",Cu=100;class Z_{constructor(){a(this,"maxDistance",Cu)}}class ro extends ai{constructor(t,i=Cu,n,r=!0){super({vsName:Q_,fsName:K_,uniformBufferDataConstructor:Z_});a(this,"lineColor");a(this,"lineThickness");a(this,"_customizationFunc");const o=Nc();this.lineColor=t||o.lineColor,this.lineThickness=0,this.setUniform("lineColor","c",this.lineColor,ve.MATERIAL),this.setUniform("lineThickness","f",0,ve.MATERIAL),this.setUniform("backsideLineThickness","f",0,ve.MATERIAL),this.setUniform("maxDistance","f",i,ve.MATERIAL),this.condDefine(r,"USE_TRANSPARENT_WIREFRAME"),this.blending=Hi.NORMAL,this.depthTest=!0,this.depthWrite=!0,this.side=Gi.DOUBLE,this.transparent=r,this._customizationFunc=n,this.fillMaterialUniformDataFromUniforms()}uniformsNeedUpdate(t,i,n){return this.uniforms.lineThickness.value!==t||this.uniforms.lineColor.value!==i||this.uniforms.backsideLineThickness.value!==n}refreshPerObjectUniforms(t){let i=this.lineColor,n=this.lineThickness,r=this.lineThickness;if(this._customizationFunc){const l=this._customizationFunc(t);i=l.lineColor||i,n=l.lineThickness||n,r=l.backsideLineThickness||r}const o=this.uniformsNeedUpdate(n,i,r);return this.uniforms.lineThickness.value=n,this.uniforms.lineColor.value=i,this.uniforms.backsideLineThickness.value=r,o}}function Es(s){return!isNaN(s)&&isFinite(s)}function $_(s){return Object.prototype.toString.call(s)==="[object Array]"}function J_(s){return s?$_(s)!==!0?[s]:s:[]}function Qc(s,e){for(var t=0,i=s.length;t<i;t++)if(s[t]===e)return t;return-1}function Ru(s){s=s||{},this.nodeCount=0,this.INDEX_INSIDE_CROSS=-1,this.INDEX_OUTSIDE_OFFSET=2,this.INDEX_OUTSIDE_POS_X=Es(s.INDEX_OUTSIDE_POS_X)?s.INDEX_OUTSIDE_POS_X:0,this.INDEX_OUTSIDE_NEG_X=Es(s.INDEX_OUTSIDE_NEG_X)?s.INDEX_OUTSIDE_NEG_X:1,this.INDEX_OUTSIDE_POS_Y=Es(s.INDEX_OUTSIDE_POS_Y)?s.INDEX_OUTSIDE_POS_Y:2,this.INDEX_OUTSIDE_NEG_Y=Es(s.INDEX_OUTSIDE_NEG_Y)?s.INDEX_OUTSIDE_NEG_Y:3,this.INDEX_OUTSIDE_POS_Z=Es(s.INDEX_OUTSIDE_POS_Z)?s.INDEX_OUTSIDE_POS_Z:4,this.INDEX_OUTSIDE_NEG_Z=Es(s.INDEX_OUTSIDE_NEG_Z)?s.INDEX_OUTSIDE_NEG_Z:5,this.INDEX_OUTSIDE_MAP=[],this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_X]={index:this.INDEX_OUTSIDE_POS_X,count:0,x:1,y:0,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_X]={index:this.INDEX_OUTSIDE_NEG_X,count:0,x:-1,y:0,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_Y]={index:this.INDEX_OUTSIDE_POS_Y,count:0,x:0,y:1,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_Y]={index:this.INDEX_OUTSIDE_NEG_Y,count:0,x:0,y:-1,z:0},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_POS_Z]={index:this.INDEX_OUTSIDE_POS_Z,count:0,x:0,y:0,z:1},this.INDEX_OUTSIDE_MAP[this.INDEX_OUTSIDE_NEG_Z]={index:this.INDEX_OUTSIDE_NEG_Z,count:0,x:0,y:0,z:-1},this.FLAG_POS_X=1<<this.INDEX_OUTSIDE_POS_X+1,this.FLAG_NEG_X=1<<this.INDEX_OUTSIDE_NEG_X+1,this.FLAG_POS_Y=1<<this.INDEX_OUTSIDE_POS_Y+1,this.FLAG_NEG_Y=1<<this.INDEX_OUTSIDE_NEG_Y+1,this.FLAG_POS_Z=1<<this.INDEX_OUTSIDE_POS_Z+1,this.FLAG_NEG_Z=1<<this.INDEX_OUTSIDE_NEG_Z+1,this.utilVec31Search=new B,this.utilVec32Search=new B,this.scene=s.scene,this.scene&&(this.visualGeometry=dt.createBox(1,1,1),this.visualMaterial=new ro(new Color(65280))),this.depthMax=Es(s.depthMax)?s.depthMax:1/0,this.objectsThreshold=Es(s.objectsThreshold)?s.objectsThreshold:8,this.overlapPct=Es(s.overlapPct)?s.overlapPct:.15,this.root=new vn({tree:this,parent:null,position:new B})}Ru.prototype={add:function(s,e,t){e||(e=s.geometry.boundingSphere.center,t=s.geometry.boundingSphere.radius),t!==0&&this.root.addObject(new Iu(s,e,t))},search:function(s,e,t){var i,n,r,o,l=[];for(this.root.appendObjectsFromNode(l),e>0||(e=Number.MAX_VALUE),t instanceof B&&(t=this.utilVec31Search.copyFrom(t).normalize(),o=this.utilVec32Search.set(1,1,1).divide(t)),i=0,n=this.root.nodesIndices.length;i<n;i++)r=this.root.nodesByIndex[this.root.nodesIndices[i]],r.search(s,e,t,o,l);return l},setRoot:function(s){s instanceof vn&&(this.root=s,this.root.updateProperties())},getDepthEnd:function(){return this.root.getDepthEnd()},getNodeCountEnd:function(){return this.root.getNodeCountEnd()},getObjectCountEnd:function(){return this.root.getObjectCountEnd()},toConsole:function(){this.root.toConsole()}};function Iu(s,e,t){this.object=s,this.radius=t,this.position=e}var e0=new B,t0=new B;function vn(s){this.tree=s.tree,this.id=this.tree.nodeCount++,this.position=s.position,this.radius=s.radius>0?s.radius:1,this.indexOctant=s.indexOctant,this.depth=0,this.reset(),this.setParent(s.parent),this.overlap=this.radius*this.tree.overlapPct,this.radiusOverlap=this.radius+this.overlap,this.left=this.position.x-this.radiusOverlap,this.right=this.position.x+this.radiusOverlap,this.bottom=this.position.y-this.radiusOverlap,this.top=this.position.y+this.radiusOverlap,this.back=this.position.z-this.radiusOverlap,this.front=this.position.z+this.radiusOverlap,this.tree.scene&&(this.visual=new Je(this.tree.visualGeometry,this.tree.visualMaterial),this.visual.scale.set(this.radiusOverlap*2,this.radiusOverlap*2,this.radiusOverlap*2),this.visual.position.copyFrom(this.position),this.tree.scene.add(this.visual),this.tree.scene.updateMatrixWorld())}vn.prototype={setParent:function(s){s!==this&&this.parent!==s&&(this.parent=s,this.updateProperties())},updateProperties:function(){var s,e;for(this.parent instanceof vn?(this.tree=this.parent.tree,this.depth=this.parent.depth+1):this.depth=0,s=0,e=this.nodesIndices.length;s<e;s++)this.nodesByIndex[this.nodesIndices[s]].updateProperties()},reset:function(s,e){var t,i,n,r=this.nodesIndices||[],o=this.nodesByIndex;for(this.objects=[],this.nodesIndices=[],this.nodesByIndex={},t=0,i=r.length;t<i;t++)n=o[r[t]],n.setParent(void 0),s===!0&&n.reset(s,e);e===!0&&this.visual&&this.visual.parent&&this.visual.parent.remove(this.visual)},addNode:function(s,e){s.indexOctant=e,Qc(this.nodesIndices,e)===-1&&this.nodesIndices.push(e),this.nodesByIndex[e]=s,s.parent!==this&&s.setParent(this)},removeNode:function(s){var e,t;e=Qc(this.nodesIndices,s),this.nodesIndices.splice(e,1),t=t||this.nodesByIndex[s],delete this.nodesByIndex[s],t.parent===this&&t.setParent(void 0)},addObject:function(s){var e,t,i;t=this.getOctantIndex(s),t>-1&&this.nodesIndices.length>0?(i=this.branch(t),i.addObject(s)):t<-1&&this.parent instanceof vn?this.parent.addObject(s):(e=Qc(this.objects,s),e===-1&&this.objects.push(s),s.node=this,this.checkGrow())},addObjectWithoutCheck:function(s){var e,t,i;for(e=0,t=s.length;e<t;e++)i=s[e],this.objects.push(i),i.node=this},checkGrow:function(){this.objects.length>this.tree.objectsThreshold&&this.tree.objectsThreshold>0&&this.grow()},grow:function(){var s,e,t=[],i=[],n=[],r=[],o=[],l,c;for(l=0,c=this.objects.length;l<c;l++)e=this.objects[l],s=this.getOctantIndex(e),s>-1?(n.push(e),r.push(s)):s<-1?(t.push(e),i.push(s)):o.push(e);n.length>0&&(o=o.concat(this.split(n,r))),t.length>0&&(o=o.concat(this.expand(t,i))),this.objects=o,this.checkMerge()},split:function(s,e){var t,i,n,r,o,l;if(this.depth<this.tree.depthMax){for(s=s||this.objects,e=e||[],l=[],t=0,i=s.length;t<i;t++)r=s[t],n=e[t],n>-1?(o=this.branch(n),o.addObject(r)):l.push(r);s===this.objects&&(this.objects=l)}else l=this.objects;return l},branch:function(s){var e,t,i,n,r,o;return this.nodesByIndex[s]instanceof vn?e=this.nodesByIndex[s]:(i=this.radiusOverlap*.5,t=i*this.tree.overlapPct,n=i-t,r=e0.set(s&1?n:-n,s&2?n:-n,s&4?n:-n),o=new B().addVectors(this.position,r),e=new vn({tree:this.tree,parent:this,position:o,radius:i,indexOctant:s}),this.addNode(e,s)),e},expand:function(s,e){var t,i,n,r,o,l,c,d,u=this.tree.INDEX_OUTSIDE_MAP,h,f,p,m,b,_,y,A,T,M,C,N,O,q,j,K,de,xe,Ve,qe=t0,k,Q;if(this.tree.root.getDepthEnd()<this.tree.depthMax){for(s=s||this.objects,e=e||[],r=[],o=[],t=0,i=u.length;t<i;t++)u[t].count=0;for(t=0,i=s.length;t<i;t++)n=s[t],l=e[t],l<-1?(c=-l-this.tree.INDEX_OUTSIDE_OFFSET,c&this.tree.FLAG_POS_X?u[this.tree.INDEX_OUTSIDE_POS_X].count++:c&this.tree.FLAG_NEG_X&&u[this.tree.INDEX_OUTSIDE_NEG_X].count++,c&this.tree.FLAG_POS_Y?u[this.tree.INDEX_OUTSIDE_POS_Y].count++:c&this.tree.FLAG_NEG_Y&&u[this.tree.INDEX_OUTSIDE_NEG_Y].count++,c&this.tree.FLAG_POS_Z?u[this.tree.INDEX_OUTSIDE_POS_Z].count++:c&this.tree.FLAG_NEG_Z&&u[this.tree.INDEX_OUTSIDE_NEG_Z].count++,o.push(n)):r.push(n);if(o.length>0)for(h=u.slice(0),h.sort(function(le,ae){return ae.count-le.count}),f=h[0],b=f.index|1,y=h[1],A=h[2],p=(y.index|1)!==b?y:A,_=p.index|1,y=h[2],A=h[3],T=h[4],M=y.index|1,C=A.index|1,m=M!==b&&M!==_?y:C!==b&&C!==_?A:T,N=f.x+p.x+m.x,O=f.y+p.y+m.y,q=f.z+p.z+m.z,l=this.getOctantIndexFromPosition(N,O,q),d=this.getOctantIndexFromPosition(-N,-O,-q),j=this.overlap,K=this.radius,xe=this.tree.overlapPct>0?j/(.5*this.tree.overlapPct*(1+this.tree.overlapPct)):K*2,Ve=xe*this.tree.overlapPct,de=xe+Ve-(K+j),qe.set(l&1?de:-de,l&2?de:-de,l&4?de:-de),k=new B().addVectors(this.position,qe),Q=new vn({tree:this.tree,position:k,radius:xe}),Q.addNode(this,d),this.tree.setRoot(Q),t=0,i=o.length;t<i;t++)this.tree.root.addObject(o[t]);s===this.objects&&(this.objects=r)}else r=s;return r},shrink:function(){this.checkMerge(),this.tree.root.checkContract()},checkMerge:function(){for(var s=this,e;s.parent instanceof vn&&s.getObjectCountEnd()<this.tree.objectsThreshold;)e=s,s=s.parent;s!==this&&s.merge(e)},merge:function(s){var e,t,i;for(s=J_(s),e=0,t=s.length;e<t;e++)i=s[e],this.addObjectWithoutCheck(i.getObjectsEnd()),i.reset(!0,!0),this.removeNode(i.indexOctant,i);this.checkMerge()},checkContract:function(){var s,e,t,i,n,r,o;if(this.nodesIndices.length>0){for(r=0,o=this.objects.length,s=0,e=this.nodesIndices.length;s<e;s++)t=this.nodesByIndex[this.nodesIndices[s]],i=t.getObjectCountEnd(),o+=i,(!(n instanceof vn)||i>r)&&(n=t,r=i);o-=r,o<this.tree.objectsThreshold&&n instanceof vn&&this.contract(n)}},contract:function(s){var e,t,i;for(e=0,t=this.nodesIndices.length;e<t;e++)i=this.nodesByIndex[this.nodesIndices[e]],i!==s&&(s.addObjectWithoutCheck(i.getObjectsEnd()),i.reset(!0,!0));s.addObjectWithoutCheck(this.objects),this.reset(!1,!0),this.tree.setRoot(s),s.checkContract()},getOctantIndex:function(s){var e,t,i=this.position,n=this.radiusOverlap,r=this.overlap,o,l,c,d,u,h,f,p=0;if(s instanceof Iu?(t=s.radius,e=s.position):s instanceof vn&&(e=s.position,t=0),o=e.x-i.x,l=e.y-i.y,c=e.z-i.z,d=Math.abs(o),u=Math.abs(l),h=Math.abs(c),f=Math.max(d,u,h),f+t>n)return d+t>n&&(p=p^(o>0?this.tree.FLAG_POS_X:this.tree.FLAG_NEG_X)),u+t>n&&(p=p^(l>0?this.tree.FLAG_POS_Y:this.tree.FLAG_NEG_Y)),h+t>n&&(p=p^(c>0?this.tree.FLAG_POS_Z:this.tree.FLAG_NEG_Z)),s.indexOctant=-p-this.tree.INDEX_OUTSIDE_OFFSET,s.indexOctant;if(o-t>-r)p=p|1;else if(!(o+t<r))return s.indexOctant=this.tree.INDEX_INSIDE_CROSS,s.indexOctant;if(l-t>-r)p=p|2;else if(!(l+t<r))return s.indexOctant=this.tree.INDEX_INSIDE_CROSS,s.indexOctant;if(c-t>-r)p=p|4;else if(!(c+t<r))return s.indexOctant=this.tree.INDEX_INSIDE_CROSS,s.indexOctant;return s.indexOctant=p,s.indexOctant},getOctantIndexFromPosition:function(s,e,t){var i=0;return s>0&&(i=i|1),e>0&&(i=i|2),t>0&&(i=i|4),i},appendObjectsFromNode:function(s){var e,t,i=this.objects;for(e=0,t=i.length;e<t;e+=1)s.push(i[e].object)},search:function(s,e,t,i,n){var r,o,l,c;if(c=this.intersectRay(s,t,e,i),c===!0)for(this.appendObjectsFromNode(n),r=0,o=this.nodesIndices.length;r<o;r++)l=this.nodesByIndex[this.nodesIndices[r]],l.search(s,e,t,i,n)},intersectRay:function(s,e,t,i){var n=(this.left-s.x)*i.x,r=(this.right-s.x)*i.x,o=(this.bottom-s.y)*i.y,l=(this.top-s.y)*i.y,c=(this.back-s.z)*i.z,d=(this.front-s.z)*i.z,u=Math.min(Math.min(Math.max(n,r),Math.max(o,l)),Math.max(c,d)),h;return!(u<0||(h=Math.max(Math.max(Math.min(n,r),Math.min(o,l)),Math.min(c,d)),h>u||h>t))},getDepthEnd:function(s){var e,t,i;if(this.nodesIndices.length>0)for(e=0,t=this.nodesIndices.length;e<t;e++)i=this.nodesByIndex[this.nodesIndices[e]],s=i.getDepthEnd(s);else s=!s||this.depth>s?this.depth:s;return s},getNodeCountEnd:function(){return this.tree.root.getNodeCountRecursive()+1},getNodeCountRecursive:function(){var s,e,t=this.nodesIndices.length;for(s=0,e=this.nodesIndices.length;s<e;s++)t+=this.nodesByIndex[this.nodesIndices[s]].getNodeCountRecursive();return t},getObjectsEnd:function(s){var e,t,i;for(s=(s||[]).concat(this.objects),e=0,t=this.nodesIndices.length;e<t;e++)i=this.nodesByIndex[this.nodesIndices[e]],s=i.getObjectsEnd(s);return s},getObjectCountEnd:function(){var s,e,t=this.objects.length;for(s=0,e=this.nodesIndices.length;s<e;s++)t+=this.nodesByIndex[this.nodesIndices[s]].getObjectCountEnd();return t},getObjectCountStart:function(){for(var s=this.objects.length,e=this.parent;e instanceof vn;)s+=e.objects.length,e=e.parent;return s},toConsole:function(s){var e,t,i,n="   ";for(s=typeof s=="string"?s:n,console.log(this.parent?s+" octree NODE > ":" octree ROOT > ",this," // id: ",this.id," // indexOctant: ",this.indexOctant," // position: ",this.position.x,this.position.y,this.position.z," // radius: ",this.radius," // depth: ",this.depth),console.log(this.parent?s+" ":" ","+ objects ( ",this.objects.length," ) ",this.objects),console.log(this.parent?s+" ":" ","+ children ( ",this.nodesIndices.length," )",this.nodesIndices,this.nodesByIndex),e=0,t=this.nodesIndices.length;e<t;e++)i=this.nodesByIndex[this.nodesIndices[e]],i.toConsole(s+n)}};const i0="object_distance_vertex.glsl",n0="object_id_fragment.glsl",s0="object_id_distance_fragment.glsl";class Du extends ai{constructor(e){super({vsName:i0,fsName:e?n0:s0}),this.doNotOverrideSide=!0,this.uniforms={objectId:{type:"i",value:null,uniformSourceType:ve.OBJECT}}}refreshPerObjectUniforms(e){return this.uniforms.objectId.value=e.visibilityId,!0}}function ws(s){let e,t,i,n;this.set=function(r,o,l){console.assert(e===void 0&&t===void 0&&i===void 0&&n===void 0),e=s.autoClear,t=s.autoClearColor,i=s.autoClearDepth,n=s.autoClearStencil,s.autoClear=r||o||l,s.autoClearColor=r,s.autoClearDepth=o,s.autoClearStencil=l},this.restore=function(){console.assert(e!==void 0&&t!==void 0&&i!==void 0&&n!==void 0),s.autoClear=e,s.autoClearColor=t,s.autoClearDepth=i,s.autoClearStencil=n,e=void 0,t=void 0,i=void 0,n=void 0}}function fl(s){const e=new Re;let t=null,i=!1;this.set=function(n,r=void 0){console.assert(!i),i=!0,e.copyFrom(s.getClearColor()),t=s.getClearAlpha(),s.setClearColor(n,r)},this.restore=function(){console.assert(i),i=!1,s.setClearColor(e,t)}}function Ks(s,e,t){this.ray=new Rc(s,e),this.far=t||1/0,this.respectColliderSettings=!1,this.onlyGroundCollisions=!1,this.ignoreVisibility=!1}function Vn(){this.distance=1/0,this.point=new B,this.object=null}function Lu(s,e){const t=s.createRenderTarget(1,1,{magFilter:ne.NEAREST,minFilter:ne.NEAREST,stencilBuffer:!1,depthBuffer:!0,generateMipmaps:!1}),i=new Uint8Array(4),n=new ws(s),r=new fl(s),o=new Du(!1),l=new hs(1,1,e.near,e.far),c={disableCollisions:!1,ground:!1};function d(u,h){if(!h.ignoreVisibility&&!u.visible)return!1;const f=u.node||c;if(f.disableCollisions&&h.respectColliderSettings||!f.ground&&h.onlyGroundCollisions)return!1;const p=h.ray;if(u.matrixWorld)return!0;const m=u.geometry.boundingSphere;if(m.distanceToPoint(p.origin)>h.far||p.isIntersectionSphere(m)===!1)return!1;const b=u.geometry.boundingBox;return!(b.distanceToPoint(p.origin)>h.far||!p.isIntersectionBox(b))}this.closestIntersection=function(u,h,f){const p=[];for(let y=0;y<u.length;y+=1){const A=u[y];console.assert(A.visibilityId===null),d(A,h)&&(A.visibilityId=p.length,p.push(A))}if(p.length===0)return!1;l.position.set(0,0,0),l.lookAt(h.ray.direction),l.position.copyFrom(h.ray.origin),l.updateMatrixWorld(),n.set(!0,!0,!1),r.set(Re.WHITE);const m=s.sortObjects;s.sortObjects=!1,s.renderMeshes(p,o,l,t,!1,h.ignoreVisibility),s.sortObjects=m,r.restore(),n.restore(),s.readPixels(1,1,i),s.setRenderTarget(null);const b=i[0]*256+i[1],_=i[2]+i[3]/255;for(let y=0;y<p.length;y+=1)p[y].visibilityId=null;return b===65535||_>h.far?!1:(console.assert(b<p.length),f.object=p[b],f.distance=_,f.point.copyFrom(h.ray.direction).multiplyScalar(_).add(h.ray.origin),!0)}}const Fu=function(){const s=new B;return function(e,t,i){return s.copyFrom(e),s.sub(t).normalize(),s.multiplyScalar(i),e.sub(s)}}();function r0(s,e,t){const i=this,n=new Ru({scene:null,depthMax:1/0,objectsThreshold:8,overlapPct:.15}),r=t.cameraWorldPosition(),o=e.camera,l=[];this.addStaticObstacle=function(h,f,p){n.add(h,f,p)},this.addDynamicObstacle=function(h){l.push(h)},this.removeDynamicObstacle=function(h){zi(h,l)};const c=function(){const h=new Lu(s,o);return function(f,p){const m=n.search(f.ray.origin,f.far,f.ray.direction);for(let b=0;b<l.length;b+=1)m.push(l[b]);return!!h.closestIntersection(m,f,p)}}(),d=function(){const h=new Vn;return function(f){return c(f,h)?h.distance:1/0}}();this.distanceToGroundFrom=function(){const h=new Ks;return h.ray.direction.set(0,0,-1),h.respectColliderSettings=!0,h.onlyGroundCollisions=o.autoClimb,function(f,p){h.ray.origin.copyFrom(f),h.far=p;const m=d(h);return o.autoClimb||m>=1?m:1/0}}(),this.distanceToObstacle=function(){const h=new Ks;return h.respectColliderSettings=!0,h.onlyGroundCollisions=!1,function(f){return h.ray.direction.copyFrom(t.camera().getWorldDirection(new B)),h.ray.origin.copyFrom(r),h.far=f,d(h)}}(),this.distanceToGround=function(h){return this.distanceToGroundFrom(r,h)},this.findIntersectionBelow=function(){const h=new Ks;return h.ray.direction.set(0,0,-1),h.respectColliderSettings=!1,function(f,p,m){return h.ray.origin.copyFrom(f),h.far=p,c(h,m)}}(),this.distanceToCeilingFrom=function(){const h=new Ks;return h.ray.direction.set(0,0,1),h.respectColliderSettings=!0,function(f,p){return h.ray.origin.copyFrom(f),h.far=p,d(h)}}(),this.distanceToCeiling=function(h){return this.distanceToCeilingFrom(r,h)},this.cameraHeightFromPoint=function(h){const f=this.distanceToGroundFrom(h,D.MAX_GROUND_SEARCH_DEPTH);return f===1/0?null:f},this.adjustPointToMatchCameraHeight=function(h){const f=o.fixedHeight||D.CAMERA_FIXED_HEIGHT||t.cameraHeight;if(f===null)return!1;const p=this.distanceToGroundFrom(h,D.MAX_GROUND_SEARCH_DEPTH);if(p===1/0)return!1;const m=f-p;return Math.abs(m)<.01||m>0&&this.distanceToCeilingFrom(h,m+D.MIN_DISTANCE_TO_CEILING)!==1/0?!1:(h.z+=m,!0)};function u(h,f,p){if(t.camera().isOrthographic()){const m=t.camera().getCurrent(),b=t.camera().getWorldQuaternion(new xi),_=f*(m.right-m.left)/2,y=p*(m.top-m.bottom)/2,A=new B(_,y,0);b.applyToVector3(A),h.ray.origin=r.clone().add(A),h.ray.direction.copyFrom(t.camera().getWorldDirection(new B))}else h.ray.origin=r.clone(),t.camera().getCurrent().unprojectVector(h.ray.direction.set(f,p,1)),h.ray.direction.sub(r).normalize()}this.findIntersectionAtPosition=function(){const h=new Ks(r);return function(f,p,m,b){return u(h,f,p),h.respectColliderSettings=m,c(h,b)}}(),this.findObstacleMeshAtPosition=function(){const h=new Vn;return function(f,p,m){return this.findIntersectionAtPosition(f,p,m,h)?h.object:null}}(),this.findMeshFromListAtPosition=function(){const h=new Ks(r),f=new Vn,p=new Lu(s,o);return function(m,b,_,y,A){h.ignoreVisibility=y===void 0?!1:y;const T=A===void 0?f:A;return u(h,b,_),p.closestIntersection(m,h,T)?T.object:null}}(),this.clickedPointToMoveTarget=function(){const h=new Ks;h.respectColliderSettings=!0;const f=h.ray.origin,p=h.ray.direction,m=new Vn,b=new B;function _(A,T){const M=A.x-T.x,C=A.y-T.y;return Math.sqrt(M*M+C*C)}function y(A){const T=_(f,b);if(h.far=T+D.CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE,p.x=b.x-f.x,p.y=b.y-f.y,!(Math.abs(p.x)<.01&&Math.abs(p.y)<.01))if(p.z=0,p.normalize(),c(h,m)){let M=m.distance-D.CLICK_MOVE_MIN_DISTANCE_TO_OBSTACLE;M>0&&(A.x=f.x+p.x*M,A.y=f.y+p.y*M,A.z=f.z);const C=.01;if(M=Math.min(m.distance-C,T),f.x+=p.x*M,f.y+=p.y*M,i.adjustPointToMatchCameraHeight(f))return y(A)}else A.x=b.x,A.y=b.y,A.z=f.z}return function(A){f.copyFrom(r),b.copyFrom(A),A.copyFrom(r),y(A),i.adjustPointToMatchCameraHeight(A)}}(),this.movePointTowardsTheCamera=function(h,f){return Fu(h,r,f)},this.handleCollisions=function(){const h=new Ks(r),f=h.ray.direction,p=new Pc,m=new B;let b=0;h.respectColliderSettings=!0,h.far=5,console.assert(h.far>D.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE);function _(A,T){const M=p.start.distanceTo(A),C=p.end.distanceTo(A);return b-.02<M+C&&M+C<b+.02&&C>=T}function y(A){if(t.applyCameraYaw(f),f.normalize(),_(r,A)&&m.equals(f))return!1;let T=d(h);return T===1/0&&(T=h.far),m.copyFrom(f),p.start.copyFrom(r),p.end.copyFrom(f).multiplyScalar(T).add(r),b=p.distance(),T<A}return function(A){const T=t.maxFrameMoveLinearDistance(A)+D.KEY_MOVE_MIN_DISTANCE_TO_OBSTACLE;t.movesForward()&&(f.set(0,1,0),y(T)&&t.stopForward()),t.movesBackward()&&(f.set(0,-1,0),y(T)&&t.stopBackward()),t.movesLeft()&&(f.set(-1,0,0),y(T)&&t.stopLeft()),t.movesRight()&&(f.set(1,0,0),y(T)&&t.stopRight()),t.movesDown()&&(f.set(0,0,-1),y(T)&&t.stopDown()),t.movesUp()&&(f.set(0,0,1),y(T)&&t.stopUp())}}()}class o0{constructor(e,t,i){a(this,"_vrManager");a(this,"_animateCallback");a(this,"_animateIdleCallback");a(this,"_clock",new Xg);a(this,"_inAnimateCallback",!1);a(this,"_frameRequested",!1);a(this,"_callIdleCallback",!1);a(this,"_idleFrameCnt",0);a(this,"_enabled",!1);this._vrManager=e,this._animateCallback=t,this._animateIdleCallback=i}_animateVR(){this._animate(this._vrManager.vrEnabled())}_animateWindow(){this._animate(!1)}_doRequestFrame(){this._frameRequested||(this._inAnimateCallback||this._clock.getDelta(),this._frameRequested=!0,this._vrManager.vrEnabled()?this._vrManager.requestAnimationFrame(this._animateVR.bind(this)):requestAnimationFrame(this._animateWindow.bind(this)))}_animate(e){this._enabled&&(this._frameRequested=!1,this._callIdleCallback?(tt(!e),this._animateIdleCallback(this._clock.getDelta(),this._idleFrameCnt)?(this._idleFrameCnt+=1,this._doRequestFrame()):this._callIdleCallback=!1):(this._inAnimateCallback=!0,this._animateCallback(this._clock.getDelta(),e),D.ALWAYS_RENDER&&this.requestFrame(),this._inAnimateCallback=!1,this._frameRequested||(this._callIdleCallback=!0,this._idleFrameCnt=0,this._doRequestFrame())))}requestFrame(){this._enabled&&(this._callIdleCallback=!1,this._doRequestFrame())}disable(){this._enabled=!1}enable(){this._enabled=!0,this._frameRequested=!1,this.requestFrame()}isEnabled(){return this._enabled}}const Mo=class Mo extends kt{constructor(t){super();a(this,"_teleport");a(this,"_running");a(this,"_maxTeleportToViewTime");a(this,"_switchToView",()=>{this._running&&this._teleport.switchToNextVisibleView(this._maxTeleportToViewTime)});a(this,"_onTeleportDone",()=>{this._running&&setTimeout(this._switchToView,D.AUTO_TOUR_IN_VIEW_STILL_TIME_MS)});this._teleport=t,this._running=!1,this._maxTeleportToViewTime=4,this._teleport.addEventListener("teleportDone",this._onTeleportDone)}isRunning(){return this._running}start(){console.assert(!this._running),this._running=!0,this.dispatchEvent(Mo.tourStartedEvent),this._switchToView()}stop(){console.assert(this._running),this._running=!1,this._teleport.switchToView(this._teleport.lastDestinationView,0),this.dispatchEvent(Mo.tourStoppedEvent)}};a(Mo,"tourStartedEvent",{type:"tourStarted"}),a(Mo,"tourStoppedEvent",{type:"tourStopped"});let Kc=Mo;const Zc=.2,Ou=.011,$c=.011,a0=.047;function l0(){const s=new si;return s.baseColor.setRGB(.298,.619,.851),s.highlight=new Re(.033,.125,.445),s.reflective=!1,s.lightmapSupported=!1,s.setUniforms(),s}function c0(s){const e=dt.createCylinder(.05,.05,$c,32),t=dt.createCylinder(.05,.03,Ou,32,1,!1),i=dt.createCylinder(0,.05,Zc,32,1,!0),n=new je;n.makeRotationX(Math.PI/2),e.applyMatrix(n),e.convertNormalsToSpherical();const r=new Je(e,s);r.position.z+=$c/2,n.makeTranslation(0,-(Zc/2+Ou/2),0),t.applyMatrix(n),t.convertNormalsToSpherical();const o=new Je(t,s);i.convertNormalsToSpherical();const l=new Je(i,s);l.add(o),l.rotateX(-Math.PI/2),l.position.z=$c+a0+Zc/2;const c=new _t;return c.add(r),c.add(l),c}class h0{constructor(e){a(this,"_scene");a(this,"_targetMaterial",l0());a(this,"_targetObject",c0(this._targetMaterial));a(this,"_baseMesh",this._targetObject.children[0]);a(this,"_visible",!1);a(this,"_highlightChangeSign",1);this._scene=e}hide(){this._visible&&(this._scene.removeAuxiliaryObject(this._targetObject),this._visible=!1)}isVisible(){return this._visible}showTargetAtPosition(e,t,i,n){this._visible||(this._scene.addAuxiliaryObject(this._targetObject),this._visible=!0),this._baseMesh.visible=n,this._targetObject.position.set(e,t,i),this._targetObject.updateMatrixWorld()}update(e){this._targetMaterial.highlightMix+=e*this._highlightChangeSign,this._targetMaterial.highlightMix>=1&&(this._targetMaterial.highlightMix=1,this._highlightChangeSign=-1),this._targetMaterial.highlightMix<=0&&(this._targetMaterial.highlightMix=0,this._highlightChangeSign=1)}}class d0{constructor(e,t,i,n){a(this,"_collider");a(this,"_controls");a(this,"_teleport");a(this,"_targetIndicator");a(this,"_intersection",new Vn);a(this,"_cancelTeleport");a(this,"_cancelTeleportInPointerLock");this._collider=t,this._controls=i,this._teleport=n,this._targetIndicator=new h0(e),this._teleport.addEventListener("teleportDone",()=>this._targetIndicator.hide()),this._cancelTeleport=()=>{this._teleport.teleportingToPoint&&this._teleport.cancelSwitchToPoint()},this._cancelTeleportInPointerLock=()=>{!this._controls.mousePressLook&&this._teleport.teleportingToPoint&&this._teleport.cancelSwitchToPoint()},this._init()}onMeshClicked(e,t){if(this._shouldIgnoreClick())return;this._collider.clickedPointToMoveTarget(t);const i=t.x,n=t.y;let r=t.z,o=!1;if(this._collider.findIntersectionBelow(t,4,this._intersection)){r=this._intersection.point.z;const l=this._intersection.object.geometry.boundingBox;l&&r>l.max.z-.01&&(o=!0)}else r-=this._controls.cameraHeight||1.6;D.CLICK_MOVE_SHOW_TARGET_INDICATOR&&this._targetIndicator.showTargetAtPosition(i,n,r,o),this._teleport.switchToPoint(t)}update(e){this._targetIndicator.isVisible()&&this._targetIndicator.update(e)}dispose(){document.removeEventListener("keydown",this._cancelTeleport,!1),document.removeEventListener("mousedown",this._cancelTeleport,!1),document.removeEventListener("mousemove",this._cancelTeleportInPointerLock,!1),document.removeEventListener("touchstart",this._cancelTeleport,!1),document.removeEventListener("wheel",this._cancelTeleport,!1)}_shouldIgnoreClick(){return this._controls.isOrbitEnabled()||this._controls.isHandlingGesture()||this._controls.camera().moveMaxSpeed===0}_init(){document.addEventListener("keydown",this._cancelTeleport,!1),document.addEventListener("mousedown",this._cancelTeleport,!1),document.addEventListener("mousemove",this._cancelTeleportInPointerLock,!1),document.addEventListener("touchstart",this._cancelTeleport,!1),document.addEventListener("wheel",this._cancelTeleport,!1)}}const Be={TRIGGER:0,BACKWARD:1,FORWARD:2,LEFT:3,RIGHT:4,DOWN:5,UP:6,PREVIOUS:7,NEXT:8},Bu=.7,Jc=-1,u0=0,f0=1,p0=[{gamepadIdPattern:/^Spatial Controller \(Spatial Interaction Source\).*$/,axisMapping:new Map([[2,[Be.PREVIOUS,Be.NEXT]],[3,[Be.UP,Be.DOWN]],[0,[Be.LEFT,Be.RIGHT]],[1,[Be.FORWARD,Be.BACKWARD]]]),buttonMapping:new Map([[1,Be.TRIGGER]])},{gamepadIdPattern:/Oculus Touch \(Left\)/,axisMapping:new Map([[0,[Be.LEFT,Be.RIGHT]],[1,[Be.FORWARD,Be.BACKWARD]]]),buttonMapping:new Map([[1,Be.TRIGGER],[3,Be.DOWN],[4,Be.UP]])},{gamepadIdPattern:/Oculus Touch \(Right\)/,axisMapping:new Map([[0,[Be.LEFT,Be.RIGHT]],[1,[Be.FORWARD,Be.BACKWARD]]]),buttonMapping:new Map([[1,Be.TRIGGER],[3,Be.NEXT],[4,Be.PREVIOUS]])},{gamepadIdPattern:/OpenVR (Gamepad|Controller)/,axisMapping:new Map([[0,[Be.PREVIOUS,Be.NEXT]],[1,[Be.DOWN,Be.UP]]]),buttonMapping:new Map([[1,Be.TRIGGER]])},{gamepadIdPattern:/.*/,gamepadLayoutMappingId:"standard",axisMapping:new Map([[0,[Be.LEFT,Be.RIGHT]],[1,[Be.FORWARD,Be.BACKWARD]],[2,[Be.LEFT,Be.RIGHT]],[3,[Be.FORWARD,Be.BACKWARD]]]),buttonMapping:new Map([[0,Be.DOWN],[1,Be.NEXT],[2,Be.PREVIOUS],[3,Be.UP],[4,Be.TRIGGER],[5,Be.TRIGGER]])},{gamepadIdPattern:/.*/,axisMapping:new Map([[0,[Be.PREVIOUS,Be.NEXT]],[1,[Be.UP,Be.DOWN]]]),buttonMapping:new Map([[0,Be.TRIGGER],[1,Be.TRIGGER],[2,Be.TRIGGER],[3,Be.TRIGGER]])}],m0={axisMapping:new Map([[2,[Be.LEFT,Be.RIGHT]],[3,[Be.FORWARD,Be.BACKWARD]]]),buttonMapping:new Map([[0,Be.TRIGGER],[4,Be.DOWN],[5,Be.UP]])},Nu={axisMapping:new Map([[2,[Be.LEFT,Be.RIGHT]],[3,[Be.FORWARD,Be.BACKWARD]]]),buttonMapping:new Map([[0,Be.TRIGGER],[4,Be.NEXT],[5,Be.PREVIOUS]])};function ku(s){return s<=-Bu?u0:s>=Bu?f0:Jc}function g0(s,e){return e.gamepadIdPattern.test(s.id)?e.gamepadLayoutMappingId!==void 0?s.mapping===e.gamepadLayoutMappingId:!0:!1}function _0(s,e){if(s.mapping==="xr-standard"){const t=s.hand?s.hand:e;return t==="left"?m0:Nu}for(let t of p0)if(g0(s,t))return t;return console.error("No matching action mapping for gamepad found",s.id),null}const eh=function(s,e){const t=_0(s,e);this.axisMapping=t.axisMapping,this.buttonMapping=t.buttonMapping,this.axisPosition=s.axes.map(ku),this.buttonPressed=s.buttons.map(i=>i.pressed)};function Uu(){const s=new Map,e=new Map,t=new Set,i=new Set,n={type:"actionActivated",action:null},r={type:"actionDeactivated",action:null};this.hasGamepads=function(){return s.size>0||e.size>0},this.update=function(){if(!this.hasGamepads())return;t.clear(),i.clear();function d(h,f){for(let p=0;p<f.axes.length;++p){const m=ku(f.axes[p]),b=h.axisPosition[p];if(m!==b){const _=h.axisMapping.get(p);_!==void 0&&(b!==Jc&&i.add(_[b]),m!==Jc&&t.add(_[m]))}h.axisPosition[p]=m}for(let p=0;p<f.buttons.length;++p){const m=f.buttons[p].pressed,b=h.buttonPressed[p];if(m!==b){const _=h.buttonMapping.get(p);_!==void 0&&(b?i.add(_):t.add(_))}h.buttonPressed[p]=m}}const u=navigator.getGamepads?navigator.getGamepads():[];for(let h of u){if(!h)continue;const f=s.get(h.index);d(f,h)}for(let[h,f]of e)d(f,h);for(let h of i)r.action=h,this.dispatchEvent(r);for(let h of t)n.action=h,this.dispatchEvent(n)};function o(d){const u=d.gamepad,h=new eh(d.gamepad);s.set(u.index,h)}function l(d){s.delete(d.gamepad.index)}this.addXrGamepad=function(d,u){const h=new eh(d,u);e.set(d,h)},this.removeXrGamepad=function(d){e.delete(d)},this.removeAllXrGamepads=function(){e.clear()};function c(){if(navigator.getGamepads){window.addEventListener("gamepadconnected",o),window.addEventListener("gamepaddisconnected",l);for(let d of navigator.getGamepads())if(d){const u=new eh(d);s.set(d.index,u)}}}c()}kt.prototype.apply(Uu.prototype);class oo{constructor(e,t,i,n){a(this,"collider");a(this,"target",new B);a(this,"noZoom",!1);a(this,"mouseZoomToPointer",!0);a(this,"mouseZoomSpeed",.97);a(this,"keyZoomSpeed",.7);a(this,"minZoom",0);a(this,"maxZoom",1/0);a(this,"noRotate",!1);a(this,"noPitchRotate",!1);a(this,"mouseRotateSpeed",2*Math.PI);a(this,"keyYawRotateSpeed",D.CAMERA_ARROWS_TURN_SPEED);a(this,"keyPitchRotateSpeed",D.CAMERA_ARROWS_TURN_SPEED/2);a(this,"autoRotate",!1);a(this,"autoRotateSpeed",2);a(this,"keyPanSpeed",.25);a(this,"primaryMouseButton",0);a(this,"secondaryMouseButton",2);a(this,"mouseButtons",{ROTATE:this.primaryMouseButton,ZOOM:1,PAN:this.secondaryMouseButton});a(this,"getMinPitchAngle",()=>-Math.PI/2);a(this,"getMaxPitchAngle",()=>Math.PI/2);a(this,"getMinYawAngle",()=>-Math.PI);a(this,"getMaxYawAngle",()=>Math.PI);a(this,"getMinDistance",()=>0);a(this,"getMaxDistance",()=>1/0);a(this,"getNoPan",()=>!1);a(this,"getAutoRotateAngle",()=>2*Math.PI/60/60*this.autoRotateSpeed);a(this,"_camera");a(this,"_controls");a(this,"_domElement");a(this,"_animationController");a(this,"_enabled",!1);a(this,"_rayIntersection",new Vn);a(this,"_rotateStart",new Ue);a(this,"_rotateEnd",new Ue);a(this,"_rotateDelta",new Ue);a(this,"_panStart",new Ue);a(this,"_panEnd",new Ue);a(this,"_panDelta",new Ue);a(this,"_panOffset",new B);a(this,"_dollyStart",new Ue);a(this,"_dollyEnd",new Ue);a(this,"_dollyDelta",new Ue);a(this,"_dollyTarget",new B);a(this,"_cameraToTarget",new B);a(this,"_dollyTargetOffset",new B);a(this,"_yawDelta",0);a(this,"_pitchDelta",0);a(this,"_scale",1);a(this,"_panVector",new B);a(this,"_panPrimary",!1);a(this,"_keyDollyDir",0);a(this,"_keyYawRotateDir",0);a(this,"_keyPitchRotateDir",0);a(this,"_keyHorizontalPanDir",0);a(this,"_keyVerticalPanDir",0);a(this,"_state",-1);a(this,"_cancelMouseDown");a(this,"_onMouseMove",e=>{if(!this._enabled)return;e.preventDefault();const t=this._domElement instanceof Document?this._domElement.body:this._domElement;if(this._state===0){if(this.noRotate===!0)return;this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateLeft(this._rotateDelta.x/t.clientWidth*this.mouseRotateSpeed),this.noPitchRotate===!1&&this._rotateUp(this._rotateDelta.y/t.clientHeight*this.mouseRotateSpeed),this._rotateStart.copyFrom(this._rotateEnd)}else if(this._state===1){if(this.noZoom===!0)return;this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyIn():this._dollyDelta.y<0&&this._dollyOut(),this._dollyStart.copyFrom(this._dollyEnd)}else if(this._state===2){if(this.getNoPan()===!0)return;this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart),this.pan(this._panDelta.x/t.clientHeight,this._panDelta.y/t.clientWidth),this._panStart.copyFrom(this._panEnd)}this._state!==-1&&this._update()});a(this,"_onMouseUp",e=>{this._enabled&&this._cancelMouseDown&&(this._cancelMouseDown(),this._cancelMouseDown=void 0)});a(this,"_onMouseDown",e=>{if(!this._enabled)return;if((this._domElement instanceof Document?this._domElement.body:this._domElement).focus(),e.preventDefault(),e.button===this.mouseButtons.ROTATE){if(this.noRotate===!0)return;this._state=0,this._rotateStart.set(e.clientX,e.clientY)}else if(e.button===this.mouseButtons.ZOOM){if(this.noZoom===!0)return;this._state=1,this._dollyStart.set(e.clientX,e.clientY),this._updateDollyTarget(e.clientX,e.clientY)}else if(e.button===this.mouseButtons.PAN){if(this.getNoPan()===!0)return;this._state=2,this._panStart.set(e.clientX,e.clientY)}this._state!==-1&&(document.addEventListener("mousemove",this._onMouseMove,!1),document.addEventListener("mouseup",this._onMouseUp,!1),this._cancelMouseDown=()=>{document.removeEventListener("mousemove",this._onMouseMove,!1),document.removeEventListener("mouseup",this._onMouseUp,!1),this._state=-1})});a(this,"_onMouseWheel",e=>{if(!this._enabled||this.noZoom||this._state!==-1)return;e.preventDefault();const t=-e.deltaY;this._updateDollyTarget(e.clientX,e.clientY),t>0?this._dollyOut():t<0&&this._dollyIn(),this._update()});a(this,"_touchStart",e=>{if(!this._enabled)return;const t=e.touches.length;if(e.preventDefault(),this._touchPanEvent(e.touches))this._state=5,this._panStart.set(e.touches[0].clientX,e.touches[0].clientY);else if(this._touchRotateEvent(t))this._state=3,this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY);else if(this._touchZoomEvent(t)){this._state=4;const i=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY,r=Math.sqrt(i*i+n*n);this._dollyStart.set(0,r);const o=e.touches[0].clientX-i/2,l=e.touches[0].clientY-n/2;this._updateDollyTarget(o,l)}else this._state=-1});a(this,"_touchMove",e=>{if(!this._enabled)return;const t=e.touches.length;e.preventDefault();const i=this._domElement instanceof Document?this._domElement.body:this._domElement;if(this._touchPanEvent(e.touches)&&this._state===5)this._panEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._panDelta.subVectors(this._panEnd,this._panStart),this.pan(this._panDelta.x/i.clientHeight,this._panDelta.y/i.clientWidth),this._panStart.copyFrom(this._panEnd),this._update();else if(this._touchRotateEvent(t)&&this._state===3)this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),this._rotateLeft(this._rotateDelta.x/i.clientWidth*this.mouseRotateSpeed),this._rotateUp(this._rotateDelta.y/i.clientHeight*this.mouseRotateSpeed),this._rotateStart.copyFrom(this._rotateEnd),this._update();else if(this._touchZoomEvent(t)&&this._state===4){const n=e.touches[0].clientX-e.touches[1].clientX,r=e.touches[0].clientY-e.touches[1].clientY,o=Math.sqrt(n*n+r*r);this._dollyEnd.set(0,o),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut():this._dollyDelta.y<0&&this._dollyIn(),this._dollyStart.copyFrom(this._dollyEnd),this._update()}else this._state=-1});a(this,"_touchEnd",e=>{this._enabled&&(this._state=-1)});a(this,"_onKeyDown",e=>{au(e)||this._onKey(e,!0)});a(this,"_onKeyUp",e=>{this._onKey(e,!1)});a(this,"_onFocusLost",e=>{this._stopAll()});this._camera=e,this._controls=t,this._domElement=i,this._animationController=n,this._domElement.addEventListener("mousedown",this._onMouseDown,!1),this._domElement.addEventListener("wheel",this._onMouseWheel,!1),this._domElement.addEventListener("touchstart",this._touchStart,!1),this._domElement.addEventListener("touchend",this._touchEnd,!1),this._domElement.addEventListener("touchmove",this._touchMove,!1),this._domElement.addEventListener("blur",this._onFocusLost,!1),this._domElement.addEventListener("keydown",this._onKeyDown,!1),this._domElement.addEventListener("keyup",this._onKeyUp,!1),!this._camera.isPerspective()&&!this._camera.isOrthographic()&&console.warn("WARNING: OrbitControls.js requires perspective or orthographic camers")}_determineDollyTarget(e,t){if(this.collider&&this.mouseZoomToPointer){const i=e/window.innerWidth*2-1,n=-(t/window.innerHeight)*2+1;if(this.collider.findIntersectionAtPosition(i,n,!0,this._rayIntersection)){this._dollyTarget.copyFrom(this._rayIntersection.point);return}}this._dollyTarget.copyFrom(this.target)}_updateDollyTarget(e,t){this.getNoPan()?this._dollyTarget.copyFrom(this.target):this._determineDollyTarget(e,t)}_updateDirection(e,t,i){return i===!0?t:e===t?0:e}_update(){let e=this._controls.getYawAngle(),t=this._controls.getPitchAngle();const i=this._controls.cameraWorldPosition();this.autoRotate&&this._state===-1&&this._rotateLeft(this.getAutoRotateAngle());const n=this.getMinYawAngle();let r=this.getMaxYawAngle();Math.abs(r-n)>=2*Math.PI-1e-6?e+=this._yawDelta:n===r?e=n:(n>r&&(r+=2*Math.PI,e<n&&(e+=2*Math.PI)),this._yawDelta<0?e=Math.min(Math.max(e+this._yawDelta,n),r):e=Math.max(Math.min(e+this._yawDelta,r),n)),t=Pi(t+this._pitchDelta,this.getMinPitchAngle(),this.getMaxPitchAngle()),this._cameraToTarget.copyFrom(this.target).sub(i);const o=this._cameraToTarget.length(),l=Pi(o*this._scale,this.getMinDistance(),this.getMaxDistance()),c=l/o;this._dollyTargetOffset.copyFrom(this._dollyTarget).sub(this.target).multiplyScalar(1-c),this.target.add(this._dollyTargetOffset),this.target.add(this._panVector),oo.computeCameraPosition(i,this.target,e,t,l),this._controls.cameraPositionUpdated(),this._controls.setYawAngle(e),this._controls.setPitchAngle(t);const d=oo.computeCameraNear(l);Math.abs(d-this._camera.near)>1e-6&&(this._camera.near=d,this._camera.updateProjectionMatrix()),this._yawDelta=0,this._pitchDelta=0,this._scale=1,this._panVector.set(0,0,0),this._animationController.requestFrame()}_stopAll(){this._keyDollyDir=0,this._keyYawRotateDir=this._keyPitchRotateDir=0,this._keyHorizontalPanDir=this._keyVerticalPanDir=0,this._cancelMouseDown&&(this._cancelMouseDown(),this._cancelMouseDown=void 0)}enable(){this._enabled=!0,this._update()}disable(){this._enabled=!1,this._stopAll()}isEnabled(){return this._enabled}setPanPrimary(e){this._panPrimary=e,this._panPrimary?(this.mouseButtons.PAN=this.primaryMouseButton,this.mouseButtons.ROTATE=this.secondaryMouseButton):(this.mouseButtons.ROTATE=this.primaryMouseButton,this.mouseButtons.PAN=this.secondaryMouseButton)}getCameraDistance(){const e=new B;return e.copyFrom(this._controls.cameraWorldPosition()).sub(this.target),e.length()}_rotateLeft(e){e===void 0&&(e=this.getAutoRotateAngle()),this._yawDelta-=e}_rotateUp(e){e===void 0&&(e=this.getAutoRotateAngle()),this._pitchDelta-=e}_panLeft(e){const t=this._camera.matrixWorld.elements;this._panOffset.set(t[0],t[1],t[2]),this._panOffset.multiplyScalar(-e),this._panVector.add(this._panOffset)}_panUp(e){const t=this._camera.matrixWorld.elements;this._panOffset.set(t[4],t[5],t[6]),this._panOffset.multiplyScalar(e),this._panVector.add(this._panOffset)}pan(e,t){if(this._camera.isPerspective()){let r=this._controls.cameraWorldPosition().clone().sub(this.target).length();r*=Math.tan(this._camera.fov/2*Math.PI/180),this._panLeft(2*e*r),this._panUp(2*t*r)}else this._camera.isOrthographic()&&(this._panLeft(e*(this._camera.right-this._camera.left)),this._panUp(t*(this._camera.top-this._camera.bottom)))}_dollyIn(e){e===void 0&&(e=this.mouseZoomSpeed),this._camera.isPerspective()?this._scale/=e:this._camera.isOrthographic()&&(this._camera.orthoFrustumSize/=e,this._camera.updateProjectionMatrix())}_dollyOut(e){e===void 0&&(e=this.mouseZoomSpeed),this._camera.isPerspective()?this._scale*=e:this._camera.isOrthographic()&&(this._camera.orthoFrustumSize*=e,this._camera.updateProjectionMatrix())}update(e){if(!this._enabled||!e)return;let t=!1;if(this._keyYawRotateDir!==0&&(this._rotateLeft(this._keyYawRotateDir*this.keyYawRotateSpeed*e),t=!0),this._keyPitchRotateDir!==0&&(this._rotateUp(this._keyPitchRotateDir*this.keyPitchRotateSpeed*e),t=!0),(this._keyHorizontalPanDir!==0||this._keyVerticalPanDir!==0)&&(this.pan(this._keyHorizontalPanDir*this.keyPanSpeed*e,this._keyVerticalPanDir*this.keyPanSpeed*e),t=!0),this._keyDollyDir!==0){const i=Math.pow(this.keyZoomSpeed,e);this._keyDollyDir===-1?this._dollyIn(i):this._dollyOut(i),t=!0}t&&this._update()}_upKey(e){return["w","ArrowUp"].includes(e.key)}_downKey(e){return["s","ArrowDown"].includes(e.key)}_leftKey(e){return["a","ArrowLeft"].includes(e.key)}_rightKey(e){return["d","ArrowRight"].includes(e.key)}_onKey(e,t){if(this._enabled===!1)return;let i=!1;if(this._panPrimary&&!this.getNoPan()?(i=!0,this._upKey(e)?this._keyVerticalPanDir=this._updateDirection(this._keyVerticalPanDir,1,t):this._downKey(e)?this._keyVerticalPanDir=this._updateDirection(this._keyVerticalPanDir,-1,t):this._leftKey(e)?this._keyHorizontalPanDir=this._updateDirection(this._keyHorizontalPanDir,1,t):this._rightKey(e)?this._keyHorizontalPanDir=this._updateDirection(this._keyHorizontalPanDir,-1,t):i=!1):!this._panPrimary&&!this.noRotate&&(i=!0,this._upKey(e)&&!this.noPitchRotate?this._keyPitchRotateDir=this._updateDirection(this._keyPitchRotateDir,1,t):this._downKey(e)&&!this.noPitchRotate?this._keyPitchRotateDir=this._updateDirection(this._keyPitchRotateDir,-1,t):this._leftKey(e)?this._keyYawRotateDir=this._updateDirection(this._keyYawRotateDir,1,t):this._rightKey(e)?this._keyYawRotateDir=this._updateDirection(this._keyYawRotateDir,-1,t):i=!1),!this.noZoom){let n;["=","+","e"].includes(e.key)?n=1:["-","q"].includes(e.key)&&(n=-1),n!==void 0&&(this._keyDollyDir=this._updateDirection(this._keyDollyDir,n,t),i=!0)}i&&(e.preventDefault(),this._animationController.requestFrame())}_touchPanEvent(e){return this.getNoPan()?!1:this._panPrimary&&e.length===1?!0:!this._panPrimary&&e.length===2?Math.abs(e[0].clientY-e[1].clientY)<=D.MAX_TWO_POINTERS_IN_LINE_DIFF:!1}_touchRotateEvent(e){return!this.noRotate&&!this._panPrimary&&e===1}_touchZoomEvent(e){return!this.noZoom&&e===2}static computeCameraPosition(e,t,i,n,r){const o=new B,l=i-Math.PI/2,c=n+Math.PI/2;o.x=r*Math.sin(c)*Math.cos(l),o.y=r*Math.sin(c)*Math.sin(l),o.z=r*Math.cos(c),e.copyFrom(t).add(o)}static computeCameraNear(e){return e*D.CAMERA_ORBIT_NEAR_FROM_1M}}var th=(s=>(s.WALK="fps",s.ORBIT="orbit",s))(th||{});const v0=10,b0=10,zu=100,Vu=.5,y0=Math.PI/12;class pl{constructor(e){a(this,"activeDirection",0);a(this,"activeSource",0);a(this,"speed",0);a(this,"_maxPerFrameDistance");this._maxPerFrameDistance=e}moves(){return this.activeDirection!==0||this.speed!==0}movesInDirection(e){return this.activeDirection===e||Math.sign(this.speed)===e}activateDirectionFromSource(e,t){this.activeDirection=e,this.activeSource=t}deactivateDirectionFromSource(e,t){this.activeDirection===e&&this.activeSource===t&&(this.activeDirection=0,this.activeSource=t)}deactivateSource(e){this.activeSource===e&&(this.activeDirection=0,this.activeSource=0)}stopInDirection(e){this.activeDirection===e&&(this.activeDirection=0,this.activeSource=0),Math.sign(this.speed)===e&&(this.speed=0)}update(e,t){if(!this.moves())return 0;const i=Math.sign(this.speed),n=this.activeDirection||-i;let r;i===n?r=e/D.CAMERA_FULL_ACCELERATION_TIME:r=e/D.CAMERA_FULL_DECELERATION_TIME;const o=t*n*r,l=t*(this.speed+o/2);return this.speed=Pi(this.speed+o,-e,e),!this.activeDirection&&Math.sign(this.speed)!==i&&(this.speed=0),Pi(l,-this._maxPerFrameDistance,this._maxPerFrameDistance)}}class x0{constructor(e,t,i,n){a(this,"_camera");a(this,"_domElement");a(this,"_gamepadManager");a(this,"_animationController");a(this,"_enabled",!0);a(this,"_controlMode","fps");a(this,"_moveMaxSpeedFactor",1);a(this,"_moveX",new pl(D.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));a(this,"_moveY",new pl(D.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));a(this,"_moveZ",new pl(D.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE));a(this,"_rotationYaw",new pl(y0));a(this,"_pointers",[new Ue(0,0),new Ue(0,0)]);a(this,"_prevPointers",[new Ue(0,0),new Ue(0,0)]);a(this,"_scrollDelta",0);a(this,"_gesture",null);a(this,"_gestureStartPointers",[new Ue(0,0),new Ue(0,0)]);a(this,"_lastPinchTime",0);a(this,"_lastTwoPointerDragTime",0);a(this,"_mousePressed",!1);a(this,"_rollObject",new _t);a(this,"_pitchObject",new _t);a(this,"_yawObject",new _t);a(this,"_hmdResetSinceUpdate",!1);a(this,"_mouseRotation",new B(0,0,0));a(this,"_hmdRotation",new mi(0,0,0,Un.XYZ));a(this,"_previousMouseRotation",new Ue);a(this,"_currentMouseRotation",new Ue);a(this,"_targetMouseRotation",new Ue);a(this,"mousePressLook",!1);a(this,"flipMouseLook",!1);a(this,"mouseControlsPitch",!0);a(this,"restrictVerticalAngle",!0);a(this,"verticalAngleMin",-Math.PI/2);a(this,"verticalAngleMax",Math.PI/3);a(this,"arrowsTurn",!0);a(this,"orbit");a(this,"cameraHeight",null);a(this,"cameraPositionUpdated");a(this,"onHmdUpdate");a(this,"_onPointerMove",e=>{if(this._isEnabled()){if(e.preventDefault(),this._savePointerPositions(e),this._gesture!==null){if(this._gesture===3||this._gesture===0&&!this._recognizeGesture())return;if(this._gesture===1){const t=this._prevPointers[1].distanceTo(this._prevPointers[0]),n=this._pointers[1].distanceTo(this._pointers[0])-t;Math.abs(n)>0&&(this._lastPinchTime=Date.now(),this._moveY.activateDirectionFromSource(Math.sign(n),2)),this._animationController.requestFrame()}else if(this._gesture===2&&this._arePointersInHorizontalLine(this._pointers)){const t=this._pointers[0].y-this._prevPointers[0].y;Math.abs(t)>0&&(this._lastTwoPointerDragTime=Date.now(),this._moveZ.activateDirectionFromSource(Math.sign(t),2)),this._animationController.requestFrame()}}else if(this._mouseLookEnabled()||this._isTouchLook(e)){const t=this._mouseMovementX(e),i=this._mouseMovementY(e),n=this.flipMouseLook||this._isTouchLook(e)?1:-1;this._targetMouseRotation.x+=n*t*D.CAMERA_LOOK_SPEED,this.mouseControlsPitch&&(this._targetMouseRotation.y+=n*i*D.CAMERA_LOOK_SPEED),this._animationController.requestFrame()}}});a(this,"_onMouseDown",e=>{this._isEnabled()&&(this._domElement.focus(),e.preventDefault(),this._savePointerPositions(e),this._mousePressed=!0,this._animationController.requestFrame())});a(this,"_onTouchStart",e=>{this._isEnabled()&&(e.preventDefault(),this._savePointerPositions(e),e.touches.length===2?(this._gesture=0,this._gestureStartPointers[0].copyFrom(this._pointers[0]),this._gestureStartPointers[1].copyFrom(this._pointers[1])):e.touches.length>2&&(this._gesture=3))});a(this,"_onMouseUp",e=>{this._isEnabled()&&(e.preventDefault(),this._mousePressed=!1)});a(this,"_onTouchEnd",e=>{this._isEnabled()&&(e.preventDefault(),e.touches.length===0?this._gesture=null:this._gesture=3)});a(this,"_onMouseWheel",e=>{if(!this._isEnabled()||!this._hasFocus())return;e.preventDefault();const t=-e.deltaY/100;this._scrollDelta+=t*D.CAMERA_SCROLL_SPEED,this._scrollDelta=Pi(this._scrollDelta,-Vu,Vu),this._animationController.requestFrame()});a(this,"_onKeyDown",e=>{let t=!0;if(!(!this._isEnabled()||au(e))){switch(this._setMoveMaxSpeedFactor(e.shiftKey),e.code){case"ArrowUp":case"Space":case"KeyW":this._moveY.activateDirectionFromSource(1,1);break;case"ArrowLeft":this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(1,1):this._moveX.activateDirectionFromSource(-1,1);break;case"KeyA":this._moveX.activateDirectionFromSource(-1,1);break;case"ArrowDown":case"KeyS":this._moveY.activateDirectionFromSource(-1,1);break;case"ArrowRight":this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(-1,1):this._moveX.activateDirectionFromSource(1,1);break;case"KeyD":this._moveX.activateDirectionFromSource(1,1);break;case"PageUp":case"KeyE":this._moveZ.activateDirectionFromSource(1,1);break;case"PageDown":case"KeyQ":this._moveZ.activateDirectionFromSource(-1,1);break;default:t=!1;break}t&&(e.preventDefault(),this._animationController.requestFrame())}});a(this,"_onKeyUp",e=>{let t=!0;if(this._isEnabled()){switch(this._setMoveMaxSpeedFactor(e.shiftKey),e.code){case"ArrowUp":case"Space":case"KeyW":this._moveY.deactivateDirectionFromSource(1,1);break;case"ArrowLeft":case"KeyA":this._rotationYaw.deactivateDirectionFromSource(1,1),this._moveX.deactivateDirectionFromSource(-1,1);break;case"ArrowDown":case"KeyS":this._moveY.deactivateDirectionFromSource(-1,1);break;case"ArrowRight":case"KeyD":this._rotationYaw.deactivateDirectionFromSource(-1,1),this._moveX.deactivateDirectionFromSource(1,1);break;case"PageUp":case"KeyE":this._moveZ.deactivateDirectionFromSource(1,1);break;case"PageDown":case"KeyQ":this._moveZ.deactivateDirectionFromSource(-1,1);break;default:t=!1;break}t&&e.preventDefault()}});a(this,"_onGamepadActionActivated",e=>{if(this._isEnabled())switch(e.action){case Be.BACKWARD:this._moveY.activateDirectionFromSource(-1,3);break;case Be.FORWARD:this._moveY.activateDirectionFromSource(1,3);break;case Be.LEFT:this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(1,3):this._moveX.activateDirectionFromSource(-1,3);break;case Be.RIGHT:this.arrowsTurn?this._rotationYaw.activateDirectionFromSource(-1,3):this._moveX.activateDirectionFromSource(1,3);break;case Be.DOWN:this._moveZ.activateDirectionFromSource(-1,3);break;case Be.UP:this._moveZ.activateDirectionFromSource(1,3);break}});a(this,"_onGamepadActionDeactivated",e=>{if(this._isEnabled())switch(e.action){case Be.BACKWARD:this._moveY.deactivateDirectionFromSource(-1,3);break;case Be.FORWARD:this._moveY.deactivateDirectionFromSource(1,3);break;case Be.LEFT:this._moveX.deactivateDirectionFromSource(-1,3),this._rotationYaw.deactivateDirectionFromSource(1,3);break;case Be.RIGHT:this._moveX.deactivateDirectionFromSource(1,3),this._rotationYaw.deactivateDirectionFromSource(-1,3);break;case Be.DOWN:this._moveZ.deactivateDirectionFromSource(-1,3);break;case Be.UP:this._moveZ.deactivateDirectionFromSource(1,3);break}});a(this,"_onMouseOut",e=>{this._onMouseUp(e)});a(this,"_onMouseEnter",e=>{e.buttons>0&&this._onMouseDown(e)});a(this,"_onFocusLost",e=>{this._stopAll()});a(this,"_disableContextMenu",e=>{e.preventDefault()});this._camera=e,this._domElement=t,this._gamepadManager=i,this._animationController=n,this._rollObject.add(this._camera),this._pitchObject.add(this._rollObject),this._yawObject.add(this._pitchObject),this.orbit=new oo(this._camera,this,this._domElement,this._animationController),this._camera.rotation.set(0,0,0),this._camera.up.set(0,0,1),this._camera.lookAt(new B(0,1,0)),this._registerEventListeners(),this.cameraPositionUpdated=(()=>{const r={type:"positionChanged"},o={type:"rotationChanged"},l=new B,c=new mi;return()=>{this._yawObject.updateMatrixWorld(!0);const d=this._yawObject.position,u=this._yawObject.rotation;r.newPosition=d,l.equals(d)||(l.copyFrom(d),this._camera.dispatchEvent(r)),o.newRotation=u,c.equals(u)||(c.copyFrom(u),this._camera.dispatchEvent(o))}})(),this.onHmdUpdate=(()=>{const r=new B,o=new B,l=new B,c=new B,d=new B;return(u,h)=>{this._isEnabled()&&(this._hmdRotation.copyFrom(u),this._hmdResetSinceUpdate?this._mouseRotation.z-=this._hmdRotation.z:h&&(c.subVectors(h,l),r.set(Math.cos(this._mouseRotation.z),Math.sin(this._mouseRotation.z),0),o.set(-Math.sin(this._mouseRotation.z),Math.cos(this._mouseRotation.z),0),d.copyFrom(r.multiplyScalar(c.x)),d.add(o.multiplyScalar(c.y)),d.z=c.z,this._yawObject.position.add(d)),h&&l.copyFrom(h),this._hmdResetSinceUpdate=!1,this._updateRotation())}})()}isFpsEnabled(){return this._enabled}setControlMode(e){this._controlMode=e,e==="fps"?(this._enabled=!0,this._mousePressed=!1,this.orbit.disable()):(this._enabled=!1,this.orbit.enable())}isOrbitEnabled(){return this.orbit.isEnabled()}orbitModeEnable(){this._enabled=!1,this.orbit.enable()}camera(){return this._camera}applyCameraYaw(e){this._yawObject.rotation.applyToVector3(e)}cameraWorldPosition(){return this._yawObject.position}_updateYaw(){this._yawObject.rotation.z=Vt(this._hmdRotation.z+this._mouseRotation.z)}_updateRotation(){this._updateYaw(),this._pitchObject.rotation.x=Vt(this._hmdRotation.x+this._mouseRotation.x),this._rollObject.rotation.y=this._hmdRotation.y,this._yawObject.updateMatrixWorld(!0)}resetRollAngle(){this._rollObject.rotation.y!==0&&(this._hmdRotation.y=0,this._updateRotation())}getPitchAngle(){return this._pitchObject.rotation.x}setPitchAngle(e){e!==this._pitchObject.rotation.x&&(this._mouseRotation.x=e,this._hmdRotation.x=0,this._updateRotation())}resetPitchAngle(){this.setPitchAngle(0)}getYawAngle(){return this._yawObject.rotation.z}setYawAngle(e){e!==this._yawObject.rotation.z&&(this._mouseRotation.z=e,this._hmdRotation.z=0,this._updateRotation())}resetYawAngle(){this.setYawAngle(0)}isHandlingGesture(){return this._gesture!==null}_mouseLookEnabled(){return!this.mousePressLook||this._mousePressed}_isTouchLook(e){return!this._gesture&&xs(e)}_arePointersInHorizontalLine(e){return Math.abs(e[0].y-e[1].y)<=D.MAX_TWO_POINTERS_IN_LINE_DIFF}_recognizeGesture(){const e=this._gestureStartPointers[0].distanceTo(this._gestureStartPointers[1]),t=this._pointers[0].distanceTo(this._pointers[1]);return Math.abs(t-e)>=v0?(this._gesture=1,!0):this._arePointersInHorizontalLine(this._pointers)&&this._arePointersInHorizontalLine(this._gestureStartPointers)&&Math.abs(this._pointers[0].y-this._gestureStartPointers[0].y)>=b0?(this._gesture=2,!0):!1}_savePointerPositions(e){this._prevPointers[0].copyFrom(this._pointers[0]),this._prevPointers[1].copyFrom(this._pointers[1]),xs(e)?(this._pointers[0].set(e.touches[0].clientX,e.touches[0].clientY),e.touches.length===2?this._pointers[1].set(e.touches[1].clientX,e.touches[1].clientY):this._pointers[1].set(0,0)):(this._pointers[0].set(e.clientX,e.clientY),this._pointers[1].set(0,0))}_restrictVerticalAngle(e){e.x>this.verticalAngleMax?e.x=this.verticalAngleMax:e.x<this.verticalAngleMin&&(e.x=this.verticalAngleMin)}_mouseRotationNeedsUpdate(){return this._currentMouseRotation.distanceTo(this._targetMouseRotation)>1e-4}_updateMouseRotation(e){if(!this._mouseRotationNeedsUpdate()){this._previousMouseRotation.set(0,0),this._currentMouseRotation.set(0,0),this._targetMouseRotation.set(0,0);return}const t=Math.min(e/D.CAMERA_LOOK_SMOOTHING,1);this._currentMouseRotation.lerp(this._targetMouseRotation,t),this._mouseRotation.z+=this._currentMouseRotation.x-this._previousMouseRotation.x,this._mouseRotation.x+=this._currentMouseRotation.y-this._previousMouseRotation.y,this.restrictVerticalAngle&&this._restrictVerticalAngle(this._mouseRotation),this._updateRotation(),this._previousMouseRotation.copyFrom(this._currentMouseRotation),this._animationController.requestFrame()}_mouseMovementX(e){let t=xs(e)?void 0:e.movementX;return t===void 0&&(t=this._pointers[0].x-this._prevPointers[0].x),t}_mouseMovementY(e){let t=xs(e)?void 0:e.movementY;return t===void 0&&(t=this._pointers[0].y-this._prevPointers[0].y),t}_isEnabled(){let e=this._enabled;return D.DEBUG_UI&&Uo.isCapturingInput()&&(e=!1),e}hmdReset(){this._hmdResetSinceUpdate=!0,this.resetPitchAngle()}_hasFocus(){return document.hasFocus!==void 0?document.hasFocus():document.activeElement===this._domElement}_setMoveMaxSpeedFactor(e){e?this._moveMaxSpeedFactor=D.CAMERA_MOVE_MAX_SPEED_SHIFT_FACTOR:this._moveMaxSpeedFactor=1}_moveMaxSpeed(){return this._camera.moveMaxSpeed*this._moveMaxSpeedFactor}maxFrameMoveLinearDistance(e){return Math.min(e*this._moveMaxSpeed(),D.CAMERA_MAX_PER_FRAME_LINEAR_DISTANCE)}movesForward(){return this._moveY.movesInDirection(1)||this._scrollDelta>0}stopForward(){this._scrollDelta>0&&(this._scrollDelta=0),this._moveY.stopInDirection(1)}movesBackward(){return this._moveY.movesInDirection(-1)||this._scrollDelta<0}stopBackward(){this._scrollDelta<0&&(this._scrollDelta=0),this._moveY.stopInDirection(-1)}movesLeft(){return this._moveX.movesInDirection(-1)}stopLeft(){this._moveX.stopInDirection(-1)}movesRight(){return this._moveX.movesInDirection(1)}stopRight(){this._moveX.stopInDirection(1)}movesUp(){return this._moveZ.movesInDirection(1)}stopUp(){this._moveZ.stopInDirection(1)}movesDown(){return this._moveZ.movesInDirection(-1)}stopDown(){this._moveZ.stopInDirection(-1)}_stopTurnLeft(){this._rotationYaw.stopInDirection(1)}_stopTurnRight(){this._rotationYaw.stopInDirection(-1)}enable(){this._controlMode==="fps"?(this._enabled=!0,this._mousePressed=!1):this.orbit.enable()}_moves(){return this._moveX.moves()||this._moveY.moves()||this._moveZ.moves()||this._rotationYaw.moves()||this._scrollDelta!==0}_stopAll(){this.stopForward(),this.stopBackward(),this.stopLeft(),this.stopRight(),this.stopUp(),this.stopDown(),this._stopTurnLeft(),this._stopTurnRight()}_updateScroll(e,t){let i=0;if(t)return this._scrollDelta=0,t;if(this._scrollDelta){const n=this.maxFrameMoveLinearDistance(e);i=Pi(this._scrollDelta,-n,n),this._scrollDelta-=i}return i}disable(){this._controlMode==="fps"?this._enabled=!1:this.orbit.disable(),this._stopAll()}update(e){if(this._controlMode==="orbit"){this.orbit.update(e);return}this._updateMouseRotation(e),this._moveY.activeSource===2&&Date.now()-this._lastPinchTime>zu&&this._moveY.deactivateSource(2),this._moveZ.activeSource===2&&Date.now()-this._lastTwoPointerDragTime>zu&&this._moveZ.deactivateSource(2);const t=this._moveX.update(this._moveMaxSpeed(),e);let i=this._moveY.update(this._moveMaxSpeed(),e);const n=this._moveZ.update(this._moveMaxSpeed(),e);i=this._updateScroll(e,i),this._yawObject.translateX(t),this._yawObject.translateY(i),this._yawObject.translateZ(n);const r=this._rotationYaw.update(D.CAMERA_ARROWS_TURN_SPEED,e);this._mouseRotation.z+=r,this._updateYaw(),this._moves()&&this._animationController.requestFrame(),this.cameraPositionUpdated()}_registerEventListeners(){this._domElement.setAttribute("tabindex",-1),this._domElement.addEventListener("contextmenu",this._disableContextMenu,!1),this._domElement.addEventListener("mousedown",this._onMouseDown,!1),this._domElement.addEventListener("touchstart",this._onTouchStart,!1),this._domElement.addEventListener("mousemove",this._onPointerMove,!1),this._domElement.addEventListener("touchmove",this._onPointerMove,!1),this._domElement.addEventListener("mouseup",this._onMouseUp,!1),this._domElement.addEventListener("touchend",this._onTouchEnd,!1),this._domElement.addEventListener("keydown",this._onKeyDown,!1),this._domElement.addEventListener("keyup",this._onKeyUp,!1),this._domElement.addEventListener("mouseout",this._onMouseOut,!1),this._domElement.addEventListener("mouseenter",this._onMouseEnter,!1),this._domElement.addEventListener("wheel",this._onMouseWheel,!1),this._domElement.addEventListener("blur",this._onFocusLost,!1),this._gamepadManager.addEventListener("actionActivated",this._onGamepadActionActivated),this._gamepadManager.addEventListener("actionDeactivated",this._onGamepadActionDeactivated)}isEnabled(){return this._controlMode==="fps"?this._enabled:this.orbit.isEnabled()}}/*!
 * Copyright (C) 2020-present Shapespark
 */const Po=class Po extends kt{constructor(){super();a(this,"modeEnabled");this.modeEnabled=!1}enableMode(){this.modeEnabled=!0,this.dispatchEvent({type:Po.modeEnabledEventType})}disableMode(){this.modeEnabled=!1,this.dispatchEvent({type:Po.modeDisabledEventType})}modeIsEnabled(){return this.modeEnabled}};a(Po,"modeDisabledEventType","modeDisabled"),a(Po,"modeEnabledEventType","modeEnabled");let Ss=Po;class A0{constructor(){a(this,"circleSpan",0)}}class E0 extends ai{constructor(){super({vsName:"gaze_pointer_vertex.glsl",fsName:"gaze_pointer_fragment.glsl",uniformBufferDataConstructor:A0}),this.blending=Hi.NORMAL,this.transparent=!0,this.transparentRenderOrder=2,this.setUniform("circleSpan","f",0,ve.MATERIAL)}set circleSpan(e){console.assert(e<=1);const t=2*Math.PI*e-Math.PI;this.uniforms.circleSpan.value=t,this.uniformBufferData.circleSpan=t}}/*!
 * Copyright (C) 2017-present Shapespark
 */console.assert(D.GAZE_POINTER_SHOW_LOADING_AFTER_S<=D.GAZE_POINTER_ACTIVATE_AFTER_S);const Gu=Math.PI/60;function w0(){const s=new Wi,e=new Float32Array(2*3*3);return s.addAttribute("position",new St(e,3)),e[0]=.05,e[1]=-.05,e[2]=-2,e[3]=.05,e[4]=.05,e[5]=-2,e[6]=-.05,e[7]=-.05,e[8]=-2,e[9]=.05,e[10]=.05,e[11]=-2,e[12]=-.05,e[13]=.05,e[14]=-2,e[15]=-.05,e[16]=-.05,e[17]=-2,s.computeBoundingSphere(),s}class S0{constructor(e,t,i,n){a(this,"_scene");a(this,"_controls");a(this,"_requestFrame");a(this,"_gazePointerEnabled");a(this,"_startPitch");a(this,"_startYaw");a(this,"_gazeTime");a(this,"_gazeStarted");a(this,"_pointer");a(this,"_handleGazeStart");a(this,"_handleGazeEnd");a(this,"update",e=>{var n,r;if(!this._gazePointerEnabled)return;const t=this._controls.getPitchAngle(),i=this._controls.getYawAngle();if(this._startPitch===void 0)this._startPitch=t,this._startYaw=i;else if(Math.abs(this._startPitch-t)>Gu||Math.abs(this._startYaw-i)>Gu)this._resetUnconditionally();else{if(this._gazeTime,this._gazeTime+=e,this._gazeTime<D.GAZE_POINTER_SHOW_LOADING_AFTER_S)return;if(!this._gazeStarted)(n=this._handleGazeStart)!=null&&n.call(this)?this._gazeStarted=!0:this._resetUnconditionally();else{this._pointer;const o=D.GAZE_POINTER_ACTIVATE_AFTER_S-D.GAZE_POINTER_SHOW_LOADING_AFTER_S;this._pointer.setCircleSpan(Math.min((this._gazeTime-D.GAZE_POINTER_SHOW_LOADING_AFTER_S)/o,1)),this._gazeTime>=D.GAZE_POINTER_ACTIVATE_AFTER_S&&((r=this._handleGazeEnd)==null||r.call(this),this._resetUnconditionally())}}});this._scene=e,this._controls=t,this._requestFrame=i,this._gazePointerEnabled=n.modeIsEnabled(),n.addEventListener(Ss.modeDisabledEventType,()=>{this._gazePointerEnabled=!1,this._reevaluateState()}),n.addEventListener(Ss.modeEnabledEventType,()=>{this._gazePointerEnabled=!0,this._reevaluateState()}),this._reevaluateState()}setGazeHandlers(e,t){this._handleGazeStart=e,this._handleGazeEnd=t}_resetUnconditionally(){var e;this._startPitch=this._startYaw=void 0,this._gazeTime=0,this._gazeStarted=!1,(e=this._pointer)==null||e.setCircleSpan(0)}_reevaluateState(){var e;if(!this._gazePointerEnabled)this._resetUnconditionally();else if(!this._pointer){const t=new E0,i=new Je(w0(),t);this._scene.addAuxiliaryObject(i),i.frustumCulled=!1,i.matrixWorld=this._controls.camera().matrixWorld,this._pointer={setVisible:n=>{i.visible=n,this._requestFrame()},setCircleSpan:n=>{t.circleSpan=n,this._requestFrame()}},this._resetUnconditionally()}(e=this._pointer)==null||e.setVisible(this._gazePointerEnabled)}reset(){this._startPitch!==void 0&&this._resetUnconditionally()}}/*!
 * Copyright (C) 2018-present Shapespark
 */class T0{constructor(e,t){a(this,"_scene");a(this,"_teleport");a(this,"_hashChanged",()=>{const e=D.urlHashGetArgument("view");if(e){const t=this._scene.findViewByName(e);t&&(this._teleport.switchToView(t),window.location.hash=D.urlHashRemoveArgument("view"))}});this._scene=e,this._teleport=t,window.addEventListener("hashchange",this._hashChanged,!1)}dispose(){window.removeEventListener("hashchange",this._hashChanged,!1)}}const Hu=.03,M0=500;class ml{constructor(e,t){a(this,"callbacks");a(this,"_pointerEventDispatcher");a(this,"_priority");a(this,"_isPotentialClick");a(this,"_pointerDownClip");a(this,"_lastClickClip");a(this,"_lastClickTime");a(this,"_enabled");a(this,"_onPointerDown",(e,t)=>{var n,r;const i=(r=(n=this.callbacks).onPointerDown)==null?void 0:r.call(n,e,t);return this._isPotentialClick=!0,this._pointerDownClip=[e,t],i});a(this,"_onPointerUp",(e,t,i)=>{var l,c,d,u;let n=(c=(l=this.callbacks).onPointerUp)==null?void 0:c.call(l,e,t);if(!this._isPotentialClick)return n;const r=Date.now();return this._lastClickTime!==void 0&&this._isWithinMaxClickMoveDiff(this._pointerDownClip,this._lastClickClip)&&this._isWithinMaxDoubleClickBreak(this._lastClickTime,r)&&this.callbacks.onDoubleClick?n=this.callbacks.onDoubleClick(e,t)||n:n=((u=(d=this.callbacks).onClick)==null?void 0:u.call(d,e,t,i))||n,this._lastClickTime=r,this._lastClickClip=[e,t],n});a(this,"_onPointerMove",(e,t)=>{var n,r;const i=(r=(n=this.callbacks).onPointerMove)==null?void 0:r.call(n,e,t);return this._isPotentialClick&&!this._isWithinMaxClickMoveDiff(this._pointerDownClip,[e,t])&&(this._isPotentialClick=!1,this._lastClickTime=void 0),i});this._pointerEventDispatcher=e,this._priority=t,this._isPotentialClick=!1,this._pointerDownClip=void 0,this._lastClickClip=void 0,this._lastClickTime=void 0,this._enabled=!1,this.callbacks={onClick:void 0,onDoubleClick:void 0,onPointerDown:void 0,onPointerUp:void 0,onPointerMove:void 0},this.enable()}_isWithinMaxClickMoveDiff(e,t){return Math.abs(e[0]-t[0])<=Hu&&Math.abs(e[1]-t[1])<=Hu}_isWithinMaxDoubleClickBreak(e,t){return Math.abs(e-t)<=M0}_registerEventListeners(){this._pointerEventDispatcher.addPointerDownListener(this._onPointerDown,this._priority),this._pointerEventDispatcher.addPointerUpListener(this._onPointerUp,this._priority),this._pointerEventDispatcher.addPointerMoveListener(this._onPointerMove,this._priority)}_unregisterEventListeners(){this._pointerEventDispatcher.removePointerDownListener(this._onPointerDown),this._pointerEventDispatcher.removePointerUpListener(this._onPointerUp),this._pointerEventDispatcher.removePointerMoveListener(this._onPointerMove)}isEnabled(){return this._enabled}enable(){this._enabled||(this._registerEventListeners(),this._enabled=!0)}disable(){this._enabled&&(this._unregisterEventListeners(),this._enabled=!1)}}class P0{constructor(e,t,i,n,r,o,l,c){a(this,"_collider");a(this,"_requestFrame");a(this,"_clickListeners");a(this,"_doubleClickListeners");a(this,"_hoverListeners");a(this,"_gamepadManager");a(this,"_gazePointer");a(this,"_gazeTargetIntersection");a(this,"_hoveredMesh");a(this,"_enabled");a(this,"_lastClipX");a(this,"_lastClipY");a(this,"_helper");a(this,"_callbacks");a(this,"_clickIntersection");a(this,"onGamepadActionActivated",e=>{this._gazePointer&&this._gazePointer.reset(),e.action===Be.TRIGGER&&this.handleClick(0,0,!1)});this._collider=t,this._requestFrame=i,this._clickListeners=n,this._doubleClickListeners=r,this._hoverListeners=o,this._gamepadManager=l,this._gazePointer=c,this._gazeTargetIntersection=new Vn,this._hoveredMesh=void 0,this._enabled=!1,this._lastClipX=void 0,this._lastClipY=void 0,this._gazePointer&&this._gazePointer.setGazeHandlers(()=>this.handleGazeStart(),()=>this.handleGazeEnd()),this._helper=new ml(e,D.POINTER_PRIORITY.INTERACTION_DISPATCHER),this._callbacks=this._helper.callbacks,this._clickIntersection=new Vn,this._callbacks.onPointerMove=(d,u)=>(console.assert(this._enabled),this._hoverListeners.length!==0&&(this._lastClipX=d,this._lastClipY=u,this._requestFrame()),!1),this._callbacks.onClick=(d,u)=>this.handleClick(d,u,!1),this._callbacks.onDoubleClick=(d,u)=>this.handleClick(d,u,!0),this._gamepadManager.addEventListener("actionActivated",this.onGamepadActionActivated),this.enable()}dispatchClick(e,t){const i=e?this._doubleClickListeners:this._clickListeners;for(const n of i)if(n(t.object,t.point,t.distance))return!0;return!1}handleGazeStart(){return this._collider.findIntersectionAtPosition(0,0,!0,this._gazeTargetIntersection)}handleGazeEnd(){this.dispatchClick(!1,this._gazeTargetIntersection)}handleClick(e,t,i){return this._gazePointer&&this._gazePointer.reset(),this._collider.findIntersectionAtPosition(e,t,!0,this._clickIntersection)?this.dispatchClick(i,this._clickIntersection):!1}invokeHoverListeners(e,t){for(const i of this._hoverListeners)if(i(e,t))break}handleHover(){if(!this._enabled||this._hoverListeners.length===0)return;const e=this._collider.findObstacleMeshAtPosition(this._lastClipX,this._lastClipY,!0);if(e===null){this._hoveredMesh&&(this.invokeHoverListeners(this._hoveredMesh,!1),this._hoveredMesh=void 0);return}e!==this._hoveredMesh&&(this._hoveredMesh&&this.invokeHoverListeners(this._hoveredMesh,!1),this.invokeHoverListeners(e,!0),this._hoveredMesh=e)}enable(){this._enabled=!0,this._helper.enable(),console.assert(this._hoveredMesh===void 0)}disable(){this._enabled=!1,this._hoveredMesh!==void 0&&(this.invokeHoverListeners(this._hoveredMesh,!1),this._hoveredMesh=void 0),this._helper.disable()}dispose(){this.disable(),this._gamepadManager.removeEventListener("actionActivated",this.onGamepadActionActivated)}}function C0(s){return s&1}function R0(s){return s&2}function I0(s){return s&4}class D0{constructor(e,t){a(this,"_domElement");a(this,"_editMode");a(this,"_pointerDownListeners",new Array);a(this,"_pointerUpListeners",new Array);a(this,"_pointerMoveListeners",new Array);a(this,"_isPointerDown",!1);a(this,"_firstTouchIdentifier",-1);a(this,"_tmpClip",{clipX:0,clipY:0});a(this,"_enabled",!1);a(this,"_onPointerDown",e=>{this._extractButton(e)===0&&(this._isPointerDown||(this._isPointerDown=!0,xs(e)&&(console.assert(e.changedTouches.length>0),this._firstTouchIdentifier=e.changedTouches[0].identifier),this._dispatchEvent(this._pointerDownListeners,e)))});a(this,"_onPointerUp",e=>{if(this._extractButton(e)!==0)return;const i=xs(e);i&&this._findTouch(e,this._firstTouchIdentifier,!0)||this._isPointerDown&&(this._isPointerDown=!1,this._dispatchEvent(this._pointerUpListeners,e),i&&(this._firstTouchIdentifier=-1))});a(this,"_onPointerMove",e=>{xs(e)&&this._firstTouchIdentifier===-1||this._dispatchEvent(this._pointerMoveListeners,e)});this._domElement=e,this._editMode=t,this.enable()}_extractButton(e){if(xs(e)||e.button===void 0)return 0;switch(e.button){case 0:return 0;case 1:return 1;case 2:return 2}return-1}_isPointerLockActive(){const e=document;return!!(e.pointerLockElement||e.mozPointerLockElement||e.webkitPointerLockElement)}_findTouch(e,t,i=!1){if(!i)for(let n=0;n<e.changedTouches.length;n++){const r=e.changedTouches[n];if(r.identifier===t)return r}for(let n=0;n<e.touches.length;n++){const r=e.touches[n];if(r.identifier===t)return r}}_extractPosition(e){let t=0,i=0;const n=xs(e);if(!n&&this._isPointerLockActive())return this._tmpClip.clipX=0,this._tmpClip.clipY=0,this._tmpClip;if(n){const r=this._findTouch(e,this._firstTouchIdentifier);tt(r!==void 0),t=r.clientX,i=r.clientY}else t=e.clientX,i=e.clientY;return this._tmpClip.clipX=t/window.innerWidth*2-1,this._tmpClip.clipY=-(i/window.innerHeight)*2+1,this._tmpClip}_getEventKeyModifiers(e){let t=0;return(e.ctrlKey&&!it.mac||e.metaKey&&it.mac)&&(t|=2),e.altKey&&(t|=4),e.shiftKey&&(t|=1),t}_dispatchEvent(e,t){if(e.length===0)return;const i=this._extractPosition(t);for(const n of e)if(n.callback(i.clipX,i.clipY,this._getEventKeyModifiers(t)))return}_registerEventListeners(){this._domElement.addEventListener("mousedown",this._onPointerDown,!1),this._domElement.addEventListener("touchstart",this._onPointerDown,!1),this._domElement.addEventListener("mouseup",this._onPointerUp,!1),this._domElement.addEventListener("touchend",this._onPointerUp,!1),this._domElement.addEventListener("mousemove",this._onPointerMove,!1),this._domElement.addEventListener("touchmove",this._onPointerMove,!1),window.addEventListener("mouseup",this._onPointerUp,!1),this._editMode&&window.top.addEventListener("mouseup",this._onPointerUp,!1)}_unregisterEventListeners(){this._domElement.removeEventListener("mousedown",this._onPointerDown,!1),this._domElement.removeEventListener("touchstart",this._onPointerDown,!1),this._domElement.removeEventListener("mouseup",this._onPointerUp,!1),this._domElement.removeEventListener("touchend",this._onPointerUp,!1),this._domElement.removeEventListener("mousemove",this._onPointerMove,!1),this._domElement.removeEventListener("touchmove",this._onPointerMove,!1),window.removeEventListener("mouseup",this._onPointerUp,!1),this._editMode&&window.top.removeEventListener("mouseup",this._onPointerUp,!1)}_addListener(e,t,i){const n=e.filter(l=>l.callback===t);console.assert(n.length===0,"Do not add the same callback twice!");const r={callback:t,priority:i};let o=0;for(o=0;o<e.length;o+=1){const l=e[o];if(r.priority<=l.priority){if(r.priority===l.priority){console.error("Adding two listeners with the same priority is not allowed!");return}break}}e.splice(o,0,r)}addPointerDownListener(e,t){this._addListener(this._pointerDownListeners,e,t)}removePointerDownListener(e){this._pointerDownListeners=this._pointerDownListeners.filter(t=>t.callback!==e)}addPointerUpListener(e,t){this._addListener(this._pointerUpListeners,e,t)}removePointerUpListener(e){this._pointerUpListeners=this._pointerUpListeners.filter(t=>t.callback!==e)}addPointerMoveListener(e,t){this._addListener(this._pointerMoveListeners,e,t)}removePointerMoveListener(e){this._pointerMoveListeners=this._pointerMoveListeners.filter(t=>t.callback!==e)}isEnabled(){return this._enabled}enable(){this._enabled||(this._registerEventListeners(),this._enabled=!0)}disable(){this._enabled&&(this._unregisterEventListeners(),this._enabled=!1)}}const ih=.005,L0=.02,F0=[new Ue(0,1),new Ue(1,0),new Ue(-1,0),new Ue(0,-1)];class O0{constructor(e,t,i){a(this,"collider");a(this,"controls");a(this,"animationController");a(this,"enabled",!0);a(this,"toGround",1/0);a(this,"cameraPosition");a(this,"prevCameraPosition",new B);this.collider=e,this.controls=t,this.animationController=i,this.cameraPosition=this.controls.cameraWorldPosition(),this.enable()}_heightNeedsUpdate(){const e=this.controls.cameraHeight;return e===null?!1:this.toGround<e-ih||this.toGround>e+ih}_calculateGroundDistance(e,t,i){const o=new B,l=[e];return F0.forEach(c=>{o.copyFrom(t),o.x+=c.x*.1,o.y+=c.y*.1;const d=this.collider.distanceToGroundFrom(o,i*(1+.1));isFinite(d)&&l.push(d)}),l.reduce((c,d)=>Math.min(c,d),1/0)}updateCameraHeight(e){if(!this.enabled)return;const t=this.cameraPosition.z-this.prevCameraPosition.z;if(this.cameraPosition.x!==this.prevCameraPosition.x||this.cameraPosition.y!==this.prevCameraPosition.y?this.toGround=this.collider.distanceToGround(D.MAX_GROUND_SEARCH_DEPTH):this.toGround!==1/0&&(this.toGround+=t),this.toGround!==1/0&&(this.controls.cameraHeight!==null?(this.controls.cameraHeight+=t,this.controls.cameraHeight=Math.max(L0,this.controls.cameraHeight)):this.controls.cameraHeight=this.toGround,this._heightNeedsUpdate())){const n=Math.sqrt(Math.pow(this.cameraPosition.x-this.prevCameraPosition.x,2)+Math.pow(this.cameraPosition.y-this.prevCameraPosition.y,2))/e,r=Math.max(1.5*n,D.CAMERA_DEFAULT_MOVE_MAX_SPEED),o=this.controls.cameraHeight;this.toGround=this._calculateGroundDistance(this.toGround,this.cameraPosition,o);let l=Math.min(r*e,Math.abs(this.toGround-o));this.toGround>o&&(l=-l),(l<0||this.collider.distanceToCeiling(l+D.MIN_DISTANCE_TO_CEILING)===1/0&&Math.abs(l)>ih)&&(this.cameraPosition.z+=l,this.toGround+=l,this.animationController.requestFrame())}this.prevCameraPosition.copyFrom(this.cameraPosition)}enable(){this.enabled=!0,this.toGround=this.collider.distanceToGround(D.MAX_GROUND_SEARCH_DEPTH),this.toGround!==1/0?this.controls.cameraHeight=this.toGround:this.controls.cameraHeight=null,this.prevCameraPosition.copyFrom(this.cameraPosition)}disable(){this.enabled=!1}isEnabled(){return this.enabled}}class Gn{constructor(){a(this,"viewportWidth",1);a(this,"viewportHeight",1);a(this,"near",1);a(this,"far",250);a(this,"isPerspective",!0);a(this,"fov",60);a(this,"aspect",16/9);a(this,"left",1);a(this,"right",1);a(this,"top",1);a(this,"bottom",1)}setViewportSize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.aspect=e/t}setProjectionMatrix(e){this.isPerspective?e.setPerspective(this.fov,this.aspect,this.near,this.far):e.setOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)}applyJitter(e,t){e.elements[8]=t[0],e.elements[9]=t[1]}}class gl{static merge(e){const t={};for(let i=0;i<e.length;i++){const n=gl.clone(e[i]);for(const r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}static clone(e){const t={};for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){t[i]={};for(const n in e[i]){if(!Object.prototype.hasOwnProperty.call(e[i],n))continue;const r=e[i][n];r&&r.clone!==void 0?t[i][n]=r.clone():r instanceof Array?t[i][n]=r.slice():t[i][n]=r}}return t}}const ns=class ns{static registerIfEnabled(e,t){D.DEBUG_UI&&Uo.registerCallback(t.bind(e))}static beginWindow(e,t,i){ImGui.SetNextWindowPos(new ImGui.ImVec2(t.x,t.y),ImGui.Cond.FirstUseEver),ImGui.SetNextWindowSize(new ImGui.ImVec2(i.x,i.y),ImGui.Cond.FirstUseEver),ImGui.Begin(e)}static endWindow(){ImGui.End()}static header(e){return ImGui.CollapsingHeader(e,ImGui.TreeNodeFlags.DefaultOpen)}static editObject(e){ns.tryToHandleObject(!0,e)||ns.editProperties(e)}static editProperties(e){let t;for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if(typeof e[t]=="object"&&ns.tryToHandleObject(!0,e[t],t))continue;const i=t.toString()+ns.DebugEditPropSuffix;if(i in e)bs(e,i)(e);else if(typeof e[t]=="number")ImGui.DragFloat(t,(n=e[t])=>e[t]=n);else if(e[t]instanceof B){const n=e[t];ImGui.DragFloat3(t,n)}else typeof e[t]=="boolean"&&ImGui.Checkbox(t,(n=e[t])=>e[t]=n)}}static displayObject(e){ns.tryToHandleObject(!1,e)||ns.displayProperties(e)}static displayProperties(e){let t;for(t in e)if(Object.prototype.hasOwnProperty.call(e,t)){if(typeof e[t]=="object"&&ns.tryToHandleObject(!1,e[t],t))continue;const i=t.toString()+": ";if(typeof e[t]=="number")ImGui.BulletText(i+e[t].toFixed(3));else if(e[t]instanceof B){const n=e[t];ImGui.BulletText(i+" x: "+n.x.toFixed(3)+" y: "+n.y.toFixed(3)+" z: "+n.z.toFixed(3))}else if(typeof e[t]=="boolean"){const n=e[t];ImGui.BulletText(i+(n?"true":"false"))}}}static tryToHandleObject(e,t,i){const r=(e?ao.customEditClasses:ao.customDisplayClasses).get(t.constructor.name);return r?(i&&ImGui.BulletText(i),ImGui.Indent(),r(t),ImGui.Unindent(),!0):!1}};a(ns,"DebugEditPropSuffix","ImGuiPropEdit"),a(ns,"DebugAccessPropSuffix","ImGuiPropAccess");let Ni=ns;const ar=class ar{static ZeroToOne(e,t){if(!D.DEBUG_UI)return;const i=t,n=i+Ni.DebugEditPropSuffix;e&&Object.defineProperty(e,n,{value:r=>{ImGui.DragFloat(i,(o=r[i])=>r[i]=o,.025,0,1)}})}static ImGuiClassPropAccess(e=!0,t=!0){function i(n,r){D.DEBUG_UI&&(e&&ar.customDisplayClasses.set(n.name,o=>{Ni.displayProperties(o)}),t&&ar.customEditClasses.set(n.name,o=>{Ni.editProperties(o)}))}return i}static ImGuiCustomDisplay(e){function t(i,n){D.DEBUG_UI&&ar.customDisplayClasses.set(i.name,e)}return t}static ImGuiCustomEdit(e){function t(i,n){D.DEBUG_UI&&ar.customEditClasses.set(i.name,e)}return t}};a(ar,"customDisplayClasses",new Map),a(ar,"customEditClasses",new Map);let ao=ar;class Wu{constructor(e,t,i){a(this,"parentNode");a(this,"resultType","");a(this,"shaderId");a(this,"result");a(this,"connectedPorts",[]);a(this,"requestCounter",0);this.parentNode=e,this.resultType=t,this.shaderId=i,this.requestCounter=0}getConnectedPort(){return this.connectedPorts.length==1?this.connectedPorts[0]:null}connect(e){this.connectedPorts.includes(e)||this.connectedPorts.push(e),e.connectedPorts.includes(this)||e.connectedPorts.push(this)}disconnect(e){const t=this.connectedPorts.indexOf(e);t>-1&&this.connectedPorts.splice(t,1);const i=e.connectedPorts.indexOf(this);i>-1&&e.connectedPorts.splice(i,1)}acquireResult(e){return this.result===void 0&&this.parentNode.acquireResult(this,e),--this.requestCounter===0&&e.notifyResultUnuse(this),console.assert(this.requestCounter>=0,"The port result of node "+this.parentNode.nodeName+" was acquired more times that was detected during frame building phase! requestCounter: "+this.requestCounter),this.result}}class xr{constructor(e){a(this,"inputs",[]);a(this,"outputs",[]);a(this,"requiredDependenciesCount",0);a(this,"followingNodes",new Set);a(this,"requiresRun",!1);a(this,"needsRebuilding",!0);a(this,"nodeName");this.nodeName=e,Ni.registerIfEnabled(this,this.onDebugUI)}addInputPort(e,t){const i=new Wu(this,e,t);return this.inputs.push(i),i}addOutputPort(e,t){const i=new Wu(this,e,t);return this.outputs.push(i),i}buildInput(e,t){console.assert(this.inputs.includes(e),"Invalid port used!");for(const i of e.connectedPorts)i.parentNode.buildOutput(i,t,this);e.requestCounter=e.connectedPorts.length}buildOutput(e,t,i){if(console.assert(this.outputs.includes(e),"Invalid port used!"),this.needsRebuilding){this.needsRebuilding=!1,t.addDependency(this,i);for(const n of this.inputs)this.buildInput(n,t)}e.requestCounter++}clearResults(){for(const e of this.inputs)e.result=void 0;for(const e of this.outputs)e.result=void 0}connectToInput(e,t){const i=this.inputs.find(r=>r.resultType===t),n=e.outputs.find(r=>r.resultType===t);i!==void 0&&n!==void 0?i.connect(n):console.error("Couldn't find valid ports for connecting by result of type "+t+".")}connectMatchingOutputs(e){for(const t of this.inputs)if(t.connectedPorts.length===0){const i=e.outputs.find(n=>n.resultType===t.resultType);i!==void 0&&t.connect(i)}}update(e){}render(e){}acquireResult(e,t){}unuseResultResources(e,t){}acquireConnectedResult(e,t){return console.assert(this.inputs.includes(e)||this.outputs.includes(e),"Invalid port used!"),e.requestCounter--,e.getConnectedPort().acquireResult(t)}onDebugUI(){}getMaterial(){}isRenderCallRequired(){return!0}}class nh extends xr{constructor(t,i){super(i);a(this,"material");a(this,"uniforms");this.material=new ai({vsName:t.vertexShaderName,fsName:t.fragmentShaderName}),this.material.depthWrite=!1,this.material.addDefine("DEV_NEW_RENDER_ARCHITECTURE"),this.material.uniforms=gl.clone(t.uniforms),this.uniforms=this.material.uniforms,this.uniforms.resolution!=null&&this.uniforms.resolution.value.set(1/(window.innerWidth*window.devicePixelRatio),1/(window.innerHeight*window.devicePixelRatio)),this.material.depthTest=!1,this.material.depthWrite=!1}update(t){const i=t.frameInfo.camera.get(Gn);this.uniforms.resolution!=null&&this.uniforms.resolution.value.set(1/i.viewportWidth,1/i.viewportHeight)}render(t){this.bindInputsOutputs(t);const i=t.getRenderDevice(),n=t.resourcesEnv.fullscreenRenderHelper;try{i.setMaterial(this.material),i.setMaterialFaces(this.material),i.renderBufferDirect(n.camera,this.material,n.quad.geometry,n.quad)}catch(r){const o=this.material?this.material.name:"null";console.error(`Failed to render material ${o}: ${r.stack}`)}}onResize(t,i){this.uniforms.resolution.value.set(1/t,1/i)}bindInputsOutputs(t){for(const i of this.inputs){const n=this.acquireConnectedResult(i,t);if(n!==void 0){const r=this.material.uniforms[i.shaderId];r?r.value=n:console.error("Invalid uniform id in render node! Input name: "+i.shaderId)}else console.error("Invalid input for rendering postprocess!")}console.assert(this.outputs.length===1);for(const i of this.outputs){const n=this.acquireConnectedResult(i,t);n!==void 0?t.getRenderDevice().setRenderTarget(n):console.error("Invalid render target for render node!")}}dispose(){this.material.dispose()}getMaterial(){return this.material}}const B0={uniforms:{tDiffuse:{type:"t",value:null}},vertexShaderName:"postprocess_vertex.glsl",fragmentShaderName:"copy_opaque_fragment.glsl"};class N0 extends nh{constructor(){super(B0,"CopyTexture"),this.addInputPort("RenderResult","tDiffuse"),this.addOutputPort("RenderResult")}}const k0={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new Ue(1/1024,1/512)}},vertexShaderName:"fxaa_vertex.glsl",fragmentShaderName:"fxaa_fragment.glsl"};class ju extends nh{constructor(){super(k0,"FXAA"),this.addInputPort("RenderResult","tDiffuse"),this.addOutputPort("RenderResult"),this.uniforms.resolution.value.set(1/window.innerWidth,1/window.innerHeight)}}class U0 extends xr{constructor(){super("ImGui");a(this,"resultPort");this.resultPort=this.addOutputPort("RenderResult")}render(t){const i=this.acquireConnectedResult(this.resultPort,t);t.getRenderDevice().setRenderTarget(i),ImGui.Render(),ImGui_Impl.RenderDrawData(ImGui.GetDrawData())}onDebugUI(){}}class Ts{constructor(){a(this,"viewMatrix",new je);a(this,"invViewMatrix",new je);a(this,"projectionMatrix",new Cc);a(this,"invProjMatrix",new je);a(this,"unjitteredProjectionMatrix",new Cc);a(this,"unjitteredInvProjectionMatrix",new Cc);a(this,"viewProjMatrix",new je);a(this,"invViewProjMatrix",new je)}}class z0{constructor(){a(this,"jitterIndex",-1);a(this,"enabled",!1);a(this,"jitterOffsets",[])}getJitterOffset(){return this.enabled?this.jitterOffsets[this.jitterIndex]:[0,0]}setNextJitter(){this.jitterIndex=(this.jitterIndex+1)%this.jitterOffsets.length}generateHaltonJitters(e,t,i){this.jitterOffsets=[];for(let n=1;n<=e;n++)this.jitterOffsets.push([(this.getHaltonNumber(2,n)-.5)*2/t,(this.getHaltonNumber(3,n)-.5)*2/i])}getHaltonNumber(e,t){let i=0,n=1;for(;t>0;)n/=e,i+=n*(t%e),t=Math.floor(t/e);return i}}class Zs{constructor(){a(this,"temporalJitter",new z0);a(this,"prevViewProjMatrix",new je);a(this,"prevViewMatrix",new je);a(this,"prevProjMatrix",new je);a(this,"unjitteredPrevViewProjMatrix",new je);a(this,"prevCameraPosition",new B(0,0,0));a(this,"cameraMove",new B(0,0,0))}}var V0=Object.defineProperty,G0=Object.getOwnPropertyDescriptor,H0=(s,e,t,i)=>{for(var n=i>1?void 0:i?G0(e,t):e,r=s.length-1,o;r>=0;r--)(o=s[r])&&(n=(i?o(e,t,n):o(n))||n);return i&&n&&V0(e,t,n),n};class jo{constructor(){a(this,"motionBlurIntensity",1);a(this,"temporalAAEnabled",!0);a(this,"temporalAAWeight",.95)}}H0([ao.ZeroToOne],jo.prototype,"temporalAAWeight",2);class _l{constructor(){a(this,"format",nt.RGBA8);a(this,"magFilter",ne.NEAREST);a(this,"minFilter",ne.NEAREST);a(this,"stencilBuffer",!1);a(this,"depthBuffer",!1);a(this,"useDepthTexture",!1);a(this,"generateMipmaps",!1)}getHash(){return _l.getHashFromRenderTarget(this)}static getHashFromRenderTarget(e){return""+e.format+e.magFilter+e.minFilter+e.stencilBuffer+e.depthBuffer+e.useDepthTexture+e.generateMipmaps}}class lo extends xr{constructor(t=null,i=!1){super(t||"RenderTarget");a(this,"renderTarget");a(this,"renderTargetParams",new _l);this.addInputPort("RenderResult"),this.addOutputPort("RenderResult"),this.renderTargetParams.depthBuffer=i,this.renderTargetParams.useDepthTexture=i,i&&this.addOutputPort("DepthRenderResult")}setRenderTarget(t){this.outputs[0].result=this.inputs[0].result=t}acquireResult(t,i){console.assert(t===this.inputs[0]||t===this.outputs[0]||t===this.outputs[1],"Invalid port result acquire!");let n=this.inputs[0].result;n||(n=this.outputs[0].result),n||(n=i.resourcesEnv.renderTargetManager.getRenderTarget(this.renderTargetParams,i.getRenderDevice())),this.setRenderTarget(n),this.renderTargetParams.depthBuffer&&(this.outputs[1].result=n.depthTexture)}unuseResultResources(t,i){this.inputs[0].requestCounter===0&&this.outputs[0].requestCounter===0&&(!this.renderTargetParams.depthBuffer||this.outputs[1].requestCounter===0)&&(i.resourcesEnv.renderTargetManager.unuseRenderTarget(this.inputs[0].result),this.outputs[0].result=this.inputs[0].result=void 0,this.renderTargetParams.depthBuffer&&(this.outputs[1].result=void 0))}isRenderCallRequired(){return!1}}class Xu{constructor(){a(this,"_code","")}generateUniformBufferCode(e,t){return this.beginUniformBufferCode(t),this.generateCodeForObject(e),this.endUniformBufferCode()}beginUniformBufferCode(e){this._code="uniform "+e+` {
`}endUniformBufferCode(){return this._code+="};",this._code}_addUniformLine(e,t,i){this._code+="	"+e+" "+(i!=null?i:"")+t+`;
`}generateCodeForObject(e,t,i){if(e instanceof Lt)this._addUniformLine("vec4",t,i);else if(e instanceof B)this._addUniformLine("vec3",t,i);else if(e instanceof Ue)this._addUniformLine("vec2",t,i);else if(e instanceof je)this._addUniformLine("mat4",t,i);else if(e instanceof ys)this._addUniformLine("mat3",t,i);else if(e instanceof ll)this._addUniformLine("int",t,i);else if(e instanceof Re)this._addUniformLine("vec3",t,i);else for(const[n,r]of Object.entries(e))if(Array.isArray(r)){const o=r;for(let l=0;l<o.length;l++)o[l],this.generateCodeForObject(o[l],void 0,`${n}[${l}].`)}else typeof r=="object"?this.generateCodeForObject(r,n,i):typeof r=="number"&&this._addUniformLine("float",n,i)}}const qu=new Map([["position",0],["sphericalNormal",1],["uv0",2],["uv1",3],["uv1Mod",4],["t0",5],["t1",6],["t2",7],["normal",8]]),W0=Object.freeze((()=>{const s=new qc,e=new Float32Array([0,0]);return s.uv0=e,s.uv1=e,s.uv1Mod=new Float32Array([0,0,1/65535,1/65535]),s.t0=new Float32Array([1,0,0,0]),s.t1=new Float32Array([0,1,0,0]),s.t2=new Float32Array([0,0,1,0]),s.sphericalNormal=e,s})());var ji=(s=>(s[s.SAMPLER_2D=ne.SAMPLER_2D]="SAMPLER_2D",s[s.SAMPLER_CUBE=ne.SAMPLER_CUBE]="SAMPLER_CUBE",s[s.SAMPLER_3D=ne.SAMPLER_3D]="SAMPLER_3D",s[s.SAMPLER_2D_SHADOW=ne.SAMPLER_2D_SHADOW]="SAMPLER_2D_SHADOW",s[s.SAMPLER_2D_ARRAY=ne.SAMPLER_2D_ARRAY]="SAMPLER_2D_ARRAY",s[s.SAMPLER_2D_ARRAY_SHADOW=ne.SAMPLER_2D_ARRAY_SHADOW]="SAMPLER_2D_ARRAY_SHADOW",s[s.SAMPLER_CUBE_SHADOW=ne.SAMPLER_CUBE_SHADOW]="SAMPLER_CUBE_SHADOW",s[s.INT_SAMPLER_2D=ne.INT_SAMPLER_2D]="INT_SAMPLER_2D",s[s.INT_SAMPLER_3D=ne.INT_SAMPLER_3D]="INT_SAMPLER_3D",s[s.INT_SAMPLER_CUBE=ne.INT_SAMPLER_CUBE]="INT_SAMPLER_CUBE",s[s.INT_SAMPLER_2D_ARRAY=ne.INT_SAMPLER_2D_ARRAY]="INT_SAMPLER_2D_ARRAY",s[s.UNSIGNED_INT_SAMPLER_2D=ne.UNSIGNED_INT_SAMPLER_2D]="UNSIGNED_INT_SAMPLER_2D",s[s.UNSIGNED_INT_SAMPLER_3D=ne.UNSIGNED_INT_SAMPLER_3D]="UNSIGNED_INT_SAMPLER_3D",s[s.UNSIGNED_INT_SAMPLER_CUBE=ne.UNSIGNED_INT_SAMPLER_CUBE]="UNSIGNED_INT_SAMPLER_CUBE",s[s.UNSIGNED_INT_SAMPLER_2D_ARRAY=ne.UNSIGNED_INT_SAMPLER_2D_ARRAY]="UNSIGNED_INT_SAMPLER_2D_ARRAY",s[s.FLOAT=ne.FLOAT]="FLOAT",s[s.FLOAT_VEC2=ne.FLOAT_VEC2]="FLOAT_VEC2",s[s.FLOAT_VEC3=ne.FLOAT_VEC3]="FLOAT_VEC3",s[s.FLOAT_VEC4=ne.FLOAT_VEC4]="FLOAT_VEC4",s[s.INT=ne.INT]="INT",s[s.INT_VEC2=ne.INT_VEC2]="INT_VEC2",s[s.INT_VEC3=ne.INT_VEC3]="INT_VEC3",s[s.INT_VEC4=ne.INT_VEC4]="INT_VEC4",s[s.BOOL=ne.BOOL]="BOOL",s[s.BOOL_VEC2=ne.BOOL_VEC2]="BOOL_VEC2",s[s.BOOL_VEC3=ne.BOOL_VEC3]="BOOL_VEC3",s[s.BOOL_VEC4=ne.BOOL_VEC4]="BOOL_VEC4",s[s.FLOAT_MAT2=ne.FLOAT_MAT2]="FLOAT_MAT2",s[s.FLOAT_MAT3=ne.FLOAT_MAT3]="FLOAT_MAT3",s[s.FLOAT_MAT4=ne.FLOAT_MAT4]="FLOAT_MAT4",s))(ji||{});function j0(s){switch(s){case ji.SAMPLER_2D:case ji.SAMPLER_CUBE:case ji.SAMPLER_3D:case ji.SAMPLER_2D_SHADOW:case ji.SAMPLER_2D_ARRAY:case ji.SAMPLER_2D_ARRAY_SHADOW:case ji.SAMPLER_CUBE_SHADOW:case ji.INT_SAMPLER_2D:case ji.INT_SAMPLER_3D:case ji.INT_SAMPLER_CUBE:case ji.INT_SAMPLER_2D_ARRAY:case ji.UNSIGNED_INT_SAMPLER_2D:case ji.UNSIGNED_INT_SAMPLER_3D:case ji.UNSIGNED_INT_SAMPLER_CUBE:case ji.UNSIGNED_INT_SAMPLER_2D_ARRAY:return!0;default:return!1}}const Ms=4,Yu=new Map([["lightmap",0],["envMap[0]",1],["envMap[1]",2],["envMap[2]",3],["brdfLUT",4]]);class Qu{constructor(e,t,i,n){a(this,"vsSource");a(this,"vsName");a(this,"fsSource");a(this,"fsName");a(this,"id");this.vsName=e,this.vsSource=t,this.fsName=i,this.fsSource=n,this.id=this.computeHash(),ye(i&&n||!i&&!n)}getId(){return this.id}computeHash(){let e=0,t,i;if(this.vsSource.length===0&&this.fsSource.length===0)return e;for(const n of[this.vsSource,this.fsSource])for(t=0;t<n.length;t++)i=n.charCodeAt(t),e=(e<<5)-e+i,e|=0;return e}}class Ku{constructor(){a(this,"program");a(this,"refCounter",0);a(this,"uniformBlockDescriptors",new Map);a(this,"samplerUniformSlots",new Map);a(this,"id",0);a(this,"debugShaderDesc")}compileProgram(e,t){const i=this.createWebGLShader(e,e.VERTEX_SHADER,t.vsSource,t.vsName);if(!i)return!1;const n=e.createProgram();if(n)e.attachShader(n,i);else return!1;let r=!0,o;if(t.fsSource!==""&&(o=this.createWebGLShader(e,e.FRAGMENT_SHADER,t.fsSource,t.fsName),o?e.attachShader(n,o):r=!1),r){this._setupAttributes(n,e),e.linkProgram(n);const l=e.getProgramInfoLog(n),c=l?l.trim():"";e.getProgramParameter(n,e.LINK_STATUS)===!1&&(console.error("Shader link error: "+e.getError(),"validate status: ",e.getProgramParameter(n,e.VALIDATE_STATUS)),r=!1),c!==""&&c!=="\0"&&console.warn("program info log: "+c)}return r?this.program=n:e.deleteProgram(n),i&&e.deleteShader(i),o&&e.deleteShader(o),r}_setupAttributes(e,t){for(const[i,n]of qu)t.bindAttribLocation(e,n,i)}load(e,t){D.DEBUG_UI&&(this.debugShaderDesc=e);const i=t.renderDevice.getGl(),n=this.compileProgram(i,e);if(n){const r=this.program;i.useProgram(r),this._setupUniformDescriptors(i)}return n}unload(e){this.program&&e.renderDevice.getGl().deleteProgram(this.program),this.program=void 0}addLineNumbers(e){return e.split(`
`).map((i,n)=>n+1+": "+i).join(`
`)}createWebGLShader(e,t,i,n){let r=e.createShader(t);if(!r)return;e.shaderSource(r,i),e.compileShader(r);const o=e.getShaderParameter(r,e.COMPILE_STATUS)===!1;if(o&&console.error(`Shader '${n}' failed to compile.`),o||D.LOG_INFO){const l=e.getShaderInfoLog(r);l!==""&&console.warn(`Shader '${n}' info log: `,l,this.addLineNumbers(i)),o&&(e.deleteShader(r),r=null)}return r||void 0}_setupUniformDescriptors(e){const t=this.program,i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),n=[...Array(i).keys()],r=e.getActiveUniforms(t,n,e.UNIFORM_BLOCK_INDEX),o=e.getActiveUniforms(t,n,e.UNIFORM_OFFSET),l=this._setupUniformBlocks(e,r);let c=Yu.size;for(let d=0;d<i;++d){const u=e.getActiveUniform(t,d),{name:h,type:f,size:p}=u;if(h.startsWith("gl_")||h.startsWith("webgl_"))continue;const m=l.get(r[d]),b=o[d],_=m.uniforms;let y=h;if(p>1){const A=h.indexOf("[");y=h.substring(0,A)}for(let A=0;A<p;A++){const T=p>1?`${y}[${A}]`:h;if(j0(f)){const M=e.getUniformLocation(t,T),C=Yu.get(T);let N=c;C!==void 0?N=C:c++,M?(e.uniform1i(M,N),this.samplerUniformSlots.set(T,{bindIndex:N,location:M})):console.log(`Couldn't find location for ${T}`)}else _.set(h,new R_(f,b))}}}_setupUniformBlocks(e,t){this.uniformBlockDescriptors.clear();const i=[...new Set(t)],n=new Map,r=this.program;for(const o of i.values())if(o!==-1){const l=e.getActiveUniformBlockName(r,o);if(!l){console.warn("Couldn't find uniform buffer block name!");continue}const c=I_[l];if(c!==void 0){const d=zo[c];e.uniformBlockBinding(r,o,d);const u=e.getActiveUniformBlockParameter(r,o,e.UNIFORM_BLOCK_DATA_SIZE),h=new vu(l,d,o);h.size=u,this.uniformBlockDescriptors.set(l,h),n.set(o,h)}else console.warn(`Unknown uniform buffer ${l}.`)}else{const l=new vu("",-1,-1);this.uniformBlockDescriptors.set("",l),n.set(-1,l)}return n}}class sh{constructor(e){a(this,"dataBuffer");a(this,"dataView");a(this,"descriptor");this.descriptor=e,this.dataBuffer=new ArrayBuffer(e.size),this.dataView=new DataView(this.dataBuffer)}_getUniformOffset(e,t){return this.descriptor.getUniformOffsetInBytes(e,t)}_loadInt32(e,t){this.dataView.setInt32(e,t,!0)}_loadFloat32(e,t){this.dataView.setFloat32(e,t,!0)}_loadFloat32Vector(e,t){this._loadFloat32(t,e.x),this._loadFloat32(t+1*Ms,e.y),e instanceof Ue||this._loadFloat32(t+2*Ms,e.z),e instanceof Lt&&this._loadFloat32(t+3*Ms,e.w)}_loadFloat32Matrix(e,t){let i=0;for(const n of e.elements)this._loadFloat32(t+Ms*i++,n)}_loadColor(e,t){this._loadFloat32(t,e.r),this._loadFloat32(t+1*Ms,e.g),this._loadFloat32(t+2*Ms,e.b)}loadObject(e,t,i){if(e instanceof Lt)this._loadFloat32Vector(e,this._getUniformOffset(t,i));else if(e instanceof B)this._loadFloat32Vector(e,this._getUniformOffset(t,i));else if(e instanceof Ue)this._loadFloat32Vector(e,this._getUniformOffset(t,i));else if(e instanceof je)this._loadFloat32Matrix(e,this._getUniformOffset(t,i));else if(e instanceof ys)this._loadFloat32Matrix(e,this._getUniformOffset(t,i));else if(e instanceof Re)this._loadColor(e,this._getUniformOffset(t,i));else{let n;for(n in e)if(Object.prototype.hasOwnProperty.call(e,n))if(Array.isArray(e[n])){const r=e[n];for(let o=0;o<r.length;o++)r[o],this.loadObject(r[o],void 0,`${n}[${o}].`)}else typeof e[n]=="object"?e[n]instanceof ll?this._loadInt32(e[n].value,this._getUniformOffset(n,i)):this.loadObject(e[n],n,i):typeof e[n]=="number"&&this._loadFloat32(this._getUniformOffset(n,i),e[n])}}}class vl{constructor(e){a(this,"glBuffer");const t=e.createBuffer();this.glBuffer=t}update(e,t,i){const n=new sh(t);n.loadObject(e),this.uploadBufferToGpu(n.dataView,i)}uploadBufferToGpu(e,t){this.glBuffer,t.bindBuffer(t.UNIFORM_BUFFER,this.glBuffer),t.bufferData(t.UNIFORM_BUFFER,e,t.DYNAMIC_DRAW),t.bindBuffer(t.UNIFORM_BUFFER,null)}uploadSubdataToGPU(e,t,i){this.glBuffer,i.bindBuffer(i.UNIFORM_BUFFER,this.glBuffer),i.bufferSubData(i.UNIFORM_BUFFER,t,e),i.bindBuffer(i.UNIFORM_BUFFER,null)}unload(e){this.glBuffer&&(e.deleteBuffer(this.glBuffer),this.glBuffer=void 0)}}class Zu{constructor(e,t){a(this,"baseMaterial");a(this,"perObjectUpdaters");this.baseMaterial=e,this.perObjectUpdaters=t}getId(){return this.baseMaterial.id}}class $u{constructor(){a(this,"refCounter",0);a(this,"shader");a(this,"id",0);a(this,"descriptor");a(this,"uniformBuffer")}_generateUniformBuffersCode(e,t){let i=e.uniformBufferData&&e.uniformBufferDataConstructor!==Su?new Xu().generateUniformBufferCode(e.uniformBufferData,zn[ve.MATERIAL])+`
`:"";if(t&&t.length>0){const n=new Xu;n.beginUniformBufferCode("ObjectBuffer");for(const r of t)r.appendCode(n);i+=n.endUniformBufferCode()}return i}load(e,t){this.descriptor=e;const i=e.baseMaterial,n=this._generateUniformBuffersCode(i,e.perObjectUpdaters),r=new Qu(i.vertexShaderName,i.generateVertexShader("",n),i.fragmentShaderName,i.generateFragmentShader("",n)),o=t.acquireResource(this,"shader",r);if(o){const l=this.shader.uniformBlockDescriptors.get(zn[ve.MATERIAL]);if(l&&i.uniformBufferData){const c=t.renderDevice.getGl();this.uniformBuffer=new vl(c),this.uniformBuffer.update(i.uniformBufferData,l,c)}}return o}unload(e){this.shader&&e.unuseResource(this,"shader"),this.uniformBuffer&&this.uniformBuffer.unload(e.renderDevice.getGl())}}function Ps(s,e,t,i,n=0){s.addAttribute(e,new St(t,i,n,!0))}class rh extends Wi{constructor(){super();a(this,"isInstanced",!1);a(this,"instanceCount",0);a(this,"index",null);a(this,"indexUint",!0);a(this,"vertices",null);a(this,"normals",null);a(this,"uvs0",null);a(this,"isUvs0Repeating",!1);a(this,"uvs1",null);a(this,"indexCnt",0);a(this,"indexOffset",0);a(this,"vertexCnt",0);a(this,"vertexOffset",0);a(this,"defaultAttributeValues");a(this,"gpuSize",0);this.boundingBox=new Dt,this.boundingSphere=new Tn,this._disableBoundingVolumesCompute=!0}allocateCoreBuffers(t){console.assert(!this.vertices),t&&(this.vertexCnt<=65535+1?(this.indexUint=!1,this.index=new Uint16Array(this.indexCnt),this.gpuSize+=this.indexCnt*2):(this.indexUint=!0,this.index=new Uint32Array(this.indexCnt),this.gpuSize+=this.indexCnt*4)),this.vertices=new Float32Array(this.vertexCnt*3),this.gpuSize+=this.vertexCnt*3*4,this.normals=it.ios?new Int16Array(this.vertexCnt*2):new Int8Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2}addCoreAttributes(){tt(this.vertices),tt(this.normals),this.index&&(Ps(this,"index",this.index,1),this.index=null),Ps(this,"position",this.vertices,3),this.vertices=null,Ps(this,"sphericalNormal",this.normals,2),this.normals=null}allocateUv0(){console.assert(!this.uvs0),this.uvs0=new Float32Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2*4}addUv0Attribute(){Ps(this,"uv0",this.uvs0,2),this.uvs0=null}allocateUv1(){console.assert(!this.uvs1),this.uvs1=new Uint16Array(this.vertexCnt*2),this.gpuSize+=this.vertexCnt*2*2}addUv1Attribute(){Ps(this,"uv1",this.uvs1,2),this.uvs1=null}}class Ju extends Wi{constructor(t,i){super();a(this,"parent");a(this,"ownsGpuBuffers");a(this,"isInstanced",!0);a(this,"instanceCount",0);a(this,"uvs1Mod",null);a(this,"transforms0",null);a(this,"transforms1",null);a(this,"transforms2",null);a(this,"indexOffset",0);a(this,"vertexOffset",0);a(this,"_gpuSize",0);this.boundingBox=new Dt,this.boundingSphere=new Tn,this.parent=t,this._disableBoundingVolumesCompute=!0,this.ownsGpuBuffers=i}allocateCoreBuffers(t){console.assert(!this.transforms0&&!this.transforms1&&!this.transforms2),this.parent.vertices||this.parent.allocateCoreBuffers(t);const i=this.instanceCount*4;this.transforms0=new Float32Array(i),this.transforms1=new Float32Array(i),this.transforms2=new Float32Array(i),this._gpuSize+=3*i*4}addCoreAttributes(){tt(this.transforms0&&this.transforms1&&this.transforms2),this.parent.attributes.position||this.parent.addCoreAttributes();for(const t of this.parent.attributesKeys)this.addAttribute(t,this.parent.attributes[t]);Ps(this,"t0",this.transforms0,4,1),Ps(this,"t1",this.transforms1,4,1),Ps(this,"t2",this.transforms2,4,1),this.transforms0=null,this.transforms1=null,this.transforms2=null}allocateUv0(){this.parent.uvs0||this.parent.allocateUv0()}addUv0Attribute(){this.parent.attributes.uv0||this.parent.addUv0Attribute(),this.addAttribute("uv0",this.parent.attributes.uv0)}allocateUv1(){console.assert(!this.uvs1Mod),this.parent.uvs1||this.parent.allocateUv1(),this.uvs1Mod=new Float32Array(this.instanceCount*4),this._gpuSize+=this.instanceCount*4*4}addUv1Attribute(){this.parent.attributes.uv1||this.parent.addUv1Attribute(),this.addAttribute("uv1",this.parent.attributes.uv1),Ps(this,"uv1Mod",this.uvs1Mod,4,1),this.uvs1Mod=null}get index(){return this.parent.index}get vertices(){return this.parent.vertices}get normals(){return this.parent.normals}get uvs0(){return this.parent.uvs0}get uvs1(){return this.parent.uvs1}get indexUint(){return this.parent.indexUint}get vertexCnt(){return this.parent.vertexCnt}set vertexCnt(t){this.parent.vertexCnt=t}get indexCnt(){return this.parent.indexCnt}set indexCnt(t){this.parent.indexCnt=t}get gpuSize(){return this.ownsGpuBuffers?this._gpuSize+this.parent.gpuSize:this._gpuSize}get isUvs0Repeating(){return this.parent.isUvs0Repeating}set isUvs0Repeating(t){this.parent.isUvs0Repeating=t}}class co{constructor(e,t,i,n=void 0,r=void 0,o=null,l=null){a(this,"id",NaN);a(this,"indexCnt");a(this,"vertexCnt");a(this,"parent");a(this,"vertexOffset");a(this,"indexOffset");a(this,"vertexAttribOffset");a(this,"isInstanced");a(this,"instanceId",0);a(this,"instanceCount",1);a(this,"defaultAttributeValues");a(this,"boundingBox",null);a(this,"boundingSphere",null);this.indexCnt=e,this.vertexCnt=t,this.parent=i,this.vertexOffset=r,this.indexOffset=n,this.isInstanced=i.isInstanced,this.boundingBox=o,this.boundingSphere=l}get indexUint(){return this.parent.indexUint}get isUvs0Repeating(){return this.parent.isUvs0Repeating}get attributes(){return this.parent.attributes}get attributesKeys(){return this.parent.attributesKeys}hasAttribute(e){return this.parent.hasAttribute(e)}setOnDispose(e){this.parent.setOnDispose(e)}}class oh{constructor(e,t){a(this,"geometry");a(this,"id");this.geometry=e,this.id=t}getId(){return this.id}}class ef{constructor(){a(this,"refCounter",0);a(this,"id",-1);a(this,"vao");a(this,"buffers",[]);a(this,"indexBufferType",0);a(this,"itemsCount",0);a(this,"offset",0);a(this,"instanceCount",0);a(this,"instanced",!1)}load(e,t){var d;const i=e.geometry,n=i.attributes;let r=0;i instanceof co&&(r=((d=i.instanceId)!=null?d:0)*4*4);const o=t.renderDevice.getGl(),l=o.createVertexArray();if(this.vao,this.vao=l,o.bindVertexArray(this.vao),n.index&&n.index.buffer){const u=n.index.buffer;this.buffers.push(u),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,u)}for(const[u,h]of qu){const f=n[u];if(f){const p=f.buffer;this.buffers.push(p),o.bindBuffer(o.ARRAY_BUFFER,p);const m=f.array;it.ios&&f.itemSize*m.BYTES_PER_ELEMENT%4;const b=f.itemSize,[_,y]=this._getTypeAndSizeForArray(m,o);o.enableVertexAttribArray(h);const A=f.divisor||0;let T=r*A;i instanceof co&&i.vertexAttribOffset&&(T+=i.vertexAttribOffset*y*b),o.vertexAttribPointer(h,b,_,!1,0,T),o.vertexAttribDivisor(h,A)}else{let p;if(!(i instanceof Ju)&&i.defaultAttributeValues){const m=u;p=i.defaultAttributeValues[m]}else p=W0[u];o.disableVertexAttribArray(h),p&&(p.length===2?o.vertexAttrib2fv(h,p):p.length===3?o.vertexAttrib3fv(h,p):p.length===4&&o.vertexAttrib4fv(h,p))}}const c=i.attributes.index;if(c){this.indexBufferType=c.glType;const u=i.indexUint?4:2;i.indexOffset!==void 0?(this.itemsCount=i.indexCnt,this.offset=u*i.indexOffset):(this.itemsCount=c.length,this.offset=0)}else{this.indexBufferType=0;const u=i.attributes.position;i.vertexOffset!==void 0?(this.itemsCount=i.vertexCnt,this.offset=i.vertexOffset):(this.itemsCount=u.length/u.itemSize,this.offset=0)}return this.instanced=i.isInstanced,this.instanceCount=i.instanceCount,o.bindVertexArray(null),!0}_getTypeAndSizeForArray(e,t){return e instanceof Float32Array?[t.FLOAT,4]:e instanceof Int8Array?[t.BYTE,1]:e instanceof Int16Array?[t.SHORT,2]:e instanceof Uint16Array?[t.UNSIGNED_SHORT,2]:e instanceof Uint32Array?[t.UNSIGNED_INT,4]:[0,0]}unload(e){return e.renderDevice.getGl().deleteVertexArray(this.vao),this.buffers=[],!0}}var li=(s=>(s[s.OPAQUE=0]="OPAQUE",s[s.GRASS=1]="GRASS",s[s.TRANSPARENT=2]="TRANSPARENT",s))(li||{});const ah=3;class X0{constructor(){a(this,"textures",[])}setTextures(e,t,i){this.textures=[];for(const[n,r]of e){let o;if(n==="lightmap")o=i.lightmap;else if(n.indexOf("envMap")>=0){let l=0;const c=n.indexOf("[");if(c>0){const d=n.indexOf("]");l=parseInt(n.substring(c+1,d)),l<D.MAX_BLENDED_REFLECTION_PROBES}o=i.envMaps[l]}else Object.prototype.hasOwnProperty.call(t.uniforms,n)?o=t.uniforms[n].value:console.warn("Couldn't find texture uniform of name "+n);o&&this.textures.push({samplerSlot:r,texture:o})}}unload(){this.textures=[]}}class q0{constructor(){a(this,"mesh");a(this,"lightDataBinding");a(this,"perObjectUniformBuffer");a(this,"renderMaterial");a(this,"activeMaterial");a(this,"boundsComp");a(this,"textureTable",new X0);a(this,"visible",!0);a(this,"index",-1)}load(e,t,i,n,r,o){this.perObjectUniformBuffer||(this.perObjectUniformBuffer=new vl(e.renderDevice.getGl())),this.boundsComp=o;const l=e.lightBindingManager.getLightDataBindingDescriptor(r.lightmap,r.reflectionProbes,i.baseMaterial.envMapMirror);this.visible=t.threeMesh.visible&&i.baseMaterial.visible;const c=new Zu(i.baseMaterial,n.perObjectUpdaters);this.setMaterial(e,c),this.renderMaterial.shader.uniformBlockDescriptors.has("LightBuffer")&&e.acquireResource(this,"lightDataBinding",l);const d=e.meshManager.getGeometryId(t.geometry);e.acquireResource(this,"mesh",new oh(t.geometry,d)),this.setTextures()}setMaterial(e,t){this.activeMaterial!==t.baseMaterial&&(this.activeMaterial=t.baseMaterial,e.acquireResource(this,"renderMaterial",t))}setTextures(){if(!this.renderMaterial.shader)return;const e=this.activeMaterial,t=this.renderMaterial.shader.samplerUniformSlots;this.textureTable.setTextures(t,e,this.lightDataBinding)}unload(e){e.unuseResource(this,"renderMaterial"),e.unuseResource(this,"lightDataBinding"),e.unuseResource(this,"mesh"),this.perObjectUniformBuffer.unload(e.renderDevice.getGl()),this.textureTable.unload()}bindLightingBuffer(e){this.lightDataBinding&&this.lightDataBinding.uniformBuffer,e.bindBufferBase(e.UNIFORM_BUFFER,zo[ve.LIGHT],this.lightDataBinding.uniformBuffer.glBuffer)}bindObjectBuffer(e){this.perObjectUniformBuffer.glBuffer,e.bindBufferBase(e.UNIFORM_BUFFER,zo[ve.OBJECT],this.perObjectUniformBuffer.glBuffer)}}class Y0{constructor(){a(this,"cameraDistances",new Float32Array);a(this,"sortedList",[]);a(this,"needsReindexing",!1);a(this,"compare",(e,t)=>e.renderMaterial!==t.renderMaterial?e.renderMaterial<t.renderMaterial?-1:1:e.lightDataBinding!==t.lightDataBinding?e.lightDataBinding<t.lightDataBinding?-1:1:0)}add(e){e.index=Kg(this.sortedList,e,this.compare),this.sortedList.splice(e.index,0,e),this.needsReindexing=!0}remove(e){e.index;const t=this.sortedList.length,i=this.sortedList.indexOf(e);this.sortedList.splice(i,1),t-1,this.sortedList.length,e.index=-1,this.needsReindexing=!0}reindexIfNeeded(){if(this.needsReindexing){this.needsReindexing=!1;let e=0;for(const t of this.sortedList)t.index=e++}}}const bl={BY_NORMALS:"By normals",UP:"Up"},Q0=new Lt(0,0,1,1);class K0 extends so{constructor(){super(...arguments);a(this,"grassDirectionality",1);a(this,"renderSteps",0)}}class Xo extends si{constructor(){super({vsHooks:nn.get("grass_vertex.glsl"),fsHooks:nn.get("grass_fragment.glsl"),uniformBufferDataConstructor:K0});a(this,"_grassHeight",.05);a(this,"_correctedHeightTexture",new no);a(this,"_direction",bl.BY_NORMALS);a(this,"grassScale",1);a(this,"doNotImport",{baseColor:!0,baseColorTexture:!0});this._repeatableTexturesRequired=!0,this.renderSteps=8,this.doNotImport={baseColor:!0,baseColorTexture:!0},this.setUniform("currentStep","f",0,ve.MATERIAL),this.setUniform("grassOffsetScaled","f",0,ve.MATERIAL),this.setUniform("grassDirectionality","f",1,ve.MATERIAL),this.setUniform("renderSteps","f",this.renderSteps,ve.MATERIAL)}_getCorrectedTexture(t){return t===Pn.HEIGHT?this._correctedHeightTexture:super._getCorrectedTexture(t)}set grassHeight(t){this._grassHeight=t,this._updated()}get grassHeight(){return this._grassHeight}set grassLayers(t){this.renderSteps=t,this.uniforms.renderSteps.value=this.renderSteps,this._updated()}get grassLayers(){return this.renderSteps}get grassDirectionMode(){return bl}get grassDirection(){return this._direction}set grassDirection(t){this._direction=t,this.uniforms.grassDirectionality.value=this._direction===bl.UP?0:1,this._updated()}set heightTexture(t){this._correctedHeightTexture.texture=t,t.addLoadedListener(()=>{this.setUniform("heightTexture","t",this.heightTexture,ve.MATERIAL),this.condDefine(this.heightTexture!==void 0,"USE_HEIGHT_TEXTURE"),this.setUniform("uvMod0","v4",this._uvOffsetScale||Q0,ve.MATERIAL),this._updated()})}get heightTexture(){return this._correctedHeightTexture.texture}_setTexture(t,i){if(t===Pn.HEIGHT)this.heightTexture=i;else return super._setTexture(t,i)}get type(){return"grass"}hash(){return"grass"}canMerge(t){return!1}configureTransparency(){this.blending=Hi.NORMAL}updateRenderStep(t){const i=this.grassHeight/this.renderSteps*t;this.uniforms.grassOffsetScaled.value=i*this.grassScale,this.uniforms.currentStep.value=t}refreshPerObjectUniforms(t){const i=this.uniforms;let n=ai.prototype.refreshPerObjectUniforms.call(this,t),r;if(t instanceof As){const o=t.selected?t.highlightMix:0;i.highlightMix!==void 0&&o!==i.highlightMix.value&&(i.highlightMix.value=o,n=!0),r=t.grassScaleOverride}return this.grassScale=r!=null?r:1,this._direction===bl.UP&&(i.grassDirectionality.value=r?1:0),n}serialize(){var n,r;const t=this.baseColor.roundChannels().toArray(),i=this.serializeTextureProperties(Pn.BASE_COLOR);return{name:this.name,type:this.type,baseColor:t,baseColorTexture:i.texture,baseColorTextureCorrection:i.correction,heightTexture:(r=(n=this.heightTexture)==null?void 0:n.serialize())!=null?r:null,grassHeight:this.grassHeight,grassLayers:this.grassLayers,grassDirection:this.grassDirection,doNotImport:this.doNotImport,uvOffsetScale:this.serializeUvOffsetScale(),antiTiling:this.serializeAntiTilingProperties()}}}function Z0(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function $0(s){if(s.__esModule)return s;var e=s.default;if(typeof e=="function"){var t=function i(){return this instanceof i?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(s).forEach(function(i){var n=Object.getOwnPropertyDescriptor(s,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return s[i]}})}),t}var ci={},lh=function(s,e){return lh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])},lh(s,e)};function tf(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");lh(s,e);function t(){this.constructor=s}s.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var yl=function(){return yl=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},yl.apply(this,arguments)};function nf(s,e){var t={};for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&e.indexOf(i)<0&&(t[i]=s[i]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,i=Object.getOwnPropertySymbols(s);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(s,i[n])&&(t[i[n]]=s[i[n]]);return t}function sf(s,e,t,i){var n=arguments.length,r=n<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(s,e,t,i);else for(var l=s.length-1;l>=0;l--)(o=s[l])&&(r=(n<3?o(r):n>3?o(e,t,r):o(e,t))||r);return n>3&&r&&Object.defineProperty(e,t,r),r}function rf(s,e){return function(t,i){e(t,i,s)}}function J0(s,e,t,i,n,r){function o(y){if(y!==void 0&&typeof y!="function")throw new TypeError("Function expected");return y}for(var l=i.kind,c=l==="getter"?"get":l==="setter"?"set":"value",d=!e&&s?i.static?s:s.prototype:null,u=e||(d?Object.getOwnPropertyDescriptor(d,i.name):{}),h,f=!1,p=t.length-1;p>=0;p--){var m={};for(var b in i)m[b]=b==="access"?{}:i[b];for(var b in i.access)m.access[b]=i.access[b];m.addInitializer=function(y){if(f)throw new TypeError("Cannot add initializers after decoration has completed");r.push(o(y||null))};var _=(0,t[p])(l==="accessor"?{get:u.get,set:u.set}:u[c],m);if(l==="accessor"){if(_===void 0)continue;if(_===null||typeof _!="object")throw new TypeError("Object expected");(h=o(_.get))&&(u.get=h),(h=o(_.set))&&(u.set=h),(h=o(_.init))&&n.unshift(h)}else(h=o(_))&&(l==="field"?n.unshift(h):u[c]=h)}d&&Object.defineProperty(d,i.name,u),f=!0}function ev(s,e,t){for(var i=arguments.length>2,n=0;n<e.length;n++)t=i?e[n].call(s,t):e[n].call(s);return i?t:void 0}function tv(s){return typeof s=="symbol"?s:"".concat(s)}function iv(s,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(s,"name",{configurable:!0,value:t?"".concat(t," ",e):e})}function of(s,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(s,e)}function af(s,e,t,i){function n(r){return r instanceof t?r:new t(function(o){o(r)})}return new(t||(t=Promise))(function(r,o){function l(u){try{d(i.next(u))}catch(h){o(h)}}function c(u){try{d(i.throw(u))}catch(h){o(h)}}function d(u){u.done?r(u.value):n(u.value).then(l,c)}d((i=i.apply(s,e||[])).next())})}function lf(s,e){var t={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},i,n,r,o;return o={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function l(d){return function(u){return c([d,u])}}function c(d){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,d[0]&&(t=0)),t;)try{if(i=1,n&&(r=d[0]&2?n.return:d[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,d[1])).done)return r;switch(n=0,r&&(d=[d[0]&2,r.value]),d[0]){case 0:case 1:r=d;break;case 4:return t.label++,{value:d[1],done:!1};case 5:t.label++,n=d[1],d=[0];continue;case 7:d=t.ops.pop(),t.trys.pop();continue;default:if(r=t.trys,!(r=r.length>0&&r[r.length-1])&&(d[0]===6||d[0]===2)){t=0;continue}if(d[0]===3&&(!r||d[1]>r[0]&&d[1]<r[3])){t.label=d[1];break}if(d[0]===6&&t.label<r[1]){t.label=r[1],r=d;break}if(r&&t.label<r[2]){t.label=r[2],t.ops.push(d);break}r[2]&&t.ops.pop(),t.trys.pop();continue}d=e.call(s,t)}catch(u){d=[6,u],n=0}finally{i=r=0}if(d[0]&5)throw d[1];return{value:d[0]?d[1]:void 0,done:!0}}}var xl=Object.create?function(s,e,t,i){i===void 0&&(i=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,i,n)}:function(s,e,t,i){i===void 0&&(i=t),s[i]=e[t]};function cf(s,e){for(var t in s)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&xl(e,s,t)}function Al(s){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&s[e],i=0;if(t)return t.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ch(s,e){var t=typeof Symbol=="function"&&s[Symbol.iterator];if(!t)return s;var i=t.call(s),n,r=[],o;try{for(;(e===void 0||e-- >0)&&!(n=i.next()).done;)r.push(n.value)}catch(l){o={error:l}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return r}function hf(){for(var s=[],e=0;e<arguments.length;e++)s=s.concat(ch(arguments[e]));return s}function df(){for(var s=0,e=0,t=arguments.length;e<t;e++)s+=arguments[e].length;for(var i=Array(s),n=0,e=0;e<t;e++)for(var r=arguments[e],o=0,l=r.length;o<l;o++,n++)i[n]=r[o];return i}function uf(s,e,t){if(t||arguments.length===2)for(var i=0,n=e.length,r;i<n;i++)(r||!(i in e))&&(r||(r=Array.prototype.slice.call(e,0,i)),r[i]=e[i]);return s.concat(r||Array.prototype.slice.call(e))}function ho(s){return this instanceof ho?(this.v=s,this):new ho(s)}function ff(s,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(s,e||[]),n,r=[];return n={},o("next"),o("throw"),o("return"),n[Symbol.asyncIterator]=function(){return this},n;function o(f){i[f]&&(n[f]=function(p){return new Promise(function(m,b){r.push([f,p,m,b])>1||l(f,p)})})}function l(f,p){try{c(i[f](p))}catch(m){h(r[0][3],m)}}function c(f){f.value instanceof ho?Promise.resolve(f.value.v).then(d,u):h(r[0][2],f)}function d(f){l("next",f)}function u(f){l("throw",f)}function h(f,p){f(p),r.shift(),r.length&&l(r[0][0],r[0][1])}}function pf(s){var e,t;return e={},i("next"),i("throw",function(n){throw n}),i("return"),e[Symbol.iterator]=function(){return this},e;function i(n,r){e[n]=s[n]?function(o){return(t=!t)?{value:ho(s[n](o)),done:!1}:r?r(o):o}:r}}function mf(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=s[Symbol.asyncIterator],t;return e?e.call(s):(s=typeof Al=="function"?Al(s):s[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(r){t[r]=s[r]&&function(o){return new Promise(function(l,c){o=s[r](o),n(l,c,o.done,o.value)})}}function n(r,o,l,c){Promise.resolve(c).then(function(d){r({value:d,done:l})},o)}}function gf(s,e){return Object.defineProperty?Object.defineProperty(s,"raw",{value:e}):s.raw=e,s}var nv=Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e};function _f(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&xl(e,s,t);return nv(e,s),e}function vf(s){return s&&s.__esModule?s:{default:s}}function bf(s,e,t,i){if(t==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!i:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?i:t==="a"?i.call(s):i?i.value:e.get(s)}function yf(s,e,t,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(s,t):n?n.value=t:e.set(s,t),t}function xf(s,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof s=="function"?e===s:s.has(e)}function Af(s,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var i;if(t){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");i=e[Symbol.asyncDispose]}if(i===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");i=e[Symbol.dispose]}if(typeof i!="function")throw new TypeError("Object not disposable.");s.stack.push({value:e,dispose:i,async:t})}else t&&s.stack.push({async:!0});return e}var sv=typeof SuppressedError=="function"?SuppressedError:function(s,e,t){var i=new Error(t);return i.name="SuppressedError",i.error=s,i.suppressed=e,i};function Ef(s){function e(i){s.error=s.hasError?new sv(i,s.error,"An error was suppressed during disposal."):i,s.hasError=!0}function t(){for(;s.stack.length;){var i=s.stack.pop();try{var n=i.dispose&&i.dispose.call(i.value);if(i.async)return Promise.resolve(n).then(t,function(r){return e(r),t()})}catch(r){e(r)}}if(s.hasError)throw s.error}return t()}const $s=$0(Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:Af,get __assign(){return yl},__asyncDelegator:pf,__asyncGenerator:ff,__asyncValues:mf,__await:ho,__awaiter:af,__classPrivateFieldGet:bf,__classPrivateFieldIn:xf,__classPrivateFieldSet:yf,__createBinding:xl,__decorate:sf,__disposeResources:Ef,__esDecorate:J0,__exportStar:cf,__extends:tf,__generator:lf,__importDefault:vf,__importStar:_f,__makeTemplateObject:gf,__metadata:of,__param:rf,__propKey:tv,__read:ch,__rest:nf,__runInitializers:ev,__setFunctionName:iv,__spread:hf,__spreadArray:uf,__spreadArrays:df,__values:Al,default:{__extends:tf,__assign:yl,__rest:nf,__decorate:sf,__param:rf,__metadata:of,__awaiter:af,__generator:lf,__createBinding:xl,__exportStar:cf,__values:Al,__read:ch,__spread:hf,__spreadArrays:df,__spreadArray:uf,__await:ho,__asyncGenerator:ff,__asyncDelegator:pf,__asyncValues:mf,__makeTemplateObject:gf,__importStar:_f,__importDefault:vf,__classPrivateFieldGet:bf,__classPrivateFieldSet:yf,__classPrivateFieldIn:xf,__addDisposableResource:Af,__disposeResources:Ef}},Symbol.toStringTag,{value:"Module"})));var hh={},wf;function rv(){return wf||(wf=1,Object.defineProperty(hh,"__esModule",{value:!0})),hh}var qo={},Sf;function El(){if(Sf)return qo;Sf=1,Object.defineProperty(qo,"__esModule",{value:!0}),qo.Signal=void 0;var s=$s,e=function(){function i(){this.handlers=[]}return Object.defineProperty(i.prototype,"hasHandlers",{get:function(){return this.handlers.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"handlersAmount",{get:function(){return this.handlers.length},enumerable:!1,configurable:!0}),i.prototype.connect=function(n,r){r===void 0&&(r=0);var o=this.handlers.find(function(d){return d.equals(n)}),l;if(o!==void 0)l=o.priority!==r,o.priority=r;else{var c=this.handlers[this.handlers.length-1];this.handlers.push(new t(n,r)),l=c!==void 0&&c.priority>r}l&&this.handlers.sort(function(d,u){return d.priority-u.priority})},i.prototype.disconnect=function(n){var r=this.handlers.findIndex(function(o){return o.equals(n)});r>=0&&this.handlers.splice(r,1)},i.prototype.disconnectAll=function(){this.handlers.length=0},i.prototype.emit=function(){for(var n,r,o=[],l=0;l<arguments.length;l++)o[l]=arguments[l];try{for(var c=s.__values(this.handlers),d=c.next();!d.done;d=c.next()){var u=d.value;u.handle.apply(u,s.__spreadArray([],s.__read(o),!1))}}catch(h){n={error:h}}finally{try{d&&!d.done&&(r=c.return)&&r.call(c)}finally{if(n)throw n.error}}},i}();qo.Signal=e;var t=function(){function i(n,r){this.handler=n,this.priority=r}return i.prototype.equals=function(n){return this.handler===n},i.prototype.handle=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];this.handler.apply(this,s.__spreadArray([],s.__read(n),!1))},i}();return qo}var Ar={},Tf;function dh(){if(Tf)return Ar;Tf=1,Object.defineProperty(Ar,"__esModule",{value:!0}),Ar.getComponentClass=Ar.getComponentId=void 0;function s(n,r){if(r===void 0&&(r=!1),n.hasOwnProperty(t))return n[t];if(r)return n[t]=i++}Ar.getComponentId=s;function e(n,r){var o=Object.getPrototypeOf(n).constructor;if(r){if(!(n instanceof r||o===r))throw new Error("Resolve class should be an ancestor of component class");o=r}return o}Ar.getComponentClass=e;var t="__componentClassId__",i=1;return Ar}var Yo={},Mf;function uh(){if(Mf)return Yo;Mf=1,Object.defineProperty(Yo,"__esModule",{value:!0}),Yo.isTag=void 0;function s(e){var t=typeof e;return t==="string"||t==="number"}return Yo.isTag=s,Yo}var Er={},Pf;function fh(){if(Pf)return Er;Pf=1,Object.defineProperty(Er,"__esModule",{value:!0}),Er.isLinkedComponent=Er.LinkedComponent=void 0;var s=function(){function t(i){this.id=i,this.next=void 0}return t}();Er.LinkedComponent=s;function e(t){return t!==void 0&&t.hasOwnProperty("next")}return Er.isLinkedComponent=e,Er}var Qo={},wr={},Ko={},Cf;function ov(){if(Cf)return Ko;Cf=1,Object.defineProperty(Ko,"__esModule",{value:!0}),Ko.LinkedComponentList=void 0;var s=$s,e=function(){function t(){}return Object.defineProperty(t.prototype,"head",{get:function(){return this._head},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isEmpty",{get:function(){return this._head===void 0},enumerable:!1,configurable:!0}),t.prototype.add=function(i){for(var n=void 0,r=this._head;r!==void 0;){if(r===i)throw new Error("Component is already appended, appending it once again will break linked items order");n=r,r=r.next}this._head===void 0?this._head=i:n.next=i},t.prototype.remove=function(i){var n=s.__read(this.find(i),2),r=n[0],o=n[1];return o===void 0?!1:(r===void 0?this._head=o.next:r.next=o.next,!0)},t.prototype.nodes=function(){var i;return s.__generator(this,function(n){switch(n.label){case 0:i=this.head,n.label=1;case 1:return i===void 0?[3,3]:[4,i];case 2:return n.sent(),i=i.next,[3,1];case 3:return[2]}})},t.prototype.iterate=function(i){var n,r;try{for(var o=s.__values(this.nodes()),l=o.next();!l.done;l=o.next()){var c=l.value;i(c)}}catch(d){n={error:d}}finally{try{l&&!l.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}},t.prototype.clear=function(){this._head=void 0},t.prototype.find=function(i){for(var n,r=this._head;r!==void 0;){if(r===i)return[n,r];n=r,r=r.next}return[void 0,void 0]},t}();return Ko.LinkedComponentList=e,Ko}var Rf;function ph(){if(Rf)return wr;Rf=1,Object.defineProperty(wr,"__esModule",{value:!0}),wr.EntitySnapshot=wr.Entity=void 0;var s=$s,e=dh(),t=El(),i=uh(),n=fh(),r=ov(),o=function(){function d(){this.onComponentAdded=new t.Signal,this.onComponentRemoved=new t.Signal,this.onInvalidationRequested=new t.Signal,this.id=c++,this._components={},this._linkedComponents={},this._tags=new Set}return Object.defineProperty(d.prototype,"components",{get:function(){return this._components},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"tags",{get:function(){return this._tags},enumerable:!1,configurable:!0}),d.prototype.add=function(u,h){return(0,i.isTag)(u)?this.addTag(u):this.addComponent(u,h),this},d.prototype.append=function(u,h){return this.appendComponent(u,h)},d.prototype.withdraw=function(u){var h=this.get(u);if(h!==void 0)return(0,n.isLinkedComponent)(h)?this.withdrawComponent(h,u):this.remove(u)},d.prototype.pick=function(u,h){if(typeof h=="string"){var f=this.find(u,function(p){return(0,n.isLinkedComponent)(p)&&p.id===h});return(0,n.isLinkedComponent)(f)?this.withdrawComponent(f,u):void 0}return(0,n.isLinkedComponent)(u)?this.withdrawComponent(u,h):this.remove(h!=null?h:(0,e.getComponentClass)(u))},d.prototype.addComponent=function(u,h){var f=(0,e.getComponentClass)(u,h),p=(0,e.getComponentId)(f,!0),m=(0,n.isLinkedComponent)(u);if(this._components[p]!==void 0){if(!m&&u===this._components[p])return;this.remove(f)}m?this.append(u,h):(this._components[p]=u,this.dispatchOnComponentAdded(u))},d.prototype.appendComponent=function(u,h){var f=(0,e.getComponentClass)(u,h),p=(0,e.getComponentId)(f,!0),m=this.getLinkedComponentList(p);return m.add(u),this._components[p]===void 0&&(this._components[p]=m.head),this.dispatchOnComponentAdded(u),this},d.prototype.addTag=function(u){this._tags.has(u)||(this._tags.add(u),this.dispatchOnComponentAdded(u))},d.prototype.has=function(u,h){return(0,i.isTag)(u)?this.hasTag(u):this.hasComponent(u,h)},d.prototype.contains=function(u,h){var f=(0,e.getComponentClass)(u,h);return(0,n.isLinkedComponent)(u)?this.find(f,function(p){return p===u})!==void 0:this.get(f)===u},d.prototype.hasComponent=function(u,h){return this.get(u,h)!==void 0},d.prototype.hasTag=function(u){return this._tags.has(u)},d.prototype.hasAny=function(){for(var u=this,h=[],f=0;f<arguments.length;f++)h[f]=arguments[f];return h.some(function(p){return u.has(p)})},d.prototype.hasAll=function(){for(var u=this,h=[],f=0;f<arguments.length;f++)h[f]=arguments[f];return h.every(function(p){return u.has(p)})},d.prototype.get=function(u,h){var f=(0,e.getComponentId)(u);if(f!==void 0){var p=this._components[f];if(h!==void 0){if((0,n.isLinkedComponent)(p))for(;p!==void 0;){if(p.id===h)return p;p=p.next}return}return this._components[f]}},d.prototype.getComponents=function(){return Array.from(Object.values(this._components))},d.prototype.getTags=function(){return Array.from(this._tags)},d.prototype.remove=function(u){if((0,i.isTag)(u)){this.removeTag(u);return}return this.removeComponent(u)},d.prototype.removeComponent=function(u){var h=(0,e.getComponentId)(u);if(!(h===void 0||this._components[h]===void 0)){var f=this._components[h];if((0,n.isLinkedComponent)(f))for(var p=this.getLinkedComponentList(u);!p.isEmpty;)this.withdraw(u);else delete this._components[h],this.dispatchOnComponentRemoved(f);return f}},d.prototype.removeTag=function(u){this._tags.has(u)&&(this._tags.delete(u),this.dispatchOnComponentRemoved(u))},d.prototype.clear=function(){this._components={},this._linkedComponents={},this._tags.clear()},d.prototype.copyFrom=function(u){return this._components=Object.assign({},u._components),this._linkedComponents=Object.assign({},u._linkedComponents),this._tags=new Set(u._tags),this},d.prototype.iterate=function(u,h){var f;this.hasComponent(u)&&((f=this.getLinkedComponentList(u))===null||f===void 0||f.iterate(h))},d.prototype.getAll=function(u){var h;return s.__generator(this,function(f){switch(f.label){case 0:return this.hasComponent(u)?(h=this.getLinkedComponentList(u,!1),h===void 0?[2,void 0]:[5,s.__values(h.nodes())]):[2];case 1:return f.sent(),[2]}})},d.prototype.find=function(u,h){var f=(0,e.getComponentId)(u,!1);if(f!==void 0){var p=this._components[f];if(p!==void 0)if((0,n.isLinkedComponent)(p))for(var m=p;m!==void 0;){if(h(m))return m;m=m.next}else return h(p)?p:void 0}},d.prototype.lengthOf=function(u){var h=0;return this.iterate(u,function(){h++}),h},d.prototype.invalidate=function(){this.onInvalidationRequested.emit(this)},d.prototype.takeSnapshot=function(u,h,f){var p=u.previous;if(u.current!==this&&(u.current=this,p.copyFrom(this)),h!==void 0)if((0,i.isTag)(h)){var m=p._tags;this.has(h)?m.delete(h):m.add(h)}else{var b=f!=null?f:Object.getPrototypeOf(h).constructor,_=(0,e.getComponentId)(b,!0),y=p._components;this.has(b)?delete y[_]:y[_]=h}},d.prototype.getLinkedComponentList=function(u,h){return h===void 0&&(h=!0),typeof u!="number"&&(u=(0,e.getComponentId)(u)),this._linkedComponents[u]!==void 0||!h?this._linkedComponents[u]:this._linkedComponents[u]=new r.LinkedComponentList},d.prototype.withdrawComponent=function(u,h){var f=(0,e.getComponentClass)(u,h),p=this.getLinkedComponentList(f,!1);if(!(!this.hasComponent(f)||p===void 0)){var m=p.remove(u)?u:void 0,b=(0,e.getComponentId)(f,!0);return p.isEmpty?(delete this._components[b],delete this._linkedComponents[b]):this._components[b]=p.head,m!==void 0&&this.dispatchOnComponentRemoved(m),m}},d.prototype.dispatchOnComponentAdded=function(u){this.onComponentAdded.hasHandlers&&this.onComponentAdded.emit(this,u)},d.prototype.dispatchOnComponentRemoved=function(u){this.onComponentRemoved.hasHandlers&&this.onComponentRemoved.emit(this,u)},d}();wr.Entity=o;var l=function(){function d(){this._previous=new o}return Object.defineProperty(d.prototype,"current",{get:function(){return this._current},set:function(u){this._current=u},enumerable:!1,configurable:!0}),Object.defineProperty(d.prototype,"previous",{get:function(){return this._previous},enumerable:!1,configurable:!0}),d}();wr.EntitySnapshot=l;var c=1;return wr}var Zo={},If;function av(){if(If)return Zo;If=1,Object.defineProperty(Zo,"__esModule",{value:!0}),Zo.Subscription=void 0;var s=function(){function e(t,i){this.messageType=t,this.handler=i}return e.prototype.equals=function(t,i){return this.messageType===t&&(i===void 0||this.handler===i)},e}();return Zo.Subscription=s,Zo}var Df;function lv(){if(Df)return Qo;Df=1,Object.defineProperty(Qo,"__esModule",{value:!0}),Qo.Engine=void 0;var s=$s,e=ph(),t=av(),i=El(),n=function(){function r(){var o=this;this.onEntityAdded=new i.Signal,this.onEntityRemoved=new i.Signal,this._entityMap=new Map,this._entities=[],this._systems=[],this._queries=[],this._subscriptions=[],this._sharedConfig=new e.Entity,this.onComponentAdded=function(l,c,d){o._queries.forEach(function(u){return u.entityComponentAdded(l,c,d)})},this.onInvalidationRequested=function(l){o._queries.forEach(function(c){return c.validateEntity(l)})},this.onComponentRemoved=function(l,c,d){o._queries.forEach(function(u){return u.entityComponentRemoved(l,c,d)})},this.connectEntity(this._sharedConfig)}return Object.defineProperty(r.prototype,"entities",{get:function(){return Array.from(this._entities)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"systems",{get:function(){return this._systems},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"queries",{get:function(){return this._queries},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"subscriptions",{get:function(){return this._subscriptions},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"sharedConfig",{get:function(){return this._sharedConfig},enumerable:!1,configurable:!0}),r.prototype.addEntity=function(o){return this._entityMap.has(o.id)?this:(this._entities.push(o),this._entityMap.set(o.id,o),this.onEntityAdded.emit(o),this.connectEntity(o),this)},r.prototype.removeEntity=function(o){if(!this._entityMap.has(o.id))return this;var l=this._entities.indexOf(o);return this._entities.splice(l,1),this._entityMap.delete(o.id),this.onEntityRemoved.emit(o),this.disconnectEntity(o),this},r.prototype.removeSystem=function(o){var l=this._systems.indexOf(o);return l===-1?this:(this._systems.splice(l,1),o.onRemovedFromEngine(),o.setEngine(void 0),this)},r.prototype.getEntityById=function(o){return this._entityMap.get(o)},r.prototype.getSystem=function(o){return this._systems.find(function(l){return l instanceof o})},r.prototype.removeAllSystems=function(){var o,l,c=this._systems;this._systems=[];try{for(var d=s.__values(c),u=d.next();!u.done;u=d.next()){var h=u.value;h.onRemovedFromEngine()}}catch(f){o={error:f}}finally{try{u&&!u.done&&(l=d.return)&&l.call(d)}finally{if(o)throw o.error}}},r.prototype.removeAllQueries=function(){var o,l,c=this._queries;this._queries=[];try{for(var d=s.__values(c),u=d.next();!u.done;u=d.next()){var h=u.value;this.disconnectQuery(h),h.clear()}}catch(f){o={error:f}}finally{try{u&&!u.done&&(l=d.return)&&l.call(d)}finally{if(o)throw o.error}}},r.prototype.removeAllEntities=function(){this.removeAllEntitiesInternal(!1)},r.prototype.clear=function(){this.removeAllEntitiesInternal(!0),this.removeAllSystems(),this.removeAllQueries()},r.prototype.update=function(o){var l,c;try{for(var d=s.__values(this._systems),u=d.next();!u.done;u=d.next()){var h=u.value;h.update(o),h.isRemovalRequested&&this.removeSystem(h)}}catch(f){l={error:f}}finally{try{u&&!u.done&&(c=d.return)&&c.call(d)}finally{if(l)throw l.error}}},r.prototype.addQuery=function(o){return this.connectQuery(o),o.matchEntities(this.entities),this._queries[this._queries.length]=o,this},r.prototype.addSystem=function(o,l){if(l===void 0&&(l=0),o.setPriority(l),this._systems.length===0)this._systems[0]=o;else{var c=this._systems.findIndex(function(d){return d.priority>l});c===-1?this._systems[this._systems.length]=o:this._systems.splice(c,0,o)}return o.setEngine(this),o.onAddedToEngine(),this},r.prototype.removeQuery=function(o){var l=this._queries.indexOf(o);if(l!=-1)return this._queries.splice(l,1),this.disconnectQuery(o),o.clear(),this},r.prototype.subscribe=function(o,l){this.addSubscription(o,l)},r.prototype.unsubscribe=function(o,l){this.removeSubscription(o,l)},r.prototype.unsubscribeAll=function(){this._subscriptions.length=0},r.prototype.addSubscription=function(o,l){var c,d;try{for(var u=s.__values(this._subscriptions),h=u.next();!h.done;h=u.next()){var f=h.value;if(f.equals(o,l))return f}}catch(m){c={error:m}}finally{try{h&&!h.done&&(d=u.return)&&d.call(u)}finally{if(c)throw c.error}}var p=new t.Subscription(o,l);return this._subscriptions.push(p),p},r.prototype.removeSubscription=function(o,l){for(var c=this._subscriptions.length;--c>=0;){var d=this._subscriptions[c];if(d.equals(o,l)&&(this._subscriptions.splice(c,1),l!==void 0))return}},r.prototype.dispatch=function(o){var l,c;try{for(var d=s.__values(this._subscriptions),u=d.next();!u.done;u=d.next()){var h=u.value;(typeof h.messageType=="function"&&o instanceof h.messageType||o===h.messageType)&&h.handler(o)}}catch(f){l={error:f}}finally{try{u&&!u.done&&(c=d.return)&&c.call(d)}finally{if(l)throw l.error}}},r.prototype.connectEntity=function(o){o.onComponentAdded.connect(this.onComponentAdded,Number.POSITIVE_INFINITY),o.onComponentRemoved.connect(this.onComponentRemoved,Number.POSITIVE_INFINITY),o.onInvalidationRequested.connect(this.onInvalidationRequested,Number.NEGATIVE_INFINITY)},r.prototype.disconnectEntity=function(o){o.onComponentAdded.disconnect(this.onComponentAdded),o.onComponentRemoved.disconnect(this.onComponentRemoved),o.onInvalidationRequested.disconnect(this.onInvalidationRequested)},r.prototype.connectQuery=function(o){this.onEntityAdded.connect(o.entityAdded),this.onEntityRemoved.connect(o.entityRemoved)},r.prototype.disconnectQuery=function(o){this.onEntityAdded.disconnect(o.entityAdded),this.onEntityRemoved.disconnect(o.entityRemoved)},r.prototype.removeAllEntitiesInternal=function(o){var l,c,d=this._entities;this._entities=[],this._entityMap.clear();try{for(var u=s.__values(d),h=u.next();!h.done;h=u.next()){var f=h.value;o||this.onEntityRemoved.emit(f),this.disconnectEntity(f)}}catch(p){l={error:p}}finally{try{h&&!h.done&&(c=u.return)&&c.call(u)}finally{if(l)throw l.error}}},r}();return Qo.Engine=n,Qo}var $o={},Lf;function Ff(){if(Lf)return $o;Lf=1,Object.defineProperty($o,"__esModule",{value:!0}),$o.System=void 0;var s=function(){function e(){this._priority=0,this._isRemovalRequested=!1}return Object.defineProperty(e.prototype,"engine",{get:function(){if(this._engine===void 0)throw new Error(`Property "engine" can't be accessed when system is not added to the engine`);return this._engine},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isRemovalRequested",{get:function(){return this._isRemovalRequested},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sharedConfig",{get:function(){if(this._engine===void 0)throw new Error(`Property "sharedConfig" can't be accessed when system is not added to the engine`);return this._engine.sharedConfig},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"priority",{get:function(){return this._priority},enumerable:!1,configurable:!0}),e.prototype.update=function(t){},e.prototype.onAddedToEngine=function(){},e.prototype.onRemovedFromEngine=function(){},e.prototype.dispatch=function(t){if(this._engine===void 0)throw new Error("Dispatching a message can't be done while system is not attached to the engine");this.engine.dispatch(t)},e.prototype.setEngine=function(t){this._engine=t},e.prototype.setPriority=function(t){this._priority=t},e.prototype.requestRemoval=function(){this._isRemovalRequested=!0},e}();return $o.System=s,$o}var Hn={},Of;function Bf(){if(Of)return Hn;Of=1,Object.defineProperty(Hn,"__esModule",{value:!0}),Hn.isQueryBuilder=Hn.isQueryPredicate=Hn.QueryBuilder=Hn.Query=void 0;var s=$s,e=dh(),t=ph(),i=uh(),n=El(),r=fh(),o=function(){function h(f){var p=this;this.onEntityAdded=new n.Signal,this.onEntityRemoved=new n.Signal,this._helper=new t.Entity,this._snapshot=new t.EntitySnapshot,this._entities=[],this.entityAdded=function(m){var b=p._entities.indexOf(m);b===-1&&p._predicate(m)&&(p._entities.push(m),p.onEntityAdded.hasHandlers&&(m.takeSnapshot(p._snapshot),p.onEntityAdded.emit(p._snapshot)))},this.entityRemoved=function(m){var b=p._entities.indexOf(m);b!==-1&&(p._entities.splice(b,1),p.onEntityRemoved.hasHandlers&&(m.takeSnapshot(p._snapshot),p.onEntityRemoved.emit(p._snapshot)))},this.entityComponentAdded=function(m,b,_){var y=p.onEntityAdded.hasHandlers,A=p.onEntityRemoved.hasHandlers;p.updateHelper(m,b,_);var T=p._entities.indexOf(m),M=p._predicate(p._helper);T===-1&&M?(p._entities.push(m),y&&(m.takeSnapshot(p._snapshot,b,_),p.onEntityAdded.emit(p._snapshot))):T!==-1&&!M&&(p._entities.splice(T,1),A&&(m.takeSnapshot(p._snapshot,b,_),p.onEntityRemoved.emit(p._snapshot)))},this.entityComponentRemoved=function(m,b,_){var y=p.onEntityAdded.hasHandlers,A=p.onEntityRemoved.hasHandlers;p.updateHelper(m,b,_);var T=p._entities.indexOf(m);T!==-1&&p._predicate(p._helper)&&!p._predicate(m)?(p._entities.splice(T,1),A&&(m.takeSnapshot(p._snapshot,b,_),p.onEntityRemoved.emit(p._snapshot))):T===-1&&p._predicate(m)&&!p._predicate(p._helper)&&(p._entities.push(m),y&&(m.takeSnapshot(p._snapshot,b,_),p.onEntityAdded.emit(p._snapshot)))},this._predicate=f}return Object.defineProperty(h.prototype,"entities",{get:function(){return this._entities},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"first",{get:function(){if(this._entities.length!==0)return this._entities[0]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"last",{get:function(){if(this._entities.length!==0)return this._entities[this._entities.length-1]},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"length",{get:function(){return this._entities.length},enumerable:!1,configurable:!0}),h.prototype.countBy=function(f){var p,m,b=0;try{for(var _=s.__values(this._entities),y=_.next();!y.done;y=_.next()){var A=y.value;f(A)&&b++}}catch(T){p={error:T}}finally{try{y&&!y.done&&(m=_.return)&&m.call(_)}finally{if(p)throw p.error}}return b},h.prototype.find=function(f){return this._entities.find(f)},h.prototype.filter=function(f){return this._entities.filter(f)},h.prototype.has=function(f){return this._entities.indexOf(f)!==-1},h.prototype.matchEntities=function(f){var p=this;f.forEach(function(m){return p.entityAdded(m)})},Object.defineProperty(h.prototype,"isEmpty",{get:function(){return this.entities.length==0},enumerable:!1,configurable:!0}),h.prototype.clear=function(){this._entities=[]},h.prototype.validateEntity=function(f){var p=this.entities.indexOf(f),m=this._predicate(f);p!==-1&&!m?this.entityRemoved(f):this.entityAdded(f)},h.prototype.updateHelper=function(f,p,m){this._helper.clear(),this._helper.copyFrom(f),(0,r.isLinkedComponent)(p)?this._helper.has((0,e.getComponentClass)(p,m))||this._helper.append(p):this._helper.add(p)},h}();Hn.Query=o;function l(h,f,p){var m,b,_,y;if(f.size>0)try{for(var A=s.__values(f),T=A.next();!T.done;T=A.next()){var M=T.value;if(h.components[M]===void 0)return!1}}catch(q){m={error:q}}finally{try{T&&!T.done&&(b=A.return)&&b.call(A)}finally{if(m)throw m.error}}if(p.size>0)try{for(var C=s.__values(p),N=C.next();!N.done;N=C.next()){var O=N.value;if(!h.tags.has(O))return!1}}catch(q){_={error:q}}finally{try{N&&!N.done&&(y=C.return)&&y.call(C)}finally{if(_)throw _.error}}return!0}var c=function(){function h(){this._components=new Set,this._tags=new Set}return h.prototype.contains=function(){for(var f,p,m=[],b=0;b<arguments.length;b++)m[b]=arguments[b];try{for(var _=s.__values(m),y=_.next();!y.done;y=_.next()){var A=y.value;if((0,i.isTag)(A))this._tags.has(A)||this._tags.add(A);else{var T=(0,e.getComponentId)(A,!0);this._components.has(T)||this._components.add(T)}}}catch(M){f={error:M}}finally{try{y&&!y.done&&(p=_.return)&&p.call(_)}finally{if(f)throw f.error}}return this},h.prototype.build=function(){var f=this;return new o(function(p){return l(p,f._components,f._tags)})},h.prototype.getComponents=function(){return this._components},h.prototype.getTags=function(){return this._tags},h}();Hn.QueryBuilder=c;function d(h){return typeof h=="function"}Hn.isQueryPredicate=d;function u(h){return h instanceof c}return Hn.isQueryBuilder=u,Hn}var Jo={},ea={},Nf;function kf(){if(Nf)return ea;Nf=1,Object.defineProperty(ea,"__esModule",{value:!0}),ea.ReactionSystem=void 0;var s=$s,e=Bf(),t=Ff(),i=function(n){s.__extends(r,n);function r(o){var l=n.call(this)||this;return l.entityAdded=function(c){},l.entityRemoved=function(c){},(0,e.isQueryBuilder)(o)?l.query=o.build():(0,e.isQueryPredicate)(o)?l.query=new e.Query(o):l.query=o,l}return Object.defineProperty(r.prototype,"entities",{get:function(){return this.query.entities},enumerable:!1,configurable:!0}),r.prototype.onAddedToEngine=function(){this.engine.addQuery(this.query),this.prepare(),this.query.onEntityAdded.connect(this.entityAdded),this.query.onEntityRemoved.connect(this.entityRemoved)},r.prototype.onRemovedFromEngine=function(){this.engine.removeQuery(this.query),this.query.onEntityAdded.disconnect(this.entityAdded),this.query.onEntityRemoved.disconnect(this.entityRemoved),this.query.clear()},r.prototype.prepare=function(){},r}(t.System);return ea.ReactionSystem=i,ea}var Uf;function cv(){if(Uf)return Jo;Uf=1,Object.defineProperty(Jo,"__esModule",{value:!0}),Jo.IterativeSystem=void 0;var s=$s,e=kf(),t=function(i){s.__extends(n,i);function n(r){var o=i.call(this,r)||this;return o._removed=!1,o}return n.prototype.update=function(r){this.updateEntities(r)},n.prototype.onAddedToEngine=function(){this._removed=!1,i.prototype.onAddedToEngine.call(this)},n.prototype.onRemovedFromEngine=function(){this._removed=!0,i.prototype.onRemovedFromEngine.call(this)},n.prototype.updateEntities=function(r){var o,l;try{for(var c=s.__values(this.query.entities),d=c.next();!d.done;d=c.next()){var u=d.value;if(this._removed)return;this.updateEntity(u,r)}}catch(h){o={error:h}}finally{try{d&&!d.done&&(l=c.return)&&l.call(c)}finally{if(o)throw o.error}}},n}(e.ReactionSystem);return Jo.IterativeSystem=t,Jo}(function(s){Object.defineProperty(s,"__esModule",{value:!0});var e=$s;e.__exportStar(rv(),s),e.__exportStar(El(),s),e.__exportStar(dh(),s),e.__exportStar(uh(),s),e.__exportStar(fh(),s),e.__exportStar(lv(),s),e.__exportStar(ph(),s),e.__exportStar(Ff(),s),e.__exportStar(Bf(),s),e.__exportStar(cv(),s),e.__exportStar(kf(),s)})(ci);class mh{}class gh{constructor(e,t){a(this,"appendCode");a(this,"updateData");this.appendCode=e,this.updateData=t}}class Ci{constructor(){a(this,"drawCall",new q0);a(this,"perObjectUpdaters",new Array)}}class zf{constructor(e,t){a(this,"lightmap");a(this,"reflectionProbes");this.lightmap=e,t&&(this.reflectionProbes=[...t])}}class Sr{constructor(){a(this,"materialComp");a(this,"meshComp");a(this,"renderComp");a(this,"lightingComp");a(this,"boundsComp")}}class wl{constructor(e){a(this,"idsToResources",new Map);a(this,"unusedResources",new Set);a(this,"resourcesEnv");this.resourcesEnv=e,Ni.registerIfEnabled(this,this.onDebugUI)}acquireResourceAndIncRef(e,t){const i=e.getId();let n=this.idsToResources.get(i);if(n)return n.refCounter++,n;if(n=new t,n.refCounter=1,n.id=i,this.idsToResources.set(i,n),n.load(e,this.resourcesEnv))return this.onResourceLoaded(e,n),n}onResourceLoaded(e,t){}unuseResourceAndDecRef(e){--e.refCounter===0&&this.unusedResources.add(e)}removeResource(e){e.unload(this.resourcesEnv),e.refCounter=0,this.idsToResources.delete(e.id),this.unusedResources.delete(e)}removeAllResources(){for(const e of this.idsToResources.values())e.unload(this.resourcesEnv),e.refCounter=0;this.idsToResources.clear(),this.unusedResources.clear()}updateManager(){this.garbageCollect(this.resourcesEnv)}garbageCollect(e){this.unusedResources.forEach(t=>{t.refCounter===0&&(t.unload(e),this.idsToResources.delete(t.id))}),this.unusedResources.clear()}onDebugUI(){}}class Sl{constructor(e,t,i){a(this,"lightmapId");a(this,"reflectionProbes");a(this,"envMapMirror");this.lightmapId=e,this.reflectionProbes=t?t.filter(n=>n):[],this.lightmapId<256,this.reflectionProbes.forEach(n=>{n.id<256}),this.envMapMirror=i}getId(){return Sl.generateIdAsBitmask(this.lightmapId,this.reflectionProbes,this.envMapMirror)}static generateIdAsBitmask(e,t,i){let n=0,r=0;const o=8;for(let l=0;l<D.MAX_BLENDED_REFLECTION_PROBES;l++)l<t.length&&(n|=t[l].id<<r),r+=o;return e>=0&&(n|=e<<r),r+=o,i&&(n|=1<<r),n}}class hv{constructor(){a(this,"boxMin",new Lt);a(this,"boxMax",new Lt);a(this,"posW",new Lt)}set(e,t,i){this.boxMin.set(e.x,e.y,e.z,0),this.boxMax.set(t.x,t.y,t.z,0),this.posW.set(i.x,i.y,i.z,0)}setZeros(){this.boxMax.set(0,0,0,0),this.boxMin.set(0,0,0,0),this.posW.set(0,0,0,0)}}class dv{constructor(){a(this,"lightmapSize",new Lt);a(this,"lightmapThreshold",new Lt);a(this,"reflectionProbes",new Array(D.MAX_BLENDED_REFLECTION_PROBES))}}class Vf{constructor(){a(this,"refCounter",0);a(this,"id",0);a(this,"uniformBuffer");a(this,"lightmap");a(this,"descriptor");a(this,"envMaps",[])}load(e,t){return this.descriptor=e,e.lightmapId>=0&&(this.lightmap=t.getLightmap(e.lightmapId),this.lightmap,void 0),this.uniformBuffer||(this.uniformBuffer=new vl(t.renderDevice.getGl())),this.updateUniformBuffer(t.renderDevice.getGl(),t.getLightUniformBlockDescriptor()),this.resetEnvMaps(),!0}resetEnvMaps(){this.envMaps=[];for(const e of this.descriptor.reflectionProbes)this.descriptor.envMapMirror?this.envMaps.push(e.getMirrorTexture()):this.envMaps.push(e.getFilteredTexture())}updateUniformBuffer(e,t){this.uniformBuffer;const i=new dv;if(this.lightmap){const r=this.lightmap;i.lightmapSize.set(r.width,r.height,1/r.width,1/r.height),i.lightmapThreshold.set(r.ycocgmThreshold,(1-r.ycocgmThreshold)/(16-3),0,0)}else i.lightmapSize.set(0,0,0,0),i.lightmapThreshold.set(0,0,0,0);const n=this.descriptor.reflectionProbes;for(let r=0;r<D.MAX_BLENDED_REFLECTION_PROBES;r++)i.reflectionProbes[r]=new hv,r<n.length?i.reflectionProbes[r].set(n[r].boxMin,n[r].boxMax,n[r].position):i.reflectionProbes[r].setZeros();this.uniformBuffer.update(i,t,e)}unload(e){this.uniformBuffer&&this.uniformBuffer.unload(e.renderDevice.getGl()),this.lightmap=void 0}}class uv extends wl{constructor(){super(...arguments);a(this,"lightmapsToIds",new Map);a(this,"idsToLightmaps",new Map);a(this,"lightmapCounter",0)}refreshReflectionProbeTextures(){for(const t of this.idsToResources.values())t.resetEnvMaps()}onTextureUploaded(t,i){for(const n of this.idsToResources.values())n.lightmap===t&&n.updateUniformBuffer(i.renderDevice.getGl(),i.getLightUniformBlockDescriptor())}getLightDataBindingDescriptor(t,i,n){let r;return t&&(r=this.lightmapsToIds.get(t),r===void 0&&(r=this.lightmapCounter++,this.lightmapsToIds.set(t,r),this.idsToLightmaps.set(r,t))),new Sl(r!=null?r:-1,i,n)}getLightmap(t){return this.idsToLightmaps.get(t)}}const ss=class ss extends wl{constructor(){super(...arguments);a(this,"materialsToUpdate",new Set);a(this,"materialsToRecompile",new Set)}onResourceLoaded(t,i){t.baseMaterial.addEventListener(ss.disposeEventType,this.onMaterialDisposed.bind(this)),t.baseMaterial.addEventListener(ss.recompileEventType,this.updateShaderForMaterial.bind(this)),t.baseMaterial.addEventListener(ss.updatedEventType,this.onMaterialUpdated.bind(this))}updateShaderForMaterial(t){this.materialsToRecompile.add(t.target)}onMaterialDisposed(t){const i=t.target,n=this.idsToResources.get(i.id);ye(n),this.removeResource(n),i.removeEventListener(ss.disposeEventType,this.onMaterialDisposed.bind(this)),i.removeEventListener(ss.recompileEventType,this.updateShaderForMaterial.bind(this)),i.removeEventListener(ss.updatedEventType,this.onMaterialUpdated.bind(this))}refreshAllMaterials(){for(const t of this.idsToResources.values())t.descriptor&&(t.unload(this.resourcesEnv),t.load(t.descriptor,this.resourcesEnv))}updateManager(){this.compileUpdatedShaders(),super.updateManager()}onMaterialUpdated(t){this.materialsToUpdate.add(t.target)}compileUpdatedShaders(){for(const i of this.materialsToRecompile){const n=this.idsToResources.get(i.id);n&&(n.unload(this.resourcesEnv),n.load(n.descriptor,this.resourcesEnv))}if(this.materialsToRecompile.clear(),this.materialsToUpdate.size===0)return;const t=zn[ve.MATERIAL];for(const i of this.materialsToUpdate){const n=this.idsToResources.get(i.id);if(n&&n.uniformBuffer){const r=this.resourcesEnv.renderDevice.getGl(),o=n.shader.uniformBlockDescriptors.get(t);n.uniformBuffer.update(i.uniformBufferData,o,r)}}this.resourcesEnv.onMaterialsUpdated(this.materialsToUpdate),this.materialsToUpdate.clear()}};a(ss,"updatedEventType","materialUpdated"),a(ss,"recompileEventType","recompile"),a(ss,"disposeEventType","dispose");let _h=ss;class fv extends wl{constructor(){super(...arguments);a(this,"materialUniformBlockDescriptors",new Map);a(this,"globalUniformDescriptor");a(this,"lightUniformDescriptor");a(this,"allBuffersInitialized",!1);a(this,"shaderFilter",new ImGui.StringBuffer(128,""));a(this,"debugUIEnabled",!1)}getGlobalUniformBlockDescriptor(){return this.globalUniformDescriptor,this.globalUniformDescriptor}getLightUniformBlockDescriptor(){return this.lightUniformDescriptor,this.lightUniformDescriptor}onResourceLoaded(t,i){if(this.allBuffersInitialized)return;const n=i.uniformBlockDescriptors;this.globalUniformDescriptor||(this.globalUniformDescriptor=n.get(zn[ve.GLOBAL])),this.lightUniformDescriptor||(this.lightUniformDescriptor=n.get(zn[ve.LIGHT])),this.allBuffersInitialized=this.globalUniformDescriptor!==void 0&&this.lightUniformDescriptor!==void 0}}class pv extends wl{constructor(){super(...arguments);a(this,"geometryIds",new Map);a(this,"currentId",0)}getMeshResourceDescriptor(t){return new oh(t,this.getGeometryId(t))}getGeometryId(t){const i=this.geometryIds.get(t);return i||(this.geometryIds.set(t,this.currentId),this.currentId++)}}class uo extends _t{constructor(){super(),this.overrideMaterial=null,this.autoUpdate=!0}clone(e){return e===void 0&&(e=new uo),_t.prototype.clone.call(this,e),this.overrideMaterial!==null&&(e.overrideMaterial=this.overrideMaterial.clone()),e.autoUpdate=this.autoUpdate,e.matrixAutoUpdate=this.matrixAutoUpdate,e}}function mv(){const s=new Wi,e=new Float32Array([-1,-1,3,-1,-1,3]),t=new Float32Array([0,0,2,0,0,2]);return s.addAttribute("position",new St(e,2)),s.addAttribute("uv0",new St(t,2)),s}class gv{constructor(){a(this,"camera");a(this,"scene");a(this,"material");a(this,"quad")}init(){this.camera=Vi.createNDC(),this.scene=new uo,this.material=new ai({vsName:"fxaa_vertex.glsl",fsName:"fxaa_fragment.glsl"}),this.quad=new Je(mv(),this.material),this.scene.add(this.quad)}}class _v{constructor(){a(this,"unusedRenderTargets",new Map);a(this,"createdRenderTargets",[]);a(this,"viewportWidth",100);a(this,"viewportHeight",100);a(this,"debugCounter",0)}getRenderTarget(e,t){const i=e.getHash();return this.unusedRenderTargets.has(i)&&this.unusedRenderTargets.get(i).length>0?this.unusedRenderTargets.get(i).pop():this.createRenderTarget(e,i,t)}unuseRenderTarget(e){if(this.createdRenderTargets.includes(e)){const t=_l.getHashFromRenderTarget(e);console.assert(this.unusedRenderTargets.has(t),"Invalid params hash or render target! Params hash: "+t),console.assert(!this.unusedRenderTargets.get(t).includes(e),"RenderTarget was already declared as unused!"),this.unusedRenderTargets.get(t).push(e)}}createRenderTarget(e,t,i){const n=i.createRenderTarget(this.viewportWidth,this.viewportHeight,e);return this.createdRenderTargets.push(n),this.unusedRenderTargets.has(t)||this.unusedRenderTargets.set(t,[]),console.assert(this.createdRenderTargets.length<32,"Render targets are leaking! Remaining unused render targets: "+this.unusedRenderTargets.get(t).length),n}onResize(e,t){if(!(this.viewportWidth===e&&this.viewportHeight===t)){this.viewportWidth=e,this.viewportHeight=t;for(const i of this.createdRenderTargets)i.dispose();this.createdRenderTargets=[],this.unusedRenderTargets=new Map}}}class Tl extends kt{}a(Tl,"materialsUpdatedEventType","materialsUpdated");class fo{constructor(e){a(this,"shaderManager");a(this,"materialManager");a(this,"meshManager");a(this,"lightBindingManager");a(this,"renderTargetManager",new _v);a(this,"renderDevice");a(this,"fullscreenRenderHelper",new gv);a(this,"resourcesEvents",new Tl);this.renderDevice=e,this.shaderManager=new fv(this),this.materialManager=new _h(this),this.meshManager=new pv(this),this.lightBindingManager=new uv(this)}acquireResource(e,t,i){const n=bs(e,t);if(i instanceof Qu){n&&this.shaderManager.unuseResourceAndDecRef(n);const r=this.shaderManager.acquireResourceAndIncRef(i,Ku);return r?(an(e,t,r),!0):!1}else if(i instanceof Zu){n&&this.materialManager.unuseResourceAndDecRef(n);const r=this.materialManager.acquireResourceAndIncRef(i,$u);return r?(an(e,t,r),!0):!1}else if(i instanceof oh){n&&this.meshManager.unuseResourceAndDecRef(n);const r=this.meshManager.acquireResourceAndIncRef(i,ef);return r?(an(e,t,r),!0):!1}else if(i instanceof Sl){n&&this.lightBindingManager.unuseResourceAndDecRef(n);const r=this.lightBindingManager.acquireResourceAndIncRef(i,Vf);return r?(an(e,t,r),!0):!1}return!1}unuseResource(e,t){const i=bs(e,t);i&&(i instanceof Ku?this.shaderManager.unuseResourceAndDecRef(i):i instanceof $u?this.materialManager.unuseResourceAndDecRef(i):i instanceof ef?this.meshManager.unuseResourceAndDecRef(i):i instanceof Vf?this.lightBindingManager.unuseResourceAndDecRef(i):ye(!1),an(e,t,void 0))}update(){this.materialManager.updateManager(),this.shaderManager.updateManager(),this.lightBindingManager.updateManager()}getGlobalUniformBlockDescriptor(){return this.shaderManager.getGlobalUniformBlockDescriptor()}getLightUniformBlockDescriptor(){return this.shaderManager.getLightUniformBlockDescriptor()}getLightmap(e){return this.lightBindingManager.getLightmap(e)}onMaterialsUpdated(e){this.resourcesEvents.dispatchEvent({type:Tl.materialsUpdatedEventType,materials:e})}}class vi{constructor(e,t,i){a(this,"position");a(this,"rotation");a(this,"scale");this.position=e?e.clone():new B(0,0,0),this.rotation=t?t.clone():new xi(1,0,0,1),this.scale=i?i.clone():new B(1,1,1)}}class Js{constructor(e,t=!0){a(this,"osBoundingBox",new Dt);a(this,"wsBoundingBox",new Dt);a(this,"wsSphere",new Tn);a(this,"frustumCulled",!0);this.osBoundingBox.copyFrom(e),this.wsBoundingBox.copyFrom(this.osBoundingBox),this.wsBoundingBox.getBoundingSphere(this.wsSphere),this.frustumCulled=t}}class po{constructor(e,t,i){a(this,"simStateAlpha",0);a(this,"deltaTime",0);a(this,"camera");a(this,"renderGraph");a(this,"renderLists");a(this,"customRender",!1);this.camera=e,this.renderGraph=t,this.renderLists=i}}var vv=Object.defineProperty,bv=Object.getOwnPropertyDescriptor,yv=(s,e,t,i)=>{for(var n=i>1?void 0:i?bv(e,t):e,r=s.length-1,o;r>=0;r--)(o=s[r])&&(n=(i?o(e,t,n):o(n))||n);return i&&n&&vv(e,t,n),n};let mo=class{constructor(s){a(this,"baseMaterial");this.baseMaterial=s}};mo=yv([ao.ImGuiCustomDisplay(s=>{const e=s;e.baseMaterial.name&&ImGui.Text(e.baseMaterial.name),ImGui.Text("VS: "+e.baseMaterial.vertexShaderName+" FS: "+e.baseMaterial.fragmentShaderName)})],mo);class Cs{constructor(e,t){a(this,"geometry");a(this,"threeMesh");this.geometry=e,this.threeMesh=t}}var vh={exports:{}};/**
 * @license BitSet.js v5.1.1 2/1/2020
 * http://www.xarg.org/2014/03/javascript-bit-array/
 *
 * Copyright (c) 2020, Robert Eisele (robert@xarg.org)
 * Dual licensed under the MIT or GPL Version 2 licenses.
 **/(function(s,e){(function(t){var i=32,n=5;function r(h){return h-=h>>>1&1431655765,h=(h&858993459)+(h>>>2&858993459),(h+(h>>>4)&252645135)*16843009>>>24}function o(h,f){for(var p=0,m=0;m<h.length;m++){p*=2;var b=(h[m]+p)/f|0;p=(h[m]+p)%f,h[m]=b}return p}function l(h,f){if(f==null){h.data=[0,0,0,0,0,0,0,0,0,0],h._=0;return}if(f instanceof c){h.data=f.data,h._=f._;return}switch(typeof f){case"number":h.data=[f|0],h._=0;break;case"string":var p=2,m=i;f.indexOf("0b")===0?f=f.substr(2):f.indexOf("0x")===0&&(f=f.substr(2),p=16,m=8),h.data=[],h._=0;var b=f.length-m,_=f.length;do{var y=parseInt(f.slice(b>0?b:0,_),p);if(isNaN(y))throw SyntaxError("Invalid param");if(h.data.push(y|0),b<=0)break;b-=m,_-=m}while(1);break;default:h.data=[0];var A=h.data;if(f instanceof Array){for(var T=f.length-1;T>=0;T--){var M=f[T];M===1/0?h._=-1:(d(h,M),A[M>>>n]|=1<<M)}break}if(Uint8Array&&f instanceof Uint8Array){var C=8;d(h,f.length*C);for(var T=0;T<f.length;T++)for(var N=f[T],O=0;O<C;O++){var q=T*C+O;A[q>>>n]|=(N>>O&1)<<q}break}throw SyntaxError("Invalid param")}}function c(h){if(!(this instanceof c))return new c(h);l(this,h),this.data=this.data.slice()}function d(h,f){for(var p=f>>>n,m=h.data,b=h._,_=m.length;p>=_;p--)m.push(b)}var u={data:[],_:0};c.prototype={data:[],_:0,set:function(h,f){return h|=0,d(this,h),f===void 0||f?this.data[h>>>n]|=1<<h:this.data[h>>>n]&=~(1<<h),this},get:function(h){h|=0;var f=this.data,p=h>>>n;return p>=f.length?this._&1:f[p]>>>h&1},not:function(){for(var h=this.clone(),f=h.data,p=0;p<f.length;p++)f[p]=~f[p];return h._=~h._,h},and:function(h){l(u,h);var f=this.clone(),p=f.data,m=u.data,b=m.length,_=u._,y=f._;y!==0&&d(f,b*i-1);for(var A=p.length,T=Math.min(b,A),M=0;M<T;M++)p[M]&=m[M];for(;M<A;M++)p[M]&=_;return f._&=_,f},or:function(h){l(u,h);for(var f=this.clone(),p=f.data,m=u.data,b=m.length-1,_=p.length-1,y=Math.min(_,b),A=b;A>y;A--)p[A]=m[A];for(;A>=0;A--)p[A]|=m[A];return f._|=u._,f},xor:function(h){l(u,h);var f=this.clone(),p=f.data,m=u.data,b=f._,_=u._,y=0,A=p.length-1,T=m.length-1;for(y=A;y>T;y--)p[y]^=_;for(y=T;y>A;y--)p[y]=b^m[y];for(;y>=0;y--)p[y]^=m[y];return f._^=_,f},andNot:function(h){return this.and(new c(h).flip())},flip:function(h,f){if(h===void 0){for(var p=this.data,m=0;m<p.length;m++)p[m]=~p[m];this._=~this._}else if(f===void 0)d(this,h),this.data[h>>>n]^=1<<h;else if(0<=h&&h<=f){d(this,f);for(var m=h;m<=f;m++)this.data[m>>>n]^=1<<m}return this},clear:function(h,f){var p=this.data;if(h===void 0){for(var m=p.length-1;m>=0;m--)p[m]=0;this._=0}else if(f===void 0)h|=0,d(this,h),p[h>>>n]&=~(1<<h);else if(h<=f){d(this,f);for(var m=h;m<=f;m++)p[m>>>n]&=~(1<<m)}return this},slice:function(h,f){if(h===void 0)return this.clone();if(f===void 0){f=this.data.length*i;var p=Object.create(c.prototype);p._=this._,p.data=[0];for(var m=h;m<=f;m++)p.set(m-h,this.get(m));return p}else if(h<=f&&0<=h){var p=Object.create(c.prototype);p.data=[0];for(var m=h;m<=f;m++)p.set(m-h,this.get(m));return p}return null},setRange:function(h,f,p){for(var m=h;m<=f;m++)this.set(m,p);return this},clone:function(){var h=Object.create(c.prototype);return h.data=this.data.slice(),h._=this._,h},toArray:Math.clz32?function(){for(var h=[],f=this.data,p=f.length-1;p>=0;p--)for(var m=f[p];m!==0;){var b=31-Math.clz32(m);m^=1<<b,h.unshift(p*i+b)}return this._!==0&&h.push(1/0),h}:function(){for(var h=[],f=this.data,p=0;p<f.length;p++)for(var m=f[p];m!==0;){var b=m&-m;m^=b,h.push(p*i+r(b-1))}return this._!==0&&h.push(1/0),h},toString:function(h){var f=this.data;if(h||(h=2),!(h&h-1)&&h<36){for(var p="",m=2+Math.log(4294967295)/Math.log(h)|0,b=f.length-1;b>=0;b--){var _=f[b];_<0&&(_+=4294967296);var y=_.toString(h);p!==""&&(p+="0".repeat(m-y.length-1)),p+=y}return this._===0?(p=p.replace(/^0+/,""),p===""&&(p="0"),p):(p="1111"+p,p.replace(/^1+/,"...1111"))}else{if(2>h||h>36)throw SyntaxError("Invalid base");for(var p=[],A=[],b=f.length;b--;)for(var T=i;T--;)A.push(f[b]>>>T&1);do p.unshift(o(A,h).toString(h));while(!A.every(function(C){return C===0}));return p.join("")}},isEmpty:function(){if(this._!==0)return!1;for(var h=this.data,f=h.length-1;f>=0;f--)if(h[f]!==0)return!1;return!0},cardinality:function(){if(this._!==0)return 1/0;for(var h=0,f=this.data,p=0;p<f.length;p++){var m=f[p];m!==0&&(h+=r(m))}return h},msb:Math.clz32?function(){if(this._!==0)return 1/0;for(var h=this.data,f=h.length;f-- >0;){var p=Math.clz32(h[f]);if(p!==i)return f*i+i-1-p}return 1/0}:function(){if(this._!==0)return 1/0;for(var h=this.data,f=h.length;f-- >0;){var p=h[f],m=0;if(p){for(;(p>>>=1)>0;m++);return f*i+m}}return 1/0},ntz:function(){for(var h=this.data,f=0;f<h.length;f++){var p=h[f];if(p!==0)return p=(p^p-1)>>>1,f*i+r(p)}return 1/0},lsb:function(){for(var h=this.data,f=0;f<h.length;f++){var p=h[f],m=0;if(p){for(var b=p&-p;b>>>=1;m++);return i*f+m}}return this._&1},equals:function(h){l(u,h);var f=this.data,p=u.data,m=this._,b=u._,_=f.length-1,y=p.length-1;if(b!==m)return!1;for(var A=_<y?_:y,T=0;T<=A;T++)if(f[T]!==p[T])return!1;for(T=_;T>y;T--)if(f[T]!==b)return!1;for(T=y;T>_;T--)if(p[T]!==m)return!1;return!0},[Symbol.iterator]:function(){var h=this.data,f=0;if(this._===0){for(var p=0,m=h.length-1;m>=0;m--)if(h[m]!==0){p=m;break}return{next:function(){var b=f>>>n;return{done:b>p||b===p&&h[b]>>>f===0,value:b>p?0:h[b]>>>f++&1}}}}else return{next:function(){var b=f>>>n;return{done:!1,value:b<h.length?h[b]>>>f++&1:1}}}}},c.fromBinaryString=function(h){return new c("0b"+h)},c.fromHexString=function(h){return new c("0x"+h)},c.Random=function(h){(h===void 0||h<0)&&(h=i);for(var f=h%i,p=[],m=Math.ceil(h/i),b=Object.create(c.prototype),_=0;_<m;_++)p.push(Math.random()*4294967296|0);return f>0&&(p[m-1]&=(1<<f)-1),b.data=p,b._=0,b},Object.defineProperty(e,"__esModule",{value:!0}),c.default=c,c.BitSet=c,s.exports=c})()})(vh,vh.exports);var xv=vh.exports;const bh=Z0(xv);class ta{constructor(){a(this,"frustum",new Kr);a(this,"renderListsVisibility",{[li.OPAQUE]:new bh,[li.GRASS]:new bh,[li.TRANSPARENT]:new bh})}}const Rs=[vi,Cs,mo,Js,Ci];class Av extends ci.ReactionSystem{constructor(){super(t=>{for(const i of Rs)if(!t.has(i))return!1;return!0});a(this,"entityRemoved",t=>{const i=this.sharedConfig.get(fo);t.previous.get(Ci).drawCall.unload(i)})}onAddedToEngine(){super.onAddedToEngine(),this.sharedConfig.get(fo).resourcesEvents.addEventListener(Tl.materialsUpdatedEventType,this._onMaterialsUpdated.bind(this))}_onMaterialsUpdated(t){for(const i of this.entities){const r=i.get(Ci).drawCall;if(!r.renderMaterial)continue;const o=r.renderMaterial.descriptor;o&&t.materials.has(o.baseMaterial)&&i.add(new Sr)}}getEntities(){return this.entities}}class yh extends ci.ReactionSystem{constructor(t){super(i=>{if(!i.has(li[t]))return!1;for(const n of Rs)if(!i.has(n))return!1;return!0});a(this,"_renderList",new Y0);a(this,"_renderPass");a(this,"entityAdded",({current:t})=>{const i=t.get(Ci);this._renderList.add(i.drawCall)});a(this,"entityRemoved",t=>{const i=t.previous.get(Ci);i.drawCall.index!==-1&&this._renderList.remove(i.drawCall)});this._renderPass=t,Ni.registerIfEnabled(this,this.onDebugUI)}onDebugUI(){Ni.beginWindow("DrawCall lists",{x:100,y:100},{x:1e3,y:800});const t=this.getEntities();if(ImGui.CollapsingHeader(li[this._renderPass]+": "+t.length)){ImGui.BeginTable("Entity draw calls",7,ImGui.TableFlags.Borders);const i=this.engine.sharedConfig.get(po).camera.get(ta);ImGui.TableHeader("Entity draw calls"),ImGui.TableSetupColumn("Name"),ImGui.TableSetupColumn("DC index"),ImGui.TableSetupColumn("Ent id"),ImGui.TableSetupColumn("Transparent"),ImGui.TableSetupColumn("Visible"),ImGui.TableSetupColumn("VS shader"),ImGui.TableSetupColumn("FS shader"),ImGui.TableHeadersRow();for(const n of t){const r=n.get(Ci),o=n.get(Cs),l=r.drawCall.activeMaterial.transparent,c=r.drawCall.index,d=r.drawCall.renderMaterial.shader;ImGui.TableNextRow(),ImGui.TableNextColumn(),o.threeMesh instanceof As?ImGui.Text(o.threeMesh.node.config.name):ImGui.Text("??"),ImGui.TableNextColumn(),ImGui.Text(""+c),ImGui.TableNextColumn(),ImGui.Text(""+n.id),ImGui.TableNextColumn(),ImGui.Text(l?"true":"false"),ImGui.TableNextColumn();const u=i.renderListsVisibility[this._renderPass].get(c);ImGui.Text(u?"true":"false"),ImGui.TableNextColumn(),d&&d.debugShaderDesc?(ImGui.Text(d.debugShaderDesc.vsName),ImGui.TableNextColumn(),ImGui.Text(d.debugShaderDesc.fsName)):(ImGui.Text(""),ImGui.TableNextColumn(),ImGui.Text(""))}ImGui.EndTable()}Ni.endWindow()}update(t){this._renderList.reindexIfNeeded()}get renderList(){return this._renderList}getEntities(){return this.entities}}class xh extends yh{constructor(){super(li.OPAQUE)}}class Ah extends yh{constructor(){super(li.GRASS)}}class Eh extends yh{constructor(){super(li.TRANSPARENT)}}class Ev extends ci.ReactionSystem{constructor(){super(e=>{if(!e.has(Sr))return!1;for(const t of Rs)if(!e.has(t))return!1;return!0})}update(){var i,n,r,o,l;const e=this.sharedConfig.get(fo),t=this.entities;if(t.length>0)for(let c=t.length-1;c>=0;c--){const d=t[c],u=d.get(Sr),h=(i=u.meshComp)!=null?i:d.get(Cs),f=(n=u.materialComp)!=null?n:d.get(mo),p=(r=u.renderComp)!=null?r:d.get(Ci),m=(o=u.lightingComp)!=null?o:d.get(zf),b=(l=u.boundsComp)!=null?l:d.get(Js);p.drawCall.load(e,h,f,p,m,b);for(let y=0;y<ah;y++)d.remove(li[y]);f.baseMaterial.transparent?d.add(li[li.TRANSPARENT]):d.has(mh)?d.add(li[li.GRASS]):d.add(li[li.OPAQUE]),d.remove(Sr)}}}class Gf{constructor(){a(this,"currentStep",0);a(this,"grassOffsetScaled",1)}}class wv extends ci.ReactionSystem{constructor(){super(t=>{if(!t.has(mh))return!1;for(const i of Rs)if(!t.has(i))return!1;return!0});a(this,"perObjectDataUpdater");a(this,"_dataUploadHelper",new Gf);a(this,"entityAdded",({current:t})=>{t.get(Ci).perObjectUpdaters.push(this.perObjectDataUpdater)});a(this,"entityRemoved",t=>{const i=t.previous.get(Ci),n=i.perObjectUpdaters.indexOf(this.perObjectDataUpdater,0);i.perObjectUpdaters.splice(n,1)});this.perObjectDataUpdater=new gh(this._appendShaderCode.bind(this),this._updatePerObjectData.bind(this))}_updatePerObjectData(t,i){i.loadObject(this._dataUploadHelper)}_appendShaderCode(t){t.generateCodeForObject(this._dataUploadHelper)}}class wh extends xr{constructor(t){super("SceneRender");a(this,"resultPort");a(this,"renderPass");this.resultPort=this.addOutputPort("RenderResult"),this.renderPass=t}render(t){const i=this.acquireConnectedResult(this.resultPort,t);if(i!==void 0){const n=t.getRenderDevice();n.setRenderTarget(i);const r=t.renderWorld.getRenderLists()[this.renderPass],l=t.frameInfo.camera.get(ta).renderListsVisibility[this.renderPass],c=l.msb();if(c===1/0)return;for(let d=0;d<=c;d++){if(!l.get(d))continue;const u=r.sortedList.at(d);t.sharedState.bindDrawCall(u,n),this.renderDrawCall(u,n.getGl())}}}renderDrawCall(t,i){const n=t.mesh,r=i.TRIANGLES;n.indexBufferType!==0?n.instanced?i.drawElementsInstanced(r,n.itemsCount,n.indexBufferType,n.offset,n.instanceCount):i.drawElements(r,n.itemsCount,n.indexBufferType,n.offset):n.instanced?i.drawArraysInstanced(r,n.offset,n.itemsCount,n.instanceCount):i.drawArrays(r,n.offset,n.itemsCount)}}class Sv extends wh{constructor(){super(li.GRASS);a(this,"_dataUploadHelper",new Gf);a(this,"_dataBuffer");a(this,"_dataView");this._dataBuffer=new ArrayBuffer(Ms),this._dataView=new DataView(this._dataBuffer)}renderDrawCall(t,i){t.activeMaterial instanceof Xo;const n=t.activeMaterial,r=zn[ve.OBJECT],o=t.renderMaterial.shader.uniformBlockDescriptors.get(r),l=t.perObjectUniformBuffer;for(let c=0;c<n.renderSteps;c++){const d=n.grassHeight/n.renderSteps*c;this._dataUploadHelper.grassOffsetScaled=d*n.grassScale,this._dataUploadHelper.currentStep=c;for(const u in this._dataUploadHelper)if(Object.prototype.hasOwnProperty.call(this._dataUploadHelper,u)){const h=o.uniforms.get(u);this._dataView.setFloat32(0,bs(this._dataUploadHelper,u),!0),l.uploadSubdataToGPU(this._dataView,h.blockOffset,i)}super.renderDrawCall(t,i)}}}class Tv extends xr{constructor(){super("PrepareRender");a(this,"resultPort");this.resultPort=this.addOutputPort("RenderResult")}render(t){t.sharedState.resetState(),t.sharedState.updateAndBindGlobalUniformData(t);const i=t.getRenderDevice(),n=this.acquireConnectedResult(this.resultPort,t);i.setRenderTarget(n),i.state.setDepthTest(!0),i.state.setDepthWrite(!0),i.state.setColorWrite(!0),i.clearDepth(),i.clearColor(),i.clearStencil(),i.resetCaching()}}class Sh extends xr{constructor(){super("SceneRender");a(this,"resultPort");a(this,"inPort");a(this,"nodes",new Array);a(this,"prepareNode",new Tv);a(this,"opaqueMeshesNode",new wh(li.OPAQUE));a(this,"transparentMeshesNode",new wh(li.TRANSPARENT));a(this,"grassNode",new Sv);this.resultPort=this.addOutputPort("RenderResult"),this.inPort=this.addInputPort("RenderResult"),this.connectToInput(this.prepareNode,"RenderResult"),this.connectToInput(this.opaqueMeshesNode,"RenderResult"),this.connectToInput(this.transparentMeshesNode,"RenderResult"),this.connectToInput(this.grassNode,"RenderResult")}buildOutput(t,i,n){this.needsRebuilding&&(i.addDependency(this.prepareNode,this.opaqueMeshesNode),i.addDependency(this.opaqueMeshesNode,this.grassNode),i.addDependency(this.grassNode,this.transparentMeshesNode)),super.buildOutput(t,i,n)}acquireResult(t,i){const n=this.acquireConnectedResult(this.resultPort,i);this.inPort.result=n}render(t){if(this.inPort.result){const i=t.getRenderDevice(),n=this.inPort.result;n.generateMipmaps&&i.updateRenderTargetMipmap(n),i.getTextureSlotter().freeAllSlots(),i.getGl().bindVertexArray(null)}}}class Mv extends lo{constructor(){super("ScreenRenderTargetNode")}acquireResult(e,t){this.outputs[0].result=this.inputs[0].result=null}unuseResultResources(e,t){}}const Pv={uniforms:{tColor:{type:"t",value:null},tDepth:{type:"t",value:null},tColorPrev:{type:"t",value:null},resolution:{type:"v2",value:new Ue(1/1024,1/512)},projMatrix:{type:"m4",value:new je},invProjMatrix:{type:"m4",value:new je},invViewMatrix:{type:"m4",value:new je},prevProjMatrix:{type:"m4",value:new je},prevViewMatrix:{type:"m4",value:new je},rtSize:{type:"v2",value:new Ue(1,1)},jitterOffset:{type:"v2",value:new Ue(1,1)},temporalWeight:{type:"f",value:.95}},vertexShaderName:"postprocess_vertex.glsl",fragmentShaderName:"temporal_aa_fragment.glsl"};class Cv extends nh{constructor(){super(Pv,"TemporalAARenderNode"),this.addInputPort("RenderResult","tColor"),this.addInputPort("DepthRenderResult","tDepth"),this.addInputPort("PrevRenderResult","tColorPrev"),this.addOutputPort("RenderResult")}update(e){super.update(e);const t=e.frameInfo.camera,i=t.get(Ts),n=t.get(Zs),r=t.get(Gn);this.uniforms.projMatrix.value=i.projectionMatrix.clone(),this.uniforms.invProjMatrix.value=i.invProjMatrix.clone(),this.uniforms.invViewMatrix.value=i.invViewMatrix.clone(),this.uniforms.prevProjMatrix.value=n.prevProjMatrix.clone(),this.uniforms.prevViewMatrix.value=n.prevViewMatrix.clone(),this.uniforms.rtSize.value={x:r.viewportWidth,y:r.viewportHeight};const o=n.temporalJitter.getJitterOffset();this.uniforms.jitterOffset.value={x:o[0],y:o[1]},this.uniforms.temporalWeight.value=t.get(jo).temporalAAWeight}}class Rv extends lo{constructor(t=!1){super("TemporalRenderTargetNode",t);a(this,"prevFramePort");a(this,"prevFrameRenderTarget");this.prevFramePort=this.addOutputPort("PrevRenderResult")}acquireResult(t,i){t===this.prevFramePort?(this.prevFrameRenderTarget||(this.prevFrameRenderTarget=this.prevFramePort.result=i.resourcesEnv.renderTargetManager.getRenderTarget(this.renderTargetParams,i.getRenderDevice())),this.prevFramePort.result=this.prevFrameRenderTarget):super.acquireResult(t,i)}unuseResultResources(t,i){this.inputs[0].requestCounter===0&&this.outputs[0].requestCounter===0&&(!this.renderTargetParams.depthBuffer||this.outputs[1].requestCounter===0)&&(this.prevFrameRenderTarget!==void 0&&this.prevFrameRenderTarget!==null&&i.resourcesEnv.renderTargetManager.unuseRenderTarget(this.prevFrameRenderTarget),this.prevFrameRenderTarget=this.outputs[0].result,this.outputs[0].result=this.inputs[0].result=void 0,this.renderTargetParams.depthBuffer&&(this.outputs[1].result=void 0))}}class Th{constructor(){a(this,"nodes",new Array);a(this,"rootNode")}add(e,t){return this.rootNode&&t&&e.connectToInput(this.rootNode,t),this.rootNode=e,this.nodes.push(e),this}}class Iv extends Th{build(){return this}}class Dv extends Th{build(){return this.add(new Sh).add(new lo(null,!0),"RenderResult").add(new ju,"RenderResult"),this}}class Hf extends Th{build(){const e=new Rv(!1),t=new Cv,i=new lo(null,!0);return this.add(new Sh).add(i,"RenderResult").add(new ju,"RenderResult").add(new lo("FXAA render target",!1),"RenderResult").add(t,"RenderResult").add(e,"RenderResult"),t.connectToInput(e,"PrevRenderResult"),t.connectToInput(i,"DepthRenderResult"),this}}class Lv{constructor(e){a(this,"context");a(this,"ext",null);a(this,"activeQuery",null);a(this,"isRunning",!1);a(this,"eventsPendingTimestamps",[]);a(this,"resolvedEvents",[]);a(this,"namedContextStack",[]);this.context=e,this.ext=e.getExtension("EXT_disjoint_timer_query_webgl2")}isProfilerRunning(){return this.isRunning}start(){if(this.ext==null)throw new Error("EXT_disjoint_timer_query WebGL extension is not available. Cannot start profiler.");if(this.isRunning)throw new Error("Profiler is already running");const e=this.context.getExtension("WEBGL_debug_renderer_info");if(e!=null){const t=this.context.getParameter(e.UNMASKED_RENDERER_WEBGL);if(t.indexOf("NVIDIA GeForce GT 750M")!==-1)throw new Error(`${t} cards seem to have a buggy implementation of EXT_disjoint_timer_query. Refusing to record to avoid misleading results.`)}this.isRunning=!0,this.eventsPendingTimestamps=[],this.resolvedEvents=[],this.activeQuery=this.context.createQuery(),this.context.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery),this.pushContext("profile")}stop(){if(this.ext!=null){if(!this.isRunning)throw new Error("Profiler is already stopped");this.isRunning=!1,this.popContext("profile"),this.activeQuery=null,this.context.endQuery(this.ext.TIME_ELAPSED_EXT)}}pushContext(e){this.markAction({type:0,name:e}),this.namedContextStack.push(e)}popContext(e){if(this.namedContextStack.length===0)throw new Error("Tried to pop a context when the context stack is empty!");const t=this.namedContextStack.pop();if(t!==e)throw new Error(`Expected popContext to be called with ${t}, but it was called with ${e}`);this.markAction({type:1,name:e})}withContext(e,t){this.pushContext(e),t(),this.popContext(e)}isReady(){return this.eventsPendingTimestamps.length>0&&this.resolveEventsIfPossible(),this.eventsPendingTimestamps.length===0}getResolvedEvents(){return this.resolvedEvents}exportSpeedscopeProfile(){return ei(this,null,function*(){for(;this.eventsPendingTimestamps.length>0;)this.resolveEventsIfPossible(),yield new Promise(e=>requestAnimationFrame(e));return this.toSpeedscopeProfile()})}downloadWhenReady(){return ei(this,null,function*(){const e=yield this.exportSpeedscopeProfile(),t=document.createElement("a");t.href=URL.createObjectURL(new Blob([e],{type:"application/json"})),t.download=`gpuprofile-${+new Date}.speedscope.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t)})}stopAndDownload(){return ei(this,null,function*(){this.stop(),yield this.downloadWhenReady()})}markAction(e){if(this.ext==null)return;if(this.activeQuery==null)throw new Error("Cannot mark actions while no profile is active");const t=this.context,i=this.activeQuery;this.activeQuery=t.createQuery(),t.endQuery(this.ext.TIME_ELAPSED_EXT),t.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery),this.eventsPendingTimestamps.push({action:e,query:i})}resolveEventsIfPossible(){if(this.ext==null)return;let e=0;const t=this.context;for(;e<this.eventsPendingTimestamps.length;){let r=this.eventsPendingTimestamps[e],o=r.query;if(!t.getQueryParameter(o,t.QUERY_RESULT_AVAILABLE))break;if(t.getParameter(this.ext.GPU_DISJOINT_EXT))throw new Error("GPU_DISJOINT_EXT");const l=this.context.getQueryParameter(o,t.QUERY_RESULT);t.deleteQuery(o);var i=this.resolvedEvents.length===0?0:this.resolvedEvents[this.resolvedEvents.length-1].timestamp,n=i+l;this.resolvedEvents.push({action:r.action,timestamp:n}),e++}e>0&&(this.eventsPendingTimestamps=this.eventsPendingTimestamps.slice(e))}toSpeedscopeProfile(){const e=[],t=[];if(this.resolvedEvents.length===0)throw new Error("Profile is empty");const i={type:"evented",name:"GPU Profile",unit:"nanoseconds",startValue:0,endValue:this.resolvedEvents[this.resolvedEvents.length-1].timestamp,events:t},n={$schema:"https://www.Speedscopeapp/file-format-schema.json",shared:{frames:e},profiles:[i]},r={};function o(l){return l in r||(r[l]=e.length,e.push({name:l})),r[l]}for(let l of this.resolvedEvents)t.push({type:l.action.type==0?"O":"C",frame:o(l.action.name),at:l.timestamp});return JSON.stringify(n)}}var Mh=(s=>(s[s.OPEN_FRAME=0]="OPEN_FRAME",s[s.CLOSE_FRAME=1]="CLOSE_FRAME",s))(Mh||{});class Wf{constructor(e){this.buffer=[];for(let t=0;t<e;t++)this.buffer.push(null);this.pointer=0}get(e){return this.buffer[e]}add(e){this.buffer[this.pointer]=e,this.pointer=(this.pointer+1)%this.buffer.length}}let Xi=null;const jf=60,Ph=.99;class Ri{static createInstance(){console.assert(!Xi),Xi=new Ri,console.log("Profiling enabled.")}static beginProfiling(){!Xi||!Xi.profilerActive||Xi.onProfilingBegin()}static endProfiling(){!Xi||!Xi.profilerActive||Xi.onProfilingEnd()}static beginSection(e,t){!Xi||!Xi.profilerActive||Xi.onSectionBegin(e,t)}static endSection(e){!Xi||!Xi.profilerActive||Xi.onSectionEnd(e)}static initWebGLProfiler(e){Xi&&(Xi.webGLProfiler=new Lv(e))}constructor(){this.gpuSections=[],this.sectionsInfo=new Map,this.profilerActive=!0,this.colors=[ImGui.IM_COL32(180,30,20),ImGui.IM_COL32(150,60,40),ImGui.IM_COL32(120,90,40),ImGui.IM_COL32(90,120,40),ImGui.IM_COL32(60,150,40),ImGui.IM_COL32(30,180,40)],this.currentSectionColorIndex=0,this.currentSectionIndex=0,this.cpuSections=[],this.cpuSectionsToDraw=[],this.cpuStackIndices=[],Ni.registerIfEnabled(this,this.onDebugUI)}onProfilingBegin(){this.tryToCopyGpuResolvedEvents(),this.cpuStackIndices=[],this.cpuSectionsToDraw=this.cpuSections,this.cpuSections=[],this.webGLProfiler.isReady()&&this.webGLProfiler.start()}onProfilingEnd(){this.webGLProfiler.isProfilerRunning()&&this.webGLProfiler.stop(),this.tryToCopyGpuResolvedEvents()}tryToCopyGpuResolvedEvents(){if(this.webGLProfiler.isReady()&&this.webGLProfiler.getResolvedEvents().length>0){this.gpuSections=[];let e=[];for(let t of this.webGLProfiler.getResolvedEvents())if(t.action.type===Mh.OPEN_FRAME){const i=this.gpuSections.length;e.push(i),this.gpuSections.push({name:t.action.name,timestamp:t.timestamp*1e-6,duration:0,stackIndex:e.length-1})}else if(t.action.type===Mh.CLOSE_FRAME){console.assert(e.length>0);const i=e.pop(),n=this.gpuSections[i];console.assert(n!==void 0),n.duration=(t.timestamp-n.timestamp)*1e-6;const r=this.sectionsInfo.get(t.action.name);r!==void 0&&(r.gpuAverageDuration=r.gpuAverageDuration*Ph+n.duration*(1-Ph),r.gpuSamples.add(n.duration))}}}onSectionBegin(e,t){if(!this.sectionsInfo.has(e)){let n;if(t===void 0){const r=this.currentSectionColorIndex++%this.colors.length;n=this.colors[r]}else n=t;this.sectionsInfo.set(e,{color:n,gpuAverageDuration:0,gpuSamples:new Wf(jf),cpuAverageDuration:0,cpuSamples:new Wf(jf)})}const i=this.cpuSections.length;this.cpuStackIndices.push(i),this.cpuSections.push({name:e,timestamp:performance.now(),duration:0,stackIndex:this.cpuStackIndices.length-1}),this.webGLProfiler.isProfilerRunning()&&this.webGLProfiler.pushContext(e)}onSectionEnd(e){const t=this.cpuStackIndices.pop(),i=this.cpuSections[t];console.assert(i!==void 0),i.duration=performance.now()-i.timestamp;const n=this.sectionsInfo.get(e);n!==void 0&&(n.cpuAverageDuration=n.cpuAverageDuration*Ph+i.duration*.01,n.cpuSamples.add(i.duration)),this.webGLProfiler.isProfilerRunning()&&this.webGLProfiler.popContext(e)}onDebugUI(){if(ImGui.SetNextWindowPos(new ImGui.ImVec2(350,20),ImGui.Cond.FirstUseEver),ImGui.SetNextWindowSize(new ImGui.ImVec2(800,500),ImGui.Cond.FirstUseEver),ImGui.Begin("Profiler"),this.gpuSections.length>0){ImGui.Button(this.profilerActive?"Pause profiler":"Start profiler")&&(this.profilerActive=!this.profilerActive);const e=Array.from(this.sectionsInfo.keys());ImGui.Combo("Section plot",(i=this.currentSectionIndex)=>this.currentSectionIndex=i,e,e.length),this.plotProfilerSection(e[this.currentSectionIndex]),ImGui.Separator(),ImGui.TextUnformatted("GPU timings:");const t=this.drawSections(this.gpuSections);ImGui.SetCursorPosY(t),ImGui.Separator(),ImGui.TextUnformatted("CPU timings:"),this.drawSections(this.cpuSectionsToDraw)}ImGui.End()}drawSections(e){const t=ImGui.GetWindowDrawList(),i=ImGui.GetCursorScreenPos(),n=ImGui.GetContentRegionAvail(),r=16,o=n.x,l=e[0].duration,c=e[0].timestamp,d=o/l,u=3,h=1,f=20,p=5,m=1;let b=0;for(let _ of e){const y=this.sectionsInfo.get(_.name),A=new ImGui.Vec2,T=new ImGui.Vec2,M=_.duration*d;A.x=i.x+(_.timestamp-c)*d,T.x=A.x+M-h,A.y=i.y+(r+u)*_.stackIndex,T.y=A.y+r,b=T.y;let C=y?y.color:ImGui.COL32_WHITE;t.AddRectFilled(A,T,C);const N=_.duration.toFixed(2),O=ImGui.GetMousePos(),q=O.x>=A.x&&O.x<=T.x&&O.y>=A.y&&O.y<=T.y;if(M>f&&(A.x+=p,A.y+=m,t.AddText(A,ImGui.COL32_BLACK,_.name+` (${N} ms)`)),q){if(ImGui.BeginTooltip(),ImGui.PushTextWrapPos(ImGui.GetFontSize()*35),ImGui.TextUnformatted(`${_.name}: ${N} ms`),y){const j=y.gpuAverageDuration.toFixed(2);ImGui.TextUnformatted(`GPU average: ${j}`);const K=y.cpuAverageDuration.toFixed(2);ImGui.TextUnformatted(`CPU average: ${K}`)}ImGui.PopTextWrapPos(),ImGui.EndTooltip()}}return b}plotProfilerSection(e){const t=this.sectionsInfo.get(e),i=`GPU Average: ${t.gpuAverageDuration.toFixed(2)}`,n=t.gpuSamples;ImGui.PlotHistogram(e+" (GPU)",n.buffer,n.buffer.length,n.pointer,i,0,20,new ImGui.Vec2(0,80));const r=t.cpuSamples,o=`CPU Average: ${t.cpuAverageDuration.toFixed(2)}`;ImGui.PlotHistogram(e+" (CPU)",r.buffer,r.buffer.length,r.pointer,o,0,20,new ImGui.Vec2(0,80))}}class Fv{constructor(){a(this,"projectionMatrix",new je);a(this,"viewMatrix",new je);a(this,"viewProjMatrix",new je);a(this,"cameraPosition",new B);a(this,"fogDistStart_DistDensity_HeightStart_HeightDensity",new Lt);a(this,"fogColor",new Lt);a(this,"camera_exposure_gamma",new Lt);a(this,"colorMapIntensity",0);a(this,"time",0)}updateData(e){const t=e.frameInfo,i=t.camera.get(Ts);this.projectionMatrix=i.projectionMatrix,this.viewMatrix=i.viewMatrix,this.viewProjMatrix=i.viewProjMatrix,this.cameraPosition=t.camera.get(vi).position;const n=e.renderWorld.scene.sharedMaterialState,r=n.fog;if(r!==void 0&&r.enabled()){const l=r.distanceEnabled?r.distanceDensity:0,c=r.heightEnabled?r.heightDensity:0;this.fogDistStart_DistDensity_HeightStart_HeightDensity.set(r.distanceStart,l,r.heightStart,c),this.fogColor.set(r.color.r,r.color.g,r.color.b,0)}else this.fogDistStart_DistDensity_HeightStart_HeightDensity.set(0,0,0,0),this.fogColor.set(0,0,0,0);const o=Math.pow(2,n.cameraExposure);this.camera_exposure_gamma.set(o,n.cameraGamma,0,0),this.colorMapIntensity=n.colorMapIntensity,this.time+=t.deltaTime}}class Ov{constructor(e){a(this,"currentProgramId",-1);a(this,"currentMaterial");a(this,"currentVao");a(this,"lightBinding");a(this,"globalUniformBuffer");a(this,"globalUniformData",new Fv);a(this,"transferBuffer");a(this,"gl");this.gl=e,this.globalUniformBuffer=new vl(this.gl)}bindDrawCall(e,t){const i=e.activeMaterial;i!=this.currentMaterial&&(this.currentMaterial=i,this._bindMaterial(e,t)),e.setTextures();for(const o of e.textureTable.textures){const l=o.texture;l.webglSlot=o.samplerSlot.bindIndex,l.isCube?t.setCubeTexture(l):t.setTexture(l)}const n=e.lightDataBinding;n&&n!==this.lightBinding&&(this.lightBinding=n,e.bindLightingBuffer(this.gl)),e.bindObjectBuffer(this.gl);const r=e.mesh;this.currentVao!==r.vao&&(this.currentVao=r.vao,this.gl.bindVertexArray(r.vao))}_bindMaterial(e,t){const i=e.activeMaterial,n=e.renderMaterial,r=n.shader;t.setMaterial(i),t.setMaterialFaces(i);const o=this.gl;n.uniformBuffer&&o.bindBufferBase(o.UNIFORM_BUFFER,zo[ve.MATERIAL],n.uniformBuffer.glBuffer),r.id!==this.currentProgramId&&(this.currentProgramId=r.id,o.useProgram(r.program))}updateAndBindGlobalUniformData(e){const t=this.gl;if(this.globalUniformData.updateData(e),!this.transferBuffer){const i=e.resourcesEnv.getGlobalUniformBlockDescriptor();this.transferBuffer=new sh(i)}this.transferBuffer.loadObject(this.globalUniformData),this.globalUniformBuffer.uploadBufferToGpu(this.transferBuffer.dataView,t),t.bindBufferBase(t.UNIFORM_BUFFER,zo[ve.GLOBAL],this.globalUniformBuffer.glBuffer)}resetState(){this.currentProgramId=-1,this.currentMaterial=void 0,this.currentVao=void 0,this.lightBinding=void 0}unload(){this.globalUniformBuffer.unload(this.gl)}}class Bv{constructor(e,t){a(this,"renderWorld");a(this,"_frameInfo");a(this,"resourcesEnv");a(this,"sharedState");a(this,"renderNodesToDependencyCount",new Map);a(this,"portsWithRequestCounterZero",[]);a(this,"_webGLRenderer",null);this.renderWorld=e,this.resourcesEnv=t,this.sharedState=new Ov(this.resourcesEnv.renderDevice.getGl())}getRenderDevice(){return ye(this._webGLRenderer),this._webGLRenderer}_buildFrame(e){if(this._resetFrame(),e&&e.rootNode)for(const t of e.rootNode.inputs)e.rootNode.buildInput(t,this)}_resetFrame(){for(const e of this.renderNodesToDependencyCount.keys())e.requiredDependenciesCount=0,e.followingNodes.clear(),e.requiresRun=!1,e.needsRebuilding=!0,e.clearResults();this.renderNodesToDependencyCount.clear()}addDependency(e,t){const i=e.followingNodes.size;e.followingNodes.add(t).size>i&&(t.requiredDependenciesCount++,this.renderNodesToDependencyCount.set(t,0)),this.renderNodesToDependencyCount.set(e,0)}notifyResultUnuse(e){this.portsWithRequestCounterZero.push(e)}get frameInfo(){return this._frameInfo}buildAndUpdate(e){this._frameInfo=e;const t=e.renderGraph;this._buildFrame(t);for(const i of this.renderNodesToDependencyCount.keys())i.update(this)}_runRenderNode(e){cs.setDebugMarker(e.nodeName),console.assert(e.requiredDependenciesCount===this.renderNodesToDependencyCount.get(e),"Attempt to run node without it's dependencies ready.Nodes count required: "+e.requiredDependenciesCount+" nodes ran: "+this.renderNodesToDependencyCount.get(e)),e.isRenderCallRequired()&&(Ri.beginSection(e.nodeName),e.render(this),Ri.endSection(e.nodeName)),cs.clearDebugMarker();for(const t of this.portsWithRequestCounterZero)t.parentNode.unuseResultResources(t,this);this.portsWithRequestCounterZero=[];for(const t of e.followingNodes)this.renderNodesToDependencyCount.set(t,this.renderNodesToDependencyCount.get(t)+1),this.renderNodesToDependencyCount.get(t)===t.requiredDependenciesCount&&this._runRenderNode(t)}render(e){this._webGLRenderer=e,Ri.beginSection("Render Graph");for(const t of this.renderNodesToDependencyCount.keys())this.renderNodesToDependencyCount.set(t,0);for(const t of this.renderNodesToDependencyCount.keys())t.requiredDependenciesCount===0&&this._runRenderNode(t);Ri.endSection("Render Graph"),this._webGLRenderer=null;for(const t of this.renderNodesToDependencyCount.keys()){for(const i of t.inputs)i.requestCounter!=0&&console.log("Node "+t.nodeName+" has invalid input request counter: "+i.requestCounter+".");for(const i of t.outputs)i.requestCounter!=0&&console.log("Node "+t.nodeName+" has invalid output request counter "+i.requestCounter+".")}}unload(){this.sharedState.unload()}}class Ch{constructor(){a(this,"_renderWorld");a(this,"_frame");a(this,"_frameBuilder")}init(e){this._renderWorld=e.renderWorld;const t=this._createRenderGraph(e),i=this._renderWorld.createCameraEntity(e.temporalEnabled);this._frame=new po(i,t,e.renderWorld.getRenderLists()),this._frame.simStateAlpha=1,this._frame.deltaTime=0,this._frame.customRender=e.customRender,this._frameBuilder=new Bv(this._renderWorld,e.resourcesEnv)}get frame(){return this._frame}unload(){this._frameBuilder.unload()}}class Tr extends ci.ReactionSystem{constructor(){super(e=>e.hasAll(vi,Gn,Ts,ta))}update(){const e=this.sharedConfig.get(po);e.customRender||Tr.updateCamera(e.camera,e.renderLists)}getEntities(){return this.entities}static updateCamera(e,t){Tr.updateCameraMatrices(e);const i=e.get(ta),n=e.get(Ts),r=i.frustum;r.setFromMatrix(n.viewProjMatrix);for(let o=0;o<ah;o++){const l=t[o],c=i.renderListsVisibility[o];c.clear();for(let d=0;d<l.sortedList.length;d++){const u=l.sortedList.at(d),h=u.boundsComp;u.visible&&(!h||!h.frustumCulled||r.intersectsBox(h.wsBoundingBox))&&c.set(d,1)}}}static updateCameraMatrices(e){const t=e.get(vi),i=e.get(Gn),n=e.get(Ts),r=e.get(Zs),o=n.viewMatrix,l=n.invViewMatrix,c=n.projectionMatrix,d=n.invProjMatrix,u=n.unjitteredProjectionMatrix,h=n.unjitteredInvProjectionMatrix;l.compose(t.position,t.rotation,t.scale),o.copyFrom(l).invert(),i.setProjectionMatrix(u),h.copyFrom(u).invert(),c.copyFrom(u),d.copyFrom(c).invert(),r&&(i.applyJitter(c,r.temporalJitter.getJitterOffset()),r.cameraMove.copyFrom(t.position).sub(r.prevCameraPosition)),n.viewProjMatrix.copyFrom(c).multiply(o),n.invViewProjMatrix.copyFrom(l).multiply(d)}}class ia extends ci.ReactionSystem{constructor(){super(e=>e.hasAll(vi,Gn,jo,Ts,Zs))}update(){const e=this.sharedConfig.get(po);e.camera&&e.camera.has(Zs)&&ia.updateTemporalMatrices(e.camera)}static updateTemporalMatrices(e){const t=e.get(Ts),i=e.get(Zs),n=e.get(jo);i.prevCameraPosition.copyFrom(e.get(vi).position),i.prevViewProjMatrix.copyFrom(t.viewProjMatrix),i.unjitteredPrevViewProjMatrix.copyFrom(t.unjitteredProjectionMatrix),i.unjitteredPrevViewProjMatrix.multiply(t.viewMatrix),i.prevViewMatrix.copyFrom(t.viewMatrix),i.prevProjMatrix.copyFrom(t.projectionMatrix),i.temporalJitter.enabled=n.temporalAAEnabled,i.temporalJitter.setNextJitter()}}class Nv extends Ch{constructor(){super();a(this,"_cubeRotations",[]);a(this,"_renderTargetNode",new lo);const t=[{target:new B(1,0,0),up:new B(0,-1,0)},{target:new B(-1,0,0),up:new B(0,-1,0)},{target:new B(0,1,0),up:new B(0,0,1)},{target:new B(0,-1,0),up:new B(0,0,-1)},{target:new B(0,0,1),up:new B(0,-1,0)},{target:new B(0,0,-1),up:new B(0,-1,0)}],i=new B(0,0,0),n=new je().identity();for(const{target:r,up:o}of t)n.lookAt(i,r,o),this._cubeRotations.push(new xi().setFromRotationMatrix(n))}_createRenderGraph(t){const i=new Iv;return i.add(new Sh),i.add(this._renderTargetNode,"RenderResult"),i}renderCubemap(t,i,n,r,o){const l=this._frame.camera,c=l.get(vi);c.position.copyFrom(n);const d=l.get(Gn);d.near=r,d.far=o,d.fov=90,d.setViewportSize(i.width,i.height),this._renderWorld.update(this._frame);for(let u=0;u<6;u++)this._frameBuilder.buildAndUpdate(this._frame),this._renderTargetNode.setRenderTarget(i),c.rotation.copyFrom(this._cubeRotations[u]),Tr.updateCamera(this._frame.camera,this._renderWorld.getRenderLists()),i.activeCubeFace=u,this._frameBuilder.render(t)}}class kv extends Ch{_createRenderGraph(e){const t=e.temporalEnabled,i=t?new Hf().build():new Dv().build(),n=new Mv;if(t?i.add(new N0,"RenderResult").add(n,"RenderResult"):i.add(n,"RenderResult"),D.DEBUG_UI){const r=new U0;i.nodes.push(r),n.connectToInput(r,"RenderResult")}return i}renderScene(e,t,i){Ri.beginSection("Scene render"),this._frame.simStateAlpha=e,this._frame.deltaTime=t,this._renderWorld.update(this._frame),D.DEBUG_UI&&Uo.beginFrame(t),this._frameBuilder.buildAndUpdate(this._frame),D.DEBUG_UI&&Uo.endFrame(),this._frameBuilder.render(i),Ri.endSection("Scene render")}}class Uv extends xr{constructor(){super("RenderResultAcquireNode");a(this,"readPixels",!1);a(this,"pixelBuf");this.addInputPort("RenderResult")}render(t){const i=this.acquireConnectedResult(this.inputs[0],t);if(this.readPixels){const n=i.width,r=i.height,o=t.getRenderDevice();o.setRenderTarget(i),this.pixelBuf=new Uint8Array(n*r*4),o.readPixels(n,r,this.pixelBuf)}}}class zv extends Ch{constructor(){super(...arguments);a(this,"_renderResultNode",new Uv)}_createRenderGraph(t){const i=new Hf().build();return i.add(this._renderResultNode,"RenderResult"),i}takeScreenshot(t,i,n,r,o){const l=this._frame.camera,c=l.get(vi);c.position.copyFrom(r),c.rotation.copyFrom(o);const d=16,u=l.get(Zs);u&&u.temporalJitter.generateHaltonJitters(d,i,n);const h=l.get(Gn);h.near=.1,h.far=1e3,h.fov=60,h.setViewportSize(i,n),this._renderWorld.update(this._frame),ia.updateTemporalMatrices(this._frame.camera),Tr.updateCamera(this._frame.camera,this._renderWorld.getRenderLists());for(let p=0;p<d;p++)ia.updateTemporalMatrices(this._frame.camera),Tr.updateCameraMatrices(this._frame.camera),this._renderResultNode.readPixels=p===d-1,this._frameBuilder.buildAndUpdate(this._frame),this._frameBuilder.render(t);const f=this._renderResultNode.pixelBuf;return this._renderResultNode.pixelBuf=void 0,f}}class cn{constructor(){a(this,"updatedComponents",new Map);a(this,"markedForRemove",!1)}}class Vv extends ci.ReactionSystem{constructor(){super(t=>t.hasAll(vi,cn,Js));a(this,"entityAdded",({current:t})=>{this._updateWsBounds(t.get(vi),t.get(Js))})}_updateWsBounds(t,i){const n=new je().compose(t.position,t.rotation,t.scale);i.wsBoundingBox.copyFrom(i.osBoundingBox).applyMatrix4(n),i.wsBoundingBox.getBoundingSphere(i.wsSphere)}}class qi{constructor(e){a(this,"_baseName");a(this,"name");a(this,"needsUpdate",!0);this._baseName=e,this.name=this._baseName}set baseName(e){this._baseName=e,this.needsUpdate=!0}get baseName(){return this._baseName}}class Gv extends ci.ReactionSystem{constructor(){super(t=>t.hasAll(qi));a(this,"entityFilter",new ImGui.StringBuffer(128,""));a(this,"enableDebug",!1);a(this,"entityAdded",({current:t})=>{t.onComponentAdded.connect(this.onEntityComponentsChanged.bind(this)),t.onComponentRemoved.connect(this.onEntityComponentsChanged.bind(this)),this.onEntityComponentsChanged(t,t.get(qi))});Ni.registerIfEnabled(this,this.onDebugUI)}onDebugUI(){if(this.enableDebug){Ni.beginWindow("Entities debug",{x:20,y:50},{x:600,y:1e3}),ImGui.InputText("Filter",this.entityFilter,ImGui.ARRAYSIZE(this.entityFilter));for(const t of this.entities){const i=t.get(qi).name;if(!(this.entityFilter.buffer!==""&&i.indexOf(this.entityFilter.buffer)===-1)&&ImGui.TreeNode(t.id,i)){for(const n of t.getComponents()){if(n instanceof qi||n instanceof cn)continue;const r=n;ImGui.TreeNode(t.id+""+r.constructor.name,r.constructor.name)&&(Ni.displayObject(r),ImGui.TreePop())}ImGui.TreePop()}}Ni.endWindow()}}update(){for(const t of this.entities){const i=t.get(qi);if(i.needsUpdate){i.needsUpdate=!1,i.name=i.baseName+t.id+" (";const n=t.getComponents().length;for(let r=0;r<n;r++){const o=t.getComponents()[r];if(o instanceof qi||o instanceof cn)continue;r!==0&&(i.name+=", ");const l=o.constructor.name,c=l.indexOf("Component");c!==-1?i.name+=l.substring(0,c):i.name+=l}i.name+=")"}}}onEntityComponentsChanged(t,i){i instanceof cn||(t.get(qi).needsUpdate=!0)}}class Hv extends ci.ReactionSystem{constructor(t){super(i=>i.hasAll(vi,Cs,Js));a(this,"renderDevice");a(this,"entityAdded",({current:t})=>{const n=t.get(Cs).geometry,r=n.attributes,o=n.attributesKeys;n.setOnDispose(this.onGeometryDispose.bind(this)),console.assert(n instanceof Wi||n instanceof co);const l=this.renderDevice.getGl();for(let c=0,d=o.length;c<d;c+=1){const u=o[c],h=r[u],f=u==="index"?l.ELEMENT_ARRAY_BUFFER:l.ARRAY_BUFFER;if(h.buffer)h.needsUpdate===!0&&console.assert(!1);else{h.buffer=l.createBuffer(),l.bindBuffer(f,h.buffer);const p=h.array;if(it.ios&&f===l.ARRAY_BUFFER){const m=h.itemSize*p.BYTES_PER_ELEMENT%4;console.assert(m===0)}l.bufferData(f,p,l.STATIC_DRAW),p instanceof Float32Array?(h.glType=l.FLOAT,h.glTypeSize=4):p instanceof Int8Array?(h.glType=l.BYTE,h.glTypeSize=1):p instanceof Int16Array?(h.glType=l.SHORT,h.glTypeSize=2):p instanceof Uint16Array?(h.glType=l.UNSIGNED_SHORT,h.glTypeSize=2):p instanceof Uint32Array?(h.glType=l.UNSIGNED_INT,h.glTypeSize=4):console.assert(!1),h.releaseOnLoadedToGpu&&h.array.slice(0,h.array.length),h.needsUpdate=!1}}});this.renderDevice=t}getEntities(){return this.entities}onGeometryDispose(t){t.setOnDispose(void 0),this.deallocateGeometry(t)}deallocateGeometry(t){const i=t.attributes;for(const n in t.attributesKeys)if(Object.prototype.hasOwnProperty.call(i,n)){const r=i[n];r!==void 0&&r.buffer!==void 0&&(this.renderDevice.getGl().deleteBuffer(r.buffer),delete r.buffer)}}}class Wv{constructor(){a(this,"modelMatrix",new je);a(this,"normalMatrix",new ys)}}const Rh="NonUniformScaleComponent";class jv extends ci.ReactionSystem{constructor(){super(e=>{if(!e.has(cn))return!1;for(const t of Rs)if(!e.has(t))return!1;return!0})}update(e){for(const i of this.entities){const n=i.get(vi).scale;Yr(n.x,n.y,.001)&&Yr(n.x,n.z,.001)?i.remove(Rh):i.add(Rh)}}}class Xv extends ci.ReactionSystem{constructor(){super(i=>{if(!i.has(Rh))return!1;for(const n of Rs)if(!i.has(n))return!1;return!0});a(this,"_tempMat4",new je);a(this,"_tempModelMatrix",new je);a(this,"_tempNormalMatrix",new ys);a(this,"_dataBuffer");a(this,"_dataView");const t=9;this._dataBuffer=new ArrayBuffer(Ms*t),this._dataView=new DataView(this._dataBuffer)}update(t){const i=zn[ve.OBJECT],n=this.sharedConfig.get(po).camera.get(Ts).viewMatrix,r=this.sharedConfig.get(fo).renderDevice.getGl();for(const o of this.entities){const l=o.get(vi),c=o.get(Ci),d=l.scale,u=c.drawCall;if(!u.renderMaterial)continue;const f=u.renderMaterial.shader.uniformBlockDescriptors.get(i).getUniformOffsetInBytes("normalMatrix");this._tempModelMatrix.compose(l.position,l.rotation,d),this._tempMat4.multiplyMatrices(n,this._tempModelMatrix),this._tempNormalMatrix.getNormalMatrix(this._tempMat4);const p=this._tempNormalMatrix.elements;for(let m=0;m<p.length;m++)this._dataView.setFloat32(m*Ms,p[m],!0);u.perObjectUniformBuffer.uploadSubdataToGPU(this._dataView,f,r)}}}class qv extends ci.ReactionSystem{constructor(){super(t=>{for(const i of Rs)if(!t.has(i))return!1;return!0});a(this,"_transformDataHelper",new Wv);a(this,"perObjectDataUpdater");a(this,"entityAdded",({current:t})=>{t.get(Ci).perObjectUpdaters.push(this.perObjectDataUpdater)});a(this,"entityRemoved",t=>{const i=t.previous.get(Ci),n=i.perObjectUpdaters.indexOf(this.perObjectDataUpdater,0);i.perObjectUpdaters.splice(n,1)});this.perObjectDataUpdater=new gh(this._appendShaderCode.bind(this),this._updatePerObjectData.bind(this))}_updatePerObjectData(t,i){const n=t.get(vi),r=n.scale;this._transformDataHelper.modelMatrix.compose(n.position,n.rotation,r),this._transformDataHelper.normalMatrix.fromMat4(this._transformDataHelper.modelMatrix),i.loadObject(this._transformDataHelper)}_appendShaderCode(t){t.generateCodeForObject(this._transformDataHelper)}}class Yv extends ci.ReactionSystem{constructor(){super(e=>{if(!e.has(cn))return!1;for(const t of Rs)if(!e.has(t))return!1;return!0})}update(){const t=this.sharedConfig.get(fo).renderDevice.getGl(),i=zn[ve.OBJECT];for(const n of this.entities){const r=n.get(Ci),o=r.drawCall,l=o.renderMaterial.shader.uniformBlockDescriptors.get(i),c=new sh(l);for(const d of r.perObjectUpdaters)d.updateData(n,c);o.perObjectUniformBuffer.uploadBufferToGpu(c.dataView,t)}}}function Ih(s=D.EDITOR_SELECTION_COLOR){const e=()=>({lineThickness:2,backsideLineThickness:2}),t=new ro(s,100,e);return t.depthTest=!0,t.depthWrite=!1,t.side=Gi.DOUBLE,t.hideFromLightProbes=!0,t.lineThickness=1.5,t}function Dh(s=D.EDITOR_SELECTION_COLOR){const e=new si;return e.hideFromLightProbes=!0,e.disableLightProbe=!0,e.lightmapSupported=!1,e.headLight=!1,e.reflective=!1,e.opacity=.2,e.transparent=!0,e.doubleSided=!1,e.baseColor=s,e.setUniforms(),e}class Xf{constructor(e){a(this,"mesh");this.mesh=e}}class Qv extends ci.ReactionSystem{constructor(){super(i=>i.hasAll(vi,Js));a(this,"boxGeometry");a(this,"wireframeMaterials");a(this,"currentMaterialIndex",0);a(this,"entityAdded",({current:t})=>{this._entityAdded(t)});this.wireframeMaterials=[];const t=[new Re(5021401),new Re(7072564),new Re(3450091),new Re(9385195)];for(const i of t){const n=Ih(i);n.depthTest=!1,this.wireframeMaterials.push(n)}this.boxGeometry=dt.createBox(1,1,1)}_entityAdded(t){const i=new Je(this.boxGeometry,this.wireframeMaterials[this.currentMaterialIndex++%this.wireframeMaterials.length]),n=t.get(Js);i.position.addVectors(n.wsBoundingBox.min,n.wsBoundingBox.max).multiplyScalar(.5),i.scale.subVectors(n.wsBoundingBox.max,n.wsBoundingBox.min).multiplyScalar(1),i.updateMatrixWorld();const r=new ci.Entity;r.add(new vi(i.position.clone(),i.rotation.toQuaternion(),i.scale.clone())),r.add(new Cs(i.geometry,i)),r.add(new Xf(i)),r.add(new qi("Debug")),this.engine.addEntity(r)}}class Kv extends ci.ReactionSystem{constructor(){super(e=>e.hasAll(vi,Cs,Xf))}getEntities(){return this.entities}}class Zv{interpolate(e){ye(!1,"Interpolator not implemented correctly! Alpha: "+e)}apply(){ye(!1,"Interpolator not implemented correctly!")}}class na extends Zv{constructor(t,i,n,r){super();a(this,"destObj");a(this,"property");a(this,"aValue");a(this,"bValue");this.aValue=n,this.bValue=r,this.destObj=t,this.property=i}}class Lh extends na{static tryToHandleProperty(e,t,i,n){if(typeof i[t]!="number")return[!1,void 0];const r=i[t],o=n[t],l=Lh;return l.equals(r,o)?(l.assign(e,i,t),[!0,void 0]):[!0,new l(e,t,r,o)]}static equals(e,t){return e===t}static assign(e,t,i){e[i]=t[i]}interpolate(e){ye(e>=0&&e<=1,"Invalid value for interpolation!"),this.destObj[this.property]=this.aValue+(this.bValue-this.aValue)*e}apply(){this.destObj[this.property]=this.bValue}}class Fh extends na{static tryToHandleProperty(e,t,i,n){if(typeof i[t]!="boolean")return[!1,void 0];const r=i[t],o=n[t],l=Fh;return l.equals(r,o)?(l.assign(e,i,t),[!0,void 0]):[!0,new l(e,t,r,o)]}static equals(e,t){return e===t}static assign(e,t,i){e[i]=t[i]}interpolate(e){ye(e>=0&&e<=1,"Invalid value for interpolation!"),this.destObj[this.property]=e>=.5?this.aValue:this.bValue}apply(){this.destObj[this.property]=this.bValue}}class Oh extends na{static tryToHandleProperty(e,t,i,n){if(!(i[t]instanceof B))return[!1,void 0];const r=i[t],o=n[t],l=Oh;return l.equals(r,o)?(l.assign(e,i,t),[!0,void 0]):[!0,new l(e,t,r.clone(),o.clone())]}static equals(e,t){return e.equals(t)}static assign(e,t,i){e[i].copyFrom(t[i])}interpolate(e){ye(e>=0&&e<=1,"Invalid value for interpolation!"),this.destObj[this.property].lerpVectors(this.aValue,this.bValue,e)}apply(){this.destObj[this.property].copyFrom(this.bValue)}}class Bh extends na{static tryToHandleProperty(e,t,i,n){if(!(i[t]instanceof xi))return[!1,void 0];const r=i[t],o=n[t],l=Bh;return l.equals(r,o)?(l.assign(e,i,t),[!0,void 0]):[!0,new l(e,t,r.clone(),o.clone())]}static equals(e,t){return e.equals(t)}static assign(e,t,i){e[i].copyFrom(t[i])}interpolate(e){ye(e>=0&&e<=1,"Invalid value for interpolation!");const t=this.destObj[this.property];xi.slerp(this.aValue,this.bValue,t,e)}apply(){this.destObj[this.property].copyFrom(this.bValue)}}class Nh extends na{static tryToHandleProperty(e,t,i,n){if(!(i[t]instanceof Re))return[!1,void 0];const r=i[t],o=n[t],l=Nh;return l.equals(r,o)?(l.assign(e,i,t),[!0,void 0]):[!0,new l(e,t,r.clone(),o.clone())]}static equals(e,t){return e.equals(t)}static assign(e,t,i){e[i].copyFrom(t[i])}interpolate(e){ye(e>=0&&e<=1,"Invalid value for interpolation!");const t=this.destObj[this.property];t.r=pr(this.aValue.r,this.bValue.r,e),t.g=pr(this.aValue.g,this.bValue.g,e),t.b=pr(this.aValue.b,this.bValue.b,e)}apply(){this.destObj[this.property].copyFrom(this.bValue)}}class $v{static createIfNotEqual(e,t,i,n){let[r,o]=[!1,void 0];if([r,o]=Lh.tryToHandleProperty(e,t,i,n),r||([r,o]=Oh.tryToHandleProperty(e,t,i,n),r)||([r,o]=Fh.tryToHandleProperty(e,t,i,n),r)||([r,o]=Bh.tryToHandleProperty(e,t,i,n),r)||([r,o]=Nh.tryToHandleProperty(e,t,i,n),r))return o}}/*!
 * Copyright (C) 2024-present Shapespark
 */function Jv(...s){const e=s.reduce((i,n)=>i.concat(Object.keys(n)),[]),t=new Set(e);return s.every(i=>t.size===Object.keys(i).length)}class kh{constructor(e){a(this,"prevState");a(this,"currState");a(this,"nextState");a(this,"pendingState");a(this,"localInterpolators",[]);a(this,"stateUpdated",!1);this.currState=e,this.prevState={},this.nextState={}}setPendingState(e){var t;(t=this.pendingState)!=null||(this.pendingState={}),this.pendingState=zt(zt({},this.pendingState),e),this.stateUpdated=!0}applyPendingState(){if(this.pendingState){let e;for(e in this.nextState)this.pendingState[e]!==void 0?an(this.prevState,e,bs(this.nextState,e)):an(this.currState,e,bs(this.nextState,e));let t;for(t in this.pendingState)Object.prototype.hasOwnProperty.call(this.pendingState,t)&&this.prevState[t]===void 0&&an(this.prevState,t,bs(this.currState,t));this.nextState=this.pendingState,this.pendingState=void 0,ye(Jv(this.prevState,this.nextState),"Invalid type build!")}else{for(const e of this.localInterpolators)e.apply();this.localInterpolators=[],this.prevState={},this.nextState={}}}gatherInterpolatedProperties(){return Object.keys(this.nextState).length===0?!1:(this.localInterpolators=kh.gatherPropertiesToInterpolate(this.currState,this.prevState,this.nextState),this.localInterpolators.length===0?(this.prevState={},this.nextState={},!1):!0)}static gatherPropertiesToInterpolate(e,t,i){let n;const r=[];for(n in t)if(Object.prototype.hasOwnProperty.call(t,n)){const o=$v.createIfNotEqual(e,n,t,i);o&&r.push(o)}return r}}class eb extends ci.ReactionSystem{constructor(){super(e=>e.hasAll(cn))}update(){const e=this.engine.sharedConfig.get(po).simStateAlpha,t=[];for(const i of this.entities){const n=i.get(cn),r=[];for(const[o,l]of n.updatedComponents){let c=!1;if(l.stateUpdated&&(l.applyPendingState(),c=l.gatherInterpolatedProperties(),l.stateUpdated=!1),c){for(const d of l.localInterpolators)d.interpolate(e);n.markedForRemove=!1}else r.push(o)}if(r.length===n.updatedComponents.size)n.markedForRemove?t.push(i):n.markedForRemove=!0;else for(const o of r)n.updatedComponents.delete(o)}for(const i of t)i.removeComponent(cn)}updateEntityState(e,t,i={}){const n=e.get(t);let r=e.get(cn);r||(r=new cn,e.add(r));let o=r.updatedComponents.get(n.constructor.name);o||(o=new kh(n),r.updatedComponents.set(n.constructor.name,o)),o.setPendingState(i)}onDebugUI(){Ni.beginWindow("Updated entities",{x:1100,y:100},{x:400,y:800}),ImGui.Text("Count "+this.entities.length),Ni.endWindow()}}class go{constructor(){a(this,"lineColor",new Re);a(this,"lineThickness",0);a(this,"backsideLineThickness",0)}}class qf extends ci.ReactionSystem{constructor(){super(t=>{if(!t.has(go))return!1;for(const i of Rs)if(!t.has(i))return!1;return!0});a(this,"perObjectDataUpdater");a(this,"_codeGenerationHelper",new go);a(this,"_materialComponentOverride");a(this,"entityAdded",({current:t})=>{t.get(Ci).perObjectUpdaters.push(this.perObjectDataUpdater),this._materialComponentOverride;const n=new Sr;n.materialComp=this._materialComponentOverride,t.add(n)});a(this,"entityRemoved",t=>{const i=t.previous.get(Ci),n=i.perObjectUpdaters.indexOf(this.perObjectDataUpdater,0);i.perObjectUpdaters.splice(n,1),t.current.add(new Sr)});this.perObjectDataUpdater=new gh(this._appendShaderCode.bind(this),this._updatePerObjectData.bind(this))}setWireframeMaterial(t){this._materialComponentOverride?this._materialComponentOverride.baseMaterial=t:this._materialComponentOverride=new mo(t)}_updatePerObjectData(t,i){const n=t.get(go);i.loadObject(n)}_appendShaderCode(t){t.generateCodeForObject(this._codeGenerationHelper)}}class tb{constructor(e,t){a(this,"ecs",new ci.Engine);a(this,"updateSystem");a(this,"renderLists");a(this,"scene");a(this,"transformDebug",!1);a(this,"renderDevice");this.ecs.sharedConfig.add(t),this.updateSystem=new eb,this.ecs.addSystem(this.updateSystem,1),this.ecs.addSystem(new Hv(e),0),this.ecs.addSystem(new jv,2),this.ecs.addSystem(new qv,0),this.ecs.addSystem(new qf,0),this.ecs.addSystem(new wv,0),this.ecs.addSystem(new Av,0),this.ecs.addSystem(new Vv,0),this.ecs.addSystem(new xh,4),this.ecs.addSystem(new Ah,4),this.ecs.addSystem(new Eh,4),this.ecs.addSystem(new Gv,2),this.ecs.addSystem(new Ev,3),this.ecs.addSystem(new ia,5),this.ecs.addSystem(new Tr,6),this.transformDebug&&(this.ecs.addSystem(new Qv,2),this.ecs.addSystem(new Kv,2)),this.ecs.addSystem(new Yv,7),this.ecs.addSystem(new Xv,8),this.ecs.onEntityAdded.connect(i=>{!i.has(Ci)&&i.get(qi).baseName===""&&(i.get(qi).baseName="Helper")}),this.renderDevice=e,this.renderLists={[li.OPAQUE]:this.ecs.getSystem(xh).renderList,[li.GRASS]:this.ecs.getSystem(Ah).renderList,[li.TRANSPARENT]:this.ecs.getSystem(Eh).renderList}}init(e){this.scene=e;for(const t of this.ecs.entities){const i=t.get(Cs);i&&(this.checkIfObjectHasMainSceneParent(i.threeMesh)?(t.add(new Ci),t.get(qi).baseName="Mesh"):t.get(qi).baseName===""&&(t.get(qi).baseName="Helper"))}}checkIfObjectHasMainSceneParent(e){const t=this.scene.threeScene;let i=e.parent;for(;i;){if(i===t)return!0;i=i.parent}return!1}getRenderLists(){return this.renderLists}update(e){Ri.beginSection("Render world update"),this.ecs.sharedConfig.add(e),this.ecs.update(e.deltaTime),Ri.endSection("Render world update")}createCameraEntity(e=!0){const t=new ci.Entity;t.add(new vi),t.add(new Gn);const i=new jo;return i.temporalAAEnabled=e,t.add(i),t.add(new Ts),e&&t.add(new Zs),t.add(new ta),t.add(new qi("Camera")),this.ecs.addEntity(t),t}createMeshEntity(e){const t=new ci.Entity;t.add(new vi(e.position,e.rotation,e.scale)),t.add(new Cs(e.geometry,e.threeMesh)),t.add(new mo(e.material)),t.add(new zf(e.lightmap,e.lightProbes)),t.add(new Sr);let i=e.geometry.boundingBox;if(!i){i=new Dt;const n=e.geometry;n instanceof Wi?(ye(n.attributes.position.array instanceof Float32Array),i.setFromArray(n.attributes.position.array)):(ye(n.parent.attributes.position.array instanceof Float32Array),i.setFromArray(n.parent.attributes.position.array,n.vertexOffset?n.vertexOffset:0,n.vertexCnt))}return t.add(new Js(i)),t.add(new qi("")),t.add(new cn),this.scene&&this.checkIfObjectHasMainSceneParent(e.threeMesh)&&(t.add(new Ci),t.get(qi).baseName="Mesh"),e.material instanceof Xo&&t.add(new mh),this.ecs.addEntity(t),t}}const Co=class Co{constructor(e){a(this,"renderWorld");a(this,"duringShadersReload",!1);a(this,"webGLRenderer");a(this,"resourcesEnv");a(this,"_sceneRenderPipeline",new kv);a(this,"_cubemapRenderPipeline",new Nv);a(this,"_screenshotRenderPipeline",new zv);this.webGLRenderer=e,this.webGLRenderer.setUploadBuffersRedirection(this.createMeshEntityAndUploadBuffer.bind(this)),this.resourcesEnv=new fo(this.webGLRenderer),this.renderWorld=new tb(e,this.resourcesEnv)}static get(){return Co._instance}static createInstance(e){Co._instance=new Co(e)}init(e){this.resourcesEnv.fullscreenRenderHelper.init(),this.renderWorld.init(e),this._cubemapRenderPipeline.init({temporalEnabled:!1,customRender:!0,renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv}),this._screenshotRenderPipeline.init({temporalEnabled:!0,customRender:!0,renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv}),this._sceneRenderPipeline.init({temporalEnabled:!0,customRender:!1,renderWorld:this.renderWorld,resourcesEnv:this.resourcesEnv}),this.resourcesEnv.update()}close(){this._cubemapRenderPipeline.unload(),this._screenshotRenderPipeline.unload(),this._sceneRenderPipeline.unload()}setWireframeMode(e){const t=this.renderWorld.ecs,i=t.getSystem(xh),n=t.getSystem(Ah),r=t.getSystem(Eh);if(e){t.getSystem(qf).setWireframeMaterial(e);const l=c=>{c.addComponent(new go),c.addComponent(new cn)};i.getEntities().forEach(c=>{l(c)}),n.getEntities().forEach(c=>{l(c)}),r.getEntities().forEach(c=>{l(c)})}else{const l=c=>{c.removeComponent(go),c.addComponent(new cn)};i.getEntities().forEach(c=>{l(c)}),n.getEntities().forEach(c=>{l(c)}),r.getEntities().forEach(c=>{l(c)})}const o=this.resourcesEnv.renderTargetManager;this.onViewportResize(o.viewportWidth,o.viewportHeight)}getActiveCamera(){return this._sceneRenderPipeline.frame.camera}renderScene(e,t,i){this.resourcesEnv.update(),this._sceneRenderPipeline.renderScene(e,t,i)}renderCubemap(e,t,i,n){this.resourcesEnv.update(),this._cubemapRenderPipeline.renderCubemap(this.webGLRenderer,e,t,i,n)}takeScreenshot(e,t,i,n){const r=this.resourcesEnv.renderTargetManager,[o,l]=[r.viewportWidth,r.viewportHeight];r.onResize(e,t),this.resourcesEnv.update();const c=this._screenshotRenderPipeline.takeScreenshot(this.webGLRenderer,e,t,i,n);return this.onViewportResize(o,l),c}createMeshEntityAndUploadBuffer(e){var i;const t=this.renderWorld.createMeshEntity({position:e.position,rotation:e.rotation.toQuaternion(),scale:e.scale,geometry:e.geometry,material:e.material,threeMesh:e,lightmap:e instanceof As||e instanceof cl?e.lightmap:void 0,lightProbes:(i=e.lightProbes)!=null?i:[]});return e.entityId=t.id,t}onViewportResize(e,t){this.resourcesEnv.renderTargetManager.onResize(e,t),this.getActiveCamera().get(Gn).setViewportSize(e,t);const n=this.getActiveCamera().get(Zs);n&&n.temporalJitter.generateHaltonJitters(16,e,t)}updateEntityState(e,t,i={}){this.renderWorld.updateSystem.updateEntityState(e,t,i)}updateEntityStateById(e,t,i={}){const n=this.renderWorld.ecs.getEntityById(e);this.updateEntityState(n,t,i)}uploadTexture(e){this.webGLRenderer.uploadTexture(e),this.resourcesEnv.lightBindingManager.onTextureUploaded(e,this.resourcesEnv)}onSceneLoaded(){this.resourcesEnv.lightBindingManager.refreshReflectionProbeTextures();const e=this.renderWorld.getRenderLists();for(let t=0;t<ah;t++)for(const i of e[t].sortedList)i.setTextures()}reloadShaders(e){}};a(Co,"_instance");let Yi=Co;var ds=function(){var s="b9H79Tebbbe8Fv9Gbb9Gvuuuuueu9Giuuub9Geueu9Giuuueuikqbeeedddillviebeoweuec:q;iekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbeY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVbdE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbiL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtblK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbol79IV9Rbrq;d8Yqdbk:yzeHu8Jjjjjbcj;eb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Radz1jjjbhwcj;abad9UhlaicefhodnadTmbalc;WFbGglcjdalcjd6EhDcbhqinaqae9pmeaDaeaq9RaqaDfae6Egkcsfglcl4cifcd4hxdndndndnalc9WGgmTmbcbhPcehsawcjdfhzaohHinaraH9Rax6midnaraHaxfgo9RcK6mbczhlcbhOinalgic9WfgAawcj;cbffhldndndndndnaHaAco4fRbbaOcoG4ciGPlbedibkal9cb83ibalcwf9cb83ibxikalaoRblaoRbbgAco4gCaCciSgCE86bbawcj;cbfaifglcGfaoclfaCfgCRbbaAcl4ciGgXaXciSgXE86bbalcVfaCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc7faCaXfgCRbbaAciGgAaAciSgAE86bbalctfaCaAfgCRbbaoRbegAco4gXaXciSgXE86bbalc91faCaXfgCRbbaAcl4ciGgXaXciSgXE86bbalc4faCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc93faCaXfgCRbbaAciGgAaAciSgAE86bbalc94faCaAfgCRbbaoRbdgAco4gXaXciSgXE86bbalc95faCaXfgCRbbaAcl4ciGgXaXciSgXE86bbalc96faCaXfgCRbbaAcd4ciGgXaXciSgXE86bbalc97faCaXfgCRbbaAciGgAaAciSgAE86bbalc98faCaAfgARbbaoRbigoco4gCaCciSgCE86bbalc99faAaCfgARbbaocl4ciGgCaCciSgCE86bbalc9:faAaCfgARbbaocd4ciGgCaCciSgCE86bbalcufaAaCfglRbbaociGgoaociSgoE86bbalaofhoxdkalaoRbwaoRbbgAcl4gCaCcsSgCE86bbawcj;cbfaifglcGfaocwfaCfgCRbbaAcsGgAaAcsSgAE86bbalcVfaCaAfgARbbaoRbegCcl4gXaXcsSgXE86bbalc7faAaXfgARbbaCcsGgCaCcsSgCE86bbalctfaAaCfgARbbaoRbdgCcl4gXaXcsSgXE86bbalc91faAaXfgARbbaCcsGgCaCcsSgCE86bbalc4faAaCfgARbbaoRbigCcl4gXaXcsSgXE86bbalc93faAaXfgARbbaCcsGgCaCcsSgCE86bbalc94faAaCfgARbbaoRblgCcl4gXaXcsSgXE86bbalc95faAaXfgARbbaCcsGgCaCcsSgCE86bbalc96faAaCfgARbbaoRbvgCcl4gXaXcsSgXE86bbalc97faAaXfgARbbaCcsGgCaCcsSgCE86bbalc98faAaCfgARbbaoRbogCcl4gXaXcsSgXE86bbalc99faAaXfgARbbaCcsGgCaCcsSgCE86bbalc9:faAaCfgARbbaoRbrgocl4gCaCcsSgCE86bbalcufaAaCfglRbbaocsGgoaocsSgoE86bbalaofhoxekalao8Pbb83bbalcwfaocwf8Pbb83bbaoczfhokdnaiam9pmbaOcdfhOaiczfhlarao9RcL0mekkaiam6miaoTmidnakTmbawaPfRbbhOawcj;cbfhlazhiakhAinaialRbbgHce4cbaHceG9R7aOfgO86bbaiadfhialcefhlaAcufgAmbkkazcefhzaPcefgPad6hsaohHaPad9hmexvkkcbhoasceGmdxikaoaxad2fhXdnakTmbcbhmcehsawcjdfhCinarao9Rax6miaoTmdaoaxfhoawamfRbbhOawcj;cbfhlaChiakhAinaialRbbgHce4cbaHceG9R7aOfgO86bbaiadfhialcefhlaAcufgAmbkaCcefhCamcefgmad6hsamad9hmbkaXhoxikcbhlcehsinarao9Rax6mdaoTmeaoaxfhoalcefglad6hsadal9hmbkaXhoxdkcbhoasceGTmekc9:hoxikabaqad2fawcjdfakad2z1jjjb8Aawawcjdfakcufad2fadz1jjjb8Aakaqfhqaombkc9:hoxekcbc99arao9Radcaadca0ESEhokavcj;ebf8Kjjjjbaok;xzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecjez:jjjjb8AavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfalaDcu7gPcl4fcsGcitfgsydlhzasydbhHdnaDcsGgDak9pmbavaiaPfcsGcdtfydbaxaDEhsaDThDdndnadcd9hmbabarcetfgPaH87ebaPcdfaz87ebaPclfas87ebxekabarcdtfgPaHBdbaPclfazBdbaPcwfasBdbkaxaDfhxavc;abfalcitfgPasBdbaPazBdlavaicdtfasBdbavc;abfalcefcsGglcitfgPaHBdbaPasBdlaiaDfhialcefhlxdkdndnaDcsSmbamaDfaDc987fcefhmxekaocefhDao8SbbgscFeGhPdndnascu9mmbaDhoxekaocvfhoaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhokaPce4cbaPceG9R7amfhmkdndnadcd9hmbabarcetfgDaH87ebaDcdfaz87ebaDclfam87ebxekabarcdtfgDaHBdbaDclfazBdbaDcwfamBdbkavc;abfalcitfgDamBdbaDazBdlavaicdtfamBdbavc;abfalcefcsGglcitfgDaHBdbaDamBdlaicefhialcefhlxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHcdfaD87ebaHclfas87ebxekabarcdtfgHaxBdbaHclfaDBdbaHcwfasBdbkavaicdtfaxBdbavc;abfalcitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfalcefcsGcitfgHasBdbaHaDBdlavaiaPfcsGgicdtfasBdbavc;abfalcdfcsGglcitfgDaxBdbaDasBdlalcefhlaiaOfhiazaOfhxxekaxcbaoRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbaocefhDxekaocdfhDao8SbegPcFeGhsdnaPcu9kmbaocofhAascFbGhscrhodninaD8SbbgPcFbGaotasVhsaPcu9kmeaDcefhDaocrfgoc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbgocFeGhPdnaocu9kmbaDcvfhzaPcFbGhPcrhodninas8SbbgDcFbGaotaPVhPaDcu9kmeascefhsaocrfgoc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashoxekascefhoas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninao8SbbgscFbGaDtaPVhPascu9kmeaocefhoaDcrfgDc8J9hmbkaOhoxekaocefhokaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDcdfaz87ebaDclfaO87ebxekabarcdtfgDaABdbaDclfazBdbaDcwfaOBdbkavc;abfalcitfgDazBdbaDaABdlavaicdtfaABdbavc;abfalcefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfalcdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiarcifgrae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:Lvoeue99dud99eud99dndnadcl9hmbaeTmeindndnabcdfgd8Sbb:Yab8Sbbgi:Ygl:l:tabcefgv8Sbbgo:Ygr:l:tgwJbb;:9cawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai86bbdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad86bbdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad86bbabclfhbaecufgembxdkkaeTmbindndnabclfgd8Ueb:Yab8Uebgi:Ygl:l:tabcdfgv8Uebgo:Ygr:l:tgwJb;:FSawawNJbbbbawawJbbbb9GgDEgq:mgkaqaicb9iEalMgwawNakaqaocb9iEarMgqaqNMM:r:vglNJbbbZJbbb:;aDEMgr:lJbbb9p9DTmbar:Ohixekcjjjj94hikadai87ebdndnaqalNJbbbZJbbb:;aqJbbbb9GEMgq:lJbbb9p9DTmbaq:Ohdxekcjjjj94hdkavad87ebdndnawalNJbbbZJbbb:;awJbbbb9GEMgw:lJbbb9p9DTmbaw:Ohdxekcjjjj94hdkabad87ebabcwfhbaecufgembkkk;siliui99iue99dnaeTmbcbhiabhlindndnJ;Zl81Zalcof8UebgvciV:Y:vgoal8Ueb:YNgrJb;:FSNJbbbZJbbb:;arJbbbb9GEMgw:lJbbb9p9DTmbaw:OhDxekcjjjj94hDkalclf8Uebhqalcdf8UebhkabaiavcefciGfcetfaD87ebdndnaoak:YNgwJb;:FSNJbbbZJbbb:;awJbbbb9GEMgx:lJbbb9p9DTmbax:Ohkxekcjjjj94hkkabaiavcdfciGfcetfak87ebdndnaoaq:YNgoJb;:FSNJbbbZJbbb:;aoJbbbb9GEMgx:lJbbb9p9DTmbax:Ohqxekcjjjj94hqkabaiavcufciGfcetfaq87ebdndnJbbjZararN:tawawN:taoaoN:tgrJbbbbarJbbbb9GE:rJb;:FSNJbbbZMgr:lJbbb9p9DTmbar:Ohqxekcjjjj94hqkabaiavciGfcetfaq87ebalcwfhlaiclfhiaecufgembkkk9mbdnadcd4ae2gdTmbinababydbgecwtcw91:Yaece91cjjj98Gcjjj;8if::NUdbabclfhbadcufgdmbkkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaik;LeeeudndnaeabVciGTmbabhixekdndnadcz9pmbabhixekabhiinaiaeydbBdbaiclfaeclfydbBdbaicwfaecwfydbBdbaicxfaecxfydbBdbaeczfheaiczfhiadc9Wfgdcs0mbkkadcl6mbinaiaeydbBdbaeclfheaiclfhiadc98fgdci0mbkkdnadTmbinaiaeRbb86bbaicefhiaecefheadcufgdmbkkabk;aeedudndnabciGTmbabhixekaecFeGc:b:c:ew2hldndnadcz9pmbabhixekabhiinaialBdbaicxfalBdbaicwfalBdbaiclfalBdbaiczfhiadc9Wfgdcs0mbkkadcl6mbinaialBdbaiclfhiadc98fgdci0mbkkdnadTmbinaiae86bbaicefhiadcufgdmbkkabkkkebcjwklz9Kbb",e="b9H79TebbbeKl9Gbb9Gvuuuuueu9Giuuub9Geueuikqbbebeedddilve9Weeeviebeoweuec:q;Aekr;leDo9TW9T9VV95dbH9F9F939H79T9F9J9H229F9Jt9VV7bb8A9TW79O9V9Wt9F9KW9J9V9KW9wWVtW949c919M9MWVbdY9TW79O9V9Wt9F9KW9J9V9KW69U9KW949c919M9MWVblE9TW79O9V9Wt9F9KW9J9V9KW69U9KW949tWG91W9U9JWbvL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9p9JtboK9TW79O9V9Wt9F9KW9J9V9KWS9P2tWV9r919HtbrL9TW79O9V9Wt9F9KW9J9V9KWS9P2tWVT949Wbwl79IV9RbDq;b9tqlbzik9:evu8Jjjjjbcz9Rhbcbheincbhdcbhiinabcwfadfaicjuaead4ceGglE86bbaialfhiadcefgdcw9hmbkaec:q:yjjbfai86bbaecitc:q1jjbfab8Piw83ibaecefgecjd9hmbkk;e8JlHud97euo978Jjjjjbcj;kb9Rgv8Kjjjjbc9:hodnadcefal0mbcuhoaiRbbc:Ge9hmbavaialfgrad9Rad;8qbbcj;abad9UhoaicefhldnadTmbaoc;WFbGgocjdaocjd6EhwcbhDinaDae9pmeawaeaD9RaDawfae6Egqcsfgoc9WGgkci2hxakcethmaocl4cifcd4hPabaDad2fhscbhzdnincbhHalhOcbhAdninaraO9RaP6miavcj;cbfaAak2fhCaOaPfhlcbhidnakc;ab6mbaral9Rc;Gb6mbcbhoinaCaofhidndndndndnaOaoco4fRbbgXciGPlbedibkaipxbbbbbbbbbbbbbbbbpklbxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklbalczfhlkdndndndndnaXcd4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklzxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklzalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklzalczfhlkdndndndndnaXcl4ciGPlbedibkaipxbbbbbbbbbbbbbbbbpklaxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklaalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaialpbbbpklaalczfhlkdndndndndnaXco4Plbedibkaipxbbbbbbbbbbbbbbbbpkl8WxikaialpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalclfaYpQbfaXc:q:yjjbfRbbfhlxdkaialpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibaXc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgXcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spkl8WalcwfaYpQbfaXc:q:yjjbfRbbfhlxekaialpbbbpkl8Walczfhlkaoc;abfhiaocjefak0meaihoaral9Rc;Fb0mbkkdndnaiak9pmbaici4hoinaral9RcK6mdaCaifhXdndndndndnaOaico4fRbbaocoG4ciGPlbedibkaXpxbbbbbbbbbbbbbbbbpklbxikaXalpbblalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLgQcdp:meaQpmbzeHdOiAlCvXoQrLpxiiiiiiiiiiiiiiiip9ogLpxiiiiiiiiiiiiiiiip8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalclfaYpQbfaKc:q:yjjbfRbbfhlxdkaXalpbbwalpbbbgQclp:meaQpmbzeHdOiAlCvXoQrLpxssssssssssssssssp9ogLpxssssssssssssssssp8JgQp5b9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibaKc:q:yjjbfpbbbgYaYpmbbbbbbbbbbbbbbbbaQp5e9cjF;8;4;W;G;ab9:9cU1:NgKcitc:q1jjbfpbibp9UpmbedilvorzHOACXQLpPaLaQp9spklbalcwfaYpQbfaKc:q:yjjbfRbbfhlxekaXalpbbbpklbalczfhlkaocdfhoaiczfgiak6mbkkalTmbaAcd0hHalhOaAcefgAclSmdxekkcbhlaHceGTmdkdnakTmbavcjdfazfhiavazfpbdbhYcbhXinaiavcj;cbfaXfgopblbgLcep9TaLpxeeeeeeeeeeeeeeeegQp9op9Hp9rgLaoakfpblbg8Acep9Ta8AaQp9op9Hp9rg8ApmbzeHdOiAlCvXoQrLgEaoamfpblbg3cep9Ta3aQp9op9Hp9rg3aoaxfpblbg5cep9Ta5aQp9op9Hp9rg5pmbzeHdOiAlCvXoQrLg8EpmbezHdiOAlvCXorQLgQaQpmbedibedibedibediaYp9UgYp9AdbbaiadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaEa8EpmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwKDYq8AkEx3m5P8Es8FgLa3a5pmwKDYq8AkEx3m5P8Es8Fg8ApmbezHdiOAlvCXorQLgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfgoaYaLa8ApmwDKYqk8AExm35Ps8E8FgQaQpmbedibedibedibedip9UgYp9AdbbaoadfgoaYaQaQpmlvorlvorlvorlvorp9UgYp9AdbbaoadfgoaYaQaQpmwDqkwDqkwDqkwDqkp9UgYp9AdbbaoadfgoaYaQaQpmxmPsxmPsxmPsxmPsp9UgYp9AdbbaoadfhiaXczfgXak6mbkkazclfgzad6mbkasavcjdfaqad2;8qbbavavcjdfaqcufad2fad;8qbbaqaDfhDc9:hoalmexikkc9:hoxekcbc99aral9Radcaadca0ESEhokavcj;kbf8Kjjjjbaokwbz:bjjjbk;tzeHu8Jjjjjbc;ae9Rgv8Kjjjjbc9:hodnaeci9UgrcHfal0mbcuhoaiRbbgwc;WeGc;Ge9hmbawcsGgDce0mbavc;abfcFecje;8kbavcUf9cu83ibavc8Wf9cu83ibavcyf9cu83ibavcaf9cu83ibavcKf9cu83ibavczf9cu83ibav9cu83iwav9cu83ibaialfc9WfhqaicefgwarfhodnaeTmbcmcsaDceSEhkcbhxcbhmcbhrcbhicbhlindnaoaq9nmbc9:hoxikdndnawRbbgDc;Ve0mbavc;abfalaDcu7gPcl4fcsGcitfgsydlhzasydbhHdnaDcsGgDak9pmbavaiaPfcsGcdtfydbaxaDEhsaDThDdndnadcd9hmbabarcetfgPaH87ebaPcdfaz87ebaPclfas87ebxekabarcdtfgPaHBdbaPclfazBdbaPcwfasBdbkaxaDfhxavc;abfalcitfgPasBdbaPazBdlavaicdtfasBdbavc;abfalcefcsGglcitfgPaHBdbaPasBdlaiaDfhialcefhlxdkdndnaDcsSmbamaDfaDc987fcefhmxekaocefhDao8SbbgscFeGhPdndnascu9mmbaDhoxekaocvfhoaPcFbGhPcrhsdninaD8SbbgOcFbGastaPVhPaOcu9kmeaDcefhDascrfgsc8J9hmbxdkkaDcefhokaPce4cbaPceG9R7amfhmkdndnadcd9hmbabarcetfgDaH87ebaDcdfaz87ebaDclfam87ebxekabarcdtfgDaHBdbaDclfazBdbaDcwfamBdbkavc;abfalcitfgDamBdbaDazBdlavaicdtfamBdbavc;abfalcefcsGglcitfgDaHBdbaDamBdlaicefhialcefhlxekdnaDcpe0mbaxcefgOavaiaqaDcsGfRbbgscl49RcsGcdtfydbascz6gPEhDavaias9RcsGcdtfydbaOaPfgzascsGgOEhsaOThOdndnadcd9hmbabarcetfgHax87ebaHcdfaD87ebaHclfas87ebxekabarcdtfgHaxBdbaHclfaDBdbaHcwfasBdbkavaicdtfaxBdbavc;abfalcitfgHaDBdbaHaxBdlavaicefgicsGcdtfaDBdbavc;abfalcefcsGcitfgHasBdbaHaDBdlavaiaPfcsGgicdtfasBdbavc;abfalcdfcsGglcitfgDaxBdbaDasBdlalcefhlaiaOfhiazaOfhxxekaxcbaoRbbgHEgAaDc;:eSgDfhzaHcsGhCaHcl4hXdndnaHcs0mbazcefhOxekazhOavaiaX9RcsGcdtfydbhzkdndnaCmbaOcefhxxekaOhxavaiaH9RcsGcdtfydbhOkdndnaDTmbaocefhDxekaocdfhDao8SbegPcFeGhsdnaPcu9kmbaocofhAascFbGhscrhodninaD8SbbgPcFbGaotasVhsaPcu9kmeaDcefhDaocrfgoc8J9hmbkaAhDxekaDcefhDkasce4cbasceG9R7amfgmhAkdndnaXcsSmbaDhsxekaDcefhsaD8SbbgocFeGhPdnaocu9kmbaDcvfhzaPcFbGhPcrhodninas8SbbgDcFbGaotaPVhPaDcu9kmeascefhsaocrfgoc8J9hmbkazhsxekascefhskaPce4cbaPceG9R7amfgmhzkdndnaCcsSmbashoxekascefhoas8SbbgDcFeGhPdnaDcu9kmbascvfhOaPcFbGhPcrhDdninao8SbbgscFbGaDtaPVhPascu9kmeaocefhoaDcrfgDc8J9hmbkaOhoxekaocefhokaPce4cbaPceG9R7amfgmhOkdndnadcd9hmbabarcetfgDaA87ebaDcdfaz87ebaDclfaO87ebxekabarcdtfgDaABdbaDclfazBdbaDcwfaOBdbkavc;abfalcitfgDazBdbaDaABdlavaicdtfaABdbavc;abfalcefcsGcitfgDaOBdbaDazBdlavaicefgicsGcdtfazBdbavc;abfalcdfcsGcitfgDaABdbaDaOBdlavaiaHcz6aXcsSVfgicsGcdtfaOBdbaiaCTaCcsSVfhialcifhlkawcefhwalcsGhlaicsGhiarcifgrae6mbkkcbc99aoaqSEhokavc;aef8Kjjjjbaok:flevu8Jjjjjbcz9Rhvc9:hodnaecvfal0mbcuhoaiRbbc;:eGc;qe9hmbav9cb83iwaicefhraialfc98fhwdnaeTmbdnadcdSmbcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcdtfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfglBdbaoalBdbaDcefgDae9hmbxdkkcbhDindnaraw6mbc9:skarcefhoar8SbbglcFeGhidndnalcu9mmbaohrxekarcvfhraicFbGhicrhldninao8SbbgdcFbGaltaiVhiadcu9kmeaocefhoalcrfglc8J9hmbxdkkaocefhrkabaDcetfaic8Etc8F91aicd47avcwfaiceGcdtVgoydbfgl87ebaoalBdbaDcefgDae9hmbkkcbc99arawSEhokaok:wPliuo97eue978Jjjjjbca9Rhiaec98Ghldndnadcl9hmbdnalTmbcbhvabhdinadadpbbbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDpxbbbbbbbbbbbbbbbbp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpkbbadczfhdavclfgval6mbkkalae9pmeaipxbbbbbbbbbbbbbbbbgqpklbaiabalcdtfgdaeciGglcdtgv;8qbbdnalTmbaiaipblbgocKp:RecKp:Sep;6egraocwp:RecKp:Sep;6earp;Geaoczp:RecKp:Sep;6egwp;Gep;Kep;LegDaqp:2egqarpxbbbjbbbjbbbjbbbjgkp9op9rp;Kegrpxbb;:9cbb;:9cbb;:9cbb;:9cararp;MeaDaDp;Meawaqawakp9op9rp;Kegrarp;Mep;Kep;Kep;Jep;Negwp;Mepxbbn0bbn0bbn0bbn0gqp;KepxFbbbFbbbFbbbFbbbp9oaopxbbbFbbbFbbbFbbbFp9op9qarawp;Meaqp;Kecwp:RepxbFbbbFbbbFbbbFbbp9op9qaDawp;Meaqp;Keczp:RepxbbFbbbFbbbFbbbFbp9op9qpklbkadaiav;8qbbskdnalTmbcbhvabhdinadczfgxaxpbbbgopxbbbbbbFFbbbbbbFFgkp9oadpbbbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpkbbadaDakp9oawaopmbezHdiOAlvCXorQLp9qpkbbadcafhdavclfgval6mbkkalae9pmbaiaeciGgvcitgdfcbcaad9R;8kbaiabalcitfglad;8qbbdnavTmbaiaipblzgopxbbbbbbFFbbbbbbFFgkp9oaipblbgDaopmlvorxmPsCXQL358E8FpxFubbFubbFubbFubbp9op;6eaDaopmbediwDqkzHOAKY8AEgoczp:Sep;6egrp;Geaoczp:Reczp:Sep;6egwp;Gep;Kep;Legopxb;:FSb;:FSb;:FSb;:FSawaopxbbbbbbbbbbbbbbbbp:2egqawpxbbbjbbbjbbbjbbbjgmp9op9rp;Kegwawp;Meaoaop;Mearaqaramp9op9rp;Kegoaop;Mep;Kep;Kep;Jep;Negrp;Mepxbbn0bbn0bbn0bbn0gqp;Keczp:Reawarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9op9qgwaoarp;Meaqp;KepxFFbbFFbbFFbbFFbbp9ogopmwDKYqk8AExm35Ps8E8Fp9qpklzaiaDakp9oawaopmbezHdiOAlvCXorQLp9qpklbkalaiad;8qbbkk;4wllue97euv978Jjjjjbc8W9Rhidnaec98GglTmbcbhvabhoinaiaopbbbgraoczfgwpbbbgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklbaopxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblbpEb:T:j83ibaocwfarp5eaipblbpEe:T:j83ibawaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblbpEd:T:j83ibaocKfakp5eaipblbpEi:T:j83ibaocafhoavclfgval6mbkkdnalae9pmbaiaeciGgvcitgofcbcaao9R;8kbaiabalcitfgwao;8qbbdnavTmbaiaipblbgraipblzgDpmlvorxmPsCXQL358E8Fgqczp:Segkclp:RepklaaipxbbjZbbjZbbjZbbjZpx;Zl81Z;Zl81Z;Zl81Z;Zl81Zakpxibbbibbbibbbibbbp9qp;6ep;NegkaraDpmbediwDqkzHOAKY8AEgrczp:Reczp:Sep;6ep;MegDaDp;Meakarczp:Sep;6ep;Megxaxp;Meakaqczp:Reczp:Sep;6ep;Megqaqp;Mep;Kep;Kep;Lepxbbbbbbbbbbbbbbbbp:4ep;Jepxb;:FSb;:FSb;:FSb;:FSgkp;Mepxbbn0bbn0bbn0bbn0grp;KepxFFbbFFbbFFbbFFbbgmp9oaxakp;Mearp;Keczp:Rep9qgxaqakp;Mearp;Keczp:ReaDakp;Mearp;Keamp9op9qgkpmbezHdiOAlvCXorQLgrp5baipblapEb:T:j83ibaiarp5eaipblapEe:T:j83iwaiaxakpmwDKYqk8AExm35Ps8E8Fgkp5baipblapEd:T:j83izaiakp5eaipblapEi:T:j83iKkawaiao;8qbbkk:Pddiue978Jjjjjbc;ab9Rhidnadcd4ae2glc98GgvTmbcbheabhdinadadpbbbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepkbbadczfhdaeclfgeav6mbkkdnaval9pmbaialciGgecdtgdVcbc;abad9R;8kbaiabavcdtfgvad;8qbbdnaeTmbaiaipblbgocwp:Recwp:Sep;6eaocep:SepxbbjFbbjFbbjFbbjFp9opxbbjZbbjZbbjZbbjZp:Uep;Mepklbkavaiad;8qbbkk9teiucbcbydj1jjbgeabcifc98GfgbBdj1jjbdndnabZbcztgd9nmbcuhiabad9RcFFifcz4nbcuSmekaehikaikkkebcjwklz9Tbb",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]);if(typeof WebAssembly!="object")return{supported:!1};var n=WebAssembly.validate(t)?e:s,r,o=WebAssembly.instantiate(l(n),{}).then(function(y){r=y.instance,r.exports.__wasm_call_ctors()});function l(y){for(var A=new Uint8Array(y.length),T=0;T<y.length;++T){var M=y.charCodeAt(T);A[T]=M>96?M-97:M>64?M-39:M+4}for(var C=0,T=0;T<y.length;++T)A[C++]=A[T]<60?i[A[T]]:(A[T]-60)*64+A[++T];return A.buffer.slice(0,C)}function c(y,A,T,M,C,N,O){var q=y.exports.sbrk,j=M+3&-4,K=q(j*C),de=q(N.length),xe=new Uint8Array(y.exports.memory.buffer);xe.set(N,de);var Ve=A(K,M,C,de,N.length);if(Ve==0&&O&&O(K,j,C),T.set(xe.subarray(K,K+M*C)),q(K-q(0)),Ve!=0)throw new Error("Malformed buffer data: "+Ve)}var d={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},u={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},h=[],f=0;function p(y){var A={object:new Worker(y),pending:0,requests:{}};return A.object.onmessage=function(T){var M=T.data;A.pending-=M.count,A.requests[M.id][M.action](M.value),delete A.requests[M.id]},A}function m(y){for(var A="self.ready = WebAssembly.instantiate(new Uint8Array(["+new Uint8Array(l(n))+"]), {}).then(function(result) { result.instance.exports.__wasm_call_ctors(); return result.instance; });self.onmessage = "+_.name+";"+c.toString()+_.toString(),T=new Blob([A],{type:"text/javascript"}),M=URL.createObjectURL(T),C=h.length;C<y;++C)h[C]=p(M);for(var C=y;C<h.length;++C)h[C].object.postMessage({});h.length=y,URL.revokeObjectURL(M)}function b(y,A,T,M,C){for(var N=h[0],O=1;O<h.length;++O)h[O].pending<N.pending&&(N=h[O]);return new Promise(function(q,j){var K=new Uint8Array(T),de=++f;N.pending+=y,N.requests[de]={resolve:q,reject:j},N.object.postMessage({id:de,count:y,size:A,source:K,mode:M,filter:C},[K.buffer])})}function _(y){var A=y.data;if(!A.id)return self.close();self.ready.then(function(T){try{var M=new Uint8Array(A.count*A.size);c(T,T.exports[A.mode],M,A.count,A.size,A.source,T.exports[A.filter]),self.postMessage({id:A.id,count:A.count,action:"resolve",value:M},[M.buffer])}catch(C){self.postMessage({id:A.id,count:A.count,action:"reject",value:C})}})}return{ready:o,supported:!0,useWorkers:function(y){m(y)},decodeVertexBuffer:function(y,A,T,M,C){c(r,r.exports.meshopt_decodeVertexBuffer,y,A,T,M,r.exports[d[C]])},decodeIndexBuffer:function(y,A,T,M){c(r,r.exports.meshopt_decodeIndexBuffer,y,A,T,M)},decodeIndexSequence:function(y,A,T,M){c(r,r.exports.meshopt_decodeIndexSequence,y,A,T,M)},decodeGltfBuffer:function(y,A,T,M,C,N){c(r,r.exports[u[C]],y,A,T,M,r.exports[d[N]])},decodeGltfBufferAsync:function(y,A,T,M,C){return h.length>0?b(y,A,T,u[M],d[C]):o.then(function(){var N=new Uint8Array(y*A);return c(r,r.exports[u[M]],N,y,A,T,r.exports[d[C]]),N})}}}();typeof exports=="object"&&typeof module=="object"?module.exports=ds:typeof define=="function"&&define.amd?define([],function(){return ds}):typeof exports=="object"?exports.MeshoptDecoder=ds:(typeof self!="undefined"?self:globalThis).MeshoptDecoder=ds;class Ml{constructor(e,t,i){a(this,"light");a(this,"position");a(this,"rotation");this.light=e,this.position=t,this.rotation=i}get index(){const e=this.light.instances.indexOf(this);return console.assert(e!==-1,"Light instance not found"),e}setPosition(e,t,i){this.position.set(e,t,i),this.light.updated()}setRotation(e,t,i){this.rotation.yaw=Vt(e),this.rotation.pitch=Vt(t),this.rotation.roll=Vt(i),this.light.updated()}setRotationDeg(e,t,i){const n=oi(e),r=oi(t);this.setRotation(n,r,oi(i))}serialize(){return{position:this.position.toArray(),rotation:this.rotation.toDegTriple()}}}var hn=(s=>(s.POINT="point",s.SPOT="spot",s.AREA="area",s.SUN="sun",s))(hn||{});const ib=["angle","color","height","photometricProfile","strength","size","type","width"];function nb(s){switch(s){case"point":case"spot":case"area":return 25;case"sun":return 8}vs(s,"Unknown LightType")}function sb(s){switch(s){case"point":case"spot":case"area":return new Re(1,.88,.799);case"sun":return new Re(1,.799,.658)}vs(s,"Unknown LightType")}function rb(s){switch(s){case"point":case"spot":case"area":return .1;case"sun":return .02}vs(s,"Unknown LightType")}const ms=class ms extends kt{constructor(t){var i,n,r,o,l,c;super();a(this,"doNotImport");a(this,"instances",new Array);a(this,"_name");a(this,"_type");a(this,"_strength");a(this,"_color");a(this,"_size");a(this,"_width");a(this,"_height");a(this,"_angle");a(this,"_photometricProfile");this._name=t.name,this._type=(i=t.type)!=null?i:"spot",this._strength=(n=t.strength)!=null?n:nb(this._type),this._color=t.color!==void 0?new Re().fromArray(t.color):sb(this._type),this._size=(r=t.size)!=null?r:rb(this._type),this._width=(o=t.width)!=null?o:.2,this._height=(l=t.height)!=null?l:.2,this._angle=(c=t.angle)!=null?c:140,this._photometricProfile=t.photometricProfile,t.doNotImport===!0?this.doNotImport=!0:(this.doNotImport={},t.doNotImport&&Fc(t.doNotImport,ib,this.doNotImport))}forEachLightInstance(t){for(let i=0;i<this.instances.length;i+=1)t(this.instances[i])}get name(){return this._name}set name(t){this._name=t,this.updated()}get type(){return this._type}set type(t){this._type=t,this.updated()}get size(){return this._size}set size(t){this._size=t,this.updated()}get width(){return this._width}set width(t){this._width=t,this.updated()}get height(){return this._height}set height(t){this._height=t,this.updated()}get angle(){return this._angle}set angle(t){this._angle=t,this.updated()}get color(){return this._color}setColorRGB(t,i,n){this._color.setRGB(t,i,n),this.updated()}get strength(){return this._strength}set strength(t){this._strength=t,this.updated()}get photometricProfile(){return this._photometricProfile}set photometricProfile(t){this._photometricProfile=t,this.updated()}setDoNotImport(t,i){ye(typeof this.doNotImport!="boolean"),this.doNotImport[t]=i,this.updated()}addCreatedInstance(t){ye(t.light===this),this.instances.push(t),this.dispatchEvent({type:ms.instanceAddedEventType,instance:t})}addInstance(t,i=[0,-90,0]){const n=new B().fromArray(t),r=new mi().setFromDegTriple(i);this.addCreatedInstance(new Ml(this,n,r))}removeInstance(t){zi(t,this.instances),this.dispatchEvent({type:ms.instanceRemovedEventType,instance:t})}serialize(){return{name:this.name,type:this.type,angle:this.angle,strength:this.strength,photometricProfile:this.photometricProfile,size:this.size,width:this.width,height:this.height,color:this.color.roundChannels().toArray(),doNotImport:this.doNotImport,instances:this.instances.map(t=>t.serialize())}}updated(){this.dispatchEvent({type:ms.updatedEventType,target:this})}static iterateLightInstances(t,i){let n=1;for(const r of t)for(const o of r.instances)i(r,o,n++)}static loadInstances(t,i){t.forEach(n=>i.addInstance(n.position,n.rotation))}static loadLights(t){const i=new Array;return t==null||t.forEach(function(n){const r=new ms(n);ms.loadInstances(n.instances,r),i.push(r)}),i}};a(ms,"updatedEventType","lightUpdated"),a(ms,"instanceAddedEventType","instanceAdded"),a(ms,"instanceRemovedEventType","instanceRemoved");let dn=ms;function ob(){return{enabled:!1,outlineColor:[0,0,0],outlineThickness:1,fillEnabled:!0,levels:[]}}function ab(s){return s!==void 0?s:ob()}function lb(s){return s&&s.trim()||"level"}class Uh{constructor(e,t,i){a(this,"_boundingBox");a(this,"_updatedCallback");a(this,"_name");a(this,"_slicePlaneHeight");a(this,"_farPlaneHeight");a(this,"_rotation");a(this,"_crop");a(this,"_cropRange");a(this,"_ratio");a(this,"_visibleRange");this._boundingBox=t,this._updatedCallback=i,this._name=e.name||"level",this._slicePlaneHeight=e.slicePlaneHeight,this._farPlaneHeight=e.farPlaneHeight,this._rotation=e.rotation||0,this._crop=!!e.cropRange,this._cropRange=e.cropRange?new Do(new Ue().fromArray(e.cropRange.min),new Ue().fromArray(e.cropRange.max)):new Do,this._ratio=new Ue(1,1),this._visibleRange=new Do,this._crop&&this._updateRatio()}_setDefaultRange(){this._cropRange.set(new Ue(this._boundingBox.min.x,this._boundingBox.min.y),new Ue(this._boundingBox.max.x,this._boundingBox.max.y))}_updateVisibleRange(){const e=this._cropRange.center(),t=Math.abs(Math.sin(this._rotation)),i=Math.abs(Math.cos(this._rotation)),n=Math.abs(this._cropRange.max.x-this._cropRange.min.x),r=Math.abs(this._cropRange.max.y-this._cropRange.min.y),o=n*i+r*t,l=n*t+r*i;this._visibleRange.set(new Ue(e.x-o/2,e.y+l/2),new Ue(e.x+o/2,e.y-l/2))}_updateRatio(){const e=Math.abs(this._boundingBox.min.x-this._boundingBox.max.x),t=Math.abs(this._boundingBox.min.y-this._boundingBox.max.y),i=this._cropRange.size().x/e,n=this._cropRange.size().y/t;i>n?this._ratio.set(1,n/i):this._ratio.set(i/n,1)}setRange(e,t,i){e>this._cropRange.max[i]&&(e=this._cropRange.max[i]),t<this._cropRange.min[i]&&(t=this._cropRange.min[i]),this._cropRange.min[i]=e,this._cropRange.max[i]=t,this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}serialize(){const e=this._crop?{min:this._cropRange.min.toArray(),max:this._cropRange.max.toArray()}:null;return{name:this.name,slicePlaneHeight:this.slicePlaneHeight,farPlaneHeight:this.farPlaneHeight,cropRange:e,rotation:this.rotation}}get name(){return this._name}set name(e){this._name=lb(e),this._updatedCallback()}get slicePlaneHeight(){return this._slicePlaneHeight}set slicePlaneHeight(e){e>=this._farPlaneHeight&&(this._slicePlaneHeight=e,this._updatedCallback())}get farPlaneHeight(){return this._farPlaneHeight}set farPlaneHeight(e){e<=this._slicePlaneHeight&&(this._farPlaneHeight=e,this._updatedCallback())}get crop(){return this._crop}set crop(e){this._crop=e,e||this._setDefaultRange(),this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}get cropRange(){return this._cropRange.empty()&&this._setDefaultRange(),this._cropRange}get visibleRange(){return this._visibleRange.empty()&&this._updateVisibleRange(),this._visibleRange}get ratio(){const e=this._ratio;return(e.x===0||e.y===0||!isNaN(e.x)||!isNaN(e.y))&&this._updateRatio(),e}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._crop||this._setDefaultRange(),this._updateVisibleRange(),this._updateRatio(),this._updatedCallback()}get rotationDeg(){return mn(this.rotation)}set rotationDeg(e){this.rotation=oi(e)}}const gc=class gc extends kt{constructor(t,i){var c,d;super();a(this,"_boundingBox");a(this,"_defaultViewHeight");a(this,"_updated");a(this,"_enabled");a(this,"_outlineColor");a(this,"_outlineThickness");a(this,"_fillEnabled");a(this,"_levels");const n=t.minimap,r=t.views||[];this._boundingBox=i,this._defaultViewHeight=(d=(c=r.at(0))==null?void 0:c.position)==null?void 0:d.at(2);const o=ab(n),l={type:gc.updatedEventType};this._updated=()=>this.dispatchEvent(l),this._enabled=o.enabled,this._outlineColor=new Re().fromArray(o.outlineColor),this._outlineThickness=o.outlineThickness,this._fillEnabled=o.fillEnabled,this._levels=o.levels.map(u=>new Uh(u,i,this._updated))}_firstLevel(){var r;const t="level0",i=(r=this._defaultViewHeight)!=null?r:this._boundingBox.min.z+D.FALLBACK_CAMERA_HEIGHT,n=this._boundingBox.min.z;return new Uh({name:t,slicePlaneHeight:i,farPlaneHeight:n},this._boundingBox,this._updated)}_nextLevel(t,i){const n="level"+t,r=this._levels[t-1],o=this._boundingBox.max.z-r.slicePlaneHeight,l=r.slicePlaneHeight+o/2,c=r.farPlaneHeight,d=r.rotation,u=i.crop?{min:i.cropRange.min.toArray(),max:i.cropRange.max.toArray()}:void 0;return new Uh({name:n,slicePlaneHeight:l,farPlaneHeight:c,cropRange:u,rotation:d},this._boundingBox,this._updated)}_serializeLevels(){return this._levels.map(t=>t.serialize())}createLevel(t){const i=this._levels.length;return i===0?this._firstLevel():(tt(t),this._nextLevel(i,t))}addLevel(t){this._levels.push(t),this._updated()}removeLevel(t){zi(t,this._levels),this._levels.length===0&&this._levels.push(this._firstLevel()),this._updated()}shiftLevel(t,i){tl(this._levels,t,i),this._updated()}getLevelsIndex(t){return this._levels.findIndex(i=>i===t)}setOutlineColorRGB(t,i,n){this._outlineColor.setRGB(t,i,n),this._updated()}serialize(){return{enabled:this.enabled,outlineColor:this.outlineColor.toArray(),outlineThickness:this.outlineThickness,fillEnabled:this.fillEnabled,levels:this._serializeLevels()}}get enabled(){return this._enabled}set enabled(t){t&&this._levels.length===0&&this.addLevel(this.createLevel()),this._enabled=t,this._updated()}get outlineColor(){return this._outlineColor}get outlineThickness(){return this._outlineThickness}set outlineThickness(t){this._outlineThickness=t,this._updated()}get fillEnabled(){return this._fillEnabled}set fillEnabled(t){this._fillEnabled=t,this._updated()}get levels(){return this._levels}};a(gc,"updatedEventType","minimapConfigUpdated");let sa=gc;function Yf(s){return Vt(oi(s))}var Mr=(s=>(s.ORBIT="orbit",s.FPS="fps",s))(Mr||{});const cb={internal:!1,position:[0,0,0],rotation:[0,0],hideFromMenu:!0,sky:D.EDITOR_CONTROLLED_SKY_NAME},Ro=class Ro extends kt{constructor(t=cb){var n,r,o,l,c,d,u,h,f,p,m,b,_;super();a(this,"id");a(this,"name");a(this,"internal");a(this,"position");a(this,"rotation");a(this,"hideFromMenu");a(this,"sky");a(this,"mode");a(this,"orthographic");a(this,"orthoFrustumSize");a(this,"distance");a(this,"panPrimary");a(this,"noRotate");a(this,"noPitchRotate");a(this,"noPan");a(this,"minDistance");a(this,"maxDistance");a(this,"minUpAngle");a(this,"maxUpAngle");a(this,"minSideAngle");a(this,"maxSideAngle");a(this,"target");a(this,"fov");a(this,"_updated");this.id=t.id!==void 0?t.id:Ro._nextViewAutoId++,this.name=t.name||"view"+this.id,this.internal=(n=t.internal)!=null?n:!1,t.position&&(this.position=new B(t.position[0],t.position[1],t.position[2])),t.rotation&&(this.rotation=new mi(Yf(t.rotation[0]),Yf(t.rotation[1]),0)),this.hideFromMenu=(r=t.hideFromMenu)!=null?r:!1,this.sky=(o=t.sky)!=null?o:D.EDITOR_CONTROLLED_SKY_NAME,this.mode=(l=t.mode)!=null?l:"fps",this.orthographic=(c=t.orthographic)!=null?c:!1,this.orthoFrustumSize=(d=t.orthoFrustumSize)!=null?d:D.CAMERA_ORTHO_FRUSTUM_SIZE,this.distance=t.distance,this.panPrimary=t.panPrimary,this.noRotate=t.noRotate,this.noPitchRotate=t.noPitchRotate,this.noPan=(u=t.noPan)!=null?u:!1,this.minDistance=(h=t.minDistance)!=null?h:1,this.maxDistance=(f=t.maxDistance)!=null?f:100,this.minUpAngle=(p=t.minUpAngle)!=null?p:-Math.PI/2,this.maxUpAngle=(m=t.maxUpAngle)!=null?m:Math.PI/2,this.minSideAngle=(b=t.minSideAngle)!=null?b:-Math.PI,this.maxSideAngle=(_=t.maxSideAngle)!=null?_:Math.PI,t.target&&(this.target=new B(t.target[0],t.target[1],t.target[2])),this.fov=t.fov;const i={type:Ro.updatedEventType,target:this};this._updated=()=>this.dispatchEvent(i)}isTop(){return!!(this.mode==="orbit"&&this.panPrimary&&this.noPitchRotate)}isOrbit(){return this.mode==="orbit"&&!this.isTop()}usesDefaultSky(){return this.sky===D.DEFAULT_SKY_NAME}switchSky(){this.usesDefaultSky()?this.sky=D.EDITOR_CONTROLLED_SKY_NAME:this.sky=D.DEFAULT_SKY_NAME,this._updated()}setName(t){this.name=t,this._updated()}getCameraParameters(){var t,i,n;return{position:(t=this.position)==null?void 0:t.toArray(),rotation:(i=this.rotation)==null?void 0:i.toDegTriple(),target:(n=this.target)==null?void 0:n.toArray(),distance:this.distance}}setCameraParameters(t){t.position?(this.position||(this.position=new B),this.position.fromArray(t.position)):this.position=void 0,t.rotation?(this.rotation||(this.rotation=new mi),this.rotation.setFromDegTriple(t.rotation)):this.rotation=void 0,this.distance=t.distance,t.target?(this.target||(this.target=new B),this.target.fromArray(t.target)):this.target=void 0}setPosition(t,i,n){ye(this.position),this.position.set(t,i,n),this._updated()}setYaw(t){ye(this.rotation),this.rotation.yaw=t,this._updated()}setMinUpAngle(t){t!==this.minUpAngle&&(this.minUpAngle=t,this._updated())}setMaxUpAngle(t){t!==this.maxUpAngle&&(this.maxUpAngle=t,this._updated())}setMinSideAngle(t){t!==this.minSideAngle&&(this.minSideAngle=t,this._updated())}setMaxSideAngle(t){t!==this.maxSideAngle&&(this.maxSideAngle=t,this._updated())}setHideFromMenu(t){t!==this.hideFromMenu&&(this.hideFromMenu=t,this._updated())}setMinDistance(t){t!==this.minDistance&&(this.minDistance=t,this._updated())}setMaxDistance(t){t!==this.maxDistance&&(this.maxDistance=t,this._updated())}setNoPan(t){t!==this.noPan&&(this.noPan=t,this._updated())}toCamera(){const t=new br;return this.orthographic?ye(!1,"TODO(kj): writeme"):(ye(this.position),ye(this.rotation),t.position.copyFrom(this.position),t.rotation.copyFrom(this.rotation)),t.updateMatrixWorld(!0),t.matrixWorldInverse.getInverse(t.matrixWorld),t}serialize(){var i;const t={id:this.id,name:this.name,mode:this.mode,rotation:(i=this.rotation)==null?void 0:i.toDegTriple().slice(0,2),hideFromMenu:this.hideFromMenu,sky:this.sky};return this.position&&(t.position=this.position.toArray()),this.target&&(t.target=this.target.toArray()),this.minSideAngle!==-1/0&&(t.minSideAngle=this.minSideAngle),this.maxSideAngle!==1/0&&(t.maxSideAngle=this.maxSideAngle),this.orthographic&&(t.orthographic=this.orthographic,t.orthoFrustumSize=this.orthoFrustumSize),this.distance!==void 0&&(t.distance=this.distance),this.minDistance!==void 0&&(t.minDistance=this.minDistance),this.maxDistance!==void 0&&(t.maxDistance=this.maxDistance),this.panPrimary!==void 0&&(t.panPrimary=this.panPrimary),this.noPan!==void 0&&(t.noPan=this.noPan),this.noRotate!==void 0&&(t.noRotate=this.noRotate),this.noPitchRotate!==void 0&&(t.noPitchRotate=this.noPitchRotate),this.minUpAngle!==void 0&&(t.minUpAngle=this.minUpAngle),this.maxUpAngle!==void 0&&(t.maxUpAngle=this.maxUpAngle),this.fov!==void 0&&(t.fov=this.fov),t}};a(Ro,"_nextViewAutoId",1e3),a(Ro,"updatedEventType","viewUpdated");let Qi=Ro;class Pr{constructor(){this.clock=performance||Date,this.reset()}reset(){this.startMS=this.clock.now()}elapsedMSec(){return this.clock.now()-this.startMS}elapsedSec(){return this.elapsedMSec()*.001}}class zh{constructor(e,t){this.nativeTimeoutId=null,this.durationMSec=e,this.callback=t}isRunning(){return this.nativeTimeoutId!==null}start(){function e(){this.nativeTimeoutId=null,this.callback&&this.callback()}this.nativeTimeoutId!==null&&clearTimeout(this.nativeTimeoutId),this.nativeTimeoutId=setTimeout(e,this.durationMSec)}}function hb(s,e){const t=new Pr,i=new Uint8Array(1*1*4),n=D.BENCHMARK_MEASUREMENTS?parseInt(D.BENCHMARK_MEASUREMENTS):60*16,r=3,o=.1;this.benchmarking=e;const l="EXT_disjoint_timer_query_webgl2",c=s,d=c.getSupportedExtensions().includes(l)?c.getExtension(l):null;d||alert(l+" support isn't enabled in this browser. Using gl.readPixels() as a means of synchronisation.");let u=null,h=!1,f=!1,p=[];this.lastMS=0,this.lastFPS=0,this.benchmarking&&document.addEventListener("keydown",m=>{m.code=="KeyB"&&(m.shiftKey?this.extensiveLogging():p=[])}),this.tearDownQuery=function(){h=!1,f=!1,u&&(c&&c.deleteQuery(u),u=null)},this.extensiveLogging=function(){const m=Array.from(p).sort((M,C)=>M-C);this.max=m.at(-1);const b=Math.floor(m.length*(1-o)),_=Math.floor(m.length/2),y=Math.floor(m.length*o),A=m.reduce((M,C)=>M+C,0)/m.length;let T;D.BENCHMARK_LIST_ALL?T=m.reduce((M,C)=>M+C.toFixed(r)+";",""):T=`high median average low 
`+m[b].toFixed(r)+" "+m[_].toFixed(r)+" "+A.toFixed(r)+" "+m[y].toFixed(r)+` 
`,D.BENCHMARK_OUTPUT==="console"?console.log(T):prompt(T+`
You can copy the result of the performance measurement by CTRL-C`,T),p=[]},this.addNewMeasurement=function(m){this.lastMS=m,this.lastFPS=1e3/this.lastMS,this.benchmarking&&(p.push(this.lastMS),p.length==n&&this.extensiveLogging())},this.glQueryEnd=function(){if(f||(c.endQuery(d.TIME_ELAPSED_EXT),f=!0),c.getParameter(d.GPU_DISJOINT_EXT)){this.tearDownQuery();return}if(!c.getQueryParameter(u,c.QUERY_RESULT_AVAILABLE))return;const _=c.getQueryParameter(u,c.QUERY_RESULT);this.addNewMeasurement(_/Math.pow(10,6)),this.tearDownQuery()},this.begin=function(){t.reset(),d&&!h&&(u=c.createQuery(),c.beginQuery(d.TIME_ELAPSED_EXT,u),h=!0)},this.end=function(){d?h&&this.glQueryEnd():(c.readPixels(0,0,1,1,c.RGBA,c.UNSIGNED_BYTE,i),this.addNewMeasurement(t.elapsedSec()*1e3))}}function Qf(s,e){let t=null;function i(){t=null,s()}this.deferRun=function(){t!==null&&clearTimeout(t),t=setTimeout(i,e)}}function db(s,e){let t=null;function i(){s()}this.deferRun=function(){t!==null&&clearInterval(t),t=setInterval(i,e)}}function Cn(s,e,t){this.textureID=e!==void 0?e:"tDiffuse",this.depthID=t!==void 0?t:"tDepth",this.material=new ai({vsName:s.vertexShaderName,fsName:s.fragmentShaderName}),this.material.uniforms=gl.clone(s.uniforms),this.uniforms=this.material.uniforms,this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.camera=Vi.createNDC(),this.scene=new uo,this.quad=new Je(dt.createPlane(2,2),this.material),this.scene.add(this.quad)}Cn.prototype={render:function(s,e,t,i){const n=this.material.uniforms[this.textureID];n&&(n.value=t);const r=this.material.uniforms[this.depthID];r&&(r.value=t.depthTexture),this.renderToScreen?s.render(this.scene,this.camera):s.render(this.scene,this.camera,e,this.clear)},dispose:function(){this.material.dispose(),this.quad.geometry.dispose()}};const Kf=s=>{const e=s.createRenderTarget(512,512,{format:nt.RGBA16F,magFilter:ne.LINEAR,minFilter:ne.LINEAR,stencilBuffer:!1,generateMipmaps:!1}),t={vertexShaderName:"brdf_vertex.glsl",fragmentShaderName:"brdf_fragment.glsl"},i=new Cn(t),n=new ws(s);return n.set(!0,!1,!1),i.render(s,e),n.restore(),i.dispose(),e};class ub{constructor(e,t){a(this,"lightmapCount");a(this,"encoding");a(this,"format");a(this,"thresholds");this.lightmapCount=e;const i=new ln(t);this.encoding=i.parseEnum("encoding",to,to.RGBM),this.thresholds=i.parseNumbers("thresholds");const r=i.parseStrings("formats").indexOf("webp")>=0;this.format=r?"webp":"png"}load(e){const t=ne.NEAREST,i=[];for(let n=0;n<this.lightmapCount;n+=1){const r=new Qs;r.id=r.name="lightmap-"+this.encoding+n,r.stdExt=this.format,r.encoding=this.encoding,r.alpha=!0,r.webFormats=["large/std"];const o=e.load(r,gn.NONE,D.LOAD_PRIORITY.LIGHTMAP);o.anisotropy=wt.NO_ANISOTROPY,o.magFilter=t,o.minFilter=t,o.ycocgmThreshold=this.thresholds.at(n)||0,o.encoding=this.encoding,i.push(o)}return[this.encoding,i]}}class Vh{constructor(){a(this,"totalResources",0);a(this,"loadedResources",0);a(this,"totalBytes",0);a(this,"loadedBytes",0)}reset(){this.totalResources=this.loadedResources=0,this.totalBytes=this.loadedBytes=0}isFinished(){return this.totalResources==this.loadedResources}progress(){return this.totalBytes==0?0:this.loadedBytes/this.totalBytes}add(e){this.totalResources+=e.totalResources,this.loadedResources+=e.loadedResources,this.totalBytes+=e.totalBytes,this.loadedBytes+=e.loadedBytes}}const fb=["cutoutMaskThreshold","doubleSided","name","opacity","parallaxCorrection","parallaxMode","parallaxScale","parallaxMinLayers","parallaxMaxLayers"],pb=["bumpScale","cutoutMode","emissive","emissionStrength","envMapProject","metallic","roughness","alphaInLowerHalf","chromaKeyEnabled"],mb=["baseColor","bumpScale","bumpTexture","doubleSided","emissive","metallic","opacity","roughness"];function Zf(s,e,t){for(let i=0;i<e.length;i+=1){const n=e[i],r=s[n];r!==void 0&&(t["_"+n]=r)}}const $f=D.LOAD_PRIORITY.DIFFUSE,Jf=D.LOAD_PRIORITY.SPECULARITY,Gh=gn.REPEAT_WRAPPING|gn.GENERATE_MIPS|(D.PUPPETEER_TEST?gn.PAUSE_LOADED_VIDEO:0);class Hh{constructor(e,t,i=!1){a(this,"_textureManager");a(this,"_mergeConfig");a(this,"_textureAtlases");a(this,"_postponeTexLoad");this._textureManager=e,this._mergeConfig=t,this._textureAtlases=e.atlases(),this._postponeTexLoad=i}_loadTexture(e,t,i){return this._textureManager.load(e,t,i,!1,this._postponeTexLoad)}getAtlasEntry(e){e instanceof hl||(e=hl.parse(e));const i=this._textureAtlases.get(e.atlasId).getAtlasEntry(e.id,e.name,e.atlasOffset[0],e.atlasOffset[1],e.atlasScale[0],e.atlasScale[1]);return i.rawExt!==void 0&&i.rawExt!==e.rawExt&&console.warn("Atlas entries with not matching rawExt "+e.name),i.rawExt=e.rawExt,i.stdExt!==void 0&&i.stdExt!==e.stdExt&&console.warn("Atlas entries with not matching stdExt "+e.name),i.stdExt=e.stdExt,i.importGpuCompress=e.importGpuCompress!==!1,i.importAutoScale=e.importAutoScale!==!1,i}applyBaseColorTexture(e,t){const i=t.baseColorTexture;if(i){let n;i.atlasId?n=this.getAtlasEntry(i):n=this._loadTexture(i,Gh,$f),n.isCutout=void 0,e.baseColorTexture=n}}parseTexture(e,t,i,n=Gh,r=$f){const l=new ln(t).parseObject(i);l&&(e[i]=this._loadTexture(l,n,r))}applyBaseColor(e,t){t.baseColor&&(e.baseColor.fromArray(t.baseColor),e.baseColor.roundChannels())}applyTextureCorrection(e,t,i){const n=i[t+"Correction"];e.loadCorrection(t,n)}applyUvOffsetScale(e,t){if(t.uvOffsetScale){const i=t.uvOffsetScale;e.setUvOffsetAndScale(i[0],i[1],i[2],i[3])}}applyAntiTiling(e,t){const i=t.antiTiling;if(i!==void 0&&(e.antiTilingType=i.antiTilingType,e.antiTilingType==="Regular")){const n=i.antiTilingRegularParameters;for(const r of Object.keys(Mu))e.setAntiTilingRegularParameters(r,n[r])}}applyAttribute(e,t,i){i[e]&&(t[e]=i[e])}applyDoNotImport(e,t){t.doNotImport&&Fc(t.doNotImport,mb,e.doNotImport)}applyChromaKey(e,t){const i=t.chromaKeyColor;i&&(e.chromaKeyColor.fromArray(i),e.chromaKeyColor.roundChannels());const n=t.chromaKeyDelta;n&&e.chromaKeyDelta.fromArray(n)}setGrassMaterialProperties(e,t){return e.name=t.name,this.applyBaseColorTexture(e,t),this.parseTexture(e,t,"heightTexture"),this.applyBaseColor(e,t),this.applyTextureCorrection(e,Pn.BASE_COLOR,t),this.applyAttribute("grassHeight",e,t),this.applyAttribute("grassLayers",e,t),this.applyAttribute("grassDirection",e,t),this.applyUvOffsetScale(e,t),this.applyAntiTiling(e,t),e}setWaterMaterialProperties(e,t){return e.name=t.name,this.parseTexture(e,t,"normalTexture",gn.REPEAT_WRAPPING,Jf),this.applyBaseColor(e,t),this.applyAttribute("opacity",e,t),Zf(t,["wavesSpeed","wavesScale","refractionFactor"],e),e.setUniforms(),e}setStandardMaterialProperties(e,t){Fc(t,fb,e),t.reflective!==void 0?e._reflective=t.reflective:e._reflective=!!(t.roughnessTexture||t.roughness!==1),Zf(t,pb,e),this.applyBaseColor(e,t),this.applyTextureCorrection(e,Pn.BASE_COLOR,t),this.applyBaseColorTexture(e,t);for(const i of[Pn.ROUGHNESS,Pn.METALLIC,Pn.BUMP])this.parseTexture(e,t,i,Gh,Jf),this.applyTextureCorrection(e,i,t);return this.applyDoNotImport(e,t),this.applyChromaKey(e,t),this.applyUvOffsetScale(e,t),this.applyAntiTiling(e,t),e}createMaterial(e){const t=hp(e.type);switch(t.type){case"grass":return this.setGrassMaterialProperties(t,e);case"water":return this.setWaterMaterialProperties(t,e);default:return this.setStandardMaterialProperties(t,e)}}getMaterial(e){return this.createMaterial(e)}load(e,t){const i=new Map;let n=0;const r=o=>{if(this._mergeConfig.isMaterialEditable(o.name))return o;const l=o.hash(),c=i.get(l)||[];for(const d of c)if(d.canMerge(o)){n+=1,d.merged=!0,o=d;break}return o.merged||(c.push(o),i.set(l,c)),o};for(const o of e){let l=this.createMaterial(o);l=r(l),t.addMaterial(l),l.merged||l.setUniforms()}n>0&&Le.log(`Merged ${e.length} materials down to ${e.length-n}.`)}}const ep=(s,e)=>{const t=s%e;return s+(t==0?0:e-t)};class gb{constructor(e,t){a(this,"data");a(this,"byteOffset");this.data=e,this.byteOffset=t}readBlock(e,t){const i=new e(this.data,this.byteOffset,t);return this.byteOffset+=t*e.BYTES_PER_ELEMENT,i}alignOffset(e=4){this.byteOffset=ep(this.byteOffset,e)}}class _b{constructor(e,t,i,n,r){a(this,"faces");a(this,"vertices");a(this,"normals");a(this,"uvs0");a(this,"uvs1");this.faces=e,this.vertices=t,this.normals=i,this.uvs0=n,this.uvs1=r}numVertices(){return this.vertices.length/3}numFaces(){return this.faces.length}}class Pl{constructor(e,t,i){a(this,"scaleFactor");a(this,"bytesPerEntry");a(this,"isInteger");this.scaleFactor=e,this.bytesPerEntry=t,this.isInteger=i}static parse(e){const t=new Float32Array(e.buffer,e.byteOffset,e.length),i=e.length/2,n=[];for(let r=0;r<i;r++){const o=t[r*2+0],l=e[r*2+1],c=l>0;n.push(new Pl(o,Math.abs(l),c))}return n}}class vb{constructor(e){a(this,"meshFlags");a(this,"meshIndices");a(this,"meshNumFaces");a(this,"meshNumVertices");a(this,"uvs0QuantInfo");a(this,"vertsQuantInfo");a(this,"quantizedVertices");a(this,"quantizedUvs0");a(this,"normals");a(this,"encodedFaces");a(this,"encodedUvs1");const t=e.readBlock(Uint32Array,7),i=t[0],n=t[1],r=t[2],o=t[3],l=t[4],c=t[5];this.meshFlags=t[6],this.meshIndices=e.readBlock(Uint32Array,i),this.meshNumFaces=e.readBlock(Uint32Array,i),this.meshNumVertices=e.readBlock(Uint32Array,i);const d=fr(this.meshFlags,2);this.uvs0QuantInfo=Pl.parse(e.readBlock(Int32Array,d?i*2:0)),this.vertsQuantInfo=Pl.parse(e.readBlock(Int32Array,i*2)),this.quantizedVertices=e.readBlock(Uint8Array,r),this.quantizedUvs0=e.readBlock(Uint8Array,l),this.normals=e.readBlock(Int8Array,o),this.encodedFaces=e.readBlock(Uint8Array,n),this.encodedUvs1=e.readBlock(Uint8Array,c),e.alignOffset()}numMeshes(){return this.meshIndices.length}numVertices(){return this.meshNumVertices.reduce((e,t)=>e+t,0)}numFaces(){return this.meshNumFaces.reduce((e,t)=>e+t,0)}dequantizeUvs0(e){const t=this.numMeshes(),i=new Float32Array(e*2),n=new Array(t);if(n.fill(!1,0,t),e==0)return[null,n];const r=this.quantizedUvs0,o=new Uint32Array(r.buffer,r.byteOffset,r.byteLength/4),l=new Float32Array(r.buffer,r.byteOffset,r.byteLength/4);let c=0,d=0;for(let u=0;u<t;u++){const h=this.uvs0QuantInfo[u],f=this.meshNumVertices[u];if(h.isInteger){for(let p=0;p<f;p++){const m=o[c+p];i[d+p*2+0]=(m&65535)*h.scaleFactor,i[d+p*2+1]=(m>>16)*h.scaleFactor}c+=f}else{for(let p=0;p<f*2;p++){const m=l[c+p];i[d+p]=m,n[u]=m<0||m>1}c+=f*2}d+=f*2}return[i,n]}dequantizeVertices(e){const t=this.numMeshes(),i=new Float32Array(e*3),n=this.quantizedVertices;let r=0,o=0;for(let l=0;l<t;l++){const c=this.vertsQuantInfo[l],u=this.meshNumVertices[l]*3;if(ye(c.isInteger),c.bytesPerEntry==1){const h=new Int8Array(n.buffer,n.byteOffset+r,u);for(let f=0;f<u;f++)i[o+f]=h[f]*c.scaleFactor}else if(c.bytesPerEntry==2){const h=new Int16Array(n.buffer,n.byteOffset+r,u);for(let f=0;f<u;f++)i[o+f]=h[f]*c.scaleFactor}else{ye(c.bytesPerEntry==4);const h=new Int32Array(n.buffer,n.byteOffset+r,u);for(let f=0;f<u;f++)i[o+f]=h[f]*c.scaleFactor}r=ep(r+u*c.bytesPerEntry,4),o+=u}return i}parse(e){const t=this.numVertices(),i=this.numFaces(),n=this.quantizedUvs0.byteLength>0,r=this.encodedUvs1.byteLength>0,o=i*3,l=this.dequantizeVertices(t),c=this.normals,[d]=this.dequantizeUvs0(n?t:0),u=new Uint8Array(r?t*4:0);t>0&&r&&e.decodeVertexBuffer(u,t,4,this.encodedUvs1);const h=u.byteLength/2,f=h==0?null:new Uint16Array(u.buffer,u.byteOffset,h),p=new Uint32Array(o);if(o>0){const m=new Uint8Array(p.buffer,p.byteOffset,p.byteLength);e.decodeIndexBuffer(m,o,4,this.encodedFaces)}return new _b(p,l,c,d,f)}}class bb{constructor(e){a(this,"meshInstanceIndices");a(this,"meshIndices");a(this,"nodeIndices");a(this,"materialIndices");a(this,"lightmapIndices");a(this,"uv1Transforms");a(this,"transforms");const i=e.readBlock(Uint32Array,1)[0];this.meshInstanceIndices=e.readBlock(Uint32Array,i),this.meshIndices=e.readBlock(Uint32Array,i),this.nodeIndices=e.readBlock(Uint32Array,i),this.materialIndices=e.readBlock(Uint16Array,i),this.lightmapIndices=e.readBlock(Uint8Array,i),e.alignOffset(),this.uv1Transforms=e.readBlock(Float32Array,i*4),this.transforms=e.readBlock(Float32Array,i*12)}numMeshInstances(){return this.meshInstanceIndices.length}}class yb{constructor(e){a(this,"numSegments");a(this,"boundingBoxes");a(this,"segmentNumTextureSegments");a(this,"textureIndices");a(this,"initialSegments");const t=e.readBlock(Uint32Array,3);this.numSegments=t[0];const i=t[1],n=t[2];this.boundingBoxes=e.readBlock(Float32Array,this.numSegments*6),this.segmentNumTextureSegments=e.readBlock(Uint16Array,this.numSegments),this.textureIndices=e.readBlock(Uint16Array,n),this.initialSegments=e.readBlock(Uint16Array,i)}parseTexturesMap(){const e=new Array(this.numSegments);let t=0;for(let i=0;i<this.numSegments;i++){const n=this.segmentNumTextureSegments[i],r=new Array(n);for(let o=0;o<n;o++)r[o]=this.textureIndices[t+o];e[i]=r,t+=n}return e}}class xb{constructor(e){a(this,"numTextures");a(this,"numLightmaps");a(this,"textureNameLengths");a(this,"textureNames");const t=e.readBlock(Uint32Array,3);this.numTextures=t[0],this.numLightmaps=t[1];const i=t[2];this.textureNameLengths=e.readBlock(Uint8Array,this.numTextures),this.textureNames=e.readBlock(Uint8Array,i)}parse(){const e=new Array(this.numTextures),t=new TextDecoder;let i=0;for(let n=0;n<this.numTextures;n++){const r=this.textureNameLengths[n],o=this.textureNames.subarray(i,i+r);e[n]=t.decode(o),i+=r}return e}}class Ab{constructor(e){a(this,"data");a(this,"segmentIdx");a(this,"meshesChunks");a(this,"meshInstancesChunks");a(this,"segmentsChunk");a(this,"texturesChunk");const i=new DataView(e,0,16),n=i.getUint32(0,!0),r=i.getUint16(4,!0),o=i.getUint16(6,!0),l=i.getUint32(8,!0);this.segmentIdx=i.getInt32(12,!0),ye(n==1802528883),ye(r==1&&o==0),this.data=e,this.meshesChunks=[],this.meshInstancesChunks=[];let c,d;const u={0:y=>this.meshesChunks.push(new vb(y)),1:y=>this.meshInstancesChunks.push(new bb(y)),2:y=>{ye(!c,"Only single SegmentsChunk is allowed in Package"),c=new yb(y)},3:y=>{ye(!d,"Only single TexturesChunk is allowed in Package"),d=new xb(y)}},h=new gb(e,16),f=h.readBlock(Uint8Array,l);h.alignOffset();const p=h.readBlock(Uint32Array,l);for(let y=0;y<l;y++){const A=f[y],T=h.byteOffset+p[y];u[A](h),h.byteOffset=T}this.segmentsChunk=c,this.texturesChunk=d;const m=this.meshesChunks.reduce((y,A)=>y+A.meshIndices.length,0),b=this.meshInstancesChunks.reduce((y,A)=>y+A.meshInstanceIndices.length,0),_=this.segmentsChunk?this.segmentsChunk.numSegments:0;console.log(`ScenePackage ${this.segmentIdx}: meshes:${m} instances:${b} segments:${_}`)}}class Eb{constructor(e,t){a(this,"_assetsUrl");this._assetsUrl=e,this.load(-1,t)}load(e,t){console.assert(e>=-1);const i=Date.now(),n=c=>{const d=new Ab(c),u=Date.now()-i;console.log(`Loaded segment ${e}: size:${c.byteLength} in: ${u} ms`),t(e,d)},r=()=>{console.log("Failed to load segment: "+e)},o=c=>{},l=this._assetsUrl+(e==-1?"shared.buf":"segment"+e+".buf");_r(D.LOAD_PRIORITY.CORE_RESOURCE,l,!0,n,r,o,!0)}}class wb{constructor(e,t,i,n,r,o){a(this,"onProgress");a(this,"onMeshBuffersLoaded",null);a(this,"onReadyToDisplay");a(this,"onComplete");a(this,"panoramas");a(this,"_scene");a(this,"_assetsUrl");a(this,"_editMode");a(this,"_mergeConfig");a(this,"_textureManager");a(this,"_segmentManager");a(this,"_rawRenderer");a(this,"_timer",new Pr);a(this,"_segmentLoader");a(this,"_initialSegment");a(this,"_readyToDisplayCalled",!1);a(this,"_sceneJson");a(this,"_meshOptCompiled",!1);a(this,"_nextInitStep");a(this,"_timeout");a(this,"updateProgress",()=>{var i,n;this._timeout!==void 0&&clearTimeout(this._timeout);const e=new Vh;e.add(this._textureManager.loadingProgress());const t=(i=this._segmentManager)==null?void 0:i.loadingProgress();t&&e.add(t),(n=this.onProgress)==null||n.call(this,e.progress()),this._timeout=setTimeout(this.updateProgress,50)});ye(D.DEV_NEW_SCENE),this._scene=e,this._assetsUrl=t,this._editMode=i,this._mergeConfig=n,this._textureManager=r,this._rawRenderer=o,this.panoramas=[]}readyToDisplay(){var e;this._readyToDisplayCalled||(this._readyToDisplayCalled=!0,(e=this.onReadyToDisplay)==null||e.call(this,this._scene))}load(){const e=()=>{this._textureManager.loadingProgress().isFinished()&&el(()=>{var l;this._textureManager.freeLoadingBuffers(),this._textureManager.onTextureLoaded=void 0,this.readyToDisplay(),(l=this.onComplete)==null||l.call(this,this._scene)})},t=()=>{var u;if(!this._sceneJson)return;this._nextInitStep=i;const l=this._scene,c=new ln(this._sceneJson);l.autoAddLightProbes=c.parseBoolean("autoAddLightProbes",l.autoAddLightProbes),l.interactionPrompt=c.parseBoolean("interactionPrompt",l.interactionPrompt);const d=c.child("autoTour");l.autoTour.disabled=d.parseBoolean("disabled",!1),l.autoTour.startOnLoad=d.parseBoolean("startOnLoad",!1),l.addLights(dn.loadLights(c.parseObjects("lights"))),l.camera.setFromJson(c.parseObject("camera")),c.parseObjects("cameraVolumes").forEach(h=>l.addCameraAdjustmentVolume(new Id(h,l.camera,l.exposureController))),c.parseObjects("views").forEach(h=>l.addView(new Qi(h))),this._scene.createDefaultViews(),l.addNodeConfigsFromJson(this._sceneJson,this._mergeConfig),l.addNodesFromJson(this._sceneJson),(u=this._nextInitStep)==null||u.call(this)},i=()=>{var m;const l=this._sceneJson,c=this._scene;if(!l||!this._meshOptCompiled||!this._segmentLoader||!this._initialSegment)return;const d=new ln(l),u=d.parseObjects("atlases");ye(u==null||u.length==0),this._textureManager.onTextureLoaded=b=>{var _;return(_=this._nextInitStep)==null?void 0:_.call(this)},new Hh(this._textureManager,this._mergeConfig,!0).load(l.materials||[],this._scene),c.disableLightProbesForMaterials(),c.initSegmentManager(this._segmentLoader,ds,this._initialSegment),this._nextInitStep=e;const f=d.child("camera").parseObject("lutTexture");f&&(c.camera.colorMap=this._textureManager.loadColorMap(f)),c.lightmapLayoutVersion=d.child("lightmap").parseNumber("lightmapLayoutVersion",0),new Wh(this._textureManager).load(l.skies||[],c),c.findSkyMesh(D.EDITOR_CONTROLLED_SKY_NAME)===null&&console.error("A sky with name "+D.EDITOR_CONTROLLED_SKY_NAME+" is missing."),this.panoramas=d.parseObjects("panoramas"),c.minimapConfig=new sa(l,c.boundingBox),this._sceneJson=void 0,(m=this._nextInitStep)==null||m.call(this)};this._timer.reset(),this._nextInitStep=t;const n=l=>{var c;this._sceneJson=l,(c=this._nextInitStep)==null||c.call(this)},r=()=>Wt.sceneLoadError();_r(D.LOAD_PRIORITY.CORE_RESOURCE,this._assetsUrl+"scene.json",!1,n,r);const o=(l,c)=>{var d;this._initialSegment=c,(d=this._nextInitStep)==null||d.call(this)};if(this._segmentLoader=new Eb(this._assetsUrl,o),it.gl.colorBufferFloat){const l=Kf(this._rawRenderer);this._scene.addBrdfLUT(l)}ds.ready.then(()=>{var l;this._meshOptCompiled=!0,(l=this._nextInitStep)==null||l.call(this)}),this.updateProgress()}elapsedLoadTimeSec(){return this._timer.elapsedSec()}}const Sb="equirect_sky_vertex.glsl",Tb="equirect_sky_fragment.glsl";class tp extends ai{constructor(){super({vsName:Sb,fsName:Tb}),this.depthWrite=!1,this.side=Gi.FRONT,this.uniforms={map:{type:"t",value:null,uniformSourceType:ve.MATERIAL}},this.fogSupported=!0,this.hdrOutputSupported=!0,this.colorMapSupported=!0,this.exposureAndGammaSupported=!0,this.toneMappingSupported=!0}get map(){return this.uniforms.map.value}set map(e){this.uniforms.map.value=e,this.condDefine(this.map.encoding=="rgbm","USE_RGBM_MAP")}}class Mb{constructor(){a(this,"topColor",new Re);a(this,"bottomColor",new Re);a(this,"sinBottomAngle",0);a(this,"exponent",0)}}class Pb extends ai{constructor(){super({vsName:"procedural_sky_vertex.glsl",fsName:"procedural_sky_fragment.glsl",uniformBufferDataConstructor:Mb}),this.depthWrite=!1,this.side=Gi.BACK,this.uniforms={topColor:{type:"c",value:new Re(15135487),uniformSourceType:ve.MATERIAL},bottomColor:{type:"c",value:new Re(16777215),uniformSourceType:ve.MATERIAL},sinBottomAngle:{type:"f",value:Math.sin(oi(-30)),uniformSourceType:ve.MATERIAL},exponent:{type:"f",value:.9,uniformSourceType:ve.MATERIAL}},this.fogSupported=!0,this.hdrOutputSupported=!0,this.colorMapSupported=!0,this.exposureAndGammaSupported=!0,this.toneMappingSupported=!0,this.fillMaterialUniformDataFromUniforms()}}const _c=class _c extends kt{constructor(t={}){var i,n,r,o,l,c,d;super();a(this,"_distanceEnabled");a(this,"_distanceDensity");a(this,"_distanceStart");a(this,"_heightEnabled");a(this,"_heightDensity");a(this,"_heightStart");a(this,"_color");a(this,"_updated");this._distanceEnabled=(i=t.distanceEnabled)!=null?i:!1,this._distanceDensity=(n=t.distanceDensity)!=null?n:.01,this._distanceStart=(r=t.distanceStart)!=null?r:0,this._heightEnabled=(o=t.heightEnabled)!=null?o:!1,this._heightDensity=(l=t.heightDensity)!=null?l:.01,this._heightStart=(c=t.heightStart)!=null?c:0,this._color=new Re().fromArray((d=t.color)!=null?d:[.5,.5,.5]),this._updated=()=>this.dispatchEvent({type:_c.updatedEventType,target:this})}get distanceEnabled(){return this._distanceEnabled}set distanceEnabled(t){this._distanceEnabled=t,this._updated()}get distanceDensity(){return this._distanceDensity}set distanceDensity(t){this._distanceDensity=t,this._updated()}get distanceStart(){return this._distanceStart}set distanceStart(t){this._distanceStart=t,this._updated()}get heightEnabled(){return this._heightEnabled}set heightEnabled(t){this._heightEnabled=t,this._updated()}get heightDensity(){return this._heightDensity}set heightDensity(t){this._heightDensity=t,this._updated()}get heightStart(){return this._heightStart}set heightStart(t){this._heightStart=t,this._updated()}get color(){return this._color}get colorArray(){return this._color.toArray()}set colorArray(t){this._color.fromArray(t),this._updated()}enabled(){return this._distanceEnabled||this.heightEnabled}serialize(){return{distanceEnabled:this._distanceEnabled,distanceDensity:this._distanceDensity,distanceStart:this._distanceStart,heightEnabled:this._heightEnabled,heightDensity:this._heightDensity,heightStart:this._heightStart,color:this._color.toArray()}}};a(_c,"updatedEventType","fogUpdated");let Cl=_c;var er=(s=>(s.PROCEDURAL="procedural",s.EQUIRECT="equirect",s))(er||{});const vc=class vc extends Je{constructor(t,i,n,r){super(i,n);a(this,"autoPosition");a(this,"name");a(this,"fog");a(this,"_updatedEvent",{type:vc.updatedEventType,target:this});r&&this.position.fromArray(r),this.autoPosition=!r,this.name=t}setTexture(t){ye(this.type==="equirect"),this.material.map=t,this.yawRotationDeg=0,this._updated()}_updated(){this.dispatchEvent(this._updatedEvent)}get type(){return this.isEquirect?"equirect":"procedural"}get yawRotationDeg(){return mn(this.rotation.y)}set yawRotationDeg(t){const i=oi(t);this.rotation.y=i,this.updateMatrixWorld(),this._updated()}get isEquirect(){return this.material instanceof tp}get radius(){return this.scale.x}set radius(t){this.scale.set(t,t,t),this.updateMatrixWorld(!0),this._updated()}serialize(){var i;const t={name:this.name,type:this.type};return this.autoPosition||(t.center=this.position.toArray()),this.isEquirect&&(t.yawRotation=this.yawRotationDeg,t.texture=this.material.map?this.material.map.serialize():null),(i=this.fog)!=null&&i.enabled()&&(t.fog=this.fog.serialize()),t}clone(){throw Error("SkyMesh can't be cloned.")}};a(vc,"updatedEventType","skyMeshUpdated");let Rl=vc;class Wh{constructor(e){a(this,"_textureManager");this._textureManager=e}loadSkyTexture(e){this._textureManager.remove(e.id);const t=this._textureManager.load(e,gn.NONE,D.LOAD_PRIORITY.SKY);return t.anisotropy=wt.NO_ANISOTROPY,t}loadSingleSky(e,t,i){let n;e.type===er.PROCEDURAL||e.type===void 0?n=this._createProceduralSkyMesh(e):e.type===er.EQUIRECT?n=this._createEquirectSkyMesh(e):(console.warn("Unknown sky type: ",e.type),n=this._createProceduralSkyMesh(e)),n.fog=i,t.addSkyMesh(n)}load(e,t){const i=new Cl(e[0].fog);t.addFog(i),this.loadSingleSky({name:D.DEFAULT_SKY_NAME,type:er.PROCEDURAL},t,i),e.forEach(n=>this.loadSingleSky(n,t,i))}_createSphereSkyMesh(e,t,i){const n=dt.createSphere(1,64,64);return new Rl(e,n,t,i)}_createProceduralSkyMesh(e){const t=new Pb;return this._createSphereSkyMesh(e.name,t,e.center)}_createEquirectSkyMesh(e){const t=new tp;t.map=e.texture instanceof wt?e.texture:this.loadSkyTexture(e.texture);const i=this._createSphereSkyMesh(e.name,t,e.center);return i.geometry.applyMatrix(new je().makeScale(1,1,-1)),i.rotation.x=Math.PI/2,i.yawRotationDeg=e.yawRotation||0,i}}const ip=function(){function s(e,t){return{formatIdx:e,gpuFormat:t}}return{ETC1:s(0,nt.RGB_ETC1),BC1:s(2,nt.RGB_DXT1),BC3:s(3,nt.RGBA_DXT5),PVRTC1_4_RGB:s(8,nt.RGB_PVRTC_4BPPV1),PVRTC1_4_RGBA:s(9,nt.RGBA_PVRTC_4BPPV1),ASTC_4x4:s(10,nt.RGBA_ASTC_4x4_KHR),RGBA8:s(13,nt.RGBA8)}}();function np(s,e,t,i,n){s({wasmBinary:e}).then(r=>{r.initializeBasis();function o(c,d,u){const h=d===u,f=Math.log2(d)%1===0&&Math.log2(u)%1===0;return i.dxtTextures?c?t.BC3:t.BC1:i.pvrtcTextures&&h&&f?c?t.PVRTC1_4_RGBA:t.PVRTC1_4_RGB:i.etc1Textures&&!c?t.ETC1:i.astcTextures?t.ASTC_4x4:t.RGBA8}function l(c){const d=new r.BasisFile(new self.Uint8Array(c));function u(){d.close(),d.delete()}const h=(N,O)=>{if(!N)throw u(),"Error in .basis file: "+O},f=d.getHasAlpha(),p=d.getNumImages(),m=d.getNumLevels(0),b=d.getImageWidth(0,0),_=d.getImageHeight(0,0);h(b!==0&&_!==0&&m!==0,"invalid dimensions"),h(p===1,"invalid number of images");const y=0,A=o(f,b,_),T=A.formatIdx;let M=d.startTranscoding();h(M,"startTranscoding failed");const C=[];for(let N=0;N<m;++N){const O=d.getImageWidth(y,N),q=d.getImageHeight(y,N),j=d.getImageTranscodedSizeInBytes(y,N,T),K=new self.Uint8Array(new self.ArrayBuffer(j));M=d.transcodeImage(K,y,N,T,0,f),h(M,"transcodeImage failed"),C.push({data:K,width:O,height:q})}return u(),{gpuFormat:A.gpuFormat,mipmaps:C}}n(l)})}function Cb(s,e,t,i){const n=new window.Worker(s);let r=null;const o={processItem:function(d){console.assert(!r),r=d,n.postMessage(d.texBuffer,[d.texBuffer])},terminate:function(){console.assert(!r),n.terminate()}},l=function(d){throw"Worker error @L"+d.lineno+": "+d.message};n.addEventListener("error",l);const c=function(){n.removeEventListener("error",l),n.removeEventListener("message",c),n.addEventListener("error",function(d){const u="Worker error @L"+d.lineno+": "+d.message;r&&(r.onError(u),r=null)}),n.addEventListener("message",function(d){console.assert(r),r.onSuccess(d.data),r=null,i(o)}),t(),i(o)};n.addEventListener("message",c),n.postMessage(e)}function Rb(s,e,t,i){const n=`
self.importScripts(`+JSON.stringify(s)+`);
const initBasis = `+np.toString()+`;
const basisFormats = `+JSON.stringify(ip)+`;
const glDetector = `+JSON.stringify({astcTextures:e.gl.astcTextures,dxtTextures:e.gl.dxtTextures,etc1Textures:e.gl.etc1Textures,pvrtcTextures:e.gl.pvrtcTextures})+`;

function initHandler(evt) {
  self.removeEventListener('message', initHandler);

  const wasmBinary = evt.data;
  initBasis(BASIS, wasmBinary, basisFormats, glDetector,
            decodeTexBuffer => {
    self.addEventListener('message', function(evt) {
        const texBuffer = evt.data;
        const texDatas = decodeTexBuffer(texBuffer);
        // second argument to transfer ownership to the main thread
        self.postMessage(texDatas, texDatas.mipmaps.map(t => t.data.buffer));
    });
    self.postMessage({}); // communicate end of init
  });
}

self.addEventListener('message', initHandler);
`,r=window.URL.createObjectURL(new window.Blob([n]));let o=!1,l=0;const c=[],d=[],u=new Qf(()=>{for(const f of c)f.terminate();l-=c.length,c.length=0},5e3);function h(){u.deferRun(),d.length!==0&&(c.length>0?(c.pop().processItem(d.pop()),h()):l<i&&!o&&(l++,o=!0,Cb(r,t,()=>{o=!1},m=>{c.push(m),h()})))}return function(p,m,b){d.push({texBuffer:p,onSuccess:m,onError:b}),h()}}function Ib(s,e){jc(gi("lib/basis/basis_transcoder.wasm"),!0,function(t){const i=gi("lib/basis/basis_transcoder.js"),n=s.basisDecodeWorkers;if(n<=0){const r=window.document.createElement("script");r.addEventListener("load",function o(){r.removeEventListener("load",o),np(window.BASIS,t,ip,s.gl,l=>{e(function(c,d,u){try{d(l(c))}catch(h){u(h)}})})}),r.src=i,window.document.head.appendChild(r)}else e(Rb(i,s,t,n))},t=>{throw t})}function Db(s){if(!(window.WebAssembly&&(s.gl.pvrtcTextures||s.gl.etc1Textures||s.gl.dxtTextures||s.gl.astcTextures)))return;const e=[];let t=(...r)=>{e.push(r)};function i(r){t=r,e.forEach(o=>t(...o)),e.length=0}let n=!1;return{load:function(r,o,l,c){const d=()=>c(r);n||(n=!0,Ib(s,i)),o(function(u){t(u,function(h){const f=h.mipmaps;r.format=h.gpuFormat,r.mipmaps=f.map(p=>new Go(p.data,p.width,p.height)),r.width=f[0].width,r.height=f[0].height,r.minFilter=f.length===1?ne.LINEAR:ne.LINEAR_MIPMAP_LINEAR,r.flipY=!1,r.generateMipmaps=!1,r.needsUpdate=!0,l(r)},d)},d)}}}let sp=!1;function Lb(s,e,t,i){function n(o){const l=o.sigBytes,c=o.words,d=new Uint8Array(l);let u=0,h=0;for(;u!==l;){let f=c[h++];if(d[u++]=(f&4278190080)>>>24,u===l||(d[u++]=(f&16711680)>>>16,u===l)||(d[u++]=(f&65280)>>>8,u===l))break;d[u++]=f&255}return d}function r(){sp=!0;const o=CryptoJS.lib.WordArray.create(s),l=o.clone();l.sigBytes=16,l.clamp(),o.words.splice(0,4),o.sigBytes-=16;const c=CryptoJS.enc.Base64.parse(e),d=CryptoJS.AES.decrypt({ciphertext:o},c,{iv:l,mode:CryptoJS.mode.CFB}),u=n(d);t(u.buffer)}sp?r():gr(gi("lib/crypto-js.min.js"),r,()=>Wt.error("Cannot load required library"))}function Fb(s){const i=[],n=(_,y)=>{if(!_)throw"Error in .ktx file: "+y},r=new Int32Array(s,0,16);n(r[3]===67305985,"endianness mismatch"),n(r[4]===0&&r[5]===1&&r[6]===0,"invalid header");let o,l;r[7]===35842?(l=6408,o=nt.RGBA_PVRTC_4BPPV1):r[7]===36196?(l=6407,o=nt.RGB_ETC1):r[7]===33776?(l=6407,o=nt.RGB_DXT1):r[7]===33779?(l=6408,o=nt.RGBA_DXT5):n(!1,"unknown internal format: "+r[7]),n(r[8]===l,"invalid base internal format: ",r[8]);const c=r[9],d=r[10];n((c&c-1)===0&&(d&d-1)===0,"non power-of-two size: "+c+" "+d),n(r[11]===0&&r[12]===0&&r[13]===1,"invalid header");const u=r[14],h=r[15];n(h%4===0,"invalid header");let f=4*16+h;const p=new DataView(s,0);let m=c,b=d;for(let _=0;_<u;++_){const y=p.getUint32(f,!0);f+=4;const A=new Uint8Array(s,f,y);i.push({data:A,width:m,height:b});const T=3-(y+3)%4;f+=y+T,m=Math.max(m/2,1),b=Math.max(b/2,1)}return n(f===s.byteLength,"invalid data size"),{format:o,width:c,height:d,mipmapCount:u,mipmaps:i}}function Ob(){this.load=function(s,e,t,i,n){const r=[];s.flipY=!1,s.generateMipmaps=!1,s.image=r;function o(l){let c;try{c=Fb(l)}catch(d){console.error(d),n(s);return}if(c.isCubemap){const d=c.mipmaps.length/c.mipmapCount;for(let u=0;u<d;u+=1){r[u]={mipmaps:[]};for(let h=0;h<c.mipmapCount;h+=1)r[u].mipmaps.push(c.mipmaps[u*c.mipmapCount+h]),r[u].format=c.format,r[u].width=c.width,r[u].height=c.height}}else s.image.width=c.width,s.image.height=c.height,s.mipmaps=c.mipmaps.map(d=>new Go(d.data,d.width,d.height));c.mipmapCount===1&&(s.minFilter=ne.LINEAR),s.format=c.format,s.width=c.width,s.height=c.height,i&&i(s)}_r(e,t,!0,o,n)}}function tr(s,e){return s.indexOf(e)>-1}function rp(s,e){return function(t,i){_r(s,e,!0,t,i)}}function op(s,e,t){return function(i,n){rp(s,e)(function(o){Lb(o,t,i)},n)}}function Bb(s,e,t,i,n,r,o){const l=()=>r(s);s.format=i;function c(d){s.image=d,s.width=d.width,s.height=d.height,n(s)}return o!==void 0?op(e,t,o)(function(u){const h=new Uint8Array(u),f=t.endsWith("png")?"image/png":t.endsWith("webp")?"image/webp":"image/jpeg",p=new Blob([h],{type:f}),b=(window.URL||window.webkitURL).createObjectURL(p),_=new Image;_.onload=function(){c(_)},_.src=b},l):mu(e,t,c,l),s}function Nb(s,e,t,i,n,r){s.format=i;function o(l){s.video=l,s.width=l.videoWidth,s.height=l.videoHeight,n(s),s.pauseWhenLoaded&&(s.pause(),s.rewind())}T_(e,t,o,()=>r(s))}class kb{constructor(e){a(this,"ios");a(this,"mobile");a(this,"pvrtc");a(this,"etc1");a(this,"dxt");this.ios=e.ios,this.mobile=e.mobile,this.pvrtc=e.gl.pvrtcTextures,this.etc1=e.gl.etc1Textures,this.dxt=e.gl.dxtTextures}}class Ub{constructor(e,t,i,n,r,o){a(this,"_assetsUrl");a(this,"_onTextureLoaded");a(this,"_onTextureLoadFailed");a(this,"_onTextureLoadFailedSoft");a(this,"_onVideoTextureLoadFailed");a(this,"_basisLoader");a(this,"_ktxLoader");a(this,"_platformInfo");this._ktxLoader=new Ob,D.NO_BASIS||(this._basisLoader=Db(t)),this._onTextureLoaded=i,this._onTextureLoadFailed=n,this._onTextureLoadFailedSoft=r,this._onVideoTextureLoadFailed=o,this._platformInfo=new kb(t),this._assetsUrl=e}getTexturePath(e){const t=e.id,i=e.webFormats;if(ye(i.length>0,"No web format for texture: "+e.id+"."+e.rawExt),e instanceof ra)return this._assetsUrl+"video/"+i[0]+"/"+t+"."+e.stdExt;const n=this._assetsUrl+"img/",r=this._platformInfo.ios&&e.encoding;if(this._basisLoader&&!r){if(!this._platformInfo.mobile&&tr(i,"large/basis"))return n+"large/basis/"+t+".basis";if(tr(i,"small/basis"))return n+"small/basis/"+t+".basis"}if(this._platformInfo.pvrtc&&!r&&tr(i,"small/pvr"))return n+"small/pvr/"+t+".ktx";if(this._platformInfo.etc1&&tr(i,"small/etc1"))return n+"small/etc1/"+t+".ktx";if(this._platformInfo.dxt&&tr(i,"large/dxt"))return n+"large/dxt/"+t+".ktx";const o=tr(i,"small/std");return tr(i,"large/std")&&(!this._platformInfo.mobile||!o)?n+"large/std/"+t+"."+e.stdExt:tr(i,"url")?e.name+"."+e.stdExt:n+"small/std/"+t+"."+e.stdExt}loadIntDataTexture(e,t,i,n,r,o){e.anisotropy=wt.NO_ANISOTROPY;const l=()=>o(e);function c(d){const u=new Uint8Array(d,0,d.byteLength),h=u[0],f=u[1];ye(e.image instanceof Go),e.image.width=Math.pow(2,h),e.image.height=Math.pow(2,f),e.format=n,e.image.data=u.subarray(2),r&&r(e)}_r(t,i,!0,c,l)}load(e,t,i=!1){tt(e.loadingStatus==Ys.NOT_LOADED||e.loadingStatus==Ys.POSTPONED),e.loadingStatus=Ys.IN_PROGRESS;const n=e.hasAlpha?nt.RGBA8:nt.RGB8,r=this.getTexturePath(e),o=/\.basis$/.test(r),l=/\.ktx$/.test(r),c=/\.buf$/.test(r),d=e instanceof ra,u=!(l||c||d),h=m=>{console.error("Error while loading texture: ",r),(i?this._onTextureLoadFailedSoft:this._onTextureLoadFailed)(m)},f=m=>{console.error("Error while loading video texture: ",r),this._onVideoTextureLoadFailed(m)},p=m=>{m.needsUpdate=!0,this._onTextureLoaded(m),m.notifyLoaded()};if(c)this.loadIntDataTexture(e,t,r,n,p,h);else if(o&&this._basisLoader){let m;e.passphrase===void 0?m=rp(t,r):m=op(t,r,e.passphrase),this._basisLoader.load(e,m,p,h)}else l?this._ktxLoader.load(e,t,r,p,h):u?Bb(e,t,r,n,p,h,e.passphrase):(ye(d),Nb(e,D.LOAD_PRIORITY.VIDEO,r,n,p,f))}}const jh=D.DEBUG;function zb(s){const e={magFilter:ne.NEAREST,minFilter:ne.NEAREST,stencilBuffer:!1,depthBuffer:!1,generateMipmaps:!1},t=[s.createRenderTarget(1024,1024,e),s.createRenderTarget(512,512,e)],i={uniforms:{map:{type:"t",value:null},mapUvStep:{type:"v2",value:null},mapUvOffsetScale:{type:"v4",value:null}},vertexShaderName:"alpha_stats_vertex.glsl",fragmentShaderName:"alpha_stats_fragment.glsl"},n=new Cn(i,"map");n.material.depthTest=!1,n.material.depthWrite=!1;const r=new Ue,o=new Lt;n.uniforms.mapUvStep.value=r,n.uniforms.mapUvOffsetScale.value=o;const l={uniforms:{map:{type:"t",value:null},mapUvStep:{type:"v2",value:null},mapUvScale:{type:"v2",value:null}},vertexShaderName:"alpha_stats_vertex.glsl",fragmentShaderName:"alpha_stats_combine_fragment.glsl"},c=new Cn(l,"map");c.material.depthTest=!1,c.material.depthWrite=!1;const d=new Ue;c.uniforms.mapUvScale.value=d,c.uniforms.mapUvStep.value=r;const u=new Uint8Array(4*1024);let h=null;jh&&(h=new Pr),this.detect=function(f){const p=f.parentTexture!==void 0;let m,b,_,y,A;if(p?(m=f.parentTexture,b=f.uvOffsetScale.x,_=f.uvOffsetScale.y,y=f.uvOffsetScale.z,A=f.uvOffsetScale.w):(m=f,b=_=0,y=A=1),!m.hasAlpha||m.video){f.isCutout=!1;return}jh&&h.reset(),s.enableScissorTest(!0);const T=m.width*y,M=m.height*A;r.set(1/T,1/M),o.set(b,_,y,A);let C=Math.max(Math.floor(T/2),1),N=Math.max(Math.floor(M/2),1);s.setRenderTarget(t[0]),s.setViewport(0,0,C,N),s.setScissor(0,0,C,N),n.render(s,t[0],m);let O=1,q=t[0];for(;C!==1&&N!==1;){r.set(1/q.width,1/q.height),d.set(C/q.width,N/q.height),C=Math.floor(C/2),N=Math.floor(N/2);const xe=t[O];s.setRenderTarget(xe),s.setViewport(0,0,C,N),s.setScissor(0,0,C,N),c.render(s,xe,q),q=xe,O=(O+1)%2}s.readPixels(C,N,u);let j=0,K=0;const de=Math.max(C,N);for(let xe=0;xe<de;++xe)j+=u[4*xe],K+=u[4*xe+1];if(j=100*j/(255*de),K=100*K/(255*de),f.isCutout=j<20||K>50,jh){let xe="";p&&(xe+="From atlas: "+m.name+" ["+b+", "+_+", "+y+", "+A+`]
`),console.log(f.name+" "+m.width+"x"+m.height+`
 `+xe+"Is cutout: "+f.isCutout+`
 Partialy transparent regions: `+j+`%
 Fully transparent pixels: `+K+`%
 Time: `+h.elapsedSec())}s.enableScissorTest(!1)},this.dispose=function(){t[0].dispose(),t[1].dispose(),n.dispose(),c.dispose()}}const Xh=512*1024;class Vb{constructor(e,t){a(this,"onTextureLoaded");a(this,"_renderer");a(this,"_textureLoader");a(this,"_cutoutDetector");a(this,"_loadingProgress",new Vh);a(this,"_textures",new Array);a(this,"_idToTexture",new Map);a(this,"_atlases",new Map);a(this,"_onLoadSuccess",e=>{this._addToProgress(e),D.DEV_NEW_RENDER_ARCHITECTURE?Yi.get().uploadTexture(e):this._renderer.uploadTexture(e),e.isAtlas()?e.forEachAtlasEntry(t=>{console.assert(t.isCutout===void 0),this._detectCutout(t)}):e.isCutout===void 0&&this._detectCutout(e)});a(this,"_onLoadFailed",e=>{this._addToProgress(e),Wt.sceneLoadError()});a(this,"_onLoadFailedSoft",e=>{this._addToProgress(e),Wt.info("Failed to load texture")});a(this,"_onVideoLoadFailed",e=>{this._addToProgress(e),console.warn("Failed to load video texture")});this._renderer=t,this._textureLoader=new Ub(e,it,this._onLoadSuccess,this._onLoadFailed,this._onLoadFailedSoft,this._onVideoLoadFailed)}_addToProgress(e){var t;this._loadingProgress.loadedBytes+=Xh,this._loadingProgress.loadedResources++,(t=this.onTextureLoaded)==null||t.call(this,e)}_detectCutout(e){this._cutoutDetector||(this._cutoutDetector=new zb(this._renderer)),e.isCutout===void 0&&this._cutoutDetector.detect(e)}remove(e){const t=this._idToTexture.get(e);if(t===void 0)return!1;delete this._textures[t],this._idToTexture.delete(e)}findTexture(e){const t=this._idToTexture.get(e);if(t===void 0)return;const i=this._textures[t],n=i==null?void 0:i.deref();if(!(n!=null&&n.isDisposed()))return n;delete this._textures[t],this._idToTexture.delete(e)}load(e,t=gn.DEFAULT,i=0,n=!1,r=!1){e instanceof Qs||(e=Qs.parse(e)),ye(e.id);let o=this.findTexture(e.id);if(o===void 0){o=e.video?new ra:new wt,o.initFromJson(e,t);const l=this._textures.length;this._textures.push(new WeakRef(o)),this._idToTexture.set(e.id,l),r?o.loadingStatus=Ys.POSTPONED:(this._textureLoader.load(o,i,n),this._loadingProgress.totalBytes+=Xh,this._loadingProgress.totalResources++)}else!r&&o.loadingStatus===Ys.POSTPONED&&(this._textureLoader.load(o,i,n),this._loadingProgress.totalBytes+=Xh,this._loadingProgress.totalResources++);return o}loadPostponed(e,t=0,i=!1){for(const n of e){const r=this.findTexture(n);r!==void 0&&r.loadingStatus===Ys.POSTPONED&&this._textureLoader.load(r,t,i)}}loadColorMap(e){const t=this.load(e,gn.NONE,D.LOAD_PRIORITY.COLORMAP);return t.anisotropy=wt.NO_ANISOTROPY,t.flipY=!1,t}atlases(){return this._atlases}loadAtlases(e){if(e.length!==0)for(const t of e){const i=Qs.parse(t),n=this.load(i,gn.DEFAULT,D.LOAD_PRIORITY.DIFFUSE);n.flipY=!1,n.enableAtlas(),ye(typeof i.id=="string"),this._atlases.set(i.id,n)}}loadingProgress(){return this._loadingProgress}freeLoadingBuffers(){this._cutoutDetector=void 0}}const bc=class bc{static createSingleColorLightmap(e,t,i=0){const n=bc._tempVector4;t===to.RGBM?Qr.rgbmEncode(e,n):t===to.YCOCGM?Qr.ycocgmEncode(e,n,i):vs();const r=new Uint8Array(4);r[0]=Math.round(n.x*255),r[1]=Math.round(n.y*255),r[2]=Math.round(n.z*255),r[3]=Math.round(n.w*255);const o=wt.newDataTexture(r,1,1);return o.magFilter=ne.NEAREST,o.minFilter=ne.NEAREST,o.anisotropy=wt.NO_ANISOTROPY,o.hasAlpha=!0,o.encoding=t,o.ycocgmThreshold=i,o.needsUpdate=!0,o}};a(bc,"_tempVector4",new Lt);let Il=bc;class ra extends wt{constructor(){super();a(this,"_isPlaying",!0);a(this,"_isSleeping",!1);a(this,"_pauseRequested",!1);a(this,"_videoSrc");a(this,"_pausedTime",0);a(this,"_interruptible",!0);a(this,"_resizedListeners",new Array);a(this,"pauseWhenLoaded",!1);a(this,"_handlePaused",()=>{this._pauseRequested?this._pauseRequested=!1:this._isSleeping=!0,!this._isPlaying&&this._interruptible&&(ye(this.video instanceof HTMLVideoElement),this.video.src="")});a(this,"_handleEnded",()=>{this._isPlaying=!1,this._isSleeping=!1});a(this,"_notifyResized",()=>{ye(this.video instanceof HTMLVideoElement),this.width=this.video.videoWidth,this.height=this.video.videoHeight;for(let t=0;t<this._resizedListeners.length;t+=1)this._resizedListeners[t]()});this.generateMipmaps=!1,this.isAnimated=!0,this.releaseOnLoadedToGpu=!1}initFromJson(t,i){super.initFromJson(t,i),this.pauseWhenLoaded=fr(i,gn.PAUSE_LOADED_VIDEO)}_srcAtPausedPosition(){return this._videoSrc+"#t="+this._pausedTime}_pauseVideo(){ye(this.video instanceof HTMLVideoElement),this._pausedTime=this.video.currentTime,this.video.pause()}rewind(){ye(this.video instanceof HTMLVideoElement),this._pausedTime=0,this.video.currentTime=0}get video(){return ye(this.image instanceof HTMLVideoElement||this.image==null),this.image}set video(t){ye(this.image===void 0,"Video already attached to texture."),ye(t instanceof HTMLVideoElement),this.image=t,this._videoSrc=t.src,this._isPlaying=!t.paused&&!t.ended,t.addEventListener("pause",this._handlePaused),t.addEventListener("ended",this._handleEnded),t.addEventListener("resize",this._notifyResized),this._isSleeping&&this._isPlaying&&this._pauseVideo()}get muted(){return ye(this.video instanceof HTMLVideoElement),this.video.muted}set muted(t){ye(this.video instanceof HTMLVideoElement),this.video.muted=t}get loop(){return ye(this.video instanceof HTMLVideoElement),this.video.loop}set loop(t){ye(this.video instanceof HTMLVideoElement),this.video.loop=t}get isPlaying(){return!this._isSleeping&&this._isPlaying}play(){if(this._isPlaying)return;if(this._isSleeping){this._isPlaying=!0;return}ye(this.video instanceof HTMLVideoElement);const t=this.video;this._interruptible&&(t.src=this._srcAtPausedPosition());const i=t.play();i?(this._isPlaying=!0,i.catch(n=>{console.log("Can't play video texture: "+n),this._isPlaying=!1})):this._isPlaying=!t.paused&&!t.ended}pause(){!this._isPlaying||!this.video||(this._isPlaying=!1,this._isSleeping||(this._pauseRequested=!0,this._pauseVideo()))}sleepAnimation(){this._isSleeping||(this._isPlaying&&this.video&&this._pauseVideo(),this._isSleeping=!0)}wakeAnimation(){this._isSleeping&&(this._isPlaying&&this.video&&(this._interruptible&&(this.video.src=this._srcAtPausedPosition()),this.video.play()),this._isSleeping=!1)}dispose(){wt.prototype.dispose.call(this),this._isPlaying&&this.pause(),ye(this.video instanceof HTMLVideoElement);const t=this.video;this.image=void 0,this._videoSrc="",this._isPlaying=!1,t.src="",t.removeEventListener("pause",this._handlePaused),t.removeEventListener("ended",this._handleEnded),t.removeEventListener("resize",this._notifyResized),this._resizedListeners.length=0}addResizedListener(t){this._resizedListeners.push(t)}serialize(){const t=wt.prototype.serialize.call(this);return t.video=!0,t}get needsUpdate(){return this._needsUpdate||!!(this.isPlaying&&this.video&&this.video.seeking!==!0&&this.video.readyState>=this.video.HAVE_CURRENT_DATA)}set needsUpdate(t){this._needsUpdate=t}}var Dl=(s=>(s[s.LIVE=1]="LIVE",s[s.BAKED=0]="BAKED",s[s.BASIC=-1]="BASIC",s))(Dl||{});const Oa=class Oa extends kt{constructor(){super();a(this,"_texture");a(this,"_mode",-1)}get mode(){return this._mode}set mode(t){this._mode!==t&&(this._mode=t,this.dispatchEvent({type:Oa.updatedEventType}))}get texture(){return this._texture}set(t){if(t===void 0){this._texture=void 0,this.mode=0;return}const i=new Float32Array(t,0,t.byteLength/4),n=i[1],r=i[2],o=i.subarray(3);n*r,o.length/3;const l=wt.newDataTexture(o,n,r,nt.RGB32F);l.minFilter=ne.NEAREST,l.magFilter=ne.NEAREST,l.generateMipmaps=!1,l.flipY=!1,l.needsUpdate=!0,this._texture=l,this.mode=1,this.dispatchEvent({type:Oa.updatedEventType})}};a(Oa,"updatedEventType","liveLightmapUpdated");let Ll=Oa;const Gb="pbr_material_vertex.glsl",Hb="pbr_material_fragment.glsl";class Wb extends so{}class jb extends si{constructor(){super({vsName:Gb,fsName:Hb,uniformBufferDataConstructor:Wb})}}const Xb=.1;class qb extends so{constructor(){super(...arguments);a(this,"wavesSpeed",0);a(this,"wavesScale",0);a(this,"refractionFactor",0)}}class Yb extends si{constructor(){super({fsHooks:nn.get("water.glsl"),uniformBufferDataConstructor:qb});a(this,"_isPlaying",!0);a(this,"_isSleeping",!1);a(this,"_wavesSpeed",1);a(this,"_wavesScale",1);a(this,"_refractionFactor",0);a(this,"_correctedNormalTexture",new no);D.DEV_DISABLE_UNIFORM_BUFFERS&&this.setUniform("time","f",0,ve.GLOBAL),this.setUniform("wavesSpeed","f",0,ve.MATERIAL),this._roughness=0,this.baseColor=new Re(0),this.opacity=.2,this.doNotImport={baseColor:!0,baseColorTexture:!0,opacity:!0}}_getCorrectedTexture(t){return t===Pn.NORMAL?this._correctedNormalTexture:super._getCorrectedTexture(t)}get hideFromLightProbes(){return this.opacity!==1&&this.refractionFactor!==0}set hideFromLightProbes(t){super.hideFromLightProbes=t}get isAnimated(){return!0}get isPlaying(){return!this._isSleeping&&this._isPlaying&&this.wavesSpeed>0}get refractionFactor(){return this._refractionFactor}set refractionFactor(t){this._doSetProperty(this,"_refractionFactor",t)}get wavesSpeed(){return this._wavesSpeed}set wavesSpeed(t){this._doSetProperty(this,"_wavesSpeed",t)}get wavesScale(){return this._wavesScale}set wavesScale(t){this._doSetProperty(this,"_wavesScale",t)}get normalTexture(){return this._correctedNormalTexture.texture}set normalTexture(t){this._correctedNormalTexture.texture=t,this._onTextureSet(t)}textureNeedsUv0(t){return!1}get type(){return"water"}hash(){return"water"}canMerge(t){if(this.type!==t.type)return!1;const i=t;return this.opacity===i.opacity&&this.baseColor.equals(i.baseColor)&&this.normalTexture===i.normalTexture&&this.wavesSpeed===i.wavesSpeed&&this.wavesScale===i.wavesScale&&this.refractionFactor===i.refractionFactor}_setTexture(t,i){if(t===Pn.NORMAL)this.normalTexture=i;else return super._setTexture(t,i)}setUniforms(){super.setUniforms();const t=this.normalTexture;this.condDefine(t!==void 0&&t.loaded&&!this.isLightProbeDisabled(),"USE_NORMAL_TEXTURE")&&(this.setUniform("normalTexture","t",t,ve.MATERIAL),this.setUniform("wavesScale","f",this.wavesScale,ve.MATERIAL),this.opacity!==1?this.setUniform("refractionFactor","f",this.refractionFactor,ve.MATERIAL):this.setUniform("refractionFactor","f",0,ve.MATERIAL)),this.setUniform("wavesSpeed","f",this.wavesSpeed*Xb,ve.MATERIAL),this.fillMaterialUniformDataFromUniforms()}play(){this._isPlaying=!0}pause(){this._isPlaying=!1}sleepAnimation(){this._isSleeping=!0}wakeAnimation(){this._isSleeping=!1}update(t){D.DEV_DISABLE_UNIFORM_BUFFERS&&(this.uniforms.time.value+=t)}serialize(){var t,i;return{name:this.name,type:this.type,baseColor:this.baseColor.roundChannels().toArray(),baseColorTexture:null,opacity:this.opacity,normalTexture:(i=(t=this.normalTexture)==null?void 0:t.serialize())!=null?i:null,wavesSpeed:this.wavesSpeed,wavesScale:this.wavesScale,refractionFactor:this.refractionFactor,doNotImport:this.doNotImport}}}const ap="nodeConfigUpdate";function _o(s){return s!=null}class Qb extends kt{constructor(e){super(),this.name=e.name,this._editable=e.editable||!1,this._setsDisableCollisions=_o(e.disableCollisions),this._disableCollisions=e.disableCollisions||!1,this._setsHideInViews=_o(e.hideInViews),this.hideInViews=null,e.hideInViews&&(this.hideInViews=e.hideInViews,this.hideInViews.sort()),this._setsLightmapResolution=_o(e.lightmapResolution),this._lightmapResolution=this._setsLightmapResolution?e.lightmapResolution:null,this._ground=_o(e.ground)?e.ground:!1,this._faceCamera=e.faceCamera||null,this._rotate=e.rotate||!1,this._rotationSpeed=e.rotationSpeed||.1,this._isolateShadows=_o(e.isolateShadows)?e.isolateShadows:!1,this._setsSimplificationParams=_o(e.simplificationParams),this._simplificationParams=this._setsSimplificationParams?e.simplificationParams:null,this.nodes=[];const t={type:ap,target:this};this._updated=()=>this.dispatchEvent(t)}_configUpdated(){this.nodes.forEach(e=>e.visitSubtree(t=>t.configure())),this._updated()}addNode(e){this.nodes.push(e)}isOnHideInViews(e){return this.hideInViews.indexOf(e)!==-1}addToHideInViews(...e){console.assert(this.setsHideInViews);for(const t of e)console.assert(!this.isOnHideInViews(t)),this.hideInViews.push(t);this._updated()}removeFromHideInViews(e){if(!this.hideInViews)return;let t=0;for(;t<this.hideInViews.length;)this.hideInViews[t]===e?this.hideInViews.splice(t,1):t+=1;this._updated()}serialize(){const e=this.setsSimplificationParams?this.simplificationParams:null;return{name:this.name,disableCollisions:this.setsDisableCollisions?this.disableCollisions:null,hideInViews:this.setsHideInViews?this.hideInViews:null,lightmapResolution:this.setsLightmapResolution?this.lightmapResolution:null,ground:this.ground?!0:null,faceCamera:this.faceCamera,rotate:this.rotate?!0:null,rotationSpeed:this.rotate?this.rotationSpeed:null,isolateShadows:this.isolateShadows?!0:null,simplificationParams:e}}get setsDisableCollisions(){return this._setsDisableCollisions}set setsDisableCollisions(e){this._setsDisableCollisions=e,this._configUpdated()}get disableCollisions(){return this._disableCollisions}set disableCollisions(e){console.assert(this._setsDisableCollisions),this._disableCollisions=e,this._configUpdated()}get editable(){return this._editable||this.faceCamera||this.rotate}set editable(e){this._editable=e,this._configUpdated()}get ground(){return this._ground}set ground(e){this._ground=e,this._configUpdated()}get faceCamera(){return this._faceCamera}set faceCamera(e){this._faceCamera=e,this._configUpdated()}get rotate(){return this._rotate}set rotate(e){this._rotate=e,this._configUpdated()}get rotationSpeed(){return this._rotationSpeed}set rotationSpeed(e){e===0&&(e=.01),this._rotationSpeed=e,this._configUpdated()}get setsLightmapResolution(){return this._setsLightmapResolution}set setsLightmapResolution(e){this._setsLightmapResolution=e,this._configUpdated()}get lightmapResolution(){return this._lightmapResolution}set lightmapResolution(e){console.assert(this._setsLightmapResolution),this._lightmapResolution=e,this._configUpdated()}get isolateShadows(){return this._isolateShadows}set isolateShadows(e){this._isolateShadows=e,this._configUpdated()}get setsSimplificationParams(){return this._setsSimplificationParams}set setsSimplificationParams(e){this._setsSimplificationParams=e,this._configUpdated()}get simplificationParams(){return this._simplificationParams}set simplificationParams(e){console.assert(this._setsSimplificationParams),this._simplificationParams=e,this._configUpdated()}get setsHideInViews(){return this._setsHideInViews}set setsHideInViews(e){this._setsHideInViews=e,this.hideInViews===null&&(this.hideInViews=[]),this._configUpdated()}}function Kb(s){const e=new je,t=new je;let i;const n=new B,r=new mi;function o(){i=new B;const l=new Dt;s.visitSubtree(c=>{const d=c.mesh;d&&l.union(d.geometry.boundingBox)}),l.center(i),t.elements[12]=-i.x,t.elements[13]=-i.y,t.elements[14]=-i.z}return(l,c)=>(i||o(),s.config.faceCamera?(n.copyFrom(c).sub(i).normalize(),r.setFromDirection(n),s.config.faceCamera==="yaw"&&(r.pitch=0),r.toRotationMatrix(e),s.animationMatrix.identity().setPosition(i).multiply(e).multiply(t),!1):(console.assert(s.config.rotate),r.yaw=Vt(r.yaw+2*Math.PI*s.config.rotationSpeed*l),r.toRotationMatrix(e),s.animationMatrix.identity().setPosition(i).multiply(e).multiply(t),!0))}let lp=class{constructor(e,t,i){this.id=i.id,i.lightProbeIds===void 0?this.initialLightProbeIds=[]:this.initialLightProbeIds=i.lightProbeIds,this.parent=e,this.config=t,this.children=[],this.mesh=null,this._facesCnt=null,this._originalFacesSubtreeCnt=null,this._originalFaceCnt=i.originalFaceCnt||0,this.disableCollisions=null,this.ground=null,this.animationMatrix=null,this.hideInViews=null,this.lightmapResolution=null,this.shadowsIsolatedWithin=null,this.editable=!1,this.editableRoot=null,t.addNode(this),this.configure()}configure(){this.config.setsDisableCollisions?this.disableCollisions=this.config.disableCollisions:this.parent?this.disableCollisions=this.parent.disableCollisions:this.disableCollisions=!1,this.disableCollisions?this.ground=!1:this.ground=this.config.ground,this.isAnimatedRoot?(this.animationMatrix=new je,this.update=Kb(this)):this.parent?this.animationMatrix=this.parent.animationMatrix:this.animationMatrix=null,this.config.setsHideInViews?this.hideInViews=this.config.hideInViews:this.parent?this.hideInViews=this.parent.hideInViews:this.hideInViews=null,this.config.setsLightmapResolution?this.lightmapResolution=this.config.lightmapResolution:this.parent?this.lightmapResolution=this.parent.lightmapResolution:this.lightmapResolution=null,this.config.setsSimplificationParams?this.simplificationParams=this.config.simplificationParams:this.parent?this.simplificationParams=this.parent.simplificationParams:this.simplificationParams=null,this.config.isolateShadows?this.shadowsIsolatedWithin=this.config.name:this.parent&&this.parent.shadowsIsolatedWithin?this.shadowsIsolatedWithin=this.parent.shadowsIsolatedWithin:this.shadowsIsolatedWithin=null,this.editable=this.config.editable,this.editable?this.editableRoot=this:this.parent?this.editableRoot=this.parent.editableRoot:this.editableRoot=null}visitSubtree(e){var t;e(this),(t=this.children)==null||t.forEach(i=>i.visitSubtree(e))}facesInSubtree(){return this._facesCnt===null&&(this._facesCnt=0,this.visitSubtree(e=>{e.mesh&&(this._facesCnt+=e.mesh.geometry.vertexCnt/3)})),this._facesCnt}originalFacesInSubtree(){return this._originalFacesSubtreeCnt===null&&(this._originalFacesSubtreeCnt=0,this.visitSubtree(e=>{e.mesh&&(this._originalFacesSubtreeCnt+=e._originalFaceCnt)})),this._originalFacesSubtreeCnt}hide(){this.visitSubtree(e=>{e.mesh&&(e.mesh.visible=!1)})}show(){this.visitSubtree(e=>{e.mesh&&(e.mesh.visible=!0)})}get isAnimatedRoot(){return this.config.faceCamera||this.config.rotate}serialize(){const e={id:this.id,children:this.children.map(i=>i.serialize())},t=this.mesh;if(t){e.lightProbeIds=[];for(let i of t.lightProbes)e.lightProbeIds.push(i.id);e.mesh=!0}return e}get type(){return this.config.name}set highlightMix(e){this.visitSubtree(t=>{t.mesh&&(t.mesh.highlightMix=e)})}set selected(e){this.visitSubtree(t=>{t.mesh&&(t.mesh.selected=e)})}set selectedSecondary(e){this.visitSubtree(t=>{t.mesh&&(t.mesh.selectedSecondary=e)})}};class Zb{constructor(e,t,i,n){a(this,"numVertices");a(this,"numIndices");a(this,"vertexOffset");a(this,"indexOffset");this.numVertices=e,this.numIndices=t,this.vertexOffset=i,this.indexOffset=n}}class $b{constructor(e,t,i,n){a(this,"boundingBox");a(this,"geometryRange");a(this,"segmentIdx");a(this,"geometryIdx");this.boundingBox=new Dt,this.geometryRange=t,this.segmentIdx=i,this.geometryIdx=n}}class qh{constructor(e,t,i,n,r,o,l){a(this,"meshIdx");a(this,"nodeIdx");a(this,"materialIdx");a(this,"lightmapIdx");a(this,"transform");a(this,"uv1Transform");a(this,"boundingBox");this.meshIdx=e,this.nodeIdx=t,this.materialIdx=i,this.transform=r,this.uv1Transform=o,this.boundingBox=l,this.lightmapIdx=n}}a(qh,"invalidLightmapIdx",255);class Fl{constructor(e,t,i){a(this,"geometries");a(this,"meshes");a(this,"meshInstances");this.geometries=e,this.meshes=t,this.meshInstances=i}static parse(e,t){const i=Date.now(),n=new Array,r=new Map,o=new Map;for(const c of e.meshesChunks){const d=c.parse(t),u=new rh;u.vertexCnt=c.numVertices(),u.indexCnt=c.numFaces()*3,u.vertices=d.vertices,u.normals=d.normals,u.index=d.faces,u.indexUint=!0,u.uvs0=d.uvs0,u.uvs1=d.uvs1,u.addCoreAttributes(),u.uvs0!==null&&u.addUv0Attribute(),u.uvs1!==null&&u.addUv1Attribute();const h=n.length;n.push(u);let f=0,p=0;for(let m=0;m<c.numMeshes();m++){const b=new Dt,_=c.meshNumVertices[m],y=c.meshNumFaces[m]*3,A=new Zb(_,y,f,p);f+=_,p+=y,r.set(c.meshIndices[m],new $b(b,A,e.segmentIdx,h))}}for(const c of e.meshInstancesChunks)for(let d=0;d<c.numMeshInstances();d++)o.set(d,Fl._parseInstance(c,d));const l=Date.now()-i;return console.log(`Parsing SegmentChunk(${e.segmentIdx}): time: ${l} ms`),new Fl(n,r,o)}static _parseInstance(e,t){const i=new Dt,n=new Float32Array(16);for(let o=0;o<12;o++)n[o]=e.transforms[t*12+o];n[12]=n[13]=n[14]=0,n[15]=1;const r=new Float32Array(4);for(let o=0;o<4;o++)r[o]=e.uv1Transforms[t*4+(o+2)%4];return new qh(e.meshIndices[t],e.nodeIndices[t],e.materialIndices[t],e.lightmapIndices[t],n,r,i)}}function Jb(s,e,t){const i=[65433,2293759,13395711,16737945,16763904,13395609,13421568],n=Dh();n.baseColor=new Re(i[t%i.length]).convertGammaToLinear(),n.setUniforms();const r=new Je(dt.createBox(1,1,1),n);return r.position.addVectors(e.min,e.max).multiplyScalar(.5),r.scale.subVectors(e.max,e.min).multiplyScalar(1),r.updateMatrixWorld(),s.addAuxiliaryObject(r),r}class ey{constructor(e,t,i){a(this,"meshes",[]);a(this,"bboxMesh");for(const n of e.meshInstances.values()){const r=e.meshes.get(n.meshIdx),o=r.geometryRange,l=e.geometries[r.geometryIdx],c=new co(o.numIndices,o.numVertices,l),d=n.uv1Transform.slice(),u=65535;d[2]*=1/u,d[3]*=1/u,c.defaultAttributeValues=new qc,c.defaultAttributeValues.uv1Mod=d,c.boundingBox=n.boundingBox,c.boundingSphere=c.boundingBox.getBoundingSphere(),c.vertexAttribOffset=o.vertexOffset,c.indexOffset=o.indexOffset;const h=t.getMaterials()[n.materialIdx],f=new As(t.findNode(n.nodeIdx),c,h);if(f.matrixWorld=new je,f.matrixWorld.elements=n.transform,f.matrixWorld=f.matrixWorld.transpose(),i.length>0){const p=n.lightmapIdx==qh.invalidLightmapIdx?0:n.lightmapIdx;ye(p>=0&&p<i.length),f.lightmap=i[p]}this.meshes.push(f),t.addGpuMesh(f)}}}const cp=2*1024*1024;class ty{constructor(e,t,i,n){a(this,"numSegments");a(this,"_segmentBoundingBoxes",[]);a(this,"_segmentPackages",[]);a(this,"_loadingSegments",[]);a(this,"_segments",[]);a(this,"_segmentRenderables",[]);a(this,"_meshoptDecoder");a(this,"_loader");a(this,"_loadingProgress",new Vh);a(this,"_textureManager");a(this,"_textureNames");a(this,"_texturesMap");a(this,"_segmentVisBoxes",new Array);a(this,"_onSegmentLoaded",(e,t)=>{const i=this._loadingSegments.indexOf(e);ye(i!=-1),this._loadingSegments.splice(i,1),this._segmentPackages[e]=t;const n=Fl.parse(t,this._meshoptDecoder);this._segments[e]=n,this._loadingProgress.loadedBytes+=cp,this._loadingProgress.loadedResources++});var o,l;this._loader=t,this._meshoptDecoder=i,this._textureManager=e,ye(n.segmentsChunk);const r=n.segmentsChunk;this.numSegments=r.numSegments;for(let c=0;c<this.numSegments;c++){const d=new B(r.boundingBoxes[c*6+0],r.boundingBoxes[c*6+1],r.boundingBoxes[c*6+2]),u=new B(r.boundingBoxes[c*6+3],r.boundingBoxes[c*6+4],r.boundingBoxes[c*6+5]);this._segmentBoundingBoxes.push(new Dt(d,u)),this._segmentPackages.push(void 0),this._segments.push(void 0)}this._textureNames=(o=n.texturesChunk)==null?void 0:o.parse(),this._texturesMap=(l=n.segmentsChunk)==null?void 0:l.parseTexturesMap()}visibleSegments(e){const t=[];for(let i=0;i<this.numSegments;i++)e.intersectsBox(this._segmentBoundingBoxes[i])&&t.push(i);return t}isLoaded(e){return console.assert(e>=0&&e<this.numSegments),this._segmentPackages[e]!==void 0}areTexturesLoaded(e){if(!this._texturesMap||!this._textureNames)return!1;const t=i=>{const n=this._textureManager.findTexture(this._textureNames[i]);return n&&n.loaded};return this._texturesMap[e].every(t)}loadSegment(e){if(!(this.isLoaded(e)||this._loadingSegments.includes(e))&&(this._loadingSegments.push(e),this._loader.load(e,this._onSegmentLoaded),this._loadingProgress.totalBytes+=cp,this._loadingProgress.totalResources++,this._texturesMap&&this._textureNames)){const t=this._texturesMap[e].map(i=>this._textureNames[i]);this._textureManager.loadPostponed(t)}}loadVisibleSegments(e){for(const t of this.visibleSegments(e))this.loadSegment(t)}loadAllSegments(){for(let e=0;e<this.numSegments;e++)this.loadSegment(e)}updateRenderables(e,t){for(let i=0;i<this.numSegments;i++){if(this._segments[i]!==void 0&&this._segmentRenderables[i]===void 0){if(!this.areTexturesLoaded(i))continue;const o=new ey(this._segments[i],e,t);this._segmentRenderables[i]=o}const n=!this.isLoaded(i),r=this._segmentVisBoxes[i]!==void 0;n&&!r&&(this._segmentVisBoxes[i]=Jb(e,this._segmentBoundingBoxes[i],i)),!n&&r&&(e.removeAuxiliaryObject(this._segmentVisBoxes[i]),this._segmentVisBoxes[i]=void 0)}}updateHelpers(){}loadingProgress(){return this._loadingProgress}}class iy extends kt{constructor(t,i){super();a(this,"weakReflectionShadow");a(this,"_liveLightmap");a(this,"_fog");a(this,"_camera");a(this,"_hdrOutput",!1);a(this,"_brdfLUT");a(this,"_lightmapEncoding");a(this,"_defaultLightmaps",new Array);a(this,"_updated",()=>this.dispatchEvent({type:"sharedMaterialStateUpdate",target:this}));this.weakReflectionShadow=D.WEAK_REFLECTION_SHADOW,this._camera=t,this._liveLightmap=i,this._liveLightmap.addEventListener(Ll.updatedEventType,this._updated),t.addEventListener("toneMappingUpdated",this._updated),t.addEventListener("colorMapUpdated",this._updated),t.addEventListener("exposureUpdated",this._updated),t.addEventListener("gammaUpdated",this._updated)}get physicalWidth(){return this._camera.physicalWidth}get physicalHeight(){return this._camera.physicalHeight}get liveLightmap(){return this._liveLightmap}get fog(){return this._fog}set fog(t){this._fog=t,this._fog.addEventListener(Cl.updatedEventType,this._updated),this._updated()}get hdrOutput(){return this._hdrOutput}set hdrOutput(t){this._hdrOutput!==t&&(this._hdrOutput=t,this._updated())}get toneMapping(){return this._camera.toneMapping}get colorMap(){return this._camera.colorMapReady()?this._camera.colorMap:null}get colorMapIntensity(){return this._camera.colorMapIntensity}get cameraExposure(){return this._camera.exposure}get cameraGamma(){return this._camera.gamma}set brdfLUT(t){this._brdfLUT=t,this._updated()}get brdfLUT(){return this._brdfLUT}set lightmapEncoding(t){this._lightmapEncoding=t,this._updated()}get lightmapEncoding(){return this._lightmapEncoding}get lightmapEnabled(){return!!this._lightmapEncoding}getDefaultLightmap(t){let i=this._defaultLightmaps.find(n=>n.ycocgmThreshold===t);return i||(this._lightmapEncoding,i=Il.createSingleColorLightmap(new Re(.8,.8,.8),this._lightmapEncoding,t),this._defaultLightmaps.push(i)),i}clearDefaultLightmaps(){this._defaultLightmaps.length=0}}let ny=0;function Ol(s,e,t){return!s.some(i=>Object.prototype.hasOwnProperty.call(i,t)&&i[t]===e)}function vo(s,e,t){return s.find(i=>i[t]===e)}function sy(s,e){const t=s.name.toUpperCase(),i=e.name.toUpperCase();return t<i?-1:t>i?1:0}const Yt=class Yt extends kt{constructor(t){super();a(this,"id");a(this,"camera");a(this,"threeScene",new uo);a(this,"autoAddLightProbes",!0);a(this,"autoTour",{disabled:!1,startOnLoad:!1});a(this,"disableProgressiveLoader",!1);a(this,"interactionPrompt",!1);a(this,"materials",new Array);a(this,"_mainAnimatedMaterials",new Set);a(this,"_disabledMaterials",new Array);a(this,"_sortedMaterials",null);a(this,"nodeConfigs",new Array);a(this,"_nodeConfigsLookup",{});a(this,"nodes",new Array);a(this,"_animatedRootNodes",new Array);a(this,"_nodeLookup",{});a(this,"gpuMeshes",new Array);a(this,"segmentManager");a(this,"segmentLightmaps",new Array);a(this,"textureManager");a(this,"exposureController");a(this,"renderCaches",new Map);a(this,"_animatableAuxiliaryObjects",new Set);a(this,"boundingBox",new Dt);a(this,"collisionBoundingBox",new Dt);a(this,"_sumLogicalMeshCenter",new B);a(this,"_logicalNonemptyMeshCount",0);a(this,"_center",new B);a(this,"skyMeshes",new Array);a(this,"views",new Array);a(this,"internalViews",new Array);a(this,"lights",new Array);a(this,"lightProbes",new Array);a(this,"cameraVolumes",new Array);a(this,"lightmapLayoutVersion",0);a(this,"liveLightmap");a(this,"minimapConfig",null);a(this,"sharedMaterialState");a(this,"_updatedEvent",{type:Yt.updatedEventType});a(this,"_anyViewUpdatedEvent",{type:Yt.anyViewUpdatedEventType});a(this,"_updated",()=>{this.dispatchEvent(this._updatedEvent)});a(this,"_anyViewUpdated",()=>{this.dispatchEvent(this._anyViewUpdatedEvent),this._updated()});a(this,"_liveLightmapUpdateNeeded",()=>{this.dispatchEvent({type:Yt.liveLightmapNeedsUpdateEventType})});a(this,"_animatedMaterialToCallId",new Map);a(this,"_animatedPrevCallId",!1);a(this,"_logicalMeshCenter",new B);a(this,"_materialUpdated",t=>{const i=t.target,n=this._mainAnimatedMaterials.has(i);i.isAnimated&&!n?this._mainAnimatedMaterials.add(i):!i.isAnimated&&n&&this._mainAnimatedMaterials.delete(i),this._updated()});a(this,"_nodeConfigUpdated",()=>{this._animatedRootNodes.length=0,this.visitAllNodes(t=>{t.isAnimatedRoot&&this._animatedRootNodes.push(t)}),this._updated()});this.id=ny++,this.camera=t,this.liveLightmap=new Ll,this.sharedMaterialState=new iy(this.camera,this.liveLightmap),this.camera.addEventListener(br.updatedEventType,this._updated)}canStartAutoTour(){return!this.autoTour.disabled&&this.visibleViews().length>1}startAutoTourOnLoad(){return this.canStartAutoTour()&&this.autoTour.startOnLoad&&!D.EDIT_MODE}initSegmentManager(t,i,n){ye(this.textureManager),this.segmentManager=new ty(this.textureManager,t,i,n);const r=this.views[0].toCamera(),o=new je;o.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse);const l=new Kr;l.setFromMatrix(o),this.segmentManager.loadVisibleSegments(l)}updateSegments(){const t=this.camera;t.updateMatrixWorld(!0),t.matrixWorldInverse.getInverse(t.matrixWorld);const i=new je;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);const n=new Kr;n.setFromMatrix(i),this.segmentManager.loadVisibleSegments(n),this.segmentManager.updateRenderables(this,this.segmentLightmaps)}serialize(){const t=i=>i.name!==D.DEFAULT_SKY_NAME;return{disableProgressiveLoader:this.disableProgressiveLoader,interactionPrompt:this.interactionPrompt,autoTour:this.autoTour,camera:this.camera.serialize(),materials:this.materials.map(i=>i.serialize()),nodeConfigs:this.nodeConfigs.map(i=>i.serialize()),nodes:this.nodes.map(i=>i.serialize()),lights:this.lights.map(i=>i.serialize()),lightProbes:this.lightProbes.map(i=>i.serialize()),cameraVolumes:this.cameraVolumes.map(i=>i.serialize()),autoAddLightProbes:!1,views:this.views.map(i=>i.serialize()),skies:this.skyMeshes.filter(t).map(i=>i.serialize()),minimap:this.minimapConfig.serialize()}}addMaterial(t){this.materials.push(t),t.addEventListener(si.majorLightingPropertyUpdatedEventType,this._liveLightmapUpdateNeeded),t.addEventListener("materialUpdated",this._materialUpdated),t.sharedMaterialState=this.sharedMaterialState,t.isAnimated&&this._mainAnimatedMaterials.add(t)}getMaterials(){return this.materials}replaceMaterial(t,i){const n=this.materials.indexOf(t);this._disabledMaterials[n]===void 0&&(this._disabledMaterials[n]=new Map),this._disabledMaterials[n].set(t.type,t);let r=this._disabledMaterials[n].get(i);r||(r=hp(i),r.addEventListener("materialUpdated",this._materialUpdated),r.addEventListener(si.majorLightingPropertyUpdatedEventType,this._liveLightmapUpdateNeeded),r.name=t.name,r.sharedMaterialState=this.sharedMaterialState,this.lightProbes.length===0&&(r.disableLightProbe=!0)),this.materials[n]=r,this._updated();for(let o=0;o<this.gpuMeshes.length;o+=1)this.gpuMeshes[o].material===t&&(this.gpuMeshes[o].material=r);return t.isAnimated&&this._mainAnimatedMaterials.delete(t),r.isAnimated&&this._mainAnimatedMaterials.add(r),this._sortedMaterials=null,r.setUniforms(),r}addNodeConfigsFromJson(t,i){t.nodeConfigs.forEach(n=>{n.editable=i.isNodeTypeEditable(n.name),this.addNodeConfig(new Qb(n))})}addNodesFromJson(t){const i=(n,r)=>{const o=this.findNodeConfig(r.config),l=new lp(n,o,r);return r.children&&(l.children=r.children.map(c=>i(l,c))),l};t.nodes.forEach(n=>this.addNode(i(null,n)))}addNodeConfig(t){this.nodeConfigs.push(t),this._nodeConfigsLookup[t.name]=t,t.addEventListener(ap,this._nodeConfigUpdated)}findNodeConfig(t){return Object.prototype.hasOwnProperty.call(this._nodeConfigsLookup,t)?this._nodeConfigsLookup[t]:null}addNode(t){this.nodes.push(t),t.visitSubtree(i=>{this._nodeLookup[i.id]=i,i.isAnimatedRoot&&this._animatedRootNodes.push(i)})}findNode(t){return this._nodeLookup[t]}visitAllNodes(t){for(const i of this.nodes)i.visitSubtree(t)}visitMeshesWithMaterial(t,i){this.visitAllNodes(n=>{const r=n.mesh;r&&r.material===t&&i(r)})}sortedMaterials(){return this._sortedMaterials===null&&(this._sortedMaterials=this.materials.slice(0).sort(sy)),this._sortedMaterials}_updateSceneCenterWithGpuMesh(t){if(t instanceof cl)for(let i=0;i<t.logicalMeshes.length;i+=1){const n=t.logicalMeshes[i].geometry.boundingBox;n.empty()||(n.center(this._logicalMeshCenter),this._sumLogicalMeshCenter.add(this._logicalMeshCenter),++this._logicalNonemptyMeshCount)}else{const i=t.geometry.boundingBox;i.empty()||(i.center(this._logicalMeshCenter),this._sumLogicalMeshCenter.add(this._logicalMeshCenter),++this._logicalNonemptyMeshCount)}this._logicalNonemptyMeshCount&&this._center.copyFrom(this._sumLogicalMeshCenter).divideScalar(this._logicalNonemptyMeshCount)}addGpuMesh(t){this.addAuxiliaryObject(t),this.gpuMeshes.push(t),this.boundingBox.union(t.geometry.boundingBox),(t instanceof cl?t.logicalMeshes:[t]).forEach(n=>{n.node.disableCollisions||this.collisionBoundingBox.union(n.geometry.boundingBox)}),this._updateSceneCenterWithGpuMesh(t)}addAuxiliaryObject(t,i=!1){this.threeScene.add(t),t.traverse(n=>{if(!(n instanceof Je))return;const r=n.material;r&&r.sharedMaterialState===null&&(r.sharedMaterialState=this.sharedMaterialState)}),i&&this._animatableAuxiliaryObjects.add(t),this._updated()}removeAuxiliaryObject(t){this.threeScene.remove(t),this._animatableAuxiliaryObjects.delete(t),this._updated()}addFog(t){tt(this.sharedMaterialState.fog===void 0),this.sharedMaterialState.fog=t}addBrdfLUT(t){this.sharedMaterialState.brdfLUT=t}setLightmapEncoding(t){this.sharedMaterialState.lightmapEncoding=t}getLightmapEncoding(){return this.sharedMaterialState.lightmapEncoding}hasLightmap(){return this.sharedMaterialState.lightmapEnabled}addSkyMesh(t){this.skyMeshes.push(t),t.addEventListener(Rl.updatedEventType,this._updated),this.dispatchEvent({type:Yt.skyMeshAddedEventType,skyMesh:t})}removeSkyMesh(t){zi(t,this.skyMeshes),this.dispatchEvent({type:Yt.skyMeshRemovedEventType,skyMesh:t}),t.geometry.dispose(),t.material.dispose()}findSkyMesh(t){return vo(this.skyMeshes,t,"name")}addLight(t){tt(Ol(this.lights,t.name,"name")),this.lights.push(t),t.addEventListener(dn.updatedEventType,this._updated),t.addEventListener(dn.instanceAddedEventType,this._updated),t.addEventListener(dn.instanceRemovedEventType,this._updated),t.addEventListener(dn.updatedEventType,this._liveLightmapUpdateNeeded),t.addEventListener(dn.instanceAddedEventType,this._liveLightmapUpdateNeeded),t.addEventListener(dn.instanceRemovedEventType,this._liveLightmapUpdateNeeded),this._updated(),this.dispatchEvent({type:Yt.lightAddedEventType,light:t})}addLights(t){for(const i of t)this.addLight(i)}removeLight(t){zi(t,this.lights),this._updated(),this.dispatchEvent({type:Yt.lightRemovedEventType,light:t}),this._liveLightmapUpdateNeeded()}addLightProbe(t){tt(Ol(this.lightProbes,t.id,"id")),this.lightProbes.push(t),t.addEventListener("positionUpdated",this._updated),t.addEventListener("boundsUpdated",this._updated),this._updated(),this.dispatchEvent({type:Yt.lightProbeAddedEventType,lightProbe:t})}removeLightProbe(t){zi(t,this.lightProbes);for(const i of this.gpuMeshes)Yg(t,i.lightProbes);this._updated(),this.dispatchEvent({type:Yt.lightProbeRemovedEventType,lightProbe:t}),t.dispose()}findLightProbe(t){return vo(this.lightProbes,t,"id")}findLightProbes(t){const i=new Array;let n;for(const r of t)n=vo(this.lightProbes,r,"id"),n&&i.push(n);return i}closestLightProbe(t){let i=null,n=1/0;for(const r of this.lightProbes){const o=t.distanceTo(r.position);o<n&&(n=o,i=r)}return i}addCameraAdjustmentVolume(t){tt(Ol(this.cameraVolumes,t.id,"id")),this.cameraVolumes.push(t),t.getCameraVolumeTrigger().addEventListener(_n.updatedEventType,this._updated),this._updated()}removeCameraVolume(t){zi(t,this.cameraVolumes),t.dispose(),this._updated()}findCameraVolume(t){return vo(this.cameraVolumes,t,"id")}shiftCameraVolume(t,i){tt(this.cameraVolumes.length>0),tl(this.cameraVolumes,t,i);for(let n=0;n<this.cameraVolumes.length;n+=1)this.cameraVolumes[n].setPriority(n);this.cameraVolumes.at(-1).onUpdated()}allViews(){return this.views.concat(this.internalViews)}findView(t){return vo(this.allViews(),t,"id")}findViewByName(t){return vo(this.allViews(),t,"name")}visibleViews(){return this.allViews().filter(t=>!t.hideFromMenu)}addView(t){tt(Ol(this.allViews(),t.id,"id")),t.internal?this.internalViews.push(t):this.views.push(t),t.addEventListener(Qi.updatedEventType,this._anyViewUpdated),this._updated(),this.dispatchEvent({type:Yt.viewAddedEventType,view:t})}removeView(t){zi(t,t.internal?this.internalViews:this.views),this.nodeConfigs.forEach(i=>i.removeFromHideInViews(t.id)),this._updated(),this.dispatchEvent({type:Yt.viewRemovedEventType,view:t})}shiftView(t,i){tt(t.internal===!1),tl(this.views,t,i),this.dispatchEvent({type:Yt.viewShiftedEventType,view:t})}createDefaultViews(){if(this.views.length===0){const t=new Qi({id:0,name:"Start place",hideFromMenu:!D.SHOW_INTERNAL_VIEWS,position:this.center.toArray(),rotation:[0,0],internal:!0,sky:D.EDITOR_CONTROLLED_SKY_NAME});this.addView(t)}if(D.SHOW_INTERNAL_VIEWS||D.EDIT_MODE){const t=Math.max(...this.allViews().map(u=>u.id)),i=this.boundingBox.getBoundingSphere().radius,n=this.boundingBox.size(),r=this.boundingBox.center().toArray(),o={hideFromMenu:!D.SHOW_INTERNAL_VIEWS,internal:!0,mode:Mr.ORBIT,orthographic:!0,target:r,distance:i,maxDistance:i*2},l=new Qi(pn(zt({},o),{id:t+1,name:lc.TOP,orthoFrustumSize:Math.max(n.x,n.y),rotation:[0,-90]})),c=new Qi(pn(zt({},o),{id:t+2,name:lc.FRONT,orthoFrustumSize:Math.max(n.x,n.z),rotation:[0,0]})),d=new Qi(pn(zt({},o),{id:t+3,name:lc.LEFT,orthoFrustumSize:Math.max(n.y,n.z),rotation:[-90,0]}));this.addView(l),this.addView(c),this.addView(d)}}adjustSkiesAndCameraFarToSpanWholeScene(){const t=(l,c)=>{const d=Math.max(Math.abs(l.min.x-c.x),Math.abs(l.max.x-c.x)),u=Math.max(Math.abs(l.min.y-c.y),Math.abs(l.max.y-c.y)),h=Math.max(Math.abs(l.min.z-c.z),Math.abs(l.max.z-c.z));return Math.sqrt(d*d+u*u+h*h)},i=(l,c)=>{const d=l.maxDistance===void 0?l.distance:l.maxDistance;if(l.target&&d)return l.target.distanceTo(c)+d},n=(l,c)=>{if(l.position)return l.position.distanceTo(c)},r=(l,c)=>{let d=0;return l.forEach(u=>{let h;u.mode==="orbit"?h=i(u,c):u.mode==="fps"&&(h=n(u,c)),h&&h>d&&(d=h)}),d};let o=0;for(const l of this.skyMeshes){l.autoPosition&&l.position.copyFrom(this.center);let c;if(this.boundingBox.empty())c=0;else{const d=t(this.boundingBox,l.position),u=r(this.allViews(),l.position);c=Math.max(d,u)}c+=D.SKY_DISTANCE_TO_SCENE,l.radius=c,o=Math.max(o,c)}this.camera.far=Math.max(this.camera.far,2*o),Le.log("Camera far set to "+this.camera.far)}disableLightProbesForMaterials(){for(const t of this.materials)t.disableLightProbe=!0,t.setUniforms()}enableLightProbesForMaterials(){for(const t of this.materials)t.disableLightProbe=!1,t.setUniforms()}getAnimatedMaterials(){const t=!this._animatedPrevCallId;for(const n of this._mainAnimatedMaterials)this._animatedMaterialToCallId.set(n,t);const i=n=>{n instanceof Je&&n.material.isAnimated&&this._animatedMaterialToCallId.set(n.material,t)};for(const n of this._animatableAuxiliaryObjects)n.traverse(i);for(const[n,r]of this._animatedMaterialToCallId)r===this._animatedPrevCallId&&this._animatedMaterialToCallId.delete(n);return this._animatedPrevCallId=t,this._animatedMaterialToCallId.keys()}getAnimatedRootNodes(){return this._animatedRootNodes}get center(){return this._center}};a(Yt,"updatedEventType","sceneUpdated"),a(Yt,"anyViewUpdatedEventType","anyViewUpdated"),a(Yt,"viewAddedEventType","viewAdded"),a(Yt,"viewRemovedEventType","viewRemoved"),a(Yt,"viewShiftedEventType","viewShifted"),a(Yt,"skyMeshAddedEventType","skyMeshAdded"),a(Yt,"skyMeshRemovedEventType","skyMeshRemoved"),a(Yt,"lightAddedEventType","lightAdded"),a(Yt,"lightRemovedEventType","lightRemoved"),a(Yt,"lightProbeAddedEventType","lightProbeAdded"),a(Yt,"lightProbeRemovedEventType","lightProbeRemoved"),a(Yt,"liveLightmapNeedsUpdateEventType","liveLightmapNeedsUpdate");let wi=Yt;function hp(s){switch(s){case"grass":return new Xo;case"water":return new Yb;default:return D.DEV_MATERIALX?new jb:new si}}function ry(s){const e=new ro(new Re(16777215*Math.random())),t=dt.createBox(s.max.x-s.min.x,s.max.y-s.min.y,s.max.z-s.min.z),i=new Je(t,e);return s.center(i.position),i.updateMatrixWorld(),i}function oy(s,e=!1){for(const t of s.gpuMeshes){if(!(t instanceof Je)||e&&!t.material.transparent)continue;const i=t.geometry;i.boundingBox||i.computeBoundingBox();const n=ry(i.boundingBox);s.addAuxiliaryObject(n)}}const ay=function(s,e){console.warn("Camera path debug mode");const t=2,i=document.createElement("canvas"),n=i.getContext("2d");i.width=s*t,i.height=e*t,i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.maxWidth="100%",document.body.appendChild(i);const r={};function o(b){return parseFloat(b.toFixed(4))}function l(b,_){return b.reduce((y,A)=>y+A[_],0)}function c(b,_="black",y=1,A=1){const T=b.x*t,M=b.y*t,C=A*t;n.lineWidth=y*t,n.strokeStyle=_,n.beginPath(),n.arc(T,M,C,0,Math.PI*2),n.stroke()}function d(b,_="black",y=1,A=!1){const T=b.x*t-.5*t,M=b.y*t-.5*t,C=t,N=t;n.lineWidth=y*t,n.strokeStyle=_,n.fillStyle=_,n.beginPath(),n.rect(T,M,C,N),n.stroke(),A&&n.fill()}function u(b,_,y="black",A=1){n.lineWidth=A*t,n.strokeStyle=y,n.beginPath(),n.moveTo(b.x*t,b.y*t),n.lineTo(_.x*t,_.y*t),n.stroke()}function h(b){b.forEach(_=>{const y=_.distanceToObstacle*255,A=_.distanceToObstacle===0?"black":"rgb(255,"+y+","+y+")";d(_,A,0,!0)})}function f(b){b.forEach(_=>{const y=new Ue(_.x,_.y);c(y,"green",.5,.5)})}function p(b){b.forEach((_,y)=>{const A=new Ue(_.x,_.y);if(y>0){const T=new Ue(b[y-1].x,b[y-1].y);u(T,A,"blue",1)}c(A,"blue",1,1)})}this.render=function(b,_,y){n.clearRect(0,0,s*t,e*t),h(b),f(_),p(y)};const m=function(b){const _=[];function y(){return _.at(-1)}function A(){return _.at(-1).end-_.at(-1).start}this.start=function(){const T=performance.now(),M={start:T,end:T,delta:0};_.push(M)},this.end=function(){const T=performance.now();y()!==void 0&&(y().end=T,y().delta=A())},this.stats=function(){const T=y().delta,M=_.reduce((q,j)=>q.delta<j.delta?q:j).delta,C=_.reduce((q,j)=>q.delta>j.delta?q:j).delta,O=l(_,"delta")/_.length;return{name:b,last:o(T),best:o(M),worst:o(C),average:o(O)}}};this.timeStart=function(b){r[b]===void 0&&(r[b]=new m(b)),r[b].start()},this.timeEnd=function(b){r[b]!==void 0&&r[b].end()},this.logTime=function(){const b=[];Object.values(r).forEach(y=>{b.push(y.stats())});const _={name:"TOTAL",last:o(l(b,"last")),best:o(l(b,"best")),worst:o(l(b,"worst")),average:o(l(b,"average"))};b.push(_),console.table(b)}};function Bl(s,e){s&&s.timeStart(e)}function Nl(s,e){s&&s.timeEnd(e)}const dp=function(s="score"){const e=[];function t(n){const r=e[n];for(;n>0;){const o=Math.floor((n-1)/2),l=e[o];if(r[s]<=l[s])e[o]=r,e[n]=l,n=o;else break}}function i(n){const r=e[n];for(;;){const o=2*n+1,l=2*n+2;let c,d,u=null;if(o<e.length&&(c=e[o],r[s]>c[s]&&(u=o)),l<e.length&&(d=e[l],(u===null&&r[s]>d[s]||u!==null&&c[s]>d[s])&&(u=l)),u!==null)e[n]=e[u],e[u]=r,n=u;else break}}this.extract=function(){const n=e[0],r=e.pop();return e.length>0&&(e[0]=r,i(0)),n},this.insert=function(n){e.push(n),t(e.length-1)},this.update=function(n){const r=e.indexOf(n);if(r===0)return;const o=Math.floor((r-1)/2);n[s]<e[o]?t(r):i(r)},this.size=function(){return e.length}},up=function(s,e,t,i){this.id=s,this.x=e,this.y=t,this.distanceToObstacle=i,this.parent=null,this.score=0};up.prototype={distanceTo:function(s){return Math.sqrt(Math.pow(this.x-s.x,2)+Math.pow(this.y-s.y,2))},distanceMeasured:function(){return this.distanceToObstacle!==void 0},isObstacle:function(){return this.distanceToObstacle===0},visited:function(){return this.parent!==null},visit:function(s,e){this.parent=s,this.score=e}};const ly=function(s,e,t,i){const n=[-1,1,-e,e],r=s.canvasRange,o=s.collisionRange,l=[];function c(u){const h=new dp("distanceToObstacle");for(let f=0;f<=u.data.length;f+=4){const p=u.data[f-1]===255,m=Math.floor(f/(e*4)),b=f/4-m*e,_=p?0:void 0,y=new up(f/4,b,m,_);l.push(y),p&&h.insert(y)}for(;h.size()>0;){const f=h.extract();n.forEach(p=>{const m=f.id+p;f.distanceToObstacle<1&&l[m]!==void 0&&l[m].distanceMeasured()===!1&&(l[m].distanceToObstacle=Math.min(1,f.distanceToObstacle+1/i),h.insert(l[m]))})}}c(s.collisionImageData);function d(u,h){if(u.x!==0&&u.x!==e-1)return!0;const f=u.x+h.x!==1,p=u.x+h.x!==e-2;return!f&&!p}this.forEachNeighbour=function(u,h){const f=u.x+u.y*e;n.forEach(p=>{l[f+p]!==void 0&&d(u,l[f+p])&&h(l[f+p])})},this.hasObstacleAt=function(u,h){const f=Math.round(u)+Math.round(h)*e;return l[f].isObstacle()},this.getNodeAtScenePosition=function(u){const h=Math.round(Bi(u.position.x,o.x.min,o.x.max,r.x.min,r.x.max)),f=Math.round(Bi(u.position.y,o.y.min,o.y.max,r.y.min,r.y.max)),p=h+f*e;return l[p]},this.getScenePointFromNode=function(u){const h=Bi(u.x,r.x.min,r.x.max,o.x.min,o.x.max),f=Bi(u.y,r.y.min,r.y.max,o.y.min,o.y.max);return new Ue(h,f)},this.resetNodeMap=function(){l.forEach(u=>{u.parent=null,u.score=0})},this.getNodeMap=function(){return l}};function cy(s,e){let t=null,i=null;const n=200,r=7,{width:o,height:l}=e.calculateRenderSize(n,s.collisionBoundingBox),c=D.DEBUG_CAMERA_PATH?new ay(o,l):null;function d(_){const y=_.position.z.toFixed(4);if(y!==t){const A={outlineThickness:2,outlineColor:new Re(0,0,0),slicePlaneHeight:_.position.z},T=e.getCollisionData(A,o,l);i=new ly(T,o,l,r),t=y}else i.resetNodeMap()}function u(_,y){const A=i.getNodeAtScenePosition(_),T=i.getNodeAtScenePosition(y);if(!A||!T)return[];const M=new dp;M.insert(A);const C=[];for(;M.size()>0;){const N=M.extract();if(N===T){for(let O=N;O;O=O.parent)O&&C.push(O);C.reverse();break}i.forEachNeighbour(N,O=>{if(O.isObstacle())return;const q=O.distanceToObstacle?O.distanceToObstacle:1,j=N.score+1/q,K=O.visited()||O===A;(!K||j<O.score)&&(O.visit(N,j),K?M.update(O):M.insert(O))})}return C}function h(_,y){const A=Math.abs(_.y-y.y)>Math.abs(_.x-y.x),T=_.x<y.x?_:y,M=_.x<y.x?y:_,C=_.y<y.y?_:y,N=_.y<y.y?y:_,O=T.x===M.x?null:(M.y-T.y)/(M.x-T.x),q=O===null?T.x:T.y-O*T.x;if(A)for(let j=C.y;j<=N.y;j+=.2){const K=O===null?C.x:(j-q)/O;if(i.hasObstacleAt(K,j))return!0}else for(let j=T.x;j<=M.x;j+=.2){const K=O===null?T.y:O*j+q;if(i.hasObstacleAt(j,K))return!0}return!1}function f(_,y){for(let A=_+1;A<y.length;A++)if(h(y[_],y[A]))return A;return-1}function p(_,y,A,T){const M=f(_,y);if(M===-1)A.push(y.at(-1));else{const C=M-_,N=C>T?M-T:M-Math.floor(C/2);A.push(y[N]),p(N,y,A,T)}}function m(_){const y=[_[0]];return p(0,_,y,5),y}function b(_,y,A){const T=[];T.push(new Ue(y.position.x,y.position.y));for(let M=1;M<_.length-1;M++)T.push(i.getScenePointFromNode(_[M]));return T.push(new Ue(A.position.x,A.position.y)),T}this.findPath=function(_,y){Bl(c,"Graph"),d(y),Nl(c,"Graph"),Bl(c,"Raw path");const A=u(_,y);Nl(c,"Raw path");const T=[],M=[];return A.length>=2&&(Bl(c,"Refine path"),T.push(...m(A)),Nl(c,"Refine path"),Bl(c,"Calculate points"),M.push(...b(T,_,y)),Nl(c,"Calculate points")),c&&(c.render(i.getNodeMap(),A,T),c.logTime()),M}}const{abs:oa,cos:Is,sin:bo,acos:hy,atan2:aa,sqrt:ir,pow:Rn}=Math;function la(s){return s<0?-Rn(-s,1/3):Rn(s,1/3)}const fp=Math.PI,kl=2*fp,nr=fp/2,dy=1e-6,Yh=Number.MAX_SAFE_INTEGER||9007199254740991,Qh=Number.MIN_SAFE_INTEGER||-9007199254740991,uy={x:0,y:0,z:0},Me={Tvalues:[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213],Cvalues:[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872],arcfn:function(s,e){const t=e(s);let i=t.x*t.x+t.y*t.y;return typeof t.z!="undefined"&&(i+=t.z*t.z),ir(i)},compute:function(s,e,t){if(s===0)return e[0].t=0,e[0];const i=e.length-1;if(s===1)return e[i].t=1,e[i];const n=1-s;let r=e;if(i===0)return e[0].t=s,e[0];if(i===1){const l={x:n*r[0].x+s*r[1].x,y:n*r[0].y+s*r[1].y,t:s};return t&&(l.z=n*r[0].z+s*r[1].z),l}if(i<4){let l=n*n,c=s*s,d,u,h,f=0;i===2?(r=[r[0],r[1],r[2],uy],d=l,u=n*s*2,h=c):i===3&&(d=l*n,u=l*s*3,h=n*c*3,f=s*c);const p={x:d*r[0].x+u*r[1].x+h*r[2].x+f*r[3].x,y:d*r[0].y+u*r[1].y+h*r[2].y+f*r[3].y,t:s};return t&&(p.z=d*r[0].z+u*r[1].z+h*r[2].z+f*r[3].z),p}const o=JSON.parse(JSON.stringify(e));for(;o.length>1;){for(let l=0;l<o.length-1;l++)o[l]={x:o[l].x+(o[l+1].x-o[l].x)*s,y:o[l].y+(o[l+1].y-o[l].y)*s},typeof o[l].z!="undefined"&&(o[l]=o[l].z+(o[l+1].z-o[l].z)*s);o.splice(o.length-1,1)}return o[0].t=s,o[0]},computeWithRatios:function(s,e,t,i){const n=1-s,r=t,o=e;let l=r[0],c=r[1],d=r[2],u=r[3],h;if(l*=n,c*=s,o.length===2)return h=l+c,{x:(l*o[0].x+c*o[1].x)/h,y:(l*o[0].y+c*o[1].y)/h,z:i?(l*o[0].z+c*o[1].z)/h:!1,t:s};if(l*=n,c*=2*n,d*=s*s,o.length===3)return h=l+c+d,{x:(l*o[0].x+c*o[1].x+d*o[2].x)/h,y:(l*o[0].y+c*o[1].y+d*o[2].y)/h,z:i?(l*o[0].z+c*o[1].z+d*o[2].z)/h:!1,t:s};if(l*=n,c*=1.5*n,d*=3*n,u*=s*s*s,o.length===4)return h=l+c+d+u,{x:(l*o[0].x+c*o[1].x+d*o[2].x+u*o[3].x)/h,y:(l*o[0].y+c*o[1].y+d*o[2].y+u*o[3].y)/h,z:i?(l*o[0].z+c*o[1].z+d*o[2].z+u*o[3].z)/h:!1,t:s}},derive:function(s,e){const t=[];for(let i=s,n=i.length,r=n-1;n>1;n--,r--){const o=[];for(let l=0,c;l<r;l++)c={x:r*(i[l+1].x-i[l].x),y:r*(i[l+1].y-i[l].y)},e&&(c.z=r*(i[l+1].z-i[l].z)),o.push(c);t.push(o),i=o}return t},between:function(s,e,t){return e<=s&&s<=t||Me.approximately(s,e)||Me.approximately(s,t)},approximately:function(s,e,t){return oa(s-e)<=(t||dy)},length:function(s){const t=Me.Tvalues.length;let i=0;for(let n=0,r;n<t;n++)r=.5*Me.Tvalues[n]+.5,i+=Me.Cvalues[n]*Me.arcfn(r,s);return .5*i},map:function(s,e,t,i,n){const r=t-e,o=n-i,l=s-e,c=l/r;return i+o*c},lerp:function(s,e,t){const i={x:e.x+s*(t.x-e.x),y:e.y+s*(t.y-e.y)};return e.z!==void 0&&t.z!==void 0&&(i.z=e.z+s*(t.z-e.z)),i},pointToString:function(s){let e=s.x+"/"+s.y;return typeof s.z!="undefined"&&(e+="/"+s.z),e},pointsToString:function(s){return"["+s.map(Me.pointToString).join(", ")+"]"},copy:function(s){return JSON.parse(JSON.stringify(s))},angle:function(s,e,t){const i=e.x-s.x,n=e.y-s.y,r=t.x-s.x,o=t.y-s.y,l=i*o-n*r,c=i*r+n*o;return aa(l,c)},round:function(s,e){const t=""+s,i=t.indexOf(".");return parseFloat(t.substring(0,i+1+e))},dist:function(s,e){const t=s.x-e.x,i=s.y-e.y;return ir(t*t+i*i)},closest:function(s,e){let t=Rn(2,63),i,n;return s.forEach(function(r,o){n=Me.dist(e,r),n<t&&(t=n,i=o)}),{mdist:t,mpos:i}},abcratio:function(s,e){if(e!==2&&e!==3)return!1;if(typeof s=="undefined")s=.5;else if(s===0||s===1)return s;const t=Rn(s,e)+Rn(1-s,e),i=t-1;return oa(i/t)},projectionratio:function(s,e){if(e!==2&&e!==3)return!1;if(typeof s=="undefined")s=.5;else if(s===0||s===1)return s;const t=Rn(1-s,e),i=Rn(s,e)+t;return t/i},lli8:function(s,e,t,i,n,r,o,l){const c=(s*i-e*t)*(n-o)-(s-t)*(n*l-r*o),d=(s*i-e*t)*(r-l)-(e-i)*(n*l-r*o),u=(s-t)*(r-l)-(e-i)*(n-o);return u==0?!1:{x:c/u,y:d/u}},lli4:function(s,e,t,i){const n=s.x,r=s.y,o=e.x,l=e.y,c=t.x,d=t.y,u=i.x,h=i.y;return Me.lli8(n,r,o,l,c,d,u,h)},lli:function(s,e){return Me.lli4(s,s.c,e,e.c)},makeline:function(s,e){return new Kt(s.x,s.y,(s.x+e.x)/2,(s.y+e.y)/2,e.x,e.y)},findbbox:function(s){let e=Yh,t=Yh,i=Qh,n=Qh;return s.forEach(function(r){const o=r.bbox();e>o.x.min&&(e=o.x.min),t>o.y.min&&(t=o.y.min),i<o.x.max&&(i=o.x.max),n<o.y.max&&(n=o.y.max)}),{x:{min:e,mid:(e+i)/2,max:i,size:i-e},y:{min:t,mid:(t+n)/2,max:n,size:n-t}}},shapeintersections:function(s,e,t,i,n){if(!Me.bboxoverlap(e,i))return[];const r=[],o=[s.startcap,s.forward,s.back,s.endcap],l=[t.startcap,t.forward,t.back,t.endcap];return o.forEach(function(c){c.virtual||l.forEach(function(d){if(d.virtual)return;const u=c.intersects(d,n);u.length>0&&(u.c1=c,u.c2=d,u.s1=s,u.s2=t,r.push(u))})}),r},makeshape:function(s,e,t){const i=e.points.length,n=s.points.length,r=Me.makeline(e.points[i-1],s.points[0]),o=Me.makeline(s.points[n-1],e.points[0]),l={startcap:r,forward:s,back:e,endcap:o,bbox:Me.findbbox([r,s,e,o])};return l.intersections=function(c){return Me.shapeintersections(l,l.bbox,c,c.bbox,t)},l},getminmax:function(s,e,t){if(!t)return{min:0,max:0};let i=Yh,n=Qh,r,o;t.indexOf(0)===-1&&(t=[0].concat(t)),t.indexOf(1)===-1&&t.push(1);for(let l=0,c=t.length;l<c;l++)r=t[l],o=s.get(r),o[e]<i&&(i=o[e]),o[e]>n&&(n=o[e]);return{min:i,mid:(i+n)/2,max:n,size:n-i}},align:function(s,e){const t=e.p1.x,i=e.p1.y,n=-aa(e.p2.y-i,e.p2.x-t),r=function(o){return{x:(o.x-t)*Is(n)-(o.y-i)*bo(n),y:(o.x-t)*bo(n)+(o.y-i)*Is(n)}};return s.map(r)},roots:function(s,e){e=e||{p1:{x:0,y:0},p2:{x:1,y:0}};const t=s.length-1,i=Me.align(s,e),n=function(O){return 0<=O&&O<=1};if(t===2){const O=i[0].y,q=i[1].y,j=i[2].y,K=O-2*q+j;if(K!==0){const de=-ir(q*q-O*j),xe=-O+q,Ve=-(de+xe)/K,qe=-(-de+xe)/K;return[Ve,qe].filter(n)}else if(q!==j&&K===0)return[(2*q-j)/(2*q-2*j)].filter(n);return[]}const r=i[0].y,o=i[1].y,l=i[2].y,c=i[3].y;let d=-r+3*o-3*l+c,u=3*r-6*o+3*l,h=-3*r+3*o,f=r;if(Me.approximately(d,0)){if(Me.approximately(u,0))return Me.approximately(h,0)?[]:[-f/h].filter(n);const O=ir(h*h-4*u*f),q=2*u;return[(O-h)/q,(-h-O)/q].filter(n)}u/=d,h/=d,f/=d;const p=(3*h-u*u)/3,m=p/3,b=(2*u*u*u-9*u*h+27*f)/27,_=b/2,y=_*_+m*m*m;let A,T,M,C,N;if(y<0){const O=-p/3,q=O*O*O,j=ir(q),K=-b/(2*j),de=K<-1?-1:K>1?1:K,xe=hy(de),Ve=la(j),qe=2*Ve;return M=qe*Is(xe/3)-u/3,C=qe*Is((xe+kl)/3)-u/3,N=qe*Is((xe+2*kl)/3)-u/3,[M,C,N].filter(n)}else{if(y===0)return A=_<0?la(-_):-la(_),M=2*A-u/3,C=-A-u/3,[M,C].filter(n);{const O=ir(y);return A=la(-_+O),T=la(_+O),[A-T-u/3].filter(n)}}},droots:function(s){if(s.length===3){const e=s[0],t=s[1],i=s[2],n=e-2*t+i;if(n!==0){const r=-ir(t*t-e*i),o=-e+t,l=-(r+o)/n,c=-(-r+o)/n;return[l,c]}else if(t!==i&&n===0)return[(2*t-i)/(2*(t-i))];return[]}if(s.length===2){const e=s[0],t=s[1];return e!==t?[e/(e-t)]:[]}return[]},curvature:function(s,e,t,i,n){let r,o,l,c,d=0,u=0;const h=Me.compute(s,e),f=Me.compute(s,t),p=h.x*h.x+h.y*h.y;if(i?(r=ir(Rn(h.y*f.z-f.y*h.z,2)+Rn(h.z*f.x-f.z*h.x,2)+Rn(h.x*f.y-f.x*h.y,2)),o=Rn(p+h.z*h.z,3/2)):(r=h.x*f.y-h.y*f.x,o=Rn(p,3/2)),r===0||o===0)return{k:0,r:0};if(d=r/o,u=o/r,!n){const m=Me.curvature(s-.001,e,t,i,!0).k,b=Me.curvature(s+.001,e,t,i,!0).k;c=(b-d+(d-m))/2,l=(oa(b-d)+oa(d-m))/2}return{k:d,r:u,dk:c,adk:l}},inflections:function(s){if(s.length<4)return[];const e=Me.align(s,{p1:s[0],p2:s.slice(-1)[0]}),t=e[2].x*e[1].y,i=e[3].x*e[1].y,n=e[1].x*e[2].y,r=e[3].x*e[2].y,o=18*(-3*t+2*i+3*n-r),l=18*(3*t-i-3*n),c=18*(n-t);if(Me.approximately(o,0)){if(!Me.approximately(l,0)){let f=-c/l;if(0<=f&&f<=1)return[f]}return[]}const d=l*l-4*o*c,u=Math.sqrt(d),h=2*o;return Me.approximately(h,0)?[]:[(u-l)/h,-(l+u)/h].filter(function(f){return 0<=f&&f<=1})},bboxoverlap:function(s,e){const t=["x","y"],i=t.length;for(let n=0,r,o,l,c;n<i;n++)if(r=t[n],o=s[r].mid,l=e[r].mid,c=(s[r].size+e[r].size)/2,oa(o-l)>=c)return!1;return!0},expandbox:function(s,e){e.x.min<s.x.min&&(s.x.min=e.x.min),e.y.min<s.y.min&&(s.y.min=e.y.min),e.z&&e.z.min<s.z.min&&(s.z.min=e.z.min),e.x.max>s.x.max&&(s.x.max=e.x.max),e.y.max>s.y.max&&(s.y.max=e.y.max),e.z&&e.z.max>s.z.max&&(s.z.max=e.z.max),s.x.mid=(s.x.min+s.x.max)/2,s.y.mid=(s.y.min+s.y.max)/2,s.z&&(s.z.mid=(s.z.min+s.z.max)/2),s.x.size=s.x.max-s.x.min,s.y.size=s.y.max-s.y.min,s.z&&(s.z.size=s.z.max-s.z.min)},pairiteration:function(s,e,t){const i=s.bbox(),n=e.bbox(),r=1e5,o=t||.5;if(i.x.size+i.y.size<o&&n.x.size+n.y.size<o)return[(r*(s._t1+s._t2)/2|0)/r+"/"+(r*(e._t1+e._t2)/2|0)/r];let l=s.split(.5),c=e.split(.5),d=[{left:l.left,right:c.left},{left:l.left,right:c.right},{left:l.right,right:c.right},{left:l.right,right:c.left}];d=d.filter(function(h){return Me.bboxoverlap(h.left.bbox(),h.right.bbox())});let u=[];return d.length===0||(d.forEach(function(h){u=u.concat(Me.pairiteration(h.left,h.right,o))}),u=u.filter(function(h,f){return u.indexOf(h)===f})),u},getccenter:function(s,e,t){const i=e.x-s.x,n=e.y-s.y,r=t.x-e.x,o=t.y-e.y,l=i*Is(nr)-n*bo(nr),c=i*bo(nr)+n*Is(nr),d=r*Is(nr)-o*bo(nr),u=r*bo(nr)+o*Is(nr),h=(s.x+e.x)/2,f=(s.y+e.y)/2,p=(e.x+t.x)/2,m=(e.y+t.y)/2,b=h+l,_=f+c,y=p+d,A=m+u,T=Me.lli8(h,f,b,_,p,m,y,A),M=Me.dist(T,s);let C=aa(s.y-T.y,s.x-T.x),N=aa(e.y-T.y,e.x-T.x),O=aa(t.y-T.y,t.x-T.x),q;return C<O?((C>N||N>O)&&(C+=kl),C>O&&(q=O,O=C,C=q)):O<N&&N<C?(q=O,O=C,C=q):O+=kl,T.s=C,T.e=O,T.r=M,T},numberSort:function(s,e){return s-e}};class ca{constructor(e){this.curves=[],this._3d=!1,e&&(this.curves=e,this._3d=this.curves[0]._3d)}valueOf(){return this.toString()}toString(){return"["+this.curves.map(function(e){return Me.pointsToString(e.points)}).join(", ")+"]"}addCurve(e){this.curves.push(e),this._3d=this._3d||e._3d}length(){return this.curves.map(function(e){return e.length()}).reduce(function(e,t){return e+t})}curve(e){return this.curves[e]}bbox(){const e=this.curves;for(var t=e[0].bbox(),i=1;i<e.length;i++)Me.expandbox(t,e[i].bbox());return t}offset(e){const t=[];return this.curves.forEach(function(i){t.push(...i.offset(e))}),new ca(t)}}const{abs:ha,min:pp,max:mp,cos:fy,sin:py,acos:my,sqrt:da}=Math,gy=Math.PI;class Kt{constructor(e){let t=e&&e.forEach?e:Array.from(arguments).slice(),i=!1;if(typeof t[0]=="object"){i=t.length;const p=[];t.forEach(function(m){["x","y","z"].forEach(function(b){typeof m[b]!="undefined"&&p.push(m[b])})}),t=p}let n=!1;const r=t.length;if(i){if(i>4){if(arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");n=!0}}else if(r!==6&&r!==8&&r!==9&&r!==12&&arguments.length!==1)throw new Error("Only new Bezier(point[]) is accepted for 4th and higher order curves");const o=this._3d=!n&&(r===9||r===12)||e&&e[0]&&typeof e[0].z!="undefined",l=this.points=[];for(let p=0,m=o?3:2;p<r;p+=m){var c={x:t[p],y:t[p+1]};o&&(c.z=t[p+2]),l.push(c)}const d=this.order=l.length-1,u=this.dims=["x","y"];o&&u.push("z"),this.dimlen=u.length;const h=Me.align(l,{p1:l[0],p2:l[d]}),f=Me.dist(l[0],l[d]);this._linear=h.reduce((p,m)=>p+ha(m.y),0)<f/50,this._lut=[],this._t1=0,this._t2=1,this.update()}static quadraticFromPoints(e,t,i,n){if(typeof n=="undefined"&&(n=.5),n===0)return new Kt(t,t,i);if(n===1)return new Kt(e,t,t);const r=Kt.getABC(2,e,t,i,n);return new Kt(e,r.A,i)}static cubicFromPoints(e,t,i,n,r){typeof n=="undefined"&&(n=.5);const o=Kt.getABC(3,e,t,i,n);typeof r=="undefined"&&(r=Me.dist(t,o.C));const l=r*(1-n)/n,c=Me.dist(e,i),d=(i.x-e.x)/c,u=(i.y-e.y)/c,h=r*d,f=r*u,p=l*d,m=l*u,b={x:t.x-h,y:t.y-f},_={x:t.x+p,y:t.y+m},y=o.A,A={x:y.x+(b.x-y.x)/(1-n),y:y.y+(b.y-y.y)/(1-n)},T={x:y.x+(_.x-y.x)/n,y:y.y+(_.y-y.y)/n},M={x:e.x+(A.x-e.x)/n,y:e.y+(A.y-e.y)/n},C={x:i.x+(T.x-i.x)/(1-n),y:i.y+(T.y-i.y)/(1-n)};return new Kt(e,M,C,i)}static getUtils(){return Me}getUtils(){return Kt.getUtils()}static get PolyBezier(){return ca}valueOf(){return this.toString()}toString(){return Me.pointsToString(this.points)}toSVG(){if(this._3d)return!1;const e=this.points,t=e[0].x,i=e[0].y,n=["M",t,i,this.order===2?"Q":"C"];for(let r=1,o=e.length;r<o;r++)n.push(e[r].x),n.push(e[r].y);return n.join(" ")}setRatios(e){if(e.length!==this.points.length)throw new Error("incorrect number of ratio values");this.ratios=e,this._lut=[]}verify(){const e=this.coordDigest();e!==this._print&&(this._print=e,this.update())}coordDigest(){return this.points.map(function(e,t){return""+t+e.x+e.y+(e.z?e.z:0)}).join("")}update(){this._lut=[],this.dpoints=Me.derive(this.points,this._3d),this.computedirection()}computedirection(){const e=this.points,t=Me.angle(e[0],e[this.order],e[1]);this.clockwise=t>0}length(){return Me.length(this.derivative.bind(this))}static getABC(e=2,t,i,n,r=.5){const o=Me.projectionratio(r,e),l=1-o,c={x:o*t.x+l*n.x,y:o*t.y+l*n.y},d=Me.abcratio(r,e);return{A:{x:i.x+(i.x-c.x)/d,y:i.y+(i.y-c.y)/d},B:i,C:c,S:t,E:n}}getABC(e,t){t=t||this.get(e);let i=this.points[0],n=this.points[this.order];return Kt.getABC(this.order,i,t,n,e)}getLUT(e){if(this.verify(),e=e||100,this._lut.length===e)return this._lut;this._lut=[],e++,this._lut=[];for(let t=0,i,n;t<e;t++)n=t/(e-1),i=this.compute(n),i.t=n,this._lut.push(i);return this._lut}on(e,t){t=t||5;let i;const n=this.getLUT(),r=[];for(let o=0,l,c=0;o<n.length;o++)l=n[o],Me.dist(l,e)<t&&(r.push(l),c+=o/n.length);return r.length?i/=r.length:!1}project(e){const t=this.getLUT(),i=t.length-1,n=Me.closest(t,e),r=n.mpos,o=(r-1)/i,l=(r+1)/i,c=.1/i;let d=n.mdist,u=o,h=u,f;d+=1;for(let p;u<l+c;u+=c)f=this.compute(u),p=Me.dist(e,f),p<d&&(d=p,h=u);return h=h<0?0:h>1?1:h,f=this.compute(h),f.t=h,f.d=d,f}get(e){return this.compute(e)}point(e){return this.points[e]}compute(e){return this.ratios?Me.computeWithRatios(e,this.points,this.ratios,this._3d):Me.compute(e,this.points,this._3d,this.ratios)}raise(){const e=this.points,t=[e[0]],i=e.length;for(let n=1,r,o;n<i;n++)r=e[n],o=e[n-1],t[n]={x:(i-n)/i*r.x+n/i*o.x,y:(i-n)/i*r.y+n/i*o.y};return t[i]=e[i-1],new Kt(t)}derivative(e){return Me.compute(e,this.dpoints[0],this._3d)}dderivative(e){return Me.compute(e,this.dpoints[1],this._3d)}align(){let e=this.points;return new Kt(Me.align(e,{p1:e[0],p2:e[e.length-1]}))}curvature(e){return Me.curvature(e,this.dpoints[0],this.dpoints[1],this._3d)}inflections(){return Me.inflections(this.points)}normal(e){return this._3d?this.__normal3(e):this.__normal2(e)}__normal2(e){const t=this.derivative(e),i=da(t.x*t.x+t.y*t.y);return{x:-t.y/i,y:t.x/i}}__normal3(e){const t=this.derivative(e),i=this.derivative(e+.01),n=da(t.x*t.x+t.y*t.y+t.z*t.z),r=da(i.x*i.x+i.y*i.y+i.z*i.z);t.x/=n,t.y/=n,t.z/=n,i.x/=r,i.y/=r,i.z/=r;const o={x:i.y*t.z-i.z*t.y,y:i.z*t.x-i.x*t.z,z:i.x*t.y-i.y*t.x},l=da(o.x*o.x+o.y*o.y+o.z*o.z);o.x/=l,o.y/=l,o.z/=l;const c=[o.x*o.x,o.x*o.y-o.z,o.x*o.z+o.y,o.x*o.y+o.z,o.y*o.y,o.y*o.z-o.x,o.x*o.z-o.y,o.y*o.z+o.x,o.z*o.z];return{x:c[0]*t.x+c[1]*t.y+c[2]*t.z,y:c[3]*t.x+c[4]*t.y+c[5]*t.z,z:c[6]*t.x+c[7]*t.y+c[8]*t.z}}hull(e){let t=this.points,i=[],n=[],r=0;for(n[r++]=t[0],n[r++]=t[1],n[r++]=t[2],this.order===3&&(n[r++]=t[3]);t.length>1;){i=[];for(let o=0,l,c=t.length-1;o<c;o++)l=Me.lerp(e,t[o],t[o+1]),n[r++]=l,i.push(l);t=i}return n}split(e,t){if(e===0&&t)return this.split(t).left;if(t===1)return this.split(e).right;const i=this.hull(e),n={left:this.order===2?new Kt([i[0],i[3],i[5]]):new Kt([i[0],i[4],i[7],i[9]]),right:this.order===2?new Kt([i[5],i[4],i[2]]):new Kt([i[9],i[8],i[6],i[3]]),span:i};return n.left._t1=Me.map(0,0,1,this._t1,this._t2),n.left._t2=Me.map(e,0,1,this._t1,this._t2),n.right._t1=Me.map(e,0,1,this._t1,this._t2),n.right._t2=Me.map(1,0,1,this._t1,this._t2),t?(t=Me.map(t,e,1,0,1),n.right.split(t).left):n}extrema(){const e={};let t=[];return this.dims.forEach(function(i){let n=function(o){return o[i]},r=this.dpoints[0].map(n);e[i]=Me.droots(r),this.order===3&&(r=this.dpoints[1].map(n),e[i]=e[i].concat(Me.droots(r))),e[i]=e[i].filter(function(o){return o>=0&&o<=1}),t=t.concat(e[i].sort(Me.numberSort))}.bind(this)),e.values=t.sort(Me.numberSort).filter(function(i,n){return t.indexOf(i)===n}),e}bbox(){const e=this.extrema(),t={};return this.dims.forEach(function(i){t[i]=Me.getminmax(this,i,e[i])}.bind(this)),t}overlaps(e){const t=this.bbox(),i=e.bbox();return Me.bboxoverlap(t,i)}offset(e,t){if(typeof t!="undefined"){const i=this.get(e),n=this.normal(e),r={c:i,n,x:i.x+n.x*t,y:i.y+n.y*t};return this._3d&&(r.z=i.z+n.z*t),r}if(this._linear){const i=this.normal(0),n=this.points.map(function(r){const o={x:r.x+e*i.x,y:r.y+e*i.y};return r.z&&i.z&&(o.z=r.z+e*i.z),o});return[new Kt(n)]}return this.reduce().map(function(i){return i._linear?i.offset(e)[0]:i.scale(e)})}simple(){if(this.order===3){const n=Me.angle(this.points[0],this.points[3],this.points[1]),r=Me.angle(this.points[0],this.points[3],this.points[2]);if(n>0&&r<0||n<0&&r>0)return!1}const e=this.normal(0),t=this.normal(1);let i=e.x*t.x+e.y*t.y;return this._3d&&(i+=e.z*t.z),ha(my(i))<gy/3}reduce(){let e,t=0,i=0,n=.01,r,o=[],l=[],c=this.extrema().values;for(c.indexOf(0)===-1&&(c=[0].concat(c)),c.indexOf(1)===-1&&c.push(1),t=c[0],e=1;e<c.length;e++)i=c[e],r=this.split(t,i),r._t1=t,r._t2=i,o.push(r),t=i;return o.forEach(function(d){for(t=0,i=0;i<=1;)for(i=t+n;i<=1+n;i+=n)if(r=d.split(t,i),!r.simple()){if(i-=n,ha(t-i)<n)return[];r=d.split(t,i),r._t1=Me.map(t,0,1,d._t1,d._t2),r._t2=Me.map(i,0,1,d._t1,d._t2),l.push(r),t=i;break}t<1&&(r=d.split(t,1),r._t1=Me.map(t,0,1,d._t1,d._t2),r._t2=d._t2,l.push(r))}),l}translate(e,t,i){i=typeof i=="number"?i:t;const n=this.order;let r=this.points.map((o,l)=>(1-l/n)*t+l/n*i);return new Kt(this.points.map((o,l)=>({x:o.x+e.x*r[l],y:o.y+e.y*r[l]})))}scale(e){const t=this.order;let i=!1;if(typeof e=="function"&&(i=e),i&&t===2)return this.raise().scale(i);const n=this.clockwise,r=this.points;if(this._linear)return this.translate(this.normal(0),i?i(0):e,i?i(1):e);const o=i?i(0):e,l=i?i(1):e,c=[this.offset(0,10),this.offset(1,10)],d=[],u=Me.lli4(c[0],c[0].c,c[1],c[1].c);if(!u)throw new Error("cannot scale this curve. Try reducing it first.");return[0,1].forEach(function(h){const f=d[h*t]=Me.copy(r[h*t]);f.x+=(h?l:o)*c[h].n.x,f.y+=(h?l:o)*c[h].n.y}),i?([0,1].forEach(function(h){if(!(t===2&&h)){var f=r[h+1],p={x:f.x-u.x,y:f.y-u.y},m=i?i((h+1)/t):e;i&&!n&&(m=-m);var b=da(p.x*p.x+p.y*p.y);p.x/=b,p.y/=b,d[h+1]={x:f.x+m*p.x,y:f.y+m*p.y}}}),new Kt(d)):([0,1].forEach(h=>{if(t===2&&h)return;const f=d[h*t],p=this.derivative(h),m={x:f.x+p.x,y:f.y+p.y};d[h+1]=Me.lli4(f,m,u,r[h+1])}),new Kt(d))}outline(e,t,i,n){if(t=t===void 0?e:t,this._linear){const C=this.normal(0),N=this.points[0],O=this.points[this.points.length-1];let q,j,K;i===void 0&&(i=e,n=t),q={x:N.x+C.x*e,y:N.y+C.y*e},K={x:O.x+C.x*i,y:O.y+C.y*i},j={x:(q.x+K.x)/2,y:(q.y+K.y)/2};const de=[q,j,K];q={x:N.x-C.x*t,y:N.y-C.y*t},K={x:O.x-C.x*n,y:O.y-C.y*n},j={x:(q.x+K.x)/2,y:(q.y+K.y)/2};const xe=[K,j,q],Ve=Me.makeline(xe[2],de[0]),qe=Me.makeline(de[2],xe[0]),k=[Ve,new Kt(de),qe,new Kt(xe)];return new ca(k)}const r=this.reduce(),o=r.length,l=[];let c=[],d,u=0,h=this.length();const f=typeof i!="undefined"&&typeof n!="undefined";function p(C,N,O,q,j){return function(K){const de=q/O,xe=(q+j)/O,Ve=N-C;return Me.map(K,0,1,C+de*Ve,C+xe*Ve)}}r.forEach(function(C){const N=C.length();f?(l.push(C.scale(p(e,i,h,u,N))),c.push(C.scale(p(-t,-n,h,u,N)))):(l.push(C.scale(e)),c.push(C.scale(-t))),u+=N}),c=c.map(function(C){return d=C.points,d[3]?C.points=[d[3],d[2],d[1],d[0]]:C.points=[d[2],d[1],d[0]],C}).reverse();const m=l[0].points[0],b=l[o-1].points[l[o-1].points.length-1],_=c[o-1].points[c[o-1].points.length-1],y=c[0].points[0],A=Me.makeline(_,m),T=Me.makeline(b,y),M=[A].concat(l).concat([T]).concat(c);return new ca(M)}outlineshapes(e,t,i){t=t||e;const n=this.outline(e,t).curves,r=[];for(let o=1,l=n.length;o<l/2;o++){const c=Me.makeshape(n[o],n[l-o],i);c.startcap.virtual=o>1,c.endcap.virtual=o<l/2-1,r.push(c)}return r}intersects(e,t){return e?e.p1&&e.p2?this.lineIntersects(e):(e instanceof Kt&&(e=e.reduce()),this.curveintersects(this.reduce(),e,t)):this.selfintersects(t)}lineIntersects(e){const t=pp(e.p1.x,e.p2.x),i=pp(e.p1.y,e.p2.y),n=mp(e.p1.x,e.p2.x),r=mp(e.p1.y,e.p2.y);return Me.roots(this.points,e).filter(o=>{var l=this.get(o);return Me.between(l.x,t,n)&&Me.between(l.y,i,r)})}selfintersects(e){const t=this.reduce(),i=t.length-2,n=[];for(let r=0,o,l,c;r<i;r++)l=t.slice(r,r+1),c=t.slice(r+2),o=this.curveintersects(l,c,e),n.push(...o);return n}curveintersects(e,t,i){const n=[];e.forEach(function(o){t.forEach(function(l){o.overlaps(l)&&n.push({left:o,right:l})})});let r=[];return n.forEach(function(o){const l=Me.pairiteration(o.left,o.right,i);l.length>0&&(r=r.concat(l))}),r}arcs(e){return e=e||.5,this._iterate(e,[])}_error(e,t,i,n){const r=(n-i)/4,o=this.get(i+r),l=this.get(n-r),c=Me.dist(e,t),d=Me.dist(e,o),u=Me.dist(e,l);return ha(d-c)+ha(u-c)}_iterate(e,t){let i=0,n=1,r;do{r=0,n=1;let o=this.get(i),l,c,d,u,h=!1,f=!1,p,m=n,b=1;do if(f=h,u=d,m=(i+n)/2,l=this.get(m),c=this.get(n),d=Me.getccenter(o,l,c),d.interval={start:i,end:n},h=this._error(d,o,i,n)<=e,p=f&&!h,p||(b=n),h){if(n>=1){if(d.interval.end=b=1,u=d,n>1){let y={x:d.x+d.r*fy(d.e),y:d.y+d.r*py(d.e)};d.e+=Me.angle({x:d.x,y:d.y},y,this.get(1))}break}n=n+(n-i)/2}else n=m;while(!p&&r++<100);if(r>=100)break;u=u||d,t.push(u),i=b}while(n<1);return t}}const _y=2,vy=6,ua=Math.PI/3,by=1,yy=2*D.CAMERA_DEFAULT_MOVE_MAX_SPEED,Ul=2,gp=3,Kh=5,Zh=5,_p=.25,vp=.35,Wn=s=>-(Math.cos(Math.PI*s)-1)/2,xy=s=>Math.sqrt(1-Math.pow(s-1,2)),Ay=s=>Math.pow(s,5),Ey=s=>1-Math.pow(1-s,5);class $h{constructor(e){a(this,"distance");a(this,"velocity");a(this,"time");this.distance=e,this.velocity=0,this.time=0}setVelocityFromCornerAngle(e){this.velocity=Bi(Math.max(ua,e),ua,Math.PI,by,yy)}}class bp{constructor(e,t,i){a(this,"_startKnot");a(this,"_endKnot");a(this,"_acceleration");this._startKnot=e,this._endKnot=t,this._acceleration=i}endTime(){return this._endKnot.time}getDistance(e){const t=e-this._startKnot.time,i=this._startKnot.velocity*t,n=.5*this._acceleration*Math.pow(t,2),r=i+n;return this._startKnot.distance+r}isTimeWithinEquation(e){return e>=this._startKnot.time&&e<=this._endKnot.time}}class wy{constructor(e,t,i,n,r,o){a(this,"_startKnot");a(this,"_endKnot");a(this,"_maxVelocity");a(this,"_accelerationTime");a(this,"_accelerationDistance");a(this,"_acceleration");this._startKnot=e,this._endKnot=t,this._maxVelocity=i,this._accelerationTime=n,this._accelerationDistance=r,this._acceleration=o}endTime(){return this._endKnot.time}getDistance(e){const t=e-this._startKnot.time;if(t<this._accelerationTime){const i=this._startKnot.velocity*t,n=.5*this._acceleration*Math.pow(t,2),r=i+n;return this._startKnot.distance+r}else{const i=this._maxVelocity*(t-this._accelerationTime),n=.5*this._acceleration*Math.pow(t-this._accelerationTime,2),r=i-n;return this._startKnot.distance+this._accelerationDistance+r}}isTimeWithinEquation(e){return e>=this._startKnot.time&&e<=this._endKnot.time}}class Jh{constructor(e,t,i){a(this,"_endDistance");a(this,"_startDistance");a(this,"_bezier");this._startDistance=e,this._endDistance=t,this._bezier=i}getEndDistance(){return this._endDistance}getPoint(e){const t=Bi(e,this._startDistance,this._endDistance,0,1);return this._bezier.get(t)}getRotation(e){const t=Bi(e,this._startDistance,this._endDistance,0,1),i=this._bezier.normal(t);return Math.atan2(i.y,i.x)-Math.PI}isDistanceWithinCurve(e){return e>=this._startDistance&&e<=this._endDistance}}const Sy=(s,e,t)=>{const i=s.velocity,n=e.velocity,r=e.distance-s.distance,o=Math.sqrt(.5*Math.pow(i,2)+.5*Math.pow(n,2)+r*t);if(o>i&&o>n){const l=.5*(Math.pow(o,2)-Math.pow(i,2))/t,c=.5*(Math.pow(o,2)-Math.pow(n,2))/t;console.assert(Math.abs(r-l-c)<.001);const d=(o-i)/t,u=(o-n)/t;return e.time=s.time+d+u,new wy(s,e,o,d,l,t)}else if(o<=n){const l=Math.sqrt(Math.pow(i,2)+2*r*t),c=.5*(Math.pow(l,2)-Math.pow(i,2))/t;return console.assert(Math.abs(r-c)<.001),e.time=s.time+(l-i)/t,e.velocity=l,new bp(s,e,t)}else{const l=2*r/(i+n),c=i*l+.5*(n-i)*l;console.assert(Math.abs(r-c)<.001);const d=(n-i)/l;return e.time=s.time+l,new bp(s,e,d)}},Ty=function(){const s=new Ue,e=new Ue;return function(t,i,n){return s.subVectors(i,t),e.subVectors(n,i),Math.asin(Ue.crossVectors(s,e)/(s.length()*e.length()))}}();function My(s){return Bi(Math.max(ua,s),ua,Math.PI,_y,vy)}const ed=s=>new Ue(s.x,s.y),yp=(s,e)=>new Kt([s,s.clone().lerp(e,1/3),s.clone().lerp(e,2/3),e]),Py=(s,e,t,i)=>{const n=e.distanceTo(s),r=e.distanceTo(t),o=Math.min(r,n),l=o/n,c=o/r,d=i/o<.5?i/o:.5,u=e.clone().lerp(s,d*l),h=e.clone().lerp(s,d/3*l),f=e.clone().lerp(t,d/3*c),p=e.clone().lerp(t,d*c);return new Kt([u,h,f,p])},Cy=(s,e)=>{const t=Vt(e.x-s.x),i=Vt(e.y-s.y),n=Math.max(Math.abs(t),Math.abs(i)),r=xy(n/Math.PI);return Bi(r,0,1,0,Ul)};class xp{constructor(e,t,i,n,r){a(this,"_camera");a(this,"_controls");a(this,"_start");a(this,"_destination");a(this,"_transition");a(this,"_time");a(this,"_totalTime");a(this,"_totalDistance");a(this,"_timeMultiplier");a(this,"_currentPlanarCurve");a(this,"_currentPlanarDistanceEquation");a(this,"_getPlanarPosition");a(this,"_getHeight");a(this,"_getYaw");a(this,"_getPitch");a(this,"_getFov");a(this,"_modifyProjectionMatrix");a(this,"_planarCurves");a(this,"_planarDistanceEquations");a(this,"_isPositivePlanarDistance");if(this._camera=e,this._controls=t,this._start=i,this._destination=n,this._transition=r,this._time=0,this._totalTime=Cy(this._start.rotation,this._destination.rotation),this._totalDistance=0,this._timeMultiplier=1,this._currentPlanarCurve=void 0,this._currentPlanarDistanceEquation=void 0,this._getPlanarPosition=void 0,this._getHeight=void 0,this._getYaw=void 0,this._getPitch=void 0,this._getFov=void 0,this._modifyProjectionMatrix=void 0,this._planarCurves=[],this._planarDistanceEquations=[],this._isPositivePlanarDistance=this._nonZeroPlanarDistanceToDestination(),this._isPositivePlanarDistance&&this._initPlanarMovement(),this._transition.usePath&&this._isPositivePlanarDistance?(this._initPathRotation(),this._initPathHeight()):(this._initLinearRotation(),this._destination.height!==void 0&&(!this._isPositivePlanarDistance&&this._nonZeroHeightDistanceToDestination()&&this._adjustTimeForHeightOnlyMovement(),this._initLinearHeight())),this._destination.fov!==void 0&&(this._getFov=function(l){const c=Wn(l/this._totalTime);return Bi(c,0,1,this._start.fov,this._destination.fov)}),this._start.projectionMatrix!==void 0&&this._destination.projectionMatrix!==void 0&&this._doMatricesDiffer(this._start.projectionMatrix,this._destination.projectionMatrix)){const c=(()=>this._camera.isOrthographic()&&!this._destination.orthographic?Ay:!this._camera.isOrthographic()&&this._destination.orthographic?Ey:d=>d)();this._modifyProjectionMatrix=function(d){const u=c(d/this._totalTime);for(let h=0;h<16;h++)this._camera.current.projectionMatrix.elements[h]=Bi(u,0,1,this._start.projectionMatrix.elements[h],this._destination.projectionMatrix.elements[h])},this._totalTime<Ul&&this._adjustTimeForProjectionChange()}}get _startHeight(){return this._start.height||this._controls.cameraWorldPosition().z}get _destinationHeight(){return this._destination.height||this._controls.cameraWorldPosition().z}_clampTotalTime(e){return Math.max(Ul,Math.min(e,this._transition.maxTime))}_calculateTimeMultiplier(){const e=this._planarDistanceEquations.at(-1);return e!==void 0?e.endTime()/this._totalTime:1}_calculateTimeForHeightOnlyDistance(e){const t=Math.sqrt(e/this._transition.acceleration);return this._clampTotalTime(t)}_adjustTimeForHeightOnlyMovement(){this._totalDistance=Math.abs(this._destinationHeight-this._startHeight),this._totalTime=this._calculateTimeForHeightOnlyDistance(this._totalDistance)}_getPlanarCurveByDistance(e){const t=this._planarCurves.find(i=>i.isDistanceWithinCurve(e));if(t===void 0)throw new Error("planarCurve is undefined");return t}_initPlanarMovement(){const e=[];for(let h=1;h<this._transition.points.length-1;h++){const f=this._transition.points[h-1],p=this._transition.points[h],m=this._transition.points[h+1],b=Ty(f,p,m),_=My(b),y=Py(f,p,m,_);e.push({bezier:y,angle:b})}const t=[];t.push(new $h(0));let i=this._transition.points[0],n=0;for(let h=0;h<e.length;h++){const f=e[h-1],p=e[h],m=e[h+1];f!==void 0&&(i=ed(f.bezier.points[3]));const b=ed(p.bezier.points[0]),_=yp(i,b);if(_.length()>0){const N=n,O=n+_.length(),q=new Jh(N,O,_);this._planarCurves.push(q),n+=_.length()}const y=p.bezier.length()/2,A=n,T=n+y*2,M=new Jh(A,T,p.bezier);this._planarCurves.push(M),n+=y;const C=Math.abs(p.angle);if(C>ua){const N=new $h(n);N.setVelocityFromCornerAngle(C),t.push(N)}n+=y,m===void 0&&(i=ed(p.bezier.points[3]))}const r=this._transition.points.at(-1),o=yp(i,r),l=n+o.length(),c=new Jh(n,l,o);this._planarCurves.push(c),n+=o.length(),t.push(new $h(n));for(let h=1;h<t.length;h++){const f=t[h-1],p=t[h],m=Sy(f,p,this._transition.acceleration);this._planarDistanceEquations.push(m)}this._getPlanarPosition=function(h){var f;return(f=this._currentPlanarCurve)==null?void 0:f.getPoint(h)},this._currentPlanarCurve=this._planarCurves[0],this._currentPlanarDistanceEquation=this._planarDistanceEquations[0],this._totalDistance=n;const d=this._planarDistanceEquations.at(-1),u=d!==void 0?d.endTime():0;this._totalTime=this._clampTotalTime(u),this._timeMultiplier=this._calculateTimeMultiplier()}_initPathRotation(){if(this._totalDistance>Kh){const e=Kh*_p,t=this._getPlanarCurveByDistance(e),i=Vt(t.getRotation(e)-this._start.rotation.x),n=this._totalDistance-Kh*(1-_p),r=this._getPlanarCurveByDistance(n),o=Vt(this._destination.rotation.x-r.getRotation(n));this._getYaw=function(l){if(l<e){const c=Wn(l/e);return this._start.rotation.x+c*i}else if(l>n){const c=l-n,d=this._totalDistance-n,u=1-Wn(c/d);return this._destination.rotation.x-u*o}else return this._currentPlanarCurve?this._currentPlanarCurve.getRotation(l):0}}else{const e=Vt(this._destination.rotation.x-this._start.rotation.x);this._getYaw=function(t){const i=Wn(t/this._totalDistance);return this._start.rotation.x+i*e}}if(this._totalDistance>Zh){const e=Zh*vp,t=Vt(0-this._start.rotation.y),i=this._totalDistance-Zh*(1-vp),n=Vt(this._destination.rotation.y);this._getPitch=function(r){if(r<e){const o=Wn(r/e);return this._start.rotation.y+o*t}else if(r>i){const o=r-i,l=this._totalDistance-i;return Wn(o/l)*n}else return 0}}else{const e=Vt(this._destination.rotation.y-this._start.rotation.y);this._getPitch=function(t){const i=Wn(t/this._totalDistance);return this._start.rotation.y+i*e}}}_initLinearRotation(){const e=Vt(this._destination.rotation.x-this._start.rotation.x);this._getYaw=function(i){return this._start.rotation.x+Wn(i/this._totalTime)*e};const t=Vt(this._destination.rotation.y-this._start.rotation.y);this._getPitch=function(i){return this._start.rotation.y+Wn(i/this._totalTime)*t}}_initPathHeight(){const e=this._totalDistance>gp?gp:this._totalDistance;this._getHeight=function(t){if(t<e){const i=Wn(t/e);return Bi(i,0,1,this._startHeight,this._destinationHeight)}else return this._destinationHeight}}_initLinearHeight(){this._getHeight=function(e){const t=Wn(e/this._totalTime);return Bi(t,0,1,this._startHeight,this._destinationHeight)}}_nonZeroPlanarDistanceToDestination(){const e=this._transition.points[0],t=this._transition.points.at(-1)||e;return e.distanceTo(t)>.001}_nonZeroHeightDistanceToDestination(){return Math.abs(this._destinationHeight-this._startHeight)>.001}_doMatricesDiffer(e,t){return e.elements.some((i,n)=>i!==t.elements[n])}_adjustTimeForProjectionChange(){this._totalTime=Ul}_getDistance(){const e=this._time*this._timeMultiplier,t=this._currentPlanarDistanceEquation;if(t===void 0)throw new Error("currentEquation is null");return e>t.endTime()&&(this._currentPlanarDistanceEquation=this._planarDistanceEquations.find(i=>i.isTimeWithinEquation(e))),t.getDistance(e)}_updateCurrentPlanarCurve(e){const t=this._currentPlanarCurve;if(t===void 0)throw new Error("currentPlanarCurve is undefined");e>t.getEndDistance()&&(this._currentPlanarCurve=this._getPlanarCurveByDistance(e))}update(e,t){if(this._time+=e,this._time>=this._totalTime)return!1;let i;if(this._transition.usePath&&this._isPositivePlanarDistance?(i=this._getDistance(),this._updateCurrentPlanarCurve(i)):i=this._time,this._getPlanarPosition){const n=this._getPlanarPosition(this._getDistance());if(n===void 0)throw new Error("planar is undefined");t.setX(n.x),t.setY(n.y)}if(this._getHeight){const n=this._getHeight(i);t.setZ(n)}return this._getFov&&(this._camera.fov=this._getFov(this._time),this._camera.updateProjectionMatrix()),this._modifyProjectionMatrix&&this._modifyProjectionMatrix(this._time),this._getYaw&&this._controls.setYawAngle(this._getYaw(i)),this._getPitch&&this._controls.setPitchAngle(this._getPitch(i)),this._controls.cameraPositionUpdated(),!0}}/*!
 * Copyright (C) 2014-present Shapespark
 */const td=1/180;class Ry{constructor(e){a(this,"_scene");a(this,"_activeSkyMesh");this._scene=e,this._activeSkyMesh=void 0}activateSky(e){if(this._activeSkyMesh){if(this._activeSkyMesh.name===e)return;this._scene.removeAuxiliaryObject(this._activeSkyMesh)}const t=this._scene.findSkyMesh(e),i=t.material.map;i&&!i.loaded?(this.activateSky(D.DEFAULT_SKY_NAME),this._activeSkyMesh=t,i.addLoadedListener(()=>{this._activeSkyMesh===t&&(this._scene.addAuxiliaryObject(t),t.updateMatrixWorld(!0))})):(this._scene.addAuxiliaryObject(t),t.updateMatrixWorld(!0),this._activeSkyMesh=t)}activeSkyName(){return this._activeSkyMesh.name}}class Ap{constructor(e,t,i){a(this,"position");a(this,"rotation");a(this,"fov");this.position=e||new B,this.rotation=t||new Ue,this.fov=i||0}}class Iy extends kt{constructor(t,i,n,r,o){super();a(this,"_scene");a(this,"_controls");a(this,"_animationController");a(this,"_skyControls");a(this,"_cameraPosition");a(this,"_camera");a(this,"_meshesToHide",{});a(this,"_meshesHiddenByTeleport",new Array);a(this,"_cameraPath");a(this,"_teleportMovement");a(this,"_destination",new Ap);a(this,"_destinationTarget",new B);a(this,"_destinationMinDistance");a(this,"_destinationMaxDistance");a(this,"_viewToEnable");a(this,"_vrEnabled",!1);a(this,"teleportingToView",!1);a(this,"teleportingToPoint",!1);a(this,"_instant",!1);a(this,"_useCameraHeightInViews",!1);a(this,"_lastVisibleDestinationView");a(this,"lastDestinationView");a(this,"_teleportStartedEvent",{type:"teleportStarted",target:this,view:void 0});a(this,"_teleportDoneEvent",{type:"teleportDone",target:this,view:void 0});a(this,"collider");a(this,"_initMeshesToHide",()=>{this._meshesToHide=[];for(const t of this._scene.views)this._meshesToHide[t.id]=[];for(const t of this._scene.gpuMeshes){const i=t.hideInViews;if(i)for(const n of i)this._meshesToHide[n]?this._meshesToHide[n].push(t):console.warn("Invalid view id in hideInViews list: '"+n+"'")}});a(this,"_skyMeshAdded",t=>{this._skyControls.activateSky(t.skyMesh.name),this._animationController.requestFrame()});a(this,"_skyMeshRemoved",t=>{this._skyControls.activeSkyName()===t.skyMesh.name&&(this._skyControls.activateSky(D.DEFAULT_SKY_NAME),this._animationController.requestFrame())});this._scene=t,this._controls=i,this.collider=n,this._animationController=r,this._skyControls=new Ry(t),this._cameraPosition=i.cameraWorldPosition(),this._camera=t.camera,this._cameraPath=new cy(t,o),this._initMeshesToHide(),this._scene.addEventListener(wi.viewAddedEventType,this._initMeshesToHide),this._scene.addEventListener(wi.viewRemovedEventType,this._initMeshesToHide),this._scene.addEventListener(wi.skyMeshAddedEventType,this._skyMeshAdded),this._scene.addEventListener(wi.skyMeshRemovedEventType,this._skyMeshRemoved)}_cameraVector(){const t=new Ap(this._controls.cameraWorldPosition());return t.rotation.set(Vt(this._controls.getYawAngle()),Vt(this._controls.getPitchAngle())),t.fov=this._camera.fov,t}teleporting(){return this.teleportingToView||this.teleportingToPoint}_getMeshesToHide(t){return this._meshesToHide[t]||[]}_hideMeshes(t){for(const i of t)i.visible=!1,this._meshesHiddenByTeleport.push(i)}_showMeshesHiddenByTeleport(){this._meshesHiddenByTeleport.forEach(t=>t.visible=!0),this._meshesHiddenByTeleport.length=0}_hideOnlyMeshes(t){this._showMeshesHiddenByTeleport(),this._hideMeshes(t)}_placeCameraAtDestination(){this._camera.fov=this._destination.fov,this._cameraPosition.copyFrom(this._destination.position),this._controls.setYawAngle(this._destination.rotation.x),this._controls.setPitchAngle(this._destination.rotation.y),this._controls.cameraPositionUpdated(),this._teleportMovement=void 0}_adjustHeightIfNeeded(t){if(this._useCameraHeightInViews||D.CAMERA_FIXED_HEIGHT!==null||this._camera.autoClimb&&this._camera.fixedHeight!==null){this._viewToEnable;const i=this._meshesHiddenByTeleport.slice();this._hideOnlyMeshes(this._getMeshesToHide(this._viewToEnable.id)),this.collider.adjustPointToMatchCameraHeight(t),this._hideOnlyMeshes(i)}}_planarPointsLinear(){return[new Ue(this._cameraVector().position.x,this._cameraVector().position.y),new Ue(this._destination.position.x,this._destination.position.y)]}_shouldUsePathTransition(t){const i=t.mode!=="orbit",n=this.lastDestinationView?this.lastDestinationView.mode!=="orbit":!0;return this._camera.autoPath&&i&&n}_onReachedToView(){if(this._viewToEnable.mode==="orbit"&&!this._vrEnabled)this._controls.orbit.setPanPrimary(this._viewToEnable.panPrimary||!1),this._controls.orbit.noRotate=this._viewToEnable.noRotate||!1,this._controls.orbit.noPitchRotate=this._viewToEnable.noPitchRotate||!1,this._controls.orbit.getNoPan=()=>this._viewToEnable.noPan,this._controls.orbit.getMinPitchAngle=()=>-this._viewToEnable.maxUpAngle,this._controls.orbit.getMaxPitchAngle=()=>-this._viewToEnable.minUpAngle,this._controls.orbit.getMinYawAngle=()=>this._viewToEnable.minSideAngle,this._controls.orbit.getMaxYawAngle=()=>this._viewToEnable.maxSideAngle,this._controls.orbit.getMinDistance=()=>this._viewToEnable.minDistance,this._controls.orbit.getMaxDistance=()=>this._viewToEnable.maxDistance,this._controls.orbit.target.copyFrom(this._destinationTarget),this._controls.setControlMode(th.ORBIT);else{const t=this._controls.camera();t.near=D.CAMERA_WALK_NEAR,this._controls.setControlMode(th.WALK)}this._viewToEnable.orthographic?(this._camera.orthoFrustumSize=this._viewToEnable.orthoFrustumSize,this._camera.setOrthographic()):this._camera.setPerspective(),this._skyControls.activateSky(this._viewToEnable.sky),this._hideOnlyMeshes(this._getMeshesToHide(this._viewToEnable.id))}update(t){if(!this.teleporting())return;t=Math.min(t,.067),t=Math.max(t,td);let i=!0;this._teleportMovement!==void 0&&(this.teleportingToPoint&&(this._destination.position.z=this._cameraPosition.z),this._teleportMovement.update(t,this._cameraPosition)?i=!1:this._placeCameraAtDestination()),i&&(this.teleportingToView&&this._onReachedToView(),this.teleportingToView=this.teleportingToPoint=!1,this._teleportDoneEvent.view=this._viewToEnable,this.dispatchEvent(this._teleportDoneEvent)),this._animationController.requestFrame()}cancelSwitchToPoint(){console.assert(this.teleportingToPoint),this.teleportingToPoint=!1,this._teleportDoneEvent.view=void 0,this.dispatchEvent(this._teleportDoneEvent)}_pointEqualsCameraPositionXY(t){return t.x===this._cameraPosition.x&&t.y===this._cameraPosition.y}_rotationEqualsCameraRotation(t){return Vt(t.yaw)===this._cameraVector().rotation.x&&Vt(t.pitch)===this._cameraVector().rotation.y}switchToPoint(t,i){if(!(this._pointEqualsCameraPositionXY(t)&&(i===void 0||this._rotationEqualsCameraRotation(i)))){if(this._viewToEnable=void 0,this.teleportingToPoint=!0,this.teleportingToView=!1,this._teleportStartedEvent.view=void 0,this.dispatchEvent(this._teleportStartedEvent),this._instant?this._destination.position.set(t.x,t.y,t.z):this._destination.position.set(t.x,t.y,this._cameraPosition.z),i)this._destination.rotation.set(Vt(i.yaw),Vt(i.pitch));else{const n=ou(this._cameraPosition,t),r=Vt(n);this._destination.rotation.set(r,0)}if(this._destination.fov=this._camera.defaultFov,this._instant)this._placeCameraAtDestination(),this.update(td);else{const n={fov:this._camera.fov,height:this._cameraVector().position.z,rotation:this._cameraVector().rotation},r={fov:this._destination.fov,rotation:this._destination.rotation},o={acceleration:D.TELEPORT_TO_POINT_ACCELERATION,maxTime:D.TELEPORT_TO_POINT_MAX_TIME,points:this._planarPointsLinear(),usePath:!1};this._teleportMovement=new xp(this._camera,this._controls,n,r,o),this._animationController.requestFrame()}}}switchToView(t,i){const n=this._shouldUsePathTransition(t);t.hideFromMenu||(this._lastVisibleDestinationView=t),this.lastDestinationView=this._viewToEnable=t,this.teleportingToView=!0,this.teleportingToPoint=!1,this._teleportStartedEvent.view=this._viewToEnable,this.dispatchEvent(this._teleportStartedEvent),this._controls.disable(),this._controls.resetRollAngle(),this._hideMeshes(this._getMeshesToHide(this._viewToEnable.id));const r=this._camera.current.projectionMatrix.clone(),o=this._camera.createProjectionMatrix(this._viewToEnable.orthographic,this._viewToEnable.orthoFrustumSize);if(this._viewToEnable.rotation!==void 0?this._destination.rotation.set(this._viewToEnable.rotation.yaw,this._viewToEnable.rotation.pitch):this._destination.rotation.set(0,0),this._destination.fov=this._viewToEnable.fov||this._camera.defaultFov,this._viewToEnable.mode==="orbit"){this._viewToEnable.target!==void 0?this._destinationTarget.set(this._viewToEnable.target.x,this._viewToEnable.target.y,this._viewToEnable.target.z):this._destinationTarget.set(0,0,0),this._destinationMinDistance=this._viewToEnable.minDistance,this._destinationMaxDistance=this._viewToEnable.maxDistance;const l=Pi(this._viewToEnable.distance||10,this._destinationMinDistance,this._destinationMaxDistance);oo.computeCameraPosition(this._destination.position,this._destinationTarget,this._destination.rotation.x,this._destination.rotation.y,l),this._camera.near=oo.computeCameraNear(l),this._camera.updateProjectionMatrix()}else this._viewToEnable.position!==void 0?(this._destination.position.set(this._viewToEnable.position.x,this._viewToEnable.position.y,this._viewToEnable.position.z),this._adjustHeightIfNeeded(this._destination.position)):this._destination.position.set(0,0,0);if(i===void 0&&D.TELEPORT_TO_VIEW_MAX_TIME===0||i===0||this._instant)this._placeCameraAtDestination(),this.update(td);else{this._viewToEnable.sky!==this._skyControls.activeSkyName()&&this._skyControls.activateSky(D.DEFAULT_SKY_NAME);const l=n?this._cameraPath.findPath(this._cameraVector(),this._destination):[],c=l.length>0,d=n&&c,u=d?l:this._planarPointsLinear(),h=d?D.TELEPORT_PATH_ACCELERATION:D.TELEPORT_TO_VIEW_ACCELERATION;if(i===void 0&&(i=d?D.TELEPORT_PATH_MAX_TIME:D.TELEPORT_TO_VIEW_MAX_TIME),this._viewToEnable.rotation===void 0){const b=u.at(-1),_=u.at(-2),y=ou(_,b),A=Vt(y);this._destination.rotation.set(A,0)}const f={fov:this._camera.fov,height:this._cameraVector().position.z,rotation:this._cameraVector().rotation,projectionMatrix:r},p={fov:this._destination.fov,height:this._destination.position.z,rotation:this._destination.rotation,projectionMatrix:o,orthographic:this._viewToEnable.orthographic},m={acceleration:h,maxTime:i,points:u,usePath:d};this._teleportMovement=new xp(this._camera,this._controls,f,p,m),this._animationController.requestFrame()}}_switchToAdjacentVisibleView(t,i){const n=this._scene.visibleViews();if(n.length===0)return;if(this._lastVisibleDestinationView===void 0){this.switchToView(n[0],i);return}const r=n.indexOf(this._lastVisibleDestinationView);r===-1&&this.switchToView(n[0],i);const o=(r+n.length+t)%n.length;this.switchToView(n[o],i)}switchToPreviousVisibleView(t){this._switchToAdjacentVisibleView(-1,t)}switchToNextVisibleView(t){this._switchToAdjacentVisibleView(1,t)}updateHiddenMeshes(t){this._initMeshesToHide(),t?this._hideOnlyMeshes(this._getMeshesToHide(t.id)):this._showMeshesHiddenByTeleport(),this._animationController.requestFrame()}activateSky(t){this._skyControls.activateSky(t.sky),this._animationController.requestFrame()}executeWithViewVisibilitySettings(t,i){const n=this._meshesHiddenByTeleport.slice();this._hideOnlyMeshes(this._getMeshesToHide(t.id)),this._skyControls.activateSky(t.sky),i(),this._skyControls.activateSky(this.lastDestinationView.sky),this._hideOnlyMeshes(n)}onVrChange(t){this._vrEnabled=t,this._instant=this._vrEnabled,this._useCameraHeightInViews=this._vrEnabled,this.lastDestinationView&&this.lastDestinationView.mode==="orbit"&&this.switchToView(this.lastDestinationView,0)}}/*!
 * Copyright (C) 2019-present Shapespark
 */class Dy{constructor(e,t){a(this,"_controls");a(this,"_collider");a(this,"_enabled",!1);a(this,"_prevCameraPositionZ");a(this,"_cameraPosition");a(this,"_receivedHmdPosition",!1);this._controls=e,this._collider=t,this._cameraPosition=e.cameraWorldPosition()}onHmdPositionUpdate(e){this._enabled&&!this._receivedHmdPosition&&e.z>1&&(this._controls.cameraHeight=e.z,this._collider.adjustPointToMatchCameraHeight(this._cameraPosition),this._controls.cameraPositionUpdated(),this._prevCameraPositionZ=this._cameraPosition.z,this._receivedHmdPosition=!0)}onTeleportDone(){this._enabled&&(this._prevCameraPositionZ=this._cameraPosition.z)}updateCameraHeight(){this._enabled&&(this._controls.cameraHeight!==null&&(this._controls.cameraHeight+=this._cameraPosition.z-this._prevCameraPositionZ),this._prevCameraPositionZ=this._cameraPosition.z)}enable(){this._enabled=!0,this._controls.cameraHeight=this._collider.cameraHeightFromPoint(this._cameraPosition),this._controls.cameraHeight===null&&(this._controls.cameraHeight=D.FALLBACK_CAMERA_HEIGHT),this._prevCameraPositionZ=this._cameraPosition.z,this._receivedHmdPosition=!1}disable(){this._enabled=!1,this._controls.cameraHeight=null}}const Ly=.3,Ep=1;class Fy{constructor(e,t){a(this,"camera");a(this,"autoExposureEnabled",!1);a(this,"cameraExposureDelta",0);a(this,"cameraExposureDeltaPerS",0);a(this,"cameraExposureDeltaSign",0);a(this,"currentTargetExposure",0);a(this,"lastId",0);a(this,"idToGammaAndExposure",{});a(this,"idToPriority",{});a(this,"idsInOrder");a(this,"lumaMeter");this.camera=e,this.camera.addEventListener(br.updatedEventType,()=>this._updateTargetExposureAndGamma()),this.lastId=0,this.idToGammaAndExposure={},this.idToPriority={},this.idsInOrder=[],this.lumaMeter=t}setPriority(e,t){this.idToPriority[e]=t}adaptExposure(){if(!this.autoExposureEnabled||!this.camera.autoExposure)return;const e=this.lumaMeter.measureReflectedLuma();if(e<0){this.cameraExposureDelta=0;return}const t=this.camera.autoExposureDarkness;this._setTargetExposure(Math.log2(t/e)),this.cameraExposureDelta<Ly&&(this.cameraExposureDelta=0)}exposureNeedsUpdate(){return this.cameraExposureDelta>0}addManualExposure(e,t,i){if(!(this.autoExposureEnabled&&this.camera.autoExposure))return i==null&&(i=this.lastId++),this.idToGammaAndExposure[i]={gamma:t,exposure:e},this.idsInOrder.push(i),this._updateTargetExposureAndGamma(),i}updateManualExposure(e,t,i){this.autoExposureEnabled&&this.camera.autoExposure||this.idToGammaAndExposure[i]&&(this.idToGammaAndExposure[i].gamma=t,this.idToGammaAndExposure[i].exposure=e,this._updateTargetExposureAndGamma(),this.updateWithoutDelay())}removeManualExposure(e){this.autoExposureEnabled&&this.camera.autoExposure||this.idToGammaAndExposure[e]&&(delete this.idToGammaAndExposure[e],this.idsInOrder.splice(this.idsInOrder.findIndex(t=>t===e),1),this._updateTargetExposureAndGamma())}update(e){if(!this.exposureNeedsUpdate())return;const t=Math.min(this.cameraExposureDeltaPerS*e,this.cameraExposureDelta);this.cameraExposureDelta-=t,this.cameraExposureDelta<1e-5?(this.cameraExposureDelta=0,this.camera.exposure=this.currentTargetExposure):this.camera.exposure+=t*this.cameraExposureDeltaSign}updateWithoutDelay(){this.update(Ep)}enableAutoExposure(){this.autoExposureEnabled=!0}disableAutoExposure(){this.autoExposureEnabled=!1}_setTargetExposure(e){this.currentTargetExposure=e,this.cameraExposureDelta=e-this.camera.exposure,this.cameraExposureDeltaSign=Math.sign(this.cameraExposureDelta),this.cameraExposureDelta=Math.abs(this.cameraExposureDelta),this.cameraExposureDeltaPerS=this.cameraExposureDelta/Ep}_setTargetExposureAndGamma(e,t){this._setTargetExposure(e),this.camera.setGamma(t)}_getActiveId(){let e=1/0,t=this.idsInOrder.at(0);for(const i of this.idsInOrder){const n=this.idToPriority[i]!==void 0?this.idToPriority[i]:1/0;n<e&&(t=i,e=n)}return t}_updateTargetExposureAndGamma(){if(this.idsInOrder.length===0){this._setTargetExposureAndGamma(this.camera.defaultExposure,this.camera.defaultGamma);return}const e=this._getActiveId();this._setTargetExposureAndGamma(this.idToGammaAndExposure[e].exposure,this.idToGammaAndExposure[e].gamma)}}class Oy{constructor(){a(this,"color",new Re)}}class wp extends ai{constructor(t,i){super({vsName:"standard_material_vertex.glsl",fsName:"luma_fragment.glsl",uniformBufferDataConstructor:Oy});a(this,"computeIncidentLuma");a(this,"color");this.lightmapSupported=!0,this.sharedMaterialState=i,this.computeIncidentLuma=t,this.color=new Re(Re.WHITE),this.setUniform("color","c",this.color,ve.MATERIAL)}refreshPerObjectUniforms(t){let i=ai.prototype.refreshPerObjectUniforms.call(this,t);const n=this.computeIncidentLuma?Re.WHITE:t.material.baseColor;return n.equals(this.color)||(this.color.copyFrom(n),i=!0),i}}const sr=256,By=16*16,Ny=.3,ky=.1;function Uy(s,e){let t=0,i=0;for(let l=0;l<sr*sr;++l){const c=l*4,d=s[c]+s[c+1]*255;d!==0&&(i+=1,e[d]+=1,t=Math.max(t,d))}if(i<By)return-1;let n=0,r=0;for(let l=1;l<=t&&e[l]+n<Ny*i;++l)n+=e[l],e[l]=0;for(let l=t;l>=0&&e[l]+r<ky*i;--l)r+=e[l],e[l]=0;let o=0;for(let l=1;l<=t;++l)o+=e[l]*Math.log(l/255),e[l]=0;return Math.exp(o/(i-n-r))}function zy(s,e){const t=e.camera;let i,n,r,o,l,c;function d(){console.assert(!i),i=s.createRenderTarget(sr,sr,{minFilter:ne.NEAREST,magFilter:ne.NEAREST,stencilBuffer:!1,generateMipmaps:!1}),n=new ws(s),r=new Uint8Array(4*sr*sr),o=new Uint32Array(255*256),l=new wp(!0,e.sharedMaterialState),c=new wp(!1,e.sharedMaterialState)}function u(h){i||d();const f=h?l:c;n.set(!0,!0,!1);const p=e.gpuMeshes.filter(m=>!m.material.transparent);return s.renderMeshes(p,f,t,i),s.readPixels(sr,sr,r),s.setRenderTarget(null),n.restore(),Uy(r,o)}this.measureIncidentLuma=function(){return u(!0)},this.measureReflectedLuma=function(){return u(!1)}}const zl={};function id(s,e,t){zl[s]={name:s,value:e,fontFamily:t}}function Xe(s,e){id(s,e,"FontAwesomeSolid")}function Cr(s,e){id(s,e,"FontAwesomeRegular")}function jn(s,e){id(s,e,"FontAwesomeBrands")}Xe("address-book",""),Xe("address-card",""),Xe("area-chart",""),Xe("arrows",""),Xe("arrow-up",""),Xe("arrow-down",""),Xe("assistive-listening-systems",""),Xe("asterisk",""),Xe("audio-description",""),Xe("at",""),Xe("bars",""),Xe("bell",""),Xe("book",""),Xe("bookmark",""),Xe("bullhorn",""),Xe("calculator",""),Xe("camera",""),Xe("chart-bar",""),Xe("chart-pie",""),Xe("chevron-up",""),Xe("chevron-down",""),Xe("cloud",""),Xe("cog",""),Xe("comment",""),Cr("compass",""),Cr("credit-card",""),Xe("crosshairs",""),Xe("desktop",""),Xe("download",""),Xe("envelope",""),Xe("expand",""),Xe("external-link",""),Cr("eye",""),Xe("eye-dropper",""),Xe("film",""),Xe("flag",""),Xe("folder",""),Xe("gift",""),Xe("headphones",""),Xe("highlighter",""),Xe("home",""),Cr("image",""),Xe("sign-in",""),Xe("info",""),Cr("lightbulb",""),Xe("magic",""),Xe("magnet",""),Xe("map-marker",""),Xe("map-pin",""),Xe("map-signs",""),Xe("paint-brush",""),Xe("pencil",""),Xe("pen",""),Xe("phone",""),Xe("question",""),Xe("search",""),Xe("share",""),Xe("share-alt",""),Xe("shopping-cart",""),Xe("sliders",""),Xe("star",""),Cr("sticky-note",""),Xe("sync",""),Cr("edit",""),Xe("tachometer",""),Xe("tag",""),Xe("video",""),Xe("wrench",""),Xe("palette",""),Xe("paint-roller",""),Xe("play",""),Xe("pause",""),Xe("plus",""),jn("youtube",""),jn("vimeo",""),jn("facebook",""),jn("twitter",""),jn("instagram",""),jn("linkedin",""),jn("skype",""),jn("whatsapp",""),jn("facebook-messenger",""),jn("telegram",""),jn("slack","");const Vy="anchor_vertex.glsl";class Gy extends si{constructor(){super({vsName:Vy,uniformBufferDataConstructor:so}),this._metallic=.1,this._roughness=.5,this._bumpScale=.01,this.hideFromLightProbes=!0,this.lightmapSupported=!1}}const nd="sprite_vertex.glsl";class Hy extends so{constructor(){super(...arguments);a(this,"offset",new B)}}class Sp extends si{constructor(){super({vsName:nd,uniformBufferDataConstructor:Hy}),this.vertexShaderName=nd,this._vertexShaderBody=nn.get(nd),this.hideFromLightProbes=!0,this.lightmapSupported=!1,this.setUniform("offset","v3",new B(0,0,0),ve.MATERIAL)}set offset(e){this.uniforms.offset.value=e,this.uniformBufferData.offset.copyFrom(e)}}const fa=512,Wy=Math.PI*(70/180),jy=Math.floor(fa*(.5-.5*Math.sin(Wy/2))),Tp=fa-2*jy,Mp=2048;var Pp=(s=>(s.SPHERE="sphere",s.SPRITE="sprite",s))(Pp||{});class Xy{constructor(e){a(this,"icon");a(this,"text");a(this,"imagePath");a(this,"font");a(this,"color");a(this,"opacity");a(this,"textColor");a(this,"type");a(this,"position");a(this,"radius");a(this,"height");a(this,"borderRadius");const t=new ln(e),i=t.parseString("icon"),n=i?zl[i]:void 0;this.text=n?n.value:t.parseString("text",""),this.imagePath=t.parseString("image"),this.font=n?n.fontFamily:"Open Sans",this.color=t.parseString("color","#4c9ed9"),this.opacity=t.parseNumber("opacity",1),this.textColor=t.parseString("textColor","#ffffff"),this.type=t.parseEnum("type",Pp,"sprite"),this.position=t.parseNumbers("position"),this.radius=t.parseNumber("radius",.1),this.height=t.parseNumber("height",.2),this.borderRadius=t.parseNumber("borderRadius",0)}colorWithOpacity(){return Qr.combineColorWithOpacity(this.color,this.opacity)}hasAlpha(){return this.opacity<1}}class qy{constructor(e){a(this,"usedTimes",1);a(this,"texture");this.texture=e}}class sd{constructor(){a(this,"sphereGeometry");a(this,"planeGeometry");a(this,"planeColliderGeometry");a(this,"texturesCache",new Map);a(this,"_debugColliderMaterial");this.sphereGeometry=dt.createSphere(1,32,16),this.sphereGeometry.convertNormalsToSpherical(),this.planeGeometry=dt.createPlane(1,1),this.planeGeometry.convertNormalsToSpherical();const e=new je;e.makeRotationX(Math.PI/2),this.planeColliderGeometry=dt.createCylinder(.5,.5,1,16,1),this.planeColliderGeometry.applyMatrix(e),this.planeColliderGeometry.convertNormalsToSpherical()}debugColliderMaterial(){return this._debugColliderMaterial||(this._debugColliderMaterial=new si,this._debugColliderMaterial.opacity=.7,this._debugColliderMaterial.baseColor.setRGB(1,0,0),this._debugColliderMaterial.setUniforms()),this._debugColliderMaterial}static getInstance(e){let t=e.get("anchor_render_cache");return t||(t=new sd,e.set("anchor_render_cache",t)),t}}function Yy(s,e,t,i,n,r){const o=r*.5*Math.min(i,n);s.beginPath(),s.moveTo(e+o,t),s.lineTo(e+i-o,t),s.quadraticCurveTo(e+i,t,e+i,t+o),s.lineTo(e+i,t+n-o),s.quadraticCurveTo(e+i,t+n,e+i-o,t+n),s.lineTo(e+o,t+n),s.quadraticCurveTo(e,t+n,e,t+n-o),s.lineTo(e,t+o),s.quadraticCurveTo(e,t,e+o,t),s.closePath(),s.fill()}function Vl(s,e){return`400 ${s}px ${e}`}function Qy(s,e,t){s.font=Vl(128,t);const n=s.measureText(e).width;let r=Math.floor(128*(Tp/n));r=Math.min(r,Tp),s.font=Vl(r,t)}function Ky(s,e,t){s.width=fa,s.height=fa;const i=s.getContext("2d");return Qy(i,e,t),i}function Zy(s,e,t,i){const n=D.SPRITE_ANCHOR_FONT_SIZE;let r=s.getContext("2d");r.font=Vl(n,t);let o=e,l=e.length-1,c,d;for(;c=r.measureText(o).width,d=c+2*i,!(d<=Mp);)o=e.substring(0,l)+"...",--l;const u=1.5*n;return s.width=d,s.height=u,r=s.getContext("2d"),r.font=Vl(n,t),[r,o]}function Cp(s,e,t){const i=s.getContext("2d");i.fillStyle=e,t?Yy(i,0,0,s.width,s.height,t):i.fillRect(0,0,s.width,s.height)}function $y(s,e,t,i,n){const r=document.createElement("canvas");return r.width=e,r.height=t,Cp(r,i,n),r.getContext("2d").drawImage(s,0,0,e,t),r}function Jy(s,e){const t=new wt;t.hasAlpha=s.hasAlpha();const i=r=>{const o=s.type=="sphere"?fa:Mp;let l=r.naturalWidth,c=r.naturalHeight;return l>=c&&l>o?(c=c/l*o,l=o):c>l&&c>o&&(l=l/c*o,c=o),[Math.round(l),Math.round(c)]},n=r=>{[t.width,t.height]=i(r),t.image=$y(r,t.width,t.height,s.colorWithOpacity(),s.borderRadius),t.needsUpdate=!0,t.notifyLoaded()};return mu(D.LOAD_PRIORITY.CORE_RESOURCE,e,r=>n(r),()=>console.log(`Failed to load trigger image: ${e}`)),t}function ex(s,e){const t=document.createElement("canvas");let i,n=s.text;s.type=="sphere"?i=Ky(t,n,s.font):[i,n]=Zy(t,n,s.font,e),Cp(t,s.colorWithOpacity(),s.borderRadius),i.fillStyle=s.textColor,i.textAlign="center",i.textBaseline="middle",i.shadowColor="black",i.shadowBlur=16,i.fillText(n,t.width/2,t.height/2);const r=new wt(t);return r.width=t.width,r.height=t.height,r.anisotropy=wt.NO_ANISOTROPY,r.hasAlpha=s.hasAlpha(),r.minFilter=ne.LINEAR,r.loadingStatus=Ys.COMPLETED,r.needsUpdate=!0,r}function tx(s,e){var o,l;const i=[(o=e.icon)!=null?o:"",e.text,(l=e.imagePath)!=null?l:"",e.font,e.colorWithOpacity(),e.textColor,e.type=="sphere",20,e.borderRadius,e.hasAlpha()].join("_"),n=s.get(i);if(n)return n.usedTimes++,[e.color,e.textColor,i,n.texture];let r;return e.imagePath?r=Jy(e,Bo(e.imagePath)):r=ex(e,20),s.set(i,new qy(r)),[e.color,e.textColor,i,r]}class Rr extends Je{constructor(t,i,n){const r=new Xy(n),o=sd.getInstance(i),l=new B;l.fromArray(r.position);const[c,d,u,h]=tx(o.texturesCache,r),f=new Re;f.setStyle(c),f.convertGammaToLinear();const p=new Re;p.setStyle(d),p.convertGammaToLinear();let m,b,_,y,A;r.type==="sphere"?(m=o.sphereGeometry,y=new Gy,_=t.closestLightProbe(l),r.imagePath||(y.bumpTexture=h),y.disableLightProbe=_===null||!_.texturesReady(),y.headLight=!0):(r.type=="sprite",m=o.planeGeometry,y=new Sp,_=null,y.headLight=!1,y.reflective=!1,A=new Je(o.planeColliderGeometry,y)),y.baseColor=f,y.baseColorTexture=h,y.configureTransparency(),y.setUniforms();super(m,y);a(this,"color");a(this,"textColor");a(this,"colliderMesh");a(this,"_texturesCache");a(this,"_textureSignature");this._texturesCache=o.texturesCache,this._textureSignature=u,this.color=f,this.textColor=p,this.visible=!1,this.position.copyFrom(l),this.lightProbes=[_],A?(A.position.copyFrom(l),this.colliderMesh=A,this.colliderMesh.visible=!1):this.colliderMesh=this,this.colliderMesh.visibilityId=null,this.colliderMesh.anchor=this,h.addLoadedListener(()=>{if(r.type==="sphere"?b=[r.radius,r.radius,r.radius]:(y.baseColorTexture instanceof wt,b=[y.baseColorTexture.width/y.baseColorTexture.height*r.height,r.height,1]),this.scale.fromArray(b),this.updateMatrixWorld(!0),A){const T=Math.max(b[0],b[1]),M=r.height;A.scale.fromArray([T,T,M]),A.updateMatrixWorld(!0),A.visible=!0}this.visible=!0,Li().requestFrame()})}dispose(){const t=this.material;t.dispose();const i=this._textureSignature,n=this._texturesCache.get(i),r=n.texture;t.baseColorTexture,setTimeout(()=>{n.usedTimes--,n.usedTimes===0&&(r.dispose(),this._texturesCache.delete(i))},5e3)}enableLightProbe(){if(this.lightProbes.length>0&&this.lightProbes[0]){tt(this.lightProbes[0].texturesReady());const t=this.material;t.disableLightProbe=!1,t.setUniforms()}}}var In=(s=>(s.TWO_STATE="twoState",s.MULTI_STATE="multiState",s.IMPULSE="impulse",s))(In||{});const ix={"":"address-book","":"address-card","":"area-chart","":"arrows","":"arrow-up","":"arrow-down","":"assistive-listening-systems","":"asterisk","":"audio-description","":"at","":"bars","":"bell","":"book","":"bookmark","":"bullhorn","":"calculator","":"camera","":"chart-bar","":"chart-pie","":"cloud","":"cog","":"comment","":"compass","":"credit-card","":"crosshairs","":"download","":"envelope","":"external-link","":"eye","":"eye-dropper","":"film","":"flag","":"folder","":"gift","":"headphones","":"home","":"image","":"sign-in","":"info","":"lightbulb","":"magic","":"magnet","":"map-marker","":"map-pin","":"map-signs","":"paint-brush","":"pencil","":"phone","":"question","":"share","":"share-alt","":"shopping-cart","":"sliders","":"star","":"tachometer","":"tag","":"video","":"wrench","":"play","":"youtube","":"vimeo","":"facebook","":"twitter","":"instagram"};class nx{constructor(){a(this,"_callbacks");this._callbacks=[]}size(){return this._callbacks.length}addCallback(e){this._callbacks.push(e)}removeCallback(e){this._callbacks=this._callbacks.filter(t=>t!==e)}onNodeTypeClicked(e,t,i){return this._callbacks.forEach(n=>{try{n(e,t,i)}catch(r){console.error(r)}}),!0}}class sx{constructor(){a(this,"_nodeTypeToListenerMulti");a(this,"_listeners");this._nodeTypeToListenerMulti=new Map,this._listeners=new Map}_getMultiListener(e){let t=this._nodeTypeToListenerMulti.get(e);return t===void 0&&(t=new nx,this._nodeTypeToListenerMulti.set(e,t),this._listeners.set(e,t.onNodeTypeClicked.bind(t))),t}onNodeTypeClicked(e,t){this._getMultiListener(e).addCallback(t),Li().onNodeTypeClicked(e,this._listeners.get(e))}removeOnNodeTypeClicked(e,t){const i=this._nodeTypeToListenerMulti.get(e);if(i===void 0){console.assert(!1,`listenerMulti not registered for ${e}`);return}i.removeCallback(t),i.size()===0&&(Li().removeOnNodeTypeClicked(e,this._listeners.get(e)),this._nodeTypeToListenerMulti.delete(e))}clear(){this._listeners.forEach((e,t)=>Li().removeOnNodeTypeClicked(t,e)),this._nodeTypeToListenerMulti.clear(),this._listeners.clear()}}const Rp=new sx;class us{constructor(e){a(this,"triggers");a(this,"_anchors");a(this,"definition");a(this,"viewerApi");a(this,"running");a(this,"config");a(this,"triggersVisible");this.triggers=[],this.triggersVisible=!0,this._anchors=[],this.definition=this.constructor.definition,this.viewerApi=Li(),this.running=!1,this.config=Fo(this.migrateConfig(e)),this.viewerApi.onVrChange(this._vrChanged.bind(this))}isTriggerable(){return!1}trigger(e){}doInit(){this.viewerApi.onSceneReadyToDisplay(()=>this._installTriggers())}_installTriggers(){this.config.trigger&&this.addTrigger(this.config.trigger,(e,t)=>this.trigger(t))}doDispose(){}hasProperty(e){return this.definition.properties.some(t=>t.id===e)}migrateConfig(e){if(e=Mn(e),e.anchor!==void 0&&e.trigger===void 0&&!this.hasProperty("anchor")&&this.hasProperty("trigger")){const t=e.anchor,i=t.icon;i&&i.font&&(t.icon=ix[i.value]),e.trigger=t,e.anchor=void 0}for(const t of this.definition.properties)e[t.id]===void 0&&t.defaultValue!==void 0&&(e[t.id]=t.defaultValue);return e}get name(){return this.config.name}get type(){return this.config.type}get vrCompatible(){return this.definition.vrCompatible}cloneConfig(){return Mn(this.config)}updateConfig(e){this.dispose(),this.config=Fo(e),this.init()}init(){this.running||(this.doInit(),this.running=!0)}dispose(){if(this.running){this.doDispose();for(const e of this._anchors)this.viewerApi.removeAnchor(e);for(const e of this.triggers)e.constructor===_n&&(this.viewerApi.removeOnCameraPositionUpdated(e.onCameraPositionUpdated),e.dispose());Rp.clear(),this.triggers.length=0,this._anchors.length=0,this.running=!1}}_vrChanged(e){e&&!this.vrCompatible?this.dispose():!e&&!this.vrCompatible&&this.init()}_addCameraVolumeTrigger(e,t,i,n){typeof e.triggerOnEnter=="boolean"&&(console.assert(typeof e.triggerOnExit=="boolean"),e.triggerOnEnter=e.triggerOnEnter?"fireExtension":"doNothing",e.triggerOnExit=e.triggerOnExit?"fireExtension":"doNothing");const r={fireExtension:[t],activateExtension:[i],deactivateExtension:[n],doNothing:[]},o=new _n(r[e.triggerOnEnter],r[e.triggerOnExit],{position:e.position,rotation:e.rotation,scale:e.scale,type:e.cameraVolumeType});this.triggers.push(o),Li().onCameraPositionUpdated(o.onCameraPositionUpdated)}addTrigger(e,t,i=No,n=No){if(e.type==="node"){const r=e.nodeType;Rp.onNodeTypeClicked(r,t),this.triggers.push(...this.viewerApi.findNodesOfType(r))}else if(["sphere","sprite"].includes(e.type)){e=e;const r=this.viewerApi.addAnchor(e,t);this._anchors.push(r),this.triggers.push(r)}else e.type=="cameraVolumeTrigger"?this._addCameraVolumeTrigger(e,t,i,n):console.assert(!1,"Unknown trigger type.")}changeTriggersVisibility(e){this.triggersVisible!==e&&(this.triggersVisible=e,this.triggers.forEach(t=>{t instanceof Rr&&(t.visible=e)}))}}a(us,"definition");class Xn extends us{trigger(e){this.activated()?this.deactivate():this.activate(e)}isTriggerable(){return!0}isTriggerExclusive(){return!!this.config.triggerExclusive}_installTriggers(){this.config.trigger&&this.addTrigger(this.config.trigger,(e,t)=>this.trigger(t),(e,t)=>this.activate(t),()=>this.deactivate())}}const yc=class yc extends Xn{constructor(t){super(yc.migrateLegacyConfig(t));a(this,"_audioOnIcon");a(this,"_audioOffIcon");a(this,"_play");a(this,"_element");a(this,"_playButton");a(this,"_playButtonIcon");this._audioOnIcon=void 0,this._audioOffIcon=void 0,this._element=void 0,this._playButton=void 0,this._playButtonIcon=void 0,this._play=!1}static migrateLegacyConfig(t){return t.url&&!t.file&&(t.file={file:t.url.split("/").pop(),url:t.url},delete t.url),t.file.path&&t.file.url&&delete t.file.url,t}_onSceneReadyToDisplay(){const t=this.config;this._installTriggers(),t.menuButton&&(this._playButton=this.viewerApi.addMenuButton(this._audioOffIcon.src),this._playButton.addEventListener("click",()=>this.trigger()),this._playButtonIcon=this.viewerApi.getMenuButtonIcon(this._playButton)),t.autoplay&&this.viewerApi.onNextPageInteraction(()=>this.trigger())}activated(){return this._play}deactivate(){this._element.pause()}activate(){this.config.playRewinds&&(this._element.currentTime=0),this._element.play()}doInit(){Le.log("Audio start"),this.config.menuButton&&!this._audioOnIcon&&(this._audioOnIcon=il(gi("img/audio-on.svg")),this._audioOffIcon=il(gi("img/audio-off.svg"))),this._element=document.createElement("audio"),this.config.file&&(this.config.file.path?this._element.src=Bo(this.config.file.path):this.config.file.url&&(this._element.src=this.config.file.url)),this._element.src&&(this._element.loop=this.config.loop,this._element.addEventListener("play",()=>{this._play=!0,this._playButtonIcon&&(this._playButtonIcon.src=this._audioOnIcon.src)}),this._element.addEventListener("pause",()=>{this._play=!1,this._playButtonIcon&&(this._playButtonIcon.src=this._audioOffIcon.src)}),document.body.appendChild(this._element),this.viewerApi.onSceneReadyToDisplay(()=>this._onSceneReadyToDisplay()))}doDispose(){Le.log("Audio stop"),this._play=!1,this._playButton&&(this.viewerApi.removeMenuButton(this._playButton),this._playButton=void 0,this._playButtonIcon=void 0),this._element.pause(),this._element.remove(),this._element=void 0}};a(yc,"definition",{name:"Audio",type:In.TWO_STATE,properties:[{id:"file",type:"file",label:"File",fileType:"audio"},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!1},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1},{id:"loop",type:"bool",label:"Loop",defaultValue:!0},{id:"menuButton",type:"bool",label:"Show menu button",defaultValue:!0},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});let rd=yc;class Ip extends us{constructor(t){super(t);a(this,"_nextView");this._nextView=0}isTriggerable(){return!0}trigger(){const t=this.config.views[this._nextView];this.viewerApi.switchToView(t,void 0,this.config.doNotMoveCamera),this._nextView=(this._nextView+1)%this.config.views.length}doInit(){super.doInit(),this._nextView=0}}a(Ip,"definition",{name:"Change view",type:In.MULTI_STATE,properties:[{id:"views",type:"list",elementType:"view",label:"Views to toggle"},{id:"doNotMoveCamera",type:"bool",label:"Do not move camera",defaultValue:!1},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class Dp extends us{constructor(t){super(t);a(this,"_visibleIcon");a(this,"_hiddenIcon");a(this,"_hideAnchorsButton");a(this,"_hideAnchorsButtonIcon");a(this,"_onAnchorsVisibilityChanged",()=>{this._hideAnchorsButtonIcon.src=this.viewerApi.anchorsVisible?this._visibleIcon.src:this._hiddenIcon.src});this._visibleIcon=il(gi("img/anchors-on.svg")),this._hiddenIcon=il(gi("img/anchors-off.svg"))}isTriggerable(){return!0}trigger(){this.viewerApi.anchorsVisible=!this.viewerApi.anchorsVisible}doInit(){const t=this.viewerApi;this._hideAnchorsButton=t.addMenuButton(this._visibleIcon.src),this._hideAnchorsButtonIcon=t.getMenuButtonIcon(this._hideAnchorsButton),t.onAnchorsVisibilityChanged(this._onAnchorsVisibilityChanged),this._hideAnchorsButton.addEventListener("click",()=>this.trigger()),t.onSceneReadyToDisplay(()=>t.anchorsVisible=this.config.visibleOnStart)}doDispose(){this.viewerApi.removeAnchorsVisibilityChangedListener(this._onAnchorsVisibilityChanged),this.viewerApi.removeMenuButton(this._hideAnchorsButton),this._hideAnchorsButton=void 0,this._hideAnchorsButtonIcon=void 0,this.viewerApi.anchorsVisible=!0}}a(Dp,"definition",{name:"Hide triggers",properties:[{id:"visibleOnStart",type:"bool",label:"Visible on start",defaultValue:!0}],vrCompatible:!0});const bn=class bn extends Xn{constructor(t){super(t);a(this,"_popup");this._popup=void 0}_sleepAnimatedMaterials(){bn._animatedMaterialsAreSleeping||(this.viewerApi.sleepAnimatedMaterials(),bn._animatedMaterialsAreSleeping=!0)}_wakeAnimatedMaterials(){bn._animatedMaterialsAreSleeping&&(this.viewerApi.wakeAnimatedMaterials(),bn._animatedMaterialsAreSleeping=!1)}_doesElementContainVideo(t){if(t instanceof HTMLVideoElement||t instanceof HTMLIFrameElement)return!0;for(const i of t.children)if(this._doesElementContainVideo(i))return!0;return!1}_onClosePopup(){this._popup=void 0,bn._activeLabel===this&&(bn._activeLabel=void 0,this._wakeAnimatedMaterials())}activated(){return bn._activeLabel===this}deactivate(){this._popup!==void 0&&this.activated()&&this._popup.close()}activate(){if(!this.activated()){bn._activeLabel=this,this._popup=this.viewerApi.openPopup(this.config.content,this.config,()=>this._onClosePopup());const t=document.createElement("div");t.innerHTML=this.config.content,this._doesElementContainVideo(t)?this._sleepAnimatedMaterials():this._wakeAnimatedMaterials()}}doDispose(){this._popup!==void 0&&this._popup.close()}};a(bn,"definition",{name:"HTML label",type:In.TWO_STATE,properties:[{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"content",type:"textArea",label:"Content",optional:!0,defaultValue:"Content to display..."},{id:"centerHorizontally",type:"bool",label:"Center horizontally",defaultValue:!1},{id:"centerVertically",type:"bool",label:"Center vertically",defaultValue:!1},{id:"padding",type:"bool",label:"Padding",defaultValue:!0}],vrCompatible:!1}),a(bn,"_activeLabel"),a(bn,"_animatedMaterialsAreSleeping",!1);let od=bn;/*!
 * Copyright (C) 2022-present Shapespark
 */function vt(s){return document.getElementById(s)}function Ir(){if(!it.ios){const s=vt("walk-canvas");s&&s.focus()}}function Lp(s){return function(e){e.stopPropagation(),s(),Ir()}}function qn(s,e){s.addEventListener("click",Lp(e))}function Ii(s,e){const t=vt(s);tt(t!=null,`${s} could not be found.`),t!==null&&qn(t,e)}function Gl(s){s.addEventListener("click",e=>{e.stopPropagation(),e.target instanceof HTMLInputElement||e.target instanceof HTMLSelectElement||e.target instanceof HTMLTextAreaElement||Ir()})}const zs=class zs{constructor(e,t,i){a(this,"_content");a(this,"_options");a(this,"_onClose");a(this,"_container");a(this,"_contentElement");a(this,"_isOpen");this._content=e,this._isOpen=!1,this._options=t,this._container=document.getElementById("ext-html-label"),this._contentElement=this._container.querySelector("#ext-html-label-content"),this._onClose=i}static set _setLastOpenPopup(e){zs._lastOpenPopup=e}static get lastOpenPopup(){return zs._lastOpenPopup}static openPopup(e,t,i){const n=new zs(e,t,i);return zs.lastOpenPopup!==void 0?zs.lastOpenPopup.close(()=>n.open()):n.open(),zs._setLastOpenPopup=n,n}close(e){if(!this._isOpen){e==null||e();return}const t=n=>{this._container.classList.remove("ext-html-label-topleft"),this._container.classList.remove("ext-html-label-horizontal-center"),this._container.classList.remove("ext-html-label-vertical-center"),this._container.classList.remove("ext-html-label-center"),this._container.classList.remove("ui-out"),this._contentElement.innerHTML="",this._container.style.display="none",this._onClose&&this._onClose(),n==null||n(),this._isOpen=!1};this._container.classList.add("ui-out");const i=400;Ir(),window.setTimeout(()=>t(e),i)}open(){if(this._isOpen)return;const e=()=>{this._options.centerVertically?this._options.centerHorizontally?this._container.classList.add("ext-html-label-center"):this._container.classList.add("ext-html-label-vertical-center"):this._options.centerHorizontally?this._container.classList.add("ext-html-label-horizontal-center"):this._container.classList.add("ext-html-label-topleft"),this._container.classList.add("ui-out"),this._container.classList.remove("ext-html-label-animated"),this._container.offsetHeight,this._container.classList.add("ext-html-label-animated"),this._container.classList.remove("ui-out")},t=()=>{this._options.padding||this._options.padding===void 0?this._contentElement.style.padding="":this._contentElement.style.padding="0"};if(this._content instanceof Node)this._contentElement.appendChild(this._content);else{const i=Bo("").slice(0,-1),n=this._content.replace(/\$EXTRA_ASSETS/g,i);this._contentElement.innerHTML=n}t(),this._container.style.display="",e(),this._container.querySelector("#ext-html-label-close").onclick=()=>{this.close()},this._isOpen=!0}};a(zs,"_lastOpenPopup");let pa=zs;const xc=class xc{constructor(e,t){a(this,"vrRadius");a(this,"vrPosition");a(this,"vrPositionOffset");a(this,"viewer");a(this,"trigger");this.viewer=e,this.trigger=t,this.vrPosition=new B,this.vrPositionOffset=new B,this.trigger&&["sprite","sphere"].includes(this.trigger.type)?(this.vrPosition.fromArray(this.trigger.position),this.vrRadius=this.trigger.radius):this.vrRadius=xc.VR_RADIUS}getPosition(e){if(e!=null)return(!this.trigger||this.trigger.type==="node")&&(this.vrPositionOffset.copyFrom(this.viewer.getCameraPosition()),this.vrPositionOffset.sub(e),this.vrPositionOffset.normalize().multiplyScalar(this.vrRadius),this.vrPosition.copyFrom(e).add(this.vrPositionOffset)),this.vrPosition}getRadius(){return this.vrRadius}};a(xc,"VR_RADIUS",.07);let Hl=xc,rx=(Io=class extends Xn{constructor(t){super(Io._migrateConfig(t));a(this,"_meshes");a(this,"_ownedMaterialPickerId");a(this,"_vrPlacer");a(this,"_apiUserStateKey");a(this,"_onStateChanged",(t,i)=>{console.assert(t===this._apiUserStateKey);const n=this.viewerApi.findMaterial(i);n&&this._setMaterial(n)});this._meshes=[],this._ownedMaterialPickerId=void 0,this._vrPlacer=new Hl(this.viewerApi,this.config.trigger),this._apiUserStateKey="MaterialPicker:"+this.name,this.viewerApi.isSceneReadyToDisplay()||this._materialNames().forEach(i=>this.viewerApi.setMaterialEditable(i))}static _migrateConfig(t){if(!t.materials)return t;const i=Mn(t);return i.materials.length>0&&(i.toReplace=i.materials[0],i.toPick=i.materials.slice(1)),i.materials=void 0,Fo(i)}_materialNames(){return(this.config.toReplace?[this.config.toReplace]:[]).concat(this.config.toPick||[])}_materials(){return this._materialNames().map(t=>this.viewerApi.findMaterial(t))}_setMaterial(t){this._meshes.forEach(i=>this.viewerApi.setMaterialForMesh(t,i))}_materialSelected(t){this.viewerApi.apiUserChangeState(this._apiUserStateKey,t.name)}activated(){return this._ownedMaterialPickerId===void 0?!1:this.viewerApi.getCurrentMaterialPickerId()===this._ownedMaterialPickerId}deactivate(){this.activated()&&(this._ownedMaterialPickerId=void 0,this.viewerApi.closeMaterialPicker())}activate(t){this.activated()||(this.viewerApi.closeMaterialPicker(),this._ownedMaterialPickerId=this.viewerApi.openMaterialPicker(this._materials(),i=>this._materialSelected(i),null,this._vrPlacer.getPosition(t),this._vrPlacer.getRadius()))}isTriggerable(){return!0}_sceneReadyToDisplay(){this._installTriggers(),this._meshes=this.viewerApi.findMeshesWithMaterial(this.config.toReplace||[])}doInit(){this.viewerApi.onSceneReadyToDisplay(()=>this._sceneReadyToDisplay()),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}doDispose(){const t=this.viewerApi.findMaterial(this.config.toReplace);t&&this._materialSelected(t),this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}},a(Io,"definition",{name:"Material picker",type:In.TWO_STATE,properties:[{id:"toReplace",type:"material",label:"Material to replace"},{id:"toPick",type:"list",elementType:"material",label:"Materials to pick"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0}),Io);const ri=class ri extends us{constructor(t){super(t);a(this,"_meshesForOptions",[]);a(this,"_defaultUvScale",[1,1]);a(this,"_originalUvOffsetScaleForMaterial",new Map);a(this,"_vrPlacer");a(this,"_apiUserStateKey");a(this,"_optionList");a(this,"_curOptionIdx",-1);a(this,"_materialSelected",(t,i)=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,i)});a(this,"_onStateChanged",(t,i)=>{if(console.assert(t===this._apiUserStateKey),this._revertChanges(),i!==0){this._curOptionIdx=i-1;for(let n=0;n<this._optionList[this._curOptionIdx].length;++n){const r=this._optionList[this._curOptionIdx][n],o=this.viewerApi.findMaterial(r.toUse),l=this._originalUvOffsetScaleForMaterial.get(o),c=r.uvScale?r.uvScale[0]:this._defaultUvScale[0],d=r.uvScale?r.uvScale[1]:this._defaultUvScale[1];o.setUvOffsetAndScale(l.x,l.y,l.z*c,l.w*d),o.setUniforms();for(const u of this._meshesForOptions[this._curOptionIdx][n])this.viewerApi.setMaterialForMesh(o,u)}}});a(this,"_sceneReadyToDisplay",()=>{for(const t of this.config.triggers)this.addTrigger(t,this.openFromTrigger.bind(this));for(let t=0;t<this._optionList.length;++t){this._meshesForOptions[t]=[];for(const{toReplace:i,toUse:n}of this._optionList[t]){this._meshesForOptions[t].push(this.viewerApi.findMeshesWithMaterial(i));const r=this.viewerApi.findMaterial(n);if(!this._originalUvOffsetScaleForMaterial.has(r)){const o=new Lt;this._originalUvOffsetScaleForMaterial.set(r,r.getUvOffsetAndScale(o))}}}});a(this,"togglePickersMenu",()=>{const t=ri._startedPickers;if(console.assert(t.length>0),ri._pickerOpened&&this.viewerApi.closeMaterialPicker(),ri._menuPopup){this.closePickersMenu();return}const i=document.createElement("div");i.innerHTML=`
        <div class="ext-material-combo-picker-menu-title">
          <img src="${gi("img/sliders-horizontal.svg")}">
        </div>
        <ul class="ext-material-combo-picker-menu-list">
          <li class="ext-material-combo-picker-menu-item"></li>
        </ul>`;const n=i.getElementsByClassName("ext-material-combo-picker-menu-list")[0];let r=n.getElementsByClassName("ext-material-combo-picker-menu-item")[0];for(let o=0;o<t.length;++o){o>0&&(r=r.cloneNode(!0),n.appendChild(r));const l=t[o];Zr(r,l.name),r.addEventListener("click",function(){l._openFromMenu()})}ri._menuPopup=pa.openPopup(i,{centerHorizontally:!0,centerVertically:!0,padding:!1},()=>{ri._menuPopup=void 0})});this._vrPlacer=new Hl(this.viewerApi),this._apiUserStateKey="MaterialComboPicker:"+this.name,this._optionList=this.config.options,this.viewerApi.isSceneReadyToDisplay()||this._allMaterialNames().forEach(i=>this.viewerApi.setMaterialEditable(i))}_allMaterialNames(){const t=new Set;for(const i of this._optionList)for(const n of i)t.add(n.toReplace),t.add(n.toUse);return t}_revertChanges(){if(this._curOptionIdx!==-1)for(let t=0;t<this._optionList[this._curOptionIdx].length;++t){const i=this._optionList[this._curOptionIdx][t],n=this.viewerApi.findMaterial(i.toUse),r=this.viewerApi.findMaterial(i.toReplace);n.setUvOffsetAndScale(this._originalUvOffsetScaleForMaterial.get(n)),n.setUniforms();for(const o of this._meshesForOptions[this._curOptionIdx][t])this.viewerApi.setMaterialForMesh(r,o)}}isTriggerable(){return!1}openFromTrigger(t,i,n){ri._menuPopup&&this.closePickersMenu();const r=this._toPickMaterials();this.viewerApi.openMaterialPicker(r,this._materialSelected,()=>this.pickerClosed(),this._vrPlacer.getPosition(i),this._vrPlacer.getRadius()),ri._pickerOpened=!0}_toPickMaterialNames(){const t=[this._optionList[0][0].toReplace];for(const i of this._optionList)t.push(i[0].toUse);return t}_toPickMaterials(){return this._toPickMaterialNames().map(t=>this.viewerApi.findMaterial(t))}closePickersMenu(){ri._menuPopup.close(),ri._menuPopup=void 0}pickerClosed(){ri._pickerOpened=!1}_openFromMenu(){const t=this._toPickMaterials();this.viewerApi.openMaterialPicker(t,this._materialSelected),ri._pickerOpened=!0}doInit(){this.viewerApi.onSceneReadyToDisplay(this._sceneReadyToDisplay),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged);const t=ri._startedPickers;if(t.push(this),t.length===1){const i=this.viewerApi.addMenuButton(gi("img/sliders-horizontal.svg"));i.addEventListener("click",this.togglePickersMenu),ri._menuButton=i}}doDispose(){this._revertChanges(),this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this._onStateChanged);const t=ri._startedPickers;if(t.splice(t.indexOf(this),1),t.length===0){const i=ri._menuButton;this.viewerApi.removeMenuButton(i),ri._menuButton=void 0}}};a(ri,"definition",{name:"Material combo picker",hideFromEditor:!0,properties:[{id:"triggers",type:"list",label:"Triggers",elementType:"trigger"},{id:"options",type:"list",label:"Options",elementType:{type:"list",label:"option",elementType:[{id:"toReplace",type:"material",label:"Material to replace"},{id:"toUse",type:"material",label:"Material to use"},{id:"uvScale",type:"list",label:"UV Scale",elementType:"float"}]}}],vrCompatible:!0}),a(ri,"_startedPickers",[]),a(ri,"_menuButton"),a(ri,"_menuPopup"),a(ri,"_pickerOpened",!1);let ad=ri;const ox=["toggle","impulse","activate","deactivate"];function ma(s){const[e,t,i]=s.split(":");return[e,t,i]}function ax(s){return["VideoTextureControl","SwitchObjects"].includes(s.type)}class Fp extends us{constructor(t){super(t);a(this,"_nextTriggerActivate");this._nextTriggerActivate=!0}migrateConfig(t){t=super.migrateConfig(t);const i=new Array;let n=!1;for(const r of t.extensions){let[o,l,c]=ma(r);ox.includes(c)||(n=!0,c="toggle"),i.push(`${o}:${l}:${c}`)}return n&&(t.extensions=i),t}extensionsAndTriggerTypes(){return this.config.extensions.map(t=>{const[i,n,r]=ma(t);return[this.viewerApi.getExtension(i,n),r]})}get vrCompatible(){return this.extensionsAndTriggerTypes().every(([t])=>t.vrCompatible)}trigger(t){for(const[i,n]of this.extensionsAndTriggerTypes())try{switch(n){case"activate":ye(i instanceof Xn),i.activate(t);break;case"deactivate":ye(i instanceof Xn),i.deactivate();break;case"impulse":ye(i instanceof Xn),i.trigger(t);break;case"toggle":i instanceof Xn?this._nextTriggerActivate?i.activate(t):i.deactivate():i.trigger(t);break}}catch(r){console.error("Failed to trigger an extension",r)}this._nextTriggerActivate=!this._nextTriggerActivate}isTriggerable(){return!1}doInit(){super.doInit(),this._nextTriggerActivate=!0}}a(Fp,"definition",{name:"Multi trigger",type:In.IMPULSE,getListElementsToAdd:function(t,i,n){tt(t==="extensions");const r=new Set(i.map(l=>ma(l)[0])),o=l=>l.isTriggerable()&&(ax(l)||!r.has(l.type));return n.filter(o).map(l=>`${l.type}:${l.name}:toggle`)},formatListElement:function(t){const[i,n,r]=ma(t),o=Hp(i),l=r.replace(r[0],r[0].toUpperCase());return`${o.name}: ${n} - ${l}`},getTriggerTypeDefinition:function(t){const[i]=ma(t);return Hp(i)},properties:[{id:"extensions",type:"list",elementType:"extension",label:"Extensions to trigger",elementLabel:"extension"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!1});class Op extends us{constructor(e){super(e)}isTriggerable(){return!0}trigger(){this.viewerApi.openUrl(this.config.url,this.config.newWindow)}}a(Op,"definition",{name:"Open URL",type:In.IMPULSE,properties:[{id:"url",type:"text",label:"URL"},{id:"newWindow",type:"bool",label:"New window",defaultValue:!0},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});const Bp=D.EDIT_MODE;class Np extends us{constructor(t){super(t);a(this,"_apiUserStateKey");a(this,"_meetingController");a(this,"_material");a(this,"_origBaseColorTexture");a(this,"_presentingAvatar");a(this,"_editModePopup");a(this,"_attachScreenShareToTexture",()=>{const t=this._getScreenShareTexture();t?this._material.baseColorTexture=t:this._material.baseColorTexture=this._origBaseColorTexture});a(this,"_presentationStop",()=>{Le.log("Presentation stop"),this._presentingAvatar&&(this._presentingAvatar.uuid===this._meetingController.myUuid&&this._meetingController.stopShareScreen(),this._presentingAvatar.removeEventListener("dispose",this._presentationStop),this._presentingAvatar.removeEventListener("avatarUpdated",this._attachScreenShareToTexture)),this._presentingAvatar=void 0,this._material.baseColorTexture=this._origBaseColorTexture,this._removeTriggerHighlight()});a(this,"_fakeTogglePresentation",()=>{if(this._editModePopup){this._editModePopup.close();return}const t=`In a 3D meeting this trigger will start a screen sharing on the ${this.config.material} material. Outside of a 3D meeting the trigger will be hidden.`;this._editModePopup=pa.openPopup(t,{padding:!0,centerVertically:!0,centerHorizontally:!0},()=>{this._editModePopup=void 0})});a(this,"_togglePresentation",()=>{const t=this._meetingController.myUuid;!this._presentingAvatar||!this._getScreenShareTexture()?(Le.log("Requesting screen share "+t),this._meetingController.startShareScreen(()=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,t)},()=>{this.viewerApi.apiUserChangeState(this._apiUserStateKey,null)},()=>{})):this._presentingAvatar.uuid!==t||(Le.log("Requesting presentation stop"),this.viewerApi.apiUserChangeState(this._apiUserStateKey,null))});a(this,"onStateChanged",(t,i)=>{if(console.assert(t===this._apiUserStateKey),!i){this._presentationStop();return}if(this._presentingAvatar&&this._presentingAvatar.uuid!==i&&(Le.log("Changing presenting user"),this._presentationStop()),!this._presentingAvatar){if(Le.log("New presenting user "+i),this._presentingAvatar=this.viewerApi.findAvatar(i),!this._presentingAvatar){console.log("Cannot attach presentation stream of a user "+i+" The user was not found.");return}this._presentingAvatar.addEventListener("dispose",this._presentationStop),this._presentingAvatar.addEventListener("avatarUpdated",this._attachScreenShareToTexture),this._addTriggerHighlight(),this._attachScreenShareToTexture()}});a(this,"_onAvatarListChanged",()=>{this.onStateChanged(this._apiUserStateKey,this.viewerApi.getApiUserState(this._apiUserStateKey))});a(this,"_meetingJoined",t=>{const i=this.config;if(this._material=this.viewerApi.findMaterial(i.material),!this._material){console.error("Material for a projection screen is missing"),this._material=void 0;return}this._meetingController=t,this._origBaseColorTexture=this._material.baseColorTexture,this.config.trigger&&this.addTrigger(this.config.trigger,this._togglePresentation),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this.onStateChanged),this.viewerApi._onAvatarListChanged(this._onAvatarListChanged)});this._apiUserStateKey="ProjectionScreen:"+this.name,this._meetingController=void 0,this._material=void 0,this._origBaseColorTexture=void 0,this._presentingAvatar=void 0,this._editModePopup=void 0,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_hasHighlightableTrigger(){return this.triggers[0]instanceof Rr}_getTriggerMaterial(){return console.assert(this._hasHighlightableTrigger()),this.triggers[0].material}_addTriggerHighlight(){if(!this._hasHighlightableTrigger())return;const t=this._getTriggerMaterial();t.highlight=this._presentingAvatar.getMainMaterial().baseColor,t.setUniforms(),t.highlightMix=.7}_removeTriggerHighlight(){this._hasHighlightableTrigger()&&(this._getTriggerMaterial().highlightMix=0)}_getScreenShareTexture(){return this._presentingAvatar.getVideoTexture1()}isTriggerable(){return!1}doInit(){Bp?this.config.trigger&&this.addTrigger(this.config.trigger,this._fakeTogglePresentation):this.viewerApi._onMeetingJoined(this._meetingJoined)}doDispose(){Bp||(this.viewerApi._removeOnMeetingJoined(this._meetingJoined),this._meetingController&&(this.viewerApi.removeOnApiUserStateChanged(this._apiUserStateKey,this.onStateChanged),this.viewerApi._removeOnAvatarListChanged(this._onAvatarListChanged)),this._meetingController=void 0,this._material=void 0)}}a(Np,"definition",{name:"Meeting projection screen",type:In.TWO_STATE,properties:[{id:"material",type:"material",label:"Material to project on"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class kp extends us{constructor(e){super(e)}isTriggerable(){return!0}trigger(){try{new Function('"use strict"; '+this.config.code)()}catch(e){console.error("Script extension error: "+e)}}doInit(){super.doInit(),this.config.trigger||this.trigger()}}a(kp,"definition",{name:"Script",type:In.IMPULSE,properties:[{id:"code",type:"textArea",label:"Code",defaultValue:"<!-- Put your JavaScript code here. If a trigger is set, the code is executed when the trigger is clicked. Otherwise the code is executed when a page is loaded -->"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0}],vrCompatible:!0});class Up extends us{constructor(t){super(t);a(this,"_apiUserStateKey");a(this,"_visibleNodeTypeIdx");a(this,"_visibleNodes");a(this,"_onStateChanged",(t,i)=>{console.assert(t===this._apiUserStateKey),this._visibleNodeTypeIdx=i,this._updateNodesVisibility()});if(this._apiUserStateKey="SwitchObjects:"+this.name,this._visibleNodeTypeIdx=void 0,this._visibleNodes=[],!this.viewerApi.isSceneReadyToDisplay())for(const i of this.config.nodeTypes)this.viewerApi.setNodeTypeEditable(i)}_updateNodesVisibility(){if(this._visibleNodes.forEach(t=>t.hide()),this._visibleNodeTypeIdx===-1)this._visibleNodes=[];else{const t=this.config.nodeTypes[this._visibleNodeTypeIdx];this._visibleNodes=this.viewerApi.findNodesOfType(t),this._visibleNodes.forEach(i=>i.show())}this.viewerApi.requestFrame()}trigger(){this.config.nodeTypes.length!==0&&(this._visibleNodeTypeIdx=this._visibleNodeTypeIdx+1,this._visibleNodeTypeIdx===this.config.nodeTypes.length&&(this._visibleNodeTypeIdx=this.config.hideAllAfterLast?-1:0),this.viewerApi.apiUserChangeState(this._apiUserStateKey,this._visibleNodeTypeIdx))}isTriggerable(){return!0}doInit(){this._visibleNodes=[],this.viewerApi.onSceneReadyToDisplay(()=>{for(let i=0;i<this.config.nodeTypes.length;++i)(i>0||this.config.hideAllOnStart)&&this.viewerApi.findNodesOfType(this.config.nodeTypes[i]).forEach(r=>r.hide());const t=this.config.nodeTypes.length==0||this.config.hideAllOnStart;this._visibleNodeTypeIdx=t?-1:0,this._updateNodesVisibility(),this._installTriggers()}),this.viewerApi.onApiUserStateChanged(this._apiUserStateKey,this._onStateChanged)}doDispose(){for(let t=0;t<this.config.nodeTypes.length;++t)t!==this._visibleNodeTypeIdx&&this.viewerApi.findNodesOfType(this.config.nodeTypes[t]).forEach(n=>n.show());this.viewerApi.requestFrame()}}a(Up,"definition",{name:"Switch objects",type:In.MULTI_STATE,properties:[{id:"nodeTypes",type:"list",elementType:"nodeType",label:"Objects to switch"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"hideAllOnStart",type:"bool",label:"Hide all on start",defaultValue:!1},{id:"hideAllAfterLast",type:"bool",label:" Hide all after last",defaultValue:!1}],vrCompatible:!0});class zp extends Xn{constructor(t){super(t);a(this,"_material");a(this,"_initialized");a(this,"_initializationPending");a(this,"_origBaseColorTexture");this._origBaseColorTexture=void 0,this._material=void 0,this._initialized=!1,this._initializationPending=!1,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_createVideoTexture(t){const i=document.createElement("video");if(i.classList.add("video-js"),i.autoplay=!0,i.muted=!0,i.type="application/x-mpegURL",Hls.isSupported()){const n=new Hls;n.loadSource(t),n.attachMedia(i)}else i.canPlayType("application/vnd.apple.mpegurl")?i.src=t:console.log("No Hls support");return this.viewerApi.createStreamTextureFromHtmlVideo(i)}_createStreamTexture(){const t=this._createVideoTexture(this.config.streamUrl);t.addLoadedListener(()=>{this._initializationPending=!1,this.running&&(this._origBaseColorTexture=this._material.baseColorTexture,this._material.baseColorTexture=t,this.viewerApi.onNextPageInteraction(()=>{t.muted=!1}),this._initialized=!0)}),this._initializationPending=!0,t.play()}_stateChanging(){return this._initializationPending?!0:!this._initialized&&!this._initializationPending?(this._createStreamTexture(),!0):!1}activated(){return this._material.isPlaying}activate(){this._stateChanging()||(this.config.playRewinds&&this._material.rewind(),this._material.play())}deactivate(){this._stateChanging()||this._material.pause()}trigger(){this._stateChanging()||super.trigger()}sceneLoadComplete(){const t=this.config;if(this._material=this.viewerApi.findMaterial(t.material),this._material){if(!this._material.baseColorTexture){console.error(`Material '${t.material}' for stream texture control '${t.name}' does not have a stream texture`),this._material=void 0;return}}else{console.error(`Material '${t.material}' for stream texture control '${t.name}' does not exist`);return}const i=()=>{this._installTriggers(),(this.config.autoplay||!this.config.trigger)&&this.trigger()};gr(gi("lib/Hls.js"),i,()=>Wt.error("Cannot load required library"))}doInit(){this.viewerApi.onSceneLoadComplete(()=>this.sceneLoadComplete())}doDispose(){if(this._material){if(this._initialized){this._initialized=!1;let t=this._material.baseColorTexture;this._material.baseColorTexture=this._origBaseColorTexture,t instanceof wt&&t.dispose(),t=void 0,this._origBaseColorTexture=void 0}this._material=void 0}}}a(zp,"definition",{name:"Video Stream",type:In.TWO_STATE,properties:[{id:"material",type:"material",label:"Material with stream"},{id:"streamUrl",type:"text",label:"Stream URL"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!0},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1}],vrCompatible:!0});class Vp extends Xn{constructor(t){super(t);a(this,"_material");this._material=void 0,this.viewerApi.isSceneReadyToDisplay()||this.viewerApi.setMaterialEditable(this.config.material)}_videoTextureLoaded(){const t=this._material.baseColorTexture,i=this.config;t.loop=i.loop,i.autoplay?i.muted||this.viewerApi.onNextPageInteraction(()=>{t.muted=!1}):(this._material.pause(),t.muted=i.muted),this._installTriggers()}_sceneLoadComplete(){const t=this.config;if(this._material=this.viewerApi.findMaterial(t.material),this._material){if(!this._material.baseColorTexture||!(this._material.baseColorTexture instanceof ra)||this._material.baseColorTexture.video===void 0){console.error(`Material '${t.material}' for video texture control '${t.name}' does not have a video texture`),this._material=void 0;return}}else{console.error(`Material '${t.material}' for video texture control '${t.name}' does not exist`);return}this._material.baseColorTexture.addLoadedListener(()=>this._videoTextureLoaded())}activated(){return this._material.isPlaying}deactivate(){this._material.pause()}activate(){this.config.playRewinds&&this._material.rewind(),this._material.play()}doInit(){this.viewerApi.onSceneLoadComplete(()=>this._sceneLoadComplete())}doDispose(){this._material&&(this._material.baseColorTexture.muted=!0,this._material.pause(),this._material=void 0)}}a(Vp,"definition",{name:"Video texture control",type:In.TWO_STATE,properties:[{id:"material",type:"material",label:"Material with video"},{id:"trigger",type:"trigger",label:"Trigger",optional:!0},{id:"autoplay",type:"bool",label:"Autoplay",defaultValue:!0},{id:"triggerExclusive",type:"bool",label:"Exclusive",defaultValue:!1},{id:"playRewinds",type:"bool",label:"Play rewinds",defaultValue:!1},{id:"loop",type:"bool",label:"Loop",defaultValue:!0},{id:"muted",type:"bool",label:"Muted",defaultValue:!0}],vrCompatible:!0});const Gp={HtmlLabel:od,Audio:rd,MaterialPicker:rx,MaterialComboPicker:ad,VideoTextureControl:Vp,OpenWebsite:Op,ChangeView:Ip,HideAnchors:Dp,Script:kp,ProjectionScreen:Np,SwitchObjects:Up,VideoStream:zp,MultiTrigger:Fp};function Hp(s){return Gp[s].definition}class lx{constructor(){a(this,"_extensions");a(this,"_extensionTypes");this._extensions=[],this._extensionTypes=Gp}updateConfig(e){this._extensions=[];for(const t of e)this._extensions.push(this._createExtensionFromConfig(t))}_augmentTriggerExclusiveExtension(e){if(!(e instanceof Xn&&e.isTriggerExclusive()))return e;const t=e.activate;e.activate=i=>{this._extensions.forEach(n=>{n instanceof Xn&&n!==e&&n.isTriggerExclusive()&&n.deactivate()}),t.call(e,i)}}_createExtensionFromConfig(e){function t(o,l){return o.some(c=>c.name===l&&c.config.type===e.type)}e.name=e.name.toString();const i=e.name;let n=2;for(;t(this._extensions,e.name);)e.name=i+n.toString(),n+=1;const r=new this._extensionTypes[e.type](e);return this._augmentTriggerExclusiveExtension(r),r}initExtensionsByType(e){this._loadFontAwesomeIfNeeded(()=>{this.getExtensionsByType(e).forEach(t=>t.init())})}initExtensions(){this._loadFontAwesomeIfNeeded(()=>{this._extensions.forEach(e=>e.init())})}_loadFontAwesomeIfNeeded(e){const t=this._extensions.map(i=>this._getFonts(i.config)).concat(D.FONT_FAMILIES_TO_LOAD).reduce((i,n)=>i.concat(n),[]).filter((i,n,r)=>n===r.indexOf(i));t.length>0&&!D.EDIT_MODE?cu(t,e,e):e()}_getFonts(e){function t(o){return o.icon&&zl[o.icon].fontFamily}const i=[];function n(o){const l=t(o);l&&i.push(l)}const r=this._extensionTypes[e.type].definition;for(const o of r.properties)if(o.type==="trigger"&&e[o.id])n(e[o.id]);else if(o.type==="list"&&o.elementType==="trigger"&&e[o.id])for(const l of e[o.id])n(l);return i}disposeExtensions(){this._extensions.forEach(e=>e.dispose())}disposeExtensionsByType(e){this.getExtensionsByType(e).forEach(t=>t.dispose())}getEditableExtensionDefinitions(){const e=[];for(const[t,i]of Object.entries(this._extensionTypes||{}))i.definition.hideFromEditor||e.push({type:t,definition:i.definition});return e}getEditableExtensions(){return this._extensions.filter(e=>!e.definition.hideFromEditor)}getEditableTriggerImagePaths(){const e=i=>i.properties.filter(n=>n.type==="trigger").map(n=>n.id),t=new Set;for(const i of this.getEditableExtensions())e(i.definition).forEach(n=>{i.config[n]&&i.config[n].image&&t.add(i.config[n].image)});return Array.from(t)}addExtension(e){this._extensions.push(e),e.init()}createExtension(e){return this._createExtensionFromConfig(e)}removeExtension(e){e.dispose();const t=this._extensions.indexOf(e);t!==-1&&this._extensions.splice(t,1)}shiftExtension(e,t){tl(this._extensions,e,t)}getExtensionIndex(e){return this._extensions.findIndex(t=>t===e)}getConfigs(){return this._extensions.map(function(e){return e.config})}getExtensionsByType(e){return this._extensions.filter(t=>t.type===e)}getExtension(e,t){const i=this._extensions.find(n=>n.type===e&&n.name===t);if(i)return i;console.error(`Unrecognized extension ${e} ${t}, supported types: ${Object.keys(this._extensionTypes)}`)}}const Wl={cardboardConfig:{ADDITIONAL_VIEWERS:[],DEFAULT_VIEWER:"",MOBILE_WAKE_LOCK:!0,DEBUG:!1,DPDB_URL:null,CARDBOARD_UI_DISABLED:!1,K_FILTER:.98,ROTATE_INSTRUCTIONS_DISABLED:!1,PREDICTION_TIME_S:.04,YAW_ONLY:!1,BUFFER_SCALE:1,DIRTY_SUBMIT_FRAME_BINDINGS:!1}};class ga extends kt{constructor(t){super();a(this,"id");a(this,"position");a(this,"boxMin",new B);a(this,"boxMax",new B);a(this,"_filteredCubeTexture");a(this,"_mirrorCubeTexture");a(this,"_boxEnabled");t.id,this.id=t.id,this.position=new B,t.position&&this.position.fromArray(t.position),this._boxEnabled=t.box?!("enabled"in t.box)||t.box.enabled:!1,t.box&&(this.boxMin.fromArray(t.box.min),this._setClampedBoxMax(...t.box.max))}setFilteredTexture(t){this._filteredCubeTexture&&this._filteredCubeTexture.dispose(),this._filteredCubeTexture=t}isBoundingBoxInitialized(){return!this.boxMin.equals(this.boxMax)}resetBoundingBox(){this.boxMin.set(0,0,0),this.boxMax.set(0,0,0)}isBoundingBoxEnabled(){return this._boxEnabled}disableBoundingBox(){this._boxEnabled=!1,this.dispatchEvent({type:"boundsUpdated",target:this})}enableBoundingBox(){this._boxEnabled=!0,this.isBoundingBoxInitialized()||this.dispatchEvent({type:"boundsInit",target:this}),this.dispatchEvent({type:"boundsUpdated",target:this})}getFilteredTexture(){return this._filteredCubeTexture}setMirrorTexture(t){this._mirrorCubeTexture&&this._mirrorCubeTexture.dispose(),this._mirrorCubeTexture=t}setPosition(t,i,n){this.position.set(t,i,n),this.dispatchEvent({type:"positionUpdated",target:this})}texturesReady(){return!!(this._mirrorCubeTexture||this._filteredCubeTexture)}getMirrorTexture(){return this._mirrorCubeTexture||this._filteredCubeTexture}_setClampedBoxMin(t,i,n){t>this.boxMax.x-.1&&(t=this.boxMax.x-.1),i>this.boxMax.y-.1&&(i=this.boxMax.y-.1),n>this.boxMax.z-.1&&(n=this.boxMax.z-.1),this.boxMin.set(t,i,n)}setBoxMin(t,i,n){this._setClampedBoxMin(t,i,n),this.dispatchEvent({type:"boundsUpdated",target:this})}_setClampedBoxMax(t,i,n){t<this.boxMin.x+.1&&(t=this.boxMin.x+.1),i<this.boxMin.y+.1&&(i=this.boxMin.y+.1),n<this.boxMin.z+.1&&(n=this.boxMin.z+.1),this.boxMax.set(t,i,n)}setBoxMax(t,i,n){this._setClampedBoxMax(t,i,n),this.dispatchEvent({type:"boundsUpdated",target:this})}serialize(){const t={id:this.id,position:this.position.toArray()};return this.isBoundingBoxInitialized()&&(t.box={enabled:this._boxEnabled,min:this.boxMin.toArray(),max:this.boxMax.toArray()}),t}dispose(){this._filteredCubeTexture&&(this._filteredCubeTexture.dispose(),this._filteredCubeTexture=void 0),this._mirrorCubeTexture&&(this._mirrorCubeTexture.dispose(),this._mirrorCubeTexture=void 0)}}/*!
 * Copyright (C) 2018-present Shapespark
 */const cx=10,hx=200,Wp=1.3,jp=1,dx=1.9,ux=1.5,fx=1/5;let Dn;function _a(s){return s.empty()?0:(s.size(Dn),Dn.x*Dn.y*Dn.z)}function ld(s){if(s.empty())return 0;s.size(Dn);const e=Dn.x*Dn.y;return Dn.x<jp||Dn.y<jp||Dn.z<dx||e<ux?0:e*Dn.z}function px(s,e){return s.min.x-.1<=e.min.x&&e.max.x<=s.max.x+.1&&s.min.y-.1<=e.min.y&&e.max.y<=s.max.y+.1&&s.min.z-.1<=e.min.z&&e.max.z<=s.max.z+.1}function mx(s,e){return!(s.max.x<e.min.x+.2||s.min.x>e.max.x-.2||s.max.y<e.min.y+.2||s.min.y>e.max.y-.2||s.max.z<e.min.z+.2||s.min.z>e.max.z-.2)}function gx(s){let e=[];const t=[];e.push(s),this.addFilledBox=function(n){t.push(n)},this.findBestFilledBoxes=function(){const n=[];let r=[],o,l;t.forEach(u=>{r.push([u,_a(u)])});function c(u){return u[1]}function d(u){return!mx(u[0],l)}for(;r.length>0&&n.length<cx;)o=Lc(r,c),l=r[o][0],n.push(l),r=r.filter(d);return n},this.isEnclosedInFilledBox=function(n){function r(o){return px(o,n)}return t.some(r)},this.findLargestEmptyBox=function(){const n=Lc(e,_a);return n!==void 0?e[n]:void 0};const i=function(){const n=[];return n[0]=new Dt,n[1]=new Dt,n[2]=new Dt,n[3]=new Dt,n[4]=new Dt,n[5]=new Dt,function(r,o,l){n[0].max.copyFrom(r.max),n[0].min.copyFrom(r.min),n[0].min.z=o.max.z,n[1].max.copyFrom(r.max),n[1].max.z=o.min.z,n[1].min.copyFrom(r.min),n[2].max.copyFrom(r.max),n[2].min.copyFrom(r.min),n[2].min.x=o.max.x,n[3].max.copyFrom(r.max),n[3].max.x=o.min.x,n[3].min.copyFrom(r.min),n[4].max.copyFrom(r.max),n[4].min.copyFrom(r.min),n[4].min.y=o.max.y,n[5].max.copyFrom(r.max),n[5].max.y=o.min.y,n[5].min.copyFrom(r.min);const c=Lc(n,ld);ld(n[c])!==0&&(l.push(n[c].clone()),c===0?r.max.z=o.max.z:c===1?r.min.z=o.min.z:c===2?r.max.x=o.max.x:c===3?r.min.x=o.min.x:c===4?r.max.y=o.max.y:c===5&&(r.min.y=o.min.y),i(r,o,l))}}();this.split=function(n){const r=[];for(let o=0;o<e.length;o+=1){const l=e[o];l.isIntersectionBox(n)?i(l,n,r):r.push(l)}e=r}}function Xp(s,e){s.center(e.position),e.position.z=s.min.z+Wp}function _x(s,e,t){const i=new gx(s.boundingBox.clone()),n=new Dt,r=new Dt,o=new B,l=new Pr;Dn=new B;const c=new ga({id:0});for(let f=0;f<hx;f+=1){const p=i.findLargestEmptyBox();if(p===void 0)break;Xp(p,c),c.enableBoundingBox(),r.makeEmpty();for(let m=0;m<5&&(e.findBounds(c),!!c.isBoundingBoxInitialized());m+=1){n.set(c.boxMin,c.boxMax);const b=ld(n);if(b===0||i.isEnclosedInFilledBox(n))break;n.center(o),o.z=n.min.z+Wp;const _=c.position.distanceToSquared(o);if(_a(r)<b&&_<.25&&r.set(n.min,n.max),_<.04)break;c.position.copyFrom(o)}r.empty()?(p.center(n.min),p.center(n.max),i.split(n)):(i.addFilledBox(r.clone()),i.split(r))}Le.log("Light probes arrangement time "+l.elapsedSec());const d=i.findBestFilledBoxes(),u=d.reduce((f,p)=>f+_a(p),0);function h(f){const p=new ga({id:s.lightProbes.length});Xp(f,p),p.enableBoundingBox(),p.boxMin.copyFrom(f.min),p.boxMax.copyFrom(f.max),s.lightProbes.push(p)}(u>_a(s.boundingBox)*fx||t)&&d.forEach(h),s.lightProbes.length===0&&t&&h(s.boundingBox)}const vx="aabb_query_vertex.glsl",bx="aabb_query_fragment.glsl";class yx{constructor(){a(this,"axis",new ll(0))}}class xx extends ai{constructor(){super({vsName:vx,fsName:bx,uniformBufferDataConstructor:yx}),this.side=Gi.DOUBLE,this.uniforms={axis:{type:"i",value:0,uniformSourceType:ve.MATERIAL}}}get axis(){return this.uniforms.axis.value}set axis(e){console.assert(e===0||e===1||e===2),this.uniforms.axis.value=e,this.uniformBufferData.axis=new ll(e)}}/*!
 * Copyright (C) 2015-present Shapespark
 */const Ax={uniforms:{gloss:{type:"f",value:.9},roughness:{type:"f",value:.9},face:{type:"f",value:0},mipSize:{type:"f",value:128},envMap:{type:"t",value:null},envMapFiltered:{type:"t",value:null},topMipResolution:{type:"f",value:512}},vertexShaderName:"cubemap_filter_vertex.glsl",fragmentShaderName:"cubemap_filter_fragment.glsl"};function Ex(s,e){return Math.round(s[e]*256*256+s[e+1]*256+s[e+2])}function wx(s,e){const t=s.length;for(let i=0;i<t;i+=4){const n=Ex(s,i);n!==16777215&&e.add(n)}}function Sx(s,e,t){const i=new Du(!0),n=new Yc(D.CAMERA_WALK_NEAR,t),r=D.OBJECT_VISIBILITY_TARGET_SIZE;let o=s.createRenderTarget(r,r,{magFilter:ne.NEAREST,minFilter:ne.NEAREST,depthBuffer:!0,stencilBuffer:!1,generateMipmaps:!1}),l=new Uint8Array(4*r*r);const c=new ws(s),d=new fl(s);this.findVisibleObjects=function(u){const h=new Set,f=[];n.position.copyFrom(u),n.updateMatrixWorld();for(let m=0;m<e.length;m+=1){const b=e[m];console.assert(!b.visibilityId),b.visibilityId=m,f.push(b)}c.set(!0,!0,!1),d.set(Re.WHITE);for(let m=0;m<6;m+=1)s.renderMeshes(f,i,n.sideCameras[m],o),s.readPixels(r,r,l),wx(l,h);d.restore(),c.restore();const p=[];for(let m of h)p.push(e[m]);for(let m=0;m<e.length;m+=1)e[m].visibilityId=null;return p},this.dispose=function(){i.dispose(),o.dispose(),o=null,l=null}}/*!
 * Copyright (C) 2014-present Shapespark
 */function Tx(s,e){for(const t of s)if(t.material.envMapMirror&&t.lightProbes.includes(e))return!0;return!1}function Mx(s,e){return Math.pow(2,Mc(e)-s)}const Px=function(){let s=null;return function(e,t){let i=null,n=0;const r=t*t;console.assert(r<Math.pow(2,16)),s===null&&(s=new Uint16Array(256*256));for(let o=0;o<r*4;o+=4){const l=e[o],c=e[o+1];s[l*256+c]+=1}s[0]>.7*r&&(n=s[0]),s[0]=0;for(let o=1;o<s.length;o+=1)s[o]>n&&(n=s[o],i=Math.floor(o/256)+o%256/255),s[o]=0;return i}}();function qp(s,e,t,i){s.sharedMaterialState.hdrOutput=!0,s.gpuMeshes.forEach(function(n){n.materialOverride!==void 0&&n.materialOverride!==null&&!i.has(n)&&(i.set(n,n.materialOverride),n.materialOverride=null)}),s.skyMeshes.forEach(n=>{i.set(n,n.visible),n.visible=!0}),s.threeScene.traverse(function(n){if(!(n instanceof Je)||!n.visible)return;const r=n.material;if(n.userData.hideFromLightProbes||r.hideFromLightProbes){e.add(n),n.visible=!1;return}t.has(r)||(t.set(r,{reflective:r.reflective,headLight:r.headLight}),r.configureTransparency&&(r.transparent=!1,r.blending=Hi.DISABLED,r.depthWrite=!0),r.headLight!==void 0&&(r.headLight=!1),r.reflective!==void 0&&(r.reflective=!1))})}function Yp(s,e,t,i){s.sharedMaterialState.hdrOutput=!1,s.gpuMeshes.forEach(function(n){i.has(n)&&(n.materialOverride=i.get(n),i.delete(n))}),s.skyMeshes.forEach(n=>{i.has(n)&&(n.visible=i.get(n),i.delete(n))}),s.threeScene.traverse(function(n){if(!(n instanceof Je))return;const r=n.material;if(r.forceObjectUniformsRefresh&&r.forceObjectUniformsRefresh(),!n.visible){e.has(n)&&(n.visible=!0);return}const o=t.get(r);o&&(t.delete(r),r.configureTransparency&&r.configureTransparency(),o.headLight!==void 0&&(r.headLight=o.headLight),o.reflective!==void 0&&(r.reflective=o.reflective))})}function Cx(s,e){const t=s.renderer,i=D.LIGHT_PROBE_MIRROR_SIZE,n=t.createRenderTargetCube(i,i,{magFilter:ne.LINEAR,minFilter:ne.LINEAR,stencilBuffer:!1,generateMipmaps:!1});if(D.DEV_NEW_RENDER_ARCHITECTURE){const r=e.sideCameras[0];Yi.get().renderCubemap(n,e.position,r.near,r.far)}else for(let r=0;r<6;r+=1)n.activeCubeFace=r,t.render(s.threeScene,e.sideCameras[r],n);return t.deallocateRenderTargetRenderingBuffers(n),n}const Qp=function(){let s=null;return function(e,t,i){const n=e.renderer,r=e.aabbQueryMaterial,o=e.pixelBuf,l=e.targetCubeRaw;s===null&&(s=new F_(.01,255)),s.position.copyFrom(t.position),s.updateMatrixWorld();let c;for(c=0;c<6;c+=1){l.activeCubeFace=c,r.axis=Math.floor(c/2),n.renderMeshes(e.scene.gpuMeshes,r,s.sideCameras[c],l),n.readPixels(l.width,l.height,o);const d=Px(o,l.width);if(d===null){Le.log("failed to find light probe bound");break}switch(c){case 0:i.boxMax.x=t.position.x+d;break;case 1:i.boxMin.x=t.position.x-d;break;case 2:i.boxMax.y=t.position.y+d;break;case 3:i.boxMin.y=t.position.y-d;break;case 4:i.boxMax.z=t.position.z+d;break;case 5:i.boxMin.z=t.position.z-d;break}}c!==6&&(Le.log("Light probe bounds: X["+i.boxMin.x.toFixed(2)+":"+i.boxMax.x.toFixed(2)+"] Y["+i.boxMin.y.toFixed(2)+":"+i.boxMax.y.toFixed(2)+"] Z["+i.boxMin.z.toFixed(2)+":"+i.boxMax.z.toFixed(2)+"]"),i.resetBoundingBox())}}();function Rx(s,e,t){const i=s.renderer,n=s.targetCubeRaw;if(D.DEV_NEW_RENDER_ARCHITECTURE){const r=e.sideCameras[0];Yi.get().renderCubemap(n,e.position,r.near,r.far)}else for(let r=0;r<6;r+=1){n.activeCubeFace=r;const o=e.sideCameras[r];i.render(s.threeScene,o,n)}}function Ix(s,e,t){const i=255*s/D.LIGHT_PROBE_MIPS_COUNT;for(let n=0;n<4*e*e;n+=4)t[n]=i,t[n+1]=i,t[n+2]=i,t[n+3]=255/8}function Dx(s,e,t){let i=!0;for(;i;){s.readPixels(e,e,t);for(let n=0;n<e*e*4;n+=4)if(t[n]!==0||t[n+1]!==0||t[n+2]!==0){i=!1;break}if(i){console.warn("Cube face has all pixels black.");return}}}function Lx(s,e,t,i,n,r,o,l){D.DEBUG_LIGHT_PROBE_MIPS&&Ix(o,n,r);for(let c=0;c<6;c+=1)D.DEBUG_LIGHT_PROBE_MIPS||(e.uniforms.face.value=c,e.render(s,i,t),Dx(s,n,r)),s.copyFramebufferToCubeFaceMip(o,n,c,r,l)}function cd(s,e){const t={magFilter:ne.LINEAR,minFilter:ne.LINEAR,stencilBuffer:!1,generateMipmaps:!1};this.renderer=s,this.scene=e,this.threeScene=e.threeScene,this.aabbQueryMaterial=new xx,this.filterPass=new Cn(Ax,"envMap");const i=D.LIGHT_PROBE_MAX_MIP_SIZE;this.pixelBuf=new Uint8Array(i*i*4),this.targetCubeRaw=s.createRenderTargetCube(i,i,t),t.depthBuffer=!1,this.targetFiltered=s.createRenderTarget(i,i,t),this.autoClearAlter=new ws(s),this.dispose=function(){this.targetCubeRaw.dispose(),this.targetFiltered.dispose(),this.aabbQueryMaterial.dispose(),this.filterPass.material.dispose(),this.pixelBuf=null}}cd.prototype.constructor=cd;function Fx(s,e,t,i,n){let r;const o=s.renderer;s.autoClearAlter.set(!0,!0,!1),i&&(r=Cx(s,e),n.setMirrorTexture(r)),t&&Qp(s,e,n),Rx(s,e),s.autoClearAlter.restore(),o.enableScissorTest(!0),s.autoClearAlter.set(!1,!1,!1),r=o.createCubeTexture(s.targetFiltered.width,!0),n.setFilteredTexture(r),s.filterPass.uniforms.envMapFiltered.value=r;for(let l=0;l<D.LIGHT_PROBE_MIPS_COUNT;l+=1){const c=Mx(l,s.targetFiltered.width);o.setScissor(0,0,c,c);const d=l/(D.LIGHT_PROBE_MIPS_COUNT-1),u=D.LIGHT_PROBE_GLOSS_FOR_MIP[l];s.filterPass.uniforms.topMipResolution.value=c,s.filterPass.uniforms.roughness.value=d,s.filterPass.uniforms.mipSize.value=c,s.filterPass.uniforms.gloss.value=u,Lx(o,s.filterPass,s.targetCubeRaw,s.targetFiltered,c,s.pixelBuf,l,r)}o.enableScissorTest(!1),s.autoClearAlter.restore()}function Kp(s,e){const t=e.geometry.boundingSphere.center,i=D.ENABLE_REFLECTION_PROBES_BLENDING?D.MAX_BLENDED_REFLECTION_PROBES:1;if(e.lightProbes.length==0){e.lightProbes.push(s);return}const n=t.distanceTo(s.position);for(let r=0;r<e.lightProbes.length;r++){const o=t.distanceTo(e.lightProbes[r].position);if(n<=o){e.lightProbes=[...e.lightProbes.slice(0,r),s,...e.lightProbes.slice(r,Math.min(e.lightProbes.length,i-1))];break}}}function Ox(s,e){for(let t=0;t<e.length;t+=1)Kp(s,e[t])}function Bx(s,e){Le.log("No visible light probe found for "+e.length+" objects. Assigning the closest ones.");for(let t=0;t<e.length;t+=1)for(let i=0;i<s.length;i+=1)Kp(s[i],e[t])}function Nx(s,e,t,i){let n;const r=new cd(e,s),o=new Pr,l=new Yc(.15,s.camera.far);this.assignLightProbesToObjects=function(){o.reset(),n===void 0&&(n=new Sx(e,s.gpuMeshes,s.camera.far));for(let u=0;u<s.gpuMeshes.length;u+=1)s.gpuMeshes[u].lightProbes=[];for(let u=0;u<s.lightProbes.length;u+=1){const h=s.lightProbes[u],f=n.findVisibleObjects(h.position);Le.log("Have visible objects "+f.length),Ox(h,f)}Le.log("Light probe assigment time "+o.elapsedSec());function d(u){return u.lightProbes.length===0}Bx(s.lightProbes,s.gpuMeshes.filter(d))};function c(d,u){l.position.copyFrom(d.position),l.updateMatrixWorld();const h=t&&(i||Tx(s.gpuMeshes,d));h&&Le.log("Mirror texture needed for the light probe."),o.reset(),Fx(r,l,u,h,d),Le.log("Cube generation time "+o.elapsedSec())}this.findBounds=function(d){l.position.copyFrom(d.position),l.updateMatrixWorld(),r.autoClearAlter.set(!0,!0,!1),Qp(r,l,d),r.autoClearAlter.restore()},this.createLightProbeTexture=function(d,u){const h=new Set,f=new Map,p=new Map;qp(s,h,f,p),c(d,u),Yp(s,h,f,p)},this.createAllLightProbeTextures=function(){const d=new Set,u=new Map,h=new Map;qp(s,d,u,h);for(let f=0;f<s.lightProbes.length;f+=1)c(s.lightProbes[f],!1);Yp(s,d,u,h)},this.dispose=function(){r.dispose(),n&&n.dispose()}}class kx extends si{constructor(){super({}),this.lightmapSupported=!1,this.headLight=!0,this.reflective=!1,this.setUniforms()}refreshPerObjectUniforms(e){const t=this.uniforms;return t.baseColor.value=Re.WHITE,!0}}const Ux="outline_vertex.glsl",zx="outline_fragment.glsl";class Vx{constructor(){a(this,"color",new Re);a(this,"thickness",0)}}class Gx extends ai{constructor(e,t){super({vsName:Ux,fsName:zx,uniformBufferDataConstructor:Vx}),this.side=Gi.DOUBLE,this.uniforms={color:{type:"c",value:e,uniformSourceType:ve.MATERIAL},thickness:{type:"f",value:t,uniformSourceType:ve.MATERIAL}},this.fillMaterialUniformDataFromUniforms()}}function va(){const s={uniforms:{inputBuffer:{type:"t",value:null},weight:{type:"f",value:1}},vertexShaderName:"accumulate_vertex.glsl",fragmentShaderName:"accumulate_fragment.glsl"};Cn.call(this,s,"inputBuffer"),this.material.depthTest=!1,this.material.depthWrite=!1,this.material.blending=Hi.CUSTOM,this.material.blendEquation=ne.FUNC_ADD,this.material.blendDst=ne.ONE_MINUS_SRC_ALPHA,this.material.blendSrc=ne.SRC_ALPHA}va.prototype=Object.create(Cn.prototype),va.prototype.constructor=va;function Hx(s,e,t,i,n){const r=s/e,o=Math.tan(oi(n.fov)*.5),l=n.near*o/n.zoom,c=-l,d=c*r,u=l*r,h=(u-d)/s,f=(l-c)/e;n.projectionMatrix.makeFrustum(d-t*h,u-t*h,c-i*f,l-i*f,n.near,n.far)}function Wx(s,e,t,i,n){const r=n.top,o=n.bottom,l=n.left,c=n.right,d=(c-l)/s,u=(o-r)/e;n.projectionMatrix.makeOrthographic(l-t*d,c-t*d,r-i*u,o-i*u,n.near,n.far)}function Zp(s){if(s instanceof hs)return Hx;if(s instanceof Vi)return Wx;console.error("Unsupported camera type")}function jx(){const s={uniforms:{tDiffuse:{type:"t",value:null}},vertexShaderName:"copy_opaque_vertex.glsl",fragmentShaderName:"copy_opaque_fragment.glsl"},e=new Cn(s);return e.renderToScreen=!0,e}function hd(s,e,t){t===void 0&&(e.camera.addEventListener("projectionTypeUpdated",()=>this.updateProjectionType()),t=e.camera.current);let i,n,r=0;const o=[[.375,.4375],[.625,.0625],[.875,.1875],[.125,.0625],[.375,.6875],[.875,.4375],[.625,.5625],[.375,.9375],[.625,.3125],[.125,.5625],[.125,.8125],[.375,.1875],[.875,.9375],[.875,.6875],[.125,.3125],[.625,.8125]],l=new va,c=jx(),d=new ws(s);let u=Zp(t);this.updateProjectionType=()=>{t=e.camera.current,u=Zp(t)},this.reset=function(){r=0},this.renderSample=function(h,f){console.assert(r<o.length),d.set(!0,!0,!1),u(n.width,n.height,o[r][0]-.5,o[r][1]-.5,t),h?s.renderMeshes(h,f,t,i,!0):(console.assert(!(f!==void 0&&h===void 0),"Passing overrideMaterial without passing meshes is not implemented"),s.render(e.threeScene,t,i,!0)),d.restore(),d.set(!1,!1,!1),l.uniforms.weight.value=1/(r+1),l.render(s,n,i),d.restore(),t.updateProjectionMatrix(),r+=1},this.renderedSamplesCount=function(){return r},this.allSamplesRendered=function(){return r===o.length},this.renderAllSamples=function(h,f){for(;!this.allSamplesRendered();)this.renderSample(h,f)},this.renderAccumulatedSamplesToScreen=function(){d.set(!0,!0,!1),c.render(s,void 0,n),d.restore()},this.copyAccumulatedSamplesToBuffer=function(){const h=n.width,f=n.height,p=new Uint8Array(h*f*4);return s.readPixels(h,f,p),p},this.setTargets=function(h,f){console.assert(h.width===f.width&&h.height===f.height),i=h,n=f},this.dispose=function(){l.material.dispose()}}function Xx(s){const e=new Gx(new Re(0,0,0),1),t=new si;return t.sharedMaterialState=s.sharedMaterialState,t.reflective=!1,t.headLight=!1,t.setUniforms(),{outlineMaterial:e,planMaterial:t}}function qx(s,e,t,i){const n=Math.max(s,e),r=Math.max(t.size().x,t.size().y);return n/r*i}function Yx(s,e,t){for(let i=0;i<t;++i)for(let n=0;n<e;++n){const r=4*(i*e+n);if(i<t/2){const o=4*((t-i-1)*e+n);for(let l=0;l<4;++l){const c=s[r+l];s[r+l]=s[o+l],s[o+l]=c}}}}function $p(s,e){return console.assert(e%4===0,"id passed does not point to alpha channel"),s[e+3]!==0}function Jp(s,e){return console.assert(e%4===0,"id passed does not point to alpha channel"),s[e+3]<255}function Qx(s,e,t){return s[t+3]<255&&s[t+3]>=s[e+3]}function Kx(s,e){for(let t=0;t<s.length;t+=4)if($p(e,t)){const i=e[t+3]/255;for(let n=0;n<3;++n)s[t+n]=s[t+n]*(1-i)+e[t+n]*i;s[t+3]=255}}function Zx(s,e=void 0){const t=new Uint8Array(s.length);for(let i=0;i<s.length;i+=4)if($p(s,i)&&(!e||Jp(e,i)))for(let n=0;n<4;++n)t[i+n]=255;return t}function $x(s,e,t){return s[t]===0&&Jp(e,t)}function Jx(s,e,t,i){return s[i]===0&&Qx(e,t,i)}function em(s,e,t){e[s]=1,t.push(s)}function e1(s,e,t,i,n){for(let r=0;r<e.length;++r)Jx(t,i,s,s+e[r])&&em(s+e[r],t,n)}function t1(s,e,t,i){const n=[],r=[];for(em(s,t,r);r.length;){const o=r.pop();n.push(o),e1(o,e,t,i,r)}return n}function i1(s,e,t){for(let i=0;i<s.length;++i)t[s[i]]=255*e.r,t[s[i]+1]=255*e.g,t[s[i]+2]=255*e.b,t[s[i]+3]=255}function n1(s,e,t,i=.02){const n=new Uint8Array(e.length),r=e.length/4*i,o=[-4,4,-s*4,s*4];for(let l=0;l<e.length;l+=4)if($x(n,e,l)){const c=t1(l,o,n,e);c.length<r&&i1(c,t,e)}return e}function dd(s,e,t){return s.createRenderTarget(e,t,{magFilter:ne.NEAREST,minFilter:ne.NEAREST,stencilBuffer:!1,generateMipmaps:!1})}function ud(s,e,t){s.near=e,s.far=t,s.updateProjectionMatrix()}function s1(s,e){const t={uniforms:{tColor:{type:"t",value:null},tAlpha:{type:"t",value:null},colorFill:{type:"c",value:null}},vertexShaderName:"minimap_add_alpha_vertex.glsl",fragmentShaderName:"minimap_add_alpha_fragment.glsl"},i=new Cn(t,"tColor");return i.uniforms.tAlpha.value=s,e&&(i.material.condDefine(!0,"USE_ALPHA_FROM_COLOR"),i.uniforms.colorFill.value=e),i}function r1(s,e){const i=new Re(1,1,1),n=Xx(e);function r(c,d,u,h,f,p,m){const b=new Uint8Array(d.width*d.height*4);if(D.DEV_NEW_RENDER_ARCHITECTURE)return b;const _=new ws(s),y=new fl(s);_.set(!0,!0,!1),y.set(new Re(0),0);const A=[];if(e.gpuMeshes.forEach(T=>{(T.logicalMeshes||[T]).forEach(C=>{const N=f?!C.node.disableCollisions:!0;(h?!C.material.transparent:!0)&&N&&A.push(C)})}),p){const T=dd(s,d.width,d.height),M=dd(s,d.width,d.height),C=new hd(s,e,c);C.setTargets(T,M),C.renderAllSamples(A,u);const N=s1(T,m);_.restore(),_.set(!0,!0,!1),N.render(s,d,M),_.restore(),s.readPixels(d.width,d.height,b),T.dispose(),M.dispose(),C.dispose()}else s.renderMeshes(A,u,c,d),_.restore(),s.readPixels(d.width,d.height,b);return y.restore(),Yx(b,d.width,d.height),b}function o(c,d,u,h,f){const p=qx(h,f,u,.1),m=c/p;n.outlineMaterial.setUniform("thickness","f",m),n.outlineMaterial.setUniform("color","c",d)}this.createMinimapImageDataComponents=function(c,d,u,h){o(c.outlineThickness,i,e.boundingBox,u,h);const f=d.cropRange.center(),p=dd(s,u,h),m=new Vi(d.visibleRange.min.x-f.x,d.visibleRange.max.x-f.x,d.visibleRange.min.y-f.y,d.visibleRange.max.y-f.y,0,10);m.rotation.set(0,0,d.rotation*-1),m.position.set(f.x,f.y,d.slicePlaneHeight),m.updateMatrixWorld(!0),ud(m,0,d.slicePlaneHeight-d.farPlaneHeight);const b=r(m,p,n.planMaterial,!0,!0,!0);let _;e.minimapConfig.outlineThickness>0&&(ud(m,0,.1),_=r(m,p,n.outlineMaterial,!0,!0,!0,c.outlineColor),e.minimapConfig.fillEnabled&&n1(u,_,c.outlineColor),Kx(b,_)),p.dispose();const y=Zx(b,_),A=new Uint8ClampedArray(b.buffer),T=new ImageData(A,u,h),M=new Uint8ClampedArray(y.buffer),C=new ImageData(M,u,h);return{minimapImageData:T,walkableImageData:C}};function l(c,d,u){o(c.outlineThickness,c.outlineColor,e.collisionBoundingBox,d,u);const h=s.createRenderTarget(d,u,{magFilter:ne.NEAREST,minFilter:ne.NEAREST,stencilBuffer:!1,generateMipmaps:!1}),f=new Vi(e.collisionBoundingBox.min.x,e.collisionBoundingBox.max.x,e.collisionBoundingBox.max.y,e.collisionBoundingBox.min.y,0,10);f.position.set(0,0,c.slicePlaneHeight),f.updateMatrixWorld(!0),ud(f,0,.1);const p=r(f,h,n.outlineMaterial,!1,!0);h.dispose();const m=new Uint8ClampedArray(p.buffer);return new ImageData(m,d,u)}this.getCollisionData=function(c,d,u){const h={x:{min:0,max:d},y:{min:0,max:u}},f={x:{min:e.collisionBoundingBox.min.x,max:e.collisionBoundingBox.max.x},y:{min:e.collisionBoundingBox.max.y,max:e.collisionBoundingBox.min.y}};return{collisionImageData:l(c,d,u),canvasRange:h,collisionRange:f}},this.calculateRenderSize=function(c,d){const u=d.empty()?1:d.size().y/d.size().x,h=u<1?c:Math.round(c*(1/u)),f=u<1?Math.round(c*u):c;return{width:h,height:f}}}function tm(s,e,t){this.scene=s,this.camera=e,this.overrideMaterial=t,this.enabled=!0,this.clear=!0,this.needsSwap=!0}tm.prototype={render:function(s,e,t,i){var n=this.scene.overrideMaterial;this.overrideMaterial&&(this.scene.overrideMaterial=this.overrideMaterial),s.render(this.scene,this.camera,e,this.clear),this.scene.overrideMaterial=n}};const o1={uniforms:{tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new Ue(1/1024,1/512)}},vertexShaderName:"fxaa_vertex.glsl",fragmentShaderName:"fxaa_fragment.glsl"};class a1{constructor(){this.shaderPass=new Cn(o1),this.shaderPass.clear=!1,this.shaderPass.renderToScreen=!1,this.shaderPass.material.depthTest=!1,this.shaderPass.material.depthWrite=!1,this.shaderPass.uniforms.resolution.value.set(1/window.innerWidth,1/window.innerHeight)}get renderToScreen(){return this.shaderPass.renderToScreen}set renderToScreen(e){this.shaderPass.renderToScreen=e}onResize(e,t){this.shaderPass.uniforms.resolution.value.set(1/e,1/t)}update(){}}const l1={uniforms:{tDepth:{type:"t",value:null},tDiffuse:{type:"t",value:null},resolution:{type:"v2",value:new Ue(1/1024,1/512)},delta:{type:"f",value:1},velocityFactor:{type:"f",value:.5},cameraMove:{type:"v3",value:new B(0,0,0)},clipToWorldMatrix:{type:"m4",value:new je},previousWorldToClipMatrix:{type:"m4",value:new je}},vertexShaderName:"motion_blur_vertex.glsl",fragmentShaderName:"motion_blur_fragment.glsl"};class im{constructor(e){this.camera=e,this.shaderPass=new Cn(l1),this.shaderPass.clear=!1,this.shaderPass.renderToScreen=!1,this.shaderPass.material.depthTest=!0,this.shaderPass.material.depthWrite=!0,this.shaderPass.uniforms.resolution.value.set(1/(window.innerWidth*window.devicePixelRatio),1/(window.innerHeight*window.devicePixelRatio)),this.shaderPass.uniforms.velocityFactor.value=e.motionBlurIntensity,this.previousMatrixWorldInverse=new je,this.previousProjectionMatrix=new je,this.previousCameraPosition=new B,this.cameraPosition=new B,this.inverseProjectionMatrix=new je}get renderToScreen(){return this.shaderPass.renderToScreen}set renderToScreen(e){this.shaderPass.renderToScreen=e}set intensity(e){this.shaderPass.uniforms.velocityFactor.value=e}onResize(e,t){this.shaderPass.uniforms.resolution.value.set(1/e,1/t)}update(e){this.shaderPass.uniforms.delta.value=e,this.shaderPass.uniforms.clipToWorldMatrix.value.getInverse(this.camera.matrixWorldInverse).multiply(this.inverseProjectionMatrix.getInverse(this.camera.projectionMatrix)),this.shaderPass.uniforms.previousWorldToClipMatrix.value.copyFrom(this.previousProjectionMatrix.multiply(this.previousMatrixWorldInverse)),this.shaderPass.uniforms.cameraMove.value.copyFrom(this.camera.position).sub(this.previousCameraPosition),this.camera.updateMatrixWorld(),this.camera.matrixWorld.getTranslation(this.cameraPosition),this.previousMatrixWorldInverse.copyFrom(this.camera.matrixWorldInverse),this.previousProjectionMatrix.copyFrom(this.camera.projectionMatrix),this.previousCameraPosition.copyFrom(this.cameraPosition)}}const nm={minFilter:ne.LINEAR,magFilter:ne.LINEAR,depthBuffer:!0,useDepthTexture:!0,stencilBuffer:!1,generateMipmaps:!1};class c1 extends kt{constructor(e,t,i){super(),this.renderer=e,this.camera=i,this.scene=t,this.renderModel=new tm(t,i),this.renderTarget1=null,this.renderTarget2=null,this.passes=[],this.postProcessChain=[],i.addEventListener("motionBlurUpdated",()=>this.updateMotionBlur())}get isEnabled(){return this.postProcessChain.length>0}init(){this.configureTarget(1024,1024,nm),this.passes.push(this.renderModel)}onResize(e,t){this.renderer&&(this.configureTarget(e,t,nm),this.ssaa&&this.ssaa.setTargets(this.renderTarget1,this.renderTarget2)),this.postProcessChain.forEach(i=>{i.onResize(e,t)})}removePostProcess(e){this.passes=this.passes.filter(t=>t!==e.shaderPass),this.postProcessChain=this.postProcessChain.filter(t=>t!==e)}disposeTarget(){this.renderTarget1&&(this.renderTarget1.dispose(),this.renderTarget1=null),this.renderTarget2&&(this.renderTarget2.dispose(),this.renderTarget2=null)}configureTarget(e,t,i){this.disposeTarget(),this.renderTarget1=this.renderer.createRenderTarget(e,t,i),this.renderTarget2=this.renderer.createRenderTarget(e,t,i)}setup(){this.isEnabled&&(this.renderer.autoClear=!1,this.postProcessChain.forEach((e,t,i)=>{e.renderToScreen=t===i.length-1}))}render(e){let t=this.renderTarget1,i=this.renderTarget2;this.passes.filter(n=>n.enabled).forEach(n=>{n.render(this.renderer,t,i,e),n.needsSwap&&n!==this.passes.at(-1)&&([t,i]=[i,t])})}update(e){this.postProcessChain.forEach(t=>{t.update(e)}),this.render(e)}updateMotionBlur(){const e=this.postProcessChain.find(n=>n instanceof im),t=e&&!this.camera.motionBlurEnabled,i=!e&&this.camera.motionBlurEnabled;t&&(this.removePostProcess(e),this.setup()),i&&(this.addMotionBlur(),this.setup()),e&&(e.intensity=this.camera.motionBlurIntensity)}addFXAA(){const e=new a1;this.passes.push(e.shaderPass),this.postProcessChain.push(e)}addMotionBlur(){const e=new im(this.camera);this.passes.push(e.shaderPass),this.postProcessChain.push(e)}addSSAA(e){this.ssaa=new hd(this.renderer,e)}resetSSAA(){this.ssaa&&this.ssaa.reset()}updateSSAA(){return this.ssaa?(this.ssaa.renderSample(),this.ssaa.renderedSamplesCount()>=4&&this.ssaa.renderAccumulatedSamplesToScreen(),!this.ssaa.allSamplesRendered()):!1}}function yo(s,e,t){var i;this.x=0,this.y=0,this.width=s,this.height=e,t=t||{},this.wrapS=t.wrapS!==void 0?t.wrapS:ne.CLAMP_TO_EDGE,this.wrapT=t.wrapT!==void 0?t.wrapT:ne.CLAMP_TO_EDGE,this.magFilter=t.magFilter!==void 0?t.magFilter:ne.LINEAR,this.minFilter=t.minFilter!==void 0?t.minFilter:ne.LINEAR_MIPMAP_LINEAR,this.anisotropy=t.anisotropy!==void 0?t.anisotropy:1,this.offset=new Ue(0,0),this.repeat=new Ue(1,1),this.format=(i=t.format)!=null?i:nt.RGBA8,this.depthBuffer=t.depthBuffer!==void 0?t.depthBuffer:!0,this.stencilBuffer=t.stencilBuffer!==void 0?t.stencilBuffer:!0,this.generateMipmaps=t.generateMipmaps||!1,this.shareDepthFrom=t.shareDepthFrom!==void 0?t.shareDepthFrom:null,this.isCube=!1,this.loaded=!0,this.useDepthTexture=t.useDepthTexture!==void 0?t.useDepthTexture:!1,this.depthTexture=null,this.webglFramebuffer=null,this.webglRenderbuffer=null,this.webglTexture=null,this.webglSlot=null}yo.prototype={constructor:yo,dispose:function(){this.dispatchEvent({type:"dispose"})}},kt.prototype.apply(yo.prototype);function jl(s){this.webglFramebuffer=s,this.x=null,this.y=null,this.width=null,this.height=null,this.isCube=!1}jl.prototype={constructor:jl,dispose:function(){this.webglFramebuffer=null,this.dispatchEvent({type:"dispose"})}},kt.prototype.apply(jl.prototype);function Xl(s,e,t){yo.call(this,s,e,t),this.activeCubeFace=0,this.isCube=!0,this.webglFramebuffer=[],this.webglRenderbuffer=[]}Xl.prototype=Object.create(yo.prototype),Xl.prototype.constructor=Xl;function h1(s){return s.split(`
`).map((t,i)=>i+1+": "+t).join(`
`)}function sm(s,e,t,i){const n=s.createShader(e);s.shaderSource(n,t),s.compileShader(n);const r=s.getShaderParameter(n,s.COMPILE_STATUS)===!1;if(r&&console.error(`Shader '${i}' failed to compile.`),r||D.LOG_INFO){const o=s.getShaderInfoLog(n);o!==""&&console.warn(`Shader '${i}' info log: `,o,h1(t))}return n}const rm=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition"];let d1=0;function u1(s,e){const t={};for(let i=0,n=rm.length;i<n;i++){const r=rm[i];t[r]=s.getUniformLocation(e,r)}return t}function f1(s,e,t){const i={i:[],f:[],v2:[],v3:[],c:[],v4:[],m4:[],t:[]};let n;for(let r in t)if(t.hasOwnProperty(r)){const o=s.getUniformLocation(e,r);if(o){const c=t[r].type;console.assert(i.hasOwnProperty(c)),c==="i"||c==="f"||c==="t"?n=null:c==="v2"?n=[null,null]:c==="v3"||c==="c"?n=[null,null,null]:c==="v4"?n=[null,null,null,null]:c==="m4"?n=null:console.assert(!1),i[c].push({id:r,value:n,location:o})}}return i}function p1(s,e,t){const i={};for(let n=0,r=t.length;n<r;n++){const o=t[n];i[o]=s.getAttribLocation(e,o)}return i}function m1(){return this.recompileProgram=function(s,e){this.program&&s.deleteProgram(this.program);const t=e.index0AttributeName,i=s.createProgram(),n=sm(s,s.VERTEX_SHADER,e.generateVertexShader(),e.vertexShaderName),r=sm(s,s.FRAGMENT_SHADER,e.generateFragmentShader(),e.fragmentShaderName);s.attachShader(i,n),s.attachShader(i,r),t!==void 0&&s.bindAttribLocation(i,0,t),s.linkProgram(i);const o=s.getProgramInfoLog(i).trim();if(s.getProgramParameter(i,s.LINK_STATUS)===!1)console.error("Shader link error: "+s.getError(),"validate status: ",s.getProgramParameter(i,s.VALIDATE_STATUS));else for(const l in Object.keys(zn))if(Object.prototype.hasOwnProperty.call(zn,l)){const c=zn[l];s.getUniformBlockIndex(i,c)}o!==""&&o!=="\0"&&console.warn("program info log: "+o),s.deleteShader(n),s.deleteShader(r),this.transformUniformCache=u1(s,i),this.materialUniformCache=f1(s,i,e.uniforms),this.attributes=p1(s,i,e.attributes),this.attributesKeys=Object.keys(this.attributes),this.program=i},this.id=d1++,this.usedTimes=1,this}function g1(s){const e=new Map;this.recompileProgram=function(t){const i=t.generateProgramId();let n=e[i];n?n.recompileProgram(s,t):console.error("Couldn't find program to recompile!")},this.assignProgramToMaterial=function(t){console.assert(t instanceof ai);const i=t.generateProgramId();let n=e[i];n?n.usedTimes++:(n=new m1,n.recompileProgram(s,t),e[i]=n),t.program&&this.resetProgramAssignment(t),t.program=n},this.resetProgramAssignment=function(t){const i=t.program;if(t.program=null,i.usedTimes-=1,i.usedTimes===0){for(let n in e)if(e.hasOwnProperty(n)&&e[n]===i){delete e[n];break}s.deleteProgram(i.program)}}}function _1(s){const n=new Array(16).fill(0),r=new Array(16).fill(null),o=n.map(()=>0);let l=null,c=null,d=null,u=null,h=null,f=null,p=null,m=null,b=null,_=null,y=null,A=null;const T={x:null,y:null,width:null,height:null};this.resetAttributeStates=function(){for(let M=0,C=n.length;M<C;M++)n[M]=0},this.disableAttributeStates=function(){for(let M=0,C=n.length;M<C;M++)s.disableVertexAttribArray(M),n[M]=0},this.enableAttributeArray=function(M){n[M]!==2&&(s.enableVertexAttribArray(M),n[M]=2)},this.disableAttributeArray=function(M,C){n[M]!==1&&(s.disableVertexAttribArray(M),n[M]=1),r[M]!==C&&(C.length===2?s.vertexAttrib2fv(M,C):C.length===3?s.vertexAttrib3fv(M,C):C.length===4&&s.vertexAttrib4fv(M,C),r[M]=C)},this.resetAttributeDivisors=function(){for(let M=0,C=o.length;M<C;M++)o[M]&&(s.vertexAttribDivisor(M,0),o[M]=0)},this.setAttributeDivisor=function(M,C){s.vertexAttribDivisor(M,C),o[M]=C},this.setBlending=function(M){const C=M.blending;if(C!==l&&(C===Hi.DISABLED?s.disable(s.BLEND):C===Hi.ADDITIVE?(s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.SRC_ALPHA,s.ONE)):C===Hi.SUBTRACTIVE?(s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ZERO,s.ONE_MINUS_SRC_COLOR)):C===Hi.MULTIPLY?(s.enable(s.BLEND),s.blendEquation(s.FUNC_ADD),s.blendFunc(s.ZERO,s.SRC_COLOR)):C===Hi.CUSTOM?s.enable(s.BLEND):(C==Hi.NORMAL,s.enable(s.BLEND),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA)),l=C),C===Hi.CUSTOM){const N=M.blendEquation,O=M.blendEquationAlpha||N,q=M.blendSrc,j=M.blendDst,K=M.blendSrcAlpha||q,de=M.blendDstAlpha||j;(N!==c||O!==h)&&(s.blendEquationSeparate(N,O),c=N,h=O),(q!==d||j!==u||K!==f||de!==p)&&(s.blendFuncSeparate(q,j,K,de),d=q,u=j,f=K,p=de)}else c=null,d=null,u=null,h=null,f=null,p=null},this.setDepthTest=function(M){m!==M&&(M?s.enable(s.DEPTH_TEST):s.disable(s.DEPTH_TEST),m=M)},this.setDepthWrite=function(M){b!==M&&(s.depthMask(M),b=M)},this.setColorWrite=function(M){_!==M&&(s.colorMask(M,M,M,M),_=M)},this.setDoubleSided=function(M){y!==M&&(M?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),y=M)},this.setFlipSided=function(M){A!==M&&(M?s.frontFace(s.CW):s.frontFace(s.CCW),A=M)},this.setViewport=function(M,C,N,O){const q=T;(q.x!==M||q.y!==C||q.width!==N||q.height!==O)&&(s.viewport(M,C,N,O),q.x=M,q.y=C,q.width=N,q.height=O)}}function v1(){this.texture=null,this.locked=!1,this.usedCount=0}function b1(s){const e=[];for(let t=0;t<s;t+=1)e[t]=new v1;return e}function y1(s){const e=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS),t=b1(e);this.setSlot=function(i,n){let r=i.webglSlot,o;if(r!==null)return o=t[r],o.usedCount+=1,o.locked=o.locked||n,!1;let l=1/0;for(let c=0;c<e;c+=1)o=t[c],!o.locked&&o.usedCount<l&&(l=o.usedCount,r=c);return r===null&&(console.warn("Not enough texture units"),r=0),o=t[r],o.texture&&(o.texture.webglSlot=null),o.texture=i,o.usedCount=1,o.locked=n,i.webglSlot=r,!0},this.unlockAllSlots=function(){for(let i=0;i<e;i+=1)t[i].locked=!1},this.freeSlot=function(i){if(i.webglSlot!==null){const n=t[i.webglSlot];i.webglSlot=null,n.texture=null,n.locked=!1,n.usedCount=0}},this.freeAllSlots=function(){for(let i=0;i<e;i+=1){const n=t[i];n.texture&&(n.texture.webglSlot=null,n.texture=null,n.locked=!1,n.usedCount=0)}}}function x1(s){const e=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);let t=0;this.setSlot=function(i,n){return t===e&&(console.warn("Not enough texture units"),t=0),i.webglSlot=t,n&&(t+=1),!0},this.unlockAllSlots=function(){t=0},this.freeSlot=function(i){i.webglSlot=null},this.freeAllSlots=function(){}}function ql(s,e,t,i,n){if(Vo(i)){s.compressedTexImage2D(e,t,i,n.width,n.height,0,n.data);return}const r=bu(i),o=yu(i);n instanceof Go?s.texImage2D(e,t,i,n.width,n.height,0,r,o,n.data):s.texImage2D(e,t,i,r,o,n)}function ba(s,e,t,i,n,r,o){const l=bu(i),c=yu(i);Vo(i),s.texImage2D(e,t,i,n,r,0,l,c,o)}function A1(s){const e={COMPRESSED_RGB_S3TC_DXT1_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT1_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT3_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGBA_S3TC_DXT5_EXT:"WEBGL_compressed_texture_s3tc",COMPRESSED_RGB_PVRTC_4BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGB_PVRTC_2BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:"WEBGL_compressed_texture_pvrtc",COMPRESSED_RGB_ETC1_WEBGL:"WEBGL_compressed_texture_etc1",COMPRESSED_RGBA_ASTC_4x4_KHR:"WEBGL_compressed_texture_astc"};for(let[t,i]of Object.entries(ne)){const n=e[t];if(n!==void 0){const r=it.gl.extension(n);r&&console.assert(r[t]===i)}else console.assert(s[t]===i)}}function E1(s){return it.gl.disableTextureSlotReuse?new x1(s):new y1(s)}function w1(s,e){let t=new Re(0),i=0;const n=[],r=[];this.domElement=s,this.renderContext=e,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0;const o=this;let l,c,d,u,h,f,p;const m=new Kr,b=new je,_=new B;this.recompileProgram=function(U){p.recompileProgram(U)},this.getProgramStore=function(){return p},this.getGl=function(){return e},this.getState=function(){return f};function y(U,z,G,X){e.clearColor(U,z,G,X)}function A(){l=null,c=null,d=-1,u=null,h=null,f=new _1(e),p=new g1(e),e.clearColor(0,0,0,1),e.clearDepth(1),e.clearStencil(0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.frontFace(e.CCW),e.cullFace(e.BACK),e.enable(e.CULL_FACE),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),f.setViewport(0,0,s.width,s.height),y(t.r,t.g,t.b,i),it.ie||e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE)}A(),A1(e),this.webGLContextRestored=function(){A()},this.context=e,this.state=f;const T=E1(e),M=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setCanvasSize=function(U,z){s.width=U,s.height=z,c===null&&this.setViewport(0,0,U,z)},this.setViewport=function(U,z,G,X){f.setViewport(U,z,G,X)},this.setScissor=function(U,z,G,X){e.scissor(U,z,G,X)},this.enableScissorTest=function(U){U?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST)},this.setClearColor=function(U,z){t.copyFrom(U),i=z!==void 0?z:1,y(t.r,t.g,t.b,i)},this.getClearColor=function(){return t},this.getClearAlpha=function(){return i},this.getTextureSlotter=function(){return T},this.clear=function(U,z,G){let X=0;U&&(X|=e.COLOR_BUFFER_BIT),z&&(X|=e.DEPTH_BUFFER_BIT),G&&(X|=e.STENCIL_BUFFER_BIT),e.clear(X)},this.clearColor=function(){e.clear(e.COLOR_BUFFER_BIT)},this.clearDepth=function(){e.clear(e.DEPTH_BUFFER_BIT)},this.clearStencil=function(){e.clear(e.STENCIL_BUFFER_BIT)};function C(U){const z=U.attributes;for(const G in U.attributesKeys)if(z.hasOwnProperty(G)){const X=z[G];X!==void 0&&X.buffer!==void 0&&(e.deleteBuffer(X.buffer),delete X.buffer)}f.disableAttributeStates(),u=null}function N(U){T.freeSlot(U),U.webglTexture&&(e.deleteTexture(U.webglTexture),U.webglTexture=null)}this.deallocateRenderTargetRenderingBuffers=function(U){if(U.isCube)for(let z=0;z<6;z++)e.deleteFramebuffer(U.webglFramebuffer[z]),e.deleteRenderbuffer(U.webglRenderbuffer[z]);else e.deleteFramebuffer(U.webglFramebuffer),e.deleteRenderbuffer(U.webglRenderbuffer);U.webglFramebuffer=null,U.webglRenderbuffer=null};function O(U){T.freeSlot(U),e.deleteTexture(U.webglTexture),U.webglTexture=null,U.webglFramebuffer&&o.deallocateRenderTargetRenderingBuffers(U)}function q(U){U.setOnDispose(void 0),C(U)}function j(U){const z=U.target;z.removeEventListener("dispose",j),N(z)}function K(U){const z=U.target;z.removeEventListener("dispose",K),O(z)}function de(U){const z=U.target;z.removeEventListener("dispose",de),p.resetProgramAssignment(z)}this.getOnMaterialDispose=function(){return de};function xe(U,z,G){const X=G.attributes,_e=z.attributes,Ie=z.attributesKeys,Ye=(G.instanceId||0)*4*4;for(let ke=0,ge=Ie.length;ke<ge;ke++){const Qe=Ie[ke],ue=_e[Qe];if(ue>=0){const Ae=X[Qe];if(Ae!==void 0){const Se=Ae.itemSize,We=Ae.glType;Ae.buffer,e.bindBuffer(e.ARRAY_BUFFER,Ae.buffer),f.enableAttributeArray(ue);const rt=Ae.divisor||0;let bt=Ye*rt;G.vertexAttribOffset&&(bt+=G.vertexAttribOffset*Ae.glTypeSize*Se),e.vertexAttribPointer(ue,Se,We,!1,0,bt),f.setAttributeDivisor(ue,rt)}else{const Se=(G.defaultAttributeValues?G.defaultAttributeValues[Qe]:void 0)||U.defaultAttributeValues[Qe];f.disableAttributeArray(ue,Se)}}}}function Ve(U,z){e.texParameteri(U,e.TEXTURE_WRAP_S,z.wrapS),e.texParameteri(U,e.TEXTURE_WRAP_T,z.wrapT),e.texParameteri(U,e.TEXTURE_MAG_FILTER,z.magFilter),e.texParameteri(U,e.TEXTURE_MIN_FILTER,z.minFilter);const G=it.gl.extension("EXT_texture_filter_anisotropic");G&&z.anisotropy>1&&e.texParameterf(U,G.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(z.anisotropy,it.gl.maxAnisotropy))}function qe(U,z){const G=U.material,X=z.material,_e=G.program,Ie=X.program;return _e&&Ie&&_e.id!==Ie.id?_e.id-Ie.id:G.id-X.id||U.id-z.id}function k(U,z){const G=U.material.transparentRenderOrder-z.material.transparentRenderOrder;return G||z.cameraDistance-U.cameraDistance||U.id-z.id}function Q(U,z){(z||U.material).transparent?(o.sortObjects===!0&&(U.cameraDistance=m.nearPlaneDistanceToCenter(U)),r.push(U)):n.push(U)}function le(U,z,G){if(!(!G&&U.visible===!1)){U instanceof Je&&(U.frustumCulled===!1||m.intersectsObject(U)===!0)&&Q(U,z);for(let X=0,_e=U.children.length;X<_e;X++)le(U.children[X],z,G)}}this.setCubeTexture=function(U){if(e.activeTexture(e.TEXTURE0+U.webglSlot),e.bindTexture(e.TEXTURE_CUBE_MAP,U.webglTexture),U.needsUpdate){e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,U.flipY);const z=Vo(U.format),G=U.image;Ve(e.TEXTURE_CUBE_MAP,U);for(let X=0;X<6;X++)if(!z)ql(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+X,0,U.format,G[X]),U.releaseOnLoadedToGpu&&(G[X]=null);else{const _e=G[X].mipmaps;for(let Ie=0,Ye=_e.length;Ie<Ye;Ie++){const ke=_e[Ie];ql(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+X,Ie,U.format,ke),U.releaseOnLoadedToGpu&&(ke.data=null)}}U.generateMipmaps&&e.generateMipmap(e.TEXTURE_CUBE_MAP),U.needsUpdate=!1}};const ae=new je,Ee=new ys;function te(U,z,G){let X;z.matrixWorld?(ae.multiplyMatrices(U.matrixWorldInverse,z.matrixWorld),X=ae):X=U.matrixWorldInverse,e.uniformMatrix4fv(G.modelViewMatrix,!1,X.elements),G.normalMatrix&&(Ee.getNormalMatrix(X),e.uniformMatrix3fv(G.normalMatrix,!1,Ee.elements)),G.modelMatrix!==null&&(z.matrixWorld?e.uniformMatrix4fv(G.modelMatrix,!1,z.matrixWorld.elements):e.uniformMatrix4fv(G.modelMatrix,!1,M))}this.setMaterialFaces=function(U){f.setDoubleSided(U.side===Gi.DOUBLE),f.setFlipSided(U.side===Gi.BACK)};function me(U,z=void 0){U.webglTexture||(U.addEventListener("dispose",j),U.webglTexture=e.createTexture()),e.activeTexture(e.TEXTURE0+(z!=null?z:U.webglSlot)),e.bindTexture(e.TEXTURE_2D,U.webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,U.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,U.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,U.unpackAlignment),Ve(e.TEXTURE_2D,U);const G=U.mipmaps;if(G.length>0){for(let X=0,_e=G.length;X<_e;X++)ql(e,e.TEXTURE_2D,X,U.format,G[X]);U.releaseOnLoadedToGpu&&(U.mipmaps=void 0),U.generateMipmaps=!1}else ql(e,e.TEXTURE_2D,0,U.format,U.image),U.releaseOnLoadedToGpu&&(U.image=void 0);U.generateMipmaps&&e.generateMipmap(e.TEXTURE_2D),U.needsUpdate=!1}this.setTexture=function(U,z=void 0){U.needsUpdate?me(U,z):(e.activeTexture(e.TEXTURE0+(z!=null?z:U.webglSlot)),e.bindTexture(e.TEXTURE_2D,U.webglTexture))},this.setRenderTarget=function(U){let z,G,X,_e,Ie;U?(U.isCube?z=U.webglFramebuffer[U.activeCubeFace]:z=U.webglFramebuffer,G=U.x,X=U.y,_e=U.width,Ie=U.height):(z=null,G=0,X=0,_e=s.width,Ie=s.height),z!==c&&(e.bindFramebuffer(e.FRAMEBUFFER,z),c=z),f.setViewport(G,X,_e,Ie)},this.loadMaterialUniforms=function(U,z){let G,X,_e,Ie,Ye,ke,ge,Qe,ue,Ae,Se,We,rt;for(G=U.materialUniformCache.i,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,Ie=z[_e].value,X.value!==Ie&&(e.uniform1i(X.location,Ie),X.value=Ie);for(G=U.materialUniformCache.f,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,Ie=z[_e].value,X.value!==Ie&&(e.uniform1f(X.location,Ie),X.value=Ie);for(G=U.materialUniformCache.v2,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,Ie=z[_e].value,Ye=Ie.x,ke=Ie.y,(X.value[0]!==Ye||X.value[1]!==ke)&&(e.uniform2f(X.location,Ye,ke),X.value[0]=Ye,X.value[1]=ke);for(G=U.materialUniformCache.v3,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,Ie=z[_e].value,Ye=Ie.x,ke=Ie.y,ge=Ie.z,(X.value[0]!==Ye||X.value[1]!==ke||X.value[2]!==ge)&&(e.uniform3f(X.location,Ye,ke,ge),X.value[0]=Ye,X.value[1]=ke,X.value[2]=ge);for(G=U.materialUniformCache.c,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,Ie=z[_e].value,Ye=Ie.r,ke=Ie.g,ge=Ie.b,(X.value[0]!==Ye||X.value[1]!==ke||X.value[2]!==ge)&&(e.uniform3f(X.location,Ye,ke,ge),X.value[0]=Ye,X.value[1]=ke,X.value[2]=ge);for(G=U.materialUniformCache.v4,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,Ie=z[_e].value,Ye=Ie.x,ke=Ie.y,ge=Ie.z,Qe=Ie.w,(X.value[0]!==Ye||X.value[1]!==ke||X.value[2]!==ge||X.value[3]!==Qe)&&(e.uniform4f(X.location,Ye,ke,ge,Qe),X.value[0]=Ye,X.value[1]=ke,X.value[2]=ge,X.value[3]=Qe);for(G=U.materialUniformCache.m4,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,e.uniformMatrix4fv(X.location,!1,z[_e].value.elements);for(G=U.materialUniformCache.t,Ae=0,Se=G.length;Ae<Se;Ae+=1)X=G[Ae],_e=X.id,ue=z[_e].value,ue&&(We=T.setSlot(ue,!0),rt=ue.webglSlot,X.value!==rt&&(e.uniform1i(X.location,rt),X.value=rt),(We||ue.needsUpdate)&&(ue.isCube?this.setCubeTexture(ue):this.setTexture(ue)));T.unlockAllSlots()},this.resetState=function(){T.unlockAllSlots(),A()},this.setMaterial=function(U){f.setBlending(U),f.setDepthTest(U.depthTest),f.setDepthWrite(U.depthWrite),f.setColorWrite(U.colorWrite)},this.setProgram=function(U,z,G){console.assert(z instanceof ai),z.programNeedsUpdate&&(p.assignProgramToMaterial(z),z.addEventListener("dispose",de),z.programNeedsUpdate=!1),console.assert(!z.morphTargets);let X=!1,_e=!1;const Ie=z.program,Ye=Ie.transformUniformCache;return Ie.id!==l&&(e.useProgram(Ie.program),l=Ie.id,X=!0,_e=!0),z.id!==d&&(d=z.id,_e=!0),X&&(e.uniformMatrix4fv(Ye.projectionMatrix,!1,U.projectionMatrix.elements),Ye.cameraPosition!==null&&(U.matrixWorld.getTranslation(_),e.uniform3f(Ye.cameraPosition,_.x,_.y,_.z)),Ye.viewMatrix!==null&&e.uniformMatrix4fv(Ye.viewMatrix,!1,U.matrixWorldInverse.elements)),(X||G.matrixWorld!==h)&&(h=G.matrixWorld,te(U,G,Ye)),z.refreshPerObjectUniforms&&z.refreshPerObjectUniforms(G)&&(_e=!0),z.renderSteps>1&&(_e=!0),_e&&this.loadMaterialUniforms(Ie,z.uniforms),Ie},this.renderBufferDirect=function(U,z,G,X){if(z.visible===!1||G.vertexCnt===0)return;const _e=this.setProgram(U,z,X);let Ie=!1;(G.id!==u||_e.id!==l)&&(u=G.id,Ie=!0),console.assert(X instanceof Je);const Ye=e.TRIANGLES,ke=G.attributes.index;if(ke){const ge=ke.glType,Qe=G.indexUint?4:2;Ie&&(xe(z,_e,G),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,ke.buffer));let ue,Ae;G.indexOffset!==void 0?(ue=G.indexCnt,Ae=Qe*G.indexOffset):(ue=ke.length,Ae=0),G.isInstanced?e.drawElementsInstanced(Ye,ue,ge,Ae,G.instanceCount):e.drawElements(Ye,ue,ge,Ae)}else{Ie&&xe(z,_e,G);const ge=G.attributes.position;let Qe,ue;G.vertexOffset!==void 0?(Qe=G.vertexCnt,ue=G.vertexOffset):(Qe=ge.length/ge.itemSize,ue=0),G.isInstanced?e.drawArraysInstanced(Ye,ue,Qe,G.instanceCount):e.drawArrays(Ye,ue,Qe)}f.resetAttributeDivisors()},this.renderObjects=function(U,z,G){let X;G&&(X=G,this.setMaterial(X),this.setMaterialFaces(X));for(let _e=0,Ie=U.length;_e<Ie;_e+=1){const Ye=U[_e],ke=Ye.geometry,ge=Ye.materialOverride?Ye.materialOverride:Ye.material;try{G?G.doNotOverrideSide&&ge&&this.setMaterialFaces(ge):(X=ge,this.setMaterial(X),this.setMaterialFaces(X));for(let Qe=0;Qe<X.renderSteps;Qe++)X.updateRenderStep(Qe),this.renderBufferDirect(z,X,ke,Ye)}catch(Qe){const ue=X?X.name:"null";console.error(`Failed to render material ${ue}: ${Qe.stack}`)}}},this.updateRenderTargetMipmap=function(U){const z=T.setSlot(U,!1);e.activeTexture(e.TEXTURE0+U.webglSlot),U.isCube?(z&&e.bindTexture(e.TEXTURE_CUBE_MAP,U.webglTexture),e.generateMipmap(e.TEXTURE_CUBE_MAP)):(z&&e.bindTexture(e.TEXTURE_2D,U.webglTexture),e.generateMipmap(e.TEXTURE_2D))},this.resetCaching=function(){u=null,d=-1,l=null,h=null,f.resetAttributeStates()},this.render=function(U,z,G,X){this.renderMeshes(U.children,U.overrideMaterial,z,G,X)},this.renderMeshes=function(U,z,G,X,_e,Ie){this.resetCaching(),G.matrixWorldInverse.getInverse(G.matrixWorld),b.multiplyMatrices(G.projectionMatrix,G.matrixWorldInverse),m.setFromMatrix(b),n.length=0,r.length=0;const Ye=Ie===void 0?!1:Ie;for(let ke=0;ke<U.length;ke+=1)le(U[ke],z,Ye);o.sortObjects===!0&&(n.sort(qe),r.sort(k)),this.setRenderTarget(X),(this.autoClear||_e)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),this.renderObjects(n,G,z),this.renderObjects(r,G,z),X&&X.generateMipmaps&&this.updateRenderTargetMipmap(X),f.setDepthTest(!0),f.setDepthWrite(!0),f.setColorWrite(!0),f.resetAttributeStates()};let Fe=null;this.setUploadBuffersRedirection=function(U){Fe=U},this.uploadNewBuffers=function(U){if(Fe){Fe(U);return}const z=U.geometry,G=z.attributes,X=z.attributesKeys;z.setOnDispose(q),console.assert(z instanceof Wi||z instanceof co);for(let _e=0,Ie=X.length;_e<Ie;_e+=1){const Ye=X[_e],ke=G[Ye],ge=Ye==="index"?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER;if(ke.buffer)ke.needsUpdate===!0&&console.assert(!1);else{ke.buffer=e.createBuffer(),e.bindBuffer(ge,ke.buffer);const Qe=ke.array;if(it.ios&&ge===e.ARRAY_BUFFER){const ue=ke.itemSize*Qe.BYTES_PER_ELEMENT%4;console.assert(ue===0)}e.bufferData(ge,Qe,e.STATIC_DRAW),Qe instanceof Float32Array?(ke.glType=e.FLOAT,ke.glTypeSize=4):Qe instanceof Int8Array?(ke.glType=e.BYTE,ke.glTypeSize=1):Qe instanceof Int16Array?(ke.glType=e.SHORT,ke.glTypeSize=2):Qe instanceof Uint16Array?(ke.glType=e.UNSIGNED_SHORT,ke.glTypeSize=2):Qe instanceof Uint32Array?(ke.glType=e.UNSIGNED_INT,ke.glTypeSize=4):console.assert(!1),ke.releaseOnLoadedToGpu&&(ke.array=null),ke.needsUpdate=!1}}},this.uploadTexture=function(U,z=void 0){T.setSlot(U,!1),me(U,z)},this.copyFramebufferToCubeFaceMip=function(U,z,G,X,_e){T.setSlot(_e,!1),e.activeTexture(e.TEXTURE0+_e.webglSlot),e.bindTexture(e.TEXTURE_CUBE_MAP,_e.webglTexture),ba(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+G,U,nt.RGBA8,z,z,X)},this.createCubeTexture=function(U,z){const G=new wt;G.isCube=!0,G.anisotropy=wt.NO_ANISOTROPY,z?G.minFilter=ne.LINEAR_MIPMAP_NEAREST:G.minFilter=ne.LINEAR,G.generateMipmaps=!1,G.needsUpdate=!1,G.addEventListener("dispose",j),G.webglTexture=e.createTexture(),T.setSlot(G,!1),e.activeTexture(e.TEXTURE0+G.webglSlot),e.bindTexture(e.TEXTURE_CUBE_MAP,G.webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),z?e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST):e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR);for(let X=0;X<6;X+=1)ba(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+X,0,nt.RGBA8,U,U,null);return z&&e.generateMipmap(e.TEXTURE_CUBE_MAP),G};function we(U,z){e.bindRenderbuffer(e.RENDERBUFFER,U),z.depthBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,z.width,z.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,U)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,z.width,z.height)}function at(U,z,G){e.bindFramebuffer(e.FRAMEBUFFER,U),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,z,G,0)}function et(U,z){if(z.addEventListener("dispose",K),z.webglTexture=e.createTexture(),T.setSlot(z,!1),e.activeTexture(e.TEXTURE0+z.webglSlot),U){e.bindTexture(e.TEXTURE_CUBE_MAP,z.webglTexture),Ve(e.TEXTURE_CUBE_MAP,z);for(let G=0;G<6;G++)z.webglFramebuffer[G]=e.createFramebuffer(),z.webglRenderbuffer[G]=e.createRenderbuffer(),ba(e,e.TEXTURE_CUBE_MAP_POSITIVE_X+G,0,z.format,z.width,z.height,null),at(z.webglFramebuffer[G],e.TEXTURE_CUBE_MAP_POSITIVE_X+G,z.webglTexture),we(z.webglRenderbuffer[G],z);z.generateMipmaps&&e.generateMipmap(e.TEXTURE_CUBE_MAP)}else{if(z.webglFramebuffer=e.createFramebuffer(),z.shareDepthFrom?z.webglRenderbuffer=z.shareDepthFrom.webglRenderbuffer:z.webglRenderbuffer=e.createRenderbuffer(),e.bindTexture(e.TEXTURE_2D,z.webglTexture),Ve(e.TEXTURE_2D,z),ba(e,e.TEXTURE_2D,0,z.format,z.width,z.height,null),at(z.webglFramebuffer,e.TEXTURE_2D,z.webglTexture),z.useDepthTexture)z.depthTexture=wt.newDataTexture(null,z.width,z.height,nt.DEPTH24),z.depthTexture.webglTexture=e.createTexture(),T.setSlot(z.depthTexture,!1),e.activeTexture(e.TEXTURE0+z.depthTexture.webglSlot),e.bindTexture(e.TEXTURE_2D,z.depthTexture.webglTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_MODE,e.NONE),ba(e,e.TEXTURE_2D,0,nt.DEPTH24,z.width,z.height,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,z.depthTexture.webglTexture,0),e.bindTexture(e.TEXTURE_2D,null);else if(z.shareDepthFrom){if(z.depthBuffer){const G=e.DEPTH_STENCIL_ATTACHMENT;e.framebufferRenderbuffer(e.FRAMEBUFFER,G,e.RENDERBUFFER,z.webglRenderbuffer)}}else we(z.webglRenderbuffer,z);z.generateMipmaps&&e.generateMipmap(e.TEXTURE_2D)}e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null)}this.createFrameBufferRenderTarget=function(U){return new jl(U)},this.createRenderTarget=function(U,z,G){const X=new yo(U,z,G);return et(!1,X),X},this.createRenderTargetCube=function(U,z,G){const X=new Xl(U,z,G);return et(!0,X),X},this.readPixels=function(U,z,G){e.readPixels(0,0,U,z,e.RGBA,e.UNSIGNED_BYTE,G)},this.checkGlError=function(){const U=e.getError();U!==e.NO_ERROR&&console.log("gl error! "+U)}}function S1(s){return D.DEBUG_WEBGL?cs.wrapWebglDebug(s):s}function T1(s,e){e.alpha===void 0&&(e.alpha=!0),e.depth===void 0&&(e.depth=!0),e.stencil===void 0&&(e.stencil=!1),e.premultipliedAlpha===void 0&&(e.premultipliedAlpha=!0),e.antialias===void 0&&(e.antialias=!0),e.preserveDrawingBuffer===void 0&&(e.preserveDrawingBuffer=!1);try{return(D.FORCE_WEBGL1?null:s.getContext("webgl2",e))||s.getContext("webgl",e)||s.getContext("experimental-webgl",e)}catch(t){return null}}function om(s,e){const t=T1(s,e);return t?(it.resetGlDetector(t),it.gl.reportToConsole(),new w1(s,S1(t))):null}function M1(s){const e=om(s,{antialias:!D.FORCE_FXAA});return e&&(e.autoClear=!0,e.autoClearColor=!1,e.autoClearDepth=!0,e.autoClearStencil=!1,e.sortObjects=!0,D.DEV_NEW_RENDER_ARCHITECTURE&&Yi.createInstance(e)),e}function P1(s,e,t,i){const n=t.camera,r=t.threeScene;Ri.initWebGLProfiler(s.renderContext),D.DEV_NEW_RENDER_ARCHITECTURE&&Yi.get().init(t);const o=new c1(s,r,n);function l(){it.gl.antialiasPostprocess&&(o.init(),it.gl.antialiasNative||o.addFXAA(),n.motionBlurEnabled&&o.addMotionBlur(),o.setup(),o.addSSAA(t))}function c(){return window.devicePixelRatio}this.resize=function(d){let u,h,f,p;d||(u=window.innerWidth,h=window.innerHeight,f=u*c(),p=h*c(),n.physicalWidth=f,n.physicalHeight=p,n.updateProjectionMatrix(),s.setCanvasSize(f,p),s.domElement.style.width=u+"px",s.domElement.style.height=h+"px",o.onResize(f,p),D.DEV_NEW_RENDER_ARCHITECTURE&&Yi.get().onViewportResize(f,p))},this.renderIdle=function(d,u){return u===0&&(i.adaptExposure(),o.resetSSAA()),i.exposureNeedsUpdate()?(this.renderToScreen(d,!1),!0):o.updateSSAA()},this.renderToScreen=function(d,u,h){D.DEV_NEW_RENDER_ARCHITECTURE?Yi.get().renderScene(h,d,s):(i.update(d),u?e.render(r,n.matrixWorld):o.isEnabled?o.update(d):s.render(r,n))},this.enableAutoExposure=function(){i.enableAutoExposure()},this.disableAutoExposure=function(){i.disableAutoExposure()},this.reloadShaders=function(){Yi.get().reloadShaders(s)},l()}function C1(s,e,t){for(let i=0;i<t;++i)for(let n=0;n<e;++n){const r=4*(i*e+n);if(i<t/2){const l=4*((t-i-1)*e+n);for(let c=0;c<3;++c){const d=s[r+c];s[r+c]=s[l+c],s[l+c]=d}}const o=3;s[r+o]=255}}const ya=function(s,e,t,i,n){return s.createRenderTarget(e,t,{magFilter:i,minFilter:i,depthBuffer:n,stencilBuffer:!1,generateMipmaps:!1})};function R1(s,e,t){const i=[],n=[],r=[{totalFovFraction:.25,count:2},{totalFovFraction:.25,count:16},{totalFovFraction:.375,count:48},{totalFovFraction:.125,count:8}],o=4;(function(){const c={fovSum:0,heightSum:0,totalFovFraction:0};for(let d=0;d<r.length;d++){const u=r[d],h=u.totalFovFraction*s/u.count;console.assert(h===Math.floor(h),`Height (${h})must be an integer`);const f=u.totalFovFraction*Math.PI/2/u.count,p=ya(t,e*o,h*o,ne.LINEAR,!0);n.push(p);for(let m=0;m<u.count;m++)i.push({fov:f,fovOffset:c.fovSum+(m+.5)*f,height:h,yOffset:c.heightSum+m*h,renderTarget:p});c.fovSum+=u.count*f,c.heightSum+=u.count*h,c.totalFovFraction+=u.totalFovFraction}console.assert(c.totalFovFraction===1,"Invalid fractions sum"),console.assert(c.fovSum===Math.PI/2,"Invalid fov definition for rectangles"),console.assert(c.heightSum===s,"Invalid rectangles height")})(),this.getRectangleHeight=function(c){return i[c].height},this.getRectangleOffset=function(c){return i[c].yOffset},this.getRectangleFov=function(c){return i[c].fov},this.getRectangleFovOffset=function(c){return i[c].fovOffset},this.getRectangleRenderTarget=function(c){return i[c].renderTarget},this.dispose=function(){n.forEach(function(c){c.dispose()}),i.length=0,n.length=0},this.getRectangleCount=function(){return i.length}}function I1(s,e,t){let i=null,n=null,r=null,o=null;const l=new B;function c(){const p=document.body.offsetHeight*i,m=(document.body.offsetWidth-p)/2,b=Math.max(m,0),_=`${m}px`,y=`${b}px`;n.style.width=y,r.style.width=y,o.style.left=_,o.style.right=_}this.markArea=function(p){function m(_,y){_.style.zIndex=1,_.style.pointerEvents="none",_.style.position="absolute",_.style.top=0,_.style.bottom=0,_.style[y]=0,_.style.backgroundColor="rgba(0, 0, 0, 0.5)"}function b(_){_.style.zIndex=1,_.style.pointerEvents="none",_.style.position="absolute",_.style.boxSizing="border-box",_.style.top=0,_.style.bottom=0,_.style.border="4px solid rgba(35, 181, 233, 0.5)"}o||(n=document.createElement("div"),m(n,"left"),r=document.createElement("div"),m(r,"right"),o=document.createElement("div"),b(o),document.body.appendChild(n),document.body.appendChild(r),document.body.appendChild(o),window.addEventListener("resize",c)),i=p,c()},this.unmarkArea=function(){o&&(n.remove(),r.remove(),o.remove(),window.removeEventListener("resize",c),i=null,n=null,r=null,o=null)};function d(p,m,b,_,y,A){const T=e.camera.near,M=e.camera.far,C=512,N=.03;console.assert(b%C===0,"Invalid width for stereo panorama");const O=b/2,q=new B(0,-1,0),j=O/2,K=2*Math.PI/C,de=b/C,xe=-de,Ve=de,qe={BOTTOM:Symbol("Bottom"),TOP:Symbol("Top")},k=Math.floor(m/K)*K,Q=T*Math.tan(K/2),le=new hs;le.up.set(0,0,1);const ae=new R1(j,de,s),Ee=ae.getRectangleCount(),te=new B,me=new B,Fe=new B,we=new je,at=function(ge,Qe,ue,Ae){const Se=function(F){return Q*Math.cos(F)},We=-(Qe*K-k),rt=ge===qe.TOP?-ae.getRectangleFovOffset(ue):ae.getRectangleFovOffset(ue);we.makeRotationZ(We),te.set(Ae,0,0),we.affineTransformPoint3(te),le.position.copyFrom(p).add(te),me.copyFrom(q),we.makeRotationX(rt).transformVector3(me),we.makeRotationZ(We).transformVector3(me),Fe.copyFrom(le.position).add(me),le.lookAt(Fe);const bt=T*Math.tan(ae.getRectangleFov(ue)/2),ft=Se(rt);le.projectionMatrix.makeFrustum(-ft,ft,-bt,bt,T,M),le.updateMatrix(),le.updateMatrixWorld()},et=ya(s,b,2*O,ne.NEAREST,!1);et.width=de;const U=new va,z=function(ge){et.dispose(),ae.dispose(),U.dispose(),y(ge)},G=[{hemisphere:qe.TOP,eyeOffset:N,parallaxOffset:xe,targetYOffset:O},{hemisphere:qe.BOTTOM,eyeOffset:N,parallaxOffset:xe,targetYOffset:O},{hemisphere:qe.TOP,eyeOffset:-N,parallaxOffset:Ve,targetYOffset:0},{hemisphere:qe.BOTTOM,eyeOffset:-N,parallaxOffset:Ve,targetYOffset:0}],X=function(ge,Qe){if(Qe++,Qe===C){if(ge++,ge===G.length)return[-1,-1];Qe=0}return[ge,Qe]},_e=G.length*C,Ie=Math.ceil(_e/100),Ye=function(ge){_({done:ge,total:_e})},ke=function(ge,Qe){const ue=G[ge].hemisphere,Ae=G[ge].eyeOffset,Se=G[ge].parallaxOffset,We=G[ge].targetYOffset;for(let rt=0;rt<Ee;rt++){at(ue,Qe,rt,Ae);const bt=ae.getRectangleRenderTarget(rt);s.render(e.threeScene,le,bt);const ft=ae.getRectangleHeight(rt),F=ae.getRectangleOffset(rt);ue===qe.TOP?et.y=We+j+F:et.y=We+j-F-ft,et.x=(Qe*de+Se+b)%b,et.height=ft,U.render(s,et,bt)}if(A()){z(null);return}if([ge,Qe]=X(ge,Qe),ge===-1){const rt=new Uint8Array(b*2*O*4);s.readPixels(b,2*O,rt),z(rt);return}Qe%Ie===0&&Ye(ge*C+Qe),setTimeout(()=>ke(ge,Qe),0)};ke(0,0)}function u(p,m,b,_){const y=new Yc(e.camera.near,e.camera.far);y.rotateZ(m),y.position.copyFrom(p),y.updateMatrixWorld();const A=4096,T=s.createRenderTargetCube(A,A,{magFilter:ne.LINEAR,minFilter:ne.LINEAR,stencilBuffer:!1,generateMipmaps:!1});for(let q=0;q<6;q+=1)T.activeCubeFace=q,s.render(e.threeScene,y.sideCameras[q],T);const M=ya(s,b,_,ne.NEAREST,!0),C={uniforms:{panoramaCube:{type:"t",value:null}},vertexShaderName:"cube_to_equirect_vertex.glsl",fragmentShaderName:"cube_to_equirect_fragment.glsl"},N=new Cn(C,"panoramaCube");N.render(s,M,T),N.dispose(),T.dispose();const O=new Uint8Array(b*_*4);return s.readPixels(b,_,O),M.dispose(),O}function h(p,m){if(D.DEV_NEW_RENDER_ARCHITECTURE)return Yi.get().takeScreenshot(p,m,t.cameraWorldPosition(),e.camera.rotation.toQuaternion());{const b=ya(s,p,m,ne.NEAREST,!0),_=ya(s,p,m,ne.NEAREST,!1),y=new hd(s,e);y.setTargets(b,_),y.renderAllSamples();const A=y.copyAccumulatedSamplesToBuffer();return b.dispose(),_.dispose(),y.dispose(),A}}this.monoScreenToBuffer=function(p,m,b){return p?u(t.cameraWorldPosition(),t.getYawAngle(),m,b):h(m,b)},this.stereoPanoramaToBuffer=function(p,m,b,_){d(t.cameraWorldPosition(),t.getYawAngle(),p,m,b,_)},this.monoScreenToDataUrl=function(p,m,b){const _=this.monoScreenToBuffer(p,m,b);C1(_,m,b);const y=new Uint8ClampedArray(_),A=new ImageData(y,m,b),T=document.createElement("canvas");T.width=m,T.height=b,T.getContext("2d").putImageData(A,0,0);const C="image/jpeg";return T.toDataURL(C)},this.monoScreenToLocalImage=function(p,m,b){const _=this.monoScreenToDataUrl(p,m,b);if(navigator.msSaveOrOpenBlob)fetch(_).then(y=>y.blob()).then(y=>navigator.msSaveOrOpenBlob(y,"screen.jpg"));else{const y=document.createElement("a");document.body.appendChild(y),y.style.cssText="display: none",y.href=_,y.download="screenshot",y.click(),window.URL.revokeObjectURL(_),y.parentNode.removeChild(y)}},this.coverToServer=function(p,m){const b=h(p,m),_=`screenshot?width=${p}&height=${m}`;qs(_,"application/binary",b)};function f(p,m){const b=Math.min(D.MAX_PANORAMA_SIZE,it.gl.maxRenderBufferSize);if(p<=b&&m<=b)return[p,m];const _=p/m;return p>m?[b,Math.floor(b/_)]:[Math.floor(b*_),b]}this.monoPanoramaToServer=function(p,m){p.position?l.fromArray(p.position):l.copyFrom(t.cameraWorldPosition());let b=p.width!==void 0?p.width:8e3,_=p.height!==void 0?p.height:4e3;[b,_]=f(b,_);const y=p.rotation!==void 0?oi(p.rotation):0,A=u(l,y,b,_),T=p.name,M=`panorama?width=${b}&height=${_}&name=${T}`;qs(M,"application/binary",A,m,m)}}function am(){const s=new Set,e=[];this.add=function(t){t instanceof RegExp?e.push(t):s.add(t)},this.matchesAny=function(t){return s.has(t)?!0:e.some(i=>i.test(t))}}function D1(){this._editableNodeTypes=new am,this._editableMaterialNames=new am,this._allMaterialsEditable=!1,this.setNodeTypeEditable=function(s){this._editableNodeTypes.add(s)},this.setMaterialEditable=function(s){this._editableMaterialNames.add(s)},this.setAllMaterialsEditable=function(){this._allMaterialsEditable=!0},this.isMaterialEditable=function(s){return this._allMaterialsEditable||this._editableMaterialNames.matchesAny(s)},this.isNodeTypeEditable=function(s){return this._editableNodeTypes.matchesAny(s)}}function L1(s,e){const t={};this.onProgress=null,this.onFailure=null,this.onHaveBuffer=null,this._buffersDone={},this.buffers={meshes:null,transforms:null,bounds:null,faces16:null,faces:null,vertices:null,normals:null,uvs0:null,uvs1:null},this.haveAllBuffers=function(){for(let i in this.buffers)if(this.buffers.hasOwnProperty(i)&&this.buffers[i]===null)return!1;return!0},this.haveCoreBuffers=function(){const i=this.buffers;return i.faces16&&i.faces&&i.vertices&&i.normals&&i.transforms},this.releaseCoreBuffers=function(){const i=this.buffers;i.faces16=i.faces=i.vertices=i.normals=null},this.load=function(){const i=this,n=D.LOAD_PRIORITY.CORE_RESOURCE,r={meshes:n,transforms:n,bounds:n,faces16:n,faces:n,vertices:n,normals:n,uvs0:e?n:D.LOAD_PRIORITY.UV0,uvs1:e?n:D.LOAD_PRIORITY.LIGHTMAP};function o(d){return function(u){i.buffers[d]=u,i.onHaveBuffer()}}function l(d){return function(u){t[d]=u.loaded,i.onProgress()}}function c(){for(let d in i.buffers)if(i.buffers.hasOwnProperty(d)){const u=r[d];console.assert(u!==void 0),_r(u,s+d+".buf",!0,o(d),i.onFailure,l(d),!0)}}c()},this.totalDone=function(){let i=0;for(let n in t)t.hasOwnProperty(n)&&(i+=t[n]);return i}}const F1=10,lm=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0]),cm=function(s){this.minVerticesUntilTimeCall=s,this.verticesCount=0,this.timer=new Pr};cm.prototype.shouldInterrupt=function(s){return this.verticesCount+=s,this.verticesCount>this.minVerticesUntilTimeCall&&this.timer.elapsedMSec()>F1?(this.verticesCount=0,this.timer.reset(),!0):!1};function hm(s,e,t,i,n,r,o){for(let l=0,c=3*t;l<c;l+=3){const d=s[l+e]*n,u=s[l+e+1]*n,h=s[l+e+2]*n;r[o+l]=i[0]*d+i[1]*u+i[2]*h+i[3],r[o+l+1]=i[4]*d+i[5]*u+i[6]*h+i[7],r[o+l+2]=i[8]*d+i[9]*u+i[10]*h+i[11]}}function dm(s,e,t,i,n,r){for(let o=0,l=2*t;o<l;o+=2){let c=(s[o+e]/254+.5)*Math.PI,d=s[o+e+1]*(Math.PI/127);const u=Math.sin(c),h=u*Math.cos(d),f=u*Math.sin(d),p=Math.cos(c),m=i[0]*h+i[1]*f+i[2]*p,b=i[4]*h+i[5]*f+i[6]*p,_=i[8]*h+i[9]*f+i[10]*p;c=(Math.acos(_)/Math.PI-.5)*2,d=Math.atan2(b,m)/Math.PI,n[r+o]=Ws(c),n[r+o+1]=Ws(d)}}function Yl(s){return s.instanceId!==0||s.parent.ownsGpuBuffers===!1}function um(s,e,t,i,n,r){let o=!1;for(let l=0,c=2*t;l<c;l+=1){const d=s[l+e]*i;n[r+l]=d,(d<0||d>1)&&(o=!0)}return o}function fm(s,e,t,i,n){let r=!1;for(let o=0,l=2*t;o<l;o+=1){const c=s[o+e];i[n+o]=c,(c<0||c>1)&&(r=!0)}return r}function pm(s,e,t,i,n,r,o,l,c){for(let d=0,u=2*t;d<u;d+=2){const h=s[d+e],f=s[d+e+1];h!==0||f!==0?(l[c+d]=Math.round(h*i)+r,l[c+d+1]=Math.round(f*n)+o):(l[c+d]=0,l[c+d+1]=0)}}function mm(s){return s.uv0ByteOffset!==-1}function gm(s){return s.uv1ByteOffset!==-1}function _m(s){return s.quantVertexRange/s.quantVertexMax}function fd(s){return s.quantUv0Max===0}function vm(s){return s.quantUv0Range/s.quantUv0Max}function Ql(s,e,t,i,n,r){const o=new cm(5e4);let l=0,c=0;function d(){for(;l<s.length;){const u=s[l];if(c===0&&!t(u)){l+=1;continue}for(;c<u.logicalMeshes.length;){const h=u.logicalMeshes[c],f=e.get(h);if(i(h,f),c+=1,o.shouldInterrupt(f.vertexCnt)){setTimeout(d,0);return}}n(u),l+=1,c=0}r()}d()}function bm(s,e){return e.geometry.allocateCoreBuffers(s),!0}function ym(s){return s.anyLogicalMeshHasUvs?(s.geometry.allocateUv0(),!0):!1}function xm(s){return s.lightmap?(s.geometry.allocateUv1(),!0):!1}function O1(s,e,t,i,n){const r=new Uint16Array(s),o=new Float32Array(s);function l(c,d){if(!mm(d))return;const u=c.geometry;if(Yl(u))return;const h=u.vertexOffset,f=u.parent;let p=!1;fd(d)?p=fm(o,d.uv0ByteOffset/4,d.vertexCnt,f.uvs0,h*2):p=um(r,d.uv0ByteOffset/2,d.vertexCnt,vm(d),f.uvs0,h*2),p&&(f.isUvs0Repeating=!0)}Ql(e,t,ym,l,i,n)}function Am(s,e,t,i,n){const r=n.instanceId*4,o=n.parent.uvs1Mod;o[r]=t/65535,o[r+1]=i/65535,o[r+2]=s/65535,o[r+3]=e/65535}function B1(s,e,t,i,n,r,o){const l=i?Sm(n,s):new Uint16Array(s);function c(d,u){if(!gm(u))return;let h=u.uv1CoordUScale,f=u.uv1CoordVScale,p=u.uv1CoordUOffset,m=u.uv1CoordVOffset;const b=d.geometry;if(b.isInstanced){if(Am(h,f,p,m,b),Yl(b))return;h=f=1,p=m=0}const _=b.vertexOffset;pm(l,u.uv1ByteOffset/2,u.vertexCnt,h,f,p,m,b.parent.uvs1,_*2)}Ql(e,t,xm,c,r,o)}function Em(s,e){const t=e.parent,i=e.instanceId*4,n=t.transforms0;n[i]=s[0],n[i+1]=s[1],n[i+2]=s[2],n[i+3]=s[3];const r=t.transforms1;r[i]=s[4],r[i+1]=s[5],r[i+2]=s[6],r[i+3]=s[7];const o=t.transforms2;o[i]=s[8],o[i+1]=s[9],o[i+2]=s[10],o[i+3]=s[11]}function N1(s,e,t,i,n,r,o){const l=i?wm(n,e,t,s.faces):[new Uint16Array(s.faces16),new Uint32Array(s.faces)],c=l[0],d=l[1],u=new Int8Array(s.vertices),h=new Int16Array(s.vertices),f=new Int32Array(s.vertices),p=new Int8Array(s.normals);function m(b,_){const y=b.geometry,A=y.parent;let T=new Float32Array(s.transforms,_.transformByteOffset,16);if(y.isInstanced){if(Em(T,y),Yl(y))return;T=lm}let M,C;switch(Sn(_.quantVertexMax)){case 1:M=u,C=_.vertexByteOffset;break;case 2:M=h,C=_.vertexByteOffset/2;break;case 4:M=f,C=_.vertexByteOffset/4;break}const N=y.vertexOffset;hm(M,C,_.vertexCnt,T,_m(_),A.vertices,N*3),dm(p,_.normalByteOffset,_.vertexCnt,T,A.normals,N*2);const O=A.index;let q=y.indexOffset,j,K;_.useFaces16?(j=_.faceByteOffset/2,K=c):(j=_.faceByteOffset/4,K=d);for(let de=j,xe=j+_.faceCnt*3;de<xe;de+=1,q+=1)O[q]=K[de]+N}Ql(e,t,bm.bind(null,!0),m,r,o)}function k1(s){return new Uint8Array(s.buffer,s.byteOffset,s.byteLength)}function wm(s,e,t,i){let n=[],r=[],o=0,l=0;for(const p of e)for(const m of p.logicalMeshes){const b=t.get(m);if(b.useFaces16){let _=b.faceByteOffset/2;n.push([_,b.faceCnt,b.useFaces16]),o+=b.faceCnt}else{let _=b.faceByteOffset/4;r.push([_,b.faceCnt,b.useFaces16]),l+=b.faceCnt}}const c=(p,m)=>p[0]-m[0];n.sort(c),r.sort(c);let d=o>0?new Uint32Array(o*3):null,u=l>0?new Uint32Array(l*3):null,h=0,f=-1;for(const p of[...n,...r]){const m=p[0],b=p[1],_=p[2];if(f==m||b==0)continue;f=m;const y=new Uint32Array(i.slice(h,h+=4)).at(0),T=k1((_?d:u).subarray(m)),M=new Uint8Array(i).subarray(h,h+=y);s.decodeIndexBuffer(T,b*3,4,M)}return[new Uint16Array(d),u]}function Sm(s,e){if(!e)return null;const t=new Uint8Array(e.slice(4)),i=new Uint32Array(e.slice(0,4)).at(0),n=new Uint8Array(i*4);return s.decodeVertexBuffer(n,i,4,t),new Uint16Array(n.buffer)}function U1(s,e,t,i,n,r,o){const l=i?wm(n,e,t,s.faces):[new Uint16Array(s.faces16),new Uint32Array(s.faces)],c=l[0],d=l[1],u=new Int8Array(s.vertices),h=new Int16Array(s.vertices),f=new Int32Array(s.vertices),p=new Int8Array(s.normals),m=new Uint16Array(s.uvs0),b=new Float32Array(s.uvs0),_=i?Sm(n,s.uvs1):new Uint16Array(s.uvs1);function y(T){return bm(!1,T),ym(T),xm(T),!0}function A(T,M){const C=T.geometry,N=T.geometry.parent;let O=new Float32Array(s.transforms,M.transformByteOffset,16),q;mm(M)&&N.uvs0&&(q=N.uvs0);let j,K,de,xe,Ve;if(gm(M)&&N.uvs1&&(j=N.uvs1,K=M.uv1CoordUScale,de=M.uv1CoordVScale,xe=M.uv1CoordUOffset,Ve=M.uv1CoordVOffset),C.isInstanced){if(Em(O,C),j&&Am(K,de,xe,Ve,C),Yl(C))return;O=lm,K=de=1,xe=Ve=0}let qe,k;M.useFaces16?(qe=c,k=M.faceByteOffset/2):(qe=d,k=M.faceByteOffset/4);let Q,le;switch(Sn(M.quantVertexMax)){case 1:Q=u,le=M.vertexByteOffset;break;case 2:Q=h,le=M.vertexByteOffset/2;break;case 4:Q=f,le=M.vertexByteOffset/4;break}let ae;fd(M)?ae=M.uv0ByteOffset/4:ae=M.uv0ByteOffset/2;let Ee=T.geometry.vertexOffset*3,te=T.geometry.vertexOffset*2;const me=N.vertices,Fe=N.normals,we=M.normalByteOffset,at=M.uv1ByteOffset/2;for(let et=k,U=k+M.faceCnt*3;et<U;et+=1,Ee+=3,te+=2){const z=qe[et],G=le+z*3;hm(Q,G,1,O,_m(M),me,Ee);const X=we+z*2;if(dm(p,X,1,O,Fe,te),q){const _e=ae+z*2;let Ie=!1;fd(M)?Ie=fm(b,_e,1,q,te):Ie=um(m,_e,1,vm(M),q,te),Ie&&(N.isUvs0Repeating=!0)}if(j){const _e=at+z*2;pm(_,_e,1,K,de,xe,Ve,j,te)}}}Ql(e,t,y,A,r,o)}const z1=500;function V1(s,e,t,i){const n=e/4;for(let r=0;r<6;++r)if(!isFinite(s[n+r]))return;t.max.x=s[n],t.max.y=s[n+1],t.max.z=s[n+2],t.min.x=s[n+3],t.min.y=s[n+4],t.min.z=s[n+5],t.center(i.center),i.radius=s[n+6]}function Tm(s){return s.uv0ByteOffset!==-1}function Mm(s){return s.useInstances?s.vertexByteOffset:null}const pd=function(s,e,t,i,n,r){this.meshPropsSet=new Set,this.meshPropsSet.add(s),this.material=e,this.lightmap=t,this.lightProbes=i,this.hideInViews=n,this.editableRootNode=r,this.anyLogicalMeshHasUvs=Tm(s),this.sharedGeometryId=Mm(s)};pd.prototype.canUseLightmap=function(s){return this.lightmap===null||s===null||this.lightmap===s};function G1(s,e,t){let i,n,r,o;t?(i=s.faceCnt*3,n=s.vertexCnt):(i=0,n=s.faceCnt*3),e.isInstanced?(r=0,o=0):(r=e.indexCnt,o=e.vertexCnt);const l=new co(i,n,e,r,o,s.boundingBox,s.boundingSphere);return e.boundingBox.union(s.boundingBox),Tn.union(s.boundingSphere,e.boundingSphere),e.isInstanced?(l.instanceId=e.instanceCount,e.instanceCount+=1,e.indexCnt=i,e.vertexCnt=n):(e.indexCnt+=i,e.vertexCnt+=n),l}function H1(s,e,t,i){const n=this,r=[],o=e.byteLength;let l=0,c=0,d=0;this.mergedMeshes=[],this.meshPropsMap=new Map,this.coreGeometryDownloadSize=0,this.geometryDownloadSize=0,this.lightmapCount=0,this.encodedUsingMeshOpt=!1;function u(m,b,_){const y=new Int32Array(m),A=new Float32Array(m),T=new Float32Array(b),M={},C=y[0];n.encodedUsingMeshOpt=C>=3;const N=y[1];for(let O=2;O<y.length;O+=N){const q={nodeId:y[O],materialIdx:y[O+1],useFaces16:y[O+2]===1,faceByteOffset:y[O+3],faceCnt:y[O+4],vertexByteOffset:y[O+5],vertexCnt:y[O+6],normalByteOffset:y[O+7],uv0ByteOffset:y[O+8],uv1ByteOffset:y[O+9],lightmapIdx:y[O+10],uv1CoordUScale:A[O+11],uv1CoordVScale:A[O+12],uv1CoordUOffset:y[O+13],uv1CoordVOffset:y[O+14],transformByteOffset:y[O+15],boundsByteOffset:y[O+16],quantVertexRange:A[O+17],quantVertexMax:y[O+18],quantUv0Range:A[O+19],quantUv0Max:y[O+20],autoLightmapResolution:C>=2?y[O+21]:-1,useInstances:!1,hasCopies:!1,isMasterCopy:!1};q.boundingBox=new Dt,q.boundingSphere=new Tn,V1(T,q.boundsByteOffset,q.boundingBox,q.boundingSphere),n.lightmapCount=Math.max(n.lightmapCount,q.lightmapIdx+1);const j=q.vertexByteOffset;if(!M.hasOwnProperty(j))M[j]=[q];else{const K=M[j],de=K[0];de.isMasterCopy=!0,de.hasCopies=!0,q.hasCopies=!0,K.push(q)}_.push(q)}for(let O of Object.values(M))(O.length-1)*O[0].faceCnt>z1&&O.forEach(K=>K.useInstances=!0)}function h(){function m(N){return N+3&-4}let b=0,_=0,y=0,A=0,T=0,M=0,C=0;for(const N of r){const O=N.vertexCnt;c+=O,d+=N.faceCnt,b=Math.max(b,N.faceByteOffset+N.faceCnt*3*(N.useFaces16?2:4)),_=Math.max(_,m(N.vertexByteOffset+O*3*Sn(N.quantVertexMax))),y=Math.max(y,N.normalByteOffset+O*2),A=Math.max(A,N.transformByteOffset+16*4),T=Math.max(T,N.boundsByteOffset+7*4),N.uv0ByteOffset!==-1&&(M=Math.max(M,m(N.uv0ByteOffset+O*2*Sn(N.quantVertexMax)))),N.uv1ByteOffset!==-1&&(C=Math.max(C,N.uv1ByteOffset+O*2*2))}n.coreGeometryDownloadSize=o+b+_+y+A+T,n.geometryDownloadSize+=n.coreGeometryDownloadSize+M+C}function f(m,b,_,y){const A=new As(m,b,_.material);return A.lightmap=_.lightmap,A.lightProbes=_.lightProbes,A.autoLightmapResolution=y.autoLightmapResolution,n.meshPropsMap.set(A,y),A.lightmapIdx=y.lightmapIdx,y.hasCopies&&(y.isMasterCopy?A.sharedBuffersDebug=1:A.sharedBuffersDebug=2),l+=1,_.addLogicalMesh(A),A}function p(m){const b=[],_=new Map;function y(A){const T=s.findNode(A.nodeId),M=A.materialIdx,C=s.materials[M];let N=[];T.initialLightProbeIds!==null&&(N=s.findLightProbes(T.initialLightProbeIds));let O=null;A.lightmapIdx!==-1&&(O=m[A.lightmapIdx]);const q=T.hideInViews||[],j=T.editableRoot;let K=T.editable||C.opacity!==1;if(C.reflective&&C.roughness<.2&&(K=!0),K){b.push(new pd(A,C,O,N,q,j));return}const de=Mm(A),xe=_.get(C)||[];for(const qe of xe)if(Ja(qe.lightProbes,N)&&qe.editableRootNode===j&&qe.canUseLightmap(O)&&qe.sharedGeometryId===de&&Ja(qe.hideInViews,q)){O!==null&&(qe.lightmap=O),qe.anyLogicalMeshHasUvs=qe.anyLogicalMeshHasUvs||Tm(A),qe.meshPropsSet.add(A);return}const Ve=new pd(A,C,O,N,q,j);xe.push(Ve),_.set(C,xe),b.push(Ve)}return r.forEach(y),b}this.createMeshes=function(m){const b=m?m[0]:null,_=p(m),y={};for(const A of _){let T=null;const M=A.sharedGeometryId;if(M!==null){let N=y[M],O=!1;N||(N=new rh,O=!0,y[M]=N),T=new Ju(N,O)}else T=new rh;const C=new cl(T,A.material);C.lightProbes=A.lightProbes,C.lightmap=A.lightmap||b,C.hideInViews=A.hideInViews,C.anyLogicalMeshHasUvs=A.anyLogicalMeshHasUvs,C.editableRootNode=A.editableRootNode,this.mergedMeshes.push(C);for(const N of A.meshPropsSet){const O=G1(N,T,i),q=s.findNode(N.nodeId);q.mesh=f(q,O,C,N)}}Le.log("Have "+l+" meshes and "+this.mergedMeshes.length+" merged meshes.")},u(e,t,r),h(),Le.log("Have "+c+" vertices, "+d+" faces and "+this.lightmapCount+" lightmaps.")}const Pm=512*1024,Cm=12*1024*1024;function W1(s,e,t,i,n,r){const o=!t,l=!t&&!D.DEBUG_SHARED_BUFFERS,c=new Pr;this.onProgress=null,this.onMeshBuffersLoaded=null,this.onReadyToDisplay=null,this.onComplete=null,this.panoramas=[],this.load=function(){const d=this;let u=null,h=null,f=!1,p=!1,m=!1,b,_=null,y=!1,A={total:void 0,texturesDone:0,totalDone:function(){return this.texturesDone+u.totalDone()}};function T(){A.total&&d.onProgress(A.totalDone()/A.total)}function M(){p||(p=!0,d.onReadyToDisplay(s))}function C(){!m||!f||n.loadingProgress().isFinished()&&(n.freeLoadingBuffers(),n.onTextureLoaded=void 0,u=h=null,s.sharedMaterialState.clearDefaultLightmaps(),el(()=>{M(),d.onComplete(s)}))}function N(te){te.geometry.addUv1Attribute(),d.onMeshBuffersLoaded(te)}function O(){u.buffers.uvs1&&(b=C,B1(u.buffers.uvs1,h.mergedMeshes,h.meshPropsMap,h.encodedUsingMeshOpt,ds,N,function(){u.buffers.uvs1=null,m=!0,b()}))}function q(te){te.geometry.isUvs0Repeating&&te.material.ensureTexturesRepeatable(),te.geometry.addUv0Attribute(),d.onMeshBuffersLoaded(te)}function j(){u.buffers.uvs0&&(b=O,O1(u.buffers.uvs0,h.mergedMeshes,h.meshPropsMap,q,function(){u.buffers.uvs0=null,b()}))}function K(){if(f=!0,s.createDefaultViews(),!t&&!s.disableProgressiveLoader&&!D.PUPPETEER_TEST){const me=1e3*D.PROGRESSIVE_LOADER_AFTER_SEC-c.elapsedMSec();me<=0?M():setTimeout(M,me)}b()}function de(te){D.DEV_NEW_SCENE||s.addGpuMesh(te)}function xe(te){te.geometry.addCoreAttributes();const me=te.logicalMeshes;console.assert(!me[0].node.editable||me.length===1),me[0].node.editable||!l?me.forEach(de):de(te),d.onMeshBuffersLoaded(te)}function Ve(te){te.geometry.isUvs0Repeating&&te.material.ensureTexturesRepeatable(),te.geometry.uvs0&&te.geometry.addUv0Attribute(),te.geometry.uvs1&&te.geometry.addUv1Attribute(),xe(te)}function qe(){if(o){if(!u.haveCoreBuffers())return;Le.log("Using indexed geometry"),b=j,N1(u.buffers,h.mergedMeshes,h.meshPropsMap,h.encodedUsingMeshOpt,ds,xe,K)}else{if(!u.haveAllBuffers())return;b=C,U1(u.buffers,h.mergedMeshes,h.meshPropsMap,h.encodedUsingMeshOpt,ds,Ve,function(){m=!0,K()})}u&&u.releaseCoreBuffers()}function k(){ds.ready.then(()=>{y=!0,b()})}function Q(){var te,me,Fe;_&&(b=le,_.autoAddLightProbes!==void 0&&(s.autoAddLightProbes=_.autoAddLightProbes),s.disableProgressiveLoader=_.disableProgressiveLoader||!1,_.interactionPrompt&&(s.interactionPrompt=_.interactionPrompt),_.autoTour!==void 0&&(s.autoTour.disabled=_.autoTour.disabled||!1,s.autoTour.startOnLoad=_.autoTour.startOnLoad||!1),s.addLights(dn.loadLights(_.lights)),(te=_.lightProbes)==null||te.forEach(we=>s.addLightProbe(new ga(we))),s.camera.setFromJson(_.camera),(me=_.cameraVolumes)==null||me.forEach(we=>s.addCameraAdjustmentVolume(new Id(we,s.camera,s.exposureController))),(Fe=_.views)==null||Fe.forEach(we=>s.addView(new Qi(we))),s.addNodeConfigsFromJson(_,i),s.addNodesFromJson(_),b())}function le(){if(!_||!u.buffers.meshes||!u.buffers.bounds||!y)return;b=qe,_.camera.lutTexture&&(s.camera.colorMap=n.loadColorMap(_.camera.lutTexture)),n.loadAtlases(_.atlases||[]),new Hh(n,i).load(_.materials||[],s),s.lightmapLayoutVersion=_.lightmap?_.lightmap.lightmapLayoutVersion:0,s.lightmapLayoutVersion=s.lightmapLayoutVersion||0,new Wh(n).load(_.skies||[],s),s.findSkyMesh(D.EDITOR_CONTROLLED_SKY_NAME)===null&&console.error("A sky with name "+D.EDITOR_CONTROLLED_SKY_NAME+" is missing."),h=new H1(s,u.buffers.meshes,u.buffers.bounds,o);let Fe=null;if(h.lightmapCount!==0){let we=new ub(h.lightmapCount,_.lightmap),at;[at,Fe]=we.load(n),s.setLightmapEncoding(at),we=null}if(h.createMeshes(Fe),A.total=h.geometryDownloadSize+(n.loadingProgress().totalResources-h.lightmapCount)*Pm+h.lightmapCount*Cm,_.panoramas&&(d.panoramas=_.panoramas),s.minimapConfig=new sa(_,s.boundingBox),it.gl.colorBufferFloat){const we=Kf(r);s.addBrdfLUT(we)}n.onTextureLoaded=we=>{A.texturesDone+=we.name.indexOf("lightmap-")===0?Cm:Pm,T(),b()},_=null,b()}function ae(te){_=te,b()}c.reset(),b=Q;const Ee=()=>Wt.sceneLoadError();_r(D.LOAD_PRIORITY.CORE_RESOURCE,e+"scene.json",!1,ae,Ee),u=new L1(e,!o),u.onProgress=T,u.onFailure=Ee,u.onHaveBuffer=function(){b()},u.load(),k()},this.elapsedLoadTimeSec=function(){return c.elapsedSec()}}function Dr(){let s=0,e=null,t=document.createElement("div");t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",t.addEventListener("click",function(u){u.preventDefault(),n(++s%t.children.length)},!1);function i(u){return t.appendChild(u.dom),u}function n(u){for(let h=0;h<t.children.length;h++)t.children[h].style.display=h===u?"block":"none";s=u}let r=(performance||Date).now(),o=r,l=0,c=i(new Dr.Panel("FPS","#0ff","#002")),d=i(new Dr.Panel("MS","#0f0","#020"));return self.performance&&self.performance.memory&&(e=i(new Dr.Panel("MB","#f08","#201"))),n(0),{REVISION:16,dom:t,addPanel:i,showPanel:n,begin:function(){r=(performance||Date).now()},end:function(){l++;let u=(performance||Date).now();if(d.update(u-r,200),u>=o+1e3&&(c.update(l*1e3/(u-o),100),o=u,l=0,e)){let h=performance.memory;e.update(h.usedJSHeapSize/1048576,h.jsHeapSizeLimit/1048576)}return u},update:function(){r=this.end()},domElement:t,setMode:n}}Dr.Panel=function(s,e,t){let i=1/0,n=0,r=Math.round,o=r(window.devicePixelRatio||1),l=100*o,c=48*o,d=3*o,u=2*o,h=3*o,f=15*o,p=94*o,m=30*o,b=document.createElement("canvas");b.width=l,b.height=c,b.style.cssText="width:100px;height:48px";let _=b.getContext("2d");return _.font="bold "+9*o+"px Helvetica,Arial,sans-serif",_.textBaseline="top",_.fillStyle=t,_.fillRect(0,0,l,c),_.fillStyle=e,_.fillText(s,d,u),_.fillRect(h,f,p,m),_.fillStyle=t,_.globalAlpha=.9,_.fillRect(h,f,p,m),{dom:b,update:function(y,A){i=Math.min(i,y),n=Math.max(n,y),_.fillStyle=t,_.globalAlpha=1,_.fillRect(0,0,l,f),_.fillStyle=e,_.fillText(r(y)+" "+s+" ("+r(i)+"-"+r(n)+")",d,u),_.drawImage(b,h+o,f,p-o,m,h,f,p-o,m),_.fillRect(h+p-o,f,o,m),_.fillStyle=t,_.globalAlpha=.9,_.fillRect(h+p-o,f,o,r((1-y/A)*m))}}};function j1(s){const e=new Dr;e.showPanel(0);let t=null,i=null,n=null;D.BENCHMARK&&(t=new hb(s,D.BENCHMARK),i=e.addPanel(new Dr.Panel("RenderMS","#ff8","#221")),n=e.addPanel(new Dr.Panel("ApproxFPS","#ff8","#221"))),document.body.appendChild(e.dom),this.begin=function(){D.BENCHMARK&&t.begin(),e.begin()},this.end=function(){D.BENCHMARK&&(t.end(),i.update(t.lastMS,100),n.update(t.lastFPS,100)),e.end()}}/*!
 * Copyright (C) 2015-present Shapespark
 */function md(s,e){Array.from(document.getElementsByClassName(s)).forEach(e)}function X1(s){const e=new Array;md(s,function(t){e.push(t)});for(const t of e)t.classList.remove(s)}function un(s,e){s.style.display=e?"":"none"}function fs(s,e){un(vt(s),e)}function Kl(s,e){md(s,t=>{un(t,e)})}function Rm(s){un(s,!0),s.style.opacity="0",el(function(){s.style.opacity="1"})}function q1(){let s=document.getElementById("qr-code-canvas");if(s){s.remove();return}s=document.createElement("canvas"),s.setAttribute("id","qr-code-canvas"),document.body.appendChild(s),QRCode.toCanvas(s,window.location.toString())}function gd(s){s.style.opacity="0";const e=window.getComputedStyle(s).transitionDuration;if(e){let t=parseFloat(e);e.indexOf("ms")===-1&&(t*=1e3),setTimeout(function(){un(s,!1),s.style.opacity="1.0"},t)}else un(s,!1),s.style.opacity="1.0"}const Ba=class Ba extends kt{constructor(t,i,n,r,o,l=!0){super();a(this,"cover");a(this,"_editMode");a(this,"_gamepadManager");a(this,"_toggleVr");a(this,"_toggleFullScreen");a(this,"_togglePointerLock");a(this,"_scene");a(this,"_teleport");a(this,"_autoTour");a(this,"_screenshotTaker");a(this,"_vrSupported",!1);a(this,"_fullScreenSupported",!1);a(this,"_pointerLockSupported",!1);a(this,"_pointerLockEnabled",!1);a(this,"_vrEnabled",!1);a(this,"_showMenuSetting");a(this,"_showHelpSetting",!1);a(this,"_advancedDesktopHelp",!1);a(this,"_forceInfoTextTimer");a(this,"_interactionPrompt",!1);this._editMode=t,this._gamepadManager=i,this._toggleVr=n,this._toggleFullScreen=r,this._togglePointerLock=o,this._showMenuSetting=l}_visibleViews(){return this._scene?this._scene.visibleViews():[]}_findViewByIdx(t){const i=this._visibleViews();if(i.length>t)return i[t]}_findUiView(t){if(!t)return;const n=this._visibleViews().findIndex(o=>o===t);return n===-1?void 0:vt("view-list-items").children[n]}_removeUiViewHighlight(t){return()=>{t.classList.remove("active-view"),t.classList.remove("next-active-view")}}_removeAllUiViewsHighlight(){const t=Array.from(vt("view-list-items").children);for(const i of t)i.classList.remove("active-view"),i.classList.remove("next-active-view")}_onTourStarted(){vt("tour-button").classList.add("tour-on")}_onTourStopped(){vt("tour-button").classList.remove("tour-on"),this._removeAllUiViewsHighlight()}_toggleAutoTour(){this._autoTour.isRunning()?this._autoTour.stop():this._autoTour.start()}_stopAutoTour(){return this._autoTour.isRunning()?(this._autoTour.stop(),!0):!1}_onTeleportStarted(t){this._removeAllUiViewsHighlight();const i=this._findUiView(t.view);i&&i.classList.add("next-active-view")}_onTeleportDone(t){const i=this._findUiView(t.view);i&&(i.classList.remove("next-active-view"),i.classList.add("active-view"),setTimeout(this._removeUiViewHighlight(i),D.AUTO_TOUR_IN_VIEW_STILL_TIME_MS))}_viewClicked(t){return Lp(()=>{const i=this._stopAutoTour();this._teleport.switchToView(t,i?0:void 0)})}_fillCover(){ye(this.cover);const t=this.cover.title,i=this.cover.author,n=this.cover.authorHref,r=this.cover.engineLogoOn,o=this.cover.engineLogoText,l=this.cover.engineLogoUrl;let c=this.cover.authorLogoUrl;this.cover.authorLogo&&(c=Bo(this.cover.authorLogo.path));const d=vt("author-logo"),u=d.firstElementChild;c?(n&&(d.href=n),u.src=c):(un(d,!1),u.removeAttribute("src"));const h=!this._scene||!!this._forceInfoTextTimer;fs("info-text",h&&(!!t||!!i)),h&&(Zr(vt("info-title"),t),Zr(vt("info-author"),i),n&&(vt("info-author").href=n));let f="";t?f=t:f="3D scene",i&&(f+=" by "+i),document.title=f;const p=vt("engine-logo");if(un(p,r),r){if(o){const m=vt("engine-logo-text");un(m,!0),Zr(m,o)}l&&(p.href=l)}}_fillUiViews(t,i){let n=i.children[0];for(this._removeUiViewHighlight(n)();i.children.length>1;)i.removeChild(i.children[i.children.length-1]);for(const r of t)r.hideFromMenu||(Zr(n,r.name),n.onclick=this._viewClicked(r),i.appendChild(n),n=n.cloneNode(!0))}_refreshMenu(){const t=vt("info-bar"),i=vt("info-bar-slide"),n=vt("view-list"),r=vt("view-list-slide"),o=vt("menu-bar"),l=vt("menu-bar-slide"),c=vt("menu-bar-folder"),d=vt("view-mode-slide");if(un(c,!!this._scene&&!this._pointerLockEnabled),this.visible)t.style.pointerEvents="auto",i.style.left="0",n.style.pointerEvents="auto",r.style.top="0",o.style.pointerEvents="auto",l.style.right="0",c.style.pointerEvents="auto",c.children[0].style.transform="",d&&(d.style.left="0");else{const f=vt("menu-bar-content");t.style.pointerEvents="none",i.style.left=-i.offsetWidth+"px",n.style.pointerEvents="none",r.style.top=-r.offsetHeight+"px",o.style.pointerEvents="none",c.style.pointerEvents="auto",l.style.right=-f.offsetWidth+"px",c.children[0].style.transform="rotate(180deg)",d&&(d.style.left=-d.offsetWidth+"px");return}this.cover&&this._fillCover();const u=this._visibleViews(),h=vt("view-list-items");fs("view-list",u.length>0&&!this._pointerLockEnabled),u.length>0&&this._fillUiViews(u,h),fs("menu-buttons",!!this._scene&&!this._pointerLockEnabled),this._scene&&this._scene.canStartAutoTour()&&!this._vrEnabled?fs("tour-button",!0):(this._autoTour&&this._autoTour.isRunning()&&this._autoTour.stop(),fs("tour-button",!1))}_refreshHelp(){const t=this.helpVisible;if(it.mobile)fs("mobile-help",t);else if(fs("desktop-help",t),t){const i=vt("desktop-help-switch"),n=vt("desktop-help-content"),r=this._advancedDesktopHelp?1:0;i.children[r].classList.add("selected"),un(n.children[r],!0),i.children[1-r].classList.remove("selected"),un(n.children[1-r],!1)}}_toggleMenu(){this.visible=!this._showMenuSetting}_toggleHelp(){this.helpVisible=!this._showHelpSetting}_switchToBasicDesktopHelp(){this._advancedDesktopHelp=!1,this.refresh()}_switchToAdvancedDesktopHelp(){this._advancedDesktopHelp=!0,this.refresh()}_switchToPreviousView(){const t=this._stopAutoTour();this._teleport.switchToPreviousVisibleView(t?0:void 0)}_switchToNextView(){const t=this._stopAutoTour();this._teleport.switchToNextVisibleView(t?0:void 0)}_showInteractionPrompt(){const t=vt("interaction-prompt");t&&(this._interactionPrompt=!0,Rm(t))}_hideInteractionPrompt(){this._interactionPrompt&&(this._interactionPrompt=!1,gd(vt("interaction-prompt")))}_onKeyDown(t){if(this._hideInteractionPrompt(),t.ctrlKey||t.altKey||t.metaKey)return;const i=t.target||t.srcElement,n=i.nodeType===Node.ELEMENT_NODE?i.nodeName.toUpperCase():"";if(/INPUT|SELECT|TEXTAREA/.test(n))return;if(D.DEBUG){if(t.key.toLowerCase()==="c"){const o=it.gl.extension("WEBGL_lose_context");tt(o),t.shiftKey?o.restoreContext():o.loseContext()}t.key==="r"&&HA()}if(!this._scene)return;switch(t.key.toLowerCase()){case"escape":this._stopAutoTour();break;case"f":this._fullScreenSupported&&this._toggleFullScreen();break;case"l":this._pointerLockSupported&&this._togglePointerLock();break;case"h":this._toggleHelp();break;case"m":this._toggleMenu();break;case"v":this._vrSupported&&this._toggleVr();break;case"p":D.NO_SCREENSHOTS||(t.shiftKey?this._screenshotTaker.monoScreenToLocalImage(!0,4e3,2e3):this._screenshotTaker.monoScreenToLocalImage(!1,window.innerWidth,window.innerHeight));break;case"u":gr(gi("lib/qrcode.js"),q1,()=>Wt.error("Cannot load required library"));break;case"[":this._switchToPreviousView();break;case"]":this._switchToNextView();break}const r=parseInt(t.key);if(!isNaN(r)){const o=this._findViewByIdx(r-1);o&&this._viewClicked(o)(t)}}_onMousePressed(){this._hideInteractionPrompt()}_onWheelScroll(){this._hideInteractionPrompt()}_onTouchStart(){this._hideInteractionPrompt()}_onGamepadActionActivated(t){switch(this._hideInteractionPrompt(),t.action){case Be.PREVIOUS:this._switchToPreviousView();break;case Be.NEXT:this._switchToNextView();break}}refresh(){this._refreshMenu(),this._refreshHelp()}get visible(){const t=this._vrEnabled&&it.mobile;return this._showMenuSetting&&!t}set visible(t){const i=this.visible;this._showMenuSetting=t,i!==this.visible&&this.dispatchEvent(Ba._visibilityChangedEvent),this.refresh()}get helpVisible(){const t=this._vrEnabled&&it.mobile;return this._showHelpSetting&&!t&&!this._pointerLockEnabled}set helpVisible(t){this._showHelpSetting=t,this.refresh()}updateCover(t){this.cover=t,this._forceInfoTextTimer!==void 0&&clearTimeout(this._forceInfoTextTimer),this._forceInfoTextTimer=setTimeout(()=>{this._forceInfoTextTimer=void 0,this.refresh()},5e3),this.refresh()}onFullScreenChange(t){}onPointerLockChange(t){this._pointerLockEnabled=t,this.refresh()}onVrChange(t){const i=this.visible;this._vrEnabled=t,i!==this.visible&&this.dispatchEvent(Ba._visibilityChangedEvent),this.refresh()}onResize(){if(!this.visible){const t=[vt("info-bar-slide"),vt("menu-bar-slide"),vt("view-list-slide")];t.forEach(i=>i.style.transition="none"),this.refresh(),t.forEach(i=>i.style.transition="")}}enablePlayButton(t){const i=vt("play-button");i.addEventListener("click",t),un(i,!0)}setVrSupported(t){this._vrSupported=t,Kl("vr-specific",t)}setFullScreenSupported(){this._fullScreenSupported=!this._editMode,this._fullScreenSupported&&Kl("fullscreen-specific",!0)}setPointerLockSupported(){this._pointerLockSupported=!this._editMode}addExtraButton(t){const i=vt("tour-button"),n=document.createElement("img");n.src=t;const r=document.createElement("div");return r.className="menu-button menu-item ui-hoverable ui-panel",r.appendChild(n),i.parentNode.insertBefore(r,i),r}removeExtraButton(t){t.remove()}getExtraButonIcon(t){return t.firstElementChild}sceneLoadStarted(){fs("play-button",!1),fs("primary-progress",!0)}loadProgress(t){if(!this._scene){const r=Math.max(314.159*(1-t),0);vt("primary-progress-done").style.strokeDashoffset=r.toString()}const n=Math.floor(t*100);vt("secondary-progress-done").style.width=n+"%"}sceneReadyToDisplay(t,i,n,r){this._scene=t,this._teleport=i,this._teleport.addEventListener("teleportStarted",this._onTeleportStarted.bind(this)),this._teleport.addEventListener("teleportDone",this._onTeleportDone.bind(this)),this._autoTour=n,this._autoTour.addEventListener("tourStarted",this._onTourStarted.bind(this)),this._autoTour.addEventListener("tourStopped",this._onTourStopped.bind(this)),this._screenshotTaker=r,gd(vt("cover-image")),gd(vt("primary-progress")),Rm(vt("secondary-progress"));const o=Li();this._scene.interactionPrompt&&!this._showHelpSetting&&!D.EDIT_MODE&&(o._isMeeting()?o._onMeetingJoined(()=>this._showInteractionPrompt()):this._showInteractionPrompt()),this._scene.addEventListener(wi.viewAddedEventType,()=>this.refresh()),this._scene.addEventListener(wi.viewRemovedEventType,()=>this.refresh()),this._scene.addEventListener(wi.viewShiftedEventType,()=>this.refresh()),document.body.style.backgroundImage="none",document.body.style.backgroundColor="#000",this.refresh()}sceneLoadComplete(){fs("secondary-progress",!1)}init(){this._editMode&&(Kl("viewer-specific",!1),Kl("editor-specific",!0)),md("ui-panel",n=>Gl(n)),it.mobile&&X1("ui-hoverable");const t=vt("author-logo"),i=t.firstElementChild;i.onload=()=>un(t,!0),i.onerror=()=>un(t,!1),document.addEventListener("keydown",this._onKeyDown.bind(this),!1),document.addEventListener("mousedown",this._onMousePressed.bind(this),!1),document.addEventListener("wheel",this._onWheelScroll.bind(this),!1),document.addEventListener("touchstart",this._onTouchStart.bind(this),!1),Ii("help-button",this._toggleHelp.bind(this)),Ii("fullscreen-button",this._toggleFullScreen),Ii("vr-button",this._toggleVr),Ii("tour-button",this._toggleAutoTour.bind(this)),Ii("menu-bar-folder",this._toggleMenu.bind(this)),Ii("view-list-folder",this._toggleMenu.bind(this)),Ii("basic-desktop-help-option",this._switchToBasicDesktopHelp.bind(this)),Ii("advanced-desktop-help-option",this._switchToAdvancedDesktopHelp.bind(this)),Ii("close-desktop-help-button",this._toggleHelp.bind(this)),Ii("close-mobile-help-button",this._toggleHelp.bind(this)),this._gamepadManager.addEventListener("actionActivated",this._onGamepadActionActivated.bind(this)),this.refresh()}contextLost(){this._scene=this._teleport=this._autoTour=this._screenshotTaker=void 0,this.refresh()}};a(Ba,"_visibilityChangedEvent",{type:"visibilityChanged"});let _d=Ba;function Im(s,e){return Math.abs(s.x-e.x)<Number.EPSILON&&Math.abs(s.y-e.y)<Number.EPSILON&&Math.abs(s.z-e.z)<Number.EPSILON}function vd(){return window.innerWidth<640||window.innerHeight<640}function Dm(s,e,t){const i=Math.sin(e),n=Math.cos(e),r=(s.x-t.x)*n-(s.y-t.y)*i+t.x,o=(s.x-t.x)*i+(s.y-t.y)*n+t.y;s.set(r,o,s.z)}function Y1(s){const e=document.createElement("canvas");e.width=s,e.height=s;const i=60*Math.PI/180,n=-i/2-Math.PI/2,r=i/2-Math.PI/2,o=e.getContext("2d");return o.beginPath(),o.arc(s/2,s/2,4,0,Math.PI*2),o.fillStyle="rgb(0, 220, 255)",o.fill(),o.moveTo(s/2,s/2),o.arc(s/2,s/2,12,n,r,!0),o.lineTo(s/2,s/2),o.arc(s/2,s/2,90,n,r),o.lineTo(s/2,s/2),o.fillStyle="rgba(0, 220, 255, 0.5)",o.fill(),e}const Q1=function(s,e){const i=document.createElement("div"),n=Y1(200),r="translate(-"+200/2+"px, -"+200/2+"px)";i.style.width="200px",i.style.height="200px",i.style.position="absolute",i.style.pointerEvents="none",i.style.zIndex="2",i.style.opacity="1",i.style.transition="opacity 0.5s",i.id="minimap-camera",i.appendChild(n),this.update=function(o,l){i.style.left=o.x/s*100+"%",i.style.top=o.y/e*100+"%",i.style.transform=r+" rotate("+l+"rad)"},this.show=function(){i.style.opacity="1"},this.hide=function(){i.style.opacity="0"},this.getContainer=function(){return i}};function K1(s,e){if("ResizeObserver"in window){new ResizeObserver(e).observe(s);return}const t=window.getComputedStyle(s),i=60;let n,r,o,l;function c(){r=i,n||d()}function d(){n=!0;const h=t.width,f=t.height;o!==h||l!==f?(o=h,l=f,e(),window.requestAnimationFrame(d)):r>0?(r-=1,window.requestAnimationFrame(d)):n=!1}new MutationObserver(function(){c()}).observe(s,{attributes:!0}),window.addEventListener("resize",function(){c()})}const Z1=function(s,e,t,i){const n={x:0,y:0},r=document.createElement("canvas");r.width=s*3,r.height=e*3,r.style.position="absolute",r.style.maxWidth="100%",r.style.maxHeight="100%";const o=document.createElement("div");o.classList.add("minimap-content-controller");const l=window.getComputedStyle(r);i.appendChild(r),i.appendChild(o);function c(){o.style.transform="translate("+n.x+","+n.y+")"}function d(){o.style.width=l.width,o.style.height=l.height}K1(t,d),this.add=function(u){o.appendChild(u)},this.clear=function(){o.innerHTML=""},this.updateOffset=function(u){n.x=50-u.x/s*100+"%",n.y=50-u.y/e*100+"%",c()},this.addOffset=function(){c()},this.removeOffset=function(){o.style.transform=""},this.updateRatio=function(u){function h(){const f=Math.abs(Math.sin(u.rotation)),p=Math.abs(Math.cos(u.rotation));r.width=3*(s*u.ratio.x*p+e*u.ratio.y*f),r.height=3*(s*u.ratio.x*f+e*u.ratio.y*p),d()}window.requestAnimationFrame(h)}};function Lm(s,e,t,i){const n=this;let r=!1,o=!1,l=!1,c=null,d=null,u=null,h=[],f=!1,p=-1/0,m=1/0;i.onViewSwitchStarted(()=>f=!0),i.onViewSwitchDone(()=>f=!1);const b=700,{width:_,height:y}=s.calculateRenderSize(b,e.boundingBox),A=document.getElementById("minimap-button-minimize"),T=document.getElementById("minimap-button-maximize"),M=document.getElementById("minimap-button-close"),C=document.getElementById("minimap-button-toggle"),N=document.getElementById("minimap-container"),O=document.getElementById("minimap-wrapper"),q=document.getElementById("minimap-content"),j=document.getElementById("minimap-tabs"),K=new B(0,0,0),de=new B(0,0,0),xe=new Ue,Ve=new Ue,qe={min:0,max:_},k={min:0,max:y};function Q(){h=e.minimapConfig.levels.map(he=>({level:he,canvas:null,tab:null}))}function le(){h.forEach(he=>{he.tab=document.createElement("div"),he.tab.classList.add("minimap-tab"),he.tab.innerText=he.level.name,he.tab.addEventListener("click",function(){n.selectLevel(he.level),Ir()}),j.appendChild(he.tab)})}function ae(he){return he===u}function Ee(he){u=he,c.show(),h.forEach(Ce=>{Ce.level===he?Ce.tab.classList.add("minimap-tab-current"):Ce.tab.classList.remove("minimap-tab-current")})}function te(he){h.forEach(Ce=>{Ce.canvas&&(Ce.canvas.style.opacity=Ce.level===he?"1":"0",Ce.canvas.style.zIndex=Ce.level===he?"1":"0"),Ce.level===he?Ce.tab.classList.add("minimap-tab-active"):Ce.tab.classList.remove("minimap-tab-active")})}function me(){const Ce=h.find(ze=>ze.level===u)?u:h.at(-1).level;n.selectLevel(Ce,!0)}function Fe(he,Ce){const ze=he.slicePlaneHeight-Ce.slicePlaneHeight;return he.slicePlaneHeight-ze/2}function we(he){const Ce=h.filter(gt=>gt.level.slicePlaneHeight<he.slicePlaneHeight).sort((gt,Ut)=>Ut.level.slicePlaneHeight-gt.level.slicePlaneHeight)[0],ze=h.filter(gt=>gt.level.slicePlaneHeight>he.slicePlaneHeight).sort((gt,Ut)=>gt.level.slicePlaneHeight-Ut.level.slicePlaneHeight)[0];p=Ce?Fe(he,Ce.level):-1/0,m=ze?Fe(he,ze.level):1/0}function at(he){return h.reduce(function(ze,gt){return Math.abs(gt.level.slicePlaneHeight-he.z)<Math.abs(ze.level.slicePlaneHeight-he.z)?gt:ze}).level}function et(he){if(he.z>m||he.z<p){const Ce=at(he);we(Ce),n.selectLevel(Ce,!0)}}function U(he,Ce){if(!u)return;!he&&!Ce&&(he=i.getCameraPosition(),Ce=i.getCameraRotation()),xe.set(he.x,he.y),Dm(xe,u.rotation,u.cropRange.center()),Ve.set(Bi(xe.x,u.visibleRange.max.x,u.visibleRange.min.x,qe.max,qe.min),Bi(xe.y,u.visibleRange.max.y,u.visibleRange.min.y,k.max,k.min));const ze=Ce.z*-1+u.rotation*-1;c.update(Ve,ze),l&&d.updateOffset(Ve)}function z(){l=!0,N.classList.add("minimap-container-minimized"),O.classList.add("minimap-wrapper-minimized"),d.addOffset(),U()}function G(){l=!1,N.classList.remove("minimap-container-minimized"),O.classList.remove("minimap-wrapper-minimized"),d.removeOffset()}function X(){r=!0,O.style.transform="translate(-101%, 0)"}function _e(){r=!1,O.style.transform=""}function Ie(){if(!i.menuVisible){X();return}if(l&&vd()){G(),_e();return}r?_e():X()}function Ye(){r&&i.menuVisible&&vd()||Ie()}function ke(){qn(A,z),qn(T,G),qn(M,X),qn(C,Ie),i.onMenuVisibilityChanged(Ye)}function ge(he,Ce){Ce.getContext("2d").putImageData(he,0,0)}function Qe(he,Ce,ze){const gt=(Ce+ze*_)*4+3;return he.data[gt]!==0}function ue(he){const Ce={position:[he.x,he.y,he.z]};return new Qi(Ce)}function Ae(he,Ce,ze){const gt=new B,Ut={min:0,max:1};Ce.addEventListener("click",function(ii){const Oe=Ce.getBoundingClientRect(),R=(ii.clientX-Oe.left)/Oe.width,V=(ii.clientY-Oe.top)/Oe.height,ie=Math.round(R*_),re=Math.round(V*y);if(Qe(he,ie,re)){gt.set(Bi(R,Ut.min,Ut.max,ze.visibleRange.min.x,ze.visibleRange.max.x),Bi(V,Ut.min,Ut.max,ze.visibleRange.min.y,ze.visibleRange.max.y),ze.slicePlaneHeight),Dm(gt,ze.rotation*-1,ze.cropRange.center());const De=ue(gt);t.switchToView(De),ae(ze)||Ee(ze)}Ir()})}function Se(){d.add(c.getContainer()),C.style.display="",N.style.display="",h.length>1&&(j.style.display="",O.classList.add("minimap-wrapper-tabs"))}function We(){d.clear(),j.innerHTML="",j.style.display="none",N.style.display="none",C.style.display="none",O.classList.remove("minimap-wrapper-tabs")}function rt(he){const Ce=document.createElement("canvas");Ce.width=_,Ce.height=y,Ce.style.transition="opacity 0.5s";const{minimapImageData:ze,walkableImageData:gt}=s.createMinimapImageDataComponents(e.minimapConfig,he,_,y);return ge(ze,Ce),Ae(gt,Ce,he),d.add(Ce),Ce}function bt(){Q(),le(),me(),Se()}function ft(){if(!A||!T||!M||!C||!N||!O||!q)return!0}function F(){ft()||(d=new Z1(_,y,O,q),c=new Q1(_,y),vd()?X():z(),ke(),o=!0,bt())}function J(){if(!o){F();return}e.minimapConfig.enabled?(We(),bt()):We()}const Ne={type:"minimapLevelSelected",target:this,level:null};kt.prototype.apply(Lm.prototype),this.selectLevel=function(he,Ce=!1){const ze=h.filter(gt=>gt.level===he)[0];Ce&&Ee(he),ze.canvas||(ze.canvas=rt(he)),ae(he)?c.show():c.hide(),te(he),we(he),U(),d.updateRatio(he),Ne.level=he,this.dispatchEvent(Ne)},this.update=function(){if(ft())return;const he=i.getCameraPosition(),Ce=i.getCameraRotation();(Im(K,he)===!1||Im(de,Ce)===!1)&&(U(he,Ce),f||et(he),K.set(he.x,he.y,he.z),de.set(Ce.x,Ce.y,Ce.z))},e.minimapConfig.enabled&&F(),e.minimapConfig.addEventListener(sa.updatedEventType,J),i._onMeetingJoined(X)}let Fm=null,Ds=!1,bd=!0;const Om=[{name:"mainMaterial",baseColor:[.5,.5,.5],roughness:.7,metallic:1},{name:"displayMaterial",baseColor:[0,0,0],roughness:.001,metallic:0}],ps={sphere:null,cylinder:null,head:[],torso:[],displayPortrait:[],displayLandscape:[]},xa={};function $1(s){(!ps.plane||Fm!==s.id)&&(ps.sphere=dt.createSphere(.08,32,16),ps.sphere.convertNormalsToSpherical(),ps.cylinder=dt.createCylinder(.005,.005,1,3),ps.cylinder.convertNormalsToSpherical(),Fm=s.id)}function J1(s,e,t){const i=new Dt;ps.head.forEach(r=>{i.union(r.geometry.boundingBox)});const n=(i.max.z-i.min.z)/2;return new Rr(s,s.renderCaches,{type:"sprite",position:[0,0,.1+i.center().z+n],height:.1,text:e,textColor:t,opacity:0})}function eA(s){const e=new Je(ps.sphere,s);return e.scale.set(.4,.4,.4),e.visible=!1,e}function tA(s){const e=new si;e.lightmapSupported=!1,e.headLight=!1,e.baseColor.setStyle(s).convertGammaToLinear(),e.transparent=!0,e.opacity=.5,e.emissive=!0,e.disableLightProbe=!0,e.setUniforms();const t=new Je(ps.cylinder,e);return t.visible=!1,t}function iA(s,e){s.length!==e.size&&console.warn("Mismatch between avatar meshes count and geometries map size");for(const t of s){e.has(t.geometryName)||console.assert(!1,'Avatar "'+t.geometryName+'" mesh is missing');const i={materialName:t.materialName?t.materialName:"mainMaterial",geometry:e.get(t.geometryName)};ps[t.group].push(i)}}function yd(s){const e=new si;return e.lightmapSupported=!1,e.baseColor.fromArray(s.baseColor),e.roughness=s.roughness||1,e.metallic=s.metallic||0,e.opacity=s.opacity||1,e.highlight=new Re(16777215),e.highlightMix=0,e.baseColorTexture=s.baseColorTexture,e.disableLightProbe=s.disableLightProbe||!1,e.headLight=s.headLight||!1,e.setUniforms(),e}function nA(s,e){s&&Om.push(...s),Om.forEach(t=>{if(t.baseColorTexture){const i=new Image;i.src=e+t.baseColorTexture.file,t.baseColorTexture=Li().createTextureFromHtmlImage(i)}xa[t.name]=yd(t)})}function sA(s,e,t){Ds=e.displayLookAtCamera||!1,bd=e.rotateHeadInPortraitMode||!0,iA(e.meshes,t),nA(e.materials,s)}class rA extends _t{constructor(e,t,i){super(),this.uuid=t,this.displayName=i.displayName,this._scene=e,this._lastLightProbeCheckPosition=new B(0,0,0),this.colliders=[],$1(e),this._haveLightProbe=this._scene.lightProbes.length>0;for(const o of Object.values(xa))o.disableLightProbe=!this._haveLightProbe,o.headLight=this._haveLightProbe,o.setUniforms();this.mainMaterial=yd(xa.mainMaterial),Ds?(this.displayMaterial=new Sp,this.displayMaterial.reflective=!1,this.displayMaterial.headLight=!1):this.displayMaterial=yd(xa.displayMaterial),this.mainMaterial.baseColor.setStyle(i.color).convertGammaToLinear(),this._body=new _t,this._head=new _t,this._head.rotation.order=Un.ZXY,this._torso=new _t,this._displayLandscape=new _t,this._displayPortrait=new _t;const n=o=>{switch(o){case"mainMaterial":return this.mainMaterial;case"displayMaterial":return this.displayMaterial;default:return xa[o]}},r=(o,l)=>{ps[l].forEach(c=>{const d=n(c.materialName),u=new Je(c.geometry,d);o.add(u),u.visibilityId=null,this.colliders.push(u)})};if(r(this._head,"head"),r(this._torso,"torso"),r(this._displayLandscape,"displayLandscape"),r(this._displayPortrait,"displayPortrait"),this._pointer=eA(this.mainMaterial),this._pointerLeaderStartOffset=new B(0,.3,-.35),this._pointerLeader=tA(i.color),this._displayNameAnchor=J1(e,i.displayName,i.color),this._body.add(this._torso),this._body.add(this._head),Ds?(this.add(this._displayLandscape),this.add(this._displayPortrait)):(this._head.add(this._displayLandscape),this._head.add(this._displayPortrait)),this.add(this._body),this.add(this._displayNameAnchor),this.add(this._pointerLeader),this.add(this._pointer),i.position&&this.position.fromArray(i.position),this.updateMatrixWorld(!0),this._setClosestLightProbe(),Ds){const o=new Dt;this._displayLandscape.children.forEach(l=>{o.union(l.geometry.boundingBox)}),this.displayMaterial.offset=o.center()}this._videoTexture0=null,this._videoTexture1=null,this._landscape=!0,this._displayLandscape.visible=!Ds,this._displayPortrait.visible=!1,this._soundThreshold=140,this._maxHighlight=.5,this._highlightStepDown=.05}switchToPortrait(){this._landscape&&(this._landscape=!1,this._displayLandscape.visible=!1,this._displayPortrait.visible=!0,bd&&!Ds&&(this._head.rotation.y=Math.PI/2,this._torso.position.z-=.05))}switchToLandscape(){this._landscape||(this._landscape=!0,this._displayLandscape.visible=!0,this._displayPortrait.visible=!1,bd&&!Ds&&(this._head.rotation.y=0,this._torso.position.z+=.05))}hideBody(){this.traverse(e=>e.visible=!1),this.visible=!0,this._pointer.visible=!0,this._pointerLeader.visible=!0}_updated(){this.dispatchEvent({type:"avatarUpdated",target:this})}rotate(e,t){this._body.rotation.z=e,this._head.rotation.x=t}setOrientation(){this._videoTexture0.width<this._videoTexture0.height?this.switchToPortrait():this.switchToLandscape()}onVideoStreamStart(){Ds&&(this._displayLandscape.visible=!0,this._displayPortrait.visible=!1)}onVideoStreamStop(){Ds?(this._displayLandscape.visible=!1,this._displayPortrait.visible=!1):this.switchToLandscape()}setVideoTexture0(e){this._videoTexture0&&(this._videoTexture0.dispose(),this._videoTexture0=null),this._haveLightProbe&&(this.displayMaterial.disableLightProbe=!1),this.displayMaterial.baseColorTexture=void 0,this._updated(),e?(this.onVideoStreamStart(),e.addLoadedListener(()=>{this._videoTexture0=e,this.setOrientation(),this.displayMaterial.disableLightProbe=!0,this.displayMaterial.baseColorTexture=e,e.addResizedListener(()=>{this.setOrientation(),this._updated()}),this._updated()})):(this.onVideoStreamStop(),this._updated())}getVideoTexture0(){return this._videoTexture0}setVideoTexture1(e){this._videoTexture1&&(this._videoTexture1.dispose(),this._videoTexture1=null,this._updated()),e&&e.addLoadedListener(()=>{this._videoTexture1=e,this._updated()})}getVideoTexture1(){return this._videoTexture1}getMainMaterial(){return this.mainMaterial}_setClosestLightProbe(){const e=this._scene.closestLightProbe(this.position);if(this._head.children[0].lightProbes!==void 0){for(const t of this._head.children[0].lightProbes)if(t===e)return}for(const t of[this._head,this._torso,this._displayPortrait,this._displayLandscape])t.children.forEach(i=>{i.lightProbes=[e]});this._pointer.lightProbes=[e],this._pointerLeader.lightProbes=[e]}setPositionFromArray(e){this.position.fromArray(e),this._lastLightProbeCheckPosition.distanceTo(this.position)>.5&&(this._lastLightProbeCheckPosition.copyFrom(this.position),this._setClosestLightProbe(this.position))}placePointer(e,t,i){const n=new je,r=new B,o=new B,l=new B,c=new B,d=new je,u=new je;u.set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1);const h=new je;this._pointer.position.set(e-this.position.x,t-this.position.y,i-this.position.z),this._pointer.visible=!0,n.makeRotationZ(this._body.rotation.z),r.set(this._pointerLeaderStartOffset.x,this._pointerLeaderStartOffset.y,this._pointerLeaderStartOffset.z),n.affineTransformPoint3(r),o.set(this.position.x,this.position.y,this.position.z).add(r),l.set(e,t,i),c.set(e,t,i).sub(o),h.makeScale(1,c.length(),1),d.lookAt(o,l,_t.DEFAULT_UP),d.multiply(u),h.multiplyMatrices(d,h),c.divideScalar(2).add(r),h.setPosition(c),this._pointerLeader.matrix.identity(),this._pointerLeader.applyMatrix(h),this._pointerLeader.visible=!0}hidePointer(){this._pointerLeader.visible=!1,this._pointer.visible=!1}onSoundVolumeUpdated(e){if(e===null)return;const t=this._computeHighlighMix(e);this.getMainMaterial().highlightMix!==t&&(this.getMainMaterial().highlightMix=t,Li().requestFrame())}onSoundSwitchedOff(){this.getMainMaterial().highlightMix>0&&(this.getMainMaterial().highlightMix=0,Li().requestFrame())}_computeHighlighMix(e){const t=this.getMainMaterial().highlightMix;if(e<this._soundThreshold)return t>0?Math.max(0,t-this._highlightStepDown):0;{const i=(e-this._soundThreshold)/(255-this._soundThreshold)*this._maxHighlight;return i>t?i:Math.max(i,t-this._highlightStepDown)}}dispose(){this.mainMaterial.dispose(),this.displayMaterial.dispose(),this._videoTexture0&&this._videoTexture0.dispose(),this._videoTexture1&&this._videoTexture1.dispose(),this._displayNameAnchor.dispose(),this.dispatchEvent({type:"dispose"})}}const oA=.1,rs=class rs{constructor(e,t,i,n,r,o,l){a(this,"lightmap",null);a(this,"meshes",new Array);a(this,"_gazeModeObserver");a(this,"_gazeListeners",new Array);a(this,"_onGazeModeEnabled",()=>this._setGaze(!0));a(this,"_onGazeModeDisabled",()=>this._setGaze(!1));this._gazeModeObserver=l;const c=Math.max(n.camera.near*2,oA);this._gazeModeObserver.addEventListener(Ss.modeEnabledEventType,this._onGazeModeEnabled),this._gazeModeObserver.addEventListener(Ss.modeDisabledEventType,this._onGazeModeDisabled);let[d,u,h,f]=this._computeSphereParameters(e,n,c);if(e.some(m=>m.lightmapEnabled)){let m=o.measureIncidentLuma();m<0&&(m=1);const b=n.sharedMaterialState.lightmapEncoding;this.lightmap=Il.createSingleColorLightmap(new Re(m,m,m),b)}const p=new B;e.forEach((m,b)=>{if(!m)return;p.set(d,u,-c);const _=this._createSphereMesh(n,m,h,p,this.lightmap);d+=2*h+f;const y=this._computeWorldStaticMatrix(r.cameraWorldPosition(),i,t,h,p,b);this.meshes.push(_),this._gazeListeners.push(A=>{A&&y?(_.matrix=y,_.matrixWorld=y):(_.matrix=n.camera.matrix,_.matrixWorld=n.camera.matrixWorld)})}),this._setGaze(l.modeIsEnabled())}_rotationAngle(e){return Math.abs(e.y)>Math.abs(e.x)?e.x>0?0:-Math.PI:e.y>0?Math.PI/2:-Math.PI/2}_createSphereMesh(e,t,i,n,r){t instanceof Xo&&(i-=Math.min(1,t.grassHeight)*i*.5);const o=dt.createSphere(i,32,16);o.changePosition(n),o.computeBoundingSphere(),o.convertNormalsToSpherical();const l=new As(null,o,t);return t.lightmapEnabled&&(l.lightmap=r),t instanceof Xo&&(l.grassScaleOverride=i),e.camera.getWorldPosition(rs._cameraPositionTemp),l.lightProbes=[e.closestLightProbe(rs._cameraPositionTemp)],l.frustumCulled=!1,l.userData.hideFromLightProbes=!0,l}_computeSphereParameters(e,t,i){const n=t.camera.fov,r=t.camera.aspectRatio,o=Math.tan(oi(n/2))*i,l=-o,c=r*l,d=r*o,u=Math.abs(d-c),h=Math.abs(o-l),f=.01*u;let p=(u-e.length*f-f)/(2*e.length);p=Math.min(p,D.MATERIAL_PICKER_BALL_MAX_SIZE/2*u);const m=-(2*p+f)*(e.length/2)+p+f,b=document.getElementById("menu-bar").getBoundingClientRect().top,y=(window.innerHeight-b)/window.innerHeight,A=-h/2+h*y+p+f;return[m,A,p,f]}_computeWorldStaticMatrix(e,t,i,n,r,o){if(!i)return;const l=new je,c=rs._mat4Temp;return l.multiply(c.makeTranslation(i.x,i.y,i.z)),rs._vec2Temp.x=e.x-i.x,rs._vec2Temp.y=e.y-i.y,l.multiply(c.makeRotationZ(this._rotationAngle(rs._vec2Temp))),l.multiply(c.makeRotationX(-Math.PI/2)),l.multiply(c.makeScale(t,t,t)),l.multiply(c.makeTranslation((o+1)*2.1,0,0)),l.multiply(c.makeScale(1/n,1/n,1/n)),l.multiply(c.makeTranslation(-r.x,-r.y,-r.z)),l}_setGaze(e){this._gazeListeners.forEach(t=>t(e))}dispose(){this._gazeListeners.length=0,this._gazeModeObserver.removeEventListener(Ss.modeEnabledEventType,this._onGazeModeEnabled),this._gazeModeObserver.removeEventListener(Ss.modeDisabledEventType,this._onGazeModeDisabled),this.meshes.forEach(e=>e.geometry.dispose()),this.meshes=[],this.lightmap&&(this.lightmap.dispose(),this.lightmap=null)}};a(rs,"_cameraPositionTemp",new B),a(rs,"_mat4Temp",new je),a(rs,"_vec2Temp",new Ue);let xd=rs;function Bm(s,e,t){let i,n=null,r,o,l,c,d,u,h,f,p,m,b,_,y=!1,A=!1,T=null,M=null;const C={nextPageInteraction:[],viewerConfigLoaded:[],sceneReadyToDisplay:[],sceneLoadComplete:[],anchorClicked:{},materialPickerClicked:{},materialPickerClosed:null,nodeTypeClicked:{},anyNodeTypeClicked:[],materialClicked:{},nodeTypeHoverChanged:{},materialHoverChanged:{},viewSwitchStarted:[],viewSwitchDone:[],vrChange:[],beforeRender:[],anchorsVisibilityChanged:[],apiUserStateChanged:{},anyApiUserStateChanged:[],meetingJoined:[],avatarListChanged:[]},N=[],O=[];let q=0;function j(...F){return null}function K(F){t.isMaterialEditable(F)||console.assert(!1,"Can't access material, call ViewerApi.setMaterialEditable('"+F+"') before the scene is loaded.")}function de(){const F=[];for(const J of n.materials)t.isMaterialEditable(J.name)&&F.push(J);return F}function xe(){const F=[];for(const J of n.nodeConfigs)t.isNodeTypeEditable(J.name)&&F.push(J.name);return F}function Ve(F){K(F);for(const J of n.materials)if(J.name===F)return J;return null}const qe=new B;function k(){return qe.copyFrom(r.cameraWorldPosition()),qe}const Q=new mi;function le(){return Q.yaw=r.getYawAngle(),Q.pitch=r.getPitchAngle(),Q.roll=0,Q}function ae(){return n.boundingBox}function Ee(F){const J=[];K(F);for(let Ne of n.gpuMeshes)Ne.material.name===F&&J.push(Ne);return J}function te(F){const J=n.findNodeConfig(F);return J?J.nodes.slice(0):[]}function me(F,J){J.geometry.isUvs0Repeating&&F.ensureTexturesRepeatable&&F.ensureTexturesRepeatable(),J.material=F,h.requestFrame()}function Fe(F,J){console.warn("setMaterialForNode() is deprecated, use setMaterialForMesh() instead"),me(F,J)}this.visibleViews=function(){return n.visibleViews()};function we(F,J,Ne){let he;if(typeof F=="string"){let Ce=F;he=n.findViewByName(Ce)}else he=F;he?(J===!0?J=0:J===!1&&(J=void 0),l.isRunning()&&(J=0,l.stop()),Ne?(o.activateSky(he),o.updateHiddenMeshes(he)):o.switchToView(he,J)):console.error("Unknown view: "+F)}function at(F={}){const J=F.isPanorama||!1;function Ne(){return J?4e3:window.innerWidth}function he(){return J?2e3:window.innerHeight}const Ce=F.width||Ne(),ze=F.height||he();if(F.toDataUrl||!1)return d.monoScreenToDataUrl(J,Ce,ze);d.monoScreenToLocalImage(J,Ce,ze)}function et(F){n.addAuxiliaryObject(F),F!==F.colliderMesh&&i.uploadNewBuffers(F.colliderMesh),c.addDynamicObstacle(F.colliderMesh)}function U(F){n.removeAuxiliaryObject(F),c.removeDynamicObstacle(F.colliderMesh)}function z(F,...J){try{return F(...J)}catch(Ne){console.error(Ne)}return!1}function G(F,...J){if(F)for(let Ne of F)z(Ne,...J)}function X(){G(C.nextPageInteraction),C.nextPageInteraction.length=0}document.addEventListener("keydown",X),document.addEventListener("mousedown",X),document.addEventListener(it.ios?"touchstart":"touchend",X);let _e=!0;Object.defineProperty(this,"anchorsVisible",{get(){return _e},set(F){F!==_e&&(_e=F,_e?N.forEach(J=>et(J)):N.forEach(J=>U(J)),this.requestFrame(),G(C.anchorsVisibilityChanged,_e))}});function Ie(F,J){const Ne=new Rr(n,n.renderCaches,F);return N.push(Ne),_e&&et(Ne),C.anchorClicked[Ne.colliderMesh.id]=J,y=!0,h.requestFrame(),Ne}function Ye(F){delete C.anchorClicked[F.colliderMesh.id],_e&&U(F),zi(F,N),F.dispose(),h.requestFrame()}function ke(F,J){const Ne=new rA(n,F,J);O.push(Ne),n.addAuxiliaryObject(Ne,!0);for(let he of Ne.colliders)c.addDynamicObstacle(he);return G(C.avatarListChanged),Ne}function ge(F){for(let J of F.colliders)c.removeDynamicObstacle(J);n.removeAuxiliaryObject(F),zi(F,O),F.dispose(),G(C.avatarListChanged)}function Qe(F){return O.find(J=>J.uuid===F)}function ue(){for(const F of n.getAnimatedMaterials())F.sleepAnimation()}function Ae(){for(const F of n.getAnimatedMaterials())F.wakeAnimation();h.requestFrame()}function Se(F,J){return f.getExtension(F,J)}function We(F,J){let Ne=F[J];return Ne||(Ne=[],F[J]=Ne,Ne)}const rt=function(){const J=new B,Ne=new B,he=new B,Ce=new Tn,ze=new B,gt=new mi;let Ut;function ii(Oe,R,V){Ne.set(Oe.x,Oe.y,Ut.z).sub(Ut);const ie=Ne.length();ie>R&&(Ne.normalize().multiplyScalar(ie-R),V.add(Ne))}return function(Oe){Ut=r.cameraWorldPosition(),ze.copyFrom(Ut);let R;Oe instanceof Ml&&Oe.light.type===hn.SUN?(Zm(n,Oe.rotation,J),R=J):Oe instanceof lp?(qA(Oe,Ce),R=Ce.center,ii(R,1+Ce.radius,ze)):(R=Oe.position,ii(R,1,ze)),he.copyFrom(R).sub(ze).normalize(),gt.setFromDirection(he);const V=new Qi({position:ze.toArray(),rotation:[gt.yawDeg,gt.pitchDeg],mode:o.lastDestinationView.mode,orthographic:o.lastDestinationView.orthographic,orthoFrustumSize:o.lastDestinationView.orthoFrustumSize,distance:o.lastDestinationView.orthographic?o.lastDestinationView.distance:1,target:R.toArray()});o.switchToView(V)}}();this.getCurrentMaterialPickerId=function(){return T?q:null},this.openMaterialPicker=function(F,J,Ne,he,Ce){return console.assert(!T,"Only one material picker can be opened"),T=new xd(F,he,Ce,n,r,u,b),T.meshes.forEach(function(ze){n.addAuxiliaryObject(ze),c.addDynamicObstacle(ze),C.materialPickerClicked[ze.id]=J}),C.materialPickerClosed=Ne,++q},this.closeMaterialPicker=function(){T&&(T.meshes.forEach(function(F){n.removeAuxiliaryObject(F),c.removeDynamicObstacle(F),delete C.materialPickerClicked[F.id]}),T.dispose(),T=null,C.materialPickerClosed&&(C.materialPickerClosed(),C.materialPickerClosed=null))},window.addEventListener("resize",this.closeMaterialPicker.bind(this)),this._vrChange=function(F){G(C.vrChange,F)},this._update=function(F){G(C.beforeRender,F)},this._clickListener=function(F,J,Ne){if(!y)return!1;if(T){const ze=C.materialPickerClicked[F.id];return ze?(z(ze,F.material,T.meshes.indexOf(F)),!0):(this.closeMaterialPicker(),!0)}const he=C.anchorClicked[F.id];if(he)return z(he,F.anchor,J,Ne),!0;const Ce=(ze,gt)=>{if(ze){for(let Ut of ze)if(z(Ut,gt,J,Ne))return!0}return!1};for(let ze=F.node;ze;ze=ze.parent)if(Ce(C.nodeTypeClicked[ze.type],F.node))return!0;return F.node&&Ce(C.anyNodeTypeClicked,F.node)?!0:F.material?Ce(C.materialClicked[F.material.name],F.material):!1},this._createHoverListener=function(){const F=[];return function(J,Ne){if(J instanceof Rr)return(C.nodeTypeHoverChanged[J]||F).some(Ce=>z(Ce,J,Ne));for(let he=J.node;he;he=he.parent)if((C.nodeTypeHoverChanged[he.type]||F).some(ze=>z(ze,he,Ne)))return!0;return J.material?(C.materialHoverChanged[J.material.name]||F).some(Ce=>z(Ce,J.material,Ne)):!1}},this._teleportStarted=function(F){const J=F.view;J&&G(C.viewSwitchStarted,J.name,J)},this._teleportDone=function(F){const J=F.view;J&&G(C.viewSwitchDone,J.name,J)},this._viewerConfigLoaded=function(F){p=F,G(C.viewerConfigLoaded,p),C.viewerConfigLoaded=[]},this._sceneReadyToDisplay=function(F,J,Ne,he,Ce,ze,gt,Ut,ii,Oe,R,V,ie){i=F,n=J,r=Ne,o=he,l=Ce,c=ze,d=gt,u=Ut,m=ii,b=Oe,_=R,h=V,f=ie,this.getEditableMaterials=de,this.getEditableNodeTypes=xe,this.findMaterial=Ve,this.findMeshesWithMaterial=Ee,this.findNodesOfType=te,this.getCameraPosition=k,this.getCameraRotation=le,this.getSceneBoundingBox=ae,this.setMaterialForNode=Fe,this.setMaterialForMesh=me,this.switchToView=we,this.captureImage=at,this.addAnchor=Ie,this.removeAnchor=Ye,this.addAvatar=ke,this.removeAvatar=ge,this.findAvatar=Qe,this.seeItem=rt,this.sleepAnimatedMaterials=ue,this.wakeAnimatedMaterials=Ae,this.getExtension=Se,G(C.sceneReadyToDisplay,n),C.sceneReadyToDisplay=[],o.addEventListener("teleportStarted",this._teleportStarted.bind(this)),o.addEventListener("teleportDone",this._teleportDone.bind(this))},this._contextLost=function(){A=!1,p=n=o=l=c=d=_=h=null,this.getEditableMaterials=j,this.getEditableNodeTypes=j,this.findMaterial=j,this.findMeshesWithMaterial=j,this.findNodesOfType=j,this.setMaterialForNode=j,this.setMaterialForMesh=j,this.switchToView=j,this.captureImage=j,this.addAnchor=j,this.addAvatar=j,this.removeAnchor=j,this.findAvatar=j,this.sleepAnimatedMaterials=j,this.wakeAnimatedMaterials=j,this.getExtension=j},this._sceneLoadComplete=function(){G(C.sceneLoadComplete),C.sceneLoadComplete=[],A=!0;for(const F of N)F.enableLightProbe()},this.openUrl=function(F,J){if(J||s)return window.open(F);window.location.href=F},this.onNextPageInteraction=function(F){C.nextPageInteraction.push(F)},this.onViewerConfigLoaded=function(F){if(p){F(p);return}C.viewerConfigLoaded.push(F)},this.isSceneReadyToDisplay=function(){return n!==null},this.onSceneReadyToDisplay=function(F){if(n){F(n);return}C.sceneReadyToDisplay.push(F)},this.onSceneLoadComplete=function(F){if(A){F(n);return}C.sceneLoadComplete.push(F)},this.requestFrame=function(){h&&h.requestFrame()},this.setNodeTypeEditable=function(F){console.assert(n===null,"setNodeTypeEditable must be called before the scene is loaded"),t.setNodeTypeEditable(F)},this.setMaterialEditable=function(F){console.assert(n===null,"setMaterialEditable must be called before the scene is loaded"),t.setMaterialEditable(F)},this.setAllMaterialsEditable=function(){console.assert(n===null,"setAllMaterialsEditable must be called before the scene is loaded"),t.setAllMaterialsEditable()},this.onCameraPositionUpdated=function(F){n.camera.addEventListener("positionChanged",F)},this.removeOnCameraPositionUpdated=function(F){n.camera.removeEventListener("positionChanged",F)},this.onNodeTypeClicked=function(F,J){typeof F=="function"?(J=F,C.anyNodeTypeClicked.push(J)):We(C.nodeTypeClicked,F).push(J),y=!0},this.removeOnNodeTypeClicked=function(F,J){typeof F=="function"?(J=F,zi(J,C.anyNodeTypeClicked)):zi(J,C.nodeTypeClicked[F])},this.onMaterialClicked=function(F,J){this.setMaterialEditable(F),We(C.materialClicked,F).push(J),y=!0},this.onNodeTypeHoverChanged=function(F,J){F instanceof Rr||this.setNodeTypeEditable(F),We(C.nodeTypeHoverChanged,F).push(J)},this.onMaterialHoverChanged=function(F,J){this.setMaterialEditable(F),We(C.materialHoverChanged,F).push(J)},this.onViewSwitchStarted=function(F){C.viewSwitchStarted.push(F)},this.onViewSwitchDone=function(F){C.viewSwitchDone.push(F)},this.onVrChange=function(F){C.vrChange.push(F)},this.onBeforeRender=function(F){C.beforeRender.push(F)},this.createTextureFromHtmlImage=function(F,J=!1){const Ne=new wt;Ne.image=F,Ne.wrapS=Ne.wrapT=ne.REPEAT,Ne.minFilter=ne.LINEAR_MIPMAP_LINEAR,Ne.format=J?nt.RGBA8:nt.RGB8,Ne.hasAlpha=J;let he=null;function Ce(){Ne.needsUpdate=!0,Ne.width=F.naturalWidth,Ne.height=F.naturalHeight,Ne.notifyLoaded()}function ze(){Ce(),he&&he(),F.onload=he}return F.complete&&F.naturalHeight!==0?Ce():(he=F.onload,F.onload=ze),Ne},this.createTextureFromHtmlVideo=function(F){const J=new ra;J.video=F,J.minFilter=ne.LINEAR,J.format=nt.RGB8,J.generateMipmaps=!1;function Ne(he){J.width=he.videoWidth,J.height=he.videoHeight,J.wrapS=ne.REPEAT,J.wrapT=ne.REPEAT,J.notifyLoaded()}return F.setAttribute("playsinline",""),F.setAttribute("webkit-playsinline",""),F.crossOrigin="anonymous",lu(F,Ne),J},this.createStreamTextureFromHtmlVideo=function(F){const J=this.createTextureFromHtmlVideo(F);return J._interruptible=!1,J},this.addAnchor=function(F,J){},this.removeAnchor=function(F){},this.addAvatar=function(){},this.removeAvatar=function(){},this.findAvatar=function(F){},this.sleepAnimatedMaterials=function(){},this.wakeAnimatedMaterials=function(){},this.getExtension=function(F,J){},this.onAnchorsVisibilityChanged=function(F){C.anchorsVisibilityChanged.push(F)},this.removeAnchorsVisibilityChangedListener=function(F){C.anchorsVisibilityChanged=C.anchorsVisibilityChanged.filter(J=>J!==F)},this.getEditableMaterials=j,this.getEditableNodeTypes=j,this.findMaterial=j,this.findMeshesWithMaterial=j,this.findNodesOfType=j,this.getCameraPosition=j,this.getCameraRotation=j,this.getSceneBoundingBox=j,this.setMaterialForNode=j,this.setMaterialForMesh=j,this.switchToView=j,this.captureImage=j,this.seeItem=j,this.getViewerAssetUrl=F=>gi(F),this.addMenuButton=function(F){return e.addExtraButton(F)},this.removeMenuButton=function(F){e.removeExtraButton(F)},this.getMenuButtonIcon=function(F){return e.getExtraButonIcon(F)},Object.defineProperty(this,"menuVisible",{get(){return e.visible},set(F){e.visible=F}}),this.onMenuVisibilityChanged=function(F){e.addEventListener("visibilityChanged",function(){F()})},Object.defineProperty(this,"helpVisible",{get(){return e.helpVisible},set(F){e.helpVisible=F}}),this.play=function(){Km()};const bt={};this.apiUserChangeState=function(F,J){if(Oo(bt[F],J))return;bt[F]=Fo(J);const Ne=Mn(J);G(C.apiUserStateChanged[F],F,Ne),G(C.anyApiUserStateChanged,F,Ne)},this.onApiUserStateChanged=function(F,J){typeof F=="function"?(J=F,C.anyApiUserStateChanged.push(J)):We(C.apiUserStateChanged,F).push(J)},this.removeOnApiUserStateChanged=function(F,J){typeof F=="function"?(J=F,zi(J,C.anyApiUserStateChanged)):zi(J,C.apiUserStateChanged[F])},this.getApiUserState=function(F){if(F===void 0)return Mn(bt);const J=bt[F];return J===void 0?void 0:Mn(J)},this._meetingJoined=function(F){console.assert(M===null),M=F,G(C.meetingJoined,M)},this._isMeeting=function(){return D.urlHashContains("meeting-key")||D.urlHashContains("meeting")},this._onMeetingJoined=function(F){C.meetingJoined.push(F),M!==null&&F(M)},this._removeOnMeetingJoined=function(F){zi(F,C.meetingJoined)},this._onAvatarListChanged=function(F){C.avatarListChanged.push(F)},this._removeOnAvatarListChanged=function(F){zi(F,C.avatarListChanged)},this._createPointerEventHelper=function(F){return new ml(_,F)},this._disableControls=function(){r.disable()},this._enableControls=function(){r.enable()};const ft=new Vn;this._findIntersectionAtPosition=function(F,J){return c.findIntersectionAtPosition(F,J,!0,ft),ft},this.getWalkMaxSpeed=function(){return console.assert(n,"getWalkMaxSpeed must be called after the scene is loaded"),n.camera.moveMaxSpeed},this.setWalkMaxSpeed=function(F){console.assert(n,"setWalkMaxSpeed must be called after the scene is loaded"),n.camera.moveMaxSpeed=F},this.openPopup=function(F,J={},Ne=void 0){return pa.openPopup(F,J,Ne)},this.enableMinimap=function(){console.assert(n,"enableMinimap must be called after the scene is loaded"),n.minimapConfig.enabled=!0},this.disableMinimap=function(){console.assert(n,"disableMinimap must be called after the scene is loaded"),n.minimapConfig.enabled=!1},this.isMinimapEnabled=function(){return console.assert(n,"isMinimapEnabled must be called after the scene is loaded"),n.minimapConfig.enabled},this.vrEnabled=function(){return console.assert(n,"vrEnabled must be called after the scene is loaded"),m.vrEnabled()},this.enableVr=function(){console.assert(n,"enableVr must be called after the scene is loaded"),m.vrEnabled()||m.enableVr(i.context)},this.disableVr=function(){console.assert(n,"disableVr must be called after the scene is loaded"),m.vrEnabled()&&m.disableVr()}}function aA(s,e,t,i,n,r,o){const l=navigator.xr,c=t?!t.nativeWebXR:!1,d="immersive-vr";let u,h,f,p=!1,m,b,_,y=null,A;const T=new je;let M=D.CAMERA_MIN_FAR;function C(){m.depthFar=M,u.updateRenderState(m)}this.setCameraFar=function(j){M=j,u&&C()},this.render=function(j,K){_.set(!1,!0,!1),b.matrixWorld=K;const de=b.projectionMatrix,xe=f.views;for(let Ve=0;Ve<xe.length;++Ve){const qe=xe[Ve];T.fromArray(qe.transform.inverse.matrix),de.fromArray(f.transform.matrix),T.multiply(de),de.fromArray(qe.projectionMatrix),de.multiply(T),s.enableScissorTest(!0);const k=m.baseLayer.getViewport(qe);s.setScissor(k.x,k.y,k.width,k.height),A.x=k.x,A.y=k.y,A.width=k.width,A.height=k.height,s.render(j,b,A),s.enableScissorTest(!1)}_.restore()};function N(){return it.ios&&DeviceMotionEvent!==void 0&&typeof DeviceMotionEvent.requestPermission=="function"&&DeviceOrientationEvent!==void 0&&typeof DeviceOrientationEvent.requestPermission=="function"?new Promise(function(j,K){Promise.all([DeviceMotionEvent.requestPermission(),DeviceOrientationEvent.requestPermission()]).then(function(de){de[0]==="granted"&&de[1]==="granted"?j():K()},function(){K()})}):Promise.resolve()}function O(){if(u=null,A.dispose(),A=null,m=null,h=null,f=null,e.removeAllXrGamepads(),o(!1),y){const j=y;y=null,j()}}function q(j){for(const K of j.removed)K.gamepad&&e.removeXrGamepad(K.gamepad);for(const K of j.added)K.gamepad&&e.addXrGamepad(K.gamepad,K.handedness)}if(this.enableVr=function(j){l?p?(r(!0),N().then(function(){const K="local-floor";return j.makeXRCompatible().then(function(){return navigator.xr.requestSession(d,{requiredFeatures:[K]})}).then(function(de){return u=de,u.requestReferenceSpace(K)}).then(function(de){h=de;const xe=new XRWebGLLayer(u,j);A=s.createFrameBufferRenderTarget(xe.framebuffer),m={baseLayer:xe},b||(b=new hs,_=new ws(s)),m.depthNear=D.CAMERA_WALK_NEAR,C(),u.addEventListener("end",O),c||u.addEventListener("inputsourceschange",q),r(!1),o(!0)}).catch(function(){r(!1),Wt.info("Failed to enable VR mode")})}).catch(function(){r(!1),Wt.info("Permissions necessary for VR mode not granted")})):Wt.info("VR device not connected"):Wt.info('You need a <a href="https://mozvr.com/#start" target="_blank">VR ready browser</a>.')},this.disableVr=function(){u.end().then(function(){Wt.hideInfo()},function(){Wt.info("Failed to exit VR mode")})},this.vrEnabled=()=>!!h,this.requestAnimationFrame=function(){function j(K,de){if(f=de.getViewerPose(h),y){const xe=y;y=null,xe(K)}}return function(K){y=K,u.requestAnimationFrame(j)}}(),this.update=function(){const j=new mi,K=new B;return function(){if(!f)return;const de=f.transform;if(de.orientation===null)return;{j.setFromQuaternion(de.orientation,Un.YXZ);const Ve=j.y;j.y=-j.z,j.z=Ve}const xe=de.position;n(j,xe&&K.set(xe.x,-xe.z,xe.y,xe.w))}}(),(it.https||it.localhost)&&l){const j=function(){navigator.xr.isSessionSupported(d).then(function(K){p=K,i(K)})};j(),navigator.xr.addEventListener("devicechange",j,!1)}else i(!1)}const Ln=document.getElementById("walk-canvas"),Di=D.EDIT_MODE,Zl=1/30,lA=1/25;let $l=0,hi,sn,Xt,xo,rn,Ls,Tt,Lr,jt,Yn,Jl,Ad,Nm,xt,Fr,Fn,Ki,fn,Qn,Fs,ki,Aa,Ed,Or,Ea,Zi=null,Br=null,Ao,ec,wd,tc=0,ic=!1,km=!1,Sd,Um=!1;const Nr=new Ss;function cA(s,e){return Fr.renderIdle(s,e)}function zm(s,e){Ri.beginSection("Integrate simulation"),e&&Lr.update(),D.DEV_NEW_SCENE&&xt.updateSegments(),ki.update(s),ec&&xt.minimapConfig.enabled&&ec.update(),Yn.enableCollisions&&!e&&Fn.handleCollisions(s),Qn==null||Qn.handleHover(),Fs.update(s),Tt.update(s),Ki==null||Ki.updateCameraHeight(s),fn==null||fn.updateCameraHeight(),e&&!ki.teleportingToPoint&&(sn.update(),jt.requestFrame()),Aa&&(e&&!Lr.hasGamepads()?Aa.update(s):Aa.reset());let t=D.BENCHMARK;for(const i of xt.getAnimatedRootNodes())i.update(s,Tt.cameraWorldPosition())&&(t=!0);for(const i of xt.getAnimatedMaterials())i.isPlaying&&(i.update(s),t=!0);t&&!D.PUPPETEER_TEST&&jt.requestFrame(),Ea==null||Ea.update(s),rn._update(s),Ri.endSection("Integrate simulation")}function hA(s,e){if(Ri.beginProfiling(),Ri.beginSection("Tick"),Br==null||Br.begin(),D.PUPPETEER_TEST&&(s=1/30),D.DEV_NEW_RENDER_ARCHITECTURE){s=Math.min(s,lA),$l+=s;const t=Yi.get();for(;$l>=Zl;){zm(Zl,e);const n=new xi;xt.camera.current.getWorldQuaternion(n),$l-=Zl;const r=t.getActiveCamera(),o=r.get(vi),l=5e-5,c=1e-5,d=o.position.distanceToSquared(Tt.cameraWorldPosition()),u=o.rotation.dot(n);(d>l||u<1-c)&&t.updateEntityState(r,vi,{position:Tt.cameraWorldPosition().clone(),rotation:n})}const i=$l/Zl;Fr.renderToScreen(s,e,i)}else zm(s,e),Fr.renderToScreen(s,e);Br==null||Br.end(),Ri.endSection("Tick"),Ri.endProfiling()}function dA(s){s.view&&(Ki==null||Ki.disable(),Qn==null||Qn.disable())}function uA(s){Ki&&!Ki.isEnabled()&&!sn.vrEnabled()&&Ki.enable(),fn&&sn.vrEnabled()&&fn.onTeleportDone(),s.view&&Qn&&Qn.enable(),sn.vrEnabled()&&Tt.hmdReset()}function fA(){if(xt){if(document.visibilityState==="hidden")for(const s of xt.getAnimatedMaterials())s.sleepAnimation();else if(document.visibilityState==="visible"){for(const s of xt.getAnimatedMaterials())s.wakeAnimation();jt.requestFrame()}}}function Eo(){it.ios&&(document.documentElement.style.height=window.innerHeight+"px",document.body.scrollTop!==0&&window.scrollTo(0,0)),Fr.resize(sn.vrEnabled()),jt.requestFrame(),Xt.onResize()}function Td(){return document.pointerLockElement===Ln||document.mozPointerLockElement===Ln||document.webkitPointerLockElement===Ln}function Md(){return document.fullscreenElement||document.mozFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||document.webkitFullscreenElement}function pA(){Td()&&(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock&&document.exitPointerLock())}function mA(){Md()&&(document.exitFullScreen=document.exitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen||document.webkitExitFullscreen,document.exitFullScreen&&document.exitFullScreen())}function Pd(){if(Td()){Tt.mousePressLook=!1,Xt.onPointerLockChange(!0);const s=D.GAZE_IN_POINTER_LOCK;s?Nr.enableMode():Nr.disableMode(),rn.anchorsVisible=s}else Tt.mousePressLook=!0,Xt.onPointerLockChange(!1),Nr.disableMode(),rn.anchorsVisible=!0}function gA(){Ln.requestPointerLock=Ln.requestPointerLock||Ln.mozRequestPointerLock||Ln.webkitRequestPointerLock,Ln.requestPointerLock(),document.addEventListener("pointerlockchange",Pd,!1),document.addEventListener("mozpointerlockchange",Pd,!1),document.addEventListener("webkitpointerlockchange",Pd,!1)}function nc(){Md()?(Xt.onFullScreenChange(!0),screen.orientation&&screen.orientation.lock&&screen.orientation.lock("landscape-primary")):Xt.onFullScreenChange(!1)}function _A(){const s=document.body;(s.mozRequestFullScreen||s.webkitRequestFullscreen||s.msRequestFullscreen||s.requestFullscreen).call(s),document.addEventListener("fullscreenchange",nc,!1),document.addEventListener("mozfullscreenchange",nc,!1),document.addEventListener("webkitfullscreenchange",nc,!1),document.addEventListener("MSFullscreenChange",nc,!1)}function Vm(s){hi.uploadNewBuffers(s),jt==null||jt.requestFrame()}function vA(s){Tt=new x0(s,Ln,Lr,jt),Tt.mousePressLook=!0,D.FLIP_MOUSE&&(Tt.flipMouseLook=!0)}function bA(){Fs=new d0(xt,Fn,Tt,ki);const s=[rn._clickListener.bind(rn)],e=[Fs.onMeshClicked.bind(Fs)],t=[rn._createHoverListener()];Di||s.push(Fs.onMeshClicked.bind(Fs)),Qn=new P0(Jl,Fn,()=>jt.requestFrame(),s,e,t,Lr,Aa)}function yA(){Md()?mA():_A()}function xA(){Td()?pA():gA()}function Gm(){Ki==null||Ki.disable(),fn==null||fn.enable(),Tt.mouseControlsPitch=!1,Tt.hmdReset(),ki.onVrChange(!0),Nr.enableMode(),Xt.onVrChange(!0),rn._vrChange(!0),Eo()}function AA(){Tt.resetRollAngle(),Tt.resetPitchAngle(),Tt.mouseControlsPitch=!0,console.assert(!sn.vrEnabled()),fn==null||fn.disable(),Ki==null||Ki.enable(),ki.onVrChange(!1),Nr.disableMode(),Xt.onVrChange(!1),rn._vrChange(!1),Eo(),setTimeout(Eo,1e3)}function EA(s){jt.isEnabled()&&(s?Gm():AA())}function wA(s){Di||it.mobile&&!D.ALLOW_MOBILE_VR||(it.ios||it.mobile&&it.firefox)&&it.inCrossOriginIframe||Xt.setVrSupported(s)}function SA(){sn.vrEnabled()?sn.disableVr():(Or.isRunning()&&Or.stop(),sn.enableVr(hi.context))}function TA(s,e){fn&&e!==null&&fn.onHmdPositionUpdate(e),Tt.onHmdUpdate(s,e)}function MA(s,e){if(s&&Tt.cameraWorldPosition().set(s[0],s[1],s[2]),e){const t=new mi;t.setFromDegTriple(e),Tt.setYawAngle(t.yaw),Tt.setPitchAngle(t.pitch)}}function PA(s){return s.every(e=>e.lightProbes.length!==0)}function CA(s,e,t){Fn=new r0(s,e,t),e.visitAllNodes(function(i){i.mesh&&Fn.addStaticObstacle(i.mesh)})}function RA(s){const e=D.urlHashGetArgument("view");let t=null;return e&&(t=s.findViewByName(e)),t||s.allViews()[0]}function Hm(s){if(xt=s,xt.adjustSkiesAndCameraFarToSpanWholeScene(),xt.addEventListener(wi.updatedEventType,()=>jt.requestFrame()),xt.addEventListener(wi.anyViewUpdatedEventType,()=>Xt.refresh()),xt.disableLightProbesForMaterials(),Tt.enable(),xt.threeScene.updateMatrixWorld(!0),sn.setCameraFar(xt.camera.far),xt.camera.current instanceof hs&&(xt.camera.current.aspectRatio=window.innerWidth/window.innerHeight),Fr=new P1(hi,sn,xt,xt.exposureController),D.DEV_NEW_RENDER_ARCHITECTURE){const i=Yi.get(),n=xt.camera.current;n instanceof hs?i.updateEntityState(i.getActiveCamera(),Gn,{isPerspective:!0,near:n.near,far:n.far,aspect:n.aspectRatio,fov:n.fov}):i.updateEntityState(i.getActiveCamera(),Gn,{isPerspective:!1,near:n.near,far:n.far,left:n.left,right:n.right,top:n.top,bottom:n.bottom})}wd=new r1(hi,xt),Jl=new D0(hi.domElement,Di);const e=Yn.enableCollisions;(e||Di)&&(CA(hi,xt,Tt),Tt.orbit.collider=Fn),ki=new Iy(xt,Tt,Fn,jt,wd),ki.addEventListener("teleportStarted",dA),ki.addEventListener("teleportDone",uA),Or=new Kc(ki),e&&xt.camera.autoClimb&&(Ki=new O0(Fn,Tt,jt)),e&&(fn=new Dy(Tt,Fn)),ki.switchToView(RA(xt),0),xt.exposureController.updateWithoutDelay(),Ed=new T0(xt,ki),Ao=new I1(hi,xt,Tt);function t(){jt.requestFrame()}if(e&&D.NO_GAZE_TELEPORT!==!0&&(Aa=new S0(xt,Tt,t,Nr)),rn._sceneReadyToDisplay(hi,xt,Tt,ki,Or,Fn,Ao,Ad,sn,Nr,Jl,jt,Ls),bA(),document.addEventListener("visibilitychange",fA),window.addEventListener("resize",function(){it.ios?setTimeout(Eo,1e3):Eo()},!1),it.fullScreenSupported()&&Xt.setFullScreenSupported(),it.pointerLockSupported()&&Xt.setPointerLockSupported(),Xt.sceneReadyToDisplay(xt,ki,Or,Ao),Eo(),D.DEBUG&&(Br=new j1(hi.context)),Ir(),D.DEBUG_SHARED_BUFFERS&&(xt.threeScene.overrideMaterial=new kx),D.DEBUG_GEOMETRY_MERGING&&oy(xt,!1),xt.startAutoTourOnLoad()&&Or.start(),jt.enable(),sn.vrEnabled()&&Gm(),D.PUPPETEER_TEST){IA();const i="display:none;";document.getElementById("cover-image").style.cssText=i,document.getElementById("info-bar").style.cssText=i,document.getElementById("menu-bar").style.cssText=i,document.getElementById("view-list").style.cssText=i,document.getElementById("minimap-wrapper").style.cssText=i}Sd=Zi.elapsedLoadTimeSec(),D.DEBUG&&console.log("readyToDisplayTime:",Sd)}function IA(){const s=document.createElement("div");s.style.cssText="display:none;",s.id="loading-finished-marker",document.body.appendChild(s)}function Wm(s){!Di&&!D.urlHashContains("nostats")&&tc===0&&Xt.cover.sendStats&&qs("./stats/"+s,null,null)}function DA(s){let e="";for(const[t,i]of Object.entries(s))if(i!=""){const n=e.length==0?"?":"&";e+=`${n}${t}=${i}`}Wm("play"+e)}function LA(s,e){Wm("loaded?readyToDisplayTime="+s.toFixed(1)+"&loadTime="+e.toFixed(1))}function FA(s,e){const t=new Map;function i(){e.assignLightProbesToObjects()}function n(c){const d=c.target;function u(){t.delete(d),s.findLightProbe(d.id)!==null&&(e.assignLightProbesToObjects(),e.createLightProbeTexture(d,!1),jt.requestFrame())}let h=t.get(d);h===void 0&&(h=new Qf(u,1e3),t.set(d,h)),h.deferRun()}function r(c){const d=c.target;if(e.createLightProbeTexture(d,!0),!d.isBoundingBoxInitialized()){const u=d.boxMin,h=d.boxMax;u.copyFrom(d.position).addScalar(-1),h.copyFrom(d.position).addScalar(1),d.enableBoundingBox()}}function o(c){for(const d of s.materials)d.forceObjectUniformsRefresh()}function l(c){const d=c.lightProbe;e.assignLightProbesToObjects(),e.createLightProbeTexture(d,!0),d.isBoundingBoxInitialized()||d.disableBoundingBox(),d.addEventListener("boundsInit",r),d.addEventListener("positionUpdated",n),d.addEventListener("boundsUpdated",o)}s.addEventListener(wi.lightProbeAddedEventType,l),s.addEventListener(wi.lightProbeRemovedEventType,i);for(const c of s.lightProbes)c.addEventListener("positionUpdated",n),c.addEventListener("boundsInit",r),c.addEventListener("boundsUpdated",o)}function OA(s,e,t){const i=new Set;function n(r){if(r===s.length){t();return}const o=s[r],l=o.name;i.has(l)?n(r+1):(i.add(l),e.monoPanoramaToServer(o,()=>n(r+1)))}n(0)}function jm(s){let e;const t=D.urlHashContains("headless");if(s.lightProbes.length>0||Di){const r=!it.mobile||D.MOBILE_HI||s.lightProbes.length<=4;if(e=new Nx(s,hi,r,Di),s.lightProbes.length===0&&Di&&s.autoAddLightProbes&&_x(s,e,t),s.lightProbes.length>0){PA(s.gpuMeshes)||(console.warn("Some objects do not have light probes assigned, this is not optimal."),e.assignLightProbesToObjects());let o=s.allViews().findIndex(l=>l.mode!=="orbit");o===-1&&(o=0),ki.executeWithViewVisibilitySettings(s.allViews()[o],function(){e.createAllLightProbeTextures()}),s.enableLightProbesForMaterials()}}if(s.hasLightmap()&&Fr.enableAutoExposure(),Di){if(e?FA(s,e):console.warn("Cube maps support is required in the edit mode"),Nm=new CE({scene:s,controls:Tt,rawRenderer:hi,teleport:ki,animationController:jt}),Ea=new Mt(Jl,s,Fn,jt,Tt),Yn.sendCoverToServer){const r="SwitchObjects";Ls.initExtensionsByType(r);const o=Ls.getExtensionsByType(r);o.forEach(l=>l.changeTriggersVisibility(!1)),Ao.coverToServer(D.EDITOR_COVER_WIDTH,D.EDITOR_COVER_HEIGHT),o.forEach(l=>l.changeTriggersVisibility(!0)),Ls.disposeExtensionsByType(r)}MA(Yn.forcedInitialCameraPosition,Yn.forcedInitialCameraRotation)}else e&&(e.dispose(),e=null);ec=new Lm(wd,s,ki,rn);const i=new SE(s,jt,xo);function n(){if(Yn.onSceneLoaded&&Yn.onSceneLoaded(new wE(s,Xt,Tt,Fn,ki,Ea,Ls,Ao,jt,ec,Or,Nm,i)),Xt.sceneLoadComplete(),!D.PUPPETEER_TEST)for(const r of s.getAnimatedMaterials())r.play();rn._sceneLoadComplete(),jt.requestFrame(),LA(Sd,Zi.elapsedLoadTimeSec()),Zi=null}Di&&t?OA(Zi.panoramas,Ao,n):n(),D.DEV_NEW_RENDER_ARCHITECTURE&&Yi.get().onSceneLoaded()}function BA(){return D.VR_LO?Wl.cardboardConfig.BUFFER_SCALE*=.5:D.VR_HI&&(Wl.cardboardConfig.BUFFER_SCALE*=1.5),new WebXRPolyfill(Wl)}function Cd(){ic&&(ic=!1,Zi.load(),Xt.sceneLoadStarted(),D.SHOW_HELP_ON_LOAD&&(Xt.helpVisible=!0),DA(it.getPlatformInfo()))}function NA(){const s="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation";return window.WebGLRenderingContext?'Your graphics card does not seem to support <a href="'+s+'" target="_blank">WebGL</a> or your browser has WebGL disabled.<br/><a href="http://get.webgl.org/" target="_blank">Find out how to get it.</a>':'Your browser does not seem to support <a href="'+s+'" target="_blank">WebGL</a>.<br/><a href="http://get.webgl.org/" target="_blank">Find out how to get it.</a>'}function Xm(s){if(Xt.updateCover(s),Ls.updateConfig(s.extensions||[]),s.canForceBrotliBuffers===!0&&b_(),s.webwalkLogMode===1?(Le.logInfoMessages(),Uc(!0)):s.webwalkLogMode===2&&Uc(!1),Di||Ls.initExtensions(),rn._viewerConfigLoaded(s),s.language){const i=zc[s.language];i?du(i):console.log(`Unknown language: ${s.language}`)}ic=!0;const e=new wi(Tt.camera()),t=new Vb(D.ASSETS_URL,hi);e.textureManager=t,e.exposureController=new Fy(e.camera,Ad),Yn.assetsUrl!==void 0&&Yn.assetsUrl!==null&&(D.ASSETS_URL=Yn.assetsUrl),D.DEV_NEW_SCENE?(Zi=new wb(e,D.ASSETS_URL,Di,xo,t,hi),Zi.onProgress=Xt.loadProgress,Zi.onMeshBuffersLoaded=Vm,Zi.onReadyToDisplay=Hm,Zi.onComplete=jm):(Zi=new W1(e,D.ASSETS_URL,Di,xo,t,hi),Zi.onProgress=Xt.loadProgress,Zi.onMeshBuffersLoaded=Vm,Zi.onReadyToDisplay=Hm,Zi.onComplete=jm),Ad=new zy(hi,e),D.AUTO_PLAY||km||tc>0?Cd():D.HIDE_PLAY||Xt.enablePlayButton(Cd)}function qm(){return!Di&&Zi===null&&tc<=D.CONTEXT_LOST_RESTORE_LIMIT}function kA(s){if(s.preventDefault(),tc+=1,jt.disable(),!qm()){Wt.error("Graphics context lost, reload to retry.");return}Ls.disposeExtensions(),rn._contextLost(),Ed.dispose(),Ed=null,Qn.dispose(),Qn=null,Fs&&(Fs.dispose(),Fs=null),Xt.contextLost()}function UA(s){s.preventDefault(),qm()&&(Wt.info("Graphics context restored, reloading the scene to use the new context.",5e3),it.resetGlDetector(hi.context),it.gl.reportToConsole(),hi.webGLContextRestored(),Xm(Xt.cover))}function zA(){function s(e,t){let i="Failed to initialize the scene.";e==401&&t!==void 0&&(i=t),Wt.error(i)}jc(D.COVER_JSON_URL,!1,Xm,s)}function Ym(s){if(Um=!0,_t.onAdd=r=>{r instanceof Je&&hi.uploadNewBuffers(r)},Yn=s,D.PROFILER_ENABLED&&Ri.createInstance(),hi=M1(Ln),!hi){Wt.error(NA());return}const e=it.missingCapabilities();if(e){Wt.errorWithQr(e);return}Ln.addEventListener("webglcontextlost",kA,!1),Ln.addEventListener("webglcontextrestored",UA,!1),Xt.init(),Ls=new lx;let t=null;try{t=BA()}catch(r){Le.log("Failed to initialize WebXR polyfill")}function i(r){r?jt.disable():jt.enable()}sn=new aA(hi,Lr,t,wA,TA,i,EA),jt=new o0(sn,hA,cA),jt.disable();const n=new br;vA(n),Tt.disable(),zA()}Lr=new Uu,Xt=new _d(Di,Lr,SA,yA,xA,!D.PUPPETEER_TEST),xo=new D1,Di&&xo.setAllMaterialsEditable(),rn=new Bm(Di,Xt,xo);function VA(s){const e=document.createElement("base");e.target="_blank",document.head.appendChild(e),cu(Object.keys(Bc),function(){Ym(s)})}function GA(){return Um}function Qm(s){Di||Ym(s)}function Km(){ic?Cd():km=!0}function Li(){return rn}let Rd=!1;function HA(){D.DEV_NEW_RENDER_ARCHITECTURE?Fr.reloadShaders():Rd||(Rd=!0,console.log("Reloading shaders..."),nn.reloadShaders(()=>{const s=new Map;let e=0;xt.threeScene.traverse(function(t){const i=t.material;i&&i.generateProgramId!==void 0&&s.set(i.generateProgramId(),i)});for(const t of s.values())t.tryToRefreshShaderCode()&&(hi.recompileProgram(t),e++);Rd=!1,console.log("Updated "+e+" shaders.")}))}class Id{constructor(e,t,i){a(this,"_config");a(this,"_volumeTrigger");a(this,"_camera");a(this,"_exposureController");this._config=e,this._volumeTrigger=this._constructVolumeTrigger(e),this._camera=t,this._camera.addEventListener("positionChanged",this._volumeTrigger.onCameraPositionUpdated),this._exposureController=i}_constructVolumeTrigger(e){const t=()=>{Li().onSceneReadyToDisplay(()=>{this._exposureController.addManualExposure(this._config.exposure,this._config.gamma,this._config.id)})},i=()=>{this._exposureController.removeManualExposure(this._config.id)};return new _n([t],[i],e)}setPriority(e){this._exposureController.setPriority(this._config.id,e)}onUpdated(){this._exposureController.updateManualExposure(this._config.exposure,this._config.gamma,this._config.id)}getCameraVolumeTrigger(){return this._volumeTrigger}get id(){return this._config.id}get name(){return this._config.name}set name(e){this._config.name=e}get exposure(){return this._config.exposure}set exposure(e){this._config.exposure=e,this.onUpdated()}get gamma(){return this._config.gamma}set gamma(e){this._config.gamma=e,this.onUpdated()}dispose(){this._camera.removeEventListener("positionChanged",this._volumeTrigger.onCameraPositionUpdated),this._volumeTrigger.dispose()}reinstate(){this._camera.addEventListener("positionChanged",this._volumeTrigger.onCameraPositionUpdated),this._volumeTrigger.reinstate()}serialize(){return zt(zt({},this._config),this._volumeTrigger.serialize())}}class wa{constructor(e,t,i,n,r,o){a(this,"editor");a(this,"controller");a(this,"property");a(this,"elements");a(this,"values");a(this,"unmergable");this.editor=e,this.controller=t,this.property=i,this.elements=n,this.values=r,this.unmergable=o}isMergable(e){return this.unmergable||!(e instanceof wa)?!1:(console.assert(e instanceof wa),e.property===this.property&&Ja(e.elements,this.elements))}apply(){const e=[];for(let i=0;i<this.elements.length;i++){const n=this.elements[i];e.push(this.editor.getElementValue(this.property,n))}const t=[];for(let i=0;i<this.elements.length;i++){const n=this.elements[i],r=this.values[i],o=this.controller.createItemUpdater(n),l=this.editor.setElementValue(n,o,this.property,r);t.push(l)}return new wa(this.editor,this.controller,this.property,t,e,this.unmergable)}}class WA{constructor(){a(this,"_pastEntries",new Array);a(this,"_futureEntries",new Array)}editorHistoryEntry(e,t,i,n,r,o){return new wa(e,t,i,n,r,o)}addItem(e){this._futureEntries=[],!(this._pastEntries.length>0&&this._pastEntries.at(-1).isMergable(e))&&this._pastEntries.push(e)}isUndoable(){return this._pastEntries.length>0}undo(){console.assert(this.isUndoable());const e=this._pastEntries.pop();this._futureEntries.push(e.apply())}isRedoable(){return this._futureEntries.length>0}redo(){console.assert(this.isRedoable());const e=this._futureEntries.pop();this._pastEntries.push(e.apply())}}class jA{constructor(){a(this,"color",new Re);a(this,"highlight",new Re);a(this,"highlightMix",0)}}class Dd extends ai{constructor(e){super({vsName:"editor_light_vertex.glsl",fsName:"editor_light_fragment.glsl",uniformBufferDataConstructor:jA}),this.setUniform("color","c",e.color,ve.MATERIAL),this.setUniform("highlight","c",D.EDITOR_SELECTION_COLOR,ve.MATERIAL),this.setUniform("highlightMix","f",0,ve.MATERIAL),this.propertyFromUniform("highlightMix")}}class XA{constructor(e,t){a(this,"_scene");a(this,"_animationController");a(this,"_selectedMesh");a(this,"_selectedMeshDispose");a(this,"_volumeGroup",new _t);a(this,"_material",Ih());a(this,"_hollowMaterial",Dh());this._scene=e,this._animationController=t,this._scene.addAuxiliaryObject(this._volumeGroup),this._volumeGroup.visible=!1}setHighlightedCameraVolumeTrigger(e){var o;(o=this._selectedMeshDispose)==null||o.call(this);const t=new Je(e.getVolumeGeometry(),this._material),i=new Je(e.getVolumeGeometry(),this._hollowMaterial);t.add(i),this._volumeGroup.add(t);const n=()=>{t.position.copyFrom(e.position),t.rotation.copyFrom(e.rotation),t.scale.copyFrom(e.scale),t.updateMatrixWorld(),this._animationController.requestFrame()},r=()=>{this.setControlsVisible(!1)};return n(),e.addEventListener(_n.updatedEventType,n),e.addEventListener(_n.disposedEventType,r),this._selectedMeshDispose=()=>{this._selectedMesh&&this._volumeGroup.remove(this._selectedMesh),e.removeEventListener(_n.updatedEventType,n),e.removeEventListener(_n.disposedEventType,r)},this._selectedMesh=t,t.material}setControlsVisible(e){this._volumeGroup.visible=e,this._animationController.requestFrame()}}/*!
 * Copyright (C) 2019-present Shapespark
 */function Zm(s,e,t){const i=s.findSkyMesh(D.EDITOR_CONTROLLED_SKY_NAME);t.set(0,-i.radius,0),e.applyToVector3(t),t.add(i.position)}function qA(s,e){e.radius=0,s.visitSubtree(function(t){t.mesh&&Tn.union(t.mesh.geometry.boundingSphere,e)})}const $m=.4,YA=1.5;function QA(){const s=new Wi,e=new Float32Array(8*4*3*3);s.addAttribute("position",new St(e,3));const t=$m,i=[[[-1,-1,-1],[-1,-1+t,-1],[-1+t,-1,-1]],[[-1,-1,-1],[-1,-1,-1+t],[-1,-1+t,-1]],[[-1,-1,-1],[-1+t,-1,-1],[-1,-1,-1+t]],[[-1+t,-1,-1],[-1,-1+t,-1],[-1,-1,-1+t]],[[-1,-1,1],[-1+t,-1,1],[-1,-1+t,1]],[[-1,-1,1],[-1,-1+t,1],[-1,-1,1-t]],[[-1,-1,1],[-1,-1,1-t],[-1+t,-1,1]],[[-1+t,-1,1],[-1,-1,1-t],[-1,-1+t,1]],[[1,-1,-1],[1-t,-1,-1],[1,-1+t,-1]],[[1,-1,-1],[1,-1+t,-1],[1,-1,-1+t]],[[1,-1,-1],[1,-1,-1+t],[1-t,-1,-1]],[[1-t,-1,-1],[1,-1,-1+t],[1,-1+t,-1]],[[-1,1,-1],[-1+t,1,-1],[-1,1-t,-1]],[[-1,1,-1],[-1,1-t,-1],[-1,1,-1+t]],[[-1,1,-1],[-1,1,-1+t],[-1+t,1,-1]],[[-1+t,1,-1],[-1,1,-1+t],[-1,1-t,-1]],[[1,1,1],[1-t,1,1],[1,1-t,1]],[[1,1,1],[1,1-t,1],[1,1,1-t]],[[1,1,1],[1,1,1-t],[1-t,1,1]],[[1-t,1,1],[1,1,1-t],[1,1-t,1]],[[1,-1,1],[1,-1+t,1],[1-t,-1,1]],[[1,-1,1],[1,-1,1-t],[1,-1+t,1]],[[1,-1,1],[1-t,-1,1],[1,-1,1-t]],[[1-t,-1,1],[1,-1+t,1],[1,-1,1-t]],[[1,1,-1],[1,1-t,-1],[1-t,1,-1]],[[1,1,-1],[1,1,-1+t],[1,1-t,-1]],[[1,1,-1],[1-t,1,-1],[1,1,-1+t]],[[1-t,1,-1],[1,1-t,-1],[1,1,-1+t]],[[-1,1,1],[-1,1-t,1],[-1+t,1,1]],[[-1,1,1],[-1,1,1-t],[-1,1-t,1]],[[-1,1,1],[-1+t,1,1],[-1,1,1-t]],[[-1+t,1,1],[-1,1-t,1],[-1,1,1-t]]];let n=0;return i.forEach(function(r){for(let o=0;o<3;o+=1)for(let l=0;l<3;l+=1)e[n]=r[o][l],n+=1}),s.computeVertexNormals(),s.convertNormalsToSpherical(),s}function KA(){const s=new si;return s.lightmapSupported=!1,s.reflective=!1,s.headLight=!0,s.baseColor=D.EDITOR_SELECTION_COLOR,s.setUniforms(),s}const ti=.01,Ge=1-1.24*($m/4);function ZA(){const s=new Wi,e=new Float32Array(12*8*3*3);s.addAttribute("position",new St(e,3));const t=new Array;function i(c,d){t.push([[c.x,c.y,c.z],[d.x,c.y,c.z],[c.x,d.y,c.z]]),t.push([[c.x,d.y,c.z],[d.x,c.y,c.z],[d.x,d.y,c.z]])}function n(c,d){t.push([[c.x,c.y,c.z],[c.x,d.y,c.z],[c.x,c.y,d.z]]),t.push([[c.x,c.y,d.z],[c.x,d.y,c.z],[c.x,d.y,d.z]])}function r(c,d){t.push([[c.x,c.y,c.z],[d.x,c.y,c.z],[c.x,c.y,d.z]]),t.push([[c.x,c.y,d.z],[d.x,c.y,c.z],[d.x,c.y,d.z]])}function o(c,d,u){const h={x:Math.min(c.x,d.x),y:Math.min(c.y,d.y),z:Math.min(c.z,d.z)},f={x:Math.max(c.x,d.x),y:Math.max(c.y,d.y),z:Math.max(c.z,d.z)};u!=="XY"&&(i(new B(f.x,h.y,h.z),new B(h.x,f.y,h.z)),i(new B(h.x,h.y,f.z),new B(f.x,f.y,f.z))),u!=="YZ"&&(n(new B(h.x,f.y,h.z),new B(h.x,h.y,f.z)),n(new B(f.x,h.y,h.z),new B(f.x,f.y,f.z))),u!=="XZ"&&(r(new B(f.x,f.y,h.z),new B(h.x,f.y,f.z)),r(new B(h.x,h.y,h.z),new B(f.x,h.y,f.z)))}o(new B(-Ge,Ge,Ge),new B(Ge,Ge-ti,Ge-ti),"YZ"),o(new B(-Ge,Ge,-Ge+ti),new B(Ge,Ge-ti,-Ge),"YZ"),o(new B(-Ge,-Ge,-Ge),new B(Ge,-Ge+ti,-Ge+ti),"YZ"),o(new B(-Ge,-Ge,Ge),new B(Ge,-Ge+ti,Ge-ti),"YZ"),o(new B(Ge,Ge,Ge),new B(Ge-ti,-Ge,Ge-ti),"XZ"),o(new B(Ge,Ge,-Ge),new B(Ge-ti,-Ge,-Ge+ti),"XZ"),o(new B(-Ge,Ge,-Ge),new B(-Ge+ti,-Ge,-Ge+ti),"XZ"),o(new B(-Ge,Ge,Ge),new B(-Ge+ti,-Ge,Ge-ti),"XZ"),o(new B(Ge,Ge,Ge),new B(Ge-ti,Ge-ti,-Ge),"XY"),o(new B(Ge,-Ge,Ge),new B(Ge-ti,-Ge+ti,-Ge),"XY"),o(new B(-Ge,Ge,Ge),new B(-Ge+ti,Ge-ti,-Ge),"XY"),o(new B(-Ge,-Ge,Ge),new B(-Ge+ti,-Ge+ti,-Ge),"XY");let l=0;return t.forEach(function(c){for(let d=0;d<3;d+=1)for(let u=0;u<3;u+=1)e[l]=c[d][u],l+=1}),s.computeVertexNormals(),s.convertNormalsToSpherical(),s}class $A{constructor(e,t){a(this,"_scene");a(this,"_animationController");a(this,"_lightsVisible",!1);a(this,"_geometryRotation",new je);a(this,"_geometryTranslation",new je);a(this,"_geometryTransform",new je);a(this,"_pointLightGeometry");a(this,"_areaLightGeometry");a(this,"_lightSelectionGeometry");a(this,"_lightSubSelectionGeometry");a(this,"_lightSelectionMaterial");a(this,"_lightUpdated");a(this,"_lightInstanceAdded");a(this,"_lightInstanceRemoved");a(this,"_lightAdded");a(this,"_lightRemoved");a(this,"selectedLightInstance");a(this,"subSelectedLightInstances",new Array);a(this,"lightInstanceMeshes",new Array);this._scene=e,this._animationController=t,this._pointLightGeometry=dt.createSphere(1,32,16),this._pointLightGeometry.convertNormalsToSpherical(),this._areaLightGeometry=dt.createPlane(1,1),this._geometryRotation.makeRotationX(-Math.PI/2),this._areaLightGeometry.applyMatrix(this._geometryRotation),this._areaLightGeometry.convertNormalsToSpherical(),this._lightSelectionGeometry=QA(),this._lightSubSelectionGeometry=ZA(),this._lightSelectionMaterial=KA(),this._lightUpdated=i=>{this._updateLightInstanceMeshes(i.target)},this._lightInstanceAdded=i=>{const n=i.instance,r=n.light;let o;r.instances[0]!==n?o=this._getLightInstanceMesh(r.instances[0]).geometry:o=this._createLightGeometry(r),this._createLightInstanceMesh(r,n,o),this._animationController.requestFrame()},this._lightInstanceRemoved=i=>{this._updateLightInstanceMeshes(i.instance.light),this._animationController.requestFrame()},this._lightAdded=i=>{this._addLight(i.light),this._animationController.requestFrame()},this._lightRemoved=i=>{this._removeLightInstanceMeshes(i.light),this._animationController.requestFrame()},this._scene.lights.forEach(i=>this._addLight(i)),this._scene.addEventListener(wi.lightAddedEventType,this._lightAdded),this._scene.addEventListener(wi.lightRemovedEventType,this._lightRemoved)}_createLightGeometry(e){let t;if(e.type===hn.SPOT){const i=oi(e.angle),n=1,r=Math.cos(i/2)*n,o=Math.sin(i/2)*n;t=dt.createCylinder(0,o,r,32,1),this._geometryTranslation.makeTranslation(0,-r/2,0),this._geometryRotation.makeRotationZ(Math.PI),this._geometryTransform.multiplyMatrices(this._geometryRotation,this._geometryTranslation),t.applyMatrix(this._geometryTransform),t.convertNormalsToSpherical()}else e.type===hn.AREA?t=this._areaLightGeometry:([hn.POINT,hn.SUN].includes(e.type),`${e.type}`,t=this._pointLightGeometry);return t}_createLightInstanceMesh(e,t,i){const n=new Dd(e),r=new Je(i,n);r.visibilityId=null;const o=new Je(this._lightSelectionGeometry,this._lightSelectionMaterial);r.add(o);const l=new Je(this._lightSubSelectionGeometry,this._lightSelectionMaterial);if(t!==this.selectedLightInstance&&!this.subSelectedLightInstances.includes(t)&&(l.visible=!1),r.add(l),e.type!==hn.SUN){const c=t.rotation.toQuaternion().multiply(r.rotation.toQuaternion());if(r.setRotationFromQuaternion(c),r.position.copyFrom(t.position),e.type===hn.AREA){n.side=Gi.DOUBLE,r.scale.set(e.width,1,e.height);const d=Math.max(e.width,e.height)/2;o.scale.set(d/e.width,d,d/e.height),l.scale.set(d/e.width,d,d/e.height)}else r.scale.set(e.size,e.size,e.size)}else{const c=this._scene.findSkyMesh(D.EDITOR_CONTROLLED_SKY_NAME).radius,d=.5*2*Math.PI*c*YA/360;Zm(this._scene,t.rotation,r.position),r.scale.set(d,d,d)}r.userData.lightInstance=t,r.updateMatrixWorld(),this.lightInstanceMeshes.push(r),this._lightsVisible&&this._scene.addAuxiliaryObject(r)}_createLightInstanceMeshes(e){const t=this._createLightGeometry(e);e.forEachLightInstance(i=>this._createLightInstanceMesh(e,i,t))}_getLightInstanceMesh(e){return this.lightInstanceMeshes.find(t=>t.userData.lightInstance===e)}_removeLightInstanceMeshes(e){const t=i=>i.userData.lightInstance.light!==e;for(const i of this.lightInstanceMeshes)t(i)||(this._lightsVisible&&this._scene.removeAuxiliaryObject(i),i.geometry!==this._pointLightGeometry&&i.geometry!==this._areaLightGeometry&&i.geometry.dispose(),i.material.dispose());this.lightInstanceMeshes=this.lightInstanceMeshes.filter(t)}_updateLightInstanceMeshes(e){this._removeLightInstanceMeshes(e),this._createLightInstanceMeshes(e)}_addLight(e){this._createLightInstanceMeshes(e),e.addEventListener(dn.updatedEventType,this._lightUpdated),e.addEventListener(dn.instanceAddedEventType,this._lightInstanceAdded),e.addEventListener(dn.instanceRemovedEventType,this._lightInstanceRemoved)}getLightInstanceMaterial(e){var t;return(t=this._getLightInstanceMesh(e))==null?void 0:t.material}showLights(){this._lightsVisible||(this._lightsVisible=!0,this.lightInstanceMeshes.forEach(e=>this._scene.addAuxiliaryObject(e)))}showSelectionMesh(e,t){this.lightInstanceMeshes.forEach(function(i){i.children[0].visible=i.userData.lightInstance.light===e||t.includes(i.userData.lightInstance.light)})}showInstancesSelectionMesh(e,t){this.selectedLightInstance=e,this.subSelectedLightInstances=t,this.lightInstanceMeshes.forEach(function(i){i.children[1].visible=i.userData.lightInstance===e||t.includes(i.userData.lightInstance)})}hideLights(){this._lightsVisible&&(this._lightsVisible=!1,this.lightInstanceMeshes.forEach(e=>this._scene.removeAuxiliaryObject(e)))}}class JA{constructor(e,t){a(this,"_scene");a(this,"_animationController");a(this,"_lightProbesVisible",!1);a(this,"_visibleBoxMesh");a(this,"lightProbeMeshes",new Array);a(this,"_lightProbeGeometry",dt.createSphere(.2,32,16));a(this,"_boxMaterial",Ih());a(this,"_boxGeometry",dt.createBox(1,1,1));a(this,"_hollowBoxMaterial",Dh());a(this,"_lightProbeUpdated",e=>{const t=e.target,i=this._findLightProbeMesh(t);i.position.copyFrom(t.position);const n=i.children[0];t.isBoundingBoxEnabled()?(this._setLightProbeBoxPosition(t,n),n.visible=!0):n.visible=!1,i.updateMatrixWorld()});a(this,"_lightProbeAdded",e=>{this._createLightProbeMesh(e.lightProbe)});a(this,"_lightProbeRemoved",e=>{this._removeLightProbeMesh(e.lightProbe)});this._scene=e,this._animationController=t,this._lightProbesVisible=!1,this._lightProbeGeometry.convertNormalsToSpherical(),this._boxGeometry.convertNormalsToSpherical(),this._init()}_setLightProbeBoxPosition(e,t){t.position.addVectors(e.boxMin,e.boxMax).multiplyScalar(.5).sub(e.position),t.scale.subVectors(e.boxMax,e.boxMin),t.scale.subScalar(.005)}_constructLightProbeMesh(){const e=new si;e.lightmapSupported=!1,e.hideFromLightProbes=!0,e.disableLightProbe=!1,e.highlight=D.EDITOR_SELECTION_COLOR,e.metallic=1,e.roughness=0,e.setUniforms();const t=new Je(this._lightProbeGeometry,e);return t.lightProbes=[],t}_createLightProbeMesh(e){const t=this._constructLightProbeMesh();t.lightProbes.push(e),t.position.copyFrom(e.position);const i=new Je(this._boxGeometry,this._boxMaterial),n=new Je(this._boxGeometry,this._hollowBoxMaterial);i.visible=!1,i.add(n),t.add(i),e.isBoundingBoxEnabled()&&this._setLightProbeBoxPosition(e,i),t.updateMatrixWorld(!0),t.visible=this._lightProbesVisible,this.lightProbeMeshes.push(t),this._scene.addAuxiliaryObject(t),e.addEventListener("positionUpdated",this._lightProbeUpdated),e.addEventListener("boundsUpdated",this._lightProbeUpdated)}_hideVisibleBoxMesh(){this._visibleBoxMesh&&(this._visibleBoxMesh.visible=!1,this._visibleBoxMesh=void 0)}_findLightProbeMeshIdx(e){return this.lightProbeMeshes.findIndex(t=>{for(let i=0;i<D.MAX_BLENDED_REFLECTION_PROBES;i++)if(t.lightProbes[i]===e)return!0;return!1})}_findLightProbeMesh(e){return this.lightProbeMeshes[this._findLightProbeMeshIdx(e)]}_removeLightProbeMesh(e){const t=this._findLightProbeMeshIdx(e),i=this.lightProbeMeshes[t];this._scene.removeAuxiliaryObject(i),i.material.dispose(),this.lightProbeMeshes.splice(t,1)}_init(){this._scene.lightProbes.forEach(e=>this._createLightProbeMesh(e)),this._scene.addEventListener(wi.lightProbeAddedEventType,this._lightProbeAdded),this._scene.addEventListener(wi.lightProbeRemovedEventType,this._lightProbeRemoved)}_changeLightProbesVisibility(e){this._lightProbesVisible!==e&&(this._lightProbesVisible=e,this.lightProbeMeshes.forEach(t=>t.visible=e)),this._animationController.requestFrame()}getLightProbeMaterial(e){const t=this._findLightProbeMesh(e);return t?t.material:void 0}showLightProbeBoundingBox(e){if(this._hideVisibleBoxMesh(),e.isBoundingBoxEnabled()){const t=this._findLightProbeMesh(e).children[0];this._visibleBoxMesh=t,this._visibleBoxMesh.visible=!0}}showLightProbes(){this._changeLightProbesVisibility(!0)}hideLightProbes(){this._changeLightProbesVisibility(!1)}}function sc(s){return s instanceof _n}function Sa(s){return s instanceof _n?!0:s instanceof ga?!1:[hn.SUN,hn.SPOT,hn.AREA].includes(s.light.type)}class eE{constructor(e,t){a(this,"_target");a(this,"_supportedModes");this._target=e,this._supportedModes=t}offsetPosition(e){const t=this._target.position.clone().add(e);this._target.setPosition(t.x,t.y,t.z)}offsetRotation(e){Sa(this._target);const t={x:this._target.rotation.x+e.x,y:this._target.rotation.y+e.y,z:this._target.rotation.z+e.z};this._target.setRotation(t.z,t.x,t.y)}offsetScale(e){sc(this._target);const t=this._target.scale.clone().add(e);this._target.setScale(t.x,t.y,t.z)}isSupported(e){return this._supportedModes[e]}get target(){return this._target}}const tE="rotate_gizmo_material_vertex.glsl",iE="rotate_gizmo_material_fragment.glsl";class nE{constructor(){a(this,"opacity",1);a(this,"color",new Re);a(this,"gizmoPosition",new B);a(this,"sphereRadius",0)}}class sE extends ai{constructor(t,i){super({vsName:tE,fsName:iE,uniformBufferDataConstructor:nE});a(this,"setUniforms",()=>{});this.blending=Hi.NORMAL,this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.transparentRenderOrder=1e3,this.hideFromLightProbes=!0,this.uniforms={opacity:{type:"f",value:1,uniformSourceType:ve.MATERIAL},color:{type:"c",value:t,uniformSourceType:ve.MATERIAL},gizmoPosition:{type:"v3",value:new B(0,0,0),uniformSourceType:ve.MATERIAL},sphereRadius:{type:"f",value:1,uniformSourceType:ve.MATERIAL}},this.opacity=i,this.fillMaterialUniformDataFromUniforms()}get color(){return this.uniforms.color.value}get opacity(){return this.uniforms.opacity.value}set opacity(t){this.uniforms.opacity.value=t}get gizmoPosition(){return this.uniforms.gizmoPosition.value}get sphereRadius(){return this.uniforms.sphereRadius.value}set sphereRadius(t){this.uniforms.sphereRadius.value=t}}var Zt=(s=>(s[s.NONE=0]="NONE",s[s.X=1]="X",s[s.Y=2]="Y",s[s.XY=3]="XY",s[s.Z=4]="Z",s[s.XZ=5]="XZ",s[s.YZ=6]="YZ",s[s.ALL=7]="ALL",s))(Zt||{});const Jm=new B(0,0,1),rc=new B(1,0,0),oc=new B(0,1,0);function rE(s){switch(s){case 1:return rc;case 2:return oc;case 4:return Jm}vs()}function oE(s){return[1,2,4].includes(s)}function aE(s){const e=new Dt;return s instanceof _t&&s.traverse(t=>{t instanceof Je&&(t.geometry.boundingBox||t.geometry.computeBoundingBox(),e.union(t.geometry.boundingBox))}),e}function lE(s,e){const t=aE(s),i=t.size(),n=dt.createBox(i.x,i.y,i.z),r=t.center(),o=new je;o.makeTranslation(r.x,r.y,r.z),n.applyMatrix(o),n.computeBoundingBox();const l=new Je(n,e);return l.visible=!1,l.visibilityId=null,l}const Kn=.6;function Zn(s,e){const t=new si;return t.lightmapSupported=!1,t.hideFromLightProbes=!0,t.baseColor.copyFrom(s),t.opacity=e,t.reflective=!1,t.headLight=!1,t.depthTest=!1,t.depthWrite=!1,t}class Ld extends _t{constructor(t,i,n){super();a(this,"material");a(this,"collider");a(this,"defaultOpacity");a(this,"hoveredOpacity",.99);a(this,"notUsedOpacity",.3);a(this,"usedAxes",0);this.add(t).add(i),this.material=n,this.collider=i,this.defaultOpacity=n.opacity}}function kr(...s){console.assert(s.length>0,"Part must have at least one element!");const e=new _t;s.forEach(n=>e.add(n));const t=lE(e,Zn(Re.WHITE,Kn)),i=e.children[0].material;return new Ld(e,t,i)}class cE extends _t{constructor(){super();a(this,"axisX");a(this,"axisY");a(this,"axisZ");a(this,"axes");a(this,"_visibility",[!1,!1,!1]);const t=.0075,i=dt.createCylinder(t,t,1e3,4,1,!1);function n(r){const o=Zn(r,Kn);return o.depthTest=!0,new Je(i,o)}this.axisX=n(Re.RED),this.axisX.rotation.set(0,0,Math.PI/2),this.axisY=n(Re.GREEN),this.axisZ=n(Re.BLUE),this.axisZ.rotation.set(Math.PI/2,0,0),this.axes=[this.axisX,this.axisY,this.axisZ];for(const r of this.axes)this.add(r)}show(t){this._visibility[0]=(1&t)===1,this._visibility[1]=(2&t)===2,this._visibility[2]=(4&t)===4;for(let i=0;i<3;i++)this.axes[i].visible=this._visibility[i]}update(t){const n=new B;n.copyFrom(t),n.sub(this.position),n.normalize(),this.axisX.visible=this._visibility[0]&&Math.abs(rc.dot(n))<.998,this.axisY.visible=this._visibility[1]&&Math.abs(oc.dot(n))<.998,this.axisZ.visible=this._visibility[2]&&Math.abs(Jm.dot(n))<.998}}class hE extends _t{constructor(){super();a(this,"markerX");a(this,"markerY");a(this,"markerZ");a(this,"markers");a(this,"_markerGeometry",dt.createSphere(.012,10,10));const t=()=>new Je(this._markerGeometry,Zn(Re.WHITE,.99));this.markerX=t(),this.markerY=t(),this.markerZ=t(),this.markers=[this.markerX,this.markerY,this.markerZ];for(const i of this.markers)this.add(i)}show(t){this.markerX.visible=(1&t)===1,this.markerY.visible=(2&t)===2,this.markerZ.visible=(4&t)===4}update(t){for(const i of[0,1,2]){const n=i;this.markers[i].position.setComponent(n,t.getComponent(n)),this.markers[i].updateMatrixWorld()}}}class dE extends _t{constructor(){super();a(this,"planeXY");a(this,"planeXZ");a(this,"planeYZ");a(this,"localPlanes");a(this,"cameraPlane");const t=dt.createPlane(1e3,1e3,1,1);function i(o,l=0,c=0,d=0){const u=Zn(o,.2);u.depthTest=!0,u.side=Gi.DOUBLE;const h=kr(new Je(t,u));return h.rotation.set(l,c,d),h}const n=i(Re.WHITE),r=new _t;this.add(n).add(r),this.planeXY=i(Re.BLUE),this.planeXZ=i(Re.GREEN,Math.PI/2,0,0),this.planeYZ=i(Re.RED,0,Math.PI/2,0),r.add(this.planeXY).add(this.planeXZ).add(this.planeYZ),this.localPlanes=r,this.cameraPlane=n}setLocalRotation(t){t?this.localPlanes.rotation.copyFrom(t):this.localPlanes.rotation.set(0,0,0)}update(t){this.cameraPlane.rotation.setFromRotationMatrix(t.matrixWorld),this.cameraPlane.updateMatrixWorld()}findPlaneIntersectionPoint(t,i,n,r){const o=new B,l=new B,c=f=>{switch(f){case 1:return this.planeYZ;case 2:return this.planeXZ;case 4:return this.planeXY;case 3:return this.planeXY;case 5:return this.planeXZ;case 6:return this.planeYZ;case 7:return this.cameraPlane}vs()};function d(f,p){if(oE(f)){const m=l.dot(l),b=l.dot(p),_=p.dot(p),y=l.dot(o),A=p.dot(o),T=m*_-b*b;return Math.abs(T)<1e-5?1/0:(m*A-b*y)/T}else{const m=l.dot(p);return Math.abs(m)<1e-5?1/0:l.dot(o)/m}}const u=c(t);u.getWorldPosition(o).sub(i),u.getWorldDirection(l);const h=d(t,n);return h===1/0?!1:(r.copyFrom(n).multiplyScalar(h).add(i),!0)}show(t){this.cameraPlane.visible=t===7,this.planeXY.visible=t===3,this.planeXZ.visible=t===5,this.planeYZ.visible=t===6}}function Fd(s,e,t){const i=s.collider,n=s.material;e===i?(n.opacity=s.hoveredOpacity,n.setUniforms()):(t&&e!==null?n.opacity=s.notUsedOpacity:n.opacity=s.defaultOpacity,n.setUniforms())}const ac=.015;class uE extends _t{constructor(){super();a(this,"parts");a(this,"collidersMap");a(this,"colliders");function t(){const _=new je,y=dt.createSphere(.1,16,16),A=dt.createPlane(.23,.23,1,1);_.makeTranslation(.45,.45,0),A.applyMatrix(_);const T=dt.createCylinder(ac,ac,1,4,1,!1);_.makeTranslation(0,.65,0),T.applyMatrix(_);const M=dt.createCylinder(0,.05,.2,10,1,!1);return _.makeTranslation(0,1.25,0),M.applyMatrix(_),{pickerGeometry:y,squareGeometry:A,lineGeometry:T,arrowHeadGeometry:M}}function i(_,y){const A=_*_,T=new Uint8Array(4*A),M=Math.floor(y.r*255),C=Math.floor(y.g*255),N=Math.floor(y.b*255);let O=0;for(let j=0;j<_;j++)for(let K=0;K<_;K++){T[O]=M,T[O+1]=C,T[O+2]=N;const de=j===0||K===0||j===_-1||K===_-1;T[O+3]=de?220:150,O+=4}const q=wt.newDataTexture(T,_,_,nt.RGBA8);return q.hasAlpha=!0,q.needsUpdate=!0,q}function n(_){const y=i(32,_),A=new si;return A.lightmapSupported=!1,A.hideFromLightProbes=!0,A.reflective=!1,A.headLight=!1,A.depthTest=!1,A.depthWrite=!1,A.transparent=!0,A.baseColor=_,A.side=Gi.DOUBLE,A.baseColorTexture=y,A.opacity=Kn,A.configureTransparency(),A.setUniforms(),A}const r=t();function o(){const _=Zn(Re.WHITE,Kn);return kr(new Je(r.pickerGeometry,_))}function l(_){const y=n(_);return kr(new Je(r.squareGeometry,y))}function c(_){const y=Zn(_,Kn);return kr(new Je(r.lineGeometry,y),new Je(r.arrowHeadGeometry,y))}const d=o(),u=c(Re.RED);u.rotation.set(0,0,-Math.PI/2);const h=c(Re.GREEN),f=c(Re.BLUE);f.rotation.set(Math.PI/2,0,0);const p=l(Re.BLUE),m=l(Re.GREEN);m.rotation.set(Math.PI/2,0,0);const b=l(Re.RED);b.rotation.set(0,-Math.PI/2,0),d.usedAxes=7,u.usedAxes=1,h.usedAxes=2,f.usedAxes=4,p.usedAxes=3,m.usedAxes=5,b.usedAxes=6,this.parts=[d,u,h,f,p,m,b],this.parts.forEach(_=>this.add(_)),this.collidersMap=new Map(this.parts.map(_=>[_.collider,_])),this.colliders=[...this.collidersMap.keys()]}highlight(t,i){this.parts.forEach(n=>Fd(n,t,i))}usedAxes(t){return this.collidersMap.get(t).usedAxes}}class fE extends _t{constructor(){super();a(this,"parts");a(this,"collidersMap");a(this,"colliders");a(this,"circleXYZ");a(this,"sphere");function t(f){const p=dt.createTorus(f,.012,6,64),m=dt.createTorus(f,.038,6,64);return{torusGeometry:p,colliderGeometry:m}}function i(f,p){const m=new sE(f,Kn),b=new _t().add(new Je(p.torusGeometry,m)),_=new Je(p.colliderGeometry,m);return _.visible=!1,_.visibilityId=null,new Ld(b,_,m)}function n(f,p){const m=Zn(f,0),b=dt.createSphere(p,32,32),_=new _t().add(new Je(b,m)),y=new Je(b,m);y.visible=!1,y.visibilityId=null;const A=new Ld(_,y,m);return A.defaultOpacity=0,A.hoveredOpacity=.2,A.notUsedOpacity=0,A}const r=t(.9),o=i(Re.RED,r);o.rotation.set(0,Math.PI/2,0);const l=i(Re.GREEN,r);l.rotation.set(Math.PI/2,0,0);const c=i(Re.BLUE,r),d=t(1.12),u=i(Re.WHITE,d),h=n(Re.WHITE,.848);this.parts=[o,l,c,u,h],this.parts.forEach(f=>this.add(f)),this.collidersMap=new Map(this.parts.map(f=>[f.collider,f])),this.colliders=[...this.collidersMap.keys()],o.usedAxes=1,l.usedAxes=2,c.usedAxes=4,u.usedAxes=7,this.circleXYZ=u,h.usedAxes=0,this.sphere=h}update(t){this.parts.filter(i=>i!==this.sphere).forEach(i=>{const n=i.material;n.gizmoPosition.copyFrom(this.position),n.sphereRadius=this.scale.x*.86}),this.circleXYZ.rotation.setFromRotationMatrix(t.matrixWorld),this.circleXYZ.updateMatrixWorld()}highlight(t,i){this.parts.forEach(n=>Fd(n,t,i))}usedAxes(t){return this.collidersMap.get(t).usedAxes}}class pE extends _t{constructor(){super();a(this,"parts");a(this,"collidersMap");a(this,"colliders");function t(){const _=new je,y=dt.createBox(.3,.3,.3),A=dt.createPlane(.23,.23,1,1);_.makeTranslation(.45,.45,0),A.applyMatrix(_);const T=dt.createCylinder(ac,ac,1,4,1,!1);_.makeTranslation(0,.65,0),T.applyMatrix(_);const M=dt.createBox(.1,.1,.1);return _.makeTranslation(0,1.1,0),M.applyMatrix(_),{pickerGeometry:y,squareGeometry:A,lineGeometry:T,cubeGeometry:M}}function i(_,y){const A=_*_,T=new Uint8Array(4*A),M=Math.floor(y.r*255),C=Math.floor(y.g*255),N=Math.floor(y.b*255);let O=0;for(let j=0;j<_;j++)for(let K=0;K<_;K++){T[O]=M,T[O+1]=C,T[O+2]=N;const de=j===0||K===0||j===_-1||K===_-1;T[O+3]=de?220:150,O+=4}const q=wt.newDataTexture(T,_,_,nt.RGBA8);return q.hasAlpha=!0,q.needsUpdate=!0,q}function n(_){const y=i(32,_),A=new si;return A.lightmapSupported=!1,A.hideFromLightProbes=!0,A.reflective=!1,A.headLight=!1,A.depthTest=!1,A.depthWrite=!1,A.transparent=!0,A.baseColor=_,A.side=Gi.DOUBLE,A.baseColorTexture=y,A.opacity=Kn,A.configureTransparency(),A.setUniforms(),A}const r=t();function o(){const _=Zn(Re.WHITE,Kn);return kr(new Je(r.pickerGeometry,_))}function l(_){const y=n(_);return kr(new Je(r.squareGeometry,y))}function c(_){const y=Zn(_,Kn);return kr(new Je(r.lineGeometry,y),new Je(r.cubeGeometry,y))}const d=o(),u=c(Re.RED);u.rotation.set(0,0,-Math.PI/2);const h=c(Re.GREEN),f=c(Re.BLUE);f.rotation.set(Math.PI/2,0,0);const p=l(Re.BLUE),m=l(Re.GREEN);m.rotation.set(Math.PI/2,0,0);const b=l(Re.RED);b.rotation.set(0,-Math.PI/2,0),d.usedAxes=7,u.usedAxes=1,h.usedAxes=2,f.usedAxes=4,p.usedAxes=3,m.usedAxes=5,b.usedAxes=6,this.parts=[d,u,h,f,p,m,b],this.parts.forEach(_=>this.add(_)),this.collidersMap=new Map(this.parts.map(_=>[_.collider,_])),this.colliders=[...this.collidersMap.keys()]}highlight(t,i){this.parts.forEach(n=>Fd(n,t,i))}usedAxes(t){return this.collidersMap.get(t).usedAxes}}const mE=.01,gE=2;class _E extends _t{constructor(){super();a(this,"currentRotationX",0);a(this,"lineMaterial",Zn(Re.WHITE,Kn));a(this,"arrow");a(this,"line");a(this,"arc");a(this,"_arrowMaterial",Zn(Re.ORANGE,Kn));a(this,"_radius",mE);a(this,"_size",gE);this.arrow=this._createArrow(),this.line=this._createLine(),this.arc=this._createArc(),this.add(this.arrow).add(this.line).add(this.arc)}_createArrow(){const t=this._radius,i=this._size,n=dt.createCylinder(0,t*6,i*.25,32,1,!1),r=dt.createCylinder(t,t,i*.75,32,1,!1),o=new Je(n,this._arrowMaterial),l=new Je(r,this._arrowMaterial);return o.position.y=i*.125*-1,l.position.y=i*.625*-1,new _t().add(o).add(l)}_createLine(){const t=this._radius,i=this._size,n=dt.createCylinder(t,t,i,32,1,!1),r=new Je(n,this.lineMaterial);return r.position.y=i*.5*-1,new _t().add(r)}_createArcMesh(t){const i=dt.createTorus(this._size*.9,this._radius,6,32,t),n=new Je(i,this.lineMaterial);return n.rotation.set(0,-Math.PI/2,-Math.PI/2),n}_createArc(){return new _t().add(this._createArcMesh(Math.PI/2))}_updateArcIfNeeded(t){if(t===this.currentRotationX)return;const i=t*-1,n=this.arc.children.pop(),r=this._createArcMesh(i);this.arc.remove(n),this.arc.add(r),n.geometry.dispose(),this.currentRotationX=t}update(t){this.arrow.rotation.copyFrom(t),this.line.rotation.set(0,0,t.z),this.arc.rotation.set(0,0,t.z),this._updateArcIfNeeded(t.x)}}var qt=(s=>(s[s.TRANSLATE=0]="TRANSLATE",s[s.ROTATE=1]="ROTATE",s[s.SCALE=2]="SCALE",s))(qt||{});const eg={ORTHOGRAPHIC:.1,PERSPECTIVE:.002};class vE{constructor(e,t,i,n){a(this,"_scene");a(this,"_collider");a(this,"_cameraWorldPosition");a(this,"_animationController");a(this,"target");a(this,"subTargetsInfo",null);a(this,"subTargetsData",new Array);a(this,"_axes",new cE);a(this,"_planes",new dE);a(this,"_markers",new hE);a(this,"_translateGizmo",new uE);a(this,"_rotateGizmo",new fE);a(this,"_scaleGizmo",new pE);a(this,"_sunHelper",new _E);a(this,"_objects3d",[this._axes,this._planes,this._markers,this._translateGizmo,this._rotateGizmo,this._scaleGizmo,this._sunHelper]);a(this,"_transforming",!1);a(this,"_initialPositionOffset",new B(0,0,0));a(this,"_initialRotationOffset",0);a(this,"_initialScaleOffset",new B);a(this,"oldPosition",new B(0,0,0));a(this,"newPosition",new B(0,0,0));a(this,"oldRotation",new mi(0,0,0,Un.XYZ));a(this,"newRotation",new mi(0,0,0,Un.XYZ));a(this,"oldScale",new B(1,1,1));a(this,"newScale",new B(1,1,1));a(this,"_mode",qt.TRANSLATE);a(this,"_visible",!1);a(this,"_startClip",{x:1/0,y:1/0});a(this,"_markersPosition",new B(0,0,0));a(this,"_currentlyHovered",null);a(this,"_pointerDown",!1);a(this,"_usedAxes",Zt.ALL);a(this,"_toEye",new B);a(this,"rotationSpeed",5);this._scene=e,this._collider=t,this._cameraWorldPosition=i,this._animationController=n,this._axes.show(Zt.ALL),this._planes.show(Zt.NONE),this._markers.show(Zt.NONE),this.mode=qt.TRANSLATE}get transforming(){return this._transforming}get position(){return this._axes.position}get rotation(){return this.oldRotation}get scale(){return this.oldScale}get currentGizmo(){switch(this._mode){case qt.TRANSLATE:return this._translateGizmo;case qt.ROTATE:return this._rotateGizmo;case qt.SCALE:return this._scaleGizmo}}get mode(){return this._mode}set mode(e){this._mode!==e&&(this._mode=e,this._updateControlsVisibility(),this._animationController.requestFrame())}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this._updateControlsVisibility())}_setScale(e){for(const t of this._objects3d)t.scale.set(e,e,e)}_copyPositionFrom(e){this.oldPosition.copyFrom(e),this.newPosition.copyFrom(e);for(const t of this._objects3d)t.position.copyFrom(e)}_copyRotationFrom(e){this.oldRotation.copyFrom(e),this.newRotation.copyFrom(e),this._mode===qt.SCALE?(this._axes.rotation.copyFrom(e),this._planes.setLocalRotation(e),this._scaleGizmo.rotation.copyFrom(this.oldRotation)):(this._axes.rotation.set(0,0,0),this._planes.setLocalRotation(void 0),this._sunHelper.update(e))}_copyScaleFrom(e){this.oldScale.copyFrom(e),this.newScale.copyFrom(e)}_updateControlsVisibility(){if(!this._visible){for(const e of this._objects3d)this._scene.removeAuxiliaryObject(e);return}this._mode===qt.TRANSLATE?(this._scene.addAuxiliaryObject(this._axes),this._scene.addAuxiliaryObject(this._planes),this._scene.addAuxiliaryObject(this._markers),this._scene.addAuxiliaryObject(this._translateGizmo),this._scene.removeAuxiliaryObject(this._rotateGizmo),this._scene.removeAuxiliaryObject(this._scaleGizmo),this._scene.removeAuxiliaryObject(this._sunHelper)):this._mode===qt.ROTATE?(this._scene.addAuxiliaryObject(this._axes),this._scene.removeAuxiliaryObject(this._translateGizmo),this._scene.addAuxiliaryObject(this._rotateGizmo),this._scene.removeAuxiliaryObject(this._scaleGizmo)):(this._scene.addAuxiliaryObject(this._axes),this._scene.addAuxiliaryObject(this._planes),this._scene.removeAuxiliaryObject(this._translateGizmo),this._scene.removeAuxiliaryObject(this._rotateGizmo),this._scene.addAuxiliaryObject(this._scaleGizmo),this._scene.removeAuxiliaryObject(this._sunHelper))}_targetIsSunInstance(){var e,t;return this.target instanceof Ml&&((e=this.target)==null?void 0:e.light)!==void 0&&((t=this.target)==null?void 0:t.light.type)===hn.SUN}_setupCameraWorldDirection(e,t,i){const n=this._scene.camera.getCurrent();this._scene.camera.isOrthographic()?e.copyFrom(n.getWorldDirection()):(n.unprojectVector(e.set(t,i,1)),e.sub(this._cameraWorldPosition).normalize())}_getCameraRayOrigin(e,t){if(this._scene.camera.isPerspective())return this._cameraWorldPosition.clone();const i=this._scene.camera.getCurrent();tt(i instanceof Vi);const n=this._scene.camera.getWorldQuaternion(new xi),r=e*(i.right-i.left)/2,o=t*(i.top-i.bottom)/2,l=new B(r,o,0);return n.applyToVector3(l),this._cameraWorldPosition.clone().add(l)}_getAxesIntersectionPosition(e,t,i){const n=new B,r=new B,o=new xi;this._setupCameraWorldDirection(n,t,i);const l=this._getCameraRayOrigin(t,i);return this._planes.findPlaneIntersectionPoint(e,l,n,r)?(r.sub(this._axes.position),this._axes.rotation.toQuaternion(o),o.inverse().applyToVector3(r),e&Zt.X||(r.x=0),e&Zt.Y||(r.y=0),e&Zt.Z||(r.z=0),r):null}_getCameraPlaneIntersectionAngle(e,t){var d;const i=new B,n=new B,r=new B,o=this._planes.cameraPlane;i.set(0,0,-1),o.matrixWorld.transformVector3(i),n.set(-1,0,0),o.matrixWorld.transformVector3(n);const l=(d=this._getAxesIntersectionPosition(Zt.ALL,e,t))==null?void 0:d.normalize();return r.copyFrom(n).cross(l),Math.sign(i.dot(r))*Math.acos(n.dot(l))}_getInitialRotationOffset(e,t){return this._getCameraPlaneIntersectionAngle(e,t)}_getNewRotation(e,t){const i=new mi(0,0,0,Un.XYZ),n=new xi,r=new xi,o=new Ue(0,0),l=new xi,c=new B,d=new B,u=new B;if(this.oldRotation.toQuaternion(l),l.normalize(),o.set(this._startClip.x-e,this._startClip.y-t),o.multiplyScalar(this.rotationSpeed),this._usedAxes===Zt.NONE){const p=this._planes.cameraPlane;return c.copyFrom(rc),p.matrixWorld.transformVector3(c),d.set(0,1,0),p.matrixWorld.transformVector3(d),r.setFromAxisAngle(c,o.y),n.setFromAxisAngle(d,-o.x),n.multiply(r),n.multiply(l),n.normalize(),i.setFromQuaternion(n,Un.ZXY),i}let h=oc,f=0;if(this._usedAxes===Zt.ALL){const p=this._planes.cameraPlane;u.set(0,0,-1),p.matrixWorld.transformVector3(u),h=u,f=this._getCameraPlaneIntersectionAngle(e,t),f=f-this._initialRotationOffset}else{if(this._usedAxes!==Zt.Z){const p=this._usedAxes===Zt.X?oc:rc,m=this._usedAxes===Zt.X?-1:1;o.multiplyScalar(m*Math.sign(p.dot(this._toEye)))}this._usedAxes===Zt.X||this._usedAxes===Zt.Y||(this._usedAxes,Zt.Z),h=rE(this._usedAxes),f=this._usedAxes===Zt.Z?-o.x:o.y}return n.setFromAxisAngle(h,f),n.multiply(l),n.normalize(),i.setFromQuaternion(n,Un.ZXY),i}_getUsedAxes(e){return this.currentGizmo.usedAxes(e)}_handleHover(e,t,i){const n={hoveredCollider:null,hasAnythingChanged:!1},r=this.currentGizmo,o=this._collider.findMeshFromListAtPosition(r.colliders,e,t,!0);let l=!1;return(o!==this._currentlyHovered||this._pointerDown!==i)&&(this._currentlyHovered=o,r.highlight(o,i),l=!0),n.hoveredCollider=o,n.hasAnythingChanged=l,n}onCanvasPointerMove(e,t){if(!this.transforming)return this._handleHover(e,t,this._pointerDown).hasAnythingChanged&&this._animationController.requestFrame(),!1;if(this._axes.show(this._usedAxes),this.mode===qt.TRANSLATE){const i=this._getAxesIntersectionPosition(this._usedAxes,e,t);i&&this.newPosition.copyFrom(i.sub(this._initialPositionOffset).add(this._axes.position)),this._translateGizmo.position.copyFrom(this.newPosition),this.adjustScaleToGizmoPosition(),this._markersPosition.copyFrom(this.newPosition),this._markersPosition.sub(this._axes.position),this._markersPosition.divide(this._axes.scale),this._markers.update(this._markersPosition),(e!==this._startClip.x||t!==this._startClip.y)&&this._markers.show(this._usedAxes)}else if(this.mode===qt.ROTATE)this.newRotation.copyFrom(this._getNewRotation(e,t)),this._targetIsSunInstance()&&(this.target&&Sa(this.target),this._sunHelper.update(this.target.rotation));else{const i=this._getAxesIntersectionPosition(this._usedAxes,e,t);i&&(i.addScalar(1).divide(this._initialScaleOffset),this.newScale.copyFrom(i))}return this._animationController.requestFrame(),!0}onCanvasPointerDown(e,t){const i=this._handleHover(e,t,!0);if(this._pointerDown=!0,i.hoveredCollider!==null){if(this._transforming=!0,this._usedAxes=this._getUsedAxes(i.hoveredCollider),this._startClip.x=e,this._startClip.y=t,this.mode===qt.TRANSLATE){this._planes.show(this._usedAxes),this.newPosition.copyFrom(this.oldPosition);const n=this._getAxesIntersectionPosition(this._usedAxes,e,t);this._initialPositionOffset.copyFrom(n)}else if(this.mode===qt.ROTATE)this._usedAxes===Zt.ALL&&(this.newRotation.copyFrom(this.oldRotation),this._initialRotationOffset=this._getInitialRotationOffset(e,t));else{this._planes.show(this._usedAxes===Zt.ALL?Zt.NONE:this._usedAxes),this.newScale.copyFrom(this.oldScale);const n=this._getAxesIntersectionPosition(this._usedAxes,e,t);this._initialScaleOffset.copyFrom(n).addScalar(1).divide(this.oldScale)}return!0}return this._usedAxes=Zt.ALL,this._transforming=!1,i.hasAnythingChanged&&this._animationController.requestFrame(),!1}onCanvasPointerUp(e,t){this.transforming&&(this._copyPositionFrom(this.newPosition),this._copyRotationFrom(this.newRotation),this._copyScaleFrom(this.newScale),this._planes.show(Zt.NONE),this._markers.show(Zt.NONE),this._usedAxes=Zt.ALL,this._axes.show(this._usedAxes),this.currentGizmo.visible=!0);const i=this.transforming;return this._transforming=!1,this.update(),this._handleHover(e,t,!1).hasAnythingChanged&&this._animationController.requestFrame(),this._pointerDown=!1,i}updateHelpers(){this._targetIsSunInstance()?this._scene.addAuxiliaryObject(this._sunHelper):this._scene.removeAuxiliaryObject(this._sunHelper)}adjustScaleToGizmoPosition(){if(this._scene.camera.isOrthographic())this._setScale(this._scene.camera.orthoFrustumSize*eg.ORTHOGRAPHIC);else{const e=this.currentGizmo.position.distanceTo(this._cameraWorldPosition);this._setScale(e*this._scene.camera.fov*eg.PERSPECTIVE)}}update(){var e;this.transforming||(((e=this.target)==null?void 0:e.position)!==void 0&&this._copyPositionFrom(this.target.position),this.target&&Sa(this.target)&&this._copyRotationFrom(this.target.rotation),this.target&&sc(this.target)&&this._copyScaleFrom(this.target.scale)),this._toEye.copyFrom(this._cameraWorldPosition),this._toEye.sub(this._axes.position),this._toEye.normalize(),this.adjustScaleToGizmoPosition(),this._rotateGizmo.update(this._scene.camera),this._planes.update(this._scene.camera),this._axes.update(this._cameraWorldPosition);for(const t of this._objects3d)t.updateMatrixWorld()}}class Od{constructor(e,t,i,n,r){a(this,"target");a(this,"_update");a(this,"_position",new B);a(this,"_rotation",new mi);a(this,"_scale",new B);a(this,"_oldPosition");a(this,"_oldRotation");a(this,"_oldScale");this._update=e,this.target=t,i&&this._position.copyFrom(i),n&&this._rotation.copyFrom(n),r&&this._scale.copyFrom(r),this._oldPosition=i,this._oldRotation=n,this._oldScale=r}apply(){var t,i,n;const e=new Od(this._update,this.target,this._oldPosition,this._oldRotation,this._oldScale);return(t=this._oldPosition)==null||t.copyFrom(this._position),(i=this._oldRotation)==null||i.copyFrom(this._rotation),(n=this._oldScale)==null||n.copyFrom(this._scale),this._update(),e}}class Ta{constructor(e){a(this,"transforms");this.transforms=e}static fromTargets(e,t){const i=new Array;for(const n of e)i.push(new Od(t,n,n.position,Sa(n)?n.rotation:void 0,sc(n)?n.scale:void 0));return new Ta(i)}apply(){const e=new Array;for(const t of this.transforms)e.push(t.apply());return new Ta(e)}isMergable(e){return!(e instanceof Ta)||e.transforms.length!==this.transforms.length?!1:e.transforms.every((t,i)=>t.target===this.transforms[i].target)}}class bE{constructor(e,t,i,n,r,o){a(this,"history");a(this,"_controls");a(this,"_enabled",!1);a(this,"_transformGizmo");a(this,"_callbacks",{itemModified:No});a(this,"_supportedModes",new Array);a(this,"_helper");this._controls=r,this._enabled=!1,this._transformGizmo=new vE(i,n,r.cameraWorldPosition(),t),this._transformGizmo.mode=qt.TRANSLATE,this.history=o,this._helper=new ml(e,D.POINTER_PRIORITY.TRANSFORM_CONTROLS),this._helper.callbacks.onPointerDown=(l,c)=>{const d=this._transformGizmo.onCanvasPointerDown(l,c);return this._setControlsEnabledState(!this._transformGizmo.transforming),d},this._helper.callbacks.onPointerUp=(l,c)=>{const d=this._transformGizmo.onCanvasPointerUp(l,c);return this._setControlsEnabledState(!this._transformGizmo.transforming),d},this._helper.callbacks.onPointerMove=(l,c)=>{const d=this._transformGizmo.onCanvasPointerMove(l,c);if(!this._transformGizmo.transforming)return d;this.target;const u=Ta.fromTargets([this.target].concat(this.subTargetsData.map(h=>h.target)),()=>{this.target&&this.target.position,this._callbacks.itemModified(this.target),this.target.setPosition(...this.target.position.toArray())});return this.history.addItem(u),this._transformGizmo.mode===qt.TRANSLATE?this._updateTargetsAfterTranslation():this._transformGizmo.mode===qt.ROTATE?this._updateTargetsAfterRotation():this._updateTargetsAfterScaling(),d},this._helper.disable()}get supportedModes(){return this._supportedModes}get mode(){return this._transformGizmo.mode}get target(){return this._transformGizmo.target}get subTargetsData(){return this._transformGizmo.subTargetsData}setTransformMode(e){this._transformGizmo.mode=e}setItemModifiedCallback(e){console.assert(this._callbacks.itemModified===No),this._callbacks.itemModified=e}update(){this._enabled&&this._transformGizmo.update()}enable(e,t,i=[]){this._enabled=!0,this._setTarget(e,i),this._supportedModes=t,this._supportedModes.indexOf(this._transformGizmo.mode)===-1&&(this._transformGizmo.mode=t[0]),this._helper.enable()}disable(){this._enabled=!1,this._supportedModes=[],this._transformGizmo.visible=!1,this._helper.disable()}_updateTargetsAfterTranslation(){this.target&&this.target.position&&this.target.setPosition;const e=this._transformGizmo.newPosition,t=e.clone().sub(this.target.position);this.target.setPosition(e.x,e.y,e.z),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(i=>{i.isSupported(this._transformGizmo.mode)&&(i.offsetPosition(t),this._callbacks.itemModified(i.target))})}_updateTargetsAfterRotation(){this.target&&Sa(this.target);const e=this._transformGizmo.newRotation,t=new B(e.x-this.target.rotation.x,e.y-this.target.rotation.y,e.z-this.target.rotation.z),i={x:this.target.rotation.x+t.x,y:this.target.rotation.y+t.y,z:this.target.rotation.z+t.z};this.target.setRotation(i.z,i.x,i.y),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(n=>{n.isSupported(this._transformGizmo.mode)&&(n.offsetRotation(t),this._callbacks.itemModified(n.target))})}_updateTargetsAfterScaling(){this.target&&sc(this.target);const e=this._transformGizmo.newScale,t=e.clone().sub(this.target.scale);this.target.setScale(e.x,e.y,e.z),this._callbacks.itemModified(this.target),this.subTargetsData&&this.subTargetsData.forEach(i=>{i.isSupported(this._transformGizmo.mode)&&(i.offsetScale(t),this._callbacks.itemModified(i.target))})}_setControlsEnabledState(e){this._controls.isEnabled()!==e&&(e?this._controls.enable():this._controls.disable())}_setTarget(e,t){this._transformGizmo.target=e,this._transformGizmo.subTargetsData=t,e!==null&&(this._transformGizmo.update(),this._transformGizmo.visible=!0,this._transformGizmo.updateHelpers())}}class yE{constructor(e,t){a(this,"_nodesPrimary");a(this,"_nodesSecondary");this._nodesPrimary=e,this._nodesSecondary=t}set highlightMix(e){this._nodesPrimary.forEach(t=>t.highlightMix=e),this._nodesSecondary.forEach(t=>t.highlightMix=e)}set selected(e){this._nodesPrimary.forEach(t=>t.selected=e),this._nodesSecondary.forEach(t=>t.selectedSecondary=e)}}class Mt{constructor(e,t,i,n,r){a(this,"_scene");a(this,"_collider");a(this,"_animationController");a(this,"_lightControls");a(this,"_lightProbeControls");a(this,"transformControls");a(this,"_cameraVolumeTriggerControls");a(this,"_updateSelectionHighlight",!1);a(this,"_selectedItems",[]);a(this,"_selectionTimeLeft",0);a(this,"_selectedNodeGroup");a(this,"_distanceToObject",0);a(this,"_clickIntersection",new Vn);a(this,"_selectionTimeSec",1);a(this,"_mode",Mt.SelectionMode.OFF);a(this,"_callbacks",{materialClicked:void 0,lightInstanceClicked:void 0,lightProbeClicked:void 0,nodeClicked:void 0,extensionClicked:void 0,positionClicked:void 0});a(this,"history",new WA);this._scene=t,this._collider=i,this._animationController=n,this._lightControls=new $A(t,n),this._lightProbeControls=new JA(t,n),this._selectionTimeLeft=0,this._distanceToObject=0,this._clickIntersection=new Vn,this.transformControls=new bE(e,n,t,i,r,this.history),this._cameraVolumeTriggerControls=new XA(t,n),this._registerPointerEventHandlers(e),this.setSelectionMode(Mt.SelectionMode.OFF,!0)}_removeCurrentSelection(){this._selectedItems.forEach(e=>{e instanceof Dd||(e.selected=!1),e.highlightMix=0}),this._selectedItems.length=0}_updateSelectionIntensity(){this._selectedItems.forEach(e=>{e.highlightMix=.8*Math.pow(this._selectionTimeLeft/this._selectionTimeSec,2)})}_selectItemByMaterial(e){this._removeCurrentSelection(),e instanceof Dd?this._selectedItems.push(e):e instanceof ai&&this._scene.threeScene.traverse(t=>{t instanceof As&&t.material===e&&(t.selected=!0,this._selectedItems.push(t))}),this._updateSelectionHighlight=!0,this._selectionTimeLeft=this._selectionTimeSec,this._updateSelectionIntensity(),this._animationController.requestFrame()}_getSupportedModeForLightInstance(e){const t=[];switch(e.light.type){case hn.POINT:t.push(qt.TRANSLATE),e.light.photometricProfile&&t.push(qt.ROTATE);break;case hn.SUN:t.push(qt.ROTATE);break;default:t.push(qt.TRANSLATE),t.push(qt.ROTATE);break}return t}get selectionMode(){return this._mode}selectMaterial(e){console.assert(this._mode===Mt.SelectionMode.MATERIAL),this._selectItemByMaterial(e)}selectLights(e,t){console.assert(this._mode===Mt.SelectionMode.LIGHT),this._lightControls.showSelectionMesh(e,t),this._animationController.requestFrame()}selectLightInstances(e,t,i){const n=r=>{const o=new Array;for(const l of this._getSupportedModeForLightInstance(e))o[l]=!0;return r.map(l=>new eE(l,o))};if(this._lightControls.showInstancesSelectionMesh(e,t),console.assert(this._mode===Mt.SelectionMode.LIGHT),e){const r=this._getSupportedModeForLightInstance(e);this.transformControls.enable(e,r,n(t))}else this.transformControls.disable();if(i){const r=this._lightControls.getLightInstanceMaterial(i);this._selectItemByMaterial(r)}else this._animationController.requestFrame()}selectLightProbe(e){let t;console.assert(this._mode===Mt.SelectionMode.LIGHT_PROBE),e?(this._lightProbeControls.showLightProbeBoundingBox(e),t=this._lightProbeControls.getLightProbeMaterial(e),this.transformControls.enable(e,[qt.TRANSLATE])):this.transformControls.disable(),this._selectItemByMaterial(t)}selectCameraVolumeTrigger(e){console.assert(this._mode===Mt.SelectionMode.CAMERA_VOLUME),e?(this._cameraVolumeTriggerControls.setControlsVisible(!0),this._selectItemByMaterial(this._cameraVolumeTriggerControls.setHighlightedCameraVolumeTrigger(e)),this.transformControls.enable(e,[qt.TRANSLATE,qt.ROTATE,qt.SCALE]),e.addEventListener(_n.disposedEventType,()=>this.transformControls.disable())):(this._selectItemByMaterial(void 0),this.transformControls.disable())}selectExtension(e){if(console.assert(this._mode===Mt.SelectionMode.EXTENSION),!e||e.triggers.length===0)return;const t=e.triggers[0];t instanceof Rr&&this._selectItemByMaterial(t.material)}selectNodes(e,t,i,n){if(console.assert(this._mode===Mt.SelectionMode.NODE),this._selectedNodeGroup&&(this._selectedNodeGroup.selected=!1),e||t.length){const r=[e].concat(i),o=t.concat(n);this._selectedNodeGroup=new yE(r,o),this._selectedNodeGroup.selected=!0,this._selectedItems.push(this._selectedNodeGroup),this._updateSelectionHighlight=!0,this._selectionTimeLeft=this._selectionTimeSec,this._updateSelectionIntensity()}else this._selectedNodeGroup=void 0;this._animationController.requestFrame()}update(e){this.transformControls.update(),this._updateSelectionHighlight&&(this._selectionTimeLeft>0?(this._selectionTimeLeft-=e,this._updateSelectionIntensity()):(this._selectedItems.forEach(t=>{t.highlightMix=0}),this._updateSelectionHighlight=!1),this._animationController.requestFrame())}_playAnimatedMaterials(){for(const e of this._scene.getAnimatedMaterials())e.play()}_pauseAnimatedMaterials(){for(const e of this._scene.getAnimatedMaterials())e.pause()}setDistanceToObject(e){this._distanceToObject=e}setSelectionMode(e,t=!1){!t&&e===this._mode||(this._mode===Mt.SelectionMode.CAMERA_VOLUME&&this._cameraVolumeTriggerControls.setControlsVisible(!1),this._removeCurrentSelection(),e==Mt.SelectionMode.LIGHT?this._lightControls.showLights():this._lightControls.hideLights(),e==Mt.SelectionMode.LIGHT_PROBE?this._lightProbeControls.showLightProbes():this._lightProbeControls.hideLightProbes(),this.transformControls.disable(),e===Mt.SelectionMode.MATERIAL||e===Mt.SelectionMode.EXTENSION?this._playAnimatedMaterials():this._pauseAnimatedMaterials(),this._mode=e)}setMaterialClickedCallback(e){console.assert(this._callbacks.materialClicked===void 0),this._callbacks.materialClicked=e}setLightInstanceClickedCallback(e){console.assert(this._callbacks.lightInstanceClicked===void 0),this._callbacks.lightInstanceClicked=e}setLightProbeClickedCallback(e){console.assert(this._callbacks.lightProbeClicked===void 0),this._callbacks.lightProbeClicked=e}setNodeClickedCallback(e){console.assert(this._callbacks.nodeClicked===void 0),this._callbacks.nodeClicked=e}setExtensionClickedCallback(e){console.assert(this._callbacks.extensionClicked===void 0),this._callbacks.extensionClicked=e}setPositionClickedCallback(e){console.assert(this._callbacks.positionClicked===void 0),this._callbacks.positionClicked=e}getMeshAtPosition(e,t){return this._collider.findObstacleMeshAtPosition(e,t,!1)}_findClickedMaterial(e,t){const i=this._collider.findObstacleMeshAtPosition(e,t,!1);return i!==null?i.material:null}_findClickedLightInstance(e,t){const i=this._collider.findMeshFromListAtPosition(this._lightControls.lightInstanceMeshes,e,t);return i!==null?i.userData.lightInstance:null}_findClickedLightProbe(e,t){const i=this._collider.findMeshFromListAtPosition(this._lightProbeControls.lightProbeMeshes,e,t);return i!==null?i.lightProbes[0]:null}_findClickedNode(e,t){const i=this._collider.findObstacleMeshAtPosition(e,t,!1);return i!==null?i.node:null}_findClickedAnchor(e,t){return this._collider.findIntersectionAtPosition(e,t,!1,this._clickIntersection)&&this._clickIntersection.object.anchor||null}_findClickedPosition(e,t){return!this._collider.findIntersectionAtPosition(e,t,!1,this._clickIntersection)||this._clickIntersection.object.anchor?null:this._collider.movePointTowardsTheCamera(this._clickIntersection.point,this._distanceToObject)}_registerPointerEventHandlers(e){const t=new ml(e,D.POINTER_PRIORITY.EDITOR_SELECTOR);t.callbacks.onClick=(i,n,r)=>{if([Mt.SelectionMode.OFF,Mt.SelectionMode.CAMERA_VOLUME].includes(this._mode))return!1;let o=null,l=!1;switch(this._mode){case Mt.SelectionMode.MATERIAL:o=this._findClickedMaterial(i,n),o!==null&&this._callbacks.materialClicked&&(l=this._callbacks.materialClicked(o,r));break;case Mt.SelectionMode.LIGHT:o=this._findClickedLightInstance(i,n),o!==null&&this._callbacks.lightInstanceClicked&&(l=this._callbacks.lightInstanceClicked(o,r));break;case Mt.SelectionMode.LIGHT_PROBE:o=this._findClickedLightProbe(i,n),o!==null&&this._callbacks.lightProbeClicked&&(l=this._callbacks.lightProbeClicked(o,r));break;case Mt.SelectionMode.NODE:o=this._findClickedNode(i,n),o&&this._callbacks.nodeClicked&&(l=this._callbacks.nodeClicked(o,r));break;case Mt.SelectionMode.EXTENSION:o=this._findClickedAnchor(i,n),o&&o.extension&&this._callbacks.extensionClicked&&(l=this._callbacks.extensionClicked(o.extension,o,r));break;case Mt.SelectionMode.POSITION:o=this._findClickedPosition(i,n),o&&this._callbacks.positionClicked&&(l=this._callbacks.positionClicked(o,r));break}return l},t.callbacks.onDoubleClick=(i,n)=>!1}}(s=>{(e=>{e[e.OFF=0]="OFF",e[e.MATERIAL=1]="MATERIAL",e[e.LIGHT=2]="LIGHT",e[e.LIGHT_PROBE=3]="LIGHT_PROBE",e[e.NODE=4]="NODE",e[e.EXTENSION=6]="EXTENSION",e[e.POSITION=7]="POSITION",e[e.CAMERA_VOLUME=8]="CAMERA_VOLUME"})(s.SelectionMode||(s.SelectionMode={}))})(Mt||(Mt={}));function Ma(s){return s.reduce((e,t)=>Math.max(e,t.id),0)+1}function xE(s,e){return s.every(t=>t.name!==e)}function wo(s,e){let t=s;for(let i=2;!xE(e,t);i+=1)t=s+i.toString();return t}function AE(s){return s.trim()||"light"}function tg(s){return s.trim()||"view"}function EE(s){return[mn(Math.atan2(-s.x,s.y)),mn(Math.asin(s.z))]}class wE{constructor(e,t,i,n,r,o,l,c,d,u,h,f,p){a(this,"scene");a(this,"menu");a(this,"controls");a(this,"collider");a(this,"teleport");a(this,"editorSelector");a(this,"extensionManager");a(this,"screenshotTaker");a(this,"animationController");a(this,"minimap");a(this,"autoTour");a(this,"sceneStats");a(this,"disableCache");a(this,"pauseLoadedVideoTextures");a(this,"textureManager");a(this,"skyLoader");a(this,"transformControls");a(this,"viewModeControls");a(this,"history");a(this,"materialLibrary");a(this,"removedViewsToHiddenNodes",new Map);a(this,"_requestLiveLightmapUpdate",()=>{});this.scene=e,this.menu=t,this.controls=i,this.collider=n,this.teleport=r,this.editorSelector=o,this.extensionManager=l,this.screenshotTaker=c,this.animationController=d,this.minimap=u,this.autoTour=h,this.viewModeControls=f,this.materialLibrary=p,this.sceneStats={geometryFacesCnt:this.scene.nodes.reduce((b,_)=>b+_.facesInSubtree(),0),objectsCnt:this._getObjectsCnt(),lightmapsCnt:this._getLightmapsCnt()},this.disableCache=!0,this.pauseLoadedVideoTextures=!1,this.textureManager=e.textureManager,this.skyLoader=new Wh(this.textureManager),this.transformControls=this.editorSelector.transformControls,this.history=this.editorSelector.history;const m=()=>{this._requestLiveLightmapUpdate(),this.scene.liveLightmap.mode===Dl.LIVE&&(this.scene.liveLightmap.mode=Dl.BASIC)};this.scene.camera.addEventListener("positionChanged",m),this.scene.camera.addEventListener("rotationChanged",m),this.scene.camera.addEventListener(br.physicalDimensionsChangedEventType,m),this.scene.addEventListener(wi.liveLightmapNeedsUpdateEventType,()=>this._requestLiveLightmapUpdate())}setLiveLightmapCallback(e){this._requestLiveLightmapUpdate=e}_getObjectsCnt(){let e=0;return this.scene.visitAllNodes(function(t){t.mesh&&e++}),e}_getLightmapsCnt(){let e=-1;return this.scene.visitAllNodes(function(t){t.mesh&&t.mesh.lightmapIdx>e&&(e=t.mesh.lightmapIdx)}),e+1}get screenAspectRatio(){return this.scene.camera.aspectRatio}setLiveLightmap(e){this.scene.liveLightmap.mode=Dl.LIVE,this.scene.liveLightmap.set(e)}getLightmapLayoutVersion(){return this.scene.lightmapLayoutVersion}getExtensionManager(){return this.extensionManager}getCameraPosition(){const e=this.controls.cameraWorldPosition();return[e.x,e.y,e.z]}getCameraRotation(){return[mn(this.controls.getYawAngle()),mn(this.controls.getPitchAngle())]}getPointInFrontOfTheCamera(e=1){const t=this.collider.distanceToObstacle(e);t<e&&(e=t);const i=this.controls.cameraWorldPosition(),n=this.controls.getYawAngle(),r=this.controls.getPitchAngle(),o=e*Math.cos(r)*Math.sin(n),l=e*Math.cos(r)*Math.cos(n),c=e*Math.sin(r),d=i.x-o,u=i.y+l,h=i.z+c;return[d,u,h]}getCamera(){return this.scene.camera}getSceneStats(){return this.sceneStats}getMaterials(){return this.scene.sortedMaterials()}getLights(){return this.scene.lights}getLightProbes(){return this.scene.lightProbes}getCameraVolumes(){return this.scene.cameraVolumes}getNodes(){return this.scene.nodes}getMinimap(){return this.minimap}getMinimapConfig(){return this.scene.minimapConfig}setLevelSelectedCallback(e){this.minimap.addEventListener("minimapLevelSelected",function(t){t.level!==null&&e(t.level)})}getBoundingBox(){return this.scene.boundingBox}addLight(e){this.scene.addLight(e)}createLight(e,t,i){const n=new dn({name:wo(e,this.scene.lights),type:t,doNotImport:!0});return n.addInstance(i),n}removeLight(e){this.scene.removeLight(e)}renameLight(e,t){t=AE(t),e.name="",e.name=wo(t,this.scene.lights)}createLightInstance(e,t,i=[0,-90,0]){const n=new B().fromArray(t),r=new mi().setFromDegTriple(i);return new Ml(e,n,r)}addLightInstance(e){console.assert(this.scene.lights.some(t=>t===e.light)),e.light.addCreatedInstance(e)}cloneLightInstance(e){const t=this.createLightInstance(e.light,[0,0,0]);return this.cloneIntoLightInstance(t,e),t}cloneIntoLightInstance(e,t){e.position.copyFrom(t.position),e.rotation.copyFrom(t.rotation)}removeLightInstance(e,t){e.removeInstance(t)}addLightProbe(e){console.assert(this.scene.lightProbes.every(t=>t.id!==e.id)),this.scene.addLightProbe(e),this.scene.lightProbes.length===1&&this.scene.enableLightProbesForMaterials()}createLightProbe(e){const t=new ga({id:Ma(this.scene.lightProbes),position:e});return t.enableBoundingBox(),t}cloneLightProbe(e){const t=this.createLightProbe([0,0,0]);return this.cloneIntoLightProbe(t,e),t}cloneIntoLightProbe(e,t){const i=t.position.toArray();e.setPosition(...i),e.setBoxMin(...t.boxMin.toArray()),e.setBoxMax(...t.boxMax.toArray()),t.isBoundingBoxEnabled()||e.disableBoundingBox(),e.id=Ma(this.scene.lightProbes)}removeLightProbe(e){this.scene.removeLightProbe(e),this.scene.lightProbes.length===0&&this.scene.disableLightProbesForMaterials()}getCameraVolumeTypes(){return Object.values(ul)}createCameraVolume(e,t){const i=new B().fromArray(this.getCameraPosition()),n=this.getCameraRotation(),r=new B(0,3,0);new mi(n[0]/180*Math.PI,n[1]/180*Math.PI,0).applyToVector3(r);const l=Ma(this.scene.cameraVolumes);return ye(e===ul.CUBE||e===ul.SPHERE),new Id({id:l,name:t||e+l,type:e,position:i.add(r).toArray(),rotation:[0,0,0],scale:[1,1,1],exposure:this.scene.camera.defaultExposure,gamma:this.scene.camera.defaultGamma},this.scene.camera,this.scene.exposureController)}addCameraVolume(e){console.assert(this.scene.cameraVolumes.every(t=>t.id!==e.id)),e.name=wo(e.name,this.scene.cameraVolumes),e.reinstate(),this.scene.addCameraAdjustmentVolume(e)}cloneCameraVolume(e){const t=this.createCameraVolume(e.getCameraVolumeTrigger().volumeType);return this.cloneIntoCameraVolume(t,e),t}cloneIntoCameraVolume(e,t){const i=t.getCameraVolumeTrigger(),n=e.getCameraVolumeTrigger();n.position.copyFrom(i.position),n.rotation.copyFrom(i.rotation),n.scale.copyFrom(i.scale),e.exposure=t.exposure,e.gamma=t.gamma}removeCameraVolume(e){this.scene.removeCameraVolume(e)}shiftCameraVolume(e,t){this.scene.shiftCameraVolume(e,t)}getCameraVolumesIndex(e){return this.scene.cameraVolumes.findIndex(t=>t===e)}getViews(){return this.scene.views}markScreenshotArea(e){this.screenshotTaker.markArea(e)}unmarkScreenshotArea(){this.screenshotTaker.unmarkArea()}monoScreenToBuffer(e,t,i){return this.screenshotTaker.monoScreenToBuffer(e,t,i)}stereoPanoramaToBuffer(e,t,i,n){this.screenshotTaker.stereoPanoramaToBuffer(e,t,i,n)}_fillParamsForTopViewType(e){const t=this.controls.orbit,i=this.controls.cameraWorldPosition();e.mode=Mr.ORBIT,e.sky=D.DEFAULT_SKY_NAME,e.panPrimary=!0,e.noPitchRotate=!0,ye(e.rotation),e.rotation[1]=-90,e.minUpAngle=0,e.maxUpAngle=Math.PI/2,t.isEnabled()?(e.target=[t.target.x,t.target.y,this.scene.boundingBox.min.z],e.distance=t.getCameraDistance(),e.minDistance=t.getMinDistance(),e.maxDistance=t.getMaxDistance()):(e.target=[i.x,i.y,this.scene.boundingBox.min.z],e.distance=Math.max(i.z-this.scene.boundingBox.min.z,1))}_fillParamsForOrbitViewType(e){const t=this.controls.orbit,i=this.controls.cameraWorldPosition();if(e.mode=Mr.ORBIT,e.sky=D.DEFAULT_SKY_NAME,e.panPrimary=!1,e.noPitchRotate=!1,t.isEnabled())e.target=t.target.toArray(),e.distance=t.getCameraDistance(),e.minDistance=t.getMinDistance(),e.maxDistance=t.getMaxDistance(),e.minUpAngle=-t.getMaxPitchAngle(),e.maxUpAngle=-t.getMinPitchAngle(),e.noPan=t.getNoPan();else{e.minUpAngle=0,e.maxUpAngle=Math.PI/2;const n=this.scene.boundingBox.center();e.target=n.toArray();const r=n;r.sub(i),e.distance=r.length(),r.normalize(),e.rotation=EE(r),e.rotation[1]=Pi(e.rotation[1],-e.maxUpAngle,e.minUpAngle)}}createViewFromCamera(e,t){const i=[0,0];console.assert(["fps","top","orbit"].includes(t)),i[0]=mn(this.controls.getYawAngle()),i[1]=mn(this.controls.getPitchAngle());const n={id:Ma(this.scene.allViews()),name:wo(tg(e),this.scene.allViews()),rotation:i};if(t==="fps"){const r=this.controls.cameraWorldPosition();n.mode=Mr.FPS,n.sky=D.EDITOR_CONTROLLED_SKY_NAME,n.position=r.toArray()}else t==="top"?this._fillParamsForTopViewType(n):this._fillParamsForOrbitViewType(n);return new Qi(n)}addView(e){console.assert(this.scene.allViews().every(i=>i.id!==e.id)),e.name=wo(e.name,this.scene.allViews());const t=this.removedViewsToHiddenNodes.get(e);if(t){for(const i of t)i.isOnHideInViews(e.id)||i.addToHideInViews(e.id);this.removedViewsToHiddenNodes.delete(e)}this.scene.addView(e)}cloneView(e){const t=this.createViewFromCamera("","fps");return this.cloneIntoView(t,e),t}cloneIntoView(e,t){Object.assign(e,new Qi(t.serialize())),e.id=Ma(this.scene.allViews()),this.scene.nodeConfigs.forEach(function(i){i.hideInViews&&i.isOnHideInViews(t.id)&&i.addToHideInViews(e.id)})}resetViewFromCamera(e){const t=this.controls.cameraWorldPosition();e.mode==="fps"?e.position.copyFrom(t):(e.target.copyFrom(this.controls.orbit.target),e.distance=t.distanceTo(e.target)),(e.mode==="fps"||!e.isTop())&&(e.rotation.pitch=this.controls.getPitchAngle()),e.setYaw(this.controls.getYawAngle())}removeView(e){const i=this.scene.nodeConfigs.filter(n=>n.hideInViews&&n.isOnHideInViews(e.id));this.removedViewsToHiddenNodes.set(e,i),this.scene.removeView(e)}shiftView(e,t){this.scene.shiftView(e,t)}getViewsIndex(e){return this.scene.views.findIndex(t=>t===e)}activateSkyForView(e){this.teleport.activateSky(e)}setCameraPosition(e,t,i){this.controls.cameraWorldPosition().set(e,t,i),this.controls.cameraPositionUpdated()}isTeleporting(){return this.teleport.teleportingToView||this.teleport.teleportingToPoint}switchToView(e,t){this.autoTour.isRunning()&&this.autoTour.stop(),this.teleport.switchToView(e,t),Ir()}renameView(e,t){t=tg(t),e.name="",e.setName(wo(t,this.scene.allViews()))}updateHiddenMeshes(e){this.teleport.updateHiddenMeshes(e)}getSky(){return this.scene.findSkyMesh(D.EDITOR_CONTROLLED_SKY_NAME)}loadSkyTexture(e){return this.skyLoader.loadSkyTexture(e)}loadTexture(e,t){ye(typeof e.id=="string"),this.textureManager.remove(e.id);const i=this.textureManager.load(e,gn.REPEAT_WRAPPING|gn.GENERATE_MIPS,D.LOAD_PRIORITY.CORE_RESOURCE,!0);return t===Pn.BASE_COLOR&&(i.isCutout=void 0),i}materialTextureUpdated(e,t){const n=new Set;let r="";const o=function(l){const c=l.geometry;if(!(c.vertexCnt===0||c.hasAttribute("uv0"))&&!n.has(l.node.type)){if(n.add(l.node.type),n.size>5)return;r+=r.length>0?", ":"",r+=`'${l.node.type}'`}};return e.textureNeedsUv0(t)&&this.scene.visitMeshesWithMaterial(e,o),n.size>0&&"Texture "+t+" won't be correctly mapped. The following objects lack base color UV mapping coming from the 3D modeling tool: "+r+(n.size>5?" (plus "+(n.size-5)+" more).":".")}changeSkyTexture(e){const t=this.scene.findSkyMesh(D.EDITOR_CONTROLLED_SKY_NAME),i=this.scene.sharedMaterialState.fog;if(!e&&t.type===er.EQUIRECT){this.scene.removeSkyMesh(t);const n={name:D.EDITOR_CONTROLLED_SKY_NAME,type:er.PROCEDURAL};this.skyLoader.loadSingleSky(n,this.scene,i)}else if(ye(e),t.type===er.PROCEDURAL){this.scene.removeSkyMesh(t);const n={name:D.EDITOR_CONTROLLED_SKY_NAME,type:er.EQUIRECT,texture:e};this.skyLoader.loadSingleSky(n,this.scene,i)}else t.setTexture(e);this.scene.adjustSkiesAndCameraFarToSpanWholeScene()}getColorMapName(){return this.scene.camera.colorMap?this.scene.camera.colorMap.name:void 0}loadColorMap(e){return this.textureManager.loadColorMap(e)}getSceneJson(){return this.scene.serialize()}getCoverJson(){const e=this.menu.cover;return e.extensions=this.extensionManager.getConfigs(),e}getSelectionMode(){return this.editorSelector.selectionMode}disableSelection(){this.editorSelector.setSelectionMode(Mt.SelectionMode.OFF)}enableMaterialSelection(){this.editorSelector.setSelectionMode(Mt.SelectionMode.MATERIAL)}enableLightSelection(){this.editorSelector.setSelectionMode(Mt.SelectionMode.LIGHT)}enableLightProbeSelection(){this.editorSelector.setSelectionMode(Mt.SelectionMode.LIGHT_PROBE)}enableExtensionSelection(){this.editorSelector.setSelectionMode(Mt.SelectionMode.EXTENSION)}enablePositionSelection(e){this.editorSelector.setDistanceToObject(e),this.editorSelector.setSelectionMode(Mt.SelectionMode.POSITION)}enableNodeSelection(){this.editorSelector.setSelectionMode(Mt.SelectionMode.NODE)}enableCameraVolumeSelection(){this.editorSelector.setSelectionMode(Mt.SelectionMode.CAMERA_VOLUME)}selectMaterial(e){this.editorSelector.selectMaterial(e)}replaceMaterial(e,t){const i=this.scene.replaceMaterial(e,t);return i.isAnimated&&i.play(),i}selectLights(e,t){this.editorSelector.selectLights(e,t)}selectLightInstances(e,t,i){this.editorSelector.selectLightInstances(e,t,i)}selectLightProbe(e){this.editorSelector.selectLightProbe(e)}selectCameraVolumeTrigger(e){this.editorSelector.selectCameraVolumeTrigger(e)}selectExtension(e){this.editorSelector.selectExtension(e)}selectNodes(e,t,i,n){this.editorSelector.selectNodes(e,t,i,n)}setMaterialClickedCallback(e){this.editorSelector.setMaterialClickedCallback(e)}setLightInstanceClickedCallback(e){this.editorSelector.setLightInstanceClickedCallback(e)}setLightProbeClickedCallback(e){this.editorSelector.setLightProbeClickedCallback(e)}setNodeClickedCallback(e){this.editorSelector.setNodeClickedCallback(e)}setExtensionClickedCallback(e){this.editorSelector.setExtensionClickedCallback(e)}setPositionClickedCallback(e){this.editorSelector.setPositionClickedCallback(e)}setItemModifiedCallback(e){this.transformControls.setItemModifiedCallback(e)}setViewSelectedCallback(e){this.teleport.addEventListener("teleportStarted",function(t){t.view&&e(t.view)})}coverModified(e){this.menu.updateCover(e)}autoTourModified(){this.menu.refresh()}hasLightmap(){return this.scene.hasLightmap()}getAutoTour(){return this.scene.autoTour}getDisableProgressiveLoader(){return this.scene.disableProgressiveLoader}setDisableProgressiveLoader(e){this.scene.disableProgressiveLoader=e}getInteractionPrompt(){return this.scene.interactionPrompt}setInteractionPrompt(e){this.scene.interactionPrompt=e}getTransformMode(){return this.transformControls.mode}setTransformMode(e){this.transformControls.setTransformMode(e)}getSupportedTransformModes(){return this.transformControls.supportedModes}seeItem(e){Li().seeItem(e)}onViewModeChanged(e){this.viewModeControls.addEventListener("viewModeChanged",t=>e(t.viewMode))}onDropMaterial(e){const t=e.clientX/window.innerWidth*2-1,i=-(e.clientY/window.innerHeight)*2+1,n=this.editorSelector.getMeshAtPosition(t,i);n&&this.materialLibrary.replaceMaterial(n,e.data)}onDragMaterial(e){const t=e.clientX/window.innerWidth*2-1,i=-(e.clientY/window.innerHeight)*2+1,n=this.editorSelector.getMeshAtPosition(t,i);this.materialLibrary.hoverMaterial(n,e.data)}}class ig{constructor(){a(this,"onSceneLoaded");a(this,"enableCollisions");a(this,"forcedInitialCameraPosition");a(this,"forcedInitialCameraRotation");a(this,"sendCoverToServer");this.onSceneLoaded=void 0,this.enableCollisions=!0,this.forcedInitialCameraPosition=void 0,this.forcedInitialCameraRotation=void 0,this.sendCoverToServer=!1}}class SE{constructor(e,t,i){a(this,"_scene");a(this,"_animationController");a(this,"_materialLoader");a(this,"_materialCache",new Map);a(this,"_meshData",[]);this._scene=e,this._animationController=t,this._materialLoader=new Hh(e.textureManager,i)}_getMaterial(e){const t=JSON.stringify(e),i=this._materialCache.get(t);if(i)return i;const n=this._materialLoader.getMaterial(e);return n.sharedMaterialState=this._scene.sharedMaterialState,this._materialCache.set(t,n),n}_getMeshesByMaterial(e){return this._scene.gpuMeshes.filter(t=>t.material===e)}_findMeshData(e){return this._meshData.find(t=>t.meshes.includes(e))}_applyMaterialToMeshes(e,t){e.forEach(i=>i.material=t)}_createMeshData(e,t,i,n){this._meshData.push({meshes:e,originalMaterial:t,replacedMaterial:i,hoverMaterial:n})}replaceMaterial(e,t){const i=e.material,n=this._getMeshesByMaterial(i),r=this._getMaterial(t),o=this._findMeshData(e);o?(this._applyMaterialToMeshes(o.meshes,r),o.replacedMaterial=r,o.hoverMaterial=void 0):this._createMeshData(n,i,r,void 0),this._animationController.requestFrame()}_restoreMaterial(){this._meshData.forEach(e=>{e.meshes.forEach(t=>t.material=e.replacedMaterial||e.originalMaterial),e.hoverMaterial=void 0})}hoverMaterial(e,t){if(e===null){this._restoreMaterial(),this._animationController.requestFrame();return}const i=e.material,n=this._getMeshesByMaterial(i),r=this._getMaterial(t),o=this._findMeshData(e);o&&o.hoverMaterial!==r&&(this._restoreMaterial(),this._applyMaterialToMeshes(o.meshes,r),o.hoverMaterial=r),o||(this._restoreMaterial(),this._applyMaterialToMeshes(n,r),this._createMeshData(n,i,void 0,r)),this._animationController.requestFrame()}}class TE extends ai{constructor(){super({vsName:"static_render_vertex.glsl",fsName:"static_render_fragment.glsl"}),this.uniforms={staticRender:{type:"t",value:null,uniformSourceType:ve.MATERIAL},sizeInv:{type:"v2",value:new Ue,uniformSourceType:ve.GLOBAL}}}}function ME(s){const e=om(s,{antialias:!1});return e.autoClear=!1,e.sortObjects=!1,e}class PE{constructor(e){a(this,"_material",new TE);a(this,"_camera",Vi.createNDC());a(this,"_scene",new uo);a(this,"_renderer");this._renderer=ME(e);const t=new Je(dt.createPlane(2,2),this._material);this._renderer.uploadNewBuffers(t),this._scene.add(t)}update(e){const t=new Float32Array(e,0,e.byteLength/4),i=t[1],n=t[2],r=t.subarray(3);i*n,r.length/3;const o=wt.newDataTexture(r,i,n,nt.RGB32F);o.minFilter=ne.NEAREST,o.magFilter=ne.NEAREST,o.generateMipmaps=!1,o.flipY=!1,o.needsUpdate=!0,this._material.uniforms.staticRender.value=o,this._material.uniforms.sizeInv.value.set(1/i,1/n),this._renderer.setCanvasSize(i,n),this._renderer.render(this._scene,this._camera),o.dispose()}}var lc=(s=>(s.TOP="top",s.LEFT="left",s.FRONT="front",s))(lc||{}),ng=(s=>(s[s.PERSPECTIVE=0]="PERSPECTIVE",s[s.ORTHOGRAPHIC=1]="ORTHOGRAPHIC",s))(ng||{}),sg=(s=>(s[s.NONE=0]="NONE",s[s.WIREFRAME_TRANSPARENT=1]="WIREFRAME_TRANSPARENT",s[s.WIREFRAME_OPAQUE=2]="WIREFRAME_OPAQUE",s))(sg||{});function cc(s){let e,t;if(s instanceof As){const r=Nc();s.selected===!0?(t=1.5,e=r.meshSelectedLineColor):s.selectedSecondary===!0&&(t=1.25,e=r.meshSelectedSecondaryLineColor)}return{lineColor:e,lineThickness:t}}class CE extends kt{constructor(t){super();a(this,"_scene");a(this,"_controls");a(this,"_rawRenderer");a(this,"_teleport");a(this,"_animationController");a(this,"_internalViews");a(this,"_wireframeMaterial");a(this,"_autoClearAlter");a(this,"_clearColorAlter");a(this,"_currentMaterialOverride");a(this,"_transparentWireframeMaterial");a(this,"_opaqueWireframeMaterial");a(this,"_onViewModeChanged",t=>{this.dispatchEvent({type:"viewModeChanged",viewMode:t})});this._scene=t.scene,this._controls=t.controls,this._rawRenderer=t.rawRenderer,this._teleport=t.teleport,this._animationController=t.animationController,this._internalViews=this._scene.internalViews;const i=this._scene.boundingBox.getBoundingSphere().radius*2;this._wireframeMaterial=new ro(void 0,i,cc),this._transparentWireframeMaterial=new ro(void 0,i,cc,!0),this._opaqueWireframeMaterial=new ro(void 0,i,cc,!1),this._autoClearAlter=new ws(this._rawRenderer),this._clearColorAlter=new fl(this._rawRenderer),this._currentMaterialOverride=0,this._bindUi()}_bindUi(){const t=document.getElementById("view-mode");if(!t)return;t.style.display="block";const i=(n,r)=>{var o;(o=document.getElementById(n))==null||o.addEventListener("click",r)};i("view-mode-top",()=>this._setViewType("top")),i("view-mode-front",()=>this._setViewType("front")),i("view-mode-left",()=>this._setViewType("left")),i("view-mode-fps",()=>this._switchToFpsView()),i("view-mode-persp",()=>this._setProjectionType(0)),i("view-mode-ortho",()=>this._setProjectionType(1)),i("view-mode-color",()=>this._setMaterialOverride(0)),i("view-mode-wireframe-opaque",()=>this._setMaterialOverride(2)),i("view-mode-wireframe-transparent",()=>this._setMaterialOverride(1))}_switchToFpsView(){const t=this._controls.getYawAngle()/Math.PI*180,i=this._controls.getPitchAngle()/Math.PI*180,n=new Qi({mode:Mr.FPS,position:this._controls.cameraWorldPosition().toArray(),rotation:[t,i],fov:this._teleport.lastDestinationView.fov,internal:!0});this._teleport.switchToView(n),this._onViewModeChanged("ViewType.FPS")}_setViewType(t){const i=this._internalViews.find(n=>n.name===t);i&&(i.orthographic=this._teleport.lastDestinationView.orthographic,this._teleport.switchToView(i),this._onViewModeChanged("ViewType."+t.toUpperCase()))}_setProjectionType(t){var l;const i=()=>{const c=this._controls.getYawAngle()/Math.PI*180,d=this._controls.getPitchAngle()/Math.PI*180;return[c,d]},n=t===1?this._scene.boundingBox.getBoundingSphere().radius:this._teleport.lastDestinationView.distance,r=t===1?Mr.ORBIT:this._teleport.lastDestinationView.mode,o=this._teleport.teleportingToView?this._teleport.lastDestinationView:new Qi({position:this._controls.cameraWorldPosition().toArray(),rotation:i(),orthoFrustumSize:this._teleport.lastDestinationView.orthoFrustumSize,target:(l=this._teleport.lastDestinationView.target)==null?void 0:l.toArray(),mode:r,distance:n,internal:!0});o.orthographic=t===1,this._teleport.switchToView(o),this._onViewModeChanged("ProjectionType."+ng[t])}_setMaterialOverride(t){switch(t){case 0:this._removeMaterialOverride(),this._currentMaterialOverride=0;break;case 2:this._setWireframeMaterial(this._opaqueWireframeMaterial),this._currentMaterialOverride=2;break;case 1:this._setWireframeMaterial(this._transparentWireframeMaterial),this._currentMaterialOverride=1;break}this._onViewModeChanged("MaterialOverride."+sg[t])}_removeMaterialOverride(){this._currentMaterialOverride!==0&&(this._autoClearAlter.restore(),this._clearColorAlter.restore()),D.DEV_NEW_RENDER_ARCHITECTURE?Yi.get().setWireframeMode(void 0):this._scene.gpuMeshes.forEach(t=>{t.materialOverride=null}),this._scene.skyMeshes.forEach(t=>{t.visible=!0}),this._animationController.requestFrame()}_setWireframeMaterial(t){if(this._currentMaterialOverride===0&&(this._autoClearAlter.set(!0,!1,!1),this._clearColorAlter.set(Nc().wireframeModeClearColor)),D.DEV_NEW_RENDER_ARCHITECTURE){const i=Yi.get();i.setWireframeMode(t),this._scene.gpuMeshes.forEach(n=>{const r=cc(n);r.lineColor&&i.updateEntityStateById(n.entityId,go,{lineColor:r.lineColor,lineThickness:r.lineThickness,backsideLineThickness:r.backsideLineThickness})})}else this._scene.gpuMeshes.forEach(i=>{i.materialOverride=t,this._rawRenderer.uploadNewBuffers(i)});this._scene.skyMeshes.forEach(i=>{i.visible=!1}),this._animationController.requestFrame()}}function RE(){D.Viewer=Bm,D.View=Qi,D.getViewer=Li,D.getExtraAssetUrl=Bo,D.initEditMode=VA,D.ColorUtils=Qr,D.TRANSFORM_MODE=qt,D.STRINGS=zc,D.ICONS=zl,D.StaticRenderViewer=PE,D.SceneLoadConfig=ig,D.init=Qm,D.updateViewerStrings=du,D.getViewerStrings=__,D.hasShiftKeyModifier=C0,D.hasCtrlEquivalentKeyModifier=R0,D.hasAltEquivalentModifier=I0,D.StandardMaterial=si,window.WALK=D,window.WebXRConfig=Wl}function IE(){const s=this,e=new B,t=new B,i=new B,n=new B,r=new B;this.objects=[];let o=null;this.vertices=[],this.normals=[],this.uvs=[],this.startObject=function(p){o={name:p||"",vertices:[],normals:[],uvs:[],hasUvs:!1},this.objects.push(o)};function l(p,m,b){return(p>=0?p-1:p+m/b)*b}function c(p,m,b){const _=s.vertices,y=o.vertices;y.push(_[p+0],_[p+1],_[p+2]),y.push(_[m+0],_[m+1],_[m+2]),y.push(_[b+0],_[b+1],_[b+2])}function d(p,m,b){const _=s.normals,y=o.normals;y.push(_[p+0],_[p+1],_[p+2]),y.push(_[m+0],_[m+1],_[m+2]),y.push(_[b+0],_[b+1],_[b+2])}function u(p,m,b){const _=s.vertices,y=o.normals;e.fromArray(_,p),t.fromArray(_,m),i.fromArray(_,b),r.subVectors(i,t),n.subVectors(e,t),r.cross(n),r.normalize(),y.push(r.x,r.y,r.z),y.push(r.x,r.y,r.z),y.push(r.x,r.y,r.z)}function h(p,m,b){const _=s.uvs,y=o.uvs;y.push(_[p+0],_[p+1]),y.push(_[m+0],_[m+1]),y.push(_[b+0],_[b+1])}function f(){const p=o.uvs;p.push(0,0),p.push(0,0),p.push(0,0)}this.addFace=function(p,m,b,_,y,A,T,M,C){const N=this.vertices.length,O=l(p,N,3),q=l(m,N,3),j=l(b,N,3);if(c(O,q,j),T!==void 0){const K=this.normals.length;d(l(T,K,3),l(M,K,3),l(C,K,3))}else u(O,q,j);if(_!==void 0){const K=this.uvs.length;h(l(_,K,2),l(y,K,2),l(A,K,2)),o.hasUvs=!0}else f()}}function DE(s){return s.indexOf(`\r
`)!==-1&&(s=s.replace(/\r\n/g,`
`)),s.indexOf(`\\
`)!==-1&&(s=s.replace(/\\\n/g,"")),s}function Os(s){if(!(s===void 0||s===""))return parseInt(s,10)}function LE(s){const e=/^[og]\s*(.+)?/,t=/^mtllib /,i=/^usemtl /,n=/^usemap /,r=new IE;s=DE(s);const o=s.split(`
`);let l=[];for(const d of o){if(d.length===0||d==="\0")continue;const u=d.charAt(0);if(u!=="#")if(u==="v"){const h=d.split(/\s+/);switch(h[0]){case"v":r.vertices.push(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3])),h.length>=7&&console.assert(!1,"obj with vertex colors is not supported");break;case"vn":r.normals.push(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3]));break;case"vt":r.uvs.push(parseFloat(h[1]),parseFloat(h[2]));break}}else if(u==="f"){const f=d.substr(1).trim().split(/\s+/),p=[];for(const b of f)if(b.length>0){const _=b.split("/");p.push(_)}const m=p[0];for(let b=1,_=p.length-1;b<_;b++){const y=p[b],A=p[b+1];r.addFace(Os(m[0]),Os(y[0]),Os(A[0]),Os(m[1]),Os(y[1]),Os(A[1]),Os(m[2]),Os(y[2]),Os(A[2]))}}else if(u==="l")console.assert(!1,"line geometry is not supported");else if(u==="p")console.assert(!1,"obj point geometry not supported");else if((l=e.exec(d))!==null){const h=(" "+l[0].substr(1).trim()).substr(1);r.startObject(h)}else i.test(d)||t.test(d)||n.test(d)||u==="s"||console.warn('OBJLoader: Unexpected line: "'+d+'"')}const c=new Map;for(const d of r.objects){if(d.vertices.length===0)continue;const u=new Wi;u.addAttribute("position",new St(new Float32Array(d.vertices),3)),d.normals.length>0&&u.addAttribute("normal",new St(new Float32Array(d.normals),3)),d.hasUvs===!0&&u.addAttribute("uv0",new St(new Float32Array(d.uvs),2)),u.convertNormalsToSpherical(),u.computeBoundingBox(),u.computeBoundingSphere(),c.set(d.name,u)}return c}let st={};function FE(s){for(;s.firstChild;)s.removeChild(s.firstChild)}function OE(s,e){const t=document.getElementById(s);t.onchange=e}function hc(s){s.style.display=""}function dc(s){s.style.display="none"}function BE(s,e){e?hc(s):dc(s)}function NE(s,e){e?s.classList.add("ext-meeting-button-highlight"):s.classList.remove("ext-meeting-button-highlight")}function kE(s){s.classList.add("ext-meeting-input-missing"),window.setTimeout(()=>{s.classList.remove("ext-meeting-input-missing")},200)}function UE(s){s.classList.add("ext-meeting-text-highlighted"),window.setTimeout(()=>{s.classList.remove("ext-meeting-text-highlighted")},200)}function $n(s){let e=null,t=null;this.showDismiss=!0,this.onClose=null,this.onDismiss=null,this.position=$n.DEFAULT,this.foremost=!1,this.modal=!1,this.open=function(){t===null&&(this.modal?(e=document.createElement("div"),e.className="modal-backdrop",document.body.appendChild(e),t=document.createElement("div"),e.appendChild(t)):(t=document.createElement("div"),document.body.appendChild(t)),this.update(s))},this.hide=function(){dc(e||t)},this.unhide=function(){hc(e||t)},this.update=function(i){const n=this.showDismiss?`<div class="ext-popup-close-button-panel ui-close-hoverable">
           <div class="ext-popup-close-button"></div>
         </div>`:"",o=(()=>{switch(this.position){case $n.TOP:return"ui-top ui-center";case $n.DEFAULT:return"ui-upper-half-center";case $n.CENTER:return"ui-all-center";default:return console.log(`Invalid popup position: ${this.position}`),"ui-all-center"}})(),l=this.foremost?"ui-foremost":"";if(mr(t,`
       <div class="ext-popup ${o} ${l}">
         <div class="ext-popup-content">
           ${i}
         </div>${n}
       </div>`),Gl(t),this.showDismiss){const c=t.getElementsByClassName("ext-popup-close-button-panel")[0];qn(c,()=>this.dismiss())}},this.getElementsByClassName=function(i){return t.getElementsByClassName(i)},this.dismiss=function(){t!==null&&(this.close(),this.onDismiss&&this.onDismiss())},this.close=function(){t!==null&&(this.modal?(document.body.removeChild(e),e=null):document.body.removeChild(t),t=null,this.onClose&&this.onClose())}}$n.CENTER="center",$n.DEFAULT="default",$n.TOP="top";function zE(s,e){let t="";e&&(t=`<h3 class="ext-meeting-dialog-title">${e}</h3>`),t+=`
      <div class="ext-meeting-dialog-message">
        ${s}
      </div>
      <div class="ext-meeting-dialog-buttons">
        <button class="ext-meeting-button" data-strings="meetings.close">
        </button>
      </div>
    `;const i=new $n(t);i.showDismiss=!1,i.foremost=!0,i.modal=!0,i.open();const n=i.getElementsByClassName("ext-meeting-button")[0];n.onclick=()=>{i.close()}}function VE(s,e,t){const i=`
      <div class="ext-meeting-dialog-iframe-container">
        <h3 class="ext-meeting-dialog-title">${s}</h3>
        <iframe src="${e}" class="ext-meeting-dialog-iframe">
        </iframe>
        <div>
          <div class="ext-meeting-dialog-buttons">
            <button class="ext-meeting-button" data-strings="meetings.close">
            </button>
          </div>
        </div>
      <div>
    `,n=new $n(i);n.showDismiss=!1,n.position=$n.CENTER,n.onClose=t,n.open();const r=n.getElementsByClassName("ext-meeting-dialog-iframe")[0];r.style.visibility="hidden",r.onload=()=>{r.style.visibility="visible"};const o=n.getElementsByClassName("ext-meeting-button")[0];o.onclick=()=>n.close()}st={removeChildren:FE,addChangeHandler:OE,show:hc,hide:dc,setVisibility:BE,setButtonHighlight:NE,highlightInput:kE,highlightText:UE,UiPopup:$n,showMessage:zE,showIframePopup:VE};let Pa={},Bd=null;function Nd(){if(Bd===null){const s=window.AudioContext||window.webkitAudioContext;Bd=new s}return Bd}class rr{constructor(e,t,i){this._frequencyDiv=t,this._noSoundThreshold=i,this._minFrequencyIndex=-1,this._maxFrequencyIndex=-1,this._noSoundCalls=0,this._source=null,this._analyser=Nd().createAnalyser(),this._analyser.fftSize=this._frequencyDiv*2,this._analyser.smoothingTimeConstant=.5;const n=new MediaStream([e.mediaStreamTrack]);this._source=Nd().createMediaStreamSource(n),this._source.connect(this._analyser);const r=Nd().sampleRate/this._frequencyDiv;this._minFrequencyIndex=Math.floor(rr._minVoiceFrequency/r),this._maxFrequencyIndex=Math.floor(rr._maxVoiceFrequency/r),this._dataArray=new Uint8Array(this._maxFrequencyIndex+1)}measureSoundVolume(){const e=this._getOverallSoundVolume();return this._shouldSkipNoSoundNotification(e)?null:e}dispose(){this._source!==null&&(this._source.disconnect(),this._source=null)}_getOverallSoundVolume(){this._analyser.getByteFrequencyData(this._dataArray);let e=0;for(let t=this._minFrequencyIndex;t<=this._maxFrequencyIndex;t++)this._dataArray[t]>e&&(e=this._dataArray[t]);return e}_shouldSkipNoSoundNotification(e){return e<this._noSoundThreshold?(this._noSoundCalls++,this._noSoundCalls<rr._skippedNoSoundCalls):(this._noSoundCalls=0,!1)}}rr._minVoiceFrequency=85,rr._maxVoiceFrequency=350,rr._skippedNoSoundCalls=3;class Jn{constructor(e,t,i,n){this._width=e,this._height=t,this._bottomMargin=n!==void 0?n:0,this._volumeRect=null,this._rectId=Jn._baseRectId+Jn._counter,Jn._counter++,this._noSoundThreshold=i,this._lengthCoef=e/(255-this._noSoundThreshold)}getHTML(){return this._volumeRect=null,`
        <svg style="filter: drop-shadow(0px 0px 1px black);
                    margin-bottom: ${this._bottomMargin.toString()}px;"
             width="${this._width.toString()}px"
             height="${this._height.toString()}px">
          <rect id="${this._rectId}"
                x = "${(this._width/2-1).toString()}" y = "0"
                width="${1 .toString()}"
                height="${this._height.toString()}"
                fill="red"/>
        </svg>
      `}getEmptyHTML(){return`
        <svg width="${this._width.toString()}px"
             height="${this._height.toString()}px">
        </svg>
      `}update(e){if(this._volumeRect===null&&(this._volumeRect=document.getElementById(this._rectId)),console.assert(this._volumeRect!==null,"Volume visualizer HTML not attached to any element"),e===null)return;const t=this._getColor(e),i=Math.max(e,this._noSoundThreshold),n=Math.max(Jn._minimalDisplayedValue,i-this._noSoundThreshold),r=this._width/2-n*this._lengthCoef/2,o=n*this._lengthCoef;this._volumeRect.setAttribute("fill",t),this._volumeRect.setAttribute("x",r.toString()),this._volumeRect.setAttribute("width",o.toString())}_getColor(e){return e<this._noSoundThreshold?"red":e<Jn._lowSoundThreshold?"orange":"green"}}Jn._counter=0,Jn._baseRectId="ext-meeting-mic-bar-",Jn._lowSoundThreshold=180,Jn._minimalDisplayedValue=20,Pa={VolumeMeter:rr,VolumeVisualizer:Jn};let rg;const GE=2e3,og={MICROPHONE:"microphone",CAMERA:"camera"},Ca={name:"mic"},Ra={name:"camera",facingMode:"user",width:480,height:360,frameRate:24};function ag(s,e){return e===void 0?s.type:(s.type,e.type,"microphoneAndCamera")}function lg(s,e){const t=ag(s,e),i=s.error.name;return console.assert(e===void 0||e.error.name===i),Ct(i==="NotFoundError"?`meetings.devicesNotFound.${t}`:i==="NotAllowedError"?`meetings.devicesBlocked.${t}`:i==="Error"?"meetings.error":`meetings.devicesNotAvailable.${t}`)}function cg(s,e){const t=e!==void 0,i=t?"twoDevices":"oneDevice",n=s.error.name;if(n==="NotFoundError"){const r=ag(s,e);return Ct(`meetings.checkIfDevicesConnected.${r}`)}else if(n==="NotAllowedError")if(it.mobile)if(it.ios){const r=t?`${s.unblockIcon} ${Ct("meetings.and")} ${e.unblockIcon}`:s.unblockIcon;return`<span>
          ${Ct(`meetings.unblockDevices.byButtons.${i}.beforeIcons`)}
          ${r}
          ${Ct(`meetings.unblockDevices.byButtons.${i}.afterIcons`)}
        </span>`}else return Ct(`meetings.unblockDevices.inBrowserSettings.${i}`);else{const r=t?e.unblockIcon:s.unblockIcon;return`<span>
        ${Ct(`meetings.unblockDevices.byButtonInAddressBar.${i}.beforeIcon`)}
        ${r}
        ${Ct(`meetings.unblockDevices.byButtonInAddressBar.${i}.afterIcon`)}
      </span>`}else return Ct(n==="Error"?"meetings.browserDoesNotSupportMeetings":`meetings.ifConnectedCloseAppsAndRefresh.${i}`)}class HE{constructor(e,t,i,n){this._firstErrorDiv=document.getElementById(e),this._secondErrorDiv=document.getElementById(t),this._devicePreview1=i,this._devicePreview2=n}_reset(){this._devicePreview1.setErrorDiv(null),this._devicePreview2.setErrorDiv(null),st.removeChildren(this._firstErrorDiv),st.removeChildren(this._secondErrorDiv)}_displayAndLogErrorMessage(e,t,i){function n(c){if(c!==void 0)return c.device}const r=lg(t.device,n(i)),o=cg(t.device,n(i)),l=`
        <div class="ext-meeting-join-error-title">${r}</div>
        <div class="ext-meeting-join-error-description">${o}</div>
      `;mr(e,l),t.setErrorDiv(e),t.device.logError(),i!==void 0&&(i.setErrorDiv(e),i.device.logError())}update(){this._reset();const e=this._devicePreview1.device.error,t=this._devicePreview2.device.error;e===null&&t===null||(e!==null&&t!==null?e.name===t.name?this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1,this._devicePreview2):(this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1),this._displayAndLogErrorMessage(this._secondErrorDiv,this._devicePreview2)):e!==null?this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview1):this._displayAndLogErrorMessage(this._firstErrorDiv,this._devicePreview2))}}class WE{constructor(e,t){this._type=e,this._active=!1,this._unblockIcon=t,this._trackOptions=null,this._track=null,this._error=null}get type(){return this._type}get track(){return this._track}set track(e){this._track=e}get active(){return this._active}set active(e){this._active=e}get unblockIcon(){return this._unblockIcon}logError(){this._error!==null&&Le.log(`Can't create local ${this.type} track : ${this._error.name}, ${this._error.message}`)}get error(){return this._error}set error(e){this._error=e}get trackOptions(){return this._trackOptions}set trackOptions(e){this._trackOptions=e}_getLabel(){return this._track?this._track.mediaStreamTrack.label:null}getId(){return this._trackOptions&&this._trackOptions.deviceId?this._trackOptions.deviceId.exact:null}getErrorMessageInfo(){if(this._error===null)return null;const e=lg(this),t=cg(this);return{title:e,description:t}}}class hg{constructor(e,t,i,n,r,o,l){this._device=new WE(e,l),this._width=i,this._height=n,this._toggleButton=document.getElementById(r),this._previewContainer=document.getElementById(o),this._errorDiv=null,this._meetingStarter=t,Ii(this._toggleButton.id,this._onToggleButtonClicked.bind(this)),this._onStoppedBound=this._onStopped.bind(this),this._twilioCreateTrackFunction=null}get device(){return this._device}isAvailable(){return this._device.track!==null}dispose(){this._device.track!==null&&this._device.track.removeListener("stopped",this._onStoppedBound),this._close()}_pauseMonitoringTrackBeforeReset(){this._device.track.removeListener("stopped",this._onStoppedBound)}_resumeMonitoringTrackAfterReset(){this._device.track.addListener("stopped",this._onStoppedBound)}setErrorDiv(e){this._errorDiv=e}showInTestNeededMode(){this.setError({name:"Test needed"})}showInPreviewMode(){this.setError({name:"Initializing"}),this.setToggleButtonVisibility(!0)}createTrack(e){return new Promise((t,i)=>{const n=e||this._device.trackOptions;this._twilioCreateTrackFunction(Mn(n)).then(r=>{this.setTrack(r,n)}).catch(r=>{this.setTrack(null,n,r)}).finally(()=>{this._toggleButton.disabled=!1,t()})})}updateTrackDeviceId(e){const t=(i,n)=>{const r=i.find(o=>o.label===n);return r?r.deviceId:null};if(this._device.track&&!this._device.trackOptions.deviceId){const i=this._device._getLabel(),n=t(e,i);console.assert(n!==null,"deviceId not found"),this._device.trackOptions={name:this._device.trackOptions.name,deviceId:{exact:n}}}}setTrack(e,t,i){t&&(this._device.trackOptions=t),e!==null&&i!==void 0?console.assert("Invalid setTrack parameters : track and error set"):e===null&&i===void 0&&console.assert("Invalid setTrack parameters : track and error not set"),this._disposeTrack(),this._device.track=e,this._device.track!==null?(this._device.track.on("stopped",this._onStoppedBound),this._device.active=!0,this._showTrack(),this.setError(null)):(this._device.active=!1,this._hideTrack(),this.setError(i)),this._meetingStarter.updateErrorMessage(),this._updateToggleButtonState()}setError(e){this._device.error=e}restartTrack(e){this._toggleButton.disabled=!0,this.isAvailable()?(this._pauseMonitoringTrackBeforeReset(),this._device.trackOptions=e,this._device.track.restart(Mn(e)).then(()=>{this._resumeMonitoringTrackAfterReset(),this._meetingStarter.updateErrorMessage(),this._toggleButton.disabled=!1}).catch(t=>{Le.log(`Second attempt to create track,device: ${this._device.type}`),window.setTimeout(()=>this.createTrack(e),1e3)})):this.createTrack(e)}setToggleButtonVisibility(e){st.setVisibility(this._toggleButton,e)}_updateToggleButtonState(){this._device.active?(st.setButtonHighlight(this._toggleButton,!1),st.setVisibility(this._toggleButton.children[0],!0),st.setVisibility(this._toggleButton.children[1],!1)):(st.setButtonHighlight(this._toggleButton,!0),st.setVisibility(this._toggleButton.children[0],!1),st.setVisibility(this._toggleButton.children[1],!0))}_disposeTrack(){if(this._device.track!==null){const e=this._device.track;e.removeListener("stopped",this._onStoppedBound),e.detach(),e.stop()}this._device.track=null}_onStopped(){this._device.track!==null&&this.setTrack(null,null,{name:"NotReadableError",message:"Stopped"})}_close(){st.removeChildren(this._previewContainer)}_setPreviewInnerHTML(e){this._close(),this._previewContainer.innerHTML=e,st.show(this._previewContainer)}_setPreviewElement(e){this._close(),e!==null&&(e.style.width=this._width.toString()+"px",e.style.height=this._height.toString()+"px",this._previewContainer.appendChild(e),st.show(this._previewContainer))}_showTrack(){this._device.active=!0,this._device.track.enable()}_hideTrack(){this._device.active=!1}_onToggleButtonClicked(){if(!this.isAvailable()){this.createTrack().then(()=>{this._device.error&&st.highlightText(this._errorDiv)});return}this._device.active?this._onSwitchOff():this._onSwitchOn(),this._updateToggleButtonState()}_onSwitchOff(){this._hideTrack(),this._device.track.disable()}_onSwitchOn(){this._showTrack(),this._device.track.enable()}}class jE extends hg{constructor(e,t,i,n,r){super(og.CAMERA,e,t,i,n,r,'<span class="fa-video-slash"></span>'),this._twilioCreateTrackFunction=Twilio.Video.createLocalVideoTrack,this._device.trackOptions=Ra}showInTestNeededMode(){super.showInTestNeededMode(),this._showPlaceholder()}showInPreviewMode(){super.showInPreviewMode(),this._showPlaceholder()}_showPlaceholder(){const e=`
        <div class="ext-meeting-join-camera-preview-placeholder">
          <span class="fa-video absolute-center"></span>
        </div>
      `;this._setPreviewInnerHTML(e)}_hideTrack(){super._hideTrack(),this._showPlaceholder()}_showTrack(){super._showTrack(),this._setPreviewElement(this._device.track.attach())}_onSwitchOff(){super._onSwitchOff(),this.setTrack(null,null,null)}}class XE extends hg{constructor(e,t,i,n,r){super(og.MICROPHONE,e,t,i,n,r,'<span class="fa-microphone-slash"></span>'),this._noSoundThreshold=80,this._volumeVisualizer=new Pa.VolumeVisualizer(t,i,this._noSoundThreshold),this._volumeMeter=null,this._measurementIntervalId=null,this._twilioCreateTrackFunction=Twilio.Video.createLocalAudioTrack,this._device.trackOptions=Ca}showInTestNeededMode(){super.showInTestNeededMode(),this._setPreviewElement(null)}showInPreviewMode(){super.showInPreviewMode(),this._setPreviewElement(null)}dispose(){this._isMeasurementActive()&&this._stopMeasurement(),super.dispose()}_measure(){this._volumeVisualizer.update(this._volumeMeter.measureSoundVolume())}_hideTrack(){super._hideTrack(),this._isMeasurementActive()&&this._stopMeasurement(),this._setPreviewElement(null)}_showTrack(){super._showTrack(),this._setPreviewInnerHTML(this._volumeVisualizer.getHTML()),this._startMeasurement()}_startMeasurement(){this._volumeMeter=new Pa.VolumeMeter(this._device.track,512,this._noSoundThreshold),this._measurementIntervalId=setInterval(()=>this._measure())}_stopMeasurement(){clearInterval(this._measurementIntervalId),this._measurementIntervalId=null,this._volumeMeter.dispose(),this._volumeMeter=null}_isMeasurementActive(){return this._measurementIntervalId!==null}_pauseMonitoringTrackBeforeReset(){super._pauseMonitoringTrackBeforeReset(),this._isMeasurementActive()&&this._stopMeasurement()}_resumeMonitoringTrackAfterReset(){super._resumeMonitoringTrackAfterReset(),this._startMeasurement()}_disposeTrack(){this._isMeasurementActive()&&this._stopMeasurement(),super._disposeTrack()}}rg=class{constructor(s,e){this._onJoinCallback=s,this._joinMode=!1,this._dialog=null,this._preflightTestDone=!1,this._mediaInitialized=!1,this._cameraPreview=null,this._micVolumePreview=null,this._cameraPreviewHeight=198,this._cameraPreviewWidth=264,this._micVolumePreviewHeight=4,this._micVolumePreviewWidth=40,this._onDevicesChangedBound=this._onDevicesChanged.bind(this),this._errorMessageActive=!0,this._runPrefilghtTest(e)}show(){this._blurHelp(),this._createDialog(),this._cameraPreview=new jE(this,this._cameraPreviewWidth,this._cameraPreviewHeight,"ext-meeting-join-camera-toggle","ext-meeting-join-camera-preview-container"),this._micVolumePreview=new XE(this,this._micVolumePreviewWidth,this._micVolumePreviewHeight,"ext-meeting-join-mic-toggle","ext-meeting-join-mic-volume-container"),this._errorMessageGenerator=new HE("ext-meeting-join-first-error","ext-meeting-join-second-error",this._micVolumePreview,this._cameraPreview),this._setupDevicesSelection(),this._checkPermissions().then(()=>{this._runPreviewMode(!1),this._createMediaTracksSeparately(Ra,Ca,()=>this._onMediaInitialized())}).catch(s=>{s!==void 0&&Le.log("Error checking audio/video devices permissions: "+s.name+": "+s.message),this._runTestNeededMode()})}_checkPermissions(){return new Promise((s,e)=>navigator.mediaDevices.enumerateDevices().then(function(t){const i=t.filter(function(r){return r.kind==="audioinput"&&r.deviceId!==""&&r.label!==""}),n=t.filter(function(r){return r.kind==="videoinput"&&r.deviceId!==""&&r.label!==""});i.length>0||n.length>0?s():e()}).catch(function(t){e(t)}))}_setupDevicesSelection(){const s=t=>{this._cameraPreview.restartTrack({name:"camera",deviceId:{exact:t.currentTarget.value}})};st.addChangeHandler("ext-meeting-join-select-camera",s);const e=t=>{this._micVolumePreview.restartTrack({name:"mic",deviceId:{exact:t.currentTarget.value}})};st.addChangeHandler("ext-meeting-join-select-microphone",e),navigator.mediaDevices.addEventListener("devicechange",this._onDevicesChangedBound)}_onDevicesChanged(){if(!this._joinMode)return;const s=this._cameraPreview.device.error,e=this._micVolumePreview.device.error;s||e?this._createMediaTracksSeparately(s?Ra:null,e?Ca:null):this._fillDevicesSelectControls()}_fillDevicesSelectControls(){navigator.mediaDevices.enumerateDevices().then(s=>{this._cameraPreview.updateTrackDeviceId(s),this._micVolumePreview.updateTrackDeviceId(s);const e=s.filter(function(i){return i.kind==="audioinput"});this._fillDevicesSelectControl(e,"ext-meeting-join-select-microphone-container","ext-meeting-join-select-microphone",this._micVolumePreview.device.getId());const t=s.filter(function(i){return i.kind==="videoinput"});this._fillDevicesSelectControl(t,"ext-meeting-join-select-camera-container","ext-meeting-join-select-camera",this._cameraPreview.device.getId())})}_fillDevicesSelectControl(s,e,t,i){const n=document.getElementById(e),r=document.getElementById(t);st.setVisibility(n,s.length>1),st.removeChildren(r),s.length>1&&(s.forEach(o=>{const l=document.createElement("option");l.value=`${o.deviceId}`,Zr(l,`${o.label}`),r.appendChild(l)}),r.value=i)}_createDialog(){this._dialog=new st.UiPopup(`
        <h3 class="ext-meeting-dialog-title" data-strings="meetings.join3dMeeting"></h3>
        <div class="ext-meeting-join-row">
          <div id="ext-meeting-join-name-label">
            ${Ct("meetings.name")}:
          </div>
          <input type="text" id="ext-meeting-join-name"
                 class="ext-meeting-join-input"
                 autocomplete="off">
          </input>
        </div>
        <div class="ext-meeting-join-row">
          <div class="ext-meeting-join-main-container">
            <div id="ext-meeting-join-error-container"
                 class="absolute-vertical-center">
              <div id="ext-meeting-join-first-error"></div>
              <div id="ext-meeting-join-second-error"></div>
            </div>
            <div id="ext-meeting-join-camera-preview-container"></div>
            <div id="ext-meeting-join-mic-volume-container"></div>
            <div id="ext-meeting-join-preview-toggle-container"
                 class="absolute-horizontal-center">
              <button id="ext-meeting-join-mic-toggle" style="display: none"
                      class="ext-meeting-button ext-meeting-button-highlight
                            ext-meeting-join-device-button">
                <span class="fa-microphone" style="display: none"></span>
                <span class="fa-microphone-slash"></span>
              </button>
              <button id="ext-meeting-join-camera-toggle" style="display: none"
                      class="ext-meeting-button ext-meeting-button-highlight
                            ext-meeting-join-device-button">
                <span class="fa-video" style="display: none"></span>
                <span class="fa-video-slash"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="ext-meeting-join-row">
          <div id="ext-meeting-join-select-camera-container"
               style="display: none">
            ${Ct("meetings.camera")}:
            <select id="ext-meeting-join-select-camera"
                    class="ext-meeting-join-input">
            </select>
          </div>
          <div id="ext-meeting-join-select-microphone-container"
               style="display: none">
            ${Ct("meetings.microphone")}:
            <select id="ext-meeting-join-select-microphone"
                    class="ext-meeting-join-input">
            </select>
          </div>
        </div>
        <div id="ext-meeting-join-network-error-container" style="display: none">
          <div data-strings="meetings.networkIssuesDetected"></div>
          <div>
            <a href="https://networktest.twilio.com/" style="color: white" target="_blank"
               data-strings="meetings.diagnoseConnection">
            </a>
          </div>
        </div>
        <div id="ext-meeting-join-button-container"
             class="ext-meeting-join-row">
          <button id="ext-meeting-join-button"
                  class="ext-meeting-button ext-meeting-dialog-buttons"
                  data-strings="meetings.join">
          </button>
        </div>
        <div class="ext-meeting-join-footer">
          <span data-strings="meetings.byJoiningYouAgreeTo"></span>
          <span id="terms-of-service-link" class="ext-meeting-terms-link">
            <u data-strings="meetings.termsOfService"></u>
          </span>
          ${Ct("meetings.and")}
          <span id="privacy-policy-link" class="ext-meeting-terms-link">
            <u data-strings="meetings.privacyPolicy"></u><!-- no whitespace before dot --></span>.
        </div>
      `),this._dialog.showDismiss=!1,this._dialog.foremost=!0,this._dialog.open();const s=document.getElementById("terms-of-service-link");s.onclick=()=>{const t="https://www.shapespark.com/terms#in-viewer";this._dialog.hide(),st.showIframePopup(Ct("meetings.infrastructureProvidedUnderTos"),t,()=>this._dialog.unhide())};const e=document.getElementById("privacy-policy-link");e.onclick=()=>{const t="https://www.shapespark.com/privacy#in-viewer";this._dialog.hide(),st.showIframePopup(Ct("meetings.infrastructureProvidedUnderPp"),t,()=>this._dialog.unhide())},this._initializeDisplayName()}_createMediaTracksSeparately(s,e,t){const i=()=>{this._fillDevicesSelectControls(),this._errorMessageActive=!0,this.updateErrorMessage(),t&&t()};this._errorMessageActive=!1,s&&e?this._cameraPreview.createTrack(s).then(()=>this._micVolumePreview.createTrack(e)).then(()=>{i()}):s?this._cameraPreview.createTrack(s).then(()=>{i()}):this._micVolumePreview.createTrack(e).then(()=>{i()})}_runTestNeededMode(){this._setTestNeededMode(),this._cameraPreview.showInTestNeededMode(),this._micVolumePreview.showInTestNeededMode()}_runPreviewMode(s){this._setPreviewMode(s),s?(this._cameraPreview.setToggleButtonVisibility(!0),this._micVolumePreview.setToggleButtonVisibility(!0)):(this._cameraPreview.showInPreviewMode(),this._micVolumePreview.showInPreviewMode())}_onCreateMediaTracks(s,e,t){const i=s.filter(r=>r.kind==="audio"),n=s.filter(r=>r.kind==="video");this._errorMessageActive=!1,i.length>0?this._micVolumePreview.setTrack(i[0],e):this._micVolumePreview.setTrack(null,e,{name:"Unknown error",message:""}),n.length>0?this._cameraPreview.setTrack(n[0],t):this._cameraPreview.setTrack(null,t,{name:"Unknown error",message:""}),this._errorMessageActive=!0,this.updateErrorMessage(),this._fillDevicesSelectControls(),this._runPreviewMode(!0)}_testCamera(){const s={audio:Mn(Ca),video:Mn(Ra)};Twilio.Video.createLocalTracks(s).then(e=>{this._onCreateMediaTracks(e)}).catch(e=>{this._createMediaTracksSeparately(Ra,Ca,()=>this._runPreviewMode(!0))})}_setTestNeededMode(){this._joinMode=!1;const s=`
        <button class="ext-meeting-button ext-meeting-dialog-buttons"
                id="ext-meeting-test-button" data-strings="meetings.testCamera">
        </button>
      `,e=document.getElementById("ext-meeting-join-button-container");st.removeChildren(e),mr(e,s),Ii("ext-meeting-test-button",()=>this._testCamera())}_setPreviewMode(s){if(this._joinMode)return;this._joinMode=!0;const e=`
        <button class="ext-meeting-button ext-meeting-dialog-buttons"
                id="ext-meeting-join-button" data-strings="meetings.join">
        </button>
      `,t=document.getElementById("ext-meeting-join-button-container");st.removeChildren(t),mr(t,e),this._mediaInitialized=!0,this._updateJoinButtonState(),Ii("ext-meeting-join-button",()=>this._joinMeeting()),s||this._setMediaInitialized(!1)}_onMediaInitialized(){this._setMediaInitialized(!0)}_updateJoinButtonState(){const s=document.getElementById("ext-meeting-join-button");s&&(s.disabled=!(this._preflightTestDone&&this._mediaInitialized))}_setMediaInitialized(s){this._mediaInitialized=s,this._updateJoinButtonState()}_setPreflightTestDone(){this._preflightTestDone=!0,this._updateJoinButtonState()}_initializeDisplayName(){const s=document.getElementById("ext-meeting-join-name");let e=localStorage.getItem("extMtgDisplayName");e&&(s.value=e),s.focus(),s.select()}_checkDisplayName(){const s=document.getElementById("ext-meeting-join-name"),e=s.value.trim();if(!e){st.highlightInput(s);return}return e}_blurHelp(){document.getElementById("help-and-primary-progress").classList.add("ui-blur")}_unblurHelp(){const s=document.getElementById("help-and-primary-progress");s.classList.remove("ui-blur"),s.classList.add("ui-unblur")}_runPrefilghtTest(s){const e=new Promise((i,n)=>{const r="https://pubsub.pubnub.com/time/0",l=new Date().getTime()/1e3;qs(r,null,null,c=>{const d=c[0]/1e7,u=Math.abs(d-l);console.warn("PubNub test completed, response time:",u.toFixed(4)+"s"),i()},(c,d)=>{console.error("PubNub test error:",c,d),n(new Error("PubNub test failed"))})}),t=new Promise((i,n)=>{const r=Twilio.Video.runPreflight(s,{duration:GE});r.on("failed",(o,l)=>{console.error("Twilio test error:",o),n(new Error("Twilio test failed"))}),r.on("completed",()=>{i()})});Promise.all([e,t]).then(()=>{this._setPreflightTestDone()}).catch(i=>{console.error(i);const n=document.getElementById("ext-meeting-join-network-error-container");st.show(n),this._setPreflightTestDone()})}_joinMeeting(){const s=this._checkDisplayName();if(s===void 0)return;localStorage.setItem("extMtgDisplayName",s);const e=this._micVolumePreview.device,t=this._cameraPreview.device;this._dispose(),this._onJoinCallback(s,e,t)}updateErrorMessage(){this._errorMessageActive&&this._errorMessageGenerator.update()}_dispose(){this._dialog.close(),this._unblurHelp(),navigator.mediaDevices.removeEventListener("devicechange",this._onDevicesChangedBound),this._cameraPreview.dispose(),this._micVolumePreview.dispose(),this._dialog=null,this._cameraPreview=null,this._micVolumePreview=null}};const kd=13,uc=15,fc=3,Ud=2,pc=9,qE=2;class YE{constructor(){this._room=null,this._bars=[],this._crossLines=[],this._crossIsVisible=!1,this._updateBind=this._update.bind(this),this._qualityToBarIndex=[-1,0,0,1,2,2],this._create()}_create(){const e=document.getElementById("ext-meeting-quality-indicator-container");console.assert(e!==null,"Quality indicator container not found");const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width",kd),t.setAttribute("height",uc),e.appendChild(t);const i=Math.floor((kd+Ud)/fc)-Ud,n=i+Ud,r=Math.floor(uc/fc);for(let u=0;u<fc;u++){const h=u*n,f=(u+1)*r,p=uc-f;this._addBar(t,h,p,i,f)}const o=(kd-pc)/2,l=(uc-pc)/2,c=o+pc,d=l+pc;this._addCrossLine(t,o,l,c,d),this._addCrossLine(t,o,d,c,l)}_addBar(e,t,i,n,r){const o=document.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("x",t),o.setAttribute("y",i),o.setAttribute("width",n),o.setAttribute("height",r),o.setAttribute("display","none"),e.appendChild(o),this._bars.push(o)}_addCrossLine(e,t,i,n,r){const o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("x1",t),o.setAttribute("y1",i),o.setAttribute("x2",n),o.setAttribute("y2",r),o.setAttribute("stroke","red"),o.setAttribute("stroke-width",qE),o.setAttribute("display","none"),e.appendChild(o),this._crossLines.push(o)}_hideBars(){this._bars.forEach(e=>{e.setAttribute("display","none")})}_hideCross(){this._crossIsVisible&&(this._crossLines.forEach(e=>{e.setAttribute("display","none")}),this._crossIsVisible=!1)}_showBars(){this._bars.forEach(e=>{e.setAttribute("display","block")})}_showCross(){this._crossIsVisible||(this._crossLines.forEach(e=>{e.setAttribute("display","block")}),this._crossIsVisible=!0)}onConnect(e){console.assert(this._room===null),this._room=e,this._showBars(),this._update(this._room.localParticipant.networkQualityLevel),e.localParticipant.on("networkQualityLevelChanged",this._updateBind)}onDisconnect(){console.assert(this._room),this._room.localParticipant.removeListener("networkQualityLevelChanged",this._updateBind),this._room=null,this._hideBars(),this._hideCross()}_getColor(e,t){return e<=this._qualityToBarIndex[t]?"white":"dimgray"}_update(e){if(e!==null){for(let t=0;t<fc;t++){const i=this._getColor(t,e);this._bars[t].setAttribute("fill",i),this._bars[t].setAttribute("stroke",i)}e===0?this._showCross():this._hideCross()}}}function QE(){D.FONT_FAMILIES_TO_LOAD.push("FontAwesomeSolid"),D.FONT_FAMILIES_TO_LOAD.push("FontAwesomeRegular");const s=.1,e="#0775e8",t=new Re(0,1,0),i=document.getElementById("walk-canvas"),n=D.urlHashGetArgument("av-region");function r(){return D.DEVEL_MEETING_SCENE_URL||window.location.href}function o(){const k=window.location.hostname;return k.endsWith(".shapespark.com")?"https://cloud"+k.substr(k.indexOf(".")):k.endsWith(".shapespark.com.cn")?"https://cloud.shapespark.com.cn":D.DEVEL_MEETING_CLOUD_URL||"https://cloud.shapespark.com"}function l(k){const Q=new Date(k),le=new Date;return le.getDate()===Q.getDate()&&le.getMonth()===Q.getMonth()&&le.getFullYear()===Q.getFullYear()?Q.toLocaleTimeString():Q.toLocaleDateString()+" "+Q.toLocaleTimeString()}function c(k,Q,le,ae){const Ee=document.createElement("li");Ee.classList.add("ext-meeting-list-entry");const te=Ee.appendChild(document.createElement("span"));if(te.classList.add("ext-meeting-list-name"),te.innerText=k,te.style.color=le,ae&&(qn(Ee,ae),Ee.style.cursor="pointer"),Q){Ee.appendChild(document.createElement("br"));const me=Ee.appendChild(document.createElement("small"));me.innerText=Q,me.style.color="white"}return Ee}function d(k,Q,le){return{color:e,icon:"edit",opacity:1,position:[k,Q,le],radius:.07,type:"sphere"}}function u(k,Q,le,ae=!1){const Ee=Q&&le?`<button class="ext-meeting-dialog-ok ext-meeting-button">
            ${Q}
          </button>`:"",me=`<div>
        <h3>${k}</h3>
      </div>
      <div class ="ext-meeting-dialog-buttons">
        ${Ee}
        ${ae?`<button class="ext-meeting-dialog-cancel ext-meeting-button" data-strings="meetings.cancel">
        </button>`:""}
      </div>`,Fe=new st.UiPopup(me);if(Fe.showDismiss=!1,Fe.open(),ae){const we=Fe.getElementsByClassName("ext-meeting-dialog-cancel")[0];we.onclick=()=>Fe.dismiss()}if(Q&&le){const we=Fe.getElementsByClassName("ext-meeting-dialog-ok")[0];we.onclick=()=>{Fe.close(),le()}}}function h(k,Q){const le=Q.attach(),ae=k.createTextureFromHtmlVideo(le);return ae.play(),ae}function f(k){k.detach().forEach(Q=>Q.remove())}function p(k){return k&&k.isStarted&&k.isEnabled&&!k.isStopped}function m(k,Q,le){this._viewer=k,this._uuid=Q;const ae=parseInt(Q.substring(2));this._color=D.AVATAR_COLORS[ae%D.AVATAR_COLORS.length],this._displayName=null,this._avatar=null,this._twilioParticipant=null,this._lastRenderedPosition=[],this._lastRenderedPositionLength=0,this._dataTrack=null,this._micTrack=null,this._cameraTrack=null,this._screenTrack=null,this._audioTrack=null,this._noSoundThreshold=80,this._soundVolumeUpdatesScheduler=le,this._volumeVisualizer=new Pa.VolumeVisualizer(20,3,this._noSoundThreshold,3),this._volumeMeter=null}m.prototype={constructor:m,_setUpAvatar:function(){console.assert(this._displayName,"Display name must be known to set up the avatar"),Le.log("Setting up avatar for %s:%s",this._uuid,this._displayName),this._avatar=this._viewer.addAvatar(this._uuid,{displayName:this._displayName,color:this._color})},get uuid(){return this._uuid},get color(){return this._color},get displayName(){return this._displayName},get hasDisplayName(){return this._displayName!==null},_positionChanged:function(k){if(this._lastRenderedPositionLength!==k.length)return!0;const Q=1e-5;for(let le=0;le<k.length;le++)if(Math.abs(this._lastRenderedPosition[le]-k[le])>Q)return!0;return!1},_setLastRenderedPosition:function(k){this._lastRenderedPositionLength=k.length;for(let Q=0;Q<k.length;Q++)this._lastRenderedPosition[Q]=k[Q]},get volumeVisualizer(){return this._volumeVisualizer},updatePosition:function(k){if(!this.hasDisplayName||!this._positionChanged(k))return;this._setLastRenderedPosition(k);const Q=this._avatar;Q.setPositionFromArray(k),Q.rotate(k[3],k[4]),k.length>=6?Q.placePointer(k[5],k[6],k[7]):Q.hidePointer(),Q.visible&&(Q.updateMatrixWorld(!0),this._viewer.requestFrame())},updateSoundVolumeVisualization(){console.assert(this._volumeMeter!==null,"this._voulmeMeter not created");const k=this._volumeMeter.measureSoundVolume();this._onSoundVolumeUpdated(k)},_onSoundVolumeUpdated(k){this._volumeVisualizer.update(k)},dispose:function(){this.isSoundMeasurementActive()&&this._stopSoundMeasurement(),this._avatar&&(this._viewer.removeAvatar(this._avatar),this._avatar=null,this._viewer.requestFrame())},_updateSoundMeasurementState:function(){this._micTrack!==null&&this._micTrack.isEnabled?this._startSoundMeasurement():this._stopSoundMeasurement()},isSoundMeasurementActive:function(){return this._volumeMeter!==null},_startSoundMeasurement:function(){this.isSoundMeasurementActive()||(this._volumeMeter=new Pa.VolumeMeter(this._micTrack,512,this._noSoundThreshold),this._soundVolumeUpdatesScheduler.registerUser(this))},_stopSoundMeasurement:function(){this.isSoundMeasurementActive()&&(this._soundVolumeUpdatesScheduler.unregisterUser(this),this._volumeMeter.dispose(),this._volumeMeter=null,this._avatar.onSoundSwitchedOff())}},Object.defineProperty(m.prototype,"micTrack",{get:function(){return this._micTrack}}),Object.defineProperty(m.prototype,"cameraTrack",{get:function(){return this._cameraTrack}}),Object.defineProperty(m.prototype,"audioTrack",{get:function(){return this._audioTrack}});function b(k,Q,le,ae,Ee,te){m.call(this,k,Q,ae,!0),this._displayName=le,this._setUpAvatar(),this._avatar.hideBody(),this._isPublishingTracksDuringConnecting=!1,this._dataTrack=new Twilio.Video.LocalDataTrack({name:"data",maxPacketLifeTime:1e3}),this._isCreatingMicTrack=!1,this._isCreatingCameraTrack=!1,this._micDevice=Ee,this._cameraDevice=te,this._micTrack=this._micDevice.track,this._micTrack!==null&&this._subscribeToMicEvents(),this._updateSoundMeasurementState(),this._cameraTrack=this._cameraDevice.track,this._cameraTrack!==null&&(console.assert(this._cameraDevice.active,"Got inactive camera track from MeetingStarter"),this._subscribeToCameraEvents()),this._lastPosition=null,this._positionMessage=[Q,le,null],this._resendInterval=null,this._onMicTrackStateChanged=null,this._onCameraTrackStateChanged=null}b.prototype=Object.create(m.prototype),b.prototype.constructor=b,Object.defineProperty(b.prototype,"dataTrack",{get:function(){return this._dataTrack}}),Object.defineProperty(b.prototype,"screenTrack",{get:function(){return this._screenTrack}}),b.prototype.getAllTracks=function(){const k=[this._dataTrack];return this._micTrack&&k.push(this._micTrack),this._cameraTrack&&k.push(this._cameraTrack),this._screenTrack&&k.push(this._screenTrack),this._audioTrack&&k.push(this._audioTrack),k},b.prototype._sendPosition=function(k){this._positionMessage[2]=k,this._dataTrack.send(JSON.stringify(this._positionMessage))},b.prototype._resendLastPosition=function(){this._lastPosition!==null&&this._sendPosition(this._lastPosition)},b.prototype.startedConnectingToTwilio=function(){this._isPublishingTracksDuringConnecting=!0},b.prototype.failedToConnectToTwilio=function(){this._isPublishingTracksDuringConnecting=!1},b.prototype.connectedToTwilio=function(k){this._twilioParticipant=k,k.publishTracks(this.getAllTracks()).finally(()=>{this._isPublishingTracksDuringConnecting=!1}),this._resendLastPosition();const Q=1e3;this._resendInterval=setInterval(()=>this._resendLastPosition(),Q)},b.prototype.disconnectedFromTwilio=function(){this._twilioParticipant=null,clearInterval(this._resendInterval),this._resendInterval=null},Object.defineProperty(b.prototype,"isConnectedToTwilio",{get:function(){return this._twilioParticipant!==null}}),b.prototype.updatePosition=function(k){m.prototype.updatePosition.call(this,k),this._lastPosition=k,this.isConnectedToTwilio&&this._sendPosition(k)},b.prototype.setAvTracksStateHandlers=function(k,Q){this._onMicTrackStateChanged=k,this._onCameraTrackStateChanged=Q},b.prototype._removeStoppedMicTrack=function(){console.assert(this._micTrack&&this._micTrack.isStopped),Le.log("Removing stopped local mic track"),this._twilioParticipant&&(Le.log("Unpublishing stopped local mic track"),this._twilioParticipant.unpublishTrack(this._micTrack)),this._micTrack=null},b.prototype._subscribeToMicEvents=function(){const k=()=>{this._updateSoundMeasurementState(),this._onMicTrackStateChanged&&this._onMicTrackStateChanged(this._micTrack)},Q=()=>{k(),this._removeStoppedMicTrack()};this._micTrack.on("started",k),this._micTrack.on("enabled",k),this._micTrack.on("disabled",k),this._micTrack.on("stopped",Q)},b.prototype._createMicTrack=function(){if(Le.log("Creating local mic track"),this._isCreatingMicTrack){Le.log("Local mic track is already being created");return}this._isCreatingMicTrack=!0;let k=null;Twilio.Video.createLocalAudioTrack(this._micDevice.trackOptions).then(Q=>{if(k=Q,this.isConnectedToTwilio)return Le.log("Publishing local mic track"),this._twilioParticipant.publishTrack(k)}).then(Q=>{Q?Le.log("Local mic track created and published"):Le.log("Local mic track created but not yet published"),this._micTrack=k,this._subscribeToMicEvents(),this._onMicTrackStateChanged&&this._onMicTrackStateChanged(this._micTrack),this._isCreatingMicTrack=!1}).catch(Q=>{k&&k.stop(),this._micDevice.error=Q,this._showCreateTrackError(this._micDevice),this._isCreatingMicTrack=!1})},b.prototype.toggleMic=function(){this._micTrack?this._micTrack.isEnabled?(Le.log("Disabling local mic track"),this._micTrack.disable()):(Le.log("Enabling local mic track"),this._micTrack.enable()):this._createMicTrack()},b.prototype._removeStoppedCameraTrack=function(){console.assert(this._cameraTrack&&this._cameraTrack.isStopped),Le.log("Removing stopped local camera track"),this._twilioParticipant&&(Le.log("Unpublishing stopped local camera track"),this._twilioParticipant.unpublishTrack(this._cameraTrack)),this._cameraTrack=null},b.prototype._subscribeToCameraEvents=function(){const k=()=>{this._onCameraTrackStateChanged&&this._onCameraTrackStateChanged(this._cameraTrack)},Q=()=>{k(),this._removeStoppedCameraTrack()};this._cameraTrack.on("started",k),this._cameraTrack.on("enabled",k),this._cameraTrack.on("disabled",k),this._cameraTrack.on("stopped",Q)},b.prototype._createCameraTrack=function(){if(Le.log("Creating local camera track"),this._isCreatingCameraTrack){Le.log("Local camera track is already being created");return}this._isCreatingCameraTrack=!0;let k=null;Twilio.Video.createLocalVideoTrack(this._cameraDevice.trackOptions).then(Q=>{if(k=Q,this.isConnectedToTwilio)return Le.log("Publishing local camera track"),this._twilioParticipant.publishTrack(k)}).then(Q=>{Q?Le.log("Local camera track created and published"):Le.log("Local camera track created but not yet published"),this._cameraTrack=k,this._subscribeToCameraEvents(),this._onCameraTrackStateChanged&&this._onCameraTrackStateChanged(this._cameraTrack),this._isCreatingCameraTrack=!1}).catch(Q=>{k&&k.stop(),this._cameraDevice.error=Q,this._showCreateTrackError(this._cameraDevice),this._isCreatingCameraTrack=!1})},b.prototype._showCreateTrackError=function(k){const Q=k.getErrorMessageInfo();st.showMessage(Q.description,Q.title)},b.prototype.toggleCamera=function(){if(this._cameraTrack){if(this._isPublishingTracksDuringConnecting){Le.log("Cannot disable the camera track during connection process");return}this._cameraTrack.stop()}else this._createCameraTrack()},b.prototype.startShareScreen=function(k,Q,le,ae){if(this._screenTrack!==null){k();return}Le.log("Share screen start"),navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}).then(Ee=>{Le.log("share screen - stream:",Ee);const te=new Twilio.Video.LocalVideoTrack(Ee.getVideoTracks()[0],{name:"screen"});this._screenTrack=te;const me=Ee.getAudioTracks();let Fe=null;me.length>0?(Fe=new Twilio.Video.LocalAudioTrack(me[0],{name:"audio"}),this._audioTrack=Fe,ae()):console.log("Audio track not available for sharing");const we=h(this._viewer,te);this._avatar.setVideoTexture1(we),this._viewer.requestFrame(),this.isConnectedToTwilio&&(this._twilioParticipant.publishTrack(te),Fe&&this._twilioParticipant.publishTrack(Fe)),k(),te.once("stopped",()=>{Le.log("Screen track stopped"),this.isConnectedToTwilio&&(this._twilioParticipant.unpublishTrack(te),Fe!==null&&this._twilioParticipant.unpublishTrack(Fe)),this._avatar.setVideoTexture1(null),f(te),Fe!==null&&f(Fe),this._screenTrack=null,this._audioTrack&&(this._audioTrack=null,ae()),this._viewer.requestFrame(),Q()})}).catch(Ee=>{le()})},b.prototype.stopShareScreen=function(){this._screenTrack!==null&&(Le.log("Share screen stop"),this._screenTrack.stop())},b.prototype.dispose=function(){this._micTrack&&this._micTrack.stop(),this._cameraTrack&&this._cameraTrack.stop(),this._screenTrack&&this._screenTrack.stop(),m.prototype.dispose.call(this)};function _(k,Q,le,ae){m.call(this,k,Q,le,!1),this._onUiRefreshNeeded=ae,this._micTrackStateChangedBound=null,this._cameraTrackEnabledBound=null,this._cameraTrackDisabledBound=null,this._trackSubscribedBound=this._trackSubscribed.bind(this),this._trackUnsubscribedBound=this._trackUnsubscribed.bind(this),this._disposed=!1}_.prototype=Object.create(m.prototype),_.prototype.constructor=_,_.prototype._refreshUi=function(){this._onUiRefreshNeeded&&this._onUiRefreshNeeded(this)},_.prototype._setUpMicTrack=function(){Le.log("Setting up remote mic track for %s:%s",this._uuid,this._displayName),this._micTrackStateChangedBound=()=>{this._updateSoundMeasurementState(),this._refreshUi()},this._micTrack.on("enabled",this._micTrackStateChangedBound),this._micTrack.on("disabled",this._micTrackStateChangedBound),this._updateSoundMeasurementState(),this._micTrack.attach()},_.prototype._tearDownMicTrack=function(){Le.log("Tearing down remote mic track for %s:%s",this._uuid,this._displayName),f(this._micTrack),this._micTrack.removeListener("enabled",this._micTrackStateChangedBound),this._micTrack.removeListener("disabled",this._micTrackStateChangedBound),this._micTrackStateChangedBound=null},_.prototype._setUpAudioTrack=function(){Le.log("Setting up remote audio track for %s:%s",this._uuid,this._displayName),this._audioTrack.attach()},_.prototype._tearDownAudioTrack=function(){Le.log("Tearing down remote audio track for %s:%s",this._uuid,this._displayName),f(this._audioTrack)},_.prototype._setUpCameraTrack=function(){Le.log("Setting up remote camera track for %s:%s",this._uuid,this._displayName);const k=h(this._viewer,this._cameraTrack);this._cameraTrackEnabledBound=()=>{this._avatar.setVideoTexture0(k)},this._cameraTrackDisabledBound=()=>{this._avatar.setVideoTexture0(null)},this._cameraTrack.on("enabled",this._cameraTrackEnabledBound),this._cameraTrack.on("disabled",this._cameraTrackDisabledBound),this._avatar.setVideoTexture0(k)},_.prototype._tearDownCameraTrack=function(){Le.log("Tearing down remote camera track for %s:%s",this._uuid,this._displayName),this._avatar.setVideoTexture0(null),f(this._cameraTrack),this._cameraTrack.removeListener("enabled",this._cameraTrackEnabledBound),this._cameraTrack.removeListener("disabled",this._cameraTrackDisabledBound),this._cameraTrackEnabledBound=null,this._cameraTrackDisabledBound=null},_.prototype._setUpScreenTrack=function(){Le.log("Setting up remote screen track for %s:%s",this._uuid,this._displayName);const k=h(this._viewer,this._screenTrack);this._avatar.setVideoTexture1(k)},_.prototype._tearDownScreenTrack=function(){Le.log("Tearing down remote screen track for %s:%s",this._uuid,this._displayName),this._avatar.setVideoTexture1(null),f(this._screenTrack)},_.prototype._setDisplayName=function(k){Le.log("Remote display name known for %s:%s",this._uuid,k),this._displayName=k,this._setUpAvatar(),this._micTrack&&this._setUpMicTrack(),this._cameraTrack&&this._setUpCameraTrack(),this._screenTrack&&this._setUpScreenTrack(),this._audioTrack&&this._setUpAudioTrack(),this._refreshUi()},_.prototype._trackSubscribed=function(k){if(Le.log("Remote %s:%s track subscribed for %s:%s",k.kind,k.name,this._uuid,this._displayName),!this._disposed){if(k.kind==="data"&&k.name==="data"){if(this._dataTrack){Le.log("Ignoring duplicate data track");return}this._dataTrack=k,k.on("message",Q=>{Q=JSON.parse(Q);const le=Q[1],ae=Q[2];this.hasDisplayName||this._setDisplayName(le),this.updatePosition(ae)})}else if(k.kind==="audio"&&k.name==="mic"){if(this._micTrack){Le.log("Ignoring duplicate mic track");return}this._micTrack=k,this.hasDisplayName&&(this._setUpMicTrack(),this._refreshUi())}else if(k.kind==="video"){if(k.name==="camera"){if(this._cameraTrack){Le.log("Ignoring duplicate camera track");return}this._cameraTrack=k,this._avatar&&(this._setUpCameraTrack(),this._viewer.requestFrame())}else if(k.name==="screen"){if(this._screenTrack){Le.log("Ignoring duplicate screen track");return}this._screenTrack=k,this._avatar&&(this._setUpScreenTrack(),this._viewer.requestFrame())}}else if(k.kind==="audio"&&k.name==="audio"){if(this._audioTrack){Le.log("Ignoring duplicate audio track");return}this._audioTrack=k,this.hasDisplayName&&(this._setUpAudioTrack(),this._refreshUi())}}},_.prototype._trackUnsubscribed=function(k){Le.log("Remote %s:%s track unsubscribed for %s:%s",k.kind,k.name,this._uuid,this._displayName),!this._disposed&&(k===this._dataTrack?this._dataTrack=null:k===this._micTrack?(this.hasDisplayName&&this._tearDownMicTrack(),this._micTrack=null,this._refreshUi()):k===this._cameraTrack?(this._avatar&&(this._tearDownCameraTrack(),this._viewer.requestFrame()),this._cameraTrack=null):k===this._screenTrack?(this._avatar&&(this._tearDownScreenTrack(),this._viewer.requestFrame()),this._screenTrack=null):k===this._audioTrack&&(this.hasDisplayName&&this._tearDownAudioTrack(),this._audioTrack=null,this._refreshUi()))},_.prototype.connectedToTwilio=function(k){this._twilioParticipant=k,k.on("trackSubscribed",this._trackSubscribedBound),k.on("trackUnsubscribed",this._trackUnsubscribedBound),k.tracks.forEach(Q=>{Q.isSubscribed&&this._trackSubscribed(Q.track)})},_.prototype.seeAvatar=function(){this._avatar&&this._viewer.seeItem(this._avatar)},_.prototype._onSoundVolumeUpdated=function(k){m.prototype._onSoundVolumeUpdated.call(this,k),this._avatar.onSoundVolumeUpdated(k)},_.prototype.dispose=function(){this._onUiRefreshNeeded=null,this._micTrack&&this._trackUnsubscribed(this._micTrack),this._cameraTrack&&this._trackUnsubscribed(this._cameraTrack),this._screenTrack&&this._trackUnsubscribed(this._screenTrack),this._audioTrack&&this._trackUnsubscribed(this._audioTrack),this.isConnectedToTwilio&&(this._twilioParticipant.removeListener("trackSubscribed",this._trackSubscribedBound),this._twilioParticipant.removeListener("trackUnsubscribed",this._trackUnsubscribedBound),this._twilioParticipant=null),m.prototype.dispose.call(this),this._disposed=!0};function y(k,Q,le,ae,Ee,te){const me=new PubNub({publishKey:Q.publishKey,subscribeKey:Q.subscribeKey,authKey:Q.authKey,uuid:k.uuid,ssl:!0}),Fe=Q.channel;me.subscribe({channels:[Fe],withPresence:!0}),me.addListener({message:function(we){Le.log("listener received message",we),we.message.type==="SceneState"&&Ee(we.message.state)},presence:function(we){we.uuid!==k.uuid&&(Le.log("listener presence event",we),we.action==="join"?le(we.uuid):we.action==="leave"&&ae(we.uuid))},status:function(we){(we.category==="PNAccessDeniedCategory"||we.category==="PNNetworkIssuesCategory"||we.category==="PNNetworkDownCategory"||we.category==="PNTimeoutCategory")&&te(we.category)}}),me.hereNow({channels:[Fe],includeUUIDs:!0,includeState:!0},(we,at)=>{Le.log("herenow",we,at),at.channels[Fe].occupants.forEach(function(et){et.uuid!==k.uuid&&le(et.uuid)})}),this.dispose=function(){me.unsubscribeAll()}}function A(k,Q,le,ae,Ee,te,me,Fe,we,at){const et=Q.avToken,U=Q.channel,z=["NotAllowedError","NotFoundError","NotReadableError","OverconstrainedError","TypeError"];let G=null,X=!1,_e=0;const Ie=D.urlHashContains("av-turn");function Ye(Se){const We=Se.identity.match(/^u-\d+/),rt=We&&We[0];return rt||(D.warn("Unknown participant",Se.identity),null)}function ke(Se){Le.log('Participant "%s" connected',Se.identity);const We=Ye(Se);We&&le(We,Se)}function ge(Se){Le.log('Participant "%s" disconnected',Se.identity);const We=Ye(Se);We&&ae(We,Se)}function Qe(Se){const We=Se!==null?Ye(Se):null;at(We)}function ue(Se){z.includes(Se.name)?Ee(Se):te("T"+Se.code)}this.isConnectingOrConnected=function(){return X};function Ae(Se){X&&(X=!1,G.participants.forEach(ge),G=null,k.disconnectedFromTwilio(),we(),_e>0?te("TReconnectionDisconnected"+(Se.code?" "+Se.code:"")):me())}this.disconnect=function(){X&&(X=!1,G&&(G.disconnect(),G.participants.forEach(ge),G=null,k.disconnectedFromTwilio(),we()))},this.dispose=function(){this.disconnect()},this.connect=function(){console.assert(!X),X=!0,k.startedConnectingToTwilio(),Le.log('Connecting to room "%s"',U),Twilio.Video.connect(et,{name:U,tracks:k.getAllTracks(),preferredVideoCodecs:"auto",iceTransportPolicy:Ie?"relay":"all",region:n||"gll",networkQuality:{local:1,remote:1},dominantSpeaker:!0}).then(Se=>{G=Se,Le.log("Connected to room"),G.participants.forEach(ke),G.on("participantConnected",ke),G.on("participantDisconnected",ge),G.on("dominantSpeakerChanged",Qe),G.on("reconnecting",We=>{_e+=1}),G.on("reconnected",We=>{_e=0}),G.once("disconnected",Ae),k.connectedToTwilio(G.localParticipant),Fe(G)}).catch(Se=>{k.failedToConnectToTwilio(),ue(Se)})}}class T{constructor(){this._users=new Set,this._maxIntervalBetweenUpdates=100,this._idleCallback=new db(()=>this._execute(),this._maxIntervalBetweenUpdates),Li().onBeforeRender(()=>this._onBeforeRender())}registerUser(Q){this._users.add(Q)}unregisterUser(Q){this._users.delete(Q)}dispose(){this._users.clear()}_onBeforeRender(){this._execute(),this._idleCallback.deferRun()}_execute(){this._users.forEach(Q=>Q.updateSoundVolumeVisualization())}}function M(k,Q){const te=document.getElementById("ext-meeting-who-list-folder"),me=document.getElementById("ext-meeting-status");Gl(me);const Fe=document.getElementById("ext-meeting-who-list"),we=new zh(1e3),at=new zh(3e3),et=new zh(1e3,()=>{Fe.style.overflowY="auto"});Fe.addEventListener("scroll",ue=>{we.isRunning()||at.start()});let U=!0;function z(){et.isRunning()||(U?(U=!1,Fe.style.maxHeight=0,Fe.style.margin=0,Fe.style.overflowY="hidden",te.children[0].style.transform="rotate(180deg)"):(te.children[0].style.transform="",Fe.style.maxHeight="",Fe.style.margin="",et.start(),U=!0))}qn(te,z),it.firefox&&(Fe.style.paddingRight="16px");let G=null;const X=new Map;function _e(ue,Ae,Se){const We=document.createElement("span");if(We.classList.add("ext-meeting-who-list-name"),ue){const rt=document.createElement("span");rt.innerText=Ae;const bt=document.createElement("span");mr(bt,` (${Ct("meetings.me")})`),We.appendChild(rt),We.appendChild(bt)}else We.innerText=Ae;return We.style.color=Se,We}function Ie(ue){const Ae=document.createElement("span");return Ae.classList.add("ext-meeting-who-list-mic-indicator"),ue?Ae.classList.add("fa-microphone"):Ae.classList.add("fa-microphone-slash"),Ae}function Ye(){const ue=document.createElement("span");return ue.classList.add("ext-meeting-who-list-mic-indicator"),ue.classList.add("fa-file-audio-o"),ue}function ke(ue){console.assert(ue.volumeVisualizer!==null,"volumeVisualizer not initialized");const Ae=document.createElement("span");return ue.isSoundMeasurementActive()?Ae.innerHTML=ue.volumeVisualizer.getHTML():Ae.innerHTML=ue.volumeVisualizer.getEmptyHTML(),Ae}function ge(){const ue=document.createElement("li");ue.classList.add("ext-meeting-who-list-entry"),ue.appendChild(ke(k)),ue.appendChild(_e(!0,k.displayName,k.color));const Ae=p(k.micTrack);return ue.appendChild(Ie(Ae)),k.audioTrack&&ue.appendChild(Ye()),ue}function Qe(ue){const Ae=document.createElement("li");Ae.classList.add("ext-meeting-who-list-entry"),Ae.appendChild(ke(ue));const Se=_e(!1,ue.displayName,ue.color);Se.style.cursor="pointer",Ae.appendChild(Se);const We=ue.micTrack&&ue.micTrack.isEnabled;return Ae.appendChild(Ie(We)),ue.audioTrack&&Ae.appendChild(Ye()),qn(Se,ue.seeAvatar.bind(ue)),Ae}this.onDominantSpeakerChanged=function(ue){if(G&&ue!==G&&(G=null),at.isRunning()||ue===null)return;const Ae=X.get(ue);Ae?(Ae.scrollIntoView({behavior:"smooth",block:"nearest"}),we.start()):G=ue},this.update=function(ue){X.clear(),st.removeChildren(Fe),Fe.appendChild(ge());for(const Ae of Object.values(ue))if(Ae.hasDisplayName){const Se=Qe(Ae);Fe.appendChild(Se),X.set(Ae,Se)}G&&X.has(G)&&(this.onDominantSpeakerChanged(G),G=null)},this.show=function(){st.show(me)},this.hide=function(){st.hide(me)},this.update([]),this.show()}function C(k){return`
      <div>
        <textarea id="ext-meeting-note-text"
          class="ext-meeeting-note-edit"
          placeholder="${k}"></textarea>
      </div>
      <button id="ext-meeting-note-publish"
        class="ext-meeting-button ext-meeting-dialog-buttons">
        Publish
      </button>
    `}function N(k,Q){const le="extMtg:"+k+":"+Q+":";function ae(Ee){let te=le;return Ee.location!==null&&(te+=":"+Ee.location.join(":")),te}this.getTimeStampOfLastReadNoteAtLocation=function(Ee){return localStorage.getItem(ae(Ee))||-1},this.isNoteRead=function(Ee){return Ee.ts<=this.getTimeStampOfLastReadNoteAtLocation(Ee)||Ee.author===Q},this.markAllNotesAtLocationAsRead=function(Ee){localStorage.setItem(ae(Ee),Ee.ts)}}function O(k,Q,le,ae,Ee,te){const me="MeetingNotes",Fe=[];let we=[],at=!1;const et=new st.UiPopup(`
      <h2>
        Click a place to leave a note there.
      </h2>`);et.position=st.UiPopup.TOP;const U=new st.UiPopup(C("Type your note"));U.position=st.UiPopup.TOP;let z,G=null,X=null;function _e(Se){if(Se===Q.displayName)return Q.color;for(const We of Object.values(le))if(We.displayName===Se)return We.color;return"#ffffff"}function Ie(){at=!1,ae.show(),i.style.cursor="default",et.dismiss(),U.close()}function Ye(){at=!0,ae.hide(),i.style.cursor="pointer",G&&G.close(),k.onNodeTypeClicked(z),et.onDismiss=()=>{k.removeOnNodeTypeClicked(z),Ie()},et.open()}function ke(Se,We){return Se===null||We===null?!1:Oo(Se,We)}Ii("ext-meeting-add-note",Ye);const ge=new B;z=function(Se,We,rt){i.style.cursor="default",ge.copyFrom(We),Fu(ge,k.getCameraPosition(),s),k.removeOnNodeTypeClicked(z);const bt=k.addAnchor(d(ge.x,ge.y,ge.z));return bt.material.highlight=t,bt.material.setUniforms(),bt.material.highlightMix=.7,et.close(),U.onClose=()=>{k.removeAnchor(bt),Ie()},U.open(),Ii("ext-meeting-note-publish",()=>{const ft=document.getElementById("ext-meeting-note-text"),F=ft.value.trim();if(!F){st.highlightInput(ft);return}te(F,[ge.x,ge.y,ge.z])}),!0};function Qe(Se){return we.filter(We=>ke(We.location,Se.location))}function ue(Se,We){let rt;function bt(Ne,he){if(at)return;rt.classList.remove("ext-meeting-note-list-unread"),rt.classList.add("ext-meeting-note-list-selected"),he&&rt.scrollIntoView(),Ne.material.highlightMix=.7,k.requestFrame();let Ce="";const ze=new Map,gt=Ee.getTimeStampOfLastReadNoteAtLocation(Se);let Ut=null;for(const Oe of Qe(Se)){const R="ext-meeting-note-text"+Oe.id,V="ext-meeting-note-author"+Oe.id;let ie="ext-meeting-note-entry";Oe.ts>gt&&Oe.author!==Q.displayName&&(ie+=" ext-meeting-note-unread"),Ce+=`<div class="${ie}">
               <strong id="${V}"
                   style="color: ${_e(Oe.author)}">
               </strong> <span>${l(Oe.ts)}</span>
               <div id="${R}">
               </div>
             </div>`,ze.set(R,Oe.text),ze.set(V,Oe.author),Ut=Oe}const ii=Ce+C("Type your response");G?G.update(ii):(G=new st.UiPopup(ii),G.position=st.UiPopup.TOP,G.onClose=()=>{rt.classList.remove("ext-meeting-note-list-selected"),Ne.material.highlightMix=0,k.requestFrame(),G=null}),Ee.markAllNotesAtLocationAsRead(Ut),X=Se.location,G.open(),ze.forEach((Oe,R)=>{document.getElementById(R).innerText=Oe}),Ii("ext-meeting-note-publish",()=>{const Oe=document.getElementById("ext-meeting-note-text"),R=Oe.value.trim();if(!R){st.highlightInput(Oe);return}const V=Ne.position;te(R,[V.x,V.y,V.z]),Oe.value=""})}const ft=k.addAnchor(d(Se.location[0],Se.location[1],Se.location[2]),Ne=>bt(Ne,!0));ft.material.highlight=t,ft.material.setUniforms(),Fe.push(ft);const F=Se,J=F.author;rt=c(J,l(F.ts),_e(J),()=>{k.seeItem(ft),bt(ft,!1)}),Ee.isNoteRead(Se)||rt.classList.add("ext-meeting-note-list-unread"),We.appendChild(rt),G!==null&&Oo(X,Se.location)&&bt(ft,!0)}function Ae(Se,We){console.assert(Se===me),we=We.sort((ft,F)=>{const J=Ee.isNoteRead(ft),Ne=Ee.isNoteRead(F);return J!==Ne?J?-1:1:ft.ts-F.ts}),Ie();for(const ft of Fe)k.removeAnchor(ft);Fe.length=0;const rt=document.getElementById("ext-meeting-note-list");st.removeChildren(rt);const bt=new Map;for(let ft=we.length-1;ft>=0;ft--){const F=we[ft];if(F.location!==null){const J=F.location.join("/");bt.has(J)||(bt.set(J,ft),ue(F,rt),rt.lastChild.scrollIntoView())}}}k.onApiUserStateChanged(me,Ae)}function q(k,Q){const le=this;let ae=null,Ee=null;const te=new st.UiPopup(`
      <h2 data-strings="meetings.pointPlace">
      </h2>`);te.position=st.UiPopup.TOP;const me=k._createPointerEventHelper(0);me.disable(),this.pointerX=null,this.pointerY=null,this.pointerZ=null,this.isEnabled=function(){return me.isEnabled()},this.showPointer=function(){return this.pointerX!==null};function Fe(){return ae!==null}k.onBeforeRender(()=>{if(!Fe())return;const et=k._findIntersectionAtPosition(ae,Ee);et.distance!==1/0&&(this.pointerX=et.point.x,this.pointerY=et.point.y,this.pointerZ=et.point.z)});function we(){ae=null,Ee=null,le.pointerX=null,le.pointerY=null,le.pointerZ=null,k._enableControls()}me.callbacks.onPointerDown=function(et,U){return ae=et,Ee=U,k._disableControls(),k.requestFrame(),!0},me.callbacks.onPointerMove=function(et,U){return Fe()?(ae=et,Ee=U,k.requestFrame(),!0):!1},me.callbacks.onPointerUp=function(){return we(),k.requestFrame(),!0};function at(){le.isEnabled()?(i.style.cursor="default",we(),me.disable(),te.close(),Q.show()):(i.style.cursor="pointer",te.open(),me.enable(),te.onDismiss=at,Q.hide())}Ii("ext-meeting-pointer",function(){at()})}function j(){const k=[0,0,0,0,0],Q=[0,0,0,0,0,0,0,0];let le=null,ae=!1;this.newUpdateWithPointer=function(){ae=!1,le!==Q&&(ae=!0,le=Q)},this.newUpdateNoPointer=function(){ae=!1,le!==k&&(ae=!0,le=k)},this.set=function(Ee,te){le[Ee]!==te&&(le[Ee]=te,ae=!0)},this.getFilledArray=function(){return ae?le:null}}function K(){const k=document.getElementById("ext-meeting-mic-toggle"),Q=document.getElementById("ext-meeting-camera-toggle"),le=document.getElementById("ext-meeting-camera-preview");Gl(le);let ae=null;function Ee(me){st.setVisibility(me.children[0],!0),st.setVisibility(me.children[1],!1)}function te(me){st.setVisibility(me.children[0],!1),st.setVisibility(me.children[1],!0)}this.refreshMicControls=function(me){p(me)?(st.setButtonHighlight(k,!1),Ee(k)):(st.setButtonHighlight(k,!0),te(k))},this.refreshCameraControls=function(me){p(me)?(ae||(ae=me.attach(),le.appendChild(ae)),st.show(le),st.setButtonHighlight(Q,!1),Ee(Q)):(ae&&(me.detach(),ae.remove(),ae=null),st.hide(le),st.setButtonHighlight(Q,!0),te(Q))},this.setToggleButtonHandlers=function(me,Fe){qn(k,me),qn(Q,Fe)}}function de(k,Q,le,ae){function Ee(Oe){Wt.info("Failed to acquire media.<br/>"+Oe.message,6e3)}const te=Li(),me=new j,Fe=new T;this.myUuid=ae.uuid;const we=new b(te,this.myUuid,k,Fe,Q,le),at={},et=new M(we),U=new K,z=ae.id,G=ae.meetingKey;let X,_e,Ie;function Ye(){we.dispose(),_e.dispose(),X.dispose();for(const Oe of Object.values(at))Oe.dispose();Fe.dispose()}function ke(Oe,R){Ye(),document.body.innerHTML='<div id="cover-image"></div>',u(Oe,R,R?()=>location.reload():void 0)}function ge(Oe){ke(`${Ct("meetings.connectionLost")}</br>(${Ct("meetings.code")}: ${Oe}).`,Ct("meetings.joinAgain"))}function Qe(){ke(Ct("meetings.meetingEnded"))}function ue(){we.toggleMic()}function Ae(){we.toggleCamera()}U.setToggleButtonHandlers(ue,Ae),we.setAvTracksStateHandlers(function(Oe){U.refreshMicControls(Oe),et.update(at)},function(Oe){U.refreshCameraControls(Oe)}),U.refreshMicControls(we.micTrack),U.refreshCameraControls(we.cameraTrack);function Se(Oe,R){const V={meetingKey:G,author:k,text:Oe,location:R};qs(o()+"/meetings/"+z+"/notes","application/json",JSON.stringify(V),()=>Le.log("Note added."),()=>Le.log("Failed to add note"))}const We=new q(te,et);D.urlHashContains("meeting-notes")&&(st.show(document.getElementById("ext-meeting-notes-preview")),O(te,we,at,et,new N(z,k),Se));function rt(Oe){et.update(at)}function bt(Oe){let R=at[Oe];return R||(R=new _(te,Oe,Fe,rt),at[Oe]=R),R}function ft(Oe){bt(Oe),_e.isConnectingOrConnected()||_e.connect()}function F(Oe){Oe in at&&(at[Oe].dispose(),delete at[Oe],et.update(at),_e.isConnectingOrConnected()&&Object.keys(at).length===0&&_e.disconnect())}function J(Oe,R){bt(Oe).connectedToTwilio(R)}function Ne(Oe,R){F(Oe)}function he(Oe){const R=Oe in at?at[Oe]:null;et.onDominantSpeakerChanged(R)}function Ce(Oe){Ie=Oe;for(const R of Object.keys(Oe))te.apiUserChangeState(R,Oe[R])}ae.sceneState!==null&&Ce(ae.sceneState),X=new y(we,ae,ft,F,Ce,ge);const ze=new YE;_e=new A(we,ae,J,Ne,Ee,ge,Qe,ze.onConnect.bind(ze),ze.onDisconnect.bind(ze),he),Ii("ext-meeting-leave",()=>{u(Ct("meetings.doYouWantToLeaveMeeting"),Ct("meetings.leaveMeeting"),()=>{ke(Ct("meetings.youHaveLeftMeeting"),Ct("meetings.joinAgain"))},!0)});function gt(Oe){We.showPointer()?(me.newUpdateWithPointer(),me.set(5,kn(We.pointerX,3)),me.set(6,kn(We.pointerY,3)),me.set(7,kn(We.pointerZ,3))):me.newUpdateNoPointer();const R=te.getCameraPosition(),V=te.getCameraRotation();me.set(0,kn(R.x,3)),me.set(1,kn(R.y,3)),me.set(2,kn(R.z,3)),me.set(3,kn(V.yaw,1)),me.set(4,kn(V.pitch,1));const ie=me.getFilledArray();ie&&we.updatePosition(ie)}function Ut(Oe,R){if(Ie&&Oo(R,Ie[Oe]))return;const V={meetingKey:G,key:Oe,state:R};qs(o()+"/meetings/"+z+"/scene-state","application/json",JSON.stringify(V),()=>Le.log("State updated."),()=>Le.log("Failed to update state."))}function ii(){ke(Ct("meetings.meetingEndedMaximumDurationReached"))}te.onBeforeRender(gt),gt(),te.onApiUserStateChanged(Ut),this.startShareScreen=function(Oe,R,V){Le.log("Screen share start requested"),we.startShareScreen(Oe,R,V,()=>et.update(at))},this.stopShareScreen=function(){Le.log("Screen share stop requested"),we.stopShareScreen()},ae.remainingTimeSeconds!==null&&setTimeout(ii,(ae.remainingTimeSeconds+5)*1e3)}function xe(k){const Q=(ae,Ee,te)=>{const me=new de(ae,Ee,te,k);Li()._meetingJoined(me)};new rg(Q,k.avToken).show()}function Ve(k,Q){const le=(te,me)=>{fetch(te+me.model).then(Fe=>Fe.text()).then(Fe=>{const we=LE(Fe);sA(te,me,we),Q()}).catch(()=>Wt.error(Ct("meetings.failedToLoadMeeting")))},ae=()=>{k=gi("3dassets/avatar.json")},Ee=te=>ei(this,null,function*(){if(te===void 0)return;const me=te.split("/").slice(0,-1).join("/")+"/";try{const we=yield(yield fetch(te)).json();return le(me,we),!0}catch(Fe){return!1}});Li().onSceneLoadComplete(()=>ei(this,null,function*(){(yield Ee(k))||(ae(),D.AVATAR_JSON_URL_OVERRIDE&&(k=D.AVATAR_JSON_URL_OVERRIDE),yield Ee(k))||Wt.error(Ct("meetings.failedToLoadMeeting"))}))}function qe(){const k=D.urlHashGetArgument("meeting"),Q=D.urlHashGetArgument("meeting-key"),le=D.urlHashGetArgument("av-mode"),ae={url:r()};k&&(ae.meetingName=k),Q&&(ae.meetingKey=Q),le&&(ae.avMode=le),n&&(ae.avRegion=n),qs(o()+"/meetings/join","application/json",JSON.stringify(ae),Ee=>Ve(Ee.avatarJsonUrl,()=>xe(Ee)),(Ee,te)=>{te!==void 0?Wt.error(te):Wt.error(Ct("meetings.failedToJoinMeeting"))})}M_([gi("lib/pubnub.min.js"),gi("lib/twilio-video.min.js")],qe,()=>Wt.error("Cannot load required library")),Km()}RE(),Li()._isMeeting()&&QE(),window.addEventListener("load",function(){return ei(this,null,function*(){if(yield C_(),GA())return;const s=new ig;Qm(s)})})})();
